"use strict";(()=>{var Lx=Object.create;var Iu=Object.defineProperty;var Fx=Object.getOwnPropertyDescriptor;var qx=Object.getOwnPropertyNames;var $x=Object.getPrototypeOf,Gx=Object.prototype.hasOwnProperty;var xu=(n,o)=>{if(o=Symbol[n])return o;throw Error("Symbol."+n+" is not defined")};var Ux=(n,o)=>()=>(n&&(o=n(n=0)),o);var ne=(n,o)=>()=>(o||n((o={exports:{}}).exports,o),o.exports),Hx=(n,o)=>{for(var e in o)Iu(n,e,{get:o[e],enumerable:!0})},Tu=(n,o,e,r)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of qx(o))!Gx.call(n,t)&&t!==e&&Iu(n,t,{get:()=>o[t],enumerable:!(r=Fx(o,t))||r.enumerable});return n},yn=(n,o,e)=>(Tu(n,o,"default"),e&&Tu(e,o,"default")),w=(n,o,e)=>(e=n!=null?Lx($x(n)):{},Tu(o||!n||!n.__esModule?Iu(e,"default",{value:n,enumerable:!0}):e,n));var zx=function(n,o){this[0]=n,this[1]=o};var So=n=>{var o=n[xu("asyncIterator")],e=!1,r,t={};return o==null?(o=n[xu("iterator")](),r=a=>t[a]=s=>o[a](s)):(o=o.call(n),r=a=>t[a]=s=>{if(e){if(e=!1,a==="throw")throw s;return s}return e=!0,{done:!1,value:new zx(new Promise(u=>{var l=o[a](s);if(!(l instanceof Object))throw TypeError("Object expected");u(l)}),1)}}),t[xu("iterator")]=()=>t,r("next"),"throw"in o?r("throw"):t.throw=a=>{throw a},"return"in o&&r("return"),t};var op=ne((exports,module)=>{h();if(exports.__platformBundles!==void 0)for(platformBundles=exports.__platformBundles.concat(),Reflect.deleteProperty(exports,"__platformBundles"),i=0;i<platformBundles.length;++i)console.log("PB start "+(i+1)+"/"+platformBundles.length),eval(platformBundles[i]),console.log("PB done  "+(i+1)+"/"+platformBundles.length);var platformBundles,i});var global,h=Ux(()=>{global=new Function("return this;")();op()});var ap=ne((y0,ip)=>{h();ip.exports=OfficePlatformGlobal.ReactNativeReka});var up=ne((w0,sp)=>{h();sp.exports=OfficePlatformGlobal.Reka});var _u=ne((I0,oi)=>{h();function Jx(n){if(Array.isArray(n))return n}oi.exports=Jx,oi.exports.__esModule=!0,oi.exports.default=oi.exports});var cp=ne((A0,ii)=>{h();function jx(n,o){var e=n==null?null:typeof Symbol!="undefined"&&n[Symbol.iterator]||n["@@iterator"];if(e!=null){var r,t,a,s,u=[],l=!0,f=!1;try{if(a=(e=e.call(n)).next,o===0){if(Object(e)!==e)return;l=!1}else for(;!(l=(r=a.call(e)).done)&&(u.push(r.value),u.length!==o);l=!0);}catch(c){f=!0,t=c}finally{try{if(!l&&e.return!=null&&(s=e.return(),Object(s)!==s))return}finally{if(f)throw t}}return u}}ii.exports=jx,ii.exports.__esModule=!0,ii.exports.default=ii.exports});var Au=ne((b0,ai)=>{h();function Kx(n,o){(o==null||o>n.length)&&(o=n.length);for(var e=0,r=new Array(o);e<o;e++)r[e]=n[e];return r}ai.exports=Kx,ai.exports.__esModule=!0,ai.exports.default=ai.exports});var Ga=ne((N0,si)=>{h();var dp=Au();function Xx(n,o){if(n){if(typeof n=="string")return dp(n,o);var e=Object.prototype.toString.call(n).slice(8,-1);if(e==="Object"&&n.constructor&&(e=n.constructor.name),e==="Map"||e==="Set")return Array.from(n);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return dp(n,o)}}si.exports=Xx,si.exports.__esModule=!0,si.exports.default=si.exports});var Mu=ne((P0,ui)=>{h();function Yx(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}ui.exports=Yx,ui.exports.__esModule=!0,ui.exports.default=ui.exports});var at=ne((B0,li)=>{h();var Zx=_u(),eT=cp(),tT=Ga(),nT=Mu();function rT(n,o){return Zx(n)||eT(n,o)||tT(n,o)||nT()}li.exports=rT,li.exports.__esModule=!0,li.exports.default=li.exports});var R=ne(($0,fi)=>{h();function oT(n,o){if(!(n instanceof o))throw new TypeError("Cannot call a class as a function")}fi.exports=oT,fi.exports.__esModule=!0,fi.exports.default=fi.exports});var Ua=ne((U0,Un)=>{h();function bu(n){"@babel/helpers - typeof";return Un.exports=bu=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(o){return typeof o}:function(o){return o&&typeof Symbol=="function"&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},Un.exports.__esModule=!0,Un.exports.default=Un.exports,bu(n)}Un.exports=bu,Un.exports.__esModule=!0,Un.exports.default=Un.exports});var vp=ne((z0,ci)=>{h();var mp=Ua().default;function iT(n,o){if(mp(n)!=="object"||n===null)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var r=e.call(n,o||"default");if(mp(r)!=="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(o==="string"?String:Number)(n)}ci.exports=iT,ci.exports.__esModule=!0,ci.exports.default=ci.exports});var Eu=ne((Q0,di)=>{h();var aT=Ua().default,sT=vp();function uT(n){var o=sT(n,"string");return aT(o)==="symbol"?o:String(o)}di.exports=uT,di.exports.__esModule=!0,di.exports.default=di.exports});var B=ne((j0,pi)=>{h();var lT=Eu();function yp(n,o){for(var e=0;e<o.length;e++){var r=o[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,lT(r.key),r)}}function fT(n,o,e){return o&&yp(n.prototype,o),e&&yp(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n}pi.exports=fT,pi.exports.__esModule=!0,pi.exports.default=pi.exports});var Cp=ne((rE,gi)=>{h();var cT=Au();function dT(n){if(Array.isArray(n))return cT(n)}gi.exports=dT,gi.exports.__esModule=!0,gi.exports.default=gi.exports});var Du=ne((iE,hi)=>{h();function pT(n){if(typeof Symbol!="undefined"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}hi.exports=pT,hi.exports.__esModule=!0,hi.exports.default=hi.exports});var xp=ne((sE,mi)=>{h();function gT(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}mi.exports=gT,mi.exports.__esModule=!0,mi.exports.default=mi.exports});var Se=ne((lE,vi)=>{h();var hT=Cp(),mT=Du(),vT=Ga(),yT=xp();function kT(n){return hT(n)||mT(n)||vT(n)||yT()}vi.exports=kT,vi.exports.__esModule=!0,vi.exports.default=vi.exports});var ja=ne((aN,Jn)=>{h();function tl(n,o){return Jn.exports=tl=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(r,t){return r.__proto__=t,r},Jn.exports.__esModule=!0,Jn.exports.default=Jn.exports,tl(n,o)}Jn.exports=tl,Jn.exports.__esModule=!0,Jn.exports.default=Jn.exports});var ze=ne((uN,Si)=>{h();var wT=ja();function ST(n,o){if(typeof o!="function"&&o!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(o&&o.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),o&&wT(n,o)}Si.exports=ST,Si.exports.__esModule=!0,Si.exports.default=Si.exports});var Ao=ne((fN,Ci)=>{h();function CT(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}Ci.exports=CT,Ci.exports.__esModule=!0,Ci.exports.default=Ci.exports});var Ve=ne((dN,xi)=>{h();var xT=Ua().default,TT=Ao();function IT(n,o){if(o&&(xT(o)==="object"||typeof o=="function"))return o;if(o!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return TT(n)}xi.exports=IT,xi.exports.__esModule=!0,xi.exports.default=xi.exports});var Oe=ne((gN,jn)=>{h();function nl(n){return jn.exports=nl=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},jn.exports.__esModule=!0,jn.exports.default=jn.exports,nl(n)}jn.exports=nl,jn.exports.__esModule=!0,jn.exports.default=jn.exports});var Mp=ne((mN,Ti)=>{h();function _T(n){return Function.toString.call(n).indexOf("[native code]")!==-1}Ti.exports=_T,Ti.exports.__esModule=!0,Ti.exports.default=Ti.exports});var bp=ne((yN,Ii)=>{h();function AT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}Ii.exports=AT,Ii.exports.__esModule=!0,Ii.exports.default=Ii.exports});var Ep=ne((wN,jt)=>{h();var MT=ja(),bT=bp();function Ka(n,o,e){return bT()?(jt.exports=Ka=Reflect.construct.bind(),jt.exports.__esModule=!0,jt.exports.default=jt.exports):(jt.exports=Ka=function(t,a,s){var u=[null];u.push.apply(u,a);var l=Function.bind.apply(t,u),f=new l;return s&&MT(f,s.prototype),f},jt.exports.__esModule=!0,jt.exports.default=jt.exports),Ka.apply(null,arguments)}jt.exports=Ka,jt.exports.__esModule=!0,jt.exports.default=jt.exports});var ol=ne((CN,Kn)=>{h();var ET=Oe(),NT=ja(),DT=Mp(),PT=Ep();function rl(n){var o=typeof Map=="function"?new Map:void 0;return Kn.exports=rl=function(r){if(r===null||!DT(r))return r;if(typeof r!="function")throw new TypeError("Super expression must either be null or a function");if(typeof o!="undefined"){if(o.has(r))return o.get(r);o.set(r,t)}function t(){return PT(r,arguments,ET(this).constructor)}return t.prototype=Object.create(r.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),NT(t,r)},Kn.exports.__esModule=!0,Kn.exports.default=Kn.exports,rl(n)}Kn.exports=rl,Kn.exports.__esModule=!0,Kn.exports.default=Kn.exports});var us=ne((dP,Ur)=>{h();Ur.exports=global.fetch;Ur.exports.default=global.fetch;Ur.exports.fetch=global.fetch;Ur.exports.Headers=global.Headers;Ur.exports.Request=global.Request;Ur.exports.Response=global.Response});var Al=ne((IP,Ng)=>{h();var Bo=null;typeof WebSocket!="undefined"?Bo=WebSocket:typeof MozWebSocket!="undefined"?Bo=MozWebSocket:typeof global!="undefined"?Bo=global.WebSocket||global.MozWebSocket:typeof window!="undefined"?Bo=window.WebSocket||window.MozWebSocket:typeof self!="undefined"&&(Bo=self.WebSocket||self.MozWebSocket);Ng.exports=Bo});var cs=ne((EP,Wi)=>{h();var fI=Eu();function cI(n,o,e){return o=fI(o),o in n?Object.defineProperty(n,o,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[o]=e,n}Wi.exports=cI,Wi.exports.__esModule=!0,Wi.exports.default=Wi.exports});var Rn=ne((VP,$l)=>{"use strict";h();var mI=Object.prototype.hasOwnProperty,Ot="~";function Ji(){}Object.create&&(Ji.prototype=Object.create(null),new Ji().__proto__||(Ot=!1));function vI(n,o,e){this.fn=n,this.context=o,this.once=e||!1}function Fg(n,o,e,r,t){if(typeof e!="function")throw new TypeError("The listener must be a function");var a=new vI(e,r||n,t),s=Ot?Ot+o:o;return n._events[s]?n._events[s].fn?n._events[s]=[n._events[s],a]:n._events[s].push(a):(n._events[s]=a,n._eventsCount++),n}function ps(n,o){--n._eventsCount===0?n._events=new Ji:delete n._events[o]}function Dt(){this._events=new Ji,this._eventsCount=0}Dt.prototype.eventNames=function(){var o=[],e,r;if(this._eventsCount===0)return o;for(r in e=this._events)mI.call(e,r)&&o.push(Ot?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o};Dt.prototype.listeners=function(o){var e=Ot?Ot+o:o,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var t=0,a=r.length,s=new Array(a);t<a;t++)s[t]=r[t].fn;return s};Dt.prototype.listenerCount=function(o){var e=Ot?Ot+o:o,r=this._events[e];return r?r.fn?1:r.length:0};Dt.prototype.emit=function(o,e,r,t,a,s){var u=Ot?Ot+o:o;if(!this._events[u])return!1;var l=this._events[u],f=arguments.length,c,d;if(l.fn){switch(l.once&&this.removeListener(o,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,e),!0;case 3:return l.fn.call(l.context,e,r),!0;case 4:return l.fn.call(l.context,e,r,t),!0;case 5:return l.fn.call(l.context,e,r,t,a),!0;case 6:return l.fn.call(l.context,e,r,t,a,s),!0}for(d=1,c=new Array(f-1);d<f;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var p=l.length,g;for(d=0;d<p;d++)switch(l[d].once&&this.removeListener(o,l[d].fn,void 0,!0),f){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,e);break;case 3:l[d].fn.call(l[d].context,e,r);break;case 4:l[d].fn.call(l[d].context,e,r,t);break;default:if(!c)for(g=1,c=new Array(f-1);g<f;g++)c[g-1]=arguments[g];l[d].fn.apply(l[d].context,c)}}return!0};Dt.prototype.on=function(o,e,r){return Fg(this,o,e,r,!1)};Dt.prototype.once=function(o,e,r){return Fg(this,o,e,r,!0)};Dt.prototype.removeListener=function(o,e,r,t){var a=Ot?Ot+o:o;if(!this._events[a])return this;if(!e)return ps(this,a),this;var s=this._events[a];if(s.fn)s.fn===e&&(!t||s.once)&&(!r||s.context===r)&&ps(this,a);else{for(var u=0,l=[],f=s.length;u<f;u++)(s[u].fn!==e||t&&!s[u].once||r&&s[u].context!==r)&&l.push(s[u]);l.length?this._events[a]=l.length===1?l[0]:l:ps(this,a)}return this};Dt.prototype.removeAllListeners=function(o){var e;return o?(e=Ot?Ot+o:o,this._events[e]&&ps(this,e)):(this._events=new Ji,this._eventsCount=0),this};Dt.prototype.off=Dt.prototype.removeListener;Dt.prototype.addListener=Dt.prototype.on;Dt.prefixed=Ot;Dt.EventEmitter=Dt;typeof $l!="undefined"&&($l.exports=Dt)});var ji=ne((JP,qg)=>{"use strict";h();qg.exports=function n(o,e){if(o===e)return!0;if(o&&e&&typeof o=="object"&&typeof e=="object"){if(o.constructor!==e.constructor)return!1;var r,t,a;if(Array.isArray(o)){if(r=o.length,r!=e.length)return!1;for(t=r;t--!==0;)if(!n(o[t],e[t]))return!1;return!0}if(o.constructor===RegExp)return o.source===e.source&&o.flags===e.flags;if(o.valueOf!==Object.prototype.valueOf)return o.valueOf()===e.valueOf();if(o.toString!==Object.prototype.toString)return o.toString()===e.toString();if(a=Object.keys(o),r=a.length,r!==Object.keys(e).length)return!1;for(t=r;t--!==0;)if(!Object.prototype.hasOwnProperty.call(e,a[t]))return!1;for(t=r;t--!==0;){var s=a[t];if(!n(o[s],e[s]))return!1}return!0}return o!==o&&e!==e}});var zl=ne((nR,zg)=>{"use strict";h();function Ae(n){if(this._capacity=Hg(n),this._length=0,this._front=0,Ug(n)){for(var o=n.length,e=0;e<o;++e)this[e]=n[e];this._length=o}}Ae.prototype.toArray=function(){for(var o=this._length,e=new Array(o),r=this._front,t=this._capacity,a=0;a<o;++a)e[a]=this[r+a&t-1];return e};Ae.prototype.push=function(o){var e=arguments.length,r=this._length;if(e>1){var t=this._capacity;if(r+e>t){for(var s=0;s<e;++s){this._checkCapacity(r+1);var a=this._front+r&this._capacity-1;this[a]=arguments[s],r++,this._length=r}return r}else{for(var a=this._front,s=0;s<e;++s)this[a+r&t-1]=arguments[s],a++;return this._length=r+e,r+e}}if(e===0)return r;this._checkCapacity(r+1);var s=this._front+r&this._capacity-1;return this[s]=o,this._length=r+1,r+1};Ae.prototype.pop=function(){var o=this._length;if(o!==0){var e=this._front+o-1&this._capacity-1,r=this[e];return this[e]=void 0,this._length=o-1,r}};Ae.prototype.shift=function(){var o=this._length;if(o!==0){var e=this._front,r=this[e];return this[e]=void 0,this._front=e+1&this._capacity-1,this._length=o-1,r}};Ae.prototype.unshift=function(o){var e=this._length,r=arguments.length;if(r>1){var s=this._capacity;if(e+r>s){for(var u=r-1;u>=0;u--){this._checkCapacity(e+1);var s=this._capacity,t=(this._front-1&s-1^s)-s;this[t]=arguments[u],e++,this._length=e,this._front=t}return e}else{for(var a=this._front,u=r-1;u>=0;u--){var t=(a-1&s-1^s)-s;this[t]=arguments[u],a=t}return this._front=a,this._length=e+r,e+r}}if(r===0)return e;this._checkCapacity(e+1);var s=this._capacity,u=(this._front-1&s-1^s)-s;return this[u]=o,this._length=e+1,this._front=u,e+1};Ae.prototype.peekBack=function(){var o=this._length;if(o!==0){var e=this._front+o-1&this._capacity-1;return this[e]}};Ae.prototype.peekFront=function(){if(this._length!==0)return this[this._front]};Ae.prototype.get=function(o){var e=o;if(e===(e|0)){var r=this._length;if(e<0&&(e=e+r),!(e<0||e>=r))return this[this._front+e&this._capacity-1]}};Ae.prototype.isEmpty=function(){return this._length===0};Ae.prototype.clear=function(){for(var o=this._length,e=this._front,r=this._capacity,t=0;t<o;++t)this[e+t&r-1]=void 0;this._length=0,this._front=0};Ae.prototype.toString=function(){return this.toArray().toString()};Ae.prototype.valueOf=Ae.prototype.toString;Ae.prototype.removeFront=Ae.prototype.shift;Ae.prototype.removeBack=Ae.prototype.pop;Ae.prototype.insertFront=Ae.prototype.unshift;Ae.prototype.insertBack=Ae.prototype.push;Ae.prototype.enqueue=Ae.prototype.push;Ae.prototype.dequeue=Ae.prototype.shift;Ae.prototype.toJSON=Ae.prototype.toArray;Object.defineProperty(Ae.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}});Ae.prototype._checkCapacity=function(o){this._capacity<o&&this._resizeTo(Hg(this._capacity*1.5+16))};Ae.prototype._resizeTo=function(o){var e=this._capacity;this._capacity=o;var r=this._front,t=this._length;if(r+t>e){var a=r+t&e-1;kI(this,0,this,e,a)}};var Ug=Array.isArray;function kI(n,o,e,r,t){for(var a=0;a<t;++a)e[a+r]=n[a+o],n[a+o]=void 0}function wI(n){return n=n>>>0,n=n-1,n=n|n>>1,n=n|n>>2,n=n|n>>4,n=n|n>>8,n=n|n>>16,n+1}function Hg(n){if(typeof n!="number")if(Ug(n))n=n.length;else return 16;return wI(Math.min(Math.max(16,n),1073741824))}zg.exports=Ae});var ih=ne(oh=>{h();(function(n){"use strict";function o(C,T){var I;return C instanceof Buffer?I=C:I=Buffer.from(C.buffer,C.byteOffset,C.byteLength),I.toString(T)}var e=function(T){return Buffer.from(T)};function r(C){for(var T=0,I=Math.min(65536,C.length+1),_=new Uint16Array(I),M=[],A=0;;){var b=T<C.length;if(!b||A>=I-1){var N=_.subarray(0,A),z=N;if(M.push(String.fromCharCode.apply(null,z)),!b)return M.join("");C=C.subarray(T),T=0,A=0}var L=C[T++];if(!(L&128))_[A++]=L;else if((L&224)===192){var J=C[T++]&63;_[A++]=(L&31)<<6|J}else if((L&240)===224){var J=C[T++]&63,P=C[T++]&63;_[A++]=(L&31)<<12|J<<6|P}else if((L&248)===240){var J=C[T++]&63,P=C[T++]&63,D=C[T++]&63,O=(L&7)<<18|J<<12|P<<6|D;O>65535&&(O-=65536,_[A++]=O>>>10&1023|55296,O=56320|O&1023),_[A++]=O}}}function t(C){for(var T=0,I=C.length,_=0,M=Math.max(32,I+(I>>>1)+7),A=new Uint8Array(M>>>3<<3);T<I;){var b=C.charCodeAt(T++);if(b>=55296&&b<=56319){if(T<I){var N=C.charCodeAt(T);(N&64512)===56320&&(++T,b=((b&1023)<<10)+(N&1023)+65536)}if(b>=55296&&b<=56319)continue}if(_+4>A.length){M+=8,M*=1+T/C.length*2,M=M>>>3<<3;var z=new Uint8Array(M);z.set(A),A=z}if(b&4294967168)if(!(b&4294965248))A[_++]=b>>>6&31|192;else if(!(b&4294901760))A[_++]=b>>>12&15|224,A[_++]=b>>>6&63|128;else if(!(b&4292870144))A[_++]=b>>>18&7|240,A[_++]=b>>>12&63|128,A[_++]=b>>>6&63|128;else continue;else{A[_++]=b;continue}A[_++]=b&63|128}return A.slice?A.slice(0,_):A.subarray(0,_)}var a="Failed to ",s=function(T,I,_){if(T)throw new Error("".concat(a).concat(I,": the '").concat(_,"' option is unsupported."))},u=typeof Buffer=="function"&&Buffer.from,l=u?e:t;function f(){this.encoding="utf-8"}f.prototype.encode=function(C,T){return s(T&&T.stream,"encode","stream"),l(C)};function c(C){var T;try{var I=new Blob([C],{type:"text/plain;charset=UTF-8"});T=URL.createObjectURL(I);var _=new XMLHttpRequest;return _.open("GET",T,!1),_.send(),_.responseText}finally{T&&URL.revokeObjectURL(T)}}var d=!u&&typeof Blob=="function"&&typeof URL=="function"&&typeof URL.createObjectURL=="function",p=["utf-8","utf8","unicode-1-1-utf-8"],g=r;u?g=o:d&&(g=function(T){try{return c(T)}catch(I){return r(T)}});var k="construct 'TextDecoder'",S="".concat(a," ").concat(k,": the ");function x(C,T){s(T&&T.fatal,k,"fatal"),C=C||"utf-8";var I;if(u?I=Buffer.isEncoding(C):I=p.indexOf(C.toLowerCase())!==-1,!I)throw new RangeError("".concat(S," encoding label provided ('").concat(C,"') is invalid."));this.encoding=C,this.fatal=!1,this.ignoreBOM=!1}x.prototype.decode=function(C,T){s(T&&T.stream,"decode","stream");var I;return C instanceof Uint8Array?I=C:C.buffer instanceof ArrayBuffer?I=new Uint8Array(C.buffer):I=new Uint8Array(C),g(I,this.encoding)},n.TextEncoder=n.TextEncoder||f,n.TextDecoder=n.TextDecoder||x})(typeof window!="undefined"?window:typeof global!="undefined"?global:oh)});var qh=ne((AB,oa)=>{h();var OI=Oe();function LI(n,o){for(;!Object.prototype.hasOwnProperty.call(n,o)&&(n=OI(n),n!==null););return n}oa.exports=LI,oa.exports.__esModule=!0,oa.exports.default=oa.exports});var ys=ne((bB,Xt)=>{h();var FI=qh();function vs(){return typeof Reflect!="undefined"&&Reflect.get?(Xt.exports=vs=Reflect.get.bind(),Xt.exports.__esModule=!0,Xt.exports.default=Xt.exports):(Xt.exports=vs=function(o,e,r){var t=FI(o,e);if(t){var a=Object.getOwnPropertyDescriptor(t,e);return a.get?a.get.call(arguments.length<3?o:r):a.value}},Xt.exports.__esModule=!0,Xt.exports.default=Xt.exports),vs.apply(this,arguments)}Xt.exports=vs,Xt.exports.__esModule=!0,Xt.exports.default=Xt.exports});var Zh=ne((KB,Yh)=>{h();Yh.exports={$schema:"http://json-schema.org/draft-07/schema#",$id:"http://augloop.office.com/settings.json",definitions:{environments:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["dev","test","int","dogfood","prod","fairfax","gcchigh","dod","ag08","ag09","gallatin"]}},regions:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["australiaeast","australiasoutheast","brazilsouth","centralindia","centralus","chinaeast3","chinanorth3","eastus","eastus2","eastus2euap","francecentral","japaneast","northeurope","southcentralus","swedencentral","northcentralus","southeastasia","westcentralus","westeurope","westus","westus2","usdodcentral","usdodeast","usgovarizona","usgovtexas","usgovvirginia","usnateast","usnatwest","usseceast","ussecwest"]}},dataBoundaries:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["eudb"]}},serviceNames:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["gateway","matchmaker","httpproxy","utility","textanalysis","proofing","acronyms","classification","mastermind","excel-ecs-proxy","automatic-clp","fileio","powerpoint-getitems-proxy","tricorder","image-services","natural-language","role-detection","doc-xray","compose","voice","incubation","canvas","excel","ink","extension","observational-assistance","personalization","security","generative-text"]}},IConfigValue:{type:"object",properties:{value:{description:"An untyped setting",type:["array","boolean","integer","null","number","object","string"]},environments:{$ref:"#/definitions/environments"},regions:{$ref:"#/definitions/regions"},dataBoundaries:{$ref:"#/definitions/dataBoundaries"},serviceNames:{$ref:"#/definitions/serviceNames"},lastModifiedBy:{type:"string",format:"email"},lastModifiedTime:{type:"string",format:"date-time"}},required:["value"],additionalProperties:!1},IConfigSetting:{type:"array",minItems:1,items:{$ref:"#/definitions/IConfigValue"}},IStringConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A string setting",type:"string"}}},{$ref:"#/definitions/IConfigValue"}]}},INumericConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A number setting",type:"number"}}},{$ref:"#/definitions/IConfigValue"}]}},IBooleanConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A boolean setting",type:"boolean"}}},{$ref:"#/definitions/IConfigValue"}]}},IObjectConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"An object setting",type:"object"}}},{$ref:"#/definitions/IConfigValue"}]}},IArrayConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"An array setting",type:"array"}}},{$ref:"#/definitions/IConfigValue"}]}}},title:"Config",properties:{$schema:!0},additionalProperties:{$ref:"#/definitions/IConfigSetting"}}});var iv=ne((gL,ov)=>{h();var c_="Expected a function",nv=NaN,d_="[object Symbol]",p_=/^\s+|\s+$/g,g_=/^[-+]0x[0-9a-f]+$/i,h_=/^0b[01]+$/i,m_=/^0o[0-7]+$/i,v_=parseInt,y_=typeof global=="object"&&global&&global.Object===Object&&global,k_=typeof self=="object"&&self&&self.Object===Object&&self,w_=y_||k_||Function("return this")(),S_=Object.prototype,C_=S_.toString,x_=Math.max,T_=Math.min,vc=function(){return w_.Date.now()};function I_(n,o,e){var r,t,a,s,u,l,f=0,c=!1,d=!1,p=!0;if(typeof n!="function")throw new TypeError(c_);o=rv(o)||0,yc(e)&&(c=!!e.leading,d="maxWait"in e,a=d?x_(rv(e.maxWait)||0,o):a,p="trailing"in e?!!e.trailing:p);function g(A){var b=r,N=t;return r=t=void 0,f=A,s=n.apply(N,b),s}function k(A){return f=A,u=setTimeout(C,o),c?g(A):s}function S(A){var b=A-l,N=A-f,z=o-b;return d?T_(z,a-N):z}function x(A){var b=A-l,N=A-f;return l===void 0||b>=o||b<0||d&&N>=a}function C(){var A=vc();if(x(A))return T(A);u=setTimeout(C,S(A))}function T(A){return u=void 0,p&&r?g(A):(r=t=void 0,s)}function I(){u!==void 0&&clearTimeout(u),f=0,r=l=t=u=void 0}function _(){return u===void 0?s:T(vc())}function M(){var A=vc(),b=x(A);if(r=arguments,t=this,l=A,b){if(u===void 0)return k(l);if(d)return u=setTimeout(C,o),g(l)}return u===void 0&&(u=setTimeout(C,o)),s}return M.cancel=I,M.flush=_,M}function yc(n){var o=typeof n;return!!n&&(o=="object"||o=="function")}function __(n){return!!n&&typeof n=="object"}function A_(n){return typeof n=="symbol"||__(n)&&C_.call(n)==d_}function rv(n){if(typeof n=="number")return n;if(A_(n))return nv;if(yc(n)){var o=typeof n.valueOf=="function"?n.valueOf():n;n=yc(o)?o+"":o}if(typeof n!="string")return n===0?n:+n;n=n.replace(p_,"");var e=h_.test(n);return e||m_.test(n)?v_(n.slice(2),e?2:8):g_.test(n)?nv:+n}ov.exports=I_});var _n=ne((i1,pa)=>{h();function Mv(n,o,e,r,t,a,s){try{var u=n[a](s),l=u.value}catch(f){e(f);return}u.done?o(l):Promise.resolve(l).then(r,t)}function O_(n){return function(){var o=this,e=arguments;return new Promise(function(r,t){var a=n.apply(o,e);function s(l){Mv(a,r,t,s,u,"next",l)}function u(l){Mv(a,r,t,s,u,"throw",l)}s(void 0)})}}pa.exports=O_,pa.exports.__esModule=!0,pa.exports.default=pa.exports});var Xv=ne((W1,ga)=>{h();var U_=_u(),H_=Du(),z_=Ga(),V_=Mu();function Q_(n){return U_(n)||H_(n)||z_(n)||V_()}ga.exports=Q_,ga.exports.__esModule=!0,ga.exports.default=ga.exports});var FS=ne((g4,LS)=>{h();LS.exports={version:"2.35.1034"}});var ex=ne(gu=>{"use strict";h();Object.defineProperty(gu,"__esModule",{value:!0});var Ob;(function(n){n.DesignerSlideSuggestion="Designer.Slides",n.TextToSmartArtSuggestion="Designer.TextToSmartArt",n.PowerPointTextTileChanged="PowerPoint.TextTileChanged",n.SlideContentChange="PowerPoint.SlideContentChange",n.IdeasExecuteAction="Ideas.ExecuteAction"})(Ob=gu.MessageType||(gu.MessageType={}))});var tx=ne(hu=>{"use strict";h();Object.defineProperty(hu,"__esModule",{value:!0});var Lb;(function(n){n[n.Error=0]="Error",n[n.Warn=1]="Warn",n[n.Info=2]="Info",n[n.Debug=3]="Debug"})(Lb=hu.LoggingLevel||(hu.LoggingLevel={}))});var nx=ne(mu=>{"use strict";h();Object.defineProperty(mu,"__esModule",{value:!0});var Fb;(function(n){n.NotSet="NotSet",n.Timeout="Timeout",n.NetworkError="NetworkError",n.ServiceError="ServiceError",n.ParsingError="ParsingError",n.AuthenticationError="AuthenticationError",n.UnhandledException="UnhandledException"})(Fb=mu.ProviderErrorType||(mu.ProviderErrorType={}))});var rx=ne(vu=>{"use strict";h();Object.defineProperty(vu,"__esModule",{value:!0});var qb;(function(n){n.Invalid="Invalid",n.Success="Success",n.Error="Error",n.Pending="Pending",n.NoResult="NoResult"})(qb=vu.ProviderResultStatus||(vu.ProviderResultStatus={}))});var ox=ne(yu=>{"use strict";h();Object.defineProperty(yu,"__esModule",{value:!0});var $b;(function(n){n[n.NotSet=0]="NotSet",n[n.Measure=1]="Measure",n[n.Diagnostics=2]="Diagnostics",n[n.CriticalBusinessImpact=191]="CriticalBusinessImpact",n[n.CriticalCensus=192]="CriticalCensus",n[n.CriticalExperimentation=193]="CriticalExperimentation",n[n.CriticalUsage=194]="CriticalUsage"})($b=yu.SamplingPolicy||(yu.SamplingPolicy={}))});var ix=ne(St=>{"use strict";h();Object.defineProperty(St,"__esModule",{value:!0});var Gb;(function(n){n.DESIGNER_SLIDE_PROVIDER_ID="Provider.Designer.Slide",n.SLIDE_SUGGESTION_ID="EntityGroup.Designer.Slide.Suggestion"})(Gb=St.DesignerSlideProviderIdentifier||(St.DesignerSlideProviderIdentifier={}));var Ub;(function(n){n.MAKE_IT_VISUAL_PROVIDER_ID="Provider.UCI.MakeItVisual",n.MAKE_IT_VISUAL_KEYWORDS_ID="EntityGroup.UCI.MakeItVisual.Keywords"})(Ub=St.MakeItVisualProviderIdentifier||(St.MakeItVisualProviderIdentifier={}));var Hb;(function(n){n.DESIGNER_TEXT_TO_SMARTART_PROVIDER_ID="Provider.Designer.TextToSmartArt",n.TEXT_TO_SMARTART_SUGGESTION_ID="EntityGroup.Designer.TextToSmartArt.Suggestion"})(Hb=St.DesignerTextToSmartArtProviderIdentifier||(St.DesignerTextToSmartArtProviderIdentifier={}));var zb;(function(n){n.HUBBLE_PROVIDER_ID="Provider.Hubble",n.HUBBLE_IMAGES_GROUP_ID="EntityGroup.Hubble.Images"})(zb=St.HubbleProviderIdentifier||(St.HubbleProviderIdentifier={}));var Vb;(function(n){n.TAP_SEARCH_QF_PROVIDER_ID="Provider.Tap.Search.QF",n.TAP_SEARCH_QF_AND_OLS_PROVIDER_ID="Provider.Tap.Search.QFAndOLS",n.TAP_SEARCH_OLS_PROVIDER_ID="Provider.Tap.Search.OLS",n.TAP_SEARCH_SP_PROVIDER_ID="Provider.Tap.Search.SP",n.TAP_SEARCH_ZERO_TERM_QF_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.QF",n.TAP_SEARCH_ZERO_TERM_QF_AND_OLS_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.QFAndOLS",n.TAP_SEARCH_ZERO_TERM_OLS_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.OLS",n.TAP_SEARCH_ZERO_TERM_SP_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.SP",n.DOCUMENT_ID="EntityGroup.Tap.Document"})(Vb=St.TapProviderIdentifier||(St.TapProviderIdentifier={}));var Qb;(function(n){n.DICTIONARY_PROVIDER_ID="Provider.UCI.Dictionary",n.DICTIONARY_WORDS_GROUP_ID="EntityGroup.UCI.Dictionary.Words"})(Qb=St.DictionaryProviderIdentifier||(St.DictionaryProviderIdentifier={}));var Jb;(function(n){n.IMAGES_PROVIDER_ID="Provider.UCI.Images",n.IMAGES_ID="EntityGroup.UCI.Images.Images"})(Jb=St.ImagesProviderIdentifier||(St.ImagesProviderIdentifier={}));var jb;(function(n){n.INSIGHTS_PROVIDER_ID="Provider.UCI.Insights",n.BINGANSWER_COMPUTATION_ID="EntityGroup.UCI.Insights.BingAnswer.Computation",n.BINGANSWER_CURRENCY_ID="EntityGroup.UCI.Insights.BingAnswer.Currency",n.BINGANSWER_FACTS_ID="EntityGroup.UCI.Insights.BingAnswer.Facts",n.BINGANSWER_FINANCE_ID="EntityGroup.UCI.Insights.BingAnswer.Finance",n.BINGANSWER_NEWS_ID="EntityGroup.UCI.Insights.BingAnswer.News",n.BINGANSWER_WEATHER_ID="EntityGroup.UCI.Insights.BingAnswer.Weather",n.DICTIONARY_ID="EntityGroup.UCI.Insights.Dictionary",n.ENTITIES_ID="EntityGroup.UCI.Insights.Entities",n.IMAGES_ID="EntityGroup.UCI.Insights.Images",n.WEBRESULTS_ID="EntityGroup.UCI.Insights.WebResults",n.WIKIPEDIARESULTS_ID="EntityGroup.UCI.Insights.WikipediaResults"})(jb=St.InsightsProviderIdentifier||(St.InsightsProviderIdentifier={}))});var Kd=ne(qt=>{"use strict";h();Object.defineProperty(qt,"__esModule",{value:!0});var Kb=ex();qt.MessageType=Kb.MessageType;var Xb=tx();qt.LoggingLevel=Xb.LoggingLevel;var Yb=nx();qt.ProviderErrorType=Yb.ProviderErrorType;var Zb=rx();qt.ProviderResultStatus=Zb.ProviderResultStatus;var e0=ox();qt.SamplingPolicy=e0.SamplingPolicy;var Pr=ix();qt.DesignerSlideProviderIdentifier=Pr.DesignerSlideProviderIdentifier;qt.MakeItVisualProviderIdentifier=Pr.MakeItVisualProviderIdentifier;qt.DesignerTextToSmartArtProviderIdentifier=Pr.DesignerTextToSmartArtProviderIdentifier;qt.HubbleProviderIdentifier=Pr.HubbleProviderIdentifier;qt.TapProviderIdentifier=Pr.TapProviderIdentifier;qt.DictionaryProviderIdentifier=Pr.DictionaryProviderIdentifier;qt.ImagesProviderIdentifier=Pr.ImagesProviderIdentifier;qt.InsightsProviderIdentifier=Pr.InsightsProviderIdentifier});var ax=ne(Xd=>{"use strict";h();Object.defineProperty(Xd,"__esModule",{value:!0});var Ba=Kd(),t0=function(){function n(o,e){this.logger=o,this.configuration=e,this.shouldMatchDocumentTitle=!1,this.shouldMatchDocumentTitle=this.configuration?this.configuration.shouldQueryMatchQfDocumentTitle:n.defaultShouldQueryMatchQfDocumentTitle}return n.prototype.rank=function(o,e){var r=this,t=e.rankedEntityGroups.slice();return t.sort(function(a,s){var u=r.getProviderRank(o,a),l=r.getProviderRank(o,s);return a.providerId==s.providerId&&a.providerId==Ba.InsightsProviderIdentifier.INSIGHTS_PROVIDER_ID?a.rank-s.rank:u-l}),e.rankedEntityGroups=t,this.logger.info(595994314,"[SmartLookupRanker] RankedResults",{interactionId:o.interactionId,transactionId:o.transactionId,queryMatchEnabled:this.shouldMatchDocumentTitle,ranking:e.rankedEntityGroups.map(function(a){return a.groupTypeId})}),e},n.prototype.getProviderRank=function(o,e){var r=this;if(e.providerId==Ba.TapProviderIdentifier.TAP_SEARCH_QF_PROVIDER_ID&&this.shouldMatchDocumentTitle){var t=e;if(t.groupTypeId==Ba.TapProviderIdentifier.DOCUMENT_ID){var a=o,s=a!=null&&a.tapContext!=null?a.tapContext.queryText.toLocaleLowerCase().split(n.separators).filter(function(u){return u}):void 0;if(t.data.find(function(u){return r.isTextContainsSearchWords(u.Title.toLocaleLowerCase(),s)}))this.logger.debug(595973527,"[SmartLookupRanker] Query match with Qf Document succeeded",{interactionId:o.interactionId,transactionId:o.transactionId});else return this.logger.debug(595973526,"[SmartLookupRanker] Query match with Qf Document failed",{interactionId:o.interactionId,transactionId:o.transactionId}),Number.MAX_VALUE}}return n.providerRank[e.providerId]?n.providerRank[e.providerId]:Number.MAX_VALUE},n.prototype.isTextContainsSearchWords=function(o,e){if(e==null||o==null)return!1;var r=o.split(n.separators);return e.every(function(t){return r.find(function(a){return a.indexOf(t)>=0})!=null})},n.providerRank=(ku={},ku[Ba.TapProviderIdentifier.TAP_SEARCH_QF_PROVIDER_ID]=1,ku[Ba.InsightsProviderIdentifier.INSIGHTS_PROVIDER_ID]=2,ku),n.separators=/[\s]+/,n.defaultShouldQueryMatchQfDocumentTitle=!1,n}();Xd.SmartLookupRanker=t0;var ku});var sx=ne(Yd=>{"use strict";h();Object.defineProperty(Yd,"__esModule",{value:!0});var n0=ax();Yd.SmartLookupRanker=n0.SmartLookupRanker});var ux=ne((Uz,Wa)=>{h();function r0(n){if(n==null)throw new TypeError("Cannot destructure "+n)}Wa.exports=r0,Wa.exports.__esModule=!0,Wa.exports.default=Wa.exports});var wx=ne((eV,kx)=>{h();kx.exports=OfficePlatformGlobal.Telemetry.OTel});var Cx=ne((nV,Sx)=>{h();Sx.exports=OfficePlatformGlobal.Telemetry.OTelSDX});h();var Ox=w(ap());h();var $a=w(up());h();var lp=function(n){return n[n.Unknown=0]="Unknown",n[n.LiveId=1]="LiveId",n[n.OrgId=2]="OrgId",n[n.ActiveDirectory=3]="ActiveDirectory",n[n.ADAL=4]="ADAL",n[n.SSPI=5]="SSPI",n[n.OAuth2=6]="OAuth2",n}({});var Qt=function(n){return n[n.Error=0]="Error",n[n.Warning=1]="Warning",n[n.Info=3]="Info",n[n.Metric=4]="Metric",n[n.Verbose=5]="Verbose",n[n.Debug=6]="Debug",n}({});$a.CustomTypeRegistry.registerTypeInfos({"AugLoopData::InputData":{InputSchema:"$string",InputJson:"$string",CorrelationVector:"$string"},"AugLoopData::ResultData":{InputSchema:"$string",InputJson:"$string",OutputSchema:"$string",OutputJson:"$string"},"AugLoopData::ServiceGroups":{OfficeServiceGroup:"$number",ControllerServiceGroup:"$number"},"AugLoopData::HostMetadata":{AppName:"$string",AppPlatform:"$string",AppVersion:"$string",UILanguage:"$string",ClientId:"$string",ReleaseAudienceGroup:"$string",ReleaseChannel:"$string",ReleaseFork:"$string",SessionId:"$string",Flights:"$string",PrivateMode:"$boolean",DisabledServiceGroups:["$array","AugLoopData::ServiceGroups"],SystemTimezone:["opt-field","$string"]},"AugLoopData::ConfigTicket":{Provider:"$number",Policy:"$string",Target:"$string",ResourceId:"$string",AuthorityUrl:"$string"},"AugLoopData::ConnectParams":{isSeedingRequired:["opt-field","$boolean"],sessionUrl:["opt-field","$string"],origin:["opt-field","$string"],authToken:["opt-field","$string"]},"AugLoopData::AuthTokenRequest":{Tickets:["$array","AugLoopData::ConfigTicket"],DocId:["opt-field","$string"],DocSessionId:["opt-field","$string"],TokenType:["opt-field","$number"],ConnectParams:["opt-field","AugLoopData::ConnectParams"],Claims:["opt-field","$string"],Interactive:["opt-field","$boolean"]},"AugLoopData::AuthTokenResponse":{Token:"$string"},"AugLoopData::IdentityWithToken":{IdentityId:"$string",Token:"$string"},"AugLoopData::AuthTokensResponse":{Identites:["$array","AugLoopData::IdentityWithToken"]},"AugLoopData::CreateSessionParameters":{docSessionId:["opt-field","$string"],extensionConfigs:["opt-field",["$array","$string"]],flights:["opt-field","$string"],serviceUrl:["opt-field","$string"],offlineMode:["opt-field","$boolean"]},"AugLoopData::ActivateAnnotationParameters":{annotationType:"$string",token:"$string",config:["opt-field","$string"],docSessionId:["opt-field","$string"],forceReturnCachedAnnotations:["opt-field","$boolean"]},"AugLoopData::ReleaseAnnotationParameters":{token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::SubmitOperationsParameters":{operations:["$array","$string"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitSeedOperationsParameters":{operations:["$array","$string"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitSeedGroupOperationsParameters":{operations:["$array","$string"],groupComplete:["opt-field","$boolean"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitCustomMessageParameters":{message:"$string",messageId:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ForceReconnectParameters":{docSessionId:["opt-field","$string"],extensionConfigs:["opt-field",["$array","$string"]]},"AugLoopData::CloseParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetSessionCloseCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetConnectCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetDisconnectCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetOfflineModeParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::BridgeMessageParameters":{bridgeId:"$string",docSessionId:["opt-field","$string"],bridgeMessage:["opt-field","$string"],binaryMessage:["opt-field",["$array","$number"]]},"AugLoopData::SDXBridgeMessageParameters":{bridgeMessage:"$string"},"AugLoopData::InitAugLoopBridgeManagerParameters":{},"AugLoopData::CreateSessionResult":{errMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::ActivateAnnotationResult":{errMessage:["opt-field","$string"],token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::AnnotationResult":{operation:"$string",token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ReleaseAnnotationResult":{errMessage:["opt-field","$string"],token:"$string",result:["opt-field","$boolean"]},"AugLoopData::SubmitCustomMessageResult":{errMessage:["opt-field","$string"],response:["opt-field","$string"],messageId:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ForceReconnectResult":{errMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SessionCloseResult":{sessionCloseMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::ConnectResult":{isSeedingRequired:"$boolean",sessionUrl:"$string",origin:"$string",authToken:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::DisconnectResult":{error:"$string",docSessionId:["opt-field","$string"]}});var Vx={NativeService:["AugLoopData::NativeService",{OnResult:["FireAndForgetMethod",["AugLoopData::ResultData"]],OnCreateSessionResult:["FireAndForgetMethod",["AugLoopData::CreateSessionResult"]],OnActivateAnnotationResult:["FireAndForgetMethod",["AugLoopData::ActivateAnnotationResult"]],OnAnnotationResult:["FireAndForgetMethod",["AugLoopData::AnnotationResult"]],OnReleaseAnnotationResult:["FireAndForgetMethod",["AugLoopData::ReleaseAnnotationResult"]],OnSubmitCustomMessageResult:["FireAndForgetMethod",["AugLoopData::SubmitCustomMessageResult"]],OnForceReconnectResult:["FireAndForgetMethod",["AugLoopData::ForceReconnectResult"]],OnSessionCloseResult:["FireAndForgetMethod",["AugLoopData::SessionCloseResult"]],OnConnectResult:["FireAndForgetMethod",["AugLoopData::ConnectResult"]],OnDisconnectResult:["FireAndForgetMethod",["AugLoopData::DisconnectResult"]],OnIngressAugLoopBridgeMessage:["FireAndForgetMethod",["AugLoopData::BridgeMessageParameters"]],OnSDXBridgeMessageResult:["FireAndForgetMethod",["AugLoopData::SDXBridgeMessageParameters"]],RequestAuthToken:["ReturnsPromiseMethod","AugLoopData::AuthTokenResponse",["AugLoopData::AuthTokenRequest"]],RequestAuthTokens:["ReturnsPromiseMethod","AugLoopData::AuthTokensResponse",["AugLoopData::AuthTokenRequest"]],IsFeatureEnabled:["ReturnsPromiseMethod","$boolean",["$string","$string"]],IsChangeGateEnabled:["ReturnsPromiseMethod","$boolean",["$string"]],ExecuteLocalLambda:["ReturnsPromiseMethod","$string",["AugLoopData::InputData","$string","$string"]],AreLicenseFeaturesEnabled:["ReturnsPromiseMethod","$boolean",[["$array","$number"]]],SendDiagnosticTrace:["FireAndForgetMethod",["$number","$number","$string"]],OnSetServiceUrl:["Event","$string"],OnSetHostMetadata:["Event","AugLoopData::HostMetadata"],OnSubmit:["Event","AugLoopData::InputData"],OnCreateSession:["Event","AugLoopData::CreateSessionParameters"],OnActivateAnnotation:["Event","AugLoopData::ActivateAnnotationParameters"],OnReleaseAnnotation:["Event","AugLoopData::ReleaseAnnotationParameters"],OnSubmitOperations:["Event","AugLoopData::SubmitOperationsParameters"],OnSubmitSeedOperations:["Event","AugLoopData::SubmitSeedOperationsParameters"],OnSubmitSeedGroupOperations:["Event","AugLoopData::SubmitSeedGroupOperationsParameters"],OnSubmitCustomMessage:["Event","AugLoopData::SubmitCustomMessageParameters"],OnForceReconnect:["Event","AugLoopData::ForceReconnectParameters"],OnClose:["Event","AugLoopData::CloseParameters"],OnSetSessionCloseCallback:["Event","AugLoopData::SetSessionCloseCallbackParameters"],OnSetConnectCallback:["Event","AugLoopData::SetConnectCallbackParameters"],OnSetDisconnectCallback:["Event","AugLoopData::SetDisconnectCallbackParameters"],OnSetOfflineMode:["Event","AugLoopData::SetOfflineModeParameters"],OnInitAugLoopBridgeManager:["Event","AugLoopData::InitAugLoopBridgeManagerParameters"],OnEgressAugLoopBridgeMessage:["Event","AugLoopData::BridgeMessageParameters"],OnSDXBridgeMessageFromNative:["Event","AugLoopData::SDXBridgeMessageParameters"]}]},fp={NativeService:$a.RekaServiceRegistry.getNativeService(Vx.NativeService)};h();var Rx=w(at());h();var pt;(function(n){n[n.EditorLowPrivilege=0]="EditorLowPrivilege",n[n.AugLoopLowPrivilege=1]="AugLoopLowPrivilege",n[n.Anonymous=2]="Anonymous",n[n.ClientAssertion=3]="ClientAssertion",n[n.ClientAssertionV2=4]="ClientAssertionV2",n[n.AutoClpLowPrivilege=5]="AutoClpLowPrivilege",n[n.AutoClpAppOnlyLowPrivilege=6]="AutoClpAppOnlyLowPrivilege",n[n.Substrate=7]="Substrate",n[n.WacUserInfo=8]="WacUserInfo",n[n.OwaExchange=9]="OwaExchange",n[n.SmartCompose=10]="SmartCompose",n[n.WritingAnalyticsLowPrivilege=11]="WritingAnalyticsLowPrivilege",n[n.DWEngineLowPrivilege=12]="DWEngineLowPrivilege",n[n.SubstrateApp=13]="SubstrateApp",n[n.CortanaAppPop=14]="CortanaAppPop",n[n.OfficeAppsAppOnly=15]="OfficeAppsAppOnly",n[n.PPTFrontdoorAppPop=16]="PPTFrontdoorAppPop",n[n.EditorAppOnlyLowPrivilege=17]="EditorAppOnlyLowPrivilege",n[n.AugLoopApp=18]="AugLoopApp",n[n.MeetingIntelligenceApp=19]="MeetingIntelligenceApp",n[n.GraphApp=20]="GraphApp",n[n.IceServicesApp=21]="IceServicesApp",n[n.AzureMapsApp=22]="AzureMapsApp",n[n.SpoApp=23]="SpoApp",n[n.OneDrive=24]="OneDrive",n[n.GoogleDrive=25]="GoogleDrive",n[n.GettyApp=26]="GettyApp",n[n.Dropbox=27]="Dropbox",n[n.GooglePhotos=28]="GooglePhotos",n[n.EditorApp=29]="EditorApp",n[n.AmazonKindle=30]="AmazonKindle",n[n.ShredderApp=31]="ShredderApp",n[n.FormsLowPrivilege=32]="FormsLowPrivilege",n[n.VivaSalesLowPrivilege=33]="VivaSalesLowPrivilege",n[n.IntentSvcApp=34]="IntentSvcApp",n[n.DcgLowPrivilege=35]="DcgLowPrivilege",n[n.CSALowPrivilege=36]="CSALowPrivilege",n[n.ConsumerSydneyLowPrivilege=37]="ConsumerSydneyLowPrivilege",n[n.CompliantSydneyApp=38]="CompliantSydneyApp",n[n.M365AdminApp=39]="M365AdminApp",n[n.MeetingArtifactsServiceLowPrivilege=40]="MeetingArtifactsServiceLowPrivilege",n[n.AlchemyApp=41]="AlchemyApp",n[n.M365Admin=42]="M365Admin",n[n.ConsumerShellApp=43]="ConsumerShellApp",n[n.PowerQueryLowPrivilege=44]="PowerQueryLowPrivilege",n[n.CIIApp=45]="CIIApp",n[n.ConsumerShell=46]="ConsumerShell",n[n.AssistCopilotLowPrivilege=47]="AssistCopilotLowPrivilege",n[n.Pva=48]="Pva",n[n.TeamsCopilotServiceLowPrivilege=49]="TeamsCopilotServiceLowPrivilege",n[n.CallAnalytics=50]="CallAnalytics",n[n.IncomingPFT=51]="IncomingPFT",n[n.GraphExchange=52]="GraphExchange",n[n.EXOAdmin=53]="EXOAdmin",n[n.InsightsServicesLowPrivilege=54]="InsightsServicesLowPrivilege",n[n.VivaServicesLowPrivilege=55]="VivaServicesLowPrivilege",n[n.EcsAppOnly=56]="EcsAppOnly",n[n.ShredderLowPrivilege=57]="ShredderLowPrivilege",n[n.SpoLowPrivilege=58]="SpoLowPrivilege",n[n.PromptValidationApp=59]="PromptValidationApp",n[n.CompliantSydneyLowPrivilege=60]="CompliantSydneyLowPrivilege",n[n.SubstrateTenantFeedbackApp=61]="SubstrateTenantFeedbackApp",n[n.MonitoringPlatform=62]="MonitoringPlatform",n[n.YammerLowPrivilege=63]="YammerLowPrivilege",n[n.VivaLearningLowPrivilege=64]="VivaLearningLowPrivilege",n[n.VivaInsightsLowPrivilege=65]="VivaInsightsLowPrivilege",n[n.ClientAugLoopApp=66]="ClientAugLoopApp",n[n.AssistAuthLowPrivilege=67]="AssistAuthLowPrivilege",n[n.VivaLearningSearchPreProdLowPrivilege=68]="VivaLearningSearchPreProdLowPrivilege",n[n.SubstrateSearchApp=69]="SubstrateSearchApp",n[n.SparkContentPlatformLowPrivilege=70]="SparkContentPlatformLowPrivilege",n[n.SparkContentPlatformPopApp=71]="SparkContentPlatformPopApp",n[n.ConsumerSydneyApp=72]="ConsumerSydneyApp",n[n.BusinessAssistAuthLowPrivilege=73]="BusinessAssistAuthLowPrivilege",n[n.AzureResourceManager=74]="AzureResourceManager",n[n.AlchemyPortal=75]="AlchemyPortal",n[n.VivaUserSkillsApp=76]="VivaUserSkillsApp",n[n.VivaEngageAppPop=77]="VivaEngageAppPop",n[n.SubstrateAppOnly=78]="SubstrateAppOnly",n[n.PowerAutomateFlowCreationLowPrivilege=79]="PowerAutomateFlowCreationLowPrivilege",n[n.PowerAutomateConnectionCreationLowPrivilege=80]="PowerAutomateConnectionCreationLowPrivilege",n[n.PowerAutomateAuthorizeConnectionLowPrivilege=81]="PowerAutomateAuthorizeConnectionLowPrivilege",n[n.TCAAppPop=82]="TCAAppPop",n[n.BusinessAssistAuthAppPop=83]="BusinessAssistAuthAppPop",n[n.HolmesApp=84]="HolmesApp",n[n.GraphAppOnly=85]="GraphAppOnly",n[n.SimsApp=86]="SimsApp",n[n.VivaOrgInsightsLowPrivilege=87]="VivaOrgInsightsLowPrivilege",n[n.VivaGoalsAppPop=88]="VivaGoalsAppPop",n[n.GCBotAppPop=89]="GCBotAppPop",n[n.ShredderV2App=90]="ShredderV2App",n[n.ShredderV2LowPrivilege=91]="ShredderV2LowPrivilege"})(pt||(pt={}));var pp;(function(n){n[n.Unknown=0]="Unknown",n[n.Consumer=1]="Consumer",n[n.Enterprise=2]="Enterprise"})(pp||(pp={}));var gp;(function(n){n.AuthorizationCode="authorization_code",n.ClientCredentials="client_credentials",n.RefreshToken="refresh_token"})(gp||(gp={}));var hp;(function(n){n[n.LoggedIn=0]="LoggedIn",n[n.LoggedOut=1]="LoggedOut"})(hp||(hp={}));h();var Co;(function(n){n[n.Add=1]="Add",n[n.Update=2]="Update",n[n.Delete=3]="Delete"})(Co||(Co={}));h();h();var Rt;(function(n){n[n.Undefined=0]="Undefined",n[n.Created=10]="Created",n[n.Sent=20]="Sent",n[n.Duplicated=30]="Duplicated",n[n.Seen=40]="Seen",n[n.Tried=50]="Tried",n[n.Kept=60]="Kept",n[n.Rejected=70]="Rejected"})(Rt||(Rt={}));h();var Nu;(function(n){n.Canvas="Canvas",n.CopilotChat="CopilotChat",n.Test="Test"})(Nu||(Nu={}));var xt;(function(n){n[n.None=0]="None",n[n.Added=1]="Added",n[n.Updated=2]="Updated",n[n.Deleted=3]="Deleted"})(xt||(xt={}));var mr;(function(n){n[n.ContentChanged=0]="ContentChanged",n[n.ContentWasEmpty=1]="ContentWasEmpty",n[n.FormattingChanged=2]="FormattingChanged",n[n.ContentWasInsideOfTheTable=3]="ContentWasInsideOfTheTable"})(mr||(mr={}));var Me;(function(n){n[n.AddOfZeroElements=0]="AddOfZeroElements",n[n.AddOfItemsWithExtraOrMissingIds=1]="AddOfItemsWithExtraOrMissingIds",n[n.AddOfItemWithUndefinedId=2]="AddOfItemWithUndefinedId",n[n.AddOfUndefinedItem=3]="AddOfUndefinedItem",n[n.AddOfItemsWithDuplicateIds=4]="AddOfItemsWithDuplicateIds",n[n.SetHeadToNonExistingItem=5]="SetHeadToNonExistingItem",n[n.DeleteOfNonExistingItem=6]="DeleteOfNonExistingItem",n[n.UpdateOfNonExistentItem=7]="UpdateOfNonExistentItem",n[n.UpdateOfStubbedItem=8]="UpdateOfStubbedItem",n[n.MoveOfNonExistentItem=9]="MoveOfNonExistentItem",n[n.UpdateMetaDataOfNonAnnotationType=10]="UpdateMetaDataOfNonAnnotationType",n[n.SequentialyInvertedUpdate=11]="SequentialyInvertedUpdate",n[n.MoveToTheSamePath=12]="MoveToTheSamePath",n[n.UnknownOperation=13]="UnknownOperation",n[n.DeltaOfNonExistingItem=100]="DeltaOfNonExistingItem"})(Me||(Me={}));h();var wp=w(B()),Sp=w(R());var xo;(function(n){n[n.None=0]="None",n[n.HttpsGetDownloadUrl=1]="HttpsGetDownloadUrl",n[n.AlCodedLocation=2]="AlCodedLocation",n[n.Token=3]="Token"})(xo||(xo={}));var kp;(function(n){n[n.NewDocument=0]="NewDocument",n[n.EditDocument=1]="EditDocument",n[n.ViewOnlyDocument=2]="ViewOnlyDocument"})(kp||(kp={}));var Or=(0,wp.default)(function n(){(0,Sp.default)(this,n)});Or.lowerIndexBound=1;Or.maxNumberOfRows=1048576;Or.maxNumberOfColumns=16384;Or.firstColumnName="A";Or.lastColumnName="XFD";h();var Ha=w(R()),za=w(B());h();var Tp=w(Se()),Ip=w(R()),_p=w(B()),y=function(){function n(o){(0,Ip.default)(this,n),n.assign(n,this,o)}return(0,_p.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_SchemaObject"}},{key:"getBaseTypes",value:function(){return[]}},{key:"getTypeNameFor",value:function(e){return e&&e.H_?e.H_.T_:void 0}},{key:"getBaseTypesFor",value:function(e){return e&&e.H_&&e.H_.B_?e.H_.B_:[]}},{key:"getAllTypesFor",value:function(e){var r=n.getTypeNameFor(e);return r?[r].concat((0,Tp.default)(n.getBaseTypesFor(e))):[]}},{key:"matchesTypesFor",value:function(e,r){if(!Array.isArray(r)||r.length===0)return!0;var t=n.getTypeNameFor(e),a=n.getBaseTypesFor(e);for(var s of r)if(s===t||a.indexOf(s)>=0)return!0;return!1}},{key:"assign",value:function(e,r,t){if(t)for(var a of Object.keys(t))r[a]=t[a];return r.H_=e.H_,r}}]),n}();y.H_={T_:y.getTypeName(),B_:y.getBaseTypes()};var At=function(){function n(o){(0,Ha.default)(this,n),y.assign(n,this,o)}return(0,za.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_Annotation"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();At.H_={T_:At.getTypeName(),B_:At.getBaseTypes()};var Pu=function(){function n(o){(0,Ha.default)(this,n),y.assign(n,this,o)}return(0,za.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_BinaryClassificationAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Pu.H_={T_:Pu.getTypeName(),B_:Pu.getBaseTypes()};var Ru=function(){function n(o){(0,Ha.default)(this,n),y.assign(n,this,o)}return(0,za.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_StreamAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ru.H_={T_:Ru.getTypeName(),B_:Ru.getBaseTypes()};h();var Wu=w(R()),Ou=w(B());var Lr=function(){function n(o){(0,Wu.default)(this,n),y.assign(n,this,o)}return(0,Ou.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Event"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Lr.H_={T_:Lr.getTypeName(),B_:Lr.getBaseTypes()};var Bu=function(){function n(o){(0,Wu.default)(this,n),y.assign(n,this,o)}return(0,Ou.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserCommand"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Event"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Bu.H_={T_:Bu.getTypeName(),B_:Bu.getBaseTypes()};h();var yt=w(R()),kt=w(B());var Lu=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemDelta"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Lu.H_={T_:Lu.getTypeName(),B_:Lu.getBaseTypes()};var Hn=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemChangesDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Hn.H_={T_:Hn.getTypeName(),B_:Hn.getBaseTypes()};var vr=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Operation"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();vr.H_={T_:vr.getTypeName(),B_:vr.getBaseTypes()};var Fu=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_OperationWithSiblingContext"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Fu.H_={T_:Fu.getTypeName(),B_:Fu.getBaseTypes()};var ke=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_AddOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ke.H_={T_:ke.getTypeName(),B_:ke.getBaseTypes()};var kn=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_MoveOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();kn.H_={T_:kn.getTypeName(),B_:kn.getBaseTypes()};var vt=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();vt.H_={T_:vt.getTypeName(),B_:vt.getBaseTypes()};var Pe=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UpdateOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Pe.H_={T_:Pe.getTypeName(),B_:Pe.getBaseTypes()};var Ge=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DeleteOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ge.H_={T_:Ge.getTypeName(),B_:Ge.getBaseTypes()};var To=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_PurgeOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();To.H_={T_:To.getTypeName(),B_:To.getBaseTypes()};var Io=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_PurgeSubtreeOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Io.H_={T_:Io.getTypeName(),B_:Io.getBaseTypes()};var _o=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_PurgeByTypesOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();_o.H_={T_:_o.getTypeName(),B_:_o.getBaseTypes()};var qu=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_FocusOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();qu.H_={T_:qu.getTypeName(),B_:qu.getBaseTypes()};var $u=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_VisibilityOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();$u.H_={T_:$u.getTypeName(),B_:$u.getBaseTypes()};var Gt=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DeltaUpdateOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Gt.H_={T_:Gt.getTypeName(),B_:Gt.getBaseTypes()};var Gu=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_MicroSyncOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Gu.H_={T_:Gu.getTypeName(),B_:Gu.getBaseTypes()};var ot=function(){function n(o){(0,yt.default)(this,n),y.assign(n,this,o)}return(0,kt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_SignalOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ot.H_={T_:ot.getTypeName(),B_:ot.getBaseTypes()};h();var Va=w(R()),Qa=w(B());var Jt=function(){function n(o){(0,Va.default)(this,n),y.assign(n,this,o)}return(0,Qa.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_Signal"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Jt.H_={T_:Jt.getTypeName(),B_:Jt.getBaseTypes()};var En=function(){function n(o){(0,Va.default)(this,n),y.assign(n,this,o)}return(0,Qa.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DirtyAreaSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();En.H_={T_:En.getTypeName(),B_:En.getBaseTypes()};var Uu=function(){function n(o){(0,Va.default)(this,n),y.assign(n,this,o)}return(0,Qa.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DirtyDocumentSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Uu.H_={T_:Uu.getTypeName(),B_:Uu.getBaseTypes()};h();var bt=w(R()),Et=w(B());var Hu=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Blob"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Hu.H_={T_:Hu.getTypeName(),B_:Hu.getBaseTypes()};var zu=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Binary"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();zu.H_={T_:zu.getTypeName(),B_:zu.getBaseTypes()};var Vu=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_TileGroup"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Vu.H_={T_:Vu.getTypeName(),B_:Vu.getBaseTypes()};var Qu=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Session"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Qu.H_={T_:Qu.getTypeName(),B_:Qu.getBaseTypes()};var Mt=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Document"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Mt.H_={T_:Mt.getTypeName(),B_:Mt.getBaseTypes()};var zn=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_SubDocument"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();zn.H_={T_:zn.getTypeName(),B_:zn.getBaseTypes()};var Nn=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_GridCell"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Nn.H_={T_:Nn.getTypeName(),B_:Nn.getBaseTypes()};var Ju=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_GridNeighborhoodContext"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ju.H_={T_:Ju.getTypeName(),B_:Ju.getBaseTypes()};var ju=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemFilter"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ju.H_={T_:ju.getTypeName(),B_:ju.getBaseTypes()};var Ku=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DynamicContext"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ku.H_={T_:Ku.getTypeName(),B_:Ku.getBaseTypes()};var yi=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ContextHolder"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();yi.H_={T_:yi.getTypeName(),B_:yi.getBaseTypes()};var yr=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserContextHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ContextHolder"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();yr.H_={T_:yr.getTypeName(),B_:yr.getBaseTypes()};var kr=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_TenantContextHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ContextHolder"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();kr.H_={T_:kr.getTypeName(),B_:kr.getBaseTypes()};var Xu=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_EventsHolder"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Xu.H_={T_:Xu.getTypeName(),B_:Xu.getBaseTypes()};var ki=function(){function n(o){(0,bt.default)(this,n),y.assign(n,this,o)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserCommandsHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_EventsHolder"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ki.H_={T_:ki.getTypeName(),B_:ki.getBaseTypes()};h();var Zu=w(R()),el=w(B());var rn=function(){function n(o){(0,Zu.default)(this,n),y.assign(n,this,o)}return(0,el.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_Apology"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();rn.H_={T_:rn.getTypeName(),B_:rn.getBaseTypes()};var Yu=function(){function n(o){(0,Zu.default)(this,n),y.assign(n,this,o)}return(0,el.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_SecondaryApology"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Apology","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Yu.H_={T_:Yu.getTypeName(),B_:Yu.getBaseTypes()};h();var Ap;(function(n){n[n.MastermindAsyncBoundaryLoader=0]="MastermindAsyncBoundaryLoader",n[n.TruncatedModelIteratingLoader=1]="TruncatedModelIteratingLoader",n[n.ExcelAsyncBoundaryLoader=2]="ExcelAsyncBoundaryLoader"})(Ap||(Ap={}));var Fr;(function(n){n[n.Filtering=0]="Filtering",n[n.ModelIterating=1]="ModelIterating"})(Fr||(Fr={}));h();var Ja;(function(n){n[n.Unknown=0]="Unknown",n[n.LiveId=1]="LiveId",n[n.OrgId=2]="OrgId",n[n.ActiveDirectory=3]="ActiveDirectory",n[n.ADAL=4]="ADAL",n[n.SSPI=5]="SSPI",n[n.OAuth2=6]="OAuth2",n[n.Badger=7]="Badger"})(Ja||(Ja={}));var Vn;(function(n){n[n.Augloop=0]="Augloop",n[n.Substrate=1]="Substrate"})(Vn||(Vn={}));h();var wn;(function(n){n[n.Input=0]="Input",n[n.Exception=1]="Exception",n[n.WaitOn=2]="WaitOn",n[n.StopAndFilterWorkflow=3]="StopAndFilterWorkflow"})(wn||(wn={}));var xe;(function(n){n[n.Unknown=0]="Unknown",n[n.NoOutput=1]="NoOutput",n[n.Authentication=2]="Authentication",n[n.JoinTimedOut=3]="JoinTimedOut",n[n.LambdaThrow=4]="LambdaThrow",n[n.LambdaErrorCallback=5]="LambdaErrorCallback"})(xe||(xe={}));h();var wi;(function(n){var o;(function(e){e[e.Undefined=0]="Undefined",e[e.Delete=1]="Delete",e[e.Add=2]="Add",e[e.Change=3]="Change",e[e.Refresh=4]="Refresh"})(o=n.SlideTileEventType||(n.SlideTileEventType={}))})(wi||(wi={}));h();var Qn;(function(n){var o;(function(u){u[u.Unknown=0]="Unknown",u[u.Text=1]="Text",u[u.Slide=2]="Slide"})(o=n.TileType||(n.TileType={}));var e;(function(u){u[u.Generic=0]="Generic",u[u.Title=1]="Title",u[u.SmartArt=2]="SmartArt",u[u.TableCell=3]="TableCell",u[u.TextBox=4]="TextBox",u[u.Notes=5]="Notes"})(e=n.TextTileType||(n.TextTileType={}));var r;(function(u){u[u.Undefined=0]="Undefined",u[u.Word=1]="Word",u[u.Phrase=2]="Phrase",u[u.Sentence=3]="Sentence",u[u.Paragraph=4]="Paragraph"})(r=n.TextTileElementUnit||(n.TextTileElementUnit={}));var t;(function(u){u[u.Undefined=0]="Undefined",u[u.Bullet=1]="Bullet",u[u.Numbered=2]="Numbered"})(t=n.ListType||(n.ListType={}));var a;(function(u){u[u.Undefined=0]="Undefined",u[u.AlphaLcParenBoth=1]="AlphaLcParenBoth",u[u.AlphaUcParenBoth=2]="AlphaUcParenBoth",u[u.AlphaLcParenR=3]="AlphaLcParenR",u[u.AlphaUcParenR=4]="AlphaUcParenR",u[u.AlphaLcPeriod=5]="AlphaLcPeriod",u[u.AlphaUcPeriod=6]="AlphaUcPeriod",u[u.ArabicParenBoth=7]="ArabicParenBoth",u[u.ArabicParenR=8]="ArabicParenR",u[u.ArabicPeriod=9]="ArabicPeriod",u[u.ArabicPlain=10]="ArabicPlain",u[u.RomanLcParenBoth=11]="RomanLcParenBoth",u[u.RomanUcParenBoth=12]="RomanUcParenBoth",u[u.RomanLcParenR=13]="RomanLcParenR",u[u.RomanUcParenR=14]="RomanUcParenR",u[u.RomanLcPeriod=15]="RomanLcPeriod",u[u.RomanUcPeriod=16]="RomanUcPeriod",u[u.CircleNumDbPlain=17]="CircleNumDbPlain",u[u.CircleNumWdBlackPlain=18]="CircleNumWdBlackPlain",u[u.CircleNumWdWhitePlain=19]="CircleNumWdWhitePlain",u[u.ArabicDbPeriod=20]="ArabicDbPeriod",u[u.ArabicDbPlain=21]="ArabicDbPlain",u[u.Ea1ChsPeriod=22]="Ea1ChsPeriod",u[u.Ea1ChsPlain=23]="Ea1ChsPlain",u[u.Ea1ChtPeriod=24]="Ea1ChtPeriod",u[u.Ea1ChtPlain=25]="Ea1ChtPlain",u[u.Ea1JpnChsDbPeriod=26]="Ea1JpnChsDbPeriod",u[u.Ea1JpnKorPlain=27]="Ea1JpnKorPlain",u[u.Ea1JpnKorPeriod=28]="Ea1JpnKorPeriod",u[u.Arabic1Minus=29]="Arabic1Minus",u[u.Arabic2Minus=30]="Arabic2Minus",u[u.Hebrew2Minus=31]="Hebrew2Minus",u[u.ThaiAlphaPeriod=32]="ThaiAlphaPeriod",u[u.ThaiAlphaParenR=33]="ThaiAlphaParenR",u[u.ThaiAlphaParenBoth=34]="ThaiAlphaParenBoth",u[u.ThaiNumPeriod=35]="ThaiNumPeriod",u[u.ThaiNumParenR=36]="ThaiNumParenR",u[u.ThaiNumParenBoth=37]="ThaiNumParenBoth",u[u.HindiAlphaPeriod=38]="HindiAlphaPeriod",u[u.HindiNumPeriod=39]="HindiNumPeriod",u[u.HindiNumParenR=40]="HindiNumParenR",u[u.HindiAlpha1Period=41]="HindiAlpha1Period"})(a=n.ListNumeration||(n.ListNumeration={}));var s;(function(u){u[u.Undefined=0]="Undefined",u[u.Delete=1]="Delete",u[u.Add=2]="Add",u[u.Change=3]="Change",u[u.Refresh=4]="Refresh"})(s=n.TextTileEventType||(n.TextTileEventType={}))})(Qn||(Qn={}));h();var Dn;(function(n){n[n.Undefined=0]="Undefined",n[n.Schema=1]="Schema",n[n.Boolean=2]="Boolean",n[n.Number=3]="Number",n[n.String=4]="String",n[n.Buffer=5]="Buffer",n[n.Function=6]="Function"})(Dn||(Dn={}));h();var Np=w(B()),Dp=w(R()),Pp=w(ze()),Rp=w(Ve()),il=w(Oe()),Bp=w(ol());function RT(n){var o=BT();return function(){var r=(0,il.default)(n),t;if(o){var a=(0,il.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Rp.default)(this,t)}}function BT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var wr;(function(n){n[n.JoinContext=0]="JoinContext",n[n.Session=1]="Session"})(wr||(wr={}));var Mo=function(n){(0,Pp.default)(e,n);var o=RT(e);function e(){var r,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"ExpectedError";return(0,Dp.default)(this,e),r=o.call(this,t),r.__proto__=e.prototype,r}return(0,Np.default)(e)}((0,Bp.default)(Error));h();var wt;(function(n){n[n.error=0]="error",n[n.warn=1]="warn",n[n.info=3]="info",n[n.metric=4]="metric",n[n.verbose=5]="verbose",n[n.debug=6]="debug",n[n.disabled=7]="disabled"})(wt||(wt={}));h();var Bt;(function(n){n[n.Active=0]="Active",n[n.Stopped=1]="Stopped",n[n.Paused=2]="Paused"})(Bt||(Bt={}));h();var _i;(function(n){n[n.ProductServiceUsage=2]="ProductServiceUsage",n[n.ProductServicePerformance=4]="ProductServicePerformance"})(_i||(_i={}));var Xa;(function(n){n[n.BasicEvent=10]="BasicEvent",n[n.FullEvent=100]="FullEvent",n[n.RequiredServiceDataEvent=110]="RequiredServiceDataEvent"})(Xa||(Xa={}));h();var Ai;(function(n){n[n.DocumentUpdate=0]="DocumentUpdate",n[n.Timeout=1]="Timeout",n[n.CloseSession=2]="CloseSession",n[n.Other=3]="Other"})(Ai||(Ai={}));h();var U;(function(n){n[n.SingleItem=0]="SingleItem",n[n.Reduce=1]="Reduce",n[n.Grid=2]="Grid",n[n.DynamicText=3]="DynamicText",n[n.Join=4]="Join",n[n.Generic=5]="Generic"})(U||(U={}));var Ya;(function(n){n.Default="Default",n.Copilot="Copilot"})(Ya||(Ya={}));var qr;(function(n){n[n.Default=0]="Default",n[n.LocalOnly=1]="LocalOnly",n[n.Exclusive=2]="Exclusive"})(qr||(qr={}));var Sn;(function(n){n[n.PreActivate=0]="PreActivate",n[n.Default=1]="Default",n[n.DelayActivate=1]="DelayActivate",n[n.NeverActivate=2]="NeverActivate"})(Sn||(Sn={}));var Sr;(function(n){n[n.Required=-3]="Required",n[n.Optional=-1]="Optional"})(Sr||(Sr={}));var bo;(function(n){n[n.Never=0]="Never",n[n.Always=1]="Always"})(bo||(bo={}));var Ut;(function(n){n[n.PreSeed=1]="PreSeed",n[n.OnSeed=2]="OnSeed",n[n.PostSeed=4]="PostSeed",n[n.All=5]="All"})(Ut||(Ut={}));var Ht;(function(n){n[n.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady",n[n.AnnotationMetadataUpdated=1]="AnnotationMetadataUpdated",n[n.DeltaUpdate=2]="DeltaUpdate",n[n.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals"})(Ht||(Ht={}));var Pn;(function(n){n[n.Character=1]="Character",n[n.Paragraph=2]="Paragraph"})(Pn||(Pn={}));var on;(function(n){n.Input="Input",n.Delta="Delta",n.UILanguage="UILanguage",n.MaxInputCount="MaxInputCount"})(on||(on={}));var Eo;(function(n){n.SetPredefinedAnnotation="SetPredefinedAnnotation",n.ClearAnnotations="ClearAnnotations"})(Eo||(Eo={}));h();var Za;(function(n){n[n.Input=1]="Input",n[n.Output=2]="Output"})(Za||(Za={}));var Wp;(function(n){n[n.Single=1]="Single",n[n.Any=-1]="Any",n[n.Optional=-2]="Optional",n[n.Some=-3]="Some"})(Wp||(Wp={}));h();var Xn;(function(n){n[n.WorkflowSession=0]="WorkflowSession",n[n.User=1]="User"})(Xn||(Xn={}));h();var es=w(R()),ts=w(B());var al=function(){function n(o){(0,es.default)(this,n),y.assign(n,this,o)}return(0,ts.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_AsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();al.H_={T_:al.getTypeName(),B_:al.getBaseTypes()};var Mi=function(){function n(o){(0,es.default)(this,n),y.assign(n,this,o)}return(0,ts.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_FilteringAsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Interfaces_AsyncBoundaryRequest"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Mi.H_={T_:Mi.getTypeName(),B_:Mi.getBaseTypes()};var bi=function(){function n(o){(0,es.default)(this,n),y.assign(n,this,o)}return(0,ts.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_ModelIteratingAsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Interfaces_AsyncBoundaryRequest"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();bi.H_={T_:bi.getTypeName(),B_:bi.getBaseTypes()};h();h();var Fp=w(B()),qp=w(R());h();var ns;(function(n){n.Log="Log"})(ns||(ns={}));var WT=typeof process!="undefined"&&process.env?process.env.SERVICE_NAME:"client",Ei="abcdefghijklmnopqrstuvwxyz0123456789",Ni={97:0,98:1,99:2,100:3,101:4,102:5,103:6,104:7,105:8,106:9,107:10,108:11,109:12,110:13,111:14,112:15,113:16,114:17,115:18,116:19,117:20,118:21,119:22,120:23,121:24,122:25,48:26,49:27,50:28,51:29,52:30,53:31,54:32,55:33,56:34,57:35},rs=[],os=[],Cr,$p=function(o){return null},Gp=function(o){},Do=new Map,sl=new Map,ul=new Map,ll=new Map,m;(function(n){n.defineCoreLogCategory=function(o){return{root:"Core",name:o}},n.defineWorkflowLogCategory=function(o){return{root:"Workflow",name:o}},n.clearLoggers=function(){rs=[],os=[],sl.clear(),ul.clear()},n.clearAggregators=function(){Do.clear()},n.addLogger=function(o){rs.indexOf(o)===-1&&(rs.push(o),Op(sl,o))},n.addDecidingLogger=function(o){os.indexOf(o)===-1&&(os.push(o),Op(ul,o))},n.setCorrelationContextCallback=function(o){Cr=o},n.setStartPerformanceEventCallback=function(o){$p=o},n.setStopPerformanceEventCallback=function(o){Gp=o},n.addAggregator=function(o){o.init(function(e,r){Di(e,r)}),Do.has(o.eventName)?Do.get(o.eventName).push(o):Do.set(o.eventName,[o])},n.flushAggregators=function(o){Do.forEach(function(e){e.forEach(function(r){return r.flush(o)})})},n.setTagLevelOverride=function(o,e){var r=GT(o);ll.set(r,e)},n.resetTagLevelOverrides=function(){ll.clear()},n.error=function(o,e,r,t,a,s,u,l,f,c){No(o,e,wt.error,r,t,a,s,u,l,f,c)},n.warn=function(o,e,r,t,a,s,u,l,f,c){No(o,e,wt.warn,r,t,a,s,u,l,f,c)},n.info=function(o,e,r,t,a,s,u,l,f,c){No(o,e,wt.info,r,t,a,s,u,l,f,c)},n.verbose=function(o,e,r,t,a,s,u,l,f,c){No(o,e,wt.verbose,r,t,a,s,u,l,f,c)},n.debug=function(o,e,r,t,a,s,u,l,f,c){No(o,e,wt.debug,r,t,a,s,u,l,f,c)},n.metric=function(o,e,r,t,a,s,u,l,f,c){No(o,e,wt.metric,r,t,a,s,u,l,f,c)},n.formatMetric=function(o,e,r,t){var a={};return a[o]={dimensionNames:r,dimensionValues:t,value:e},a},n.dynamic=function(o){Di(o)}})(m||(m={}));var Op=function(o,e){var r=e.level;Object.keys(wt).map(function(t){return wt[t]}).filter(function(t){return typeof t!="string"}).filter(function(t){return t<=r}).forEach(function(t){o.has(t)?o.get(t).push(e):o.set(t,[e])})},OT=function(o,e,r,t,a,s,u,l){if(e===void 0&&(typeof o=="string"||typeof o=="object"))return o;if(e===void 0&&typeof o=="function")return o();var f=[];for(var c of[o,e,r,t,a,s,u,l])c!==void 0&&f.push(typeof c=="function"?c():c);return f},Up=function(o){if(typeof o=="string")return o;for(var e="",r=0;r<o.length;r++){r>0&&(e+=" ");var t=o[r];t instanceof Error?e+=JSON.stringify({message:t.message,name:t.name,stack:t.stack}):typeof t=="object"?e+=JSON.stringify(t):e+=t}return e},Hp=[],LT=["Level","Tag"],FT=["Level","Tag","Workflow"],is=function(o){return fl(o).length},fl=function(o){return o!==void 0?sl.get(o)||Hp:rs},qT=function(o,e){var r=o!==void 0?ul.get(o)||[]:os;return r.filter(function(t){return t.shouldLog(e)})},No=function(o,e,r,t,a,s,u,l,f,c,d){r=ll.get(o)||r;var p=fl(r),g=qT(r,t);if(!(p.length==0&&g.length==0)){var k=$p(ns.Log),S=zp(o),x=OT(t,a,s,u,l,f,c,d);if($T(e))Lp(x)&&Di({eventName:"Metrics",tagId:S,category:`${e.root}.${e.name}`,traceLevel:r,message:"",getMetrics:function(){return x}},!1,p,g);else if(Lp(x)){var C=x;C.tagId=S,C.category=`${e.root}.${e.name}`,C.eventName==="Operation"&&e.root==="Workflow"&&(C.eventName="WorkflowOperation",Cr&&(C.joinContextId=Cr().joinContextId,C.workflow=Cr().workflow)),C.traceLevel=r;var T=Do.get(C.eventName);if(T)for(var I=0;I<T.length;++I){var _=T[I];if(_&&_.add(C,I===T.length-1))break}else Di(C,!1,p,g)}else{var M=function(){var b;return e.root==="Core"?{TraceEventV2:{dimensionNames:function(){return LT},dimensionValues:[String(r),S],value:1}}:{WorkflowTraceEvent:{dimensionNames:function(){return FT},dimensionValues:[String(r),S,Cr?(b=Cr())===null||b===void 0?void 0:b.workflow:""],value:1}}};Di({eventName:"Log",tagId:S,category:`${e.root}.${e.name}`,traceLevel:r,message:Up(x),getMetrics:M},!1,p,g)}Gp(k)}},Di=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2?arguments[2]:void 0,t=arguments.length>3?arguments[3]:void 0,a,s,u,l,f,c,d,p,g,k,S;if(r==null&&(r=fl(o.traceLevel)),t=t||Hp,r.length>0||t.length>0){if(o.serviceName=WT,!e&&Cr){var x=Cr();x&&(o.cv=o.cv?o.cv:x.cv.toString(),o.sessionKey=o.sessionKey?o.sessionKey:x.sessionKey,o.workflow=o.workflow?o.workflow:x.workflow,o.clientAppName=o.clientAppName?o.clientAppName:(a=x.clientMetadata)===null||a===void 0?void 0:a.appName,o.clientAppPlatform=o.clientAppPlatform?o.clientAppPlatform:(s=x.clientMetadata)===null||s===void 0?void 0:s.appPlatform,o.clientAppVersion=o.clientAppVersion?o.clientAppVersion:(u=x.clientMetadata)===null||u===void 0?void 0:u.appVersion,o.clientDeviceId=o.clientDeviceId?o.clientDeviceId:(l=x.clientMetadata)===null||l===void 0?void 0:l.deviceId,o.clientDocSessionId=o.clientDocSessionId?o.clientDocSessionId:(f=x.clientMetadata)===null||f===void 0?void 0:f.docSessionId,o.clientReleaseAudienceGroup=o.clientReleaseAudienceGroup?o.clientReleaseAudienceGroup:(c=x.clientMetadata)===null||c===void 0?void 0:c.releaseAudienceGroup,o.clientReleaseChannel=o.clientReleaseChannel?o.clientReleaseChannel:(d=x.clientMetadata)===null||d===void 0?void 0:d.releaseChannel,o.clientReleaseFork=o.clientReleaseFork?o.clientReleaseFork:(p=x.clientMetadata)===null||p===void 0?void 0:p.releaseFork,o.clientRuntimeVersion=o.clientRuntimeVersion?o.clientRuntimeVersion:(g=x.clientMetadata)===null||g===void 0?void 0:g.runtimeVersion,o.clientSessionId=o.clientSessionId?o.clientSessionId:(k=x.clientMetadata)===null||k===void 0?void 0:k.sessionId,o.clientUserAgent=o.clientUserAgent?o.clientUserAgent:(S=x.clientMetadata)===null||S===void 0?void 0:S.userAgent,o.traceId=o.traceId||x.traceId)}for(var C of r)C.log(o);for(var T of t)T.log(o)}},$T=function(o){return o.name===v.WorkflowMetricsOnly.name&&o.root===v.WorkflowMetricsOnly.root},Lp=function(o){return!Array.isArray(o)&&typeof o=="object"},zp=function(o){return Ei[o>>24&63]+Ei[o>>18&63]+Ei[o>>12&63]+Ei[o>>6&63]+Ei[o>>0&63]},GT=function(o){return o&&o.length===5?Ni[o.charCodeAt(0)]<<24|Ni[o.charCodeAt(1)]<<18|Ni[o.charCodeAt(2)]<<12|Ni[o.charCodeAt(3)]<<6|Ni[o.charCodeAt(4)]:-1},v=(0,Fp.default)(function n(){(0,qp.default)(this,n)});v.CoreDefault=m.defineCoreLogCategory("Default");v.CoreSystem=m.defineCoreLogCategory("System");v.WorkflowDefault=m.defineWorkflowLogCategory("Default");v.WorkflowUnsampled=m.defineWorkflowLogCategory("Unsampled");v.WorkflowMetricsOnly=m.defineWorkflowLogCategory("MetricsOnly");v.PrivacyGuardEvent=m.defineCoreLogCategory("PrivacyGuardEvent");h();var Kp=w(R()),Xp=w(B()),Yp=w(ze()),Zp=w(Ve()),hl=w(Oe());h();var cl={util:{},roots:{default:{}}},jN=cl.util,KN=cl.roots.default||(cl.roots.default={}),Vp=function(){function n(o){if(o)for(var e in o)o[e]!=null&&(this[e]=o[e])}return n.prototype.count=0,n.prototype.cv="",n.prototype.serviceName="",n.prototype.sessionKey="",n.prototype.traceId="",n.prototype.durationMs=0,n.prototype.success=!1,n.prototype.resultDescription="",n.prototype.resultJSON="",n.prototype.resultSignature="",n.prototype.operationName="",n.prototype.resourceId="",n.prototype.dimension0="",n.prototype.dimension1="",n.prototype.dimension2="",n.prototype.dimension3="",n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientRuntimeVersion="",n.prototype.clientAppVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientReleaseChannel="",n.prototype.clientReleaseFork="",n.prototype.clientSessionId="",n.prototype.clientFlights="",n.prototype.clientIPRange="",n.prototype.clientDocSessionId="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.userType="",n.prototype.userId="",n.prototype.userTenantId="",n.prototype.joinContextId="",n.prototype.ariaTenant="",n.prototype.ariaNamespace="",n.prototype.dataFields="",n.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/OperationEvent"},n}();h();var dl={util:{},roots:{default:{}}},ZN=dl.util,eD=dl.roots.default||(dl.roots.default={}),Qp=function(){function n(o){if(o)for(var e in o)o[e]!=null&&(this[e]=o[e])}return n.prototype.sessionKey="",n.prototype.annotationType="",n.prototype.annotationState=0,n.prototype.workflowId="",n.prototype.traceId="",n.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/AnnotationMetaDataChangeEvent"},n}();h();var pl={util:{},roots:{default:{}}},rD=pl.util,oD=pl.roots.default||(pl.roots.default={}),Jp=function(){function n(o){if(o)for(var e in o)o[e]!=null&&(this[e]=o[e])}return n.prototype.cv="",n.prototype.sessionKey="",n.prototype.healthy=!1,n.prototype.fullLogs=!1,n.prototype.traceId="",n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientAppVersion="",n.prototype.clientSessionId="",n.prototype.clientRuntimeVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.userType="",n.prototype.userId="",n.prototype.userTenantId="",n.prototype.protocolVersion=0,n.prototype.totalDurationMs=0,n.prototype.idleDurationMs=0,n.prototype.closeReason="",n.prototype.firstClientConnectionDurationMs=0,n.prototype.seedMode="",n.prototype.seedSuccess=!1,n.prototype.seedItems=0,n.prototype.seedMessageCount=0,n.prototype.seedBatchSize=0,n.prototype.seedGroupSize=0,n.prototype.seedDurationMs=0,n.prototype.sendMessageCount=0,n.prototype.sendMessageErrors=0,n.prototype.sendMessageWarnings=0,n.prototype.sendMessageDurationMsMax=0,n.prototype.processMessageCount=0,n.prototype.processMessageErrors=0,n.prototype.processMessageWarnings=0,n.prototype.processMessageDurationMsMax=0,n.prototype.syncMessageCount=0,n.prototype.syncMessagesOutOfSequence=0,n.prototype.syncMessagesAbandoned=0,n.prototype.syncMessagesIgnored=0,n.prototype.syncMessageQueueLimitReached=!1,n.prototype.modelItemsMax=0,n.prototype.modelConsistencyErrors=0,n.prototype.estimatedSizeMax=0,n.prototype.estimatedSizeCorrect=!1,n.prototype.modelItemsCountBucket="",n.prototype.modelConsistencyErrorsAndWarnings=0,n.prototype.modelConsistencyQuietStateValid=!1,n.prototype.modelConsistencyQuietStateWarnings=0,n.prototype.modelConsistencyQuietStateErrors=0,n.prototype.documentUrlAvailable=!1,n.prototype.documentUrlWasProvided=!1,n.prototype.workflowsRegistered=0,n.prototype.workflowExecutions=0,n.prototype.workflowExecutionErrors=0,n.prototype.workflowExecutionDurationMsMax=0,n.prototype.workflowExecutionInfraErrors=0,n.prototype.annotationTypesActivated=0,n.prototype.annotationsAdded=0,n.prototype.annotationsUpdated=0,n.prototype.annotationsDeleted=0,n.prototype.augLoopLowPrivilegeTokenExistenceStatus="",n.prototype.augLoopLowPrivilegeTokenFirstArrivalDurationMs=0,n.prototype.wacTokenProvisionTokenExistenceStatus="",n.prototype.wacTokenProvisionTokenFirstArrivalDurationMs=0,n.prototype.seedingWorkflowPerformanceTimesValid=!1,n.prototype.timeFromFirstSeedMessageToFirstWorkflowFinishedMs=0,n.prototype.timeFromFirstSeedMessageToFirstAnnotationMs=0,n.prototype.timeFromFirstSeedMessageToLastAnnotationMs=0,n.prototype.timeFromFirstSeedMessageToLastWorkflowFinishedMs=0,n.prototype.timeFromLastSeedMessageToLastAnnotationMs=0,n.prototype.timeFromLastSeedMessageToLastWorkflowFinishedMs=0,n.prototype.syncMessagesWorkflowPerformanceNotMeasured=0,n.prototype.timeToAllWorkflowsFinishedMsMax=0,n.prototype.timeFromSessionStartToLastWorkflowFinishedMs=0,n.prototype.healthBucket="",n.prototype.coreHealthBucket="",n.prototype.coreHealthReason="",n.prototype.coreHealthBucketWithSuppressions="",n.prototype.coreHealthReasonWithSuppressions="",n.prototype.healthReason="",n.prototype.healthReasonCategory="",n.prototype.healthBucketWithSuppressions="",n.prototype.healthReasonWithSuppressions="",n.prototype.healthReasonCategoryWithSuppressions="",n.prototype.eventAnalysisFindings="",n.prototype.mappedHealthBucketsToReasons="",n.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/SessionStatsEvent"},n}();h();var gl={util:{},roots:{default:{}}},sD=gl.util,uD=gl.roots.default||(gl.roots.default={}),jp=function(){function n(o){if(o)for(var e in o)o[e]!=null&&(this[e]=o[e])}return n.prototype.cv="",n.prototype.serviceName="",n.prototype.sessionKey="",n.prototype.traceId="",n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientRuntimeVersion="",n.prototype.clientAppVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientReleaseChannel="",n.prototype.clientReleaseFork="",n.prototype.clientSessionId="",n.prototype.clientFlights="",n.prototype.clientIPRange="",n.prototype.clientDocSessionId="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.userType="",n.prototype.userId="",n.prototype.userTenantId="",n.prototype.sessionHealthEventName="",n.prototype.source="",n.prototype.reason="",n.prototype.reasonDependency="",n.prototype.subReason="",n.prototype.impact="",n.prototype.success=!1,n.prototype.durationMs=0,n.prototype.count=0,n.prototype.message="",n.prototype.affectedWorkflows="",n.prototype.resourceId="",n.prototype.dimension0="",n.prototype.dimension1="",n.prototype.dimension2="",n.prototype.dimension3="",n.prototype.resultDescription="",n.prototype.resultSignature="",n.prototype.joinContextId="",n.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/SessionHealthEvent"},n}();h();var UT=1e3,HT=1e6,Kt=function(){return typeof process!="undefined"&&process.hrtime?function(){var n=process.hrtime();return n[0]*UT+n[1]/HT}:typeof performance!="undefined"&&performance.now?function(){return performance.now()}:function(){return Date.now()}}();function zT(n){var o=VT();return function(){var r=(0,hl.default)(n),t;if(o){var a=(0,hl.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Zp.default)(this,t)}}function VT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var E=function(n){(0,Yp.default)(e,n);var o=zT(e);function e(r,t){var a;return(0,Kp.default)(this,e),a=o.call(this,r),a.eventName="Operation",a.options=t,a.durationMs=r==null?void 0:r.durationMs,(!r||r.count==null)&&(a.count=1),a}return(0,Xp.default)(e,[{key:"setClientMetadata",value:function(t){return t&&(this.clientAppName=t.appName,this.clientAppPlatform=t.appPlatform,this.clientAppVersion=t.appVersion,this.clientFlights=t.flights,this.clientReleaseAudienceGroup=t.releaseAudienceGroup,this.clientReleaseChannel=t.releaseChannel,this.clientReleaseFork=t.releaseFork,this.clientRuntimeVersion=t.runtimeVersion,this.clientSessionId=t.sessionId,this.clientDocSessionId=t.docSessionId,this.clientDeviceId=t.deviceId,this.clientUserAgent=t.userAgent),this}},{key:"setUserContext",value:function(t){return t&&(this.userId=t.puid||t.oid,this.userType=t.userType&&t.userType.toString(),this.userTenantId=t.tid),this}},{key:"setMetricCustomDimensions",value:function(t,a){if(!this.options)throw new Error(`Attempting to set custom dimensions ${t} to operation ${this.operationName} without activating MetricCount or MetricDuration`);this.options.metricCustomDimensions=this.options.metricCustomDimensions||{},this.options.metricCustomDimensions[t]=a}},{key:"setDataField",value:function(t,a){var s=this.dataFields?JSON.parse(this.dataFields):{};s[t]=a,this.dataFields=JSON.stringify(s)}},{key:"setDataFields",value:function(t){this.dataFields?this.dataFields=JSON.stringify(Object.assign(Object.assign({},JSON.parse(this.dataFields)),t)):this.dataFields=JSON.stringify(t)}},{key:"start",value:function(){return this.startTime=Kt(),this}},{key:"stop",value:function(){var t=Kt();return this.durationMs=Math.round(t-this.startTime),this}},{key:"getMetrics",value:function(t){var a,s,u={};if(this.operationName)switch(this.operationName){case"SessionHealthOrphanedEventsWithoutProperSessionKey":case"SessionHealthOrphanedSessions":case"WorkflowActivationState":u[this.operationName+".CountV2"]={dimensionNames:e.getOrphanedSessionHealthDimensionNames.bind(e),dimensionValues:this.getOrphanedSessionHealthDimensionValues(),value:this.count};break;case"MarkUnhealthySession":case"MarkHealthWarningSession":u[this.operationName+".Reason"]={dimensionNames:e.getSessionHealthDimensionNames.bind(e),dimensionValues:this.getSessionHealthDimensionValues(),value:1};break;default:if(this.operationName==="matchmaker_timer"&&(u["Workflow.DurationMs"]={dimensionNames:e.getWorkflowDimensionNames.bind(e),dimensionValues:this.getWorkflowDimensionValues(),value:this.durationMs||0},u["Workflow.Count"]={dimensionNames:e.getWorkflowDimensionNames.bind(e),dimensionValues:this.getWorkflowDimensionValues(),value:1}),this.durationMs!==void 0){var l=`${this.operationName}.DurationMsV2`;(!((a=this.options)===null||a===void 0)&&a.metricDuration||t.indexOf(l)>=0)&&(u[l]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.durationMs})}{var f=`${this.operationName}.CountV2`;(!((s=this.options)===null||s===void 0)&&s.metricCount||t.indexOf(f)>=0)&&(u[f]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.count})}}return u}},{key:"getDimensionNames",value:function(){var t,a,s=e.dimensionNames;if(!((t=this.options)===null||t===void 0)&&t.metricCustomDimensions){s=s.slice();for(var u in(a=this.options)===null||a===void 0?void 0:a.metricCustomDimensions)s.push(u)}return s}},{key:"getDimensionValues",value:function(){var t,a,s=[this.success,this.clientAppName,this.clientAppPlatform,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3];if(!((t=this.options)===null||t===void 0)&&t.metricCustomDimensions)for(var u in(a=this.options)===null||a===void 0?void 0:a.metricCustomDimensions)s.push(this.options.metricCustomDimensions[u]);return s}},{key:"getOrphanedSessionHealthDimensionValues",value:function(){return[this.success,this.clientAppName,this.clientAppPlatform,this.clientReleaseAudienceGroup,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}},{key:"getSessionHealthDimensionValues",value:function(){return[this.resultSignature,this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}},{key:"getWorkflowDimensionValues",value:function(){return[this.resultSignature,this.resourceId,this.resourceId,this.success]}}],[{key:"getOrphanedSessionHealthDimensionNames",value:function(){return this.orphanedSessionHealthDimensionNames}},{key:"getSessionHealthDimensionNames",value:function(){return this.sessionHealthDimensionNames}},{key:"getWorkflowDimensionNames",value:function(){return this.workflowDimensionNames}}]),e}(Vp);E.dimensionNames=["Success","ClientAppName","ClientAppPlatform","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];E.orphanedSessionHealthDimensionNames=["Success","ClientAppName","ClientAppPlatform","ClientReleaseAudienceGroup","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];E.sessionHealthDimensionNames=["Reason","ClientAppName","ClientAppPlatform","ClientAppVersion","Dimension0","Dimension1","Dimension2","Dimension3"];E.workflowDimensionNames=["ResultSignature","WorkflowId","ResourceId","Success"];h();var ig=w(R()),ag=w(B());h();var ng=w(R()),rg=w(B()),Qe=function(){function n(o){(0,ng.default)(this,n),this.childCount=0,this.id=o||QT()}return(0,rg.default)(n,[{key:"newChild",value:function(){return++this.childCount,new n(this.id+"."+this.childCount.toString())}},{key:"toString",value:function(){return this.id.length>127?this.id.substring(0,127)+"!":this.id}}],[{key:"fromString",value:function(e,r){if(!e)throw new Error("Received invalid correlation vector string");var t;return e.endsWith(".0")?t=new n(e.substring(0,e.length-2)):t=new n(e),r&&(t.childCount=r),t}}]),n}(),eg=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],og=22,tg=new Array(og);function QT(){for(var n=0;n<og;n++)tg[n]=eg[Math.floor(Math.random()*eg.length)];return tg.join("")}h();function ml(n,o){return JSON.stringify}var $r=function(){function n(o,e,r,t){(0,ig.default)(this,n),this.cv=o,this.sessionDescriptor=e,this.clientMetadata=r,this.workflow=t==null?void 0:t.workflow,this.joinContextId=t==null?void 0:t.joinContextId,this.performanceEvent=t==null?void 0:t.performanceEvent,this.sessionLogsSampled=void 0,this._interactionId=t==null?void 0:t.interactionId,this._interactionSessionId=t==null?void 0:t.interactionSessionId,this.traceId=t==null?void 0:t.traceId}return(0,ag.default)(n,[{key:"sessionKey",get:function(){var e;return(e=this.sessionDescriptor)===null||e===void 0?void 0:e.sessionKey}},{key:"interactionSessionId",get:function(){return this._interactionSessionId},set:function(e){if(this._interactionSessionId&&this._interactionSessionId!==e)throw new Error("InteractionSessionId is already set");this._interactionSessionId=e}},{key:"interactionId",get:function(){return this._interactionId},set:function(e){if(this._interactionId&&this._interactionId!==e)throw new Error("InteractionId is already set");this._interactionId=e}},{key:"toString",value:function(){var e,r;return`${(e=this.clientMetadata)===null||e===void 0?void 0:e.appName};${(r=this.clientMetadata)===null||r===void 0?void 0:r.appPlatform};${this.sessionKey};${this.cv}`}},{key:"serialize",value:function(){var e,r,t,a,s,u=(e=this.clientMetadata)===null||e===void 0?void 0:e.appName,l=(r=this.clientMetadata)===null||r===void 0?void 0:r.appPlatform,f=(t=this.clientMetadata)===null||t===void 0?void 0:t.releaseAudienceGroup,c=(a=this.clientMetadata)===null||a===void 0?void 0:a.flights;return n.stringify(Object.assign(Object.assign({cv:this.cv.toString()},(s=this.sessionDescriptor)!==null&&s!==void 0?s:{}),{clientAppName:u,clientAppPlatform:l,clientReleaseAudienceGroup:f,clientFlights:c,workflow:this.workflow,joinContextId:this.joinContextId,interactionId:this.interactionId,interactionSessionId:this.interactionSessionId,traceId:this.traceId}))}},{key:"newChild",value:function(){return new n(this.cv.newChild(),this.sessionDescriptor,this.clientMetadata,{workflow:this.workflow,joinContextId:this.joinContextId,interactionId:this.interactionId,interactionSessionId:this.interactionSessionId,traceId:this.traceId})}}],[{key:"deserialize",value:function(e){if(e)try{var r=JSON.parse(e),t={appName:r.clientAppName,appPlatform:r.clientAppPlatform,releaseAudienceGroup:r.clientReleaseAudienceGroup,flights:r.clientFlights};return new n(new Qe(r.cv),{sessionKey:r.sessionKey,userId:r.userId,mastermindEndpoint:r.mastermindEndpoint},t,{workflow:r.workflow,joinContextId:r.joinContextId,interactionId:r.interactionId,interactionSessionId:r.interactionSessionId,traceId:r.traceId})}catch(a){return new n(new Qe(e))}}},{key:"fromExisting",value:function(e,r,t,a,s){return new n(r||e.cv,t||e.sessionDescriptor,a||e.clientMetadata,{workflow:(s==null?void 0:s.workflow)||e.workflow,joinContextId:(s==null?void 0:s.joinContextId)||e.joinContextId,performanceEvent:(s==null?void 0:s.performanceEvent)||e.performanceEvent,interactionId:(s==null?void 0:s.interactionId)||e.interactionId,interactionSessionId:(s==null?void 0:s.interactionSessionId)||e.interactionSessionId,traceId:(s==null?void 0:s.traceId)||e.traceId})}}]),n}();$r.schema={type:"object",properties:{cv:{type:"string"},clientAppName:{type:"string"},clientAppPlatform:{type:"string"},clientReleaseAudienceGroup:{type:"string"},clientFlights:{type:"string"},sessionKey:{type:"string"},userId:{type:"string"},mastermindEndpoint:{type:"string"},workflow:{type:"string"},joinContextId:{type:"string"},interactionId:{type:"string"},interactionSessionId:{type:"string"},traceId:{type:"string"}}};$r.stringify=ml($r.schema);h();var yl=w(B()),kl=w(R()),sg="|",ug="b~",JT="b~true",vl="n~",jT=/\|\~/g,KT="_",XT=(0,yl.default)(function n(){(0,kl.default)(this,n),this.count=0,this.measureSums=new Map}),wl=(0,yl.default)(function n(o,e,r,t,a){var s=this;(0,kl.default)(this,n),this.buckets=new Map,this.init=function(u){s.log=u},this.add=function(u){var l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(!s.condition||!s.condition(u))return l===!0&&s.log(u,!1),!1;var f=[];for(var c of s.dimensions)if(u[c]===void 0||u[c]===null)f.push(null);else{var d="";typeof u[c]=="boolean"?d=ug:typeof u[c]=="number"&&(d=vl),f.push(`${d}${u[c].toString().replace(jT,KT)}`)}var p=f.join(sg),g=s.buckets.get(p);if(!g){g=new XT,g.traceLevel=u.traceLevel;for(var k of s.avgMeasures)g.measureSums.set(k,0);s.buckets.set(p,g)}g.count++;for(var S of s.avgMeasures)u[S]&&g.measureSums.set(S,g.measureSums.get(S)+u[S]);return!0},this.flush=function(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;s.buckets.forEach(function(l,f){for(var c={traceLevel:l.traceLevel,eventName:s.eventName,count:l.count},d=f.split(sg),p=0;p<s.dimensions.length;p++){var g=s.dimensions[p],k=d[p];k.indexOf(ug)===0?c[g]=k===JT:k.indexOf(vl)===0?c[g]=parseInt(k.slice(vl.length),10):c[g]=k}for(var S of s.avgMeasures)c[S]=Math.round(l.measureSums.get(S)/l.count);s.log(c,!0)}),s.buckets.clear(),u&&(s.condition=null,clearInterval(s.interval))},this.eventName=o,this.condition=e,this.dimensions=r,this.avgMeasures=t,a>0&&(this.interval=setInterval(this.flush,a*1e3))});h();var lg=w(B()),fg=w(R()),cg=w(ze()),dg=w(Ve()),Sl=w(Oe());function YT(n){var o=ZT();return function(){var r=(0,Sl.default)(n),t;if(o){var a=(0,Sl.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,dg.default)(this,t)}}function ZT(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Pi=function(n){(0,cg.default)(e,n);var o=YT(e);function e(r){var t;return(0,fg.default)(this,e),t=o.call(this,r),t.eventName="AnnotationMetaDataChange",t}return(0,lg.default)(e)}(Qp);h();var pg=w(R()),gg=w(B()),hg=w(ze()),mg=w(Ve()),Cl=w(Oe());function eI(n){var o=tI();return function(){var r=(0,Cl.default)(n),t;if(o){var a=(0,Cl.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,mg.default)(this,t)}}function tI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Te;(function(n){n[n.Unknown=0]="Unknown",n[n.Core=1]="Core",n[n.Workflow=2]="Workflow",n[n.SessionExtension=3]="SessionExtension",n[n.Client=4]="Client",n[n.ClientRuntime=5]="ClientRuntime"})(Te||(Te={}));var pe;(function(n){n[n.Unknown=0]="Unknown",n[n.Core=1]="Core",n[n.Workflow=2]="Workflow",n[n.SessionExtension=3]="SessionExtension",n[n.Client=4]="Client",n[n.Network=5]="Network",n[n.AugLoopDependency=6]="AugLoopDependency",n[n.WorkflowDependency=7]="WorkflowDependency",n[n.ClientRuntime=8]="ClientRuntime"})(pe||(pe={}));var Ie;(function(n){n[n.Unknown=0]="Unknown",n[n.None=1]="None",n[n.MissingInput=2]="MissingInput",n[n.MissingOutput=3]="MissingOutput"})(Ie||(Ie={}));var Re=function(n){(0,hg.default)(e,n);var o=eI(e);function e(r,t){var a;(0,pg.default)(this,e);var s,u;return a=o.call(this,{source:Te[r.source],reason:pe[r.reason],reasonDependency:r.reasonDependency,subReason:r.subReason,sessionHealthEventName:r.sessionHealthEventName,impact:Ie[r.impact],success:r.success,durationMs:(s=r.durationMs)!==null&&s!==void 0?s:0,count:typeof r.count=="number"?r.count:1,message:r.message,affectedWorkflows:((u=r.affectedWorkflows)!==null&&u!==void 0?u:[]).join(","),resourceId:r.resourceId,dimension0:r.dimension0,dimension1:r.dimension1,dimension2:r.dimension2,dimension3:r.dimension3,cv:r.cv,resultSignature:r.resultSignature,resultDescription:r.resultDescription,joinContextId:r.joinContextId}),a.eventName="SessionHealth",t&&a.setClientMetadata(t),a.metricCount=r.metricCount,a.metricDuration=r.metricDuration,a}return(0,gg.default)(e,[{key:"getMetrics",value:function(){var t={};return(this.metricCount===void 0||this.metricCount)&&(t[`${this.sessionHealthEventName}.CountV2`]={dimensionNames:function(){return e.dimensionNames},dimensionValues:this.getDimensionValues(),value:this.count}),(this.metricDuration===void 0||this.metricDuration)&&(t[`${this.sessionHealthEventName}.DurationMsV2`]={dimensionNames:function(){return e.dimensionNames},dimensionValues:this.getDimensionValues(),value:this.durationMs}),t}},{key:"setClientMetadata",value:function(t){return t&&(this.clientAppName=t.appName,this.clientAppPlatform=t.appPlatform,this.clientAppVersion=t.appVersion,this.clientFlights=t.flights,this.clientReleaseAudienceGroup=t.releaseAudienceGroup,this.clientReleaseChannel=t.releaseChannel,this.clientReleaseFork=t.releaseFork,this.clientRuntimeVersion=t.runtimeVersion,this.clientSessionId=t.sessionId,this.clientDocSessionId=t.docSessionId,this.clientUserAgent=t.userAgent,this.clientDeviceId=t.deviceId),this}},{key:"setUserContext",value:function(t){return t&&(this.userId=t.puid||t.oid,this.userType=t.userType&&t.userType.toString(),this.userTenantId=t.tid),this}},{key:"setReason",value:function(t){return this.reason=pe[t],this}},{key:"setSource",value:function(t){return this.source=Te[t],this}},{key:"setImpact",value:function(t){return this.impact=Ie[t],this}},{key:"setAffectedWorkflows",value:function(t){return this.affectedWorkflows=(t!=null?t:[]).join(","),this}},{key:"getAffectedWorkflows",value:function(){return this.affectedWorkflows.split(",")}},{key:"start",value:function(){return this.startTime=Kt(),this}},{key:"stop",value:function(){var t=Kt();return this.durationMs=Math.round(t-this.startTime),this}},{key:"getDimensionValues",value:function(){var t;return[this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.success?"1":"0",`${this.reason}_${this.reasonDependency}`,this.impact,(t=this.getAffectedWorkflows()[0])!==null&&t!==void 0?t:"",this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}}]),e}(jp);Re.dimensionNames=["ClientAppName","ClientAppPlatform","ClientAppVersion","Success","Reason","Impact","FirstAffectedWorkflow","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];h();var te=new $r(new Qe),as=[];var nI=function(o){as.push(te),te=o},rI=function(o){if(te===o){te=as.pop();return}var e=as.lastIndexOf(o);if(e<0)throw new Error("Context not found");if(e===0)throw new Error("Cannot remove top context");as.splice(e,1)};var st=function(){return te};var xl=function(){var o;return new $r(((o=te==null?void 0:te.cv)===null||o===void 0?void 0:o.newChild())||new Qe,te==null?void 0:te.sessionDescriptor,te==null?void 0:te.clientMetadata,{workflow:te==null?void 0:te.workflow,joinContextId:te==null?void 0:te.joinContextId,performanceEvent:te==null?void 0:te.performanceEvent,interactionId:te==null?void 0:te.interactionId,interactionSessionId:te.interactionSessionId,traceId:te==null?void 0:te.traceId})},Cn=function(o){var e=xl();return Le(function(r){return o(r&&r.cv||void 0)},e)},ss=function(o,e,r,t,a){var s=new $r(e&&Qe.fromString(e)||(te==null?void 0:te.cv)||new Qe,r||(te==null?void 0:te.sessionDescriptor),t||(te==null?void 0:te.clientMetadata),{workflow:(a==null?void 0:a.workflow)||(te==null?void 0:te.workflow),joinContextId:(a==null?void 0:a.joinContextId)||(te==null?void 0:te.joinContextId),performanceEvent:(a==null?void 0:a.performanceEvent)||(te==null?void 0:te.performanceEvent),interactionId:(a==null?void 0:a.interactionId)||(te==null?void 0:te.interactionId),interactionSessionId:(a==null?void 0:a.interactionSessionId)||(te==null?void 0:te.interactionSessionId),traceId:(a==null?void 0:a.traceId)||(te==null?void 0:te.traceId)});return Le(o,s)},Le=function(o,e){nI(e);try{return o(e)}finally{rI(e)}};h();h();var vg=w(R()),yg=w(B()),Yn=function(){function n(o){if((0,vg.default)(this,n),this.cache=new Map,this.options=o||{sweepInterval:100},this.options.idleDurationMs!=null&&this.options.idleDurationMs<=0)throw new Error("Idle duration must be positive");if(this.interval=this.options.sweepInterval||100,this.interval<=0)throw new Error("Sweep interval must be a positive number")}return(0,yg.default)(n,[{key:"put",value:function(e,r,t,a,s,u,l){if(t==null||t<=0)throw new Error("Cache timeout must be a positive number");(s==null||s<=0)&&(s=this.options.idleDurationMs);var f={value:r,lastUsed:s?Date.now():void 0,expire:t+Date.now(),idleDurationMs:s,expireCallback:a,expiringTriggerTime:u+Date.now(),expiringCallback:l};return this.cache.set(e,f),this.timeout||(this.timeout=setInterval(this.onInterval.bind(this),this.interval),this.timeout.unref&&this.timeout.unref()),r}},{key:"del",value:function(e){if(this.options.delCallback){var r=this.cache.get(e);r&&this.options.delCallback(e,r.value)}var t=this.cache.delete(e);return this.size()===0&&this.clear(),t}},{key:"clear",value:function(){this.timeout&&(clearInterval(this.timeout),this.timeout=void 0),this.cache.clear()}},{key:"get",value:function(e){var r=this.cache.get(e);if(r)return this.options.idleDurationMs&&(r.lastUsed=Date.now()),r.expire<Date.now()&&(this.del(e),r.expireCallback&&r.expireCallback(e,r.value),r=this.cache.get(e),!r)?void 0:r.value}},{key:"keys",value:function(){return this.cache.keys()}},{key:"forEach",value:function(e){this.cache.forEach(function(r,t){e(r.value,t)})}},{key:"size",value:function(){return this.cache.size}},{key:"updateExpireTime",value:function(e,r){return this.cache.has(e)&&r>=0?(this.cache.get(e).expire=r+Date.now(),!0):!1}},{key:"onInterval",value:function(){var e=this,r=Date.now();this.cache.forEach(function(t,a){try{if(t.idleDurationMs&&t.lastUsed<r-t.idleDurationMs){e.del(a),e.options.idleCallback&&e.options.idleCallback(a,t.value);return}t.expire<r&&(e.del(a),t.expireCallback&&t.expireCallback(a,t.value)),t.expiringTriggerTime<r&&t.expiringCallback&&(t.expiringCallback(a,t.value),t.expiringCallback=void 0)}catch(s){n.logIntervalError&&n.logIntervalError(s)}})}}],[{key:"setLogIntervalError",value:function(e){n.logIntervalError=e}}]),n}();h();h();var Na=w(Se()),Pd=w(R()),Rd=w(B());h();var oI={category:Dn.Schema,schema:{name:"Exception",path:"message-schema.proto"}},nP={category:Dn.Schema,schema:{name:"Filter",path:"message-schema.proto"}},Gr=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(o==null)return"Invalid message passed";if(o.payload==null)return`${xe[xe.NoOutput]}: Payload is null`;if(o.payload.exceptionType==null)return"Payload is not an exception";var r=xe[o.payload.exceptionType];return r+=o.payload.message?`: ${o.payload.message}`:": No description",r+=e&&o.payload.data?`
${o.payload.data.toString()}`:"",r},kg=function(o){return o==null||o.payload==null||o.payload.exceptionType==null?xe.Unknown:o.payload.exceptionType},Zn=function(o,e){if(o==null)throw new Error("Cannot set exception on null message");o.payload=e,o.payloadSchema=oI,o.messageType=wn.Exception};h();h();var wg=w(at()),Tl=w(Se()),Sg=w(R()),Cg=w(B());var Ri;(function(n){n[n.ExceedingMaxSize=0]="ExceedingMaxSize",n[n.GroupComplete=1]="GroupComplete",n[n.BatchIntervalElapsed=2]="BatchIntervalElapsed"})(Ri||(Ri={}));var Po=function(){function n(o,e,r,t){(0,Sg.default)(this,n),this.batchesByGroupingKey=new Map,this.getOrderOfMagnitudeDimension=function(a){return a<0?"Negative":a===0?"0":a===1?"1":`Magnitude ${a.toString().length}`},this.submit=o,this.onSummary=t,this.reduceBatchOperationsEnabled=e,this.batchMessagesEnabled=r}return(0,Cg.default)(n,[{key:"addBatchItem",value:function(e,r,t,a,s,u){var l=this,f=r.delayMs,c=r.delayMsMax,d=r.maxInputSize,p=r.estimateSize,g=r.groupingKeyExtractor,k=p(e),S=g(e);if(r.split&&k>d){var x;try{x=r.split(e)}catch(z){var C=new Error("Split error: "+z.message);u?u(C):m.error(573366352,v.CoreDefault,C);return}if(x&&Array.isArray(x.inputs)&&x.inputs.length>1){for(var T,I=[],_=u?function(z,L){if(T=T||z,I.push(L),I.length===x.inputs.length){var J;try{J=x.join(I)}catch(P){u(new Error("Join error: "+P.message));return}u(T,J)}}:void 0,M=0;M<x.inputs.length;M++){var A=x.inputs[M];this.addBatchItem(A,r,t,a,s&&M===x.inputs.length-1,_)}return}}var b=this.batchesByGroupingKey.get(S);if(b&&b.size+k>d&&(this.executeBatch(S,b,r,Ri.ExceedingMaxSize),b=void 0),b||(b={items:[],size:0,hasItemsWithCallbacks:!1,context:t,creationTime:Date.now()},this.batchesByGroupingKey.set(S,b)),!this.batchMessagesEnabled)b.items.push({input:e,size:k,callback:u});else{var N=b.items[b.items.length-1];N&&N.cv===a&&N.callback===u?(N.input=[].concat((0,Tl.default)(N.input),(0,Tl.default)(e)),N.size+=k):b.items.push({input:e,size:k,cv:a,callback:u})}b.size+=k,b.hasItemsWithCallbacks=b.hasItemsWithCallbacks||!!u,this.batchMessagesEnabled||(b.cv=a),b.groupComplete=s,b.groupComplete?this.executeBatch(S,b,r,Ri.GroupComplete):(Date.now()-b.creationTime+f<c&&(clearTimeout(b.timeout),b.timeout=void 0),b.timeout||(b.timeout=setTimeout(function(){l.executeBatch(S,b,r,Ri.BatchIntervalElapsed)},f)))}},{key:"removeAllBatchedItems",value:function(){this.batchesByGroupingKey.forEach(function(e){e.timeout&&clearTimeout(e.timeout)}),this.batchesByGroupingKey.clear()}},{key:"reduceBatchOperations",value:function(e){var r=new E({operationName:"ReduceBatchOperations"}).start(),t=0,a=0,s=0,u=new Set,l=[],f=function(I,_){return I.parentPath.toString()+"/"+I.parentRevId+"/"+_.id};for(var c of e.input.reverse()){var d=[];for(var p of c.input.reverse())if(Pe.typeGuard(p)){var g=[];for(var k of p.items){s++;var S=f(p,k);u.has(S)?a++:(g.push(k),u.add(S),t++)}g.length!==0&&(p.items=g,d.push(p))}else if(ke.typeGuard(p)){for(var x of p.items){var C=f(p,x);u.delete(C)}d.push(p)}else d.push(p);d.length!==0&&l.push({input:d.reverse(),size:c.size,cv:c.cv,callback:c.callback})}e.input=l.reverse(),s!=0&&(r.dimension0=`${this.getOrderOfMagnitudeDimension(a)}`,r.dimension1=`noOp: ${a===0}`),s-a==t?r.success=!0:r.success=!1,m.info(507839488,v.CoreDefault,r.stop())}},{key:"executeBatch",value:function(e,r,t,a){var s=this;clearTimeout(r.timeout),r.timeout=void 0,this.batchesByGroupingKey.delete(e);var u=r.items,l=new E({operationName:"ExecuteBatch",cv:this.batchMessagesEnabled?"":r.cv,resourceId:r.context.name,resultDescription:`batching duration: ${Date.now()-r.creationTime}ms`,dimension0:`${this.batchMessagesEnabled?"Batched items count":"Batched ops count:"} ${this.getOrderOfMagnitudeDimension(u.length)}`,dimension1:`Size ${this.getOrderOfMagnitudeDimension(r.size)}`,dimension2:a.toString()}).start(),f=function(p,g,k){var S;if(g&&g.exceptionType===xe.NoOutput)l.success=!0,m.info(573366353,v.CoreDefault,l.stop());else{var x=`${p} error: ${g?g.message||g:"Unknown error"}`;S=g||new Error(x),l.success=!1,l.resultDescription=`Batch of ${u.length} items of size ${r.size} with ${x}`,l.resultSignature=`${p} Error`,m.error(573366354,v.CoreDefault,l.stop())}if(r.hasItemsWithCallbacks)for(var C of u)C.callback&&C.callback(S,k)},c;try{c=t.multiplex(this.batchMessagesEnabled?u:u.map(function(d){return d.input}))}catch(d){f("Multiplex",d);return}this.reduceBatchOperationsEnabled&&this.batchMessagesEnabled&&e=="operations"&&this.reduceBatchOperations(c),this.submit(c.input,r,function(d,p){if(d||p&&("exceptionType"in p||p instanceof Error))f("Submit",d||p,p);else if(r.hasItemsWithCallbacks||t.summaryExtractor){var g;if(r.hasItemsWithCallbacks)try{if(g=c.demultiplex(p),g.length!==u.length)throw new Error("Mismatched output length")}catch(I){f("Demultiplex",I);return}var k,S;if(t.summaryExtractor)try{var x=t.summaryExtractor(p),C=(0,wg.default)(x,2);S=C[0],k=C[1]}catch(I){f("SummaryExtractor",I);return}if(l.success=!0,m.info(573366342,v.CoreDefault,l.stop()),r.hasItemsWithCallbacks)for(var T=0;T<u.length;T++)u[T].callback&&u[T].callback(void 0,g[T]);k&&s.onSummary(S,k,r.context)}else l.success=!0,m.info(573366343,v.CoreDefault,l.stop())})}}]),n}();h();h();var xg=w(at()),Tg=w(R()),Ig=w(B()),_g=function(){function n(o,e,r){if((0,Tg.default)(this,n),this.requestInProgress=!1,this.queuedRequests=[],o==null)throw new Error("No request.");this.fetch=o,this.fetchTimeout=e,this.queueTimeout=r}return(0,Ig.default)(n,[{key:"tryProcessNextRequest",value:function(){if(this.requestInProgress=!1,this.queuedRequests.length>0){var e=this.queuedRequests.shift(),r=(0,xg.default)(e,3),t=r[0],a=r[1],s=r[2];clearTimeout(s),this.add(t,a)}}},{key:"add",value:function(e,r){var t=this;if(this.requestInProgress){var a=setTimeout(function(){r(new Error("Timed out waiting in queue"),null),t.queuedRequests.shift()},this.queueTimeout);this.queuedRequests.push([e,r,a])}else{this.requestInProgress=!0;var s=new Promise(function(u,l){var f=!1,c=setTimeout(function(){f=!0,l(new Error("Fetch timed out"))},t.fetchTimeout);t.fetch(e).then(function(d){f||(clearTimeout(c),u(d))}).catch(function(d){f||(clearTimeout(c),l(d))})});s.then(function(u){r(null,u),t.tryProcessNextRequest()}).catch(function(u){r(u,null),t.tryProcessNextRequest()})}}}]),n}();var Bi=w(us()),iI=2e4,aI=12e4,ls="Request timed out";function Hr(n,o,e){var r=new Bi.Request(n,o);return sI.add(r,e)}var sI=new _g(Bi.fetch,iI,aI);function Ag(n,o,e){return new Promise(function(r,t){var a=setTimeout(function(){t(new Error(ls))},o);(0,Bi.fetch)(n,e||{}).then(function(s){clearTimeout(a),r(s)}).catch(function(s){clearTimeout(a),t(s)})})}h();function an(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var o=Math.random()*16|0,e=n==="x"?o:o&3|8;return e.toString(16)})}h();var fs=function(o){return uI(o,Number.POSITIVE_INFINITY)};var uI=function(o,e){for(var r=0,t=[],a=[o];a.length>0;){var s=a.pop(),u=typeof s;if(u==="boolean")r+=4;else if(u==="string")r+=2*s.length;else if(u==="number")r+=8;else if(u==="object"&&s&&t.indexOf(s)===-1)if(s instanceof Uint8Array)r+=s.length;else{t.push(s);for(var l in s)a.push(s[l])}if(r>e)return r}return r};h();var qS=w(R()),$S=w(B());h();var Mg=w(R()),bg=w(B()),Eg=w(Se());var lI=1e3,Il=["cloud-dev.microsoft","officeppe.com","cloud.microsoft","office.com","office365.us","ic.gov","microsoft.scloud","microsoftonline.cn"],Ro=function(o,e,r,t){return new wl(o,function(a){return a.success&&r.indexOf(a[e])>=0},[e,"resourceId","success","resultSignature","clientDocSessionId","dimension0","dimension1","dimension2","dimension3"],["durationMs"],t)},_l=function(o){Il.push.apply(Il,(0,Eg.default)(o))},sn=function(o){if(!o)return o;for(var e of Il)if(o.indexOf(e)>=0)return o;return"**redacted**"},zr=function(){function n(o){(0,Mg.default)(this,n),this.level=wt.info,this.hostCallbacks=o}return(0,bg.default)(n,[{key:"log",value:function(e){var r=this;if(!(this.hostCallbacks==null||this.hostCallbacks.sendTelemetryEvent==null)){var t=function(c,d,p,g,k){var S=d.charAt(0).toUpperCase()+d.slice(1),x={DocSessionId:c.clientDocSessionId,ResourceId:c.resourceId,ResultDescription:c.resultDescription,ResultSignature:c.resultSignature,Dimension0:c.dimension0,Dimension1:c.dimension1,Dimension2:c.dimension2,Dimension3:c.dimension3,JoinContextId:c.joinContextId};p&&(x=Object.assign(Object.assign({},x),JSON.parse(p)));var C=g||n.augLoopAriaTenantToken,T=!k&&C==n.augLoopAriaTenantToken?n.augLoopAriaNamespace:k;S=S||n.operationNamePlaceholder;var I={CV:c.cv,Duration:(c.durationMs||0)*lI,Count:c.count,AggMode:2,Success:c.success};r.hostCallbacks.sendTelemetryEvent(C,T?`${T}_${S}`:S,x,"Office.System.Activity",I,!1,_i.ProductServiceUsage|_i.ProductServicePerformance,Xa.RequiredServiceDataEvent)},a=function(c,d,p){r.hostCallbacks.sendDiagnosticTrace&&r.hostCallbacks.sendDiagnosticTrace(c,d,p)};if(e.category!="Workflow.MetricsOnly")if(e.eventName==="Operation"){var s=e;t(s,s.operationName,s.dataFields,void 0,s.ariaNamespace)}else if(e.eventName==="SessionHealth"){var u=e;t(u,u.sessionHealthEventName)}else if(e.eventName==="WorkflowOperation"){var l=e;t(l,l.operationName,l.dataFields,l.ariaTenant,l.ariaNamespace)}else e.eventName==="Log"&&a(e.tagId,e.traceLevel,e.message)}}}]),n}();zr.augLoopAriaTenantToken="3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770";zr.augLoopAriaNamespace="Office_AugLoop_Client";zr.operationNamePlaceholder="OperationNameNotProvided";h();var Dg=w(R()),Pg=w(B()),Rg=w(Al());var Ml=function(){function n(){(0,Dg.default)(this,n),this.hadEgressError=!1,this.isClosing=!1,this.pendingEgress=[]}return(0,Pg.default)(n,[{key:"init",value:function(e,r,t,a,s){var u=this;this.ws=new Rg.default(e),this.logOp=new E({operationName:n.className,success:!0}).start(),this.logOp.setClientMetadata(s),this.ingressByteCountOp=new E({operationName:"WSIngressByteOrderOfMagnitude",success:!0}),this.ingressByteCountOp.setClientMetadata(s),this.ws.addEventListener("open",function(l){t(),u.logOp.resourceId="OnOpen",u.logOp.resultDescription="",u.logOp.success=!0,u.logOp.dimension0=u.pendingEgress.length.toString(),m.info(508843801,v.CoreDefault,u.logOp.stop())}),this.ws.addEventListener("message",function(l){u.logIngressCount(l.data),r(l.data)}),this.ws.addEventListener("error",function(l){u.errorMessage=l.message,u.logOp.resourceId="OnError",u.logOp.resultDescription=u.errorMessage,u.logOp.success=!1,m.info(508843800,v.CoreDefault,u.logOp.stop()),u.ws.close()}),this.ws.addEventListener("close",function(l){u.logOp.resourceId="OnClose",u.logOp.resultDescription=l?`code: ${l.code}. reason: ${l.reason}`:"",u.logOp.success=!0,m.info(508843799,v.CoreDefault,u.logOp.stop()),a(u.errorMessage),u.isClosing=!1})}},{key:"egress",value:function(e){var r=this,t=e.obj;this.ws.send(t,function(a){a&&!r.hadEgressError&&(r.hadEgressError=!0,r.logOp.resourceId="OnEgressError",r.logOp.resultDescription=a.message,r.logOp.success=!1,m.info(508843797,v.CoreDefault,r.logOp.stop()))})}},{key:"close",value:function(){this.isClosing||(this.isClosing=!0,this.ws.close())}},{key:"logIngressCount",value:function(e){var r=e.length;r>1e5&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=r.toString().length.toString(),m.info(508843794,v.CoreDefault,this.ingressByteCountOp.stop()))}}]),n}();Ml.className="WebSocketWorker";h();var ra=w(cs()),Dh=w(R()),Ph=w(B()),or=w(Ao()),Rh=w(ze()),Bh=w(Ve()),tf=w(Oe());h();var Og=w(R()),Lg=w(B());h();var Wg=2,Ue;(function(n){n[n.Unknown=0]="Unknown",n[n.Found=302]="Found",n[n.BadRequest=400]="BadRequest",n[n.Unauthorized=401]="Unauthorized",n[n.Forbidden=403]="Forbidden",n[n.NotFound=404]="NotFound",n[n.RequestTimeout=408]="RequestTimeout",n[n.Conflict=409]="Conflict",n[n.Gone=410]="Gone",n[n.RequestEntityTooLarge=413]="RequestEntityTooLarge",n[n.UnsupportedMediaType=415]="UnsupportedMediaType",n[n.TooManyRequests=429]="TooManyRequests",n[n.SocketDisconnect=499]="SocketDisconnect",n[n.InternalServerError=500]="InternalServerError",n[n.ServiceUnavailable=503]="ServiceUnavailable",n[n.GatewayTimeout=504]="GatewayTimeout",n[n.UnsupportedMessage=1e3]="UnsupportedMessage",n[n.Cancelled=1001]="Cancelled",n[n.EgressError=1002]="EgressError",n[n.SyncMessageException=2e3]="SyncMessageException",n[n.SyncMessageUnsupported=2001]="SyncMessageUnsupported",n[n.SyncMessageUnexpectedSeed=2002]="SyncMessageUnexpectedSeed",n[n.SyncMessageUnsupportedBatch=2003]="SyncMessageUnsupportedBatch",n[n.SyncMessageQueueFull=2004]="SyncMessageQueueFull",n[n.SyncMessageTooLateOrDuplicate=2005]="SyncMessageTooLateOrDuplicate",n[n.SyncMessageGroupIdMismatch=2006]="SyncMessageGroupIdMismatch",n[n.SyncMessageGroupStop=2007]="SyncMessageGroupStop",n[n.SyncMessageLost=2008]="SyncMessageLost",n[n.SyncMessageUnprocessedDuplicate=2009]="SyncMessageUnprocessedDuplicate",n[n.SyncMessageSessionClosed=2010]="SyncMessageSessionClosed",n[n.TokenValidationError=2100]="TokenValidationError",n[n.TokenDecryptError=2101]="TokenDecryptError",n[n.TokenTypeError=2102]="TokenTypeError",n[n.AnnotationActivationInvalidType=2200]="AnnotationActivationInvalidType",n[n.AnnotationReleaseTokenNotFound=2300]="AnnotationReleaseTokenNotFound"})(Ue||(Ue={}));var Bg;(function(n){n[n.IdentityChange=0]="IdentityChange"})(Bg||(Bg={}));var un;(function(n){n[n.Idle=0]="Idle",n[n.Pending=1]="Pending"})(un||(un={}));h();var ue=w(R()),le=w(B());var bl=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Message"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();bl.H_={T_:bl.getTypeName(),B_:bl.getBaseTypes()};var Fe=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Response"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Fe.H_={T_:Fe.getTypeName(),B_:Fe.getBaseTypes()};var Y=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ErrorResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Y.H_={T_:Y.getTypeName(),B_:Y.getBaseTypes()};var Oi=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TimeoutErrorResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Oi.H_={T_:Oi.getTypeName(),B_:Oi.getBaseTypes()};var Li=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_RateLimitErrorResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Li.H_={T_:Li.getTypeName(),B_:Li.getBaseTypes()};var gt=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();gt.H_={T_:gt.getTypeName(),B_:gt.getBaseTypes()};var ln=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionInitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ln.H_={T_:ln.getTypeName(),B_:ln.getBaseTypes()};var Vr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionLongPollMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Vr.H_={T_:Vr.getTypeName(),B_:Vr.getBaseTypes()};var er=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionLongPollResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();er.H_={T_:er.getTypeName(),B_:er.getBaseTypes()};var Fi=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionCloseReason"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Fi.H_={T_:Fi.getTypeName(),B_:Fi.getBaseTypes()};var El=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionSwapOnClose"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SessionCloseReason"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();El.H_={T_:El.getTypeName(),B_:El.getBaseTypes()};var Je=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionCloseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Je.H_={T_:Je.getTypeName(),B_:Je.getBaseTypes()};var qi=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_CacheDumpRequestMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();qi.H_={T_:qi.getTypeName(),B_:qi.getBaseTypes()};var Nl=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_CacheDumpRequestResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Nl.H_={T_:Nl.getTypeName(),B_:Nl.getBaseTypes()};var fn=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationActivationMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();fn.H_={T_:fn.getTypeName(),B_:fn.getBaseTypes()};var Qr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationActivationResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Qr.H_={T_:Qr.getTypeName(),B_:Qr.getBaseTypes()};var Jr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationResultStateMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Jr.H_={T_:Jr.getTypeName(),B_:Jr.getBaseTypes()};var jr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationReleaseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();jr.H_={T_:jr.getTypeName(),B_:jr.getBaseTypes()};var Kr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationReleaseResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Kr.H_={T_:Kr.getTypeName(),B_:Kr.getBaseTypes()};var Xr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Xr.H_={T_:Xr.getTypeName(),B_:Xr.getBaseTypes()};var Wo=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Wo.H_={T_:Wo.getTypeName(),B_:Wo.getBaseTypes()};var xn=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_BatchedMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();xn.H_={T_:xn.getTypeName(),B_:xn.getBaseTypes()};var Be=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SyncMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Be.H_={T_:Be.getTypeName(),B_:Be.getBaseTypes()};var tr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_MicroSyncMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();tr.H_={T_:tr.getTypeName(),B_:tr.getBaseTypes()};var cn=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SyncResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();cn.H_={T_:cn.getTypeName(),B_:cn.getBaseTypes()};var Dl=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionDeleteMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Dl.H_={T_:Dl.getTypeName(),B_:Dl.getBaseTypes()};var Nt=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationResultsMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Nt.H_={T_:Nt.getTypeName(),B_:Nt.getBaseTypes()};var nr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TokenProvisionMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();nr.H_={T_:nr.getTypeName(),B_:nr.getBaseTypes()};var Oo=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TokenFailureMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Oo.H_={T_:Oo.getTypeName(),B_:Oo.getBaseTypes()};var Pl=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TokenProvisionResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Pl.H_={T_:Pl.getTypeName(),B_:Pl.getBaseTypes()};var Rl=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_KeepAlive"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Rl.H_={T_:Rl.getTypeName(),B_:Rl.getBaseTypes()};var Yr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowGraphInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Yr.H_={T_:Yr.getTypeName(),B_:Yr.getBaseTypes()};var $i=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowGraphInitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();$i.H_={T_:$i.getTypeName(),B_:$i.getBaseTypes()};var Zr=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionCompleteMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Zr.H_={T_:Zr.getTypeName(),B_:Zr.getBaseTypes()};var Bl=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitV2Message"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Bl.H_={T_:Bl.getTypeName(),B_:Bl.getBaseTypes()};var Wl=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitV2Response"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Wl.H_={T_:Wl.getTypeName(),B_:Wl.getBaseTypes()};var Ol=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ol.H_={T_:Ol.getTypeName(),B_:Ol.getBaseTypes()};var Ll=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ll.H_={T_:Ll.getTypeName(),B_:Ll.getBaseTypes()};var Fl=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2CallbackMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Fl.H_={T_:Fl.getTypeName(),B_:Fl.getBaseTypes()};var Ke=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_BridgeMessage"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ke.H_={T_:Ke.getTypeName(),B_:Ke.getBaseTypes()};var Gi=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionConnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Gi.H_={T_:Gi.getTypeName(),B_:Gi.getBaseTypes()};var Ui=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionDisconnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ui.H_={T_:Ui.getTypeName(),B_:Ui.getBaseTypes()};var Hi=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionReconnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Hi.H_={T_:Hi.getTypeName(),B_:Hi.getBaseTypes()};var zi=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SubmittedCustomMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();zi.H_={T_:zi.getTypeName(),B_:zi.getBaseTypes()};var Lo=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ServerAuthenticationStateChangeMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Lo.H_={T_:Lo.getTypeName(),B_:Lo.getBaseTypes()};var Vi=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ClaimsChallengeMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Vi.H_={T_:Vi.getTypeName(),B_:Vi.getBaseTypes()};var Qi=function(){function n(o){(0,ue.default)(this,n),y.assign(n,this,o)}return(0,le.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_InteractiveAuthMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Qi.H_={T_:Qi.getTypeName(),B_:Qi.getBaseTypes()};var Wt;(function(n){n.ClientDisconnected="Client disconnected.",n.UnsupportedSyncMessage="SyncMessages with seq = -1 are not supported anymore.",n.UnexpectedSeedMessage="Unexpected seed message",n.SyncMessageUnsupportedBatch="SyncMessage with unsupported batching.",n.AnnotationTokenNotFound="Token not found"})(Wt||(Wt={}));var ql;(function(n){n.ProvisionTokenValidationError="Token provision message didn't pass token validation.",n.ProvisionTokenDecryptAndTransformError="Token provision message didn't pass token decrypt and transform."})(ql||(ql={}));function ds(n){var o=["AugLoop_Excel_Session_Protocol_","AugLoop_Powerpoint_Session_Protocol_","AugLoop_Session_Protocol_"],e;for(var r of o)if(n.indexOf(r)===0){e=r;break}if(!e)return"MalformedMessageName";var t="Message",a=n.indexOf(t,n.length-t.length)===n.length-t.length;return n.slice(e.length,a?-t.length:void 0)}var dI=5e3,pI=12e4,gI=15e3,hI=3e5,Fo=function(){function n(o){(0,Og.default)(this,n),this.config=o,this.nextMessageId=1,this.pendingResponseCallbacks=new Yn({sweepInterval:dI}),this.messageCallbacks=new Map,this.messageIdPrefix=o.messageIdPrefix,this.source=o.messageIdPrefix==="c"?Te.ClientRuntime:Te.Core,this.stats={sendMessageCount:0,sendMessageClientDisconnectedErrors:0,sendMessageErrors:0,sendMessageDurationMsMax:0,processMessageCount:0,processMessageProvisionTokenErrors:0,processMessageErrors:0,processMessageDurationMsMax:0}}return(0,Lg.default)(n,[{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"setEgress",value:function(e){var r=this;this.egress=e,this.config.resendPendingMessagesOnReconnect&&this.egress&&this.pendingResponseCallbacks.forEach(function(t,a){t.logOp.dimension1=(t.sendCount++).toString(),r.egress(t.message,function(s){return r.onEgressError(s,t)})})}},{key:"ingress",value:function(e,r){Fe.typeGuard(e)?(this.processResponse(e),r()):this.processMessage(e,r),Je.typeGuard(e)&&!e.reconnectAllowed&&this.clearAllPendingResponses()}},{key:"sendMessage",value:function(e,r,t){var a=this,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,u=new Re({sessionHealthEventName:"SendMessage",source:this.source,reason:pe.Client,impact:this.source===Te.ClientRuntime?Ie.MissingInput:Ie.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv,resourceId:ds(y.getTypeNameFor(e)),dimension0:s.toString()}).start(),l=function(){if(u.setClientMetadata(a.clientMetadata),u.success)m.info(572836e3,v.CoreDefault,u.stop());else{var x=u.resultSignature==="ErrorWithoutPendingResponse"||u.resultSignature==="ResponseCallbackException"||u.message!=="We called into done callback";u.message=JSON.stringify({errorNotPropagatedToDoneCallback:x}),m.error(572836001,v.CoreDefault,u.stop())}};e.messageId=`${this.messageIdPrefix}${this.nextMessageId++}`,xn.typeGuard(e)&&e.messages.forEach(function(S,x){return S.messageId=e.messageId+"."+x});var f=y.getTypeNameFor(e)===Je.getTypeName(),c=!t&&!f,d={message:e,logOp:u,logEvent:l,callback:void 0,sendCount:1};if(c){d.callback=function(S,x){var C;if(S?(u.success=!1,u.resultSignature=S.error,u.resultDescription=`Error for ${y.getTypeNameFor(e)} message ${e.messageId}${Be.typeGuard(e)?`, seq ${e.seq}`:""}: ${S.error}`):u.resultSignature="Success",r)try{u.message="We called into done callback",r(S,x)}catch(T){u.success=!1,u.resultSignature="ResponseCallbackException",u.resultDescription=((C=a.clientMetadata)===null||C===void 0?void 0:C.appPlatform)==="Web"?JSON.stringify({message:T.message,stack:T.stack}):JSON.stringify({message:T.message})}l(),a.updateSendMessageStats(u.success,u.durationMs,S?new Error(S.error):void 0)};var p=function(){d.callback(new Oi({code:Ue.RequestTimeout,error:"Timeout waiting for response"}),void 0)},g=this.config.responseTimeoutMs;if(Vr.typeGuard(e)){var k=e;k.longPollTimeoutHint>=gI&&k.longPollTimeoutHint<=hI?g=k.longPollTimeoutHint+5e3:g=pI}this.pendingResponseCallbacks.put(e.messageId,d,g,p)}this.egress&&this.egress(e,function(S){return a.onEgressError(S,d)},s)}},{key:"onEgressError",value:function(e,r){var t,a;if(e){var s=r.message,u=this.pendingResponseCallbacks.get(r.message.messageId);u?(this.pendingResponseCallbacks.del(s.messageId),u.callback(new Y({messageId:s.messageId,code:Ue.EgressError,error:e.message}))):Je.typeGuard(s)?(r.logOp.success=(a=(t=e.message)===null||t===void 0?void 0:t.endsWith("Client disconnected."))!==null&&a!==void 0?a:!1,r.logOp.resultSignature="ErrorSendingSessionCloseMessage",r.logOp.resultDescription=`Error for ${y.getTypeNameFor(s)} message ${s.messageId}: ${e.message}`,r.logEvent()):(r.logOp.success=!1,r.logOp.resultSignature="ErrorWithoutPendingResponse",r.logOp.resultDescription=`Error for ${y.getTypeNameFor(s)} message ${s.messageId}: ${e.message}`,r.logEvent())}}},{key:"queryEgressCacheSize",value:function(){return this.pendingResponseCallbacks.size()}},{key:"onMessage",value:function(e,r){this.messageCallbacks.set(e,r)}},{key:"getStats",value:function(){return this.stats}},{key:"hasMessageCallback",value:function(e){return this.messageCallbacks.has(e)}},{key:"cancelPendingResponseCallbacks",value:function(){var e=this;this.pendingResponseCallbacks.forEach(function(r,t){r&&(e.pendingResponseCallbacks.del(t),r.callback(new Y({messageId:t,code:Ue.Cancelled,error:"Cancelled"})))})}},{key:"clearAllPendingResponses",value:function(){if(this.pendingResponseCallbacks.size()!=0){var e=new E({operationName:"PurgePendingResponses",resultDescription:this.pendingResponseCallbacks.size().toString(),success:!0});m.info(572836002,v.CoreDefault,e),this.pendingResponseCallbacks.clear()}}},{key:"processMessage",value:function(e,r){var t=this,a=new Re({sessionHealthEventName:"ProcessMessage",source:this.source,reason:pe.Client,impact:this.source===Te.ClientRuntime?Ie.MissingOutput:Ie.MissingInput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv}).start(),s=function(){if(a.setClientMetadata(t.clientMetadata),a.success)m.info(572836003,v.CoreDefault,a.stop());else{var d=a.resourceId==="UnsupportedMessage"||a.resultSignature==="Timeout"||a.resultSignature==="OnResponseInvokedMoreThanOnce"||a.resultSignature==="MessageCallbackException"||a.message!=="We called into messageCallback";a.message=JSON.stringify({errorHappenedOutsideRegisteredMessageCallback:d}),m.error(572836032,v.CoreDefault,a.stop())}},u=this.messageCallbacks.get(y.getTypeNameFor(e));u?a.resourceId=ds(y.getTypeNameFor(e)):u=function(d,p){a.resourceId=ds(y.getTypeNameFor(d)),a.resourceId!=="MalformedMessageName"&&(a.resourceId="UnsupportedMessage"),p(new Y({messageId:d.messageId,code:Ue.UnsupportedMessage,error:`Message type ${y.getTypeNameFor(d)} is not supported`}))};var l=!1,f=function(d,p){l?(a.success=!1,a.resultSignature="OnResponseInvokedMoreThanOnce",a.resultDescription=`Invoked onResponse for ${y.getTypeNameFor(e)} message ${e.messageId} more than once`):d?(a.success=!1,a.resultSignature=d.error,d.code!==void 0&&(a.dimension0=Ue[d.code]),a.resultDescription=`Error for ${y.getTypeNameFor(e)} message ${e.messageId}: ${d.error}`):a.resultSignature="Success",l=!0,s(),d&&!y.matchesTypesFor(d,[Y.getTypeName()])&&(d=new Y({error:"Internal Server Error"})),t.updateProcessMessageStats(a.success,a.durationMs,d?new Error(d.error):void 0),d?(d.messageId=e.messageId,r(d)):p?(p.messageId=e.messageId,r(void 0,p)):r()};try{a.message="We called into messageCallback",u(e,f)}catch(c){a.success=!1,a.resultSignature="MessageCallbackException",a.resultDescription=JSON.stringify({message:c.message,stack:c.stack}),s(),this.updateProcessMessageStats(!1,a.durationMs,c),r()}}},{key:"processResponse",value:function(e){var r,t,a=new E({operationName:"ProcessResponse"});if(a.success=!0,a.setClientMetadata(this.clientMetadata),a.start(),e.messageId){var s=(r=this.pendingResponseCallbacks.get(e.messageId))===null||r===void 0?void 0:r.callback;s?(this.pendingResponseCallbacks.del(e.messageId),y.matchesTypesFor(e,[Y.getTypeName()])?s(e):s(void 0,e)):(a.resultSignature="NoPendingMessage",a.resultDescription=`${e.messageId}`,a.success=!1)}else a.resultSignature="NoMessageIdSetInResponse",Y.typeGuard(e)?a.resultDescription=e.error:a.resultDescription="MessageId is not available",a.success=!1;((t=this.clientMetadata)===null||t===void 0?void 0:t.releaseAudienceGroup)!=="Production"&&(a.resourceId=ds(y.getTypeNameFor(e)),m.info(572836034,v.CoreDefault,a.stop()))}},{key:"updateSendMessageStats",value:function(e,r,t){this.stats.sendMessageCount++,this.stats.sendMessageDurationMsMax=Math.max(r,this.stats.sendMessageDurationMsMax),!e&&!t?m.warn(572836035,v.CoreDefault,"Failed send message did not provide error object."):e&&t&&m.warn(572836036,v.CoreDefault,"Succeeded send message provided error object."),!e&&(t&&t.message===Wt.ClientDisconnected?this.stats.sendMessageClientDisconnectedErrors++:this.stats.sendMessageErrors++)}},{key:"updateProcessMessageStats",value:function(e,r,t){this.stats.processMessageCount++,this.stats.processMessageDurationMsMax=Math.max(r,this.stats.processMessageDurationMsMax),!e&&!t?m.warn(572836037,v.CoreDefault,"Failed process message did not provide error object."):e&&t&&m.warn(572836038,v.CoreDefault,"Succeeded process message provided error object."),!e&&(t&&t.message===ql.ProvisionTokenValidationError?this.stats.processMessageProvisionTokenErrors++:this.stats.processMessageErrors++)}}]),n}();h();var ut;(function(n){n[n.NotAuthenticated=0]="NotAuthenticated",n[n.Pending=1]="Pending",n[n.Authenticated=2]="Authenticated",n[n.WacUserInfoAuthenticated=3]="WacUserInfoAuthenticated"})(ut||(ut={}));var Wh=w(Rn());h();var yI=w(Se()),Gl=w(R()),Ul=w(B());var $g=w(ji()),me=function(){function n(){(0,Gl.default)(this,n)}return(0,Ul.default)(n,null,[{key:"createHealthCheckRequest",value:function(e){return{payload:{},payloadSchema:{category:Dn.Schema,schema:{name:"HealthCheckRequest"}},requestedSchema:{category:Dn.Schema,schema:{name:"HealthCheckResponse"}},clientMetadata:e}}},{key:"isFeatureEnabled",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"None";return e&&e.isFeatureEnabled?e.isFeatureEnabled("Microsoft.Office.AugLoop."+r,a).catch(function(){return Promise.resolve(t)}):Promise.resolve(t)}},{key:"isChangeGateEnabled",value:function(e,r){return e&&e.isChangeGateEnabled?e.isChangeGateEnabled(r):Promise.resolve(!1)}},{key:"convertWebSocketUrlToHttp",value:function(e){return this.convertUrl(e,!1)}},{key:"convertServiceUrlToWebSocket",value:function(e){return this.convertUrl(e,!0)}},{key:"convertUrl",value:function(e,r){if(!e)return e;var t=e.split(":"),a=t[0].toLowerCase();return a.indexOf(r?"http":"ws")==0?(a=r?a.replace("http","ws"):a.replace("ws","http"),t[0]=a,t.join(":")):e}},{key:"deepEquals",value:function(e,r){return(0,$g.default)(e,r)}},{key:"collectTelemetry",value:function(e,r,t,a,s,u){var l,f,c,d;e.start(),e.resultSignature=a!=null?a:"",e.resultDescription=s!=null?s:"",e.success=t,u?(e.dimension0=(l=u[0])!==null&&l!==void 0?l:"",e.dimension1=(f=u[1])!==null&&f!==void 0?f:"",e.dimension2=(c=u[2])!==null&&c!==void 0?c:"",e.dimension3=(d=u[3])!==null&&d!==void 0?d:""):(e.dimension0="",e.dimension1="",e.dimension2="",e.dimension3=""),r.log(function(){return m.info(508367457,v.CoreDefault,e.stop())})}}]),n}();me.getCurrentTimeMs=function(){return Date.now?Date.now():new Date().getTime()};var eo=function(){function n(o){(0,Gl.default)(this,n),this.maxNumberOfLogs=40,this.numberOfLogs=0,this.id=o}return(0,Ul.default)(n,[{key:"log",value:function(e){if(this.numberOfLogs<this.maxNumberOfLogs&&(this.numberOfLogs++,e(),this.numberOfLogs===this.maxNumberOfLogs)){var r=new E({operationName:"OnLastLog",success:!0,resourceId:this.id,resultDescription:`Limit for number of logs for id: ${this.id} reached - all next logs will be dropped`});m.warn(572838107,v.CoreDefault,r)}}}]),n}(),ZP=[y.getTypeName(),At.getTypeName(),Jt.getTypeName()];var Hl=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return Number.isFinite(o)?o:e},Gg=function(o,e){if(!Array.isArray(e)||e.length===0||Gt.typeGuard(o)||vt.typeGuard(o))return!0;for(var r of o.items)if(!r.body||y.matchesTypesFor(r.body,e))return!0;return!1};h();var Qg=w(R()),Jg=w(B());var jg=w(zl());var Bn;(function(n){n.ArrivedBeforeReseeding="Message is dropped from queue since it arrived before reseeding is started",n.DroppedAsOldestInQueue="Message is dropped as oldest in full queue",n.DroppedBecauseClientDisconnected="Message is dropped because client is disconnected from server"})(Bn||(Bn={}));var Vg=1e3,Kg=function(){function n(o){(0,Qg.default)(this,n),this.logOp=new E({operationName:"MessageQueue",success:!0}),this.queue=new jg.default(Vg),this.callbacks=o}return(0,Jg.default)(n,[{key:"clear",value:function(){this.queue.clear()}},{key:"size",value:function(){return this.queue.length}},{key:"push",value:function(e,r,t){var a=this.queue;if(a.length===Vg){this.logOp.resourceId="QueueFull",this.logOp.durationMs=0,this.logOp.success=!1,m.warn(508843746,v.CoreDefault,this.logOp);var s=a.shift();s.onResponse&&s.onResponse(new Y({error:Bn.DroppedAsOldestInQueue}))}a.push({message:e,onResponse:r,timeQueued:me.getCurrentTimeMs(),attemptNumber:t})}},{key:"sendOnSessionInitialized",value:function(e){var r=this.queue.length,t=0;if(r>0){for(var a=me.getCurrentTimeMs()-this.queue.get(0).timeQueued;this.queue.length>0&&this.callbacks.canSendMessage();){var s=this.queue.shift();e&&this.containSequencedSyncMessage(s)?(t++,s.onResponse&&s.onResponse(new Y({error:Bn.ArrivedBeforeReseeding}))):s.message instanceof Uint8Array?this.callbacks.sendBytes(s.message):this.callbacks.sendMessage(s.message,s.onResponse,s.attemptNumber)}this.logOp.resourceId="SendOnSessionInitialized",this.logOp.resultDescription=`Queue size before: ${r}, after: ${this.queue.length}. droppedSyncMessages: ${t}`,this.logOp.durationMs=a,this.logOp.success=!0,m.warn(508843745,v.CoreDefault,this.logOp)}}},{key:"containSequencedSyncMessage",value:function(e){return e.message instanceof Be&&y.matchesTypesFor(e.message,[Be.getTypeName()])&&e.message.seq>=0||e.message instanceof xn&&y.matchesTypesFor(e.message,[xn.getTypeName()])}}]),n}();h();var Ki=w(ze()),Xg=w(Ve()),Vl=w(Oe()),qo=w(R()),$o=w(B());function gs(n){var o=SI();return function(){var r=(0,Vl.default)(n),t;if(o){var a=(0,Vl.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Xg.default)(this,t)}}function SI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var De;(function(n){n[n.Initing=0]="Initing",n[n.Running=1]="Running",n[n.Disconnected=2]="Disconnected",n[n.Closed=3]="Closed"})(De||(De={}));var Ql=function(o,e,r,t){e&&(e.cv||(e.cv=o.cvParent.newChild().toString()),o.messageEndpoint.sendMessage(e,function(a,s){!a&&y.getTypeNameFor(s)===cn.getTypeName()&&(o.stats.lastSyncMessage=Date.now()),r&&r(a,s)},void 0,t))},Yg=function(o,e,r,t){e&&(o.messageQueue.push(e,r,t),o.networkWorkerManager.init(void 0,o.customInitPromise).catch(function(a){var s=new E({operationName:"WorkerManagerInit",success:!1,resultDescription:`${a}`});m.error(508843789,v.CoreDefault,s)}))},Zg=function(o,e){e&&(o.messageQueue.push(e),o.networkWorkerManager.init(void 0,o.customInitPromise).catch(function(r){m.error(508843788,v.CoreDefault,`Init failed: ${r}`)}))},hs=function(){function n(o){(0,qo.default)(this,n),this.context=o}return(0,$o.default)(n,[{key:"onEnter",value:function(e){}},{key:"sendMessage",value:function(e,r,t,a){}},{key:"sendBytes",value:function(e){}},{key:"canSendMessage",value:function(){return!1}},{key:"onConnectionClose",value:function(){}}]),n}(),eh=function(n){(0,Ki.default)(e,n);var o=gs(e);function e(){var r;return(0,qo.default)(this,e),r=o.apply(this,arguments),r.stateName=De.Initing,r.possibleNextStates=[De.Running,De.Disconnected,De.Closed],r}return(0,$o.default)(e,[{key:"sendMessage",value:function(t,a,s){y.matchesTypesFor(t,[gt.getTypeName()])?Ql(this.context,t,a,s):Yg(this.context,t,a)}},{key:"sendBytes",value:function(t){Zg(this.context,t)}},{key:"onConnectionClose",value:function(){this.context.setState(De.Disconnected)}}]),e}(hs),th=function(n){(0,Ki.default)(e,n);var o=gs(e);function e(){var r;return(0,qo.default)(this,e),r=o.apply(this,arguments),r.stateName=De.Running,r.possibleNextStates=[De.Disconnected,De.Closed],r}return(0,$o.default)(e,[{key:"onEnter",value:function(t){t&&t.isSessionReseedingStarted&&this.context.resetNextSyncSequenceId(),this.context.messageQueue.sendOnSessionInitialized(t&&t.isSessionReseedingStarted)}},{key:"sendMessage",value:function(t,a,s,u){Ql(this.context,t,a,s)}},{key:"sendBytes",value:function(t){t&&this.context.networkWorkerManager.egressBytes(t)}},{key:"canSendMessage",value:function(){return!0}},{key:"onConnectionClose",value:function(){this.context.setState(De.Disconnected)}}]),e}(hs),nh=function(n){(0,Ki.default)(e,n);var o=gs(e);function e(){var r;return(0,qo.default)(this,e),r=o.apply(this,arguments),r.stateName=De.Disconnected,r.possibleNextStates=[De.Initing,De.Closed],r}return(0,$o.default)(e,[{key:"onEnter",value:function(t){this.context.messageEndpoint.cancelPendingResponseCallbacks()}},{key:"sendMessage",value:function(t,a,s,u){if(y.matchesTypesFor(t,[gt.getTypeName()]))this.context.setState(De.Initing),Ql(this.context,t,a,s);else if(y.matchesTypesFor(t,[Je.getTypeName()]))this.context.setState(De.Closed);else{if(!u){Yg(this.context,t,a,s);return}a&&a(new Y({messageId:t.messageId,error:Bn.DroppedBecauseClientDisconnected}))}}},{key:"sendBytes",value:function(t){Zg(this.context,t)}}]),e}(hs),rh=function(n){(0,Ki.default)(e,n);var o=gs(e);function e(){var r;return(0,qo.default)(this,e),r=o.apply(this,arguments),r.stateName=De.Closed,r.possibleNextStates=[],r}return(0,$o.default)(e,[{key:"onEnter",value:function(t){this.context.messageEndpoint.cancelPendingResponseCallbacks()}}]),e}(hs);h();var bh=w(R()),Eh=w(B());h();h();var CI=function(){if(typeof TextEncoder=="undefined"){ih();var o={AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder};return TextEncoder=void 0,TextDecoder=void 0,o}else return{AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder}},ah=CI(),Jl=ah.AugLoopTextEncoder,jl=ah.AugLoopTextDecoder;h();var sh=w(R()),uh=w(B());var dn=function(){function n(){(0,sh.default)(this,n)}return(0,uh.default)(n,null,[{key:"deserialize",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:function(c){return c};if(e[0]!==n.IDENTIFIERBYTE)throw new Error("Invalid Binary: Incorrect Identifier");for(var t=1,a=[],s=new DataView(e.buffer,e.byteOffset,e.byteLength);t<e.byteLength;){if(t+4>e.byteLength)throw new Error("Invalid Binary: Error reading fragment length");var u=s.getUint32(t);if(t+u+4>e.byteLength)throw new Error("Invalid Binary: Fragment out of range");typeof Buffer!="undefined"&&Buffer.from?a.push(Buffer.from(e.buffer,e.byteOffset+t+4,u)):a.push(new Uint8Array(e.buffer,e.byteOffset+t+4,u)),t+=4+u}if(a.length<1)throw new Error("Invalid Binary: No fragments found");var l=n.textDecoder.decode(a[0]),f=function(d,p){if(typeof p=="string"){if(p.substring(0,n.BINARYKEYWORD.length)===n.BINARYKEYWORD){var g=parseInt(p.substring(n.BINARYKEYWORD.length),10);if(typeof g!="number"||g>=a.length-1)throw new Error("Invalid Binary: Binary index out of range");return r(a[g+1])}else if(p.substring(0,n.ESCAPEKEYWORD.length)===n.ESCAPEKEYWORD)return p.substring(n.ESCAPEKEYWORD.length)}return p};return JSON.parse(l,f)}},{key:"serialize",value:function(e){var r=[void 0],t=function(p,g){return ArrayBuffer.isView(g)?(r.push(g),`${n.BINARYKEYWORD}${r.length-2}`):g&&g.type==="Buffer"&&Array.isArray(g.data)?(r.push(new Uint8Array(g.data)),`${n.BINARYKEYWORD}${r.length-2}`):typeof g=="string"&&g.substring(0,n.ESCAPEKEYWORD.length)===n.ESCAPEKEYWORD?n.ESCAPEKEYWORD+g:g},a=JSON.stringify(e,t);r[0]=n.textEncoder.encode(a);var s=r.reduce(function(d,p){return d+4+p.byteLength},0),u=new Uint8Array(s+1);u[0]=n.IDENTIFIERBYTE;var l=1,f=new DataView(u.buffer,u.byteOffset,u.byteLength);for(var c of r)f.setUint32(l,c.byteLength),u.set(c,l+4),l+=4+c.byteLength;return u}}]),n}();dn.IDENTIFIERBYTE=3;dn.BINARYKEYWORD=":b";dn.ESCAPEKEYWORD=":";dn.textDecoder=new jl;dn.textEncoder=new Jl;h();var Th=w(R()),Ih=w(B());h();h();var fh=w(R()),ch=w(B());var xI=3,lh=3e4,Kl=function(){function n(o,e,r){(0,fh.default)(this,n),this.lastPingTime=0,this.lastPongTime=0,this.lastEgressTime=0,this.remainingPingFailures=3,this.isPingPongSuccessful=!1,this.pingPongLogOp=new E({operationName:"WebSocketReliabilityManager",success:!0}).start(),this.pingPongLogOp.setClientMetadata(r),this.worker=o,this.rateControllerClose=e}return(0,ch.default)(n,[{key:"start",value:function(){this.logOperation(!0,"ping","initial ping"),this.ping(),this.isPingPongSuccessful=!0,this.startInterval()}},{key:"onResponse",value:function(){this.lastPongTime=Date.now()}},{key:"isReliabilityResponse",value:function(e){return typeof e=="string"&&e.length===1&&e===n.pingPongMessage}},{key:"close",value:function(){this.logOperation(!0,"ping","close"),this.lastPingTime=0,this.lastPongTime=0,this.isPingPongSuccessful=!1,this.clearPingInterval(),this.worker=void 0}},{key:"checkConnection",value:function(){return this.isPingPongSuccessful}},{key:"postEgress",value:function(){this.lastEgressTime=Date.now()}},{key:"needsParsedResponses",value:function(){return!1}},{key:"ping",value:function(){this.lastPingTime=Date.now(),this.worker&&this.worker.egress({obj:n.pingPongMessage})}},{key:"startInterval",value:function(){var e=this;this.pingInterval=setInterval(function(){if(e.isPingPongSuccessful=e.lastPongTime>=e.lastPingTime&&e.lastPongTime-e.lastPingTime<=lh,!(e.lastPongTime>e.lastEgressTime)){var r=e.lastPongTime-e.lastPingTime;e.isPingPongSuccessful?(e.remainingPingFailures=xI,e.ping()):e.remainingPingFailures>0?(--e.remainingPingFailures,e.ping()):(e.logOperation(!1,"ping","Pong still not received after all retry attempts",[`${r}`,`${e.remainingPingFailures}`]),e.worker?e.worker.close():e.rateControllerClose())}},lh)}},{key:"clearPingInterval",value:function(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0)}},{key:"logOperation",value:function(e,r,t,a){var s,u,l,f;this.pingPongLogOp.start(),this.pingPongLogOp.success=e,this.pingPongLogOp.resultSignature=r,this.pingPongLogOp.resultDescription=t,a&&(this.pingPongLogOp.dimension0=(s=a[0])!==null&&s!==void 0?s:"",this.pingPongLogOp.dimension1=(u=a[1])!==null&&u!==void 0?u:"",this.pingPongLogOp.dimension2=(l=a[2])!==null&&l!==void 0?l:"",this.pingPongLogOp.dimension3=(f=a[3])!==null&&f!==void 0?f:""),m.info(507320073,v.CoreDefault,this.pingPongLogOp.stop())}}]),n}();Kl.pingPongMessage="~";h();var ph=w(R()),gh=w(B());var TI=15e3,II=2e4,_I=JSON.stringify(new Vr({longPollTimeoutHint:TI})),AI=6e4,MI="Request timed out",dh=4,hh=function(){function n(o,e){(0,ph.default)(this,n),this.remainingRetryAttempts=dh,this.isAsleep=!1,this.isLongPollSuccessful=!1,this.isActiveLongPoll=!1,this.isResponseReceived=!1,this.lastEgressTime=0,this.longPollLogOp=new E({operationName:"OnLongPollMessage",success:!0}),this.clientMetadata=e,this.longPollLogOp.setClientMetadata(this.clientMetadata),this.worker=o}return(0,gh.default)(n,[{key:"start",value:function(){var e=new E({operationName:"StartHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata),m.info(508163399,v.CoreDefault,e.stop()),this.trySendLongPoll(!0),this.isLongPollSuccessful=!0}},{key:"onResponse",value:function(e){if(!e||this.isResponseReceived){var r=new E({operationName:"HttpReliabilityManagerFailure",success:!1}).start();r.setClientMetadata(this.clientMetadata),m.info(508162497,v.CoreDefault,r.stop());return}this.isResponseReceived=!0,this.isActiveLongPoll=!1;var t=e;t.error?(this.isLongPollSuccessful=!1,--this.remainingRetryAttempts,this.remainingRetryAttempts>0?(this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription=`Retry attempts left : ${this.remainingRetryAttempts}`,this.longPollLogOp.resultSignature=t.error,m.info(508163398,v.CoreDefault,this.longPollLogOp.stop()),t.error===MI||this.remainingRetryAttempts===3?this.trySendLongPoll(!0):this.enqueueSendLongPoll()):(this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription="Long poll still not received after all retry attempts",m.info(508163397,v.CoreDefault,this.longPollLogOp.stop()),this.worker&&this.worker.close())):(this.longPollLogOp.success=!0,this.longPollLogOp.resultDescription="Long poll received",m.info(508163401,v.CoreDefault,this.longPollLogOp.stop()),this.remainingRetryAttempts=dh,this.isLongPollSuccessful=!0,this.trySendLongPoll())}},{key:"close",value:function(){var e=new E({operationName:"CloseHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata),m.info(508162467,v.CoreDefault,e.stop()),this.sendLongPollTimer&&(clearTimeout(this.sendLongPollTimer),this.sendLongPollTimer=void 0),this.isActiveLongPoll=!1,this.isLongPollSuccessful=!1,this.worker=void 0}},{key:"checkConnection",value:function(){if(this.isAsleep){this.isAsleep=!1;var e=new E({operationName:"AwakenHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata),m.info(508162496,v.CoreDefault,e.stop()),this.trySendLongPoll(!0)}return this.isLongPollSuccessful}},{key:"isReliabilityResponse",value:function(e){return typeof e!="string"&&er.typeGuard(e)}},{key:"postEgress",value:function(){this.lastEgressTime=Date.now(),this.trySendLongPoll()}},{key:"needsParsedResponses",value:function(){return!0}},{key:"enqueueSendLongPoll",value:function(){var e=this;this.sendLongPollTimer=setTimeout(function(){e.trySendLongPoll(!0)},II)}},{key:"trySendLongPoll",value:function(e){if(!this.worker){var r=new E({operationName:"LongPollNoOp",success:!0}).start();r.setClientMetadata(this.clientMetadata),r.resultDescription="Worker is undefined",m.info(507281438,v.CoreDefault,r.stop());return}if(this.isActiveLongPoll===!0){var t=new E({operationName:"LongPollNoOp",success:!0}).start();t.setClientMetadata(this.clientMetadata),t.resultDescription="Already active long poll",m.info(508163396,v.CoreDefault,t.stop());return}if(this.isActiveLongPoll=!0,Date.now()-this.lastEgressTime>AI&&!e){this.isActiveLongPoll=!1,this.isAsleep=!0;var a=new E({operationName:"LongPollSleep",success:!0}).start();a.setClientMetadata(this.clientMetadata),a.resultDescription=`isAsleep: ${this.isAsleep}, isActiveLongPoll: ${this.isActiveLongPoll}`,m.info(507278739,v.CoreDefault,a.stop());return}this.longPollLogOp.start(),this.isResponseReceived=!1,this.worker.egress({obj:_I,isHttpSessionLongPollMessage:!0,isHttpSessionInitMessage:!1})}}]),n}();h();var mh=w(R()),vh=w(B());var Xi=w(us());var bI=2e4,EI=JSON.stringify(new er({error:ls})),ms=function(){function n(){(0,mh.default)(this,n),this.isClosed=!1,this.pendingEgress=[]}return(0,vh.default)(n,[{key:"init",value:function(e,r,t,a){var s=new E({operationName:"HttpWorkerInit",success:!0}).start(),u=e.split("/?x-origin=");u.length===2?(this.url=me.convertWebSocketUrlToHttp(u[0]),this.origin=u[1]):(this.url=me.convertWebSocketUrlToHttp(e),this.origin=void 0),this.ingress=r,this.onOpen=t,this.onClose=a,m.info(507839180,v.CoreDefault,s.stop())}},{key:"egress",value:function(e){var r=this,t=new E({operationName:"HttpEgress",success:!0}).start();if(!(this.isConnectedToSession()||e.isHttpSessionInitMessage)){this.pendingEgress.push(e),t.success=!1,t.resultDescription="NotConnected, pendingQueueSize:  "+this.pendingEgress.length.toString(),m.info(508163394,v.CoreDefault,t.stop());return}var a=this.getRequestInfo(e,t);if(!a.url){t.success=!1,t.resultDescription="Could not generate HTTP request",m.error(508163393,v.CoreDefault,t.stop());return}if(e.isHttpSessionLongPollMessage){this.egressLongPoll(a,t);return}Hr(a.url,a.request,function(s,u){s?r.onEgressError(t,"OnEgressError:"+(s==null?void 0:s.message)):!u||!u.ok?r.onEgressError(t,"OnEgressResponseError: "+(s==null?void 0:s.message)+`, Status ${u==null?void 0:u.status}: ${u==null?void 0:u.statusText}`):u.text().then(function(l){t.success=!0,m.info(508163362,v.CoreDefault,t.stop()),r.ingressInternal(l)}).catch(function(l){r.onEgressError(t,"OnEgressParseError: "+(l==null?void 0:l.message))})})}},{key:"close",value:function(){var e=new E({operationName:"HttpWorkerClose",success:!0}).start();if(this.isClosed){e.resultDescription="AlreadyClosed",m.info(508163360,v.CoreDefault,e.stop());return}m.info(508163359,v.CoreDefault,e.stop()),this.isClosed=!0,this.sessionSettings=void 0,this.onClose&&(this.onClose(void 0),this.onClose=void 0)}},{key:"onEgressError",value:function(e,r){e.success=!1,e.resultDescription=r,m.error(508163358,v.CoreDefault,e.stop()),this.isClosed||this.close()}},{key:"ingressInternal",value:function(e,r){var t=this,a=e;r||(a=this.formatServerInput(e));var s=function(l){ln.typeGuard(l)&&t.onSessionInitResponse(l)};a&&(this.logIngressCount(a),this.ingress(a,s))}},{key:"onSessionInitResponse",value:function(e){var r=this,t=new E({operationName:"HttpWorkerOpen",success:!0}).start();if(!e.sessionKey||!e.origin||!e.anonymousToken||!e.sessionUrlBase){t.success=!1,t.resultDescription="SessionInitResponse missing information",m.error(507809949,v.CoreDefault,t.stop());return}m.info(508163357,v.CoreDefault,t.stop()),this.setSessionSettings(e.sessionKey,e.origin,e.anonymousToken,e.sessionUrlBase),this.onOpen(),this.pendingEgress.forEach(function(a){r.egress(a)}),this.pendingEgress=[]}},{key:"egressLongPoll",value:function(e,r){var t=this;Ag(e.url,bI,e.request).then(function(a){!a||!a.ok?t.onEgressError(r,"LongPollFetchStatusFailure: "+(a==null?void 0:a.statusText)):a.text().then(function(s){r.success=!0,r.resourceId="LongPoll",m.info(508163355,v.CoreDefault,r.stop()),t.ingressInternal(s)}).catch(function(s){t.onEgressError(r,"LongPollFetchParseError: "+(s==null?void 0:s.message))})}).catch(function(a){a.message===ls?(r.success=!1,r.resultDescription="LongPollFetchResponseTimeout:"+(a==null?void 0:a.message),m.error(508163353,v.CoreDefault,r.stop()),t.ingressInternal(EI,!0)):t.onEgressError(r,"LongPollFetchResponseError: "+(a==null?void 0:a.message))})}},{key:"getRequestInfo",value:function(e,r){var t=this.getUrl(e==null?void 0:e.isHttpSessionInitMessage),a=this.getHeader(e,r);return r.resultSignature=t,{url:t,request:{method:"POST",headers:a,body:e.obj}}}},{key:"getUrl",value:function(e){var r=this.sessionSettings&&this.sessionSettings.sliceUrl?this.sessionSettings.sliceUrl:this.url;return e?r+"/sessioninit":this.isConnectedToSession()?r+"/session/"+this.sessionSettings.sessionKey:""}},{key:"getHeader",value:function(e,r){if(e!=null&&e.isHttpSessionInitMessage){var t=new Xi.Headers({"Content-Type":"application/json"});return this.origin&&t.set("x-origin",this.origin),t}else if(this.isConnectedToSession()){var a;return e.obj instanceof Uint8Array||e.obj instanceof ArrayBuffer?(a=new Xi.Headers({"Content-Type":"application/jsond2"}),r.dimension0=e.obj.byteLength.toString().length.toString()):a=new Xi.Headers({"Content-Type":"application/json"}),a.append("Authorization",`Bearer ${this.sessionSettings.anonymousToken}`),a.set("x-origin",this.sessionSettings.origin),a}return new Xi.Headers}},{key:"setSessionSettings",value:function(e,r,t,a){var s=a.replace("/session","");this.sessionSettings={sessionKey:e,origin:r,anonymousToken:t,sliceUrl:s}}},{key:"isConnectedToSession",value:function(){return this.sessionSettings&&this.sessionSettings.sessionKey.length>0&&this.sessionSettings.anonymousToken.length>0&&this.sessionSettings.origin.length>0&&this.sessionSettings.sliceUrl.length>0&&!this.isClosed}},{key:"formatServerInput",value:function(e){return e.length>1?e.substring(1,e.length-1):""}},{key:"logIngressCount",value:function(e){var r=e.length;if(r>1e5){var t=new E({operationName:"HttpIngressByteOrderOfMagnitude",success:!0}).start();t.dimension2=r.toString().length.toString(),m.info(508409622,v.CoreDefault,t.stop())}}}]),n}();var yh=function(o,e,r){return o instanceof ms?new hh(o,r):new Kl(o,e,r)};var _h=w(zl()),kh=function(n,o,e,r){function t(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(c){try{f(r.next(c))}catch(d){s(d)}}function l(c){try{f(r.throw(c))}catch(d){s(d)}}function f(c){c.done?a(c.value):t(c.value).then(u,l)}f((r=r.apply(n,o||[])).next())})},wh=50,Sh=1e5,NI=1e4,Xl=1e4,Ch=3e6,Yl=1e3,DI=1e4,xh=.9,Ah=function(){function n(o){var e=this;(0,Th.default)(this,n);var r;this.emptyMessageId=0,this.egressMessageCount=0,this.egressByteCount=0,this.prevSeq=-1,this.pendingQueue=[],this.rpsThreshold=150,this.bpsThreshold=5e8,this.isClosing=!1,this.messageQueue=void 0,this.egressRateLogOp=new E({operationName:"NetworkEgressRate",success:!0}),this.egressedCache=new Map,this.initPromise=new Promise(function(t){e.resolveInitPromise=t}),this.dynamicRateControllerEnabled=(r=o==null?void 0:o.dynamicRateControllerEnabled)!==null&&r!==void 0?r:!1,this.dynamicRateControllerEnabled&&(this.messageQueue=new _h.default)}return(0,Ih.default)(n,[{key:"init",value:function(e,r,t,a,s){var u=this;this.worker=e,this.ingress=r,this.queryEgressCacheSize=t,this.clientMetadata=s,this.networkMode=a,this.reliabilityManager=yh(this.worker,this.close.bind(this)),this.egressRateLogOp.setClientMetadata(this.clientMetadata),this.dynamicRateControllerEnabled&&(this.resetRateLimiter(),this.onCloseController=new Promise(function(l){u.resolveCloseControllerPromise=l}),this.queueProcessingCompletePromise=new Promise(function(l){u.resolveQueueProcessingCompletePromise=l}),this.processQueue()),this.resolveInitPromise()}},{key:"open",value:function(){var e=this,r=new E({operationName:"NetworkRateControllerOpen",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();r.setClientMetadata(this.clientMetadata),this.initPromise.then(function(){if(!e.reliabilityManager){r.success=!1,r.resultDescription="Reliability Manager is undefined";return}e.egressRateControlIntervalStart=Date.now(),e.reliabilityManager.start(),e.dynamicRateControllerEnabled||(e.egressRateControlTimer=setInterval(function(){return e.flush()},1e3),e.flush())}).catch(function(t){var a;r.success=!1,r.resultDescription=(a="Catch: "+(t==null?void 0:t.message))!==null&&a!==void 0?a:""}).finally(function(){m.info(507834384,v.CoreDefault,r.stop())})}},{key:"ingressFromWorker",value:function(e,r){var t=this;if(!this.reliabilityManager){this.ingress(e,r);return}if(!this.reliabilityManager.needsParsedResponses()&&this.reliabilityManager.isReliabilityResponse(e)){this.reliabilityManager.onResponse();return}this.ingress(e,function(a){r==null||r(a),t.reliabilityManager.needsParsedResponses()&&t.reliabilityManager.isReliabilityResponse(a)&&t.reliabilityManager.onResponse(a)})}},{key:"onRateLimitErrorResponse",value:function(e){if(this.dynamicRateControllerEnabled){var r=new E({operationName:"NetworkRateControllerOnRateLimitResponse",success:!0}).start();r.setClientMetadata(this.clientMetadata),r.resultSignature=`rateLimitAlreadyStarted: ${this.rateLimitTimeout!==void 0}`,r.setDataField("RetryAfterMs",e.retryAfterMs),r.setDataField("QueueSize",this.messageQueue.length),this.startRateLimiting(e.retryAfterMs),m.info(507388684,v.CoreDefault,r.stop())}}},{key:"setRpsBps",value:function(e,r){var t=new E({operationName:"NetworkRateControllerRateLimitsSet",success:!0}).start();t.setClientMetadata(this.clientMetadata),e&&(this.rpsThreshold=xh*e,t.resultDescription+=`maxRPS: ${e}, rpsThreshold: ${this.rpsThreshold}; `),r&&(this.bpsThreshold=xh*r,t.resultDescription+=`maxRPS: ${r}, rpsThreshold: ${this.bpsThreshold}; `),m.info(507388683,v.CoreDefault,t.stop())}},{key:"close",value:function(){var e,r;return kh(this,void 0,void 0,function*(){var t=new E({operationName:"NetworkRateControllerClose",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();if(t.setClientMetadata(this.clientMetadata),this.isClosing=!0,this.dynamicRateControllerEnabled){(e=this.resolveCloseControllerPromise)===null||e===void 0||e.call(this);var a=(r=this.reliabilityManager)===null||r===void 0?void 0:r.checkConnection();t.setDataField("QueueSizeBeforeFlush",this.messageQueue.length),this.messageQueue.length!=0&&a&&(yield this.queueProcessingCompletePromise),t.setDataField("QueueSizeAfterFlush",this.messageQueue.length),t.setDataField("IsConnected",a)}this.reliabilityManager?this.reliabilityManager.close():t.resultDescription="Reliability Manager is undefined",this.worker=void 0,this.prevSeq=-1,this.clearEgressControlTimeout(),this.reliabilityManager=void 0,m.info(507834381,v.CoreDefault,t.stop())})}},{key:"clearMessageQueues",value:function(){this.pendingQueue=[],this.egressedCache.clear(),this.messageQueue=void 0}},{key:"egress",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,t,a,s;if(!this.reliabilityManager){this.logEgressActivity(!1,"Reliability Manager is undefined","");return}var u=this.getMessageSize(e);if(u>=Ch){this.logEgressActivity(!1,`Message size exceeded ${Ch}`,`Message size: ${u}`);return}if((e.obj instanceof ArrayBuffer||e.isHttpSessionInitMessage)&&this.worker){this.logEgressActivity(!0,`isArrayBuffer: ${e.obj instanceof ArrayBuffer}, isHttpSessionInitMessage: ${e.isHttpSessionInitMessage}`,""),this.worker.egress(e);return}if(this.validateSyncMessage(e.messageId,e.seqId),this.dynamicRateControllerEnabled){var l=(t=e.messageId)!==null&&t!==void 0?t:`id${this.emptyMessageId++}`,f={obj:e.obj,seqId:e==null?void 0:e.seqId,messageId:l,isHttpSessionInitMessage:e==null?void 0:e.isHttpSessionInitMessage},c=r>0,d=new E({operationName:"NetworkRateControllerQueueItem",success:!0,dimension3:`isRetry: ${c}`}).start();d.setClientMetadata(this.clientMetadata);var p={message:f,logOp:d};if(d.dimension0="Enqueue",c?this.messageQueue.unshift(p):this.messageQueue.push(p),this.messageQueue.length>DI)throw this.messageQueue.shift(),new Error("MessageQueue max size reached.");m.info(507388547,v.CoreDefault,d.stop()),(a=this.resolveQueueNotEmptyPromise)===null||a===void 0||a.call(this)}else{var g=this.queryEgressCacheSize(),k=this.egressMessageCount>=this.rpsThreshold,S=this.egressByteCount>=this.bpsThreshold,x=g>Xl,C=this.reliabilityManager.checkConnection(),T=this.pendingQueue.length!==0,I=this.pendingQueue.length>=NI;if(!C||k||S||T||I||x){var _="",M=[];(T||I)&&(_+=I?"Pending queue max exceeded. ":"Pending queue not empty. ",M.push(this.pendingQueue.length.toString().length.toString())),x&&(_+=g>=Xl?"Egressed cache max exceeded. ":"",M.push(g.toString().length.toString())),k&&(_+="RPS exceeded. ",M.push(this.egressMessageCount.toString().length.toString())),S&&(_+="BPS exceeded. ",M.push(this.egressByteCount.toString().length.toString())),_+=C?"":"Not connected. ",this.logEgressActivity(!0,`networkMode: ${this.networkMode}`,_,M);var A=(s=e.messageId)!==null&&s!==void 0?s:`id${this.emptyMessageId++}`;this.pendingQueue.push({obj:e.obj,seqId:e==null?void 0:e.seqId,messageId:A,isHttpSessionInitMessage:e==null?void 0:e.isHttpSessionInitMessage});return}this.sendToNetworkWorker(e)}}},{key:"getMessageSize",value:function(e){return e.obj instanceof ArrayBuffer?e.obj.byteLength:e.obj.length}},{key:"sendToNetworkWorker",value:function(e){try{if(!this.worker){this.logEgressActivity(!1,"NetworkWorker is undefined","SendToNetworkWorkerFailure");return}if(!this.reliabilityManager){this.logEgressActivity(!1,"Reliability Manager is undefined","SendToNetworkWorkerFailure");return}this.worker.egress(e),this.reliabilityManager.postEgress();var r=this.getMessageSize(e);this.logEgressCount(r)}catch(t){this.logEgressActivity(!1,"SendToNetworkWorkerFailure",t?t.message:"")}}},{key:"flush",value:function(){if(!this.reliabilityManager){var e=new E({operationName:"NetworkRateControllerFlushFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`}).start();e.setClientMetadata(this.clientMetadata),e.resultDescription="Reliability Manager is undefined",m.info(507834373,v.CoreDefault,e.stop());return}for(var r=0,t=0;this.pendingQueue.length>0&&this.queryEgressCacheSize()<Xl&&r<this.rpsThreshold&&t<this.bpsThreshold&&this.reliabilityManager.checkConnection();){var a=this.pendingQueue.shift();this.sendToNetworkWorker(a),r++,t+=this.getMessageSize(a)}}},{key:"processQueue",value:function(){var e,r;return kh(this,void 0,void 0,function*(){if(!this.reliabilityManager){var t=new E({operationName:"NetworkRateControllerProcessQueueFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`}).start();t.setClientMetadata(this.clientMetadata),t.resultDescription="Reliability Manager is undefined",m.info(507573643,v.CoreDefault,t.stop());return}for(var a=new E({operationName:"NetworkRateControllerProcessQueue",success:!0}).start();;){if(this.messageQueue.length===0){if(this.isClosing){a.setDataField("ExitReason","Stage#1 Closing");break}yield Promise.race([this.queueNotEmpty(),this.onCloseController])}if(this.rateLimitTimeout){var s=new E({operationName:"NetworkRateControllerRateLimitBackoff",dimension3:`networkMode: ${this.networkMode}`}).start();s.setClientMetadata(this.clientMetadata),s.setDataField("QueueLengthBeforeBackoff",this.messageQueue.length),yield Promise.race([this.rateLimitTimeout,this.onCloseController]),s.setDataField("QueueLengthAfterBackoff",this.messageQueue.length),s.setDataField("IsClosing",this.isClosing),s.success=!0,this.rateLimitTimeout=void 0,this.resetRateLimiter(),m.info(507281410,v.CoreDefault,s.stop())}if(!(!((e=this.reliabilityManager)===null||e===void 0)&&e.checkConnection())){if(this.isClosing){a.setDataField("ExitReason","Stage#2 Closing");break}yield this.checkConnectionPromise(),this.connectionPromise=void 0}if(!this.reliabilityManager){a.setDataField("ExitReason","Stage#2 ReliabilityManager null");break}for(;this.messageQueue.length>0&&this.reliabilityManager.checkConnection();){var u=Date.now()-this.egressRateControlIntervalStart;if(u>=Yl)this.resetRateLimiter();else if(this.egressMessageCount>=this.rpsThreshold||this.egressByteCount>=this.bpsThreshold){var l=Date.now()-this.egressRateControlIntervalStart,f=Yl-l+100,c="";this.egressMessageCount>=this.rpsThreshold&&(c+="RPS exceeded."),this.egressByteCount>=this.bpsThreshold&&(c+="BPS exceeded.");var d="rateLimitHit",p=new E({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`}).start();p.setClientMetadata(this.clientMetadata),p.success=!0,p.resultDescription=d,p.resultSignature=c,p.dimension0=this.messageQueue.length.toString().length.toString(),p.dimension1="rateLimitHit",p.setDataField("QueueLength",this.messageQueue.length),p.setDataField("RateLimitDelayMs",f),m.info(507281409,v.CoreDefault,p.stop()),this.startRateLimiting(f);break}var g=this.messageQueue.shift();g.logOp.dimension0="Dequeue",this.sendToNetworkWorker(g.message),m.info(507388682,v.CoreDefault,g.logOp.stop())}this.onQueueNotEmpty=void 0,this.resolveQueueNotEmptyPromise=void 0}this.resolveQueueProcessingCompletePromise(),this.resolveQueueProcessingCompletePromise=void 0,a.setClientMetadata(this.clientMetadata),a.setDataField("QueueSize",this.messageQueue.length),a.setDataField("IsConnected",(r=this.reliabilityManager)===null||r===void 0?void 0:r.checkConnection()),a.setDataField("IsClosing",this.isClosing),m.info(507368671,v.CoreDefault,a.stop())})}},{key:"queueNotEmpty",value:function(){var e=this;return this.onQueueNotEmpty||(this.onQueueNotEmpty=new Promise(function(r){e.resolveQueueNotEmptyPromise=r})),this.onQueueNotEmpty}},{key:"checkConnectionPromise",value:function(){return this.connectionPromise||(this.connectionPromise=new Promise(function(e){setTimeout(e,1e3)})),this.connectionPromise}},{key:"startRateLimiting",value:function(e){this.rateLimitTimeout||(this.rateLimitTimeout=new Promise(function(r){setTimeout(r,e)}))}},{key:"resetRateLimiter",value:function(){this.egressRateControlIntervalStart=Date.now(),this.egressMessageCount=0,this.egressByteCount=0}},{key:"clearEgressControlTimeout",value:function(){this.egressRateControlTimer&&(clearInterval(this.egressRateControlTimer),this.egressRateControlTimer=void 0)}},{key:"validateSyncMessage",value:function(e,r){if(!(r===void 0||e===void 0||r<=this.prevSeq)){if(r&&r!==this.prevSeq+1){var t=new E({operationName:"NetworkRateControllerAbandonedSyncMessage",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();t.setClientMetadata(this.clientMetadata),t.resultDescription="Gap in sync message",t.dimension0=`${this.prevSeq}`,t.dimension1=`${r}`,t.dimension2=`${r-this.prevSeq}`,m.info(507834370,v.CoreDefault,t.stop())}this.prevSeq=r}}},{key:"logEgressActivity",value:function(e,r,t,a){var s,u,l,f,c=new E({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`}).start();c.setClientMetadata(this.clientMetadata),c.success=e,c.resultDescription=r,c.resultSignature=t,a&&(c.dimension0=(s=a[0])!==null&&s!==void 0?s:"",c.dimension1=(u=a[1])!==null&&u!==void 0?u:"",c.dimension2=(l=a[2])!==null&&l!==void 0?l:"",c.dimension3=(f=a[3])!==null&&f!==void 0?f:""),m.info(507626007,v.CoreDefault,c.stop())}},{key:"logEgressCount",value:function(e){var r=Date.now();r-this.egressRateControlIntervalStart>Yl&&((this.egressMessageCount>wh||this.egressByteCount>Sh)&&(this.egressRateLogOp.start(),this.egressRateLogOp.resultDescription=this.egressMessageCount>wh?"rps logging threshold exceeded":"",this.egressRateLogOp.resultDescription=this.egressByteCount>Sh?"bps logging threshold exceeded":"",this.egressRateLogOp.dimension0=(r-this.egressRateControlIntervalStart).toString(),this.egressRateLogOp.dimension1=`${this.egressMessageCount}`,this.egressRateLogOp.dimension2=`${this.egressByteCount}`,this.egressRateLogOp.dimension3=`networkMode: ${this.networkMode}`,m.info(508843792,v.CoreDefault,this.egressRateLogOp.stop())),this.egressRateControlIntervalStart=r,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=e!=null?e:0}}]),n}();h();var Mh="sessionWorkflowContext",be;(function(n){n[n.JSWebSockets=0]="JSWebSockets",n[n.LocalWorkflowsOnly=1]="LocalWorkflowsOnly",n[n.HostWebSockets=2]="HostWebSockets",n[n.HttpFallback=3]="HttpFallback"})(be||(be={}));h();var pn=w(R()),gn=w(B());var to=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_WorkflowRegistrationMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();to.H_={T_:to.getTypeName(),B_:to.getBaseTypes()};var no=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();no.H_={T_:no.getTypeName(),B_:no.getBaseTypes()};var Go=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Go.H_={T_:Go.getTypeName(),B_:Go.getBaseTypes()};var Yi=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_RuntimeInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Yi.H_={T_:Yi.getTypeName(),B_:Yi.getBaseTypes()};var Zl=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_DiagnosticTraceMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Zl.H_={T_:Zl.getTypeName(),B_:Zl.getBaseTypes()};var Zi=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_TelemetryMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Zi.H_={T_:Zi.getTypeName(),B_:Zi.getBaseTypes()};var ef=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_TelemetryFlushMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ef.H_={T_:ef.getTypeName(),B_:ef.getBaseTypes()};var ea=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_SessionCloseResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ea.H_={T_:ea.getTypeName(),B_:ea.getBaseTypes()};var rr=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_WorkflowDefinitionOverrideMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();rr.H_={T_:rr.getTypeName(),B_:rr.getBaseTypes()};var ro=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsRequestMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ro.H_={T_:ro.getTypeName(),B_:ro.getBaseTypes()};var ta=function(){function n(o){(0,pn.default)(this,n),y.assign(n,this,o)}return(0,gn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsResponseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ta.H_={T_:ta.getTypeName(),B_:ta.getBaseTypes()};var Nh=1e3,PI=6e4,RI=function(o,e,r){var t=0,a=me.getCurrentTimeMs()?me.getCurrentTimeMs()-e:0,s=[1e3,2e3,5e3,1e4,6e4];return t=s[Math.max(0,Math.min(s.length-1,o-1))],t=Math.max(t-a,Nh),t=r&&r>0?Math.min(5e3,t):t,t},na=function(){function n(o,e,r,t,a,s,u,l,f,c){var d=this;(0,bh.default)(this,n),this.logCountLimiter=new eo(n.className),this.isWorkerReady=!1,this.permanentlyClosed=!1,this.currentReconnectAttempt=0,this.lastInitializationAttemptTimeMs=0,this.offlineInterval=void 0,this.alreadyLoggedReconnectAttempt=!1,this.httpTestsLeft=5,this.httpTestsSuccessCount=0,this.workerOpenCount=0,this.testHttpConnection=function(p){var g=me.convertWebSocketUrlToHttp(d.globalUrl),k=!p,S=p!=null?p:new E({operationName:"HttpsTest",resourceId:sn(g),success:!1,resultDescription:"",resultSignature:"HttpResponse:"}).start(),x={method:"POST",headers:{"content-type":"application/json","X-CorrelationId":S.cv},body:JSON.stringify(me.createHealthCheckRequest(d.clientMetadata))};Hr(g,x,function(C,T){C?(S.dimension1="HttpErr",S.resultDescription+=`HttpErr: ${C.message}`):!T||!T.ok?(S.dimension1="HttpNoResp",S.resultDescription+=`HttpStatus: ${T==null?void 0:T.status}`):(S.dimension1="HttpOK",d.leaveOfflineMode(),d.httpTestsSuccessCount++,k&&(S.success=!0)),k&&S.stop(),d.logCountLimiter.log(function(){m.info(508843780,v.CoreDefault,S)})})},this.globalUrl=o,this.clientMetadata=e,this.workerFactory=r,this.sessionInitializer=t,this.ingress=a,this.queryEgressCacheSize=s,this.onConnectionClose=u,this.onDetectedWSBlock=l,this.httpFallbackEnabled=f.httpFallbackEnabled,this.dynamicRateControllerEnabled=f.dynamicRateControllerEnabled,this.networkWorkerLogOp=new E({operationName:"CreateNetworkWorker",success:!0}),this.networkMode=c||be.JSWebSockets}return(0,Eh.default)(n,[{key:"init",value:function(e,r){var t=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(this.permanentlyClosed)return Promise.reject(new Error("permanentlyClosed"));if(this.isWorkerReady||this.pendingInitPromise)return this.pendingInitPromise?this.pendingInitPromise:Promise.resolve();this.extensionConfigs=e||this.extensionConfigs;var s=function(){if(a||!t.alreadyLoggedReconnectAttempt){var l=a?n.initialAttemptTimeout:n.reconnectAttemptTimeout;t.connTimeout=setTimeout(function(){var f=new E({operationName:"ConnectionFailingOrSlow",dimension0:a?"Initial":"Reconnect",dimension1:l.toString(),dimension2:t.currentReconnectAttempt.toString()});m.info(508843787,v.CoreDefault,f),t.alreadyLoggedReconnectAttempt=!a,t.connTimeout=void 0},l)}};return r?this.pendingInitPromise=r().catch(function(u){var l=new E({operationName:"WorkerManagerCustomInit",success:!1,resultDescription:`${u}`});m.error(508843786,v.CoreDefault,l)}).then(function(){s(),t.initInternal()}):(this.pendingInitPromise=Promise.resolve(),s(),this.initInternal()),this.pendingInitPromise}},{key:"egress",value:function(e,r){var t=this;return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(function(){t.egressInternal(e,r)}):(this.egressInternal(e,r),Promise.resolve())}},{key:"egressBytes",value:function(e){var r=this;return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(function(){r.egressBytesInternal(e)}):(this.egressBytesInternal(e),Promise.resolve())}},{key:"getNetworkMode",value:function(){return this.networkMode}},{key:"onRateLimitErrorResponse",value:function(e){this.dynamicRateControllerEnabled&&this.getNetworkRateController().onRateLimitErrorResponse(e)}},{key:"close",value:function(e){this.isWorkerReady=!1,this.dynamicRateControllerEnabled&&this.networkRateController&&this.getNetworkRateController().close(),this.worker&&(this.worker.close(),this.worker=null),!this.dynamicRateControllerEnabled&&this.networkRateController&&this.getNetworkRateController().close(),this.networkRateController=null,this.permanentlyClosed=e||this.permanentlyClosed,this.permanentlyClosed&&(this.leaveOfflineMode(),clearTimeout(this.connTimeout))}},{key:"initInternal",value:function(){var e=this;if(this.isWorkerReady=!1,this.permanentlyClosed||this.isOffline()){var r=new E({operationName:"WorkerManagerInitOffline",success:!0,resultSignature:this.permanentlyClosed?"PermanentlyClosed":"Offline"});m.info(508843785,v.CoreDefault,r);return}this.currentReconnectAttempt>0?setTimeout(function(){e.tryToConnectAndInitializeSession()},RI(this.currentReconnectAttempt,this.lastInitializationAttemptTimeMs,this.httpFallbackEnabled?this.httpTestsSuccessCount:void 0)):this.tryToConnectAndInitializeSession()}},{key:"egressInternal",value:function(e,r){if(!this.isWorkerReady&&!y.matchesTypesFor(e,[gt.getTypeName()])){y.matchesTypesFor(e,[Fe.getTypeName()])||m.error(508843784,v.CoreDefault,new E({operationName:"UnexpectedEgressCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}));return}var t;y.matchesTypesFor(e,[tr.getTypeName()])?(this.castBinaryData(e),t=dn.serialize(e)):t=JSON.stringify(e);var a;if(Be.typeGuard(e)&&(a=e.seq),this.bypassRateController(e)){this.worker.egress({obj:t});return}var s=gt.typeGuard(e)&&this.getNetworkMode()===be.HttpFallback;this.getNetworkRateController().egress({obj:t,isHttpSessionInitMessage:s,messageId:e.messageId,seqId:a},r)}},{key:"bypassRateController",value:function(e){return Je.typeGuard(e)}},{key:"egressBytesInternal",value:function(e){if(!this.isWorkerReady){m.error(508843783,v.CoreDefault,new E({operationName:"UnexpectedEgressBytesCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}));return}this.getNetworkRateController().egress({obj:e})}},{key:"tryToConnectAndInitializeSession",value:function(){var e=this;this.currentReconnectAttempt++,this.lastInitializationAttemptTimeMs=me.getCurrentTimeMs();var r=function a(s){e.permanentlyClosed||e.isOffline()||(e.connect(e.sliceUrl?e.sliceUrl:e.globalUrl),e.sessionInitializer.initSession({isTokenRefresh:!1,isReconnectOnSameSlice:!!e.sliceUrl,extensionConfigs:e.extensionConfigs,onResponse:function(l,f){if(s.success=!l,s.resourceId=f?sn(f.sliceUrl):"",s.dimension2=e.getNetworkModeLogString(),e.getNetworkMode()===be.HttpFallback?(s.resultDescription=l?`HTTP Error: ${l.error}`:"",s.dimension0=s.success?"HTTPOK":"HTTPFail"):(s.resultDescription=l?`WS Error: ${l.error}`:"",s.dimension0=s.success?"WSOK":"WSFail"),l||!e.worker){e.sliceUrl=void 0,e.close(),e.httpTestsLeft>0?(e.httpTestsLeft--,e.testHttpConnection(s.stop())):(e.httpFallbackEnabled?e.getNetworkMode()===be.JSWebSockets?e.workerOpenCount===0&&e.httpTestsSuccessCount>=5?(s.dimension1="WSBlocked",s.dimension3="HTTP Fallback",e.networkMode=be.HttpFallback,e.currentReconnectAttempt=0,e.resetHttpTestsCounter()):e.httpTestsSuccessCount===0&&(e.startOfflineMode(),s.dimension1="WSOffline"):e.httpTestsSuccessCount===0&&(e.startOfflineMode(),s.dimension1="HTTPOffline"):e.workerOpenCount===0&&e.httpTestsSuccessCount>=5?(e.permanentlyClosed=!0,s.dimension1="WSBlocked",e.onDetectedWSBlock()):e.httpTestsSuccessCount===0&&(e.startOfflineMode(),s.dimension1="WSOffline"),e.logCountLimiter.log(function(){m.info(508843782,v.CoreDefault,s.stop())})),e.initInternal();return}else if(e.logCountLimiter.log(function(){m.info(508843781,v.CoreDefault,s.stop())}),f.forceReconnect){e.close();var c=new E({operationName:"ForcedReconnect"}).start();c.resultSignature=`globalUrl: ${e.globalUrl}. sliceUrl: ${e.sliceUrl}`,e.sliceUrl=void 0,setTimeout(function(){a(c)},Nh)}else clearTimeout(e.connTimeout),e.sliceUrl=f.sliceUrl,e.dynamicRateControllerEnabled&&e.getNetworkRateController().setRpsBps(f.maxRPS,f.maxBPS),e.ready();e.resetHttpTestsCounter()}}))},t=new E({operationName:"TryToConnectAndInitializeSession",resultSignature:`Reconnection attempt #${this.currentReconnectAttempt}`}).start();r(t)}},{key:"getNetworkRateController",value:function(){return this.networkRateController||(this.networkRateController=new Ah({dynamicRateControllerEnabled:this.dynamicRateControllerEnabled})),this.networkRateController}},{key:"connect",value:function(e){var r=this,t=this.getNetworkMode();this.networkWorkerLogOp.start(),this.networkWorkerLogOp.resultDescription=this.getNetworkModeLogString(),this.networkWorkerLogOp.dimension0=t.toString(),this.logCountLimiter.log(function(){return m.info(508372418,v.CoreDefault,r.networkWorkerLogOp.stop())}),this.worker=this.workerFactory(t),this.worker.init(e,this.getNetworkRateController().ingressFromWorker.bind(this.networkRateController),function(){r.workerOpenCount++,r.getNetworkRateController().open(),r.leaveOfflineMode()},function(a){r.close(),r.onConnectionClose(a)},this.clientMetadata),this.getNetworkRateController().init(this.worker,this.ingress,this.queryEgressCacheSize,t,this.clientMetadata)}},{key:"ready",value:function(){this.isWorkerReady=!0,this.pendingInitPromise=void 0,this.currentReconnectAttempt=0}},{key:"castBinaryData",value:function(e){if(e){if(Array.isArray(e.__binaryMembers__))for(var r of e.__binaryMembers__)ArrayBuffer.isView(e[r])||(e[r]=new Uint8Array(e[r]));for(var t of Object.keys(e))typeof e[t]=="object"&&e[t]!==null&&this.castBinaryData(e[t])}}},{key:"isOffline",value:function(){return!!this.offlineInterval}},{key:"startOfflineMode",value:function(){var e=this;this.offlineInterval=setInterval(function(){e.testHttpConnection()},PI)}},{key:"leaveOfflineMode",value:function(){this.isOffline()&&(clearInterval(this.offlineInterval),this.offlineInterval=void 0,this.resetHttpTestsCounter(),this.tryToConnectAndInitializeSession())}},{key:"resetHttpTestsCounter",value:function(){this.httpTestsLeft=5,this.httpTestsSuccessCount=0}},{key:"getNetworkModeLogString",value:function(){return"NetworkMode: "+(this.getNetworkMode()===be.JSWebSockets?"WebSocket":"HTTP")}}]),n}();na.initialAttemptTimeout=1e5;na.reconnectAttemptTimeout=2e4;na.className="NetworkWorkerManager";function BI(n){var o=WI();return function(){var r=(0,tf.default)(n),t;if(o){var a=(0,tf.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Bh.default)(this,t)}}function WI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var nf=function(n){(0,Rh.default)(e,n);var o=BI(e);function e(r,t,a,s,u,l,f,c){var d;return(0,Dh.default)(this,e),d=o.call(this),d.cvParent=new Qe,d.logOp=new E({operationName:"SessionState",success:!0}).start(),d.sessionStateChangeLogCountLimiter=new eo("SessionState"),d.stats=t,d.allStates=(0,ra.default)((0,ra.default)((0,ra.default)((0,ra.default)({},De.Initing,new eh((0,or.default)(d))),De.Running,new th((0,or.default)(d))),De.Disconnected,new nh((0,or.default)(d))),De.Closed,new rh((0,or.default)(d))),d.setState(De.Initing),d.messageEndpoint=new Fo({messageIdPrefix:"c",responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}),d.messageEndpoint.setClientMetadata(u),d.messageEndpoint.setEgress(d.egress.bind((0,or.default)(d))),d.messageEndpoint.onMessage(Je.getTypeName(),function(p,g){d.onSessionCloseMessage(p,g)}),d.networkWorkerManager=new na(r,u,a,s,d.ingress.bind((0,or.default)(d)),d.messageEndpoint.queryEgressCacheSize.bind(d.messageEndpoint),d.onConnectionClose.bind((0,or.default)(d)),function(){d.onSessionClose(void 0,"WSNotSupported")},f,c),d.messageQueue=new Kg({sendMessage:function(g,k,S,x){return d.state.sendMessage(g,k,S,x)},sendBytes:d.sendBytes.bind((0,or.default)(d)),canSendMessage:function(){return d.state.canSendMessage()}}),s.on("connect",function(p,g,k,S,x,C,T){d.setState(De.Running,"",{isSessionReseedingStarted:p&&g}),d.emit("connect",p,k,S,x,C,T)}),s.on("reconnect",function(){return d.emit("reconnect")}),s.on("serverAuthenticationStateChange",function(p){return d.emit("serverAuthenticationStateChange",p)}),d.resetNextSyncSequenceId=function(){return d.emit("resetNextSyncSequenceId")},d.tokenRefreshManager=l,d}return(0,Ph.default)(e,[{key:"setState",value:function(t,a,s){var u=this;if(!(this.state&&t===this.state.stateName)){var l=this.state?De[this.state.stateName]:"undefined",f=this.state?this.state.possibleNextStates.indexOf(t)>=0:t===De.Initing;this.sessionStateChangeLogCountLimiter.log(function(){u.logOp.stop(),u.logOp.resourceId=`New state: ${f?De[t]:l}`,u.logOp.resultDescription=`Previous state: ${l}`,u.logOp.dimension0=`Attempted state: ${De[t]||"undefined"}`,u.logOp.resultSignature=a+(u.state&&!f?"Unexpected state change":""),u.logOp.success=f,m.info(508843791,v.CoreDefault,u.logOp)}),f&&(this.state=this.allStates[t],this.logOp.start(),this.state.onEnter(s))}}},{key:"init",value:function(t,a){return this.extensionConfigs=t,this.customInitPromise=a,this.networkWorkerManager.init(this.extensionConfigs,this.customInitPromise,!0)}},{key:"sendMessage",value:function(t,a,s){this.retrySendMessage(t,a,e.maxRetries,s)}},{key:"sendBytes",value:function(t){this.state.sendBytes(t)}},{key:"onMessage",value:function(t,a){this.messageEndpoint.onMessage(t,a)}},{key:"getCorrelationVector",value:function(){return this.cvParent}},{key:"forceReconnect",value:function(t){var a=this;return this.extensionConfigs=t||this.extensionConfigs,this.networkWorkerManager.close(!1),new Promise(function(s){return setTimeout(function(){s(a.networkWorkerManager.init(a.extensionConfigs))},100)})}},{key:"closeSession",value:function(t){this.sendMessage(new Je),this.networkWorkerManager.close(!0);var a=t||new Fi({reasonDescription:"ClientRequested"});this.onSessionClose(new Je({reconnectAllowed:!1,reason:a}),"ClientRequested")}},{key:"ingress",value:function(t,a){var s=this,u;try{u=JSON.parse(t)}catch(c){m.error(508843790,v.CoreDefault,new E({operationName:"ProcessMessage",resourceId:"Unknown",success:!1,resultSignature:"ParseError",resultDescription:c.message,durationMs:0}))}if(u){if(a&&Fe.typeGuard(u)&&a(u),this.networkWorkerManager.getNetworkMode()===be.HttpFallback&&er.typeGuard(u)){var l=u;if(l.batch)for(var f of l.batch)this.messageEndpoint.ingress(f,function(c,d){return s.egress(c||d,function(){})});return}this.messageEndpoint.ingress(u,function(c,d){return s.egress(c||d,function(){})})}}},{key:"egress",value:function(t,a,s){t&&this.networkWorkerManager.egress(t,s).then(function(){return a()}).catch(function(u){return a(u)})}},{key:"onSessionCloseMessage",value:function(t,a){t.reconnectAllowed?this.networkWorkerManager.close():this.onSessionClose(t,"CloseMessageReceived"),a()}},{key:"onSessionClose",value:function(t,a){this.setState(De.Closed,a),this.tokenRefreshManager.clearAllTimeouts(),this.onConnectionClose(void 0),t&&this.emit("sessionClose",t)}},{key:"onConnectionClose",value:function(t){this.state.onConnectionClose(),this.stats.lastConnectionClose=me.getCurrentTimeMs(),this.emit("disconnect",t)}},{key:"retrySendMessage",value:function(t,a,s,u){var l=this,f=e.maxRetries-s;this.state.sendMessage(t,function(c,d){c&&s>0&&l.canBeRetried(t)&&l.isTransientError(c)?(l.retrySendMessage(t,a,s-1,u),y.matchesTypesFor(c,[Li.getTypeName()])&&l.networkWorkerManager.onRateLimitErrorResponse(c)):a&&a(c,d)},f,u)}},{key:"canBeRetried",value:function(t){return!y.matchesTypesFor(t,[gt.getTypeName(),tr.getTypeName()])}},{key:"isTransientError",value:function(t){var a=t.error;return a!==Wt.SyncMessageUnsupportedBatch&&a!==Wt.UnexpectedSeedMessage&&a!==Wt.UnsupportedSyncMessage&&a!==Wt.AnnotationTokenNotFound&&a!==Bn.ArrivedBeforeReseeding&&a!==Bn.DroppedAsOldestInQueue&&a!==Bn.DroppedBecauseClientDisconnected}}]),e}(Wh.EventEmitter);nf.maxRetries=2;h();var ko=w(Se()),br=w(at()),tS=w(R()),nS=w(B());h();var Oh=w(R()),Lh=w(B());var rf=function(){function n(o,e,r){(0,Oh.default)(this,n),this.sendMessage=o,this.annotationType=e,this.options=r,this.token=`${e}-${n.nextActivationResultBatchId++}`}return(0,Lh.default)(n,[{key:"activate",value:function(e,r){var t=this;return new Promise(function(a,s){t.sendMessage(new fn({annotationType:t.annotationType,token:t.token,config:t.options?t.options.config:void 0,ignoreExistingAnnotations:e,sendStateUpdates:t.options?!!t.options.stateUpdateCallback:void 0,forceReturnCachedAnnotations:t.options?t.options.forceReturnCachedAnnotations:void 0}),function(u,l){u?s(new Error(u.error)):a({token:t.token})},r)})}},{key:"release",value:function(){var e=this;return new Promise(function(r,t){e.sendMessage(new jr({token:e.token}),function(a,s){a?t(new Error(a.error)):r(s.lastRelease)})})}}]),n}();rf.nextActivationResultBatchId=1;h();var ir=function(o,e){var r=[];for(var t of o!=null?o:[])if(!(e!==void 0&&e!==t.cardinality))for(var a of t.contextTypes)r.push([a,t.cardinality,t.producerWaitPolicy]);return r},Fh=function(o){var e=[];for(var r of o!=null?o:[])(r.cardinality===Sr.Required||r.producerWaitPolicy===bo.Always)&&(e=e.concat(r.contextTypes));return e};h();h();var lt=w(Se()),Jm=w(R()),jm=w(B()),Km=w(ze()),Xm=w(Ve()),hc=w(Oe());h();h();var uf=w(R()),lf=w(B());h();var om=w(R()),im=w(B());var ve={};Hx(ve,{ChangeGate:()=>Q,DataListener:()=>oo,ModuleSettings:()=>UI,Setting:()=>xr,SettingInstance:()=>G,SettingInstanceCollection:()=>af,SettingPatternInstance:()=>$I,SettingsRegistry:()=>jh,TestSettingsProvider:()=>VI});h();h();h();var ia=w(ys()),ks=w(R()),ws=w(B()),Ss=w(ze()),Uh=w(Ve()),io=w(Oe()),Hh=w(ji());h();var $h=w(R()),Gh=w(B()),oo=function(){function n(){(0,$h.default)(this,n),this.listeners=new Map,this.lastId=0}return(0,Gh.default)(n,[{key:"addListener",value:function(e){if(!e)throw new Error("No callback provided for data listener");return this.listeners.set(this.lastId,e),this.lastId++}},{key:"removeListener",value:function(e){this.listeners.delete(e)}},{key:"notifyListeners",value:function(e){this.listeners.forEach(function(r){r(e)})}}]),n}();function of(n){var o=qI();return function(){var r=(0,io.default)(n),t;if(o){var a=(0,io.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Uh.default)(this,t)}}function qI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var xr=function(n){(0,Ss.default)(e,n);var o=of(e);function e(r){var t;return(0,ks.default)(this,e),t=o.call(this),t.name=r,t}return(0,ws.default)(e,[{key:"getName",value:function(){return this.name}},{key:"getValue",value:function(){return this.value}},{key:"updateValue",value:function(t){return(0,Hh.default)(this.value,t)?!1:(m.info(572837968,v.CoreDefault,`Received new property value for ${this.getName()}:`,t),this.value=t,!0)}}],[{key:"getInstance",value:function(t){var a=this.allSettings.get(t);if(!a){a=new e(t);var s=e.tryGetConfigProperty(e.currentConfig,t);s.success&&a.updateValue(s.value),this.allSettings.set(t,a)}return a}},{key:"getPatternInstance",value:function(t){var a=this.allPatternSettings.get(t);if(!a){a={regex:new RegExp(t),setting:new e(t)};var s=e.tryGetConfigPropertyByPattern(e.currentConfig,a.regex);a.setting.updateValue(s),this.allPatternSettings.set(t,a)}return a.setting}},{key:"setNewConfig",value:function(t){e.currentConfig=t,m.info(572837966,v.CoreDefault,`New config: ${JSON.stringify(t)}`),e.allSettings.forEach(function(a,s){var u=e.tryGetConfigProperty(e.currentConfig,s).value;a.updateValue(u)&&(m.info(572837967,v.CoreDefault,`Setting new value for ${s}: ${u instanceof Object?JSON.stringify(u):u}`),a.notifyListeners(u))}),e.allPatternSettings.forEach(function(a,s){var u=e.tryGetConfigPropertyByPattern(t,a.regex);a.setting.updateValue(u)&&(m.info(508432774,v.CoreDefault,`Setting new value for pattern ${s}: ${JSON.stringify(u)}`),a.setting.notifyListeners(u))})}},{key:"tryGetConfigProperty",value:function(t,a){return t&&t.hasOwnProperty(a)?{success:!0,value:e.selectApplicableValue(t[a])}:{success:!1,value:void 0}}},{key:"tryGetConfigPropertyByPattern",value:function(t,a){var s=[];if(t){var u=Object.getOwnPropertyNames(t).filter(function(f){return a.test(f)});for(var l of u)s.push({name:l,value:e.selectApplicableValue(t[l])})}return s}},{key:"setGlobalFilter",value:function(t){e.globalFilter=t}},{key:"clear",value:function(){e.currentConfig=void 0,e.allSettings.clear(),e.allPatternSettings.clear()}},{key:"selectApplicableValue",value:function(t){var a;if(t){var s=t.find(function(u){return!e.globalFilter||e.globalFilter(u)});s&&(a=s.value)}return a}}]),e}(oo);xr.allSettings=new Map;xr.allPatternSettings=new Map;var G=function(n){(0,Ss.default)(e,n);var o=of(e);function e(r,t){var a;return(0,ks.default)(this,e),a=o.call(this),a.listenerId=NaN,a.defaultValue=t,a.setting=xr.getInstance(r),a}return(0,ws.default)(e,[{key:"getDefaultValue",value:function(){return this.defaultValue}},{key:"addListener",value:function(t){var a=this;return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(function(){a.notifyListeners(a.getValue())})),(0,ia.default)((0,io.default)(e.prototype),"addListener",this).call(this,t)}},{key:"removeListener",value:function(t){(0,ia.default)((0,io.default)(e.prototype),"removeListener",this).call(this,t),this.listeners.size==0&&!Number.isNaN(this.listenerId)&&(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}},{key:"getValue",value:function(){var t=this.setting.getValue();return t===void 0?this.defaultValue:t}}]),e}(oo),$I=function(n){(0,Ss.default)(e,n);var o=of(e);function e(r){var t;return(0,ks.default)(this,e),t=o.call(this),t.listenerId=NaN,t.setting=xr.getPatternInstance(r),t}return(0,ws.default)(e,[{key:"addListener",value:function(t){var a=this;return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(function(){a.notifyListeners(a.getValue())})),(0,ia.default)((0,io.default)(e.prototype),"addListener",this).call(this,t)}},{key:"removeListener",value:function(t){(0,ia.default)((0,io.default)(e.prototype),"removeListener",this).call(this,t),this.listeners.size==0&&!Number.isNaN(this.listenerId)&&(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}},{key:"getValue",value:function(){var t=this.setting.getValue();return t===void 0?[]:t}}]),e}(oo);var GI=new G("disabledChangeGates",[]),Q=function(o,e){var r=GI.getValue().indexOf(o)===-1;if(!e)return r;if(r){for(var t=arguments.length,a=new Array(t>2?t-2:0),s=2;s<t;s++)a[s-2]=arguments[s];return e.apply(void 0,a)}};h();var zh=w(R()),Vh=w(B());var UI=function(){function n(o,e){(0,zh.default)(this,n),this.moduleName=o!=null?o:"",this.moduleVersion=e!=null?e:""}return(0,Vh.default)(n,[{key:"getInstance",value:function(e,r){return new G(`${this.moduleName}.${e}`,r)}}]),n}();h();var Qh=w(R()),Jh=w(B());var jh=function(){function n(){(0,Qh.default)(this,n)}return(0,Jh.default)(n,null,[{key:"addProvider",value:function(e){var r=e.addListener(function(){m.info(572837969,v.CoreDefault,`Received new settings from ${e.constructor.name}`),n.currentConfig=n.buildConfig(),xr.setNewConfig(n.currentConfig)});n.providers.push({provider:e,listenerId:r}),n.currentConfig=n.buildConfig(),xr.setNewConfig(n.currentConfig)}},{key:"getCurrentConfig",value:function(){return n.currentConfig}},{key:"clear",value:function(){n.currentConfig=void 0,n.providers.forEach(function(e){e.provider.removeListener(e.listenerId)}),n.providers=[]}},{key:"buildConfig",value:function(){var e={};for(var r of n.providers){var t=r.provider.getSettings()||{};e=Object.assign(e,t)}return e}}]),n}();jh.providers=[];h();var Kh=w(R()),Xh=w(B());var af=function(){function n(o,e){(0,Kh.default)(this,n),this.prefix=o,this.defaultValue=e,this.settingInstances=new Map}return(0,Xh.default)(n,[{key:"getSettingInstance",value:function(e){var r=`${this.prefix}${e}`,t=this.settingInstances.get(r);return t===void 0&&(t=new G(r,this.defaultValue),this.settingInstances.set(r,t)),t}}]),n}();yn(ve,w(Zh()));h();var em=w(R()),tm=w(B()),nm=w(ze()),rm=w(Ve()),sf=w(Oe());function HI(n){var o=zI();return function(){var r=(0,sf.default)(n),t;if(o){var a=(0,sf.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,rm.default)(this,t)}}function zI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var VI=function(n){(0,nm.default)(e,n);var o=HI(e);function e(r){var t;return(0,em.default)(this,e),t=o.call(this),t.currentSettings=r,t}return(0,tm.default)(e,[{key:"setSettings",value:function(t){this.currentSettings=t,this.notifyListeners(t)}},{key:"getSettings",value:function(){return this.currentSettings}}]),e}(oo);var QI=new G("performanceEventExpirationTimeMs",1e4),am=function(){function n(){(0,om.default)(this,n),this.pendingEvents=[]}return(0,im.default)(n,[{key:"add",value:function(e){this.pendingEvents.push(e),this.runTimeout()}},{key:"runTimeout",value:function(){var e=this;this.timer||this.pendingEvents.length===0||(this.timer=setTimeout(function(){e.logFinishedEvents(),e.timer=void 0,e.runTimeout()},500),this.timer.unref&&this.timer.unref())}},{key:"calculateSyncDuration",value:function(e){var r,t=0;if(e.sync)t+=(r=e.durationMs)!==null&&r!==void 0?r:0;else for(var a of e.children)t+=this.calculateSyncDuration(a);return t}},{key:"logFinishedEvents",value:function(){for(var e=this,r=Date.now(),t=0,a=[],s=function(){var l=e.pendingEvents[t];if(r-l.lastActivityTimeMs<QI.getValue())return a.push(l),1;Le(function(){var f=new E;f.operationName="PerformanceMeasurement",f.resourceId=l.rootScope.name,f.resultJSON=JSON.stringify(l.toLoggable()),f.success=!0,f.stop(),f.durationMs=Math.round(e.calculateSyncDuration(l.rootScope));var c=st(),d=c.performanceEvent;c.performanceEvent=void 0,m.info(521417348,v.CoreDefault,f),c.performanceEvent=d},l.cc)};t<this.pendingEvents.length;t++)s();this.pendingEvents=a}}],[{key:"getInstance",value:function(){return this.instance||(this.instance=new n),this.instance}}]),n}();var kW=new G("loggedPerformanceEventsPercentage",0);function sm(){m.setStartPerformanceEventCallback(function(n){var o=V();return o.startSync(n)}),m.setStopPerformanceEventCallback(function(n){V().stop(n)})}sm();var JI=function(){function n(){(0,uf.default)(this,n)}return(0,lf.default)(n,[{key:"start",value:function(e,r){return ao}},{key:"startSync",value:function(e,r){return ao}},{key:"startAsync",value:function(e,r){return ao}},{key:"stop",value:function(e){}},{key:"remove",value:function(e){}},{key:"stopCurrentScope",value:function(){}},{key:"stopCurrentEvent",value:function(){}},{key:"resume",value:function(e){}},{key:"startBranch",value:function(e,r,t){return{event:ao,performanceEvent:Cs}}},{key:"switchToScope",value:function(e){}},{key:"switchToParentScope",value:function(){}},{key:"switchToRootScope",value:function(){}},{key:"markForLogging",value:function(){}},{key:"find",value:function(e){return ao}}]),n}(),ao={name:"Dummy",startTimeMs:0,activeEventsNumber:0,status:Bt.Active},Cs=new JI;Cs.rootScope=ao;Cs.currentScope=ao;var so;(function(n){n[n.None=0]="None",n[n.WentDown=1]="WentDown",n[n.WentUp=2]="WentUp"})(so||(so={}));function V(n){return jI.getCurrent(n)||Cs}var jI=function(){function n(){(0,uf.default)(this,n),this.markedForLogging={value:!1},this.activeSyncEvents=new Set,this.notFoundEventNames=new Set}return(0,lf.default)(n,[{key:"resume",value:function(e){var r,t;this.lastActivityTimeMs=Date.now();var a;typeof e=="string"?a=(t=(r=this.currentScope)===null||r===void 0?void 0:r.children)===null||t===void 0?void 0:t.find(function(s){return s.name===e}):a=e,a&&this.resumeInternal(a)&&(this.currentScope=a.parent,a.sync&&this.activeSyncEvents.add(a))}},{key:"start",value:function(e,r){return this.startInternal(e,void 0,r)}},{key:"startAsync",value:function(e,r){return this.startInternal(e,!1,r)}},{key:"startSync",value:function(e,r){return this.startInternal(e,!0,r)}},{key:"stop",value:function(e){var r,t,a;this.lastActivityTimeMs=Date.now();var s=Kt(),u;if(typeof e=="string"?((r=this.currentScope)===null||r===void 0?void 0:r.name)===e?u=this.currentScope:u=(t=this.currentScope)===null||t===void 0?void 0:t.children.find(function(f){return f.name===e}):u=e,!!u){if(u.activeEventsNumber?u.stopRequested=!0:(this.pause(u,s),u.status=Bt.Stopped,u.parent&&u.parent.stopRequested&&u.parent.activeEventsNumber===0&&(this.stop(u.parent),u.parent.stopRequested=!1)),u.sync&&u.parent.neighbourScopeActiveSyncEvents)for(var l of u.parent.neighbourScopeActiveSyncEvents)l.status===Bt.Paused&&(this.resumeInternal(l),l.pausedByNeighbour=!1);this.currentScope=(a=u.initialScope)!==null&&a!==void 0?a:u.parent,u.sync&&this.activeSyncEvents.delete(u)}}},{key:"remove",value:function(e){var r;this.lastActivityTimeMs=Date.now(),(r=e==null?void 0:e.parent)===null||r===void 0||r.children.splice(e.parent.children.indexOf(e),1)}},{key:"stopCurrentScope",value:function(){this.stop(this.currentScope)}},{key:"stopCurrentEvent",value:function(){this.currentScope.children.length>0&&this.stop(this.currentScope.children[this.currentScope.children.length-1])}},{key:"startBranch",value:function(e,r,t){return this.startBranchInternal(e,r,void 0,t)}},{key:"switchToScope",value:function(e){this.currentScope=e}},{key:"switchToParentScope",value:function(){var e;this.currentScope=(e=this.currentScope)===null||e===void 0?void 0:e.parent}},{key:"switchToRootScope",value:function(){this.currentScope=this.rootScope}},{key:"markForLogging",value:function(){this.markedForLogging.value||(this.markedForLogging.value=!0,am.getInstance().add(this))}},{key:"toLoggable",value:function(){var e={events:{},summary:{syncDurationMs:0,asyncDurationMs:0,eventDurations:{}}};return e.events[this.rootScope.name]=this.mapEventToLoggable(this.rootScope),this.notFoundEventNames.size>0&&(e.summary.notFoundEventNames=Array.from(this.notFoundEventNames)),this.fillSummary(e.summary,this.rootScope),e}},{key:"find",value:function(e){var r=this.findInternal(e);return r||this.notFoundEventNames.add(e),r}},{key:"pauseActiveSyncEvents",value:function(){var e=Kt();for(var r of this.activeSyncEvents)this.pause(r,e)}},{key:"resumeActiveSyncEvents",value:function(){for(var e of this.activeSyncEvents)!e.pausedByNeighbour&&e.status===Bt.Paused&&e.performanceEvent===this&&this.resumeInternal(e)}},{key:"resumeInternal",value:function(e,r){if(e&&(e.status!==Bt.Active||r)){if(e.parent&&e.parent.activeEventsNumber++,e.startTimeMs=Kt(),e.status=Bt.Active,e.sync&&e.parent.neighbourScopeActiveSyncEvents){var t=Kt();for(var a of e.parent.neighbourScopeActiveSyncEvents)a.status===Bt.Active&&(this.pause(a,t),a.pausedByNeighbour=!0)}return!0}return!1}},{key:"startInternal",value:function(e,r,t){this.lastActivityTimeMs=Date.now();var a=this.currentScope,s=this.switchScope(r),u=this.findOrCreateEvent(e,r,t);return u.event.performanceEvent=this,this.onEventStarted(u.event,a,u.created,s),u.event}},{key:"startBranchInternal",value:function(e,r,t,a){var s=this.currentScope,u=this.switchScope(t),l=this.createEvent(e,t,a);this.onEventStarted(l,s,!0,u),this.currentScope=l;var f=new n;return f.rootScope=this.rootScope,f.currentScope=this.currentScope,f.cc=r,f.markedForLogging=this.markedForLogging,f.activeSyncEvents=this.activeSyncEvents,f.notFoundEventNames=this.notFoundEventNames,l.performanceEvent=f,r.performanceEvent=f,this.currentScope=s,{event:l,performanceEvent:f}}},{key:"onEventStarted",value:function(e,r,t,a){var s;this.lastActivityTimeMs=Date.now(),a.scopeChange!==so.None&&(e.initialScope=r),e.neighbourScopeActiveSyncEvents=a.neighbourScopeActiveSyncEvents,t?(e.parent=this.currentScope,(s=this.currentScope)===null||s===void 0||s.children.push(e)):e.status!==Bt.Active&&(e.count=e.count?e.count+1:2,e.startTimeMs=Kt(),e.status=Bt.Active),this.resumeInternal(e,!0),e.sync&&this.activeSyncEvents.add(e)}},{key:"pause",value:function(e,r){var t;e.status===Bt.Active&&(e.durationMs=((t=e.durationMs)!==null&&t!==void 0?t:0)+(r-e.startTimeMs),e.startTimeMs=void 0,e.parent&&e.parent.activeEventsNumber--,e.status=Bt.Paused)}},{key:"findInternal",value:function(e){var r,t;return(t=(r=this.currentScope)===null||r===void 0?void 0:r.children)===null||t===void 0?void 0:t.find(function(a){return a.name===e})}},{key:"switchScope",value:function(e){for(var r,t={scopeChange:so.None},a,s=this.currentScope.children.length-1;s>=0;s--){var u=this.currentScope.children[s];if(u.startTimeMs!==void 0&&u.performanceEvent===this){if(e===!0&&u.sync!==!1||e!==!0&&u.sync===void 0)return this.currentScope=u,{scopeChange:so.WentDown};a=u}}if(e===!1)for(;!((r=this.currentScope)===null||r===void 0)&&r.sync;)this.currentScope=this.currentScope.parent,t.scopeChange=so.WentUp;else if(e===void 0){var l=this.currentScope;for(a!=null&&a.sync&&(t.neighbourScopeActiveSyncEvents=new Set([a]));l.sync!==void 0;)l.sync===!0&&l.startTimeMs!==void 0&&(t.neighbourScopeActiveSyncEvents||(t.neighbourScopeActiveSyncEvents=new Set),t.neighbourScopeActiveSyncEvents.add(l)),l=l.parent,t.scopeChange=so.WentUp;this.currentScope=l}return t}},{key:"mergeEvents",value:function(e,r){var t,a,s,u;e.count=((t=e.count)!==null&&t!==void 0?t:1)+((a=r.count)!==null&&a!==void 0?a:1),e.durationMs=((s=e.durationMs)!==null&&s!==void 0?s:0)+((u=r.durationMs)!==null&&u!==void 0?u:0),r.children.length>0&&e.children===void 0&&(e.children={});for(var l of r.children)e.children[l.name]?this.mergeEvents(e.children[l.name],l):e.children[l.name]=this.mapEventToLoggable(l)}},{key:"fillSummary",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},a,s,u,l;r.sync&&((a=r.parent)===null||a===void 0?void 0:a.sync)!==!0?e.syncDurationMs+=(s=r.durationMs)!==null&&s!==void 0?s:0:r.sync===!1&&(e.asyncDurationMs+=(u=r.durationMs)!==null&&u!==void 0?u:0),e.eventDurations[r.name]===void 0&&(e.eventDurations[r.name]={sync:r.sync,durationMs:0}),t[r.name]===1&&(e.eventDurations[r.name].durationMs+=(l=r.durationMs)!==null&&l!==void 0?l:0);for(var f of r.children)t[f.name]=t[f.name]?t[f.name]+1:1,this.fillSummary(e,f,t),t[f.name]--}},{key:"mapEventToLoggable",value:function(e){var r=Object.assign({},e);if(r.parent=void 0,r.startTimeMs=void 0,r.initialScope=void 0,r.name=void 0,r.neighbourScopeActiveSyncEvents=void 0,r.perfEvent=void 0,r.pausedByNeighbour=void 0,r.performanceEvent=void 0,r.activeEventsNumber=void 0,r.stopRequested=void 0,r.status=void 0,r.children.length>0){r.children={};var t=0;for(var a of e.children)if(r.children[a.name])this.mergeEvents(r.children[a.name],a);else{var s=this.mapEventToLoggable(a);e.children.length>1&&(s.order=t++),r.children[a.name]=s}}else r.children=void 0;return r}},{key:"createEvent",value:function(e,r,t){var a={name:e,sync:r,startTimeMs:Kt(),children:[],activeEventsNumber:0,status:Bt.Active};return t&&(a=Object.assign(a,t)),a}},{key:"findOrCreateEvent",value:function(e,r,t){var a=this.findInternal(e),s=a===void 0||a.startTimeMs!==void 0;return s?a=this.createEvent(e,r,t):t&&Object.assign(a,t),{event:a,created:s}}}],[{key:"getCurrent",value:function(e){var r;return(r=e!=null?e:st())===null||r===void 0?void 0:r.performanceEvent}},{key:"create",value:function(e,r){var t=st(),a=new n;return a.rootScope=a.findOrCreateEvent(e,void 0,r).event,a.currentScope=a.rootScope,a.cc=t,a.lastActivityTimeMs=Date.now(),t.performanceEvent=a,t.performanceEvent}}]),n}();h();var um=w(R()),lm=w(B());var Tn=function(){function n(o){(0,um.default)(this,n),y.assign(n,this,o)}return(0,lm.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Voice_VoiceOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Tn.H_={T_:Tn.getTypeName(),B_:Tn.getBaseTypes()};var Ym=w(Rn());h();var fm=w(B()),cm=w(R()),dm=w(ze()),pm=w(Ve()),ff=w(Oe()),gm=w(ol());function KI(n){var o=XI();return function(){var r=(0,ff.default)(n),t;if(o){var a=(0,ff.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,pm.default)(this,t)}}function XI(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var uo=function(n){(0,dm.default)(e,n);var o=KI(e);function e(r){var t;return(0,cm.default)(this,e),t=o.call(this,r),t.__proto__=e.prototype,t}return(0,fm.default)(e)}((0,gm.default)(Error));h();var cf=w(Se()),vm=w(at()),ym=w(R()),km=w(B());h();var In;(function(n){n.ApplyOperations="ApplyOperations",n.GetModelSubTreeItems="Model.GetSubTreeItems",n.EmitEvents="EmitEvents",n.InvokeSynchronousEvents="InvokeSynchronousEvents",n.UpdateModelItems="Model.UpdateItems",n.GetModelItemChildren="Model.GetItemChildren"})(In||(In={}));h();var Yt="\\",YI=100,it=function(o,e){return Object.assign(Object.assign({},e),{parentPath:o})},H=function(o){return Array.isArray(o)?o.length===5?`${o[0]}${Yt}${o[1]}${Yt}${o[2]}${Yt}${o[3]}${Yt}${o[4]}`:o.length===4?`${o[0]}${Yt}${o[1]}${Yt}${o[2]}${Yt}${o[3]}`:o.length===3?`${o[0]}${Yt}${o[1]}${Yt}${o[2]}`:o.length===2?`${o[0]}${Yt}${o[1]}`:o.length===1?o[0]:o.join(Yt):"(malformed path)"},hm=function(o,e){if(o.length!==e.length)return!1;for(var r=0;r<o.length;r++)if(o[r]!==e[r])return!1;return!0},Wn=function(o){return o.split(Yt)},mm=function(o){return o&&o.length>0&&o.length<YI&&o.indexOf(Yt)<0},aa=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return Number.isFinite(o)?o:e},ar=function(o,e){if(o.length>e.length)return!1;for(var r=0;r<o.length;r++)if(o[r]!==e[r])return!1;return!0};var xs=function(){function n(){(0,ym.default)(this,n),this.singleItemListeners=new Map}return(0,km.default)(n,[{key:"onItemChange",value:function(e,r,t,a){var s=this.singleItemListeners.get(e);s||(s=[],this.singleItemListeners.set(e,s)),s.push({itemType:e,inputStage:r,callback:t,synchronousCallbackRequired:a})}},{key:"emitEvents",value:function(e,r){var t=this,a=V(),s=a.startSync(In.EmitEvents),u=[],l=[],f=new Map,c=function(_){m.debug(572837896,v.CoreDefault,function(){return`Triggering notifications for ${y.getTypeNameFor(_)}`});var M=function(N){if(!N.body)return 1;var z=function(P){var D=t.singleItemListeners.get(P);for(var O of D||[]){if(r!==void 0&&r<1&&!(O.inputStage&Ut.PreSeed)){m.debug(572837897,v.CoreDefault,function(){return`Suppressing item listener callback for item type ${P} on ${H([].concat((0,cf.default)(_.parentPath),[N.id]))} on a seeded item.`});continue}m.debug(572837898,v.CoreDefault,function(){return`Invoking item listener callback for item type ${P} on ${H([].concat((0,cf.default)(_.parentPath),[N.id]))}`});var $=Object.assign(Object.assign({},_),{items:[N]}),F=f.get(O);F||(F=[],f.set(O,F)),F.push($)}};for(var L of y.getAllTypesFor(N.body))z(L)};for(var A of _.items)M(A)};for(var d of e)c(d);var p=function(_,M){_.synchronousCallbackRequired?l.push(function(){return _.callback(M)}):u.push(function(){return _.callback(M)})};for(var g of f.entries()){var k=(0,vm.default)(g,2),S=k[0],x=k[1];p(S,x)}var C=function(_){var M=function(N){try{Cn(function(){N()})}catch(z){m.error(572837899,v.CoreDefault,`Item listener callback failed: ${z.message}`)}};for(var A of _)M(A)};if(l.length>0){a.stop(s);var T=a.start(In.InvokeSynchronousEvents);C(l),a.stop(T),a.resume(s)}u.length>0&&setTimeout(function(){return C(u)},0),a.stop(s)}}]),n}();h();var he;(function(n){n[n.Add=0]="Add",n[n.Delete=1]="Delete",n[n.Update=2]="Update",n[n.CursorUpdate=3]="CursorUpdate",n[n.FormattingUpdate=4]="FormattingUpdate",n[n.OtherNonContentUpdate=5]="OtherNonContentUpdate"})(he||(he={}));var je;(function(n){n[n.Chars=0]="Chars",n[n.Word=1]="Word",n[n.PartialSentence=2]="PartialSentence",n[n.Sentence=3]="Sentence",n[n.Paragraph=4]="Paragraph"})(je||(je={}));var wm;(function(n){n[n.SessionUser=0]="SessionUser",n[n.Programmatic=1]="Programmatic",n[n.Collaborator=2]="Collaborator"})(wm||(wm={}));h();var Sm;(function(n){n[n.Unspecified=0]="Unspecified",n[n.Inline=1]="Inline",n[n.Floating=2]="Floating"})(Sm||(Sm={}));var Ts;(function(n){n[n.Undefined=0]="Undefined",n[n.Bullet=1]="Bullet",n[n.Numbered=2]="Numbered",n[n.Lim=3]="Lim",n[n.Nil=4]="Nil",n[n.Any=5]="Any",n[n.NoList=6]="NoList",n[n.Invalid=7]="Invalid"})(Ts||(Ts={}));var Cm;(function(n){n[n.DontCare=1]="DontCare",n[n.Thin=2]="Thin",n[n.ExtraLight=3]="ExtraLight",n[n.Light=4]="Light",n[n.Normal=5]="Normal",n[n.Medium=6]="Medium",n[n.SemiBold=7]="SemiBold",n[n.Bold=8]="Bold",n[n.ExtraBold=9]="ExtraBold",n[n.Heavy=10]="Heavy"})(Cm||(Cm={}));var xm;(function(n){n[n.NoCaps=0]="NoCaps",n[n.SmallCaps=1]="SmallCaps",n[n.AllCaps=2]="AllCaps",n[n.AllPetiteCaps=3]="AllPetiteCaps",n[n.PetiteCaps=4]="PetiteCaps",n[n.Unicase=5]="Unicase",n[n.Titling=6]="Titling",n[n.Other=7]="Other"})(xm||(xm={}));var Tm;(function(n){n[n.None=0]="None",n[n.Words=1]="Words",n[n.SingleLine=2]="SingleLine",n[n.DoubleLine=3]="DoubleLine",n[n.HeavyLine=4]="HeavyLine",n[n.DottedLine=5]="DottedLine",n[n.DottedHeavyLine=6]="DottedHeavyLine",n[n.DashLine=7]="DashLine",n[n.DashHeavyLine=8]="DashHeavyLine",n[n.DashLongLine=9]="DashLongLine",n[n.DashLongHeavyLine=10]="DashLongHeavyLine",n[n.DotDashLine=11]="DotDashLine",n[n.DotDashHeavyLine=12]="DotDashHeavyLine",n[n.DotDotDashLine=13]="DotDotDashLine",n[n.DotDotDashHeavyLine=14]="DotDotDashHeavyLine",n[n.WavyLine=15]="WavyLine",n[n.WavyHeavyLine=16]="WavyHeavyLine",n[n.WavyDoubleLine=17]="WavyDoubleLine"})(Tm||(Tm={}));var Im;(function(n){n[n.Left=0]="Left",n[n.Right=1]="Right",n[n.Center=2]="Center",n[n.Justified=3]="Justified",n[n.Other=4]="Other",n[n.None=5]="None",n[n.JustifyLow=6]="JustifyLow",n[n.Distributed=7]="Distributed",n[n.ThaiDistributed=8]="ThaiDistributed"})(Im||(Im={}));var _m;(function(n){n[n.Image=0]="Image",n[n.TextBox=1]="TextBox",n[n.Chart=2]="Chart",n[n.SmartArt=3]="SmartArt",n[n.Drawing=4]="Drawing",n[n.EquationObject=5]="EquationObject",n[n.Ink=6]="Ink",n[n.InkSpace=7]="InkSpace",n[n.InkEndOfLine=8]="InkEndOfLine",n[n.LineBreak=9]="LineBreak",n[n.PageBreak=10]="PageBreak",n[n.PageNumbers=11]="PageNumbers",n[n.FootnoteEndnote=12]="FootnoteEndnote",n[n.FootnoteEndnoteReferenceMark=13]="FootnoteEndnoteReferenceMark",n[n.Tab=14]="Tab",n[n.UnsupportedObject=15]="UnsupportedObject",n[n.Other=16]="Other",n[n.Person=17]="Person",n[n.Date=18]="Date"})(_m||(_m={}));var Am;(function(n){n[n.Initial=0]="Initial",n[n.FirstLine=1]="FirstLine",n[n.Hanging=2]="Hanging"})(Am||(Am={}));h();var Tt=w(R()),It=w(B());var df=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_RangeAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();df.H_={T_:df.getTypeName(),B_:df.getBaseTypes()};var pf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_MultiTileRangeAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();pf.H_={T_:pf.getTypeName(),B_:pf.getBaseTypes()};var gf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageDetectionSummaryAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();gf.H_={T_:gf.getTypeName(),B_:gf.getBaseTypes()};var hf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();hf.H_={T_:hf.getTypeName(),B_:hf.getBaseTypes()};var mf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageCountAnnotationLocalized"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_LanguageCountAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();mf.H_={T_:mf.getTypeName(),B_:mf.getBaseTypes()};var vf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_Definition"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();vf.H_={T_:vf.getTypeName(),B_:vf.getBaseTypes()};var yf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_SuggestionsAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();yf.H_={T_:yf.getTypeName(),B_:yf.getBaseTypes()};var kf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_Critique"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();kf.H_={T_:kf.getTypeName(),B_:kf.getBaseTypes()};var wf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_NeuralRewriteCritique"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_Critique","AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();wf.H_={T_:wf.getTypeName(),B_:wf.getBaseTypes()};var Sf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_CritiqueCategoryCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Sf.H_={T_:Sf.getTypeName(),B_:Sf.getBaseTypes()};var lo=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_UniqueWordsCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();lo.H_={T_:lo.getTypeName(),B_:lo.getBaseTypes()};var Cf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_EmptyDocumentAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Cf.H_={T_:Cf.getTypeName(),B_:Cf.getBaseTypes()};var xf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_IdeasPersonalizationSettingsAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();xf.H_={T_:xf.getTypeName(),B_:xf.getBaseTypes()};var Tf=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_TextToSpeechAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Tf.H_={T_:Tf.getTypeName(),B_:Tf.getBaseTypes()};var If=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_AutoreplaceAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_Critique","AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();If.H_={T_:If.getTypeName(),B_:If.getBaseTypes()};var _f=function(){function n(o){(0,Tt.default)(this,n),y.assign(n,this,o)}return(0,It.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_TextStreamAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_StreamAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();_f.H_={T_:_f.getTypeName(),B_:_f.getBaseTypes()};h();var Af=w(R()),Mf=w(B());var sr=function(){function n(o){(0,Af.default)(this,n),y.assign(n,this,o)}return(0,Mf.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TextTileDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();sr.H_={T_:sr.getTypeName(),B_:sr.getBaseTypes()};var hn=function(){function n(o){(0,Af.default)(this,n),y.assign(n,this,o)}return(0,Mf.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_FormattedTextTileDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTileDelta","AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();hn.H_={T_:hn.getTypeName(),B_:hn.getBaseTypes()};h();var ur=w(R()),lr=w(B());var et=function(){function n(o){(0,ur.default)(this,n),y.assign(n,this,o)}return(0,lr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TextTile"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();et.H_={T_:et.getTypeName(),B_:et.getBaseTypes()};var ht=function(){function n(o){(0,ur.default)(this,n),y.assign(n,this,o)}return(0,lr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_FormattedTextTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ht.H_={T_:ht.getTypeName(),B_:ht.getBaseTypes()};var bf=function(){function n(o){(0,ur.default)(this,n),y.assign(n,this,o)}return(0,lr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_InlineTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();bf.H_={T_:bf.getTypeName(),B_:bf.getBaseTypes()};var Ef=function(){function n(o){(0,ur.default)(this,n),y.assign(n,this,o)}return(0,lr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_DynamicTextContext"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DynamicContext"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ef.H_={T_:Ef.getTypeName(),B_:Ef.getBaseTypes()};var Nf=function(){function n(o){(0,ur.default)(this,n),y.assign(n,this,o)}return(0,lr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TaskTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_FormattedTextTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Nf.H_={T_:Nf.getTypeName(),B_:Nf.getBaseTypes()};var Df=function(){function n(o){(0,ur.default)(this,n),y.assign(n,this,o)}return(0,lr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_PersonTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Df.H_={T_:Df.getTypeName(),B_:Df.getBaseTypes()};var Pf=function(){function n(o){(0,ur.default)(this,n),y.assign(n,this,o)}return(0,lr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_DateTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Pf.H_={T_:Pf.getTypeName(),B_:Pf.getBaseTypes()};var Rf=function(){function n(o){(0,ur.default)(this,n),y.assign(n,this,o)}return(0,lr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_LinkTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Rf.H_={T_:Rf.getTypeName(),B_:Rf.getBaseTypes()};h();var Mm=w(Se()),bm=w(R()),Em=w(B());var Nm=function(){function n(){(0,bm.default)(this,n)}return(0,Em.default)(n,[{key:"accumulate",value:function(e,r,t,a){var s=this;if(t===0){a(r,t);return}var u=0,l=0,f=Pe.getTypeName(),c=ke.getTypeName(),d=function(_){var M=y.getTypeNameFor(_);return M===f||M==c},p=Math.round(performance.now());p-=p%e.messageRateIntervalMs;var g=[];for(var k of r){var S=k.items.length===1&&d(k)&&!k.items[0].deltas,x=S?H([].concat((0,Mm.default)(k.parentPath),[k.items[0].id])):void 0,C=!this.lastUpdatedItem||this.lastUpdatedItem.itemPathKey!==x;if(l+=k.items.length,S){var T=C||this.lastUpdatedItem.intervalStartTime!==p?1:this.lastUpdatedItem.currentRate+1;this.lastUpdatedItem={itemPathKey:x,intervalStartTime:p,currentRate:T},u++}if(!S||C){this.accumulatedUpdate&&(m.info(508368717,v.CoreDefault,`Pushing accumulated item before the timeout due the pattern change. Seq = ${this.accumulatedUpdate.seq}`),this.accumulatedUpdate.seq===t?g.push(this.accumulatedUpdate.operation):this.accumulatedUpdate.callback([this.accumulatedUpdate.operation],this.accumulatedUpdate.seq),clearTimeout(this.accumulatedUpdate.timeout),this.accumulatedUpdate=void 0),g.push(k);continue}this.accumulatedUpdate===void 0?this.lastUpdatedItem.currentRate>e.maxRate?(m.info(508368716,v.CoreDefault,`Message rate of ${e.maxRate} messages per ${e.messageRateIntervalMs}ms is exceeded - starting to accumulate the changes for single-tile update with seq = ${t}.`),this.accumulatedUpdate={callback:a,operation:k,seq:t,timeout:setTimeout(function(){s.accumulatedUpdate.callback([s.accumulatedUpdate.operation],s.accumulatedUpdate.seq),s.accumulatedUpdate=void 0},e.accumulationTimeoutMs)}):g.push(k):(m.info(508368715,v.CoreDefault,`An item from the message with seq = ${t} will be sent to item listeners with delay as it's currently being accumulated due to exceeded single-tile update max rate`),this.accumulatedUpdate.operation.items=k.items,this.accumulatedUpdate.seq=t,this.accumulatedUpdate.callback=a)}Q("SingleItemUpdatesAccumulatorExtraLogging")&&m.info(508347408,v.CoreDefault,`operations.length: ${r.length}, singleTileOperations: ${u}, totalItemsCount: ${l}`),g.length&&a(g,t)}}]),n}();h();var cc=w(at()),dc=w(R()),pc=w(B());h();var ua=w(Se()),Bf=w(R()),Wf=w(B());h();var Rm=w(cs()),Bm=w(R()),Wm=w(B());h();var Dm=w(R()),Pm=w(B()),sa=function(){function n(o,e){if((0,Dm.default)(this,n),this.next=void 0,this.previous=void 0,e==null)throw Error("Argument id cannot be undefined or null.");this.item=o,this._id=e}return(0,Pm.default)(n,[{key:"id",get:function(){return this._id}}]),n}();var Is=function(n){function o(e,r){if((0,Bm.default)(this,o),this.fragmentsById=new Map,this.arrayOfFragmentHeads=[],this.checksEnabled=e||function(){return!0},Array.isArray(r))for(var t of r){var a=void 0;for(var s of t){var u=new sa(s.item,s.id);this.fragmentsById.set(u.id,u),a?(a.next=u,u.previous=a):this.arrayOfFragmentHeads.push(u),a=u}}}return(0,Wm.default)(o,[{key:n,value:function(){return this.makeIterator(!1)}},{key:"iterator",value:function(){var r=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return(0,Rm.default)({},Symbol.iterator,function(){return r.makeIterator(t)})}},{key:"hasItems",value:function(){if(this.arrayOfFragmentHeads.length===0)return!1;for(var r of this.fragmentsById.values())if(r.item)return!0;return!1}},{key:"getItemsWithIds",value:function(){var r,t=new Array(this.arrayOfFragmentHeads.length),a=0;for(var s of this.arrayOfFragmentHeads){for(var u=[],l=s,f=s==null?void 0:s.next;l;)u.push({item:l.item,id:l.id}),l=l.next,f=(r=f==null?void 0:f.next)===null||r===void 0?void 0:r.next,l&&l===f&&(m.error(512231009,v.CoreDefault,"FragList getItemsWithIds Cycle Detected"),l=void 0);t[a++]=u}return t}},{key:"getFragmentHeadIds",value:function(r){var t=[];for(var a of this.arrayOfFragmentHeads)r(a.id,a.item)&&t.push(a.id);return t}},{key:"isFragmented",value:function(){return this.arrayOfFragmentHeads.length>1}},{key:"addItem",value:function(r,t,a,s,u){this.addItems([r],[t],a,s,u)}},{key:"addItems",value:function(r,t,a,s,u){if(m.verbose(573871326,v.CoreDefault,function(){return`FragList: Adding ${t.toString()}`}),r.length===0){a(Me.AddOfZeroElements,"");return}if(r.length!==t.length)throw Error("Length of object array doesn't match length of id array.");this.checksEnabled()&&this.checkForSequentialInversion(t,a);var l=this.createFragmentList(r,t);this.removeAlreadyExistingStubFragments(l),this.addFragmentsToMap(l),this.innerAddItems(l,s,u),this.checkState()}},{key:"deleteItem",value:function(r,t){m.verbose(573871327,v.CoreDefault,`FragList: Deleting ${r}`);var a=this.fragmentsById.get(r);return a===void 0?!1:(this.innerDeleteFragment(a),this.checkState(),!0)}},{key:"updateItem",value:function(r,t,a){m.verbose(573871328,v.CoreDefault,`FragList: Updating ${r}`);var s=this.fragmentsById.get(r);if(s===void 0)throw Error(`Item with id '${r!=null?r:"undefined"}' doesn't exist.`);s.item===void 0&&a(Me.UpdateOfStubbedItem,r),s.item=t,this.checkState()}},{key:"moveItem",value:function(r,t,a,s){m.verbose(573871329,v.CoreDefault,`FragList: Moving ${r}`);var u=this.fragmentsById.get(r);if(u===void 0){s(Me.MoveOfNonExistentItem,r);return}this.connectFragments(u.previous,u.next),this.innerAddItems([u],t,a),this.checkState()}},{key:"getItem",value:function(r){var t=this.fragmentsById.get(r);if(t)return t.item}},{key:"checkForSequentialInversion",value:function(r,t){var a=new Set(r);for(var s of r){a.delete(s);var u=this.fragmentsById.get(s);if(u){for(var l=u.previous;l;l=l.previous)if(a.has(l.id)){t(Me.SequentialyInvertedUpdate,l.id);return}}}}},{key:"checkState",value:function(){if(this.checksEnabled()){var r=[];for(var t of this.iterator(!1))t!=null&&r.push(t);var a=[];for(var s of this.fragmentsById.values())s.item!=null&&a.push(s.item);this.checkSizeOfArrayAndMapAreSame(r,a),this.checkArrayAndMapAreIdentical(r,a)}}},{key:"checkSizeOfArrayAndMapAreSame",value:function(r,t){return r.length!=t.length?(m.error(573871330,v.CoreDefault,`${r.length} items available, but ${t.length} items in the map`),!1):!0}},{key:"checkArrayAndMapAreIdentical",value:function(r,t){var a=!0;for(var s of t){var u=r.indexOf(s);u==-1?(m.error(573871331,v.CoreDefault,`Can't reach element ${s}`),a=!1):r.splice(u,1)}for(var l of r)m.error(573871360,v.CoreDefault,`Element: ${l} in the sorted array that isn't in the map.`),a=!1;return a}},{key:"innerAddItems",value:function(r,t,a){var s=this.getOrCreateFragment(t),u=this.getOrCreateFragment(a);s&&s.next&&this.disconnectFragments(s,s.next),u&&u.previous&&this.disconnectFragments(u.previous,u),this.connectFragments(s,r[0]),this.connectFragments(r[r.length-1],u)}},{key:"makeIterator",value:function(r){var t=this,a=-1,s=void 0,u=void 0;return{next:function(){for(var f;a<t.arrayOfFragmentHeads.length;){for(;s;){var c=s;if(s=s.next,u=(f=u==null?void 0:u.next)===null||f===void 0?void 0:f.next,c&&c===u&&(m.error(512231008,v.CoreDefault,"FragList Iterator Cycle Detected."),s=void 0),c.item||r)return{value:c.item,done:!1}}a++,s=a<t.arrayOfFragmentHeads.length?t.arrayOfFragmentHeads[a]:void 0,u=s}return{value:void 0,done:!0}}}}},{key:"innerDeleteFragment",value:function(r){this.fragmentsById.delete(r.id),this.removeFragmentFromHeadList(r),this.connectFragments(r.previous,r.next)}},{key:"removeFragmentFromHeadList",value:function(r){var t=this.arrayOfFragmentHeads.indexOf(r);t!=-1&&this.arrayOfFragmentHeads.splice(t,1)}},{key:"addFragmentsToMap",value:function(r){for(var t of r)this.fragmentsById.set(t.id,t)}},{key:"createFragmentList",value:function(r,t){var a=new Array(r.length);a[0]=new sa(r[0],t[0]);for(var s=1;s<r.length;s++)a[s]=new sa(r[s],t[s]),a[s-1].next=a[s],a[s].previous=a[s-1];return a}},{key:"removeAlreadyExistingStubFragments",value:function(r){for(var t of r){var a=this.fragmentsById.get(t.id);a&&(a.item!=null&&m.info(573871361,v.CoreDefault,`Already Existing Item: ${a.id}`),this.innerDeleteFragment(a))}}},{key:"getOrCreateFragment",value:function(r){if(r!=null){var t=this.fragmentsById.get(r);return t===void 0&&(t=new sa(void 0,r),this.fragmentsById.set(r,t)),t}}},{key:"connectFragments",value:function(r,t){if(r&&(r.next=t,r.previous==null)){var a=this.arrayOfFragmentHeads.indexOf(r);a===-1&&this.arrayOfFragmentHeads.push(r)}if(t)if(t.previous=r,r){var s=this.arrayOfFragmentHeads.indexOf(t);s!==-1&&this.arrayOfFragmentHeads.splice(s,1)}else this.arrayOfFragmentHeads.push(t)}},{key:"disconnectFragments",value:function(r,t){!r||!t||(r.next=void 0,t.previous=void 0,this.arrayOfFragmentHeads.push(t))}}]),o}(Symbol.iterator);function ZI(){return!1}var e_=function(){function n(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;(0,Bf.default)(this,n),this.id=o,this.parent=e}return(0,Wf.default)(n,[{key:"getPath",value:function(){for(var e=this,r=0;e!==null;)r+=1,e=e.parent;var t=new Array(r);for(e=this;r>0;)r-=1,t[r]=e.id,e=e.parent;return t}},{key:"getParentPath",value:function(){var e,r;return(r=(e=this.parent)===null||e===void 0?void 0:e.getPath())!==null&&r!==void 0?r:[]}}]),n}(),la=Symbol("path");function t_(){return this[la].getParentPath()}function n_(n){Object.defineProperty(this,"parentPath",{value:n,writable:!0,configurable:!0,enumerable:!0})}function Om(){var n={id:"#root#",parentPath:[]};return Q("CompressItemPathsEnabled")&&(n[la]=null),n}function r_(n,o){var e=o.parentPath.length===0&&o.id==="#root#"?[]:[].concat((0,ua.default)(o.parentPath),[o.id]),r=n;return r.parentPath=e,r}function Uo(n,o){var e=o[la];return e!==void 0?(n[la]=new e_(n.id,e),Object.defineProperty(n,"parentPath",{get:t_,set:n_,configurable:!0,enumerable:!0}),n):r_(n,o)}var Lm=function(){function n(o,e){(0,Bf.default)(this,n),this.itemWithPath=o.item,o.childNodes&&o.childNodes.length>0?this.childNodes=new Is(e,o.childNodes.map(function(r){return r.map(function(t){return{id:t.id,item:t.item?new n(t.item,e):void 0}})})):Q("LeavesHaveNoChildrenOptimizationEnabled")?this.checksEnabled=e:this.childNodes=new Is(e)}return(0,Wf.default)(n,[{key:"itemWithPath",get:function(){return this.item},set:function(e){this.item=e}},{key:"serializableForm",value:function(){var e,r,t=(r=(e=this.childNodes)===null||e===void 0?void 0:e.getItemsWithIds())!==null&&r!==void 0?r:[];return{item:this.itemWithPath,childNodes:t.map(function(a){return a.map(function(s){return{id:s.id,item:s.item?s.item.serializableForm():void 0}})})}}},{key:"loggableForm",value:function(){var e,r,t=(r=(e=this.childNodes)===null||e===void 0?void 0:e.getItemsWithIds())!==null&&r!==void 0?r:[];return{id:this.item.id,type:y.getTypeNameFor(this.itemWithPath.body),childNodeIds:t.map(function(a){return a.map(function(s){return s.id})})}}},{key:"normalizeEmptyChildren",value:function(){this.ensureChildNodeList(),this.checksEnabled=void 0}},{key:"visitChildNodesSync",value:function(e){var r;for(var t of(r=this.childNodes)!==null&&r!==void 0?r:[])e(t)}},{key:"visitChildNodesWithFragListStubsSync",value:function(e){var r,t;for(var a of(t=(r=this.childNodes)===null||r===void 0?void 0:r.iterator(!0))!==null&&t!==void 0?t:[])e(a)}},{key:"visitAllLeafDescendantNodesSync",value:function(e){var r;for(var t of(r=this.childNodes)!==null&&r!==void 0?r:[])t.hasChildren()?t.visitAllLeafDescendantNodesSync(e):e(t)}},{key:"visitSubtree",value:function(e){var r;e(this);for(var t of(r=this.childNodes)!==null&&r!==void 0?r:[])t.visitSubtree(e)}},{key:"getNodeInSubtree",value:function(e,r,t){if(e.length===0)return this;t=t||{createInferredNodes:!1};for(var a=this,s=void 0,u=0;u<e.length;u++){var l=e[u];if(s=a.getChildNodeById(l),!s&&t.createInferredNodes&&(this.item[la]===void 0?s=r({id:l,parentPath:[].concat((0,ua.default)(this.getPath()),(0,ua.default)(e.slice(0,u)))}):s=r(Uo({id:l},a.item)),a.ensureChildNodeList(),a.childNodes.addItem(s,l,null)),!s)return;a=s}return s}},{key:"addChildItems",value:function(e,r,t,a,s){this.ensureChildNodeList(),this.childNodes.addItems(r,t,e,a,s)}},{key:"updateChildItem",value:function(e,r,t){this.ensureChildNodeList(),this.childNodes.updateItem(e,r,t)}},{key:"deleteChildItem",value:function(e,r){var t;(t=this.childNodes)===null||t===void 0||t.deleteItem(e,r)}},{key:"hasChildren",value:function(){var e,r;return(r=(e=this.childNodes)===null||e===void 0?void 0:e.hasItems())!==null&&r!==void 0?r:!1}},{key:"getChildNodeById",value:function(e){var r;return(r=this.childNodes)===null||r===void 0?void 0:r.getItem(e)}},{key:"getFragmentHeadIds",value:function(e){var r,t;return(t=(r=this.childNodes)===null||r===void 0?void 0:r.getFragmentHeadIds(e))!==null&&t!==void 0?t:[]}},{key:"ensureChildNodeList",value:function(){var e;this.childNodes===void 0&&(this.childNodes=new Is((e=this.checksEnabled)!==null&&e!==void 0?e:ZI))}},{key:"getPath",value:function(){return this.item.parentPath.length===0&&this.item.id==="#root#"?[]:[].concat((0,ua.default)(this.item.parentPath),[this.item.id])}}]),n}();h();var Ee=w(R()),Ne=w(B());var Of=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMetadata"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Of.H_={T_:Of.getTypeName(),B_:Of.getBaseTypes()};var fo=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_Worksheet"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();fo.H_={T_:fo.getTypeName(),B_:fo.getBaseTypes()};var Lf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_WorksheetMetadata"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Lf.H_={T_:Lf.getTypeName(),B_:Lf.getBaseTypes()};var Ff=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRange"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Ff.H_={T_:Ff.getTypeName(),B_:Ff.getBaseTypes()};var qf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeWrapper"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();qf.H_={T_:qf.getTypeName(),B_:qf.getBaseTypes()};var $f=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeWrapperAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();$f.H_={T_:$f.getTypeName(),B_:$f.getBaseTypes()};var Gf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_BaseExcelBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Gf.H_={T_:Gf.getTypeName(),B_:Gf.getBaseTypes()};var Uf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelBlock","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Uf.H_={T_:Uf.getTypeName(),B_:Uf.getBaseTypes()};var Hf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelExtendedBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelBlock","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Hf.H_={T_:Hf.getTypeName(),B_:Hf.getBaseTypes()};var zf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMergedCellInfo"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRange"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();zf.H_={T_:zf.getTypeName(),B_:zf.getBaseTypes()};var Vf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Vf.H_={T_:Vf.getTypeName(),B_:Vf.getBaseTypes()};var Qf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_PathFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Qf.H_={T_:Qf.getTypeName(),B_:Qf.getBaseTypes()};var Jf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelGridSubtreeFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Jf.H_={T_:Jf.getTypeName(),B_:Jf.getBaseTypes()};var jf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeSampleFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeFilter","AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();jf.H_={T_:jf.getTypeName(),B_:jf.getBaseTypes()};var Kf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelTableColumn"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Kf.H_={T_:Kf.getTypeName(),B_:Kf.getBaseTypes()};var Xf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_BaseExcelTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Xf.H_={T_:Xf.getTypeName(),B_:Xf.getBaseTypes()};var Yf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelTable","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Yf.H_={T_:Yf.getTypeName(),B_:Yf.getBaseTypes()};var Zf=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelPivotTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelTable","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Zf.H_={T_:Zf.getTypeName(),B_:Zf.getBaseTypes()};var fa=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelCell"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_GridCell"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();fa.H_={T_:fa.getTypeName(),B_:fa.getBaseTypes()};var ec=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMergedCell"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ec.H_={T_:ec.getTypeName(),B_:ec.getBaseTypes()};var tc=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelRangeAddressNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRange"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();tc.H_={T_:tc.getTypeName(),B_:tc.getBaseTypes()};var nc=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelRecognizedTableNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();nc.H_={T_:nc.getTypeName(),B_:nc.getBaseTypes()};var rc=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelDetectedTableBoundaryPartNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();rc.H_={T_:rc.getTypeName(),B_:rc.getBaseTypes()};var oc=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelDetectedTableBoundaryNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();oc.H_={T_:oc.getTypeName(),B_:oc.getBaseTypes()};var ic=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelTableDataGridPartNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ic.H_={T_:ic.getTypeName(),B_:ic.getBaseTypes()};var ac=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelComparisonAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();ac.H_={T_:ac.getTypeName(),B_:ac.getBaseTypes()};var sc=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelComparisonItem"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();sc.H_={T_:sc.getTypeName(),B_:sc.getBaseTypes()};var uc=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_EcsAccessInfo"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();uc.H_={T_:uc.getTypeName(),B_:uc.getBaseTypes()};var lc=function(){function n(o){(0,Ee.default)(this,n),y.assign(n,this,o)}return(0,Ne.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_DirtyRangeSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();lc.H_={T_:lc.getTypeName(),B_:lc.getBaseTypes()};h();var Fm=w(R()),qm=w(B()),$m=function(){function n(){(0,Fm.default)(this,n),this.string2internedString=new Map,this.hitCount=0}return(0,qm.default)(n,[{key:"intern",value:function(e){var r=this.string2internedString.get(e);return r!==void 0?(this.hitCount+=1,r):(this.string2internedString.set(e,e),e)}},{key:"clear",value:function(){this.string2internedString.clear(),this.hitCount=0}},{key:"hits",get:function(){return this.hitCount}},{key:"size",get:function(){return this.string2internedString.size}},{key:"hitRate",value:function(){return this.hits/(this.hits+this.size)}}]),n}();h();var Gm=w(Se());function Um(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:void 0,o=new Map,e=function(t){if(t==null){m.error(572837961,v.CoreDefault,"Attempt to call a generic function on undefined or null");return}var a=void 0;for(var s of[y.getTypeNameFor(t)].concat((0,Gm.default)(y.getBaseTypesFor(t)),[void 0])){var u=o.get(s);if(u!==void 0){a=u;break}}if(a===void 0){m.error(572837962,v.CoreDefault,`Cannot find generic implementation for type ${y.getTypeNameFor(t)}`);return}for(var l=arguments.length,f=new Array(l>1?l-1:0),c=1;c<l;c++)f[c-1]=arguments[c];return a.apply(void 0,[t].concat(f))};return e.set=function(r,t){o.set(r,t)},e}h();var _s=w(at()),Hm=w(R()),zm=w(B());var o_=new G("enableTreeLevelsByItemTypeCaching",!0),fc=function(){function n(o,e){(0,Hm.default)(this,n),this.levelsByTypeMap=e!=null?e:new Map,this._isEnabled=o!=null?o:o_.getValue()}return(0,zm.default)(n,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"size",get:function(){return this.levelsByTypeMap.size}},{key:"add",value:function(e){this._isEnabled&&n.add(this.levelsByTypeMap,e)}},{key:"addNodes",value:function(e){if(this._isEnabled)for(var r of e)n.add(this.levelsByTypeMap,r.itemWithPath)}},{key:"addSubtree",value:function(e){var r=this;this._isEnabled&&e.visitSubtree(function(t){r.add(t.itemWithPath)})}},{key:"remove",value:function(e){var r,t;if(!(!this._isEnabled||!(!((r=e==null?void 0:e.body)===null||r===void 0)&&r.H_))){var a=e.parentPath.length;e.body.H_.T_&&this.removeType(e.body.H_.T_,a);for(var s of(t=e.body.H_.B_)!==null&&t!==void 0?t:[])this.removeType(s,a)}}},{key:"removeSubtree",value:function(e){var r=this;this._isEnabled&&e.visitSubtree(function(t){r.remove(t.itemWithPath)})}},{key:"update",value:function(e,r){if(this._isEnabled){var t=this.getAllTypesSet(e);if(!t){this.add(r);return}var a=this.getAllTypesSet(r);if(!a){this.remove(e);return}var s=r.parentPath.length;for(var u of t)a.has(u)||this.removeType(u,s);for(var l of a)t.has(l)||n.addType(this.levelsByTypeMap,l,s)}}},{key:"getLevels",value:function(e){return this.levelsByTypeMap.get(e)}},{key:"compare",value:function(e){var r,t=void 0;for(var a of e){var s=(0,_s.default)(a,2),u=s[0],l=s[1];if(!this.levelsByTypeMap.has(u)){t={itemType:u,expected:Array.from(l.entries()),actual:null};break}var f=this.levelsByTypeMap.get(u);for(var c of l){var d=(0,_s.default)(c,2),p=d[0],g=d[1],k=(r=f.get(p))!==null&&r!==void 0?r:0;if(k!=g){t={itemType:u,expected:Array.from(l.entries()),actual:Array.from(f.entries())};break}}}for(var S of this.levelsByTypeMap){var x=(0,_s.default)(S,2),C=x[0],T=x[1];if(t)break;if(!e.has(C)){for(var I of T.values())if(I>0){t={itemType:C,expected:null,actual:Array.from(T.entries())};break}}}return t}},{key:"removeType",value:function(e,r){var t=this.levelsByTypeMap.get(e);if(t){var a=t.get(r);t.set(r,a-1)}}},{key:"getAllTypesSet",value:function(e){var r,t,a;if(!((t=(r=e==null?void 0:e.body)===null||r===void 0?void 0:r.H_)===null||t===void 0)&&t.T_){var s=new Set;s.add(e.body.H_.T_);for(var u of(a=e.body.H_.B_)!==null&&a!==void 0?a:[])s.add(u);return s}}}],[{key:"add",value:function(e,r){var t,a;if(!((t=r==null?void 0:r.body)===null||t===void 0)&&t.H_){var s=r.parentPath.length;r.body.H_.T_&&n.addType(e,r.body.H_.T_,s);for(var u of(a=r.body.H_.B_)!==null&&a!==void 0?a:[])n.addType(e,u,s)}}},{key:"addType",value:function(e,r,t){var a,s=e.get(r);if(!s)s=new Map,s.set(t,1),e.set(r,s);else{var u=(a=s.get(t))!==null&&a!==void 0?a:0;s.set(t,u+1)}}}]),n}();var Vm=new G("modelLogMinDurationInMs",30),i_=new G("percentageOfGetSubtreeItemsLogs",5),a_=["formulaR1C1Json","numberFormat","numberFormatCategory","fillColor","fontColor"],gc=Um(function(n,o){});gc.set(void 0,function(){});gc.set(fa.getTypeName(),function(n,o){if(o!==void 0)for(var e of a_)n[e]!==void 0&&(n[e]=o.intern(n[e]))});var s_=function(){function n(o,e,r){(0,dc.default)(this,n),this._itemIds=[],this._newNodes=[],this._lastPrevId=e,this._createNode=r,o?(this._addItem=this.addItemIfNotDuplicate,this._uniqueIds=new Set):this._addItem=this.addItem}return(0,pc.default)(n,[{key:"lastPrevId",get:function(){return this._lastPrevId}},{key:"itemIds",get:function(){return this._itemIds}},{key:"newNodes",get:function(){return this._newNodes}},{key:"addItemIfNeeded",value:function(e,r){this._addItem(e,r)}},{key:"reset",value:function(e){this._itemIds=[],this._newNodes=[],this._lastPrevId=e,this._uniqueIds&&(this._uniqueIds=new Set)}},{key:"addItem",value:function(e){this._itemIds.push(e.id);var r=this._createNode(e);this._newNodes.push(r)}},{key:"addItemIfNotDuplicate",value:function(e,r){if(this._uniqueIds.has(e.id))r(Me.AddOfItemsWithDuplicateIds,e.id);else{this._uniqueIds.add(e.id),this._itemIds.push(e.id);var t=this._createNode(e);this._newNodes.push(t)}}}]),n}(),co=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,e=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;(0,dc.default)(this,n),this._firstSeenSchemaObjectTypes=new Map,this.cellLookup=new Map,this.shouldErrorCheck=function(){return!1},this.root=this.createNode(Om()),this.root.itemWithPath.parentPath=[],this.nextAnnotationId=o,this.maxNodeCount=1,this.nodeCount=1,Q("InternExcelCellProperties")&&(this.interner=new $m),this.levelsByTypeCache=new fc(e,r)}return(0,pc.default)(n,[{key:"firstSeenSchemaObjectTypes",get:function(){return this._firstSeenSchemaObjectTypes}},{key:"getNextAnnotationId",value:function(){return"#A"+this.nextAnnotationId++}},{key:"serializableForm",value:function(){return{nextAnnotationId:this.nextAnnotationId}}},{key:"serializeAllNodes",value:function(){var e=new Array(this.nodeCount),r=0;return this.root.visitSubtree(function(t){e[r++]=t.serializableForm()}),e}},{key:"addItems",value:function(e,r,t,a,s){var u=this,l,f;if(t.length!==0){if(Q("PreventFragCyclesWithPrevAndNextIds")){var c=this.updatePrevAndNextIdsIfCycles(t,a,s);a=c.prevId,s=c.nextId}var d=this.shouldErrorCheck(),p=new s_(d,a,this.createNode.bind(this)),g=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!0}),k=g.itemWithPath;if(d){var S=t.map(function(_){return u.ensureItemId(_),_.id.toString()}).join(", ");m.info(527745699,v.CoreDefault,`Add items with ids: ${S}, parentItemId: ${k.id}, previousItemId: ${a}, nextItemId: ${s}.`)}for(var x of t){this.ensureItemId(x),x.body!=null&&(this.addCell(r,x),gc(x.body,this.interner),this.reportSeenType(x.body));var C=Uo(x,k),T=g.getChildNodeById(C.id);if(T){!((l=T.itemWithPath)===null||l===void 0)&&l.body&&(!((f=C==null?void 0:C.id)===null||f===void 0)&&f.match(/R(\d+)C(\d+)/)||m.info(527745728,v.CoreDefault,`Already Existing Item: ${C.id}`));var I=T.itemWithPath;T.itemWithPath=C,this.levelsByTypeCache.update(I,C),p.newNodes.length>0&&(g.addChildItems(e,p.newNodes,p.itemIds,p.lastPrevId,x.id),this.levelsByTypeCache.addNodes(p.newNodes),p.reset(C.id))}else p.addItemIfNeeded(C,e)}p.newNodes.length>0&&(g.addChildItems(e,p.newNodes,p.itemIds,p.lastPrevId,s),this.levelsByTypeCache.addNodes(p.newNodes))}}},{key:"updateItems",value:function(e,r,t){if(t.length!==0){var a=V().startSync(In.UpdateModelItems),s=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!1});s||(e(Me.UpdateOfNonExistentItem,r[r.length-1]),s=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!0}));var u=s.itemWithPath;for(var l of t){if(!l.id){e(Me.UpdateOfNonExistentItem,void 0);continue}var f=Uo(l,u),c=s.getChildNodeById(f.id);if(!c){e(Me.UpdateOfNonExistentItem,f.id),c=this.createNode(f),s.addChildItems(e,[c],[f.id]),this.levelsByTypeCache.add(f);continue}var d=c.itemWithPath;c.itemWithPath=f,s.updateChildItem(l.id,c,e),this.levelsByTypeCache.update(d,f)}V().stop(a)}}},{key:"deleteItems",value:function(e,r,t){if(t.length!==0){var a=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!1});if(!a){e(Me.DeleteOfNonExistingItem,r[r.length-1]);return}var s=a.itemWithPath;this.shouldErrorCheck()&&m.info(527745729,v.CoreDefault,`Delete items with ids: ${t.map(function(f){return f.id.toString()}).join(", ")}, parentItemId: ${s.id}`);for(var u of t){var l=a.getChildNodeById(u.id);if(!l){e(Me.DeleteOfNonExistingItem,u.id);continue}this.levelsByTypeCache.removeSubtree(l),a.deleteChildItem(u.id,e),this.deleteNode(l)}}}},{key:"moveItems",value:function(e,r,t,a,s,u){var l=this;if(a.length!==0){var f=this.root.getNodeInSubtree(r,this.createNode.bind(this),{createInferredNodes:!1});if(!f){e(Me.MoveOfNonExistentItem,r[r.length-1]);return}if(Q("PreventFragCyclesWithPrevAndNextIds")){var c=this.updatePrevAndNextIdsIfCycles(a,s,u);s=c.prevId,u=c.nextId}var d=this.root.getNodeInSubtree(t,this.createNode.bind(this),{createInferredNodes:!0}),p=d.itemWithPath,g=[],k=[],S=function(){var T=f.getChildNodeById(x.id);if(!T)return e(Me.DeleteOfNonExistingItem,x.id),1;g.push(T),k.push(x.id),l.levelsByTypeCache.removeSubtree(T),T.itemWithPath=Uo(Object.assign({},T.itemWithPath),p);var I=function _(M){M.visitChildNodesSync(function(A){A.itemWithPath=Uo(Object.assign({},A.itemWithPath),M.itemWithPath),_(A)})};I(T),l.levelsByTypeCache.addSubtree(T),f.deleteChildItem(x.id,e)};for(var x of a)S();d.addChildItems(e,g,k,s,u)}}},{key:"getItem",value:function(e){if(e.length===0)throw new Error("Invalid item path");var r=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(r)return r.itemWithPath}},{key:"hasItem",value:function(e){if(e.length===0)return!1;var r=this.root.getNodeInSubtree(e,this.createNode.bind(this));return!!r}},{key:"getCells1D",value:function(e,r,t,a,s){var u=[],l=this.cellLookup.get(e);if(!l)throw new Error(`Invalid worksheet ID ${e}`);var f=Or.lowerIndexBound,c=l.length-1;r=Math.max(r,f),t=Math.min(t,c),a=Math.max(a,f);for(var d=r;d<=t;d++)if(Array.isArray(l[d]))for(var p=l[d].length-1,g=Math.min(s,p),k=a;k<=g;k++)l[d][k]&&u.push(l[d][k]);return u}},{key:"getSubtreeItems",value:function(e,r,t){var a=V().startSync(In.GetModelSubTreeItems);try{return!this.levelsByTypeCache.isEnabled||!Array.isArray(r)||r.length===0||r.some(function(s){return!s})?this.getSubtreeItemsFullSearch(e,r,t):this.getSubtreeItemsIndexed(e,r,t)}finally{V().stop(a)}}},{key:"getItemChildren",value:function(e,r){var t=V().startSync(In.GetModelItemChildren);try{var a=[],s=this.root.getNodeInSubtree(e,this.createNode.bind(this));return s?(s.visitChildNodesSync(function(u){(!r||y.matchesTypesFor(u.itemWithPath.body,r))&&a.push(u.itemWithPath)}),a):void 0}finally{V().stop(t)}}},{key:"visitItemPathSync",value:function(e,r){var t=this.root;for(var a of e){if(t=t.getNodeInSubtree([a],this.createNode.bind(this)),!t)throw new Error("Ancestor item not found");if(r(t.itemWithPath))return}}},{key:"getMaxItemCount",value:function(){return this.maxNodeCount}},{key:"analyzeTreeLevelsByItemTypeCacheErrors",value:function(){var e=this,r=new Map,t=new E({operationName:"AnalyzeTreeLevelsByItemTypeCacheConsistency",success:!0}).start(),a=function l(f){fc.add(r,f.itemWithPath),f.visitChildNodesSync(function(c){return l(c)})};this.root.visitChildNodesSync(function(l){return a(l)});var s=this.levelsByTypeCache.compare(r);t.success=!s,t.stop();var u=function(){return t.resultDescription=`maxItemCount: ${e.maxNodeCount.toString()}. diff: ${JSON.stringify(s)}`,t};return t.success===!1||t.durationMs>Vm.getValue()?m.info(528589721,v.CoreDefault,u):m.debug(528589722,v.CoreDefault,u),t.success}},{key:"setShouldErrorCheck",value:function(e){this.shouldErrorCheck=e}},{key:"getSubtreeItemsFullSearch",value:function(e,r,t){var a=this,s;Array.isArray(r)&&t?s=function(k){return t(k)&&y.matchesTypesFor(k.body,r)}:Array.isArray(r)&&!t?s=function(k){return y.matchesTypesFor(k.body,r)}:s=r||function(){return!0};var u=new E({operationName:"getSubtreeItemsFullSearch",success:!0}).start(),l=[],f=0,c=function g(k){f++,s(k.itemWithPath)&&l.push(k.itemWithPath),k.visitChildNodesSync(function(S){return g(S)})};if(e.length===0)this.root.visitChildNodesSync(function(g){return c(g)});else{var d=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(!d)throw new Error(`Failed to get item for path ${H(e)} in model`);c(d)}u.stop();var p=function(){return u.resultDescription=`maxItemCount= ${a.maxNodeCount.toString()}. subtreeSize=${f}. results=${l.length}.`,u};return n.shouldLogGetSubtreeItemsMetric(u)?m.info(529056927,v.CoreDefault,p):m.debug(529056928,v.CoreDefault,p),l}},{key:"getSubtreeItemsIndexed",value:function(e,r,t){var a=this,s=new E({operationName:"getSubtreeItemsIndexed",success:!0}).start(),u=this.calculateItemTypesByLevelAndMaxLevel(r),l=(0,cc.default)(u,2),f=l[0],c=l[1];if(f.size===0)return[];var d;t?d=function(T,I){return t(T)&&y.matchesTypesFor(T.body,I)}:d=function(T,I){return y.matchesTypesFor(T.body,I)};var p=[],g=0,k=function C(T,I,_){g++,_&&d(T.itemWithPath,_)&&p.push(T.itemWithPath),I<c&&T.visitChildNodesSync(function(M){return C(M,I+1,f.get(I+1))})};if(e.length===0)this.root.visitChildNodesSync(function(C){return k(C,0,f.get(0))});else{var S=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(!S)throw new Error(`Failed to get item for path ${H(e)} in model`);k(S,e.length-1,f.get(e.length-1))}s.stop();var x=function(){var T={maxInputCount:a.maxNodeCount,visitedNodesCount:g,resultsCount:p.length,cacheSize:a.levelsByTypeCache.size,itemTypes:r.join(", ")};return s.resultDescription=JSON.stringify(T),s};return n.shouldLogGetSubtreeItemsMetric(s)?m.info(572837889,v.CoreDefault,x):m.debug(572837890,v.CoreDefault,x),p}},{key:"calculateItemTypesByLevelAndMaxLevel",value:function(e){var r=this,t=new Map,a=-1,s=function(f){var c=r.levelsByTypeCache.getLevels(f);if(c)for(var d of c){var p=(0,cc.default)(d,2),g=p[0],k=p[1];if(!(k<=0)){var S=t.get(g);S||(S=[],t.set(g,S),a<g&&(a=g)),S.push(f)}}};for(var u of e)s(u);return[t,a]}},{key:"createNode",value:function(e){mm(e.id)||m.warn(572837893,v.CoreDefault,`ItemId ${e.id} does not meet length/charset requirements`);var r=new Lm({item:e,childNodes:[]},this.shouldErrorCheck);return this.nodeCount++,this.nodeCount>this.maxNodeCount&&(this.maxNodeCount=this.nodeCount),r}},{key:"deleteNode",value:function(e){e&&e.hasChildren()&&m.error(572837894,v.CoreDefault,"Destroying node which has children. This can result in orphaned children in our map of all nodes."),this.nodeCount--,this.nodeCount<0&&m.error(572837895,v.CoreDefault,"Model is in inconsistent state, total nodes count is less than zero.")}},{key:"addCell",value:function(e,r){if(y.matchesTypesFor(r.body,[Nn.getTypeName()])){var t=r.body,a=this.cellLookup.get(e[e.length-1]);a||(a=[]),Array.isArray(a[t.row])||(a[t.row]=[]),a[t.row][t.column]=r,this.cellLookup.set(e[e.length-1],a)}}},{key:"reportSeenType",value:function(e){var r;for(var t of y.getAllTypesFor(e)){var a=this._firstSeenSchemaObjectTypes.get(t);a||(r||(r=Date.now()),this._firstSeenSchemaObjectTypes.set(t,r))}}},{key:"ensureItemId",value:function(e){e.id||(e.id=an(),m.info(527745730,v.CoreDefault,`Assigning ${e.id} to child item provided without an id`))}},{key:"updatePrevAndNextIdsIfCycles",value:function(e,r,t){for(var a of e)if(a.id===r||a.id===t)return m.info(512233806,v.CoreDefault,`Incoming operation with prevId or nextId the same as the item.id: ${a.id}`),{prevId:void 0,nextId:void 0};return{prevId:r,nextId:t}}}],[{key:"fromSerializableForm",value:function(e){return new n(e.nextAnnotationId)}},{key:"shouldLogGetSubtreeItemsMetric",value:function(e){return Q("LogPercOfGetSubtreeItems")?100*Math.random()<=i_.getValue():e.durationMs>Vm.getValue()}}]),n}();h();var ca=new G("moveOperationEnabled",!1);function u_(n){var o=l_();return function(){var r=(0,hc.default)(n),t;if(o){var a=(0,hc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Xm.default)(this,t)}}function l_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Qm=new G("hotCacheLogMinDurationInMs",30),f_=new G("singleItemUpdatesAccumulatorSettings",{"Outlook-Win32":{enabled:!0,accumulationTimeoutMs:2e3,messageRateIntervalMs:1e3,maxRate:4}}),Zm=function(n){(0,Km.default)(e,n);var o=u_(e);function e(r,t,a){var s;return(0,Jm.default)(this,e),s=o.call(this),s.itemListeners=new xs,s.stats={maxItemCount:0,firstSeenSchemaObjectTypes:new Map,documentUrlAvailable:!1,documentUrlWasProvided:!1},s.deltaHandlers=new Map,s.consistencyErrorLogger=r,s.model=t||new co,s.model.setShouldErrorCheck(function(){return!1}),s.itemUpdatesAccumulator=a!=null?a:new Nm,Q("checkIfDocumentUrlWasProvided")&&s.setupDocumentUrlChecker(),s}return(0,jm.default)(e,[{key:"getSerializedCache",value:function(){return{allNodes:this.model.serializeAllNodes()}}},{key:"applyOperations",value:function(t,a){var s=this,u=V(),l=u.startSync(In.ApplyOperations),f=0,c=0,d=!1,p=t.length,g=new E({operationName:"HotCacheApplyOperations",success:!0},{metricDuration:!0}).start(),k=[],S=[],x=function(M){var A=y.getTypeNameFor(M),b=function(re,se){if(s.consistencyErrorLogger.logModelOperationError(A,M,re,se),Q("mastermindSendOpErrors")){var de=(0,lt.default)(M.parentPath);se&&de.push(se),S.push({path:de,errorCode:re})}};if(s.model.shouldErrorCheck()){var N=function(){var re=4e3,se=100,de=M.items.length>se,ye=de?M.items.slice(0,se):M.items,He=ye.map(function(nt){return nt.id}).join(", "),Ct=He.length>re,we=Ct?He.substring(0,re):He;return`Applying ${A} to hot cache haveWeOmittedSomeIds=${de}; haveWeShortenedLogString=${Ct}; ids: ${we}`};m.info(572837901,v.CoreDefault,N)}var z=A===Ge.getTypeName();if(z){d=!0;var L=s.generateDeepDeleteOperations(M,b);u.stop(l);for(var J of L)s.triggerNotifications([J],a),f++;u.resume(l);for(var P of L)s.updateModel(P,a,b),c++}else if(A===Gt.getTypeName()){var D=s.handleDeltaUpdate(b,M);D&&(s.updateModel(D,a,b),c++,k.push(D))}else{if(A===kn.getTypeName()){var O=M;if(hm(O.parentPath,O.prevParentPath)&&!O.nextId&&!O.prevId)return O.items.forEach(function(X){return b(Me.MoveToTheSamePath,X.id)}),0;if(ca.getValue())return k.push(M),s.generateSubtreeMoveOperations(O).forEach(function(X){s.emit("beforeItemChange",X),k.push(X)}),s.updateModel(M,a,b),c++,0;var $=s.generateAddOperationsForNewPath(O),F=s.generateDeepDeleteOperations(new Ge({items:M.items,parentPath:O.prevParentPath}),b);u.stop(l);for(var q of F)s.triggerNotifications([q],a),f++;u.resume(l);for(var W of F)s.updateModel(W,a,b);for(var K of $)s.updateModel(K,a,b),k.push(K);return 0}s.updateModel(M,a,b),c++,A!==To.getTypeName()&&A!==Io.getTypeName()&&A!==_o.getTypeName()&&k.push(M)}},C;for(var T of t)C=x(T);u.stop(l),k.length>0&&(this.triggerNotifications(k,a),f++),g.stop();var I=function(){return g.resultDescription=`{"triggerNotificationsCallCount":${f},"updateModelCallCount":${c},"hadDeleteOps":${d},"numberOfOps":${p}}`,g};return g.durationMs>Qm.getValue()?m.info(572837902,v.CoreDefault,I):m.debug(572837903,v.CoreDefault,I),S}},{key:"getItem",value:function(t){var a=this.model.getItem(t);if(!a)throw new uo(`Failed to get item for path ${H(t)} in hot cache`);return a}},{key:"hasItem",value:function(t){return this.model.hasItem(t)}},{key:"getItemChildren",value:function(t,a){var s=this.model.getItemChildren(t,a);if(!Array.isArray(s))throw new uo(`Path not found ${H(t)}`);return s}},{key:"getSubtreeItems",value:function(t,a,s){return this.model.getSubtreeItems(t,a,s)}},{key:"getFirstAncestorOfType",value:function(t,a){for(var s=t.slice(0),u=!0;s.length>0;){var l=this.model.getItem(s);if(l){if(y.matchesTypesFor(l.body,a))return it(s.slice(0,-1),l)}else if(!u)throw new Error(`Failed to get ancestor of type(s) [${a.join(",")}] on path ${H(s)} (bad path)`);u=!1,s.pop()}}},{key:"tryGetFirstAncestorOfType",value:function(t,a){try{return this.getFirstAncestorOfType(t,a)}catch(s){}}},{key:"onItemChange",value:function(t,a,s,u){this.itemListeners.onItemChange(t,a,s,u)}},{key:"getCells1D",value:function(t,a,s,u,l){return this.model.getCells1D(t,a,s,u,l)}},{key:"getAnnotation",value:function(t){try{return this.model.getItem(t).body}catch(a){m.error(572837904,v.CoreDefault,`Could not find annotation given path: ${t}`);return}}},{key:"getStats",value:function(){return this.stats.firstSeenSchemaObjectTypes=this.model.firstSeenSchemaObjectTypes,this.stats.documentUrlAvailable=Q("CheckIfDocumentUrlIsAvailable")?this.isDocumentUrlAvailable():!1,this.stats}},{key:"registerItemDeltaHandler",value:function(t,a){this.deltaHandlers.set(t,a)}},{key:"getNextAnnotationId",value:function(){return this.model.getNextAnnotationId()}},{key:"dispose",value:function(){}},{key:"updateAnnotationMetadata",value:function(t,a){var s=[];for(var u of a.items){var l=this.model.getItem(a.parentPath.concat([u.id]));if(!l||!l.body)t(Me.UpdateOfStubbedItem,u.id);else if(!y.matchesTypesFor(l.body,[At.getTypeName()]))t(Me.UpdateMetaDataOfNonAnnotationType,u.id);else{var f=l.body;f.M_=Object.assign(Object.assign({},f.M_),a.M_),s.push(l)}}a.items=s,this.model.updateItems(t,a.parentPath,s)}},{key:"handleDeltaUpdate",value:function(t,a){var s=this.model.getItem(a.parentPath);if(!s){Q("deltaConsistencyErrors")&&a.items&&a.items.length>0?t(Me.DeltaOfNonExistingItem,a.items[0].id):m.error(572837908,v.CoreDefault,`Failed to find parent item for delta op, ID: ${a.parentPath}`);return}var u=a.parentPath.slice(0,-1),l=a.items&&a.items.length>1?a.items.sort(function(S,x){return[he.Add,he.Update,he.Delete].includes(S.body.deltaType)?-1:1}):a.items,f=[],c=st(),d=c.clientMetadata;for(var p of l)try{var g=this.deltaHandlers.get(y.getTypeNameFor(p.body));if(g){m.info(572837909,v.CoreDefault,`Executing delta handler for item type ${y.getTypeNameFor(s.body)}, and ID: ${s.id}`);var k=g(p.body,s.body,d==null?void 0:d.flights);f.push(p.body),k?s={id:s.id,revId:p.revId,body:k,parentPath:u,delta:f[0],deltas:f,contextId:p.contextId,sourceTimestamp:p.sourceTimestamp}:m.info(572837910,v.CoreDefault,`Failed to apply delta of type: ${y.getTypeNameFor(p.body)} on item ${s.id}`)}else m.warn(572837911,v.CoreDefault,`Received a delta operation with no registered handler, delta type: ${y.getTypeNameFor(p.body)}`)}catch(S){m.error(572837912,v.CoreDefault,`Failed to apply delta, error: ${S}`)}if(l.length>0)return new Pe({parentPath:u,items:[s]})}},{key:"updateModel",value:function(t,a,s){var u;this.emit("beforeItemChange",t);var l=y.getTypeNameFor(t);if(m.debug(572837905,v.CoreDefault,function(){var p,g;return`Updating model for ${l} under parent path [${t.parentPath}] (${(p=t.items)===null||p===void 0?void 0:p.length} item(s), first item id: ${((g=t.items)===null||g===void 0?void 0:g.length)>0?t.items[0].id:"(no items)"})`}),l===ke.getTypeName()){var f=t;this.model.addItems(s,f.parentPath,f.items,f.prevId,f.nextId)}else if(l===Pe.getTypeName())this.model.updateItems(s,t.parentPath,t.items);else if(l===Ge.getTypeName())this.model.deleteItems(s,t.parentPath,t.items);else if(l===vt.getTypeName())this.updateAnnotationMetadata(s,t);else if(!(l===Tn.getTypeName()||l===ot.getTypeName()))if(l===To.getTypeName())t.parentPath&&t.items?this.purgeModel(t.parentPath,t.items):m.error(526403013,v.CoreDefault,"invalid arguments for purge operation");else if(l===Io.getTypeName())t.parentPath&&t.items?this.purgeModelSubtree(t.parentPath,t.items):m.error(508126941,v.CoreDefault,"invalid arguments for purge subtree operation");else if(l===_o.getTypeName()){var c=t;c.parentPath&&((u=c.types)===null||u===void 0?void 0:u.length)>0?this.purgeModelByTypes(c.parentPath,c.types):m.error(507253403,v.CoreDefault,"invalid arguments for purge by types operation")}else if(ca.getValue()&&l==kn.getTypeName()){var d=t;this.model.moveItems(s,d.prevParentPath,d.parentPath,d.items,d.prevId,d.nextId)}else Q("errorUnknownOperation")&&s(Me.UnknownOperation,void 0),m.warn(572837914,v.CoreDefault,`Unsupported operation type ${l}`);this.stats.maxItemCount=this.model.getMaxItemCount()}},{key:"purgeModelSubtree",value:function(t,a){var s=this;m.info(508126940,v.CoreDefault,"purging the model subtree");var u=function(){var c=[].concat((0,lt.default)(t),[l.id]),d=s.model.getItemChildren(c);if(d&&d.length>0){var p=d.map(function(g){return s.model.getItem([].concat((0,lt.default)(c),[g.id]))});s.purgeModel(c,p)}};for(var l of a)u()}},{key:"purgeModel",value:function(t,a){var s=this;m.info(526403014,v.CoreDefault,"purging the model"),this.emit("purgeModel",a.map(function(c){return[].concat((0,lt.default)(t),[c.id])}));var u=this.model;this.model=new co;var l=new Set(a.map(function(c){return c.id})),f=function c(d){var p=u.getItemChildren(d),g=new Set(p);if(p&&p.length>0){if(d.length===t.length&&d.every(function(x,C){return t[C]===x}))for(var k=0;k<p.length;k++)l.has(p[k].id)&&(m.info(526403015,v.CoreDefault,"PurgeModel: reached the purgable node. Will not unpurge."),g.delete(p[k]));s.updateModel(new ke({parentPath:d,items:(0,lt.default)(g)}),0,function(){});for(var S of g)c([].concat((0,lt.default)(d),[S.id]))}};f([])}},{key:"purgeModelByTypes",value:function(t,a){var s=this;m.info(507253402,v.CoreDefault,"purgeModelByTypes: purging the model by types: ",a.join(", "));var u=this.model;this.model=new co;var l=[],f=function c(d){var p=u.getItemChildren(d),g=new Set(p);if(p&&p.length>0){if(d.length>=t.length&&t.every(function(x,C){return d[C]===x}))for(var k=0;k<p.length;k++)y.matchesTypesFor(p[k].body,a)&&(l.push([].concat((0,lt.default)(d),[p[k].id])),g.delete(p[k]));s.updateModel(new ke({parentPath:d,items:(0,lt.default)(g)}),0,function(){});for(var S of g)c([].concat((0,lt.default)(d),[S.id]))}};f([]),l.length>0&&this.emit("purgeModel",l),m.info(507253401,v.CoreDefault,`purgeModelByTypes: purged ${l.length}. items`)}},{key:"triggerNotifications",value:function(t,a){var s=this,u,l,f,c,d=new E({operationName:"HotCacheTriggerNotifications",success:!0}).start(),p=st(),g=`${(l=(u=p.clientMetadata)===null||u===void 0?void 0:u.appName)!==null&&l!==void 0?l:""}-${(c=(f=p.clientMetadata)===null||f===void 0?void 0:f.appPlatform)!==null&&c!==void 0?c:""}`,k=f_.getValue()[g];k&&k.enabled?this.itemUpdatesAccumulator.accumulate(k,t,a,function(x,C){s.itemListeners.emitEvents(x,C)}):this.itemListeners.emitEvents(t,a),d.stop();var S=function(){return d.resultDescription=`maxItemCount= ${s.stats.maxItemCount.toString()}. ops.length=${t.length}.`,d};d.durationMs>Qm.getValue()?m.info(572837958,v.CoreDefault,S):m.debug(572837959,v.CoreDefault,S)}},{key:"generateDeepDeleteOperations",value:function(t,a){var s=this,u=[],l=function c(d){var p=s.model.getItemChildren(d);p&&p.length>0&&(u.push(new Ge({parentPath:d,items:p})),p.forEach(function(g){c([].concat((0,lt.default)(d),[g.id]))}))},f=function(d){var p=s.model.getItem(d);p?(u.push(new Ge({parentPath:d.slice(0,-1),items:[p]})),l(d)):a(Me.DeleteOfNonExistingItem,d[d.length-1])};return t.items.forEach(function(c){f([].concat((0,lt.default)(t.parentPath),[c.id]))}),u.reverse(),u}},{key:"isDocumentUrlAvailable",value:function(){var t=this.model.getSubtreeItems([],[Mt.getTypeName()]);if(!t||t.length===0)return!1;var a=t[0].body;return!!a.url}},{key:"generateSubtreeMoveOperations",value:function(t){for(var a=this,s=[],u=function g(k,S){var x=a.model.getItemChildren(S);if(x!=null&&x.length){s.push(new kn({parentPath:k,prevParentPath:S,items:x}));for(var C of x)g([].concat((0,lt.default)(k),[C.id]),[].concat((0,lt.default)(S),[C.id]))}},l=0;l<t.items.length;l++){var f=t.items[l],c=[].concat((0,lt.default)(t.parentPath),[f.id]),d=[].concat((0,lt.default)(t.prevParentPath),[f.id]),p=this.model.getItem(d);t.items[l]=Object.assign({},p),u(c,d)}return s}},{key:"generateAddOperationsForNewPath",value:function(t){var a=this,s=[],u=function g(k,S){var x=a.model.getItemChildren(S);if(x!=null&&x.length){s.push(new ke({parentPath:k,items:x}));for(var C of x)g([].concat((0,lt.default)(k),[C.id]),[].concat((0,lt.default)(S),[C.id]))}},l=new ke({parentPath:t.parentPath,items:[]});s.push(l);for(var f=0;f<t.items.length;f++){var c=[].concat((0,lt.default)(t.parentPath),[t.items[f].id]),d=[].concat((0,lt.default)(t.prevParentPath),[t.items[f].id]),p=this.model.getItem(d);p&&(l.items.push(Object.assign({},p)),u(c,d))}return s}},{key:"setupDocumentUrlChecker",value:function(){var t=this;this.onItemChange(Mt.getTypeName(),Ut.All,function(a){if(!t.stats.documentUrlWasProvided)for(var s of a)for(var u of s.items){var l=u.body;if(l!=null&&l.url){t.stats.documentUrlWasProvided=!0;return}}})}}]),e}(Ym.EventEmitter);h();var mv=w(R()),vv=w(B());h();h();var ev=w(R()),tv=w(B()),mc=function(){function n(o){(0,ev.default)(this,n),this.containedAnalyzers=o}return(0,tv.default)(n,[{key:"appliedOperationNotification",value:function(){for(var e of this.containedAnalyzers)e.appliedOperationNotification()}},{key:"scheduleAnalysis",value:function(){for(var e of this.containedAnalyzers)e.scheduleAnalysis()}},{key:"stop",value:function(){for(var e of this.containedAnalyzers)e.stop()}}]),n}();h();var fv=w(R()),cv=w(B()),dv=w(ze()),pv=w(Ve()),wc=w(Oe());h();var av=w(R()),sv=w(B()),kc=w(iv()),Zt;(function(n){n[n.Idle=0]="Idle",n[n.Pending=1]="Pending",n[n.Running=2]="Running",n[n.Stopped=3]="Stopped"})(Zt||(Zt={}));var uv=function(){function n(o){(0,av.default)(this,n),this.state=Zt.Idle,this.hadNewAppliedOperations=!1,this.analysisTimeoutRelaxed=!1,this.args=o,this.debouncedAnalysis=(0,kc.default)(this.analysisToDebounce.bind(this),this.args.normalSessionsDebounceTimeInMs)}return(0,sv.default)(n,[{key:"finishedAnalysisAndInQuietState",get:function(){return this.state===Zt.Idle}},{key:"appliedOperationNotification",value:function(){this.hadNewAppliedOperations=!0}},{key:"stop",value:function(){this.state=Zt.Stopped,this.debouncedAnalysis.cancel();var e=function(){};e.cancel=function(){},this.debouncedAnalysis=e}},{key:"scheduleAnalysis",value:function(){this.state===Zt.Idle&&(this.state=Zt.Pending),this.debouncedAnalysis()}},{key:"analysisToDebounce",value:function(){var e=this;if(!(this.state!==Zt.Pending||!this.canPerformAnalysis())){if(!this.hadNewAppliedOperations){this.state=Zt.Idle;return}this.state=Zt.Running,this.hadNewAppliedOperations=!1,this.performAnalysis(function(){return e.hadNewAppliedOperations},function(r){e.hadNewAppliedOperations&&setTimeout(function(){return e.scheduleAnalysis()},0),r&&(e.args.allowAnalysisOfLargeSessions()?e.analysisTimeoutRelaxed||(e.analysisTimeoutRelaxed=!0,e.debouncedAnalysis.cancel(),e.debouncedAnalysis=(0,kc.default)(e.analysisToDebounce.bind(e),e.args.tooLargeSessionsDebounceTimeInMs),setTimeout(function(){return e.scheduleAnalysis()},0)):e.state=Zt.Stopped),e.state===Zt.Running&&(e.state=Zt.Idle)})}}}]),n}();function M_(n){var o=b_();return function(){var r=(0,wc.default)(n),t;if(o){var a=(0,wc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,pv.default)(this,t)}}function b_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var E_=5e4,N_=3e5,D_=new G("treeLevelsByItemTypeCacheAnalysisEnabled",!1),lv=new G("treeLevelsByItemTypeCacheAnalysisOfLargeSessions",!1),P_=new G("treeLevelsByItemTypeCacheLargeSessionThreshold",1e3),gv=function(n){(0,dv.default)(e,n);var o=M_(e);function e(r){var t;return(0,fv.default)(this,e),t=o.call(this,{allowAnalysisOfLargeSessions:function(){return lv.getValue()},normalSessionsDebounceTimeInMs:E_,tooLargeSessionsDebounceTimeInMs:N_}),t.stopAnlysis=!1,t.fetchInMemoryModel=r,t}return(0,cv.default)(e,[{key:"canPerformAnalysis",value:function(){return D_.getValue()&&!this.stopAnlysis}},{key:"performAnalysis",value:function(t,a){var s=this.fetchInMemoryModel();if(s){if(s.getMaxItemCount()>P_.getValue()&&!lv.getValue()){this.stopAnlysis=!0,a(!0);return}var u=s.analyzeTreeLevelsByItemTypeCacheErrors();this.stopAnlysis=!u,a(!1)}}}]),e}(uv);var R_=new G("percentageOfSessionsForTreeLevelsCacheAnalysis",10),B_=new G("enableTreeLevelsByItemTypeCaching",!0),W_=new G("treeLevelsByItemTypeCacheAnalysisEnabled",!1),hv=function(o){if(W_.getValue()&&B_.getValue()&&100*Math.random()<=R_.getValue()){var e=new gv(o);return new mc([e])}return new mc([])};var yv=function(){function n(o){var e=this;(0,mv.default)(this,n),this.isShuttingDown=!1,this.quietStateAnalyzer=hv(function(){return e.hotCache.model}),this.hotCache=o()}return(0,vv.default)(n,[{key:"on",value:function(e,r){this.hotCache.on(e,r)}},{key:"applyOperations",value:function(e,r){if(this.isShuttingDown)throw new Error("Shutdown is in process, no further messages will be applied.");this.quietStateAnalyzer.appliedOperationNotification();var t=this.hotCache.applyOperations(e,r);return this.quietStateAnalyzer.scheduleAnalysis(),t}},{key:"getItem",value:function(e){return this.hotCache.getItem(e)}},{key:"hasItem",value:function(e){return this.hotCache.hasItem(e)}},{key:"getItemChildren",value:function(e,r){return this.hotCache.getItemChildren(e,r)}},{key:"onItemChange",value:function(e,r,t,a){this.hotCache.onItemChange(e,r,t,a)}},{key:"getSubtreeItems",value:function(e,r,t){return this.hotCache.getSubtreeItems(e,r,t)}},{key:"getFirstAncestorOfType",value:function(e,r){return this.hotCache.getFirstAncestorOfType(e,r)}},{key:"tryGetFirstAncestorOfType",value:function(e,r){return this.hotCache.tryGetFirstAncestorOfType(e,r)}},{key:"getAnnotation",value:function(e){return this.hotCache.getAnnotation(e)}},{key:"getCells1D",value:function(e,r,t,a,s){return this.hotCache.getCells1D(e,r,t,a,s)}},{key:"getStats",value:function(){return this.hotCache.getStats()}},{key:"getSerializedCache",value:function(){return this.hotCache.getSerializedCache()}},{key:"getNextAnnotationId",value:function(){return this.hotCache.getNextAnnotationId()}},{key:"registerItemDeltaHandler",value:function(e,r){this.hotCache.registerItemDeltaHandler(e,r)}},{key:"dispose",value:function(){this.hotCache.dispose(),this.isShuttingDown=!0,this.quietStateAnalyzer.stop()}}]),n}();h();var kv=w(Se()),wv=w(R()),Sv=w(B());var Sc=function(){function n(){(0,wv.default)(this,n),this.stats={warnings:0,errors:0,quietStateAnalysisDataCorrect:!1,lastRunWarnings:void 0,lastRunErrors:void 0}}return(0,Sv.default)(n,[{key:"getStats",value:function(){return this.stats}},{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"logModelOperationError",value:function(e,r,t,a){var s=n.shouldLogConsistencyErrorAsInfoTemporarily(t),u;s?(this.stats.warnings++,u="SyncOperationWarning"):(this.stats.errors++,u="SyncOperationError"),m.info(508650700,v.CoreDefault,new Re({sessionHealthEventName:u,source:Te.Core,reason:pe.Client,impact:Ie.MissingInput,success:!1,message:`${e} for item ${H([].concat((0,kv.default)(r.parentPath),[a]))} has operation error ${Me[t]}`,dimension0:Me[t],subReason:Me[t]},this.clientMetadata))}}],[{key:"shouldLogConsistencyErrorAsInfoTemporarily",value:function(e){return e===Me.UpdateOfNonExistentItem||e===Me.DeleteOfNonExistingItem}}]),n}();h();var Oy=w(Se()),Ly=w(R()),Fy=w(B()),qy=w(ze()),$y=w(Ve()),Gc=w(Oe());h();var Cv=w(R()),xv=w(B()),Tv=function(){function n(){(0,Cv.default)(this,n),this.prevSequence=-1}return(0,xv.default)(n,[{key:"generate",value:function(e){if(e)for(var r of e){var t=++this.prevSequence;r.metadata?r.metadata.seq=t:r.metadata={seq:t}}}}]),n}();h();var Iv=w(R()),_v=w(B()),As=function(){function n(o){(0,Iv.default)(this,n),this.elements=o}return(0,_v.default)(n,[{key:"getAll",value:function(e){return Promise.resolve(this.elements)}},{key:"map",value:function(e){throw new Error("Not Yet Implemented")}},{key:"filter",value:function(e){throw new Error("Not Yet Implemented")}},{key:"forEach",value:function(e){throw new Error("Not Yet Implemented")}},{key:"reduce",value:function(e,r){throw new Error("Not Yet Implemented")}}]),n}();h();var Ms=w(R()),bs=w(B());var da=function(){function n(o){(0,Ms.default)(this,n),y.assign(n,this,o)}return(0,bs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_AsyncAnnotationResult"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();da.H_={T_:da.getTypeName(),B_:da.getBaseTypes()};var Cc=function(){function n(o){(0,Ms.default)(this,n),y.assign(n,this,o)}return(0,bs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_ChatStoreSetMessages"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Cc.H_={T_:Cc.getTypeName(),B_:Cc.getBaseTypes()};var xc=function(){function n(o){(0,Ms.default)(this,n),y.assign(n,this,o)}return(0,bs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_ChatStoreGetMessages"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();xc.H_={T_:xc.getTypeName(),B_:xc.getBaseTypes()};h();var ee;(function(n){n[n.WorkflowExecutionFailed=0]="WorkflowExecutionFailed",n[n.WorkflowDisabled=1]="WorkflowDisabled",n[n.WorkflowWrongAnnotationType=2]="WorkflowWrongAnnotationType",n[n.FailedAnnotationApply=3]="FailedAnnotationApply",n[n.ApplyAnnotationsException=4]="ApplyAnnotationsException",n[n.AnnotationsNotArray=5]="AnnotationsNotArray",n[n.UnexpectedOutput=6]="UnexpectedOutput",n[n.OutputIsNotAnnotation=7]="OutputIsNotAnnotation",n[n.MixedOutput=8]="MixedOutput",n[n.UnknownAnnotationParent=9]="UnknownAnnotationParent",n[n.SnapshotStorageNotInitialized=10]="SnapshotStorageNotInitialized",n[n.FailedToRetrieveDataFromSnapshot=11]="FailedToRetrieveDataFromSnapshot",n[n.TooManyItemsToExecuteReduceWorkflow=12]="TooManyItemsToExecuteReduceWorkflow",n[n.NoAcceptableTransportAvailable=13]="NoAcceptableTransportAvailable",n[n.FailedToZipInput=14]="FailedToZipInput",n[n.RequiredTokenNotAvailable=15]="RequiredTokenNotAvailable",n[n.TimedOutSendingRequestToWorkflowProcess=16]="TimedOutSendingRequestToWorkflowProcess",n[n.PubSubProduceError=17]="PubSubProduceError",n[n.WorkflowExecutionCancelled=18]="WorkflowExecutionCancelled",n[n.WorkflowTimeout=19]="WorkflowTimeout",n[n.SequenceOutOfOrder=20]="SequenceOutOfOrder",n[n.WorkflowResultsCancelled=21]="WorkflowResultsCancelled",n[n.WorkflowExecutionThrottled=22]="WorkflowExecutionThrottled",n[n.InvalidInputQuantityForSingleItemWorkflow=23]="InvalidInputQuantityForSingleItemWorkflow"})(ee||(ee={}));var Es=new Set(Object.keys(ee).filter(function(n){return typeof ee[n]=="number"})),Tc=function(o){return Es.has(o)?ee[o]:o.indexOf("Timeout sending request")!==-1?ee.TimedOutSendingRequestToWorkflowProcess:o.indexOf("PubSub.produce Error")!==-1?ee.PubSubProduceError:ee.WorkflowExecutionFailed},Av=function(o){switch(o){case ee.SnapshotStorageNotInitialized:case ee.FailedToRetrieveDataFromSnapshot:case ee.TooManyItemsToExecuteReduceWorkflow:case ee.NoAcceptableTransportAvailable:case ee.FailedToZipInput:case ee.TimedOutSendingRequestToWorkflowProcess:case ee.PubSubProduceError:case ee.WorkflowExecutionCancelled:return!0;case ee.WorkflowExecutionFailed:case ee.WorkflowDisabled:case ee.WorkflowWrongAnnotationType:case ee.FailedAnnotationApply:case ee.ApplyAnnotationsException:case ee.AnnotationsNotArray:case ee.UnexpectedOutput:case ee.OutputIsNotAnnotation:case ee.MixedOutput:case ee.UnknownAnnotationParent:case ee.WorkflowTimeout:case ee.SequenceOutOfOrder:default:return!1}};h();var Ho;(function(n){n.JsClient="C",n.Server="S"})(Ho||(Ho={}));h();var Nv=w(at()),po=w(Se()),Mc=w(R()),bc=w(B());h();var Ic=w(_n()),_c=w(R()),Ac=w(B());var L_=function(){function n(o,e,r,t){(0,_c.default)(this,n),this.item=o,this.subtreeRootItem=r,this.subtreeRootModelIteratorItem=t,this.createIteratorCallback=e}return(0,Ac.default)(n,[{key:"schema",get:function(){return this.item.schema}},{key:"id",get:function(){return this.item.id}},{key:"operation",get:function(){return this.item.operation}},{key:"delta",get:function(){return this.item.delta}},{key:"deltas",get:function(){return this.item.deltas}},{key:"isContext",get:function(){return this.item.isContext}},{key:"asyncBoundary",get:function(){return this.item.asyncBoundary}},{key:"revId",get:function(){return this.item.revId}},{key:"getModelIterator",value:function(){if(this.asyncBoundary)return this.createIteratorCallback(this);throw new Error("An iterator can be created only for async boundary items")}},{key:"getSourceTimestamp",value:function(){return this.item.getSourceTimestamp()}},{key:"getContextId",value:function(){return this.item.getContextId()}},{key:"getBody",value:function(){return this.item.getBody()}},{key:"getItemReference",value:function(){return this.item.getItemReference()}},{key:"getParentItem",value:function(e){var r=this.item.getParentItem(e);if(r===void 0){if(this.subtreeRootModelIteratorItem!==void 0)return this.subtreeRootModelIteratorItem.getParentItem(e);r=this.subtreeRootItem.getParentItem(e)}return this.createIteratorItem(r)}},{key:"getParentItemBody",value:function(e){var r;return(r=this.getParentItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getChildItem",value:function(e){var r=this.item.getChildItem(e);return this.createIteratorItem(r)}},{key:"getChildItemBody",value:function(e){return this.item.getChildItemBody(e)}},{key:"getChildItems",value:function(e){var r=this;return this.item.getChildItems(e).map(function(t){return r.createIteratorItem(t)})}},{key:"getChildItemBodies",value:function(e){return this.item.getChildItemBodies(e)}},{key:"getSubtreeItem",value:function(e){var r=this.item.getSubtreeItem(e);return this.createIteratorItem(r)}},{key:"getSubtreeItemBody",value:function(e){return this.item.getSubtreeItemBody(e)}},{key:"getSubtreeItems",value:function(e){var r=this;return this.item.getSubtreeItems(e).map(function(t){return r.createIteratorItem(t)})}},{key:"getSubtreeItemBodies",value:function(e){return this.item.getSubtreeItemBodies(e)}},{key:"getContextItem",value:function(e){var r=this.item.getContextItem(e);return this.createIteratorItem(r)}},{key:"getContextItemBody",value:function(e){return this.item.getContextItemBody(e)}},{key:"getContextItems",value:function(e){var r=this;return this.item.getContextItems(e).map(function(t){return r.createIteratorItem(t)})}},{key:"getContextItemBodies",value:function(e){return this.item.getContextItemBodies(e)}},{key:"addAnnotation",value:function(e,r){var t=this.item.addAnnotation(e,r);return this.createIteratorItem(t)}},{key:"updateAnnotation",value:function(e,r){this.item.updateAnnotation(e,r)}},{key:"deleteAnnotation",value:function(e){return this.item.deleteAnnotation(e)}},{key:"createIteratorItem",value:function(e){return e===void 0?void 0:new n(e,this.createIteratorCallback,this.subtreeRootItem,this.subtreeRootModelIteratorItem)}}]),n}(),bv=function(){function n(o,e,r,t,a,s,u){(0,_c.default)(this,n);var l;this.subtreeRootItem=o,this.parentModel=e,this.asyncBoundaryLoader=r,this.hasUnreadItems=this.subtreeRootItem.getChildItem()!==void 0,this.subtreeRootModelIteratorItem=s,this.endReached=!1,this.truncationContext=t,this.truncated=((l=t==null?void 0:t.truncatedItemPathKeys)===null||l===void 0?void 0:l.indexOf(this.subtreeRootItem.id))>=0,this.pageSize=a,this.modelUnloadedCallback=u}return(0,Ac.default)(n,[{key:"getNextPage",value:function(){var o=(0,Ic.default)(function*(){if(this.endReached)return Promise.resolve([]);if(!this.hasUnreadItems&&this.truncated){var r=yield this.asyncBoundaryLoader.loadSubtree(new bi({pageSize:this.pageSize,rootItemPath:this.subtreeRootItem.getItemReference().referencedPath,lastItemPathKey:this.lastItemPathKey})),t=this.parentModel.createSubModel(this.subtreeRootItem);t.addItems(r.items);for(var a of r.existingAnnotations)t.getItemByReference({referencedPath:a.parentPath}).addAnnotation(a.body);this.lastItemPathKey=r.lastItemPathKey,this.subtreeRootItem=t.scopeItem,this.currentSubModel&&(this.currentSubModel.commitPendingAnnotations(),this.modelUnloadedCallback(this.currentSubModel)),this.currentSubModel=t,this.endReached=r.endReached}for(var s=this.subtreeRootItem.getChildItems(),u=new Array(s.length),l=this.createIterator.bind(this),f=0;f<u.length;f++)u[f]=new L_(s[f],l,this.subtreeRootItem,this.subtreeRootModelIteratorItem);return this.hasUnreadItems=!1,this.truncated||(this.endReached=!0),Promise.resolve(u)});function e(){return o.apply(this,arguments)}return e}()},{key:"forEach",value:function(){var o=(0,Ic.default)(function*(r){for(var t=yield this.getNextPage(),a=!1,s=function(){a=!0};t.length>0;){for(var u=0;!a&&u<t.length;u++){var l=r(t[u],s);l instanceof Promise&&(yield l)}if(a)break;t=yield this.getNextPage()}});function e(r){return o.apply(this,arguments)}return e}()},{key:"createIterator",value:function(e){var r;return new n(e.item,(r=this.currentSubModel)!==null&&r!==void 0?r:this.parentModel,this.asyncBoundaryLoader,this.truncationContext,this.pageSize,e,this.modelUnloadedCallback)}}]),n}();var Ev=new G("pullWorkflowModelPageSize",11e3),Dv=Symbol("workflowModel"),tt=Symbol("workflowModelItem"),Tr=function(o){if(!o)return function(e){return e[tt]!==void 0};if(typeof o=="function")return function(e){return e[tt]&&o(e[tt])};if((o.id?1:0)+(o.ids?1:0)+(o.itemType?1:0)+(o.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");return o.id?function(e){return e[tt]&&o.id===e[tt].internalId}:o.ids?function(e){return e[tt]&&o.ids.indexOf(e[tt].internalId)>=0}:o.itemType?function(e){return e[tt]&&y.matchesTypesFor(e.body,[o.itemType])}:function(e){return e[tt]&&y.matchesTypesFor(e.body,o.itemTypes)}},F_=function(){function n(o,e,r,t,a,s,u,l){(0,Mc.default)(this,n),this.model=o,this.item=e,this.isNew=a,this.isContext=s,this.operation=e.op,this.delta=e.delta,this.deltas=e.deltas,this.loadSubtreeCallback=r,this.createIteratorCallback=t,this.resolveSchemaItemCallback=u,this.getNextAnnotationId=l}return(0,bc.default)(n,[{key:"id",get:function(){if(this.isNew)throw new Error("Cannot provide id for newly added annotation");return this.internalId}},{key:"internalId",get:function(){return this._id||(this._id=H(this.itemPath)),this._id}},{key:"revId",get:function(){return this.item.revId}},{key:"asyncBoundary",get:function(){var e;return(e=this.schema)===null||e===void 0?void 0:e.asyncBoundary}},{key:"schema",get:function(){var e;return(e=this._schema)!==null&&e!==void 0?e:this._schema=this.resolveSchemaItemCallback?this.resolveSchemaItemCallback(this):void 0}},{key:"workflowModel",get:function(){return this.model[Dv]}},{key:"itemPath",get:function(){return this._itemPath||(this._itemPath=[].concat((0,po.default)(this.item.parentPath),[this.item.id])),this._itemPath}},{key:"getModelIterator",value:function(){if(this.asyncBoundary)return this.createIteratorCallback(this);throw new Error("An iterator can be created only for async boundary items")}},{key:"getBody",value:function(){return this.item.body}},{key:"getItemReference",value:function(){if(this.isNew)throw new Error("Cannot provide IItemReference for newly added annotation");return{referencedPath:(0,po.default)(this.itemPath)}}},{key:"getParentItem",value:function(e){var r=Tr(e),t=void 0;return this.model.visitItemPathSync(this.item.parentPath,function(a){r(a)&&(t=a[tt])}),t}},{key:"getParentItemBody",value:function(e){var r;return(r=this.getParentItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getPrevItem",value:function(e,r){var t=this.getSubtreeItemsForSiblingIteration(e,r),a=t.indexOf(this.item)-1;if(a>=0)return t[a][tt]}},{key:"getPrevItemBody",value:function(e,r){var t;return(t=this.getPrevItem(e,r))===null||t===void 0?void 0:t.getBody()}},{key:"getNextItem",value:function(e,r){var t=this.getSubtreeItemsForSiblingIteration(e,r),a=t.indexOf(this.item)+1;if(a>0&&a<t.length)return t[a][tt]}},{key:"getNextItemBody",value:function(e,r){var t;return(t=this.getNextItem(e,r))===null||t===void 0?void 0:t.getBody()}},{key:"getChildItem",value:function(e){var r=Tr(e),t=[];return this.accumulateChildWorkflowModelItems(r,this.itemPath,t,!0),t[0]}},{key:"getChildItemBody",value:function(e){var r;return(r=this.getChildItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getChildItems",value:function(e){var r=Tr(e),t=[];return this.accumulateChildWorkflowModelItems(r,this.itemPath,t),t}},{key:"getChildItemBodies",value:function(e){return this.getChildItems(e).map(function(r){return r.getBody()})}},{key:"getSubtreeItem",value:function(e){return this.getSubtreeWorkflowModelItems(Tr(e),this.itemPath,!0)[0]}},{key:"getSubtreeItemBody",value:function(e){var r;return(r=this.getSubtreeItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getSubtreeItems",value:function(e){return this.getSubtreeWorkflowModelItems(Tr(e),this.itemPath)}},{key:"getSubtreeItemBodies",value:function(e){return this.getSubtreeItems(e).map(function(r){return r.getBody()})}},{key:"getContextItem",value:function(e){var r;return(r=this.getContextItems(e))===null||r===void 0?void 0:r[0]}},{key:"getContextItemBody",value:function(e){var r;return(r=this.getContextItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getContextItems",value:function(e){var r=this,t=Tr(e),a=function(l){var f=(0,po.default)(l.getItemReference().referencedPath);return f.splice(-1),ar(f,r.itemPath)},s=function(l){return t(l.item)&&a(l)};return this.workflowModel.getItems(s)}},{key:"getContextItemBodies",value:function(e){return this.getContextItems(e).map(function(r){return r.getBody()})}},{key:"addAnnotation",value:function(e,r){if(r!=null&&r.immediate){this.workflowModel.commitImmediateAnnotation(this.item,e);return}var t={id:this.getNextAnnotationId(),body:e,parentPath:this.itemPath};return this.model.addItems(function(){},this.itemPath,[t]),t[tt]=new n(this.model,t,this.loadSubtreeCallback,void 0,!0,void 0,this.resolveSchemaItemCallback,this.getNextAnnotationId),this.workflowModel.setPendingAnnotationType(this.item,y.getTypeNameFor(e)),t[tt]}},{key:"updateAnnotation",value:function(e,r){if(y.getTypeNameFor(e)!==y.getTypeNameFor(this.item.body))throw new Error("WorkflowModelItem.update: Must update annotation with another body of the same type");var t=this.getParentItemForAnnotationOperations("update",r);this.item.body=e,this.model.updateItems(function(){},this.item.parentPath,[this.item]),this.workflowModel.setPendingAnnotationType(t,y.getTypeNameFor(this.item.body))}},{key:"deleteAnnotation",value:function(e){var r=this.getParentItemForAnnotationOperations("delete",e);this.model.deleteItems(function(){},this.item.parentPath,[this.item]),this.workflowModel.setPendingAnnotationType(r,y.getTypeNameFor(this.item.body)),this.item.body=void 0}},{key:"loadSubtree",value:function(e){return this.loadSubtreeCallback(this.itemPath,e)}},{key:"getSourceTimestamp",value:function(){return this.item.sourceTimestamp}},{key:"getContextId",value:function(){return this.item.contextId}},{key:"accumulateChildWorkflowModelItems",value:function(e,r,t,a){var s=this.model.getItemChildren(r);for(var u of s)if(u[tt]){if(e(u)&&(t.push(u[tt]),a))return!1}else if(Q("FixStubsFromStoppingIteratingTheChildren")){if(!this.accumulateChildWorkflowModelItems(e,[].concat((0,po.default)(u.parentPath),[u.id]),t,a))return!1}else if(this.accumulateChildWorkflowModelItems(e,[].concat((0,po.default)(u.parentPath),[u.id]),t,a))return!1;return!0}},{key:"getParentItemForAnnotationOperations",value:function(e,r){if(r!=null&&r.immediate)throw new Error(`WorkflowModelItem.${e}Annotation: Unsupported option`);var t=this.item.parentPath.length>0?this.model.getItem(this.item.parentPath):void 0;if(!t||t[tt]===void 0)throw new Error(`WorkflowModelItem.${e}Annotation: Parent must exist in workflow model`);return t}},{key:"getSubtreeItemsForSiblingIteration",value:function(e,r){var t=Tr(e);if(!t(this.item))throw new Error("Sibling filter must match current item");var a=this.getParentItem(r).itemPath;return this.model.getSubtreeItems(a,t).slice(1)}},{key:"getSubtreeWorkflowModelItems",value:function(e,r,t){var a=this.model.getSubtreeItems(r,e);if(a.length>0&&a[0]===this.item&&(a=a.slice(1)),a.length===0)return[];for(var s=new Array(t?1:a.length),u=0;u<s.length;u++)s[u]=a[u][tt];return s}}]),n}(),Pv=function(){function n(o,e,r,t,a,s,u,l,f){(0,Mc.default)(this,n),this.pendingAnnotationTypesByParentItem=new Map,this.childModels=new Set,this.asyncBoundaryLoader=t,a&&(this.workflowModelItemSchemaResolver=s==null?void 0:s.create(a)),this.workflowModelItemSchemaResolverFactory=s,this.truncationContext=u,this.model=new co,this.model[Dv]=this,this._scopeItem=o,this.modelOptions=f,this.addItemCallback=r,this.getNextAnnotationId=l!=null?l:this.model.getNextAnnotationId.bind(this.model),this.addItems([o]),this.setAnnotations=e}return(0,bc.default)(n,[{key:"scopeItem",get:function(){return this._scopeItem[tt]}},{key:"rootItem",get:function(){return this.scopeItem}},{key:"addItems",value:function(e,r){var t,a;if((e==null?void 0:e.length)>0){var s=this.loadSubtree.bind(this),u=this.createWorkflowModelIterator.bind(this),l=(a=(t=this.workflowModelItemSchemaResolver)===null||t===void 0?void 0:t.resolve)===null||a===void 0?void 0:a.bind(this.workflowModelItemSchemaResolver);for(var f of e)this.addItemCallback&&this.addItemCallback(f),this.model.addItems(function(){},f.parentPath,[f]),f[tt]=new F_(this.model,f,s,u,void 0,r,l,this.getNextAnnotationId)}}},{key:"setPendingAnnotationType",value:function(e,r){if(this.immediateAnnotationParentItem)throw new Error("Mixing immediate and non-immediate annotations is not supported");var t=this.pendingAnnotationTypesByParentItem.get(e)||[];t.indexOf(r)<0&&t.push(r),this.pendingAnnotationTypesByParentItem.set(e,t)}},{key:"commitImmediateAnnotation",value:function(e,r){if(this.pendingAnnotationTypesByParentItem.size>0)throw new Error("Mixing immediate and non-immediate annotations is not supported");if(this.immediateAnnotationParentItem&&this.immediateAnnotationParentItem!==e)throw new Error("Adding immediate annotations under different parents is not supported");this.setAnnotations(e,y.getTypeNameFor(r),[r],{immediate:!0}),this.immediateAnnotationParentItem=e}},{key:"commitPendingAnnotations",value:function(){for(var e of this.pendingAnnotationTypesByParentItem){var r=(0,Nv.default)(e,2),t=r[0],a=r[1];for(var s of a){var u=this.model.getItemChildren([].concat((0,po.default)(t.parentPath),[t.id]),[s]);u&&u.length>0&&this.setAnnotations(t,s,u.map(function(f){return f.body}))}}for(var l of this.childModels)l.commitPendingAnnotations()}},{key:"getItem",value:function(e){return this.getItems(e)[0]}},{key:"getItems",value:function(e){return this.model.getSubtreeItems([],Tr(e)).map(function(r){return r[tt]})}},{key:"getItemBody",value:function(e){var r;return(r=this.getItem(e))===null||r===void 0?void 0:r.getBody()}},{key:"getItemBodies",value:function(e){return this.getItems(e).map(function(r){return r.getBody()})}},{key:"getItemByReference",value:function(e){var r;if(((r=e==null?void 0:e.referencedPath)===null||r===void 0?void 0:r.length)>0){var t=this.model.getItem(e.referencedPath);if(t)return t[tt]}}},{key:"getItemBodyByReference",value:function(e){var r;return(r=this.getItemByReference(e))===null||r===void 0?void 0:r.getBody()}},{key:"createWorkflowModelIterator",value:function(e){var r,t=void 0;if(this.asyncBoundaryLoader?this.asyncBoundaryLoader.kind!==Fr.ModelIterating?t=`loadSubtree must be called for the asyncBoundaryLoader of kind 'ModelIterating'. Actual kind is ${this.asyncBoundaryLoader.kind}`:e.asyncBoundary||(t="An iterator can be created only for the items with asyncBoundary === true"):t="asyncBoundaryLoader is not defined",t)throw m.error(509092948,v.CoreDefault,t),new Error(t);var a;return!((r=this.modelOptions)===null||r===void 0)&&r.maxModelItems?a=Math.min(this.modelOptions.maxModelItems,Ev.getValue()):a=Ev.getValue(),new bv(e,this,this.asyncBoundaryLoader,this.truncationContext,a,void 0,this.onChildModelUnloaded.bind(this))}},{key:"createSubModel",value:function(e){var r=this.model.getItem(Wn(e.id)),t=new n(r,this.setAnnotations,this.addItemCallback,this.asyncBoundaryLoader,[e.schema],this.workflowModelItemSchemaResolverFactory,this.truncationContext,this.getNextAnnotationId,this.modelOptions);return this.childModels.add(t),t}},{key:"onChildModelUnloaded",value:function(e){this.childModels.delete(e)}},{key:"loadSubtree",value:function(e,r){var t=this,a=new E({operationName:"WorkflowModelLoadSubtree",success:!0,resultDescription:e.join("/")},{metricDuration:!0,metricCount:!0}).start(),s=void 0;if(this.asyncBoundaryLoader?this.asyncBoundaryLoader.kind!==Fr.Filtering&&(s=`loadSubtree must be called for the asyncBoundaryLoader of kind 'Filtering'. Actual kind is ${this.asyncBoundaryLoader.kind}`):s="asyncBoundaryLoader is not defined",s)throw a.success=!1,a.resultSignature=`${s}`,m.error(526952588,v.CoreDefault,a.stop()),new Error(s);var u=this.asyncBoundaryLoader;return u.loadSubtree(new Mi({rootItemPath:e,filter:r})).then(function(l){l.forEach(function(f){f.parentPath=e}),t.addItems(l),a.success=!0,a.count=l.length,a.resultSignature="items loaded successfully",m.metric(526952589,v.CoreDefault,a.stop())}).catch(function(l){return a.success=!1,a.resultSignature="items loaded failed",a.resultDescription+=`
${l}`,m.error(526952590,v.CoreDefault,a.stop()),Promise.reject(l)})}}]),n}();h();var Qo=w(_n()),Py=w(R()),Ry=w(B());h();var Vv=w(R()),Qv=w(B()),Jv=w(ys()),jv=w(ze()),Kv=w(Ve()),Bs=w(Oe());h();var Fv=w(R()),qv=w(B());h();var Nc=w(Se());var Ec=new Map,w1=new G("workflowSynchronizationInterval",10),Ns=function(o){if(!o||!o.startsWith)return o;if(!Ec.has(o)){var e="Workflows/",r=o.startsWith(e)?o.substring(e.length):o;return Ec.set(o,r),r}return Ec.get(o)};var Bv=function(o,e){return!(e&&e.includeExistingAnnotations&&o)},Wv=function(o,e,r){if(!o||e===void 0)return!0;r!=null||(r=[]);for(var t of e)if(!r.includes(t))return!1;return!0},Ov=function(o,e){o=o!=null?o:[],e=e!=null?e:[];var r=Array.from(new Set(o)).sort(),t=Array.from(new Set(e)).sort();if(r.length!==t.length)return!1;for(var a=0;a<r.length;a++)if(r[a]!==t[a])return!1;return!0},Rv=[y.getTypeName(),At.getTypeName(),Jt.getTypeName()],Ds=function(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,r=new Set;for(var t of o)if(typeof t=="string")Rv.includes(t)||r.add(t);else{var a=e?[t.getTypeName()].concat((0,Nc.default)(t.getBaseTypes())):[t.getTypeName()];for(var s of a)Rv.includes(s)||r.add(s)}return(0,Nc.default)(r)};var Dc=function(o,e,r){if(e!==r){if(e===void 0){o.push(r);return}if(r===void 0){o.splice(o.indexOf(e),1);return}var t=o.indexOf(e);o[t]=r}};function Lv(n,o){var e=function(t){return typeof t=="number"};if(o.some(e)){if(!o.every(e))throw new Error(`Expected AuthTokenType[] or AuthTokenOptions[] but found a mix in workflow ${n}`);return!0}return!1}var $v=function(){function n(o,e){(0,Fv.default)(this,n);var r,t,a,s;this.visibility=qr.Default,this.id=o,this.resourceId=Ns(o),e&&(this.requestedContextTypesRules=(r=e.requestedContextTypesRules)!==null&&r!==void 0?r:this.requestedContextTypesRules,this.eventSequenceOptions=(t=e.eventSequenceOptions)!==null&&t!==void 0?t:this.eventSequenceOptions,this.activationUserConfigs=(a=e.activationUserConfigs)!==null&&a!==void 0?a:this.activationUserConfigs,this.requiredTokenOptions=(s=e.requiredTokenOptions)!==null&&s!==void 0?s:this.requiredTokenOptions)}return(0,qv.default)(n,[{key:"validateOptions",value:function(){return{isValid:!0}}},{key:"setRequestedContexts",value:function(e){var r;return this.requestedContextTypesRules=((r=this.requestedContextTypesRules)!==null&&r!==void 0?r:this.requestedContextTypesRules=[]).concat(e),this}},{key:"setEventSequenceOptions",value:function(e){return this.eventSequenceOptions=e,this}},{key:"setActivationUserConfigs",value:function(e){return this.activationUserConfigs=e,this}}]),n}();h();var Ps=w(B()),Rs=w(R());var q_=(0,Ps.default)(function n(o,e){(0,Rs.default)(this,n),this.name=o,this.defaultValue=e}),Gv=(0,Ps.default)(function n(o,e){(0,Rs.default)(this,n),this.type=on.MaxInputCount,typeof o=="number"?this.maxCount=o:o instanceof q_&&(this.setting=o),this.action=e}),Uv=(0,Ps.default)(function n(o,e){(0,Rs.default)(this,n),this.type=on.UILanguage,o instanceof Array?this.languages=o:this.setting=o,this.action=e});function $_(n){var o=G_();return function(){var r=(0,Bs.default)(n),t;if(o){var a=(0,Bs.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Kv.default)(this,t)}}function G_(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Hv=Symbol("maxInputCountPrefilter"),zv=Symbol("languagesPrefilter"),Ws=function(n){(0,jv.default)(e,n);var o=$_(e);function e(r,t){var a;(0,Vv.default)(this,e);var s,u,l,f,c,d,p,g,k,S,x,C,T,I,_,M,A,b,N,z,L;return a=o.call(this,r,t),a.kind=U.Reduce,a.priority=0,a.activationConfigs=[{clientAppName:"All",clientAppPlatform:"All",activationTier:Sn.Default}],a.inputStage=Ut.All,a.minDelayMs=1e3,a.maxDelayMs=5e3,a.isStateful=!1,a.bypassModel=!1,a.bypassTypes=void 0,a.fetchExistingAnnotations=!1,a.billingDomain=Ya.Default,t&&(a.priority=(s=t.priority)!==null&&s!==void 0?s:a.priority,a.inputTypes=(u=t.inputTypes)!==null&&u!==void 0?u:a.inputTypes,a.outputTypes=(l=t.outputTypes)!==null&&l!==void 0?l:a.outputTypes,a.inputStage=(f=t.inputStage)!==null&&f!==void 0?f:a.inputStage,a.isStateful=(c=t.isStateful)!==null&&c!==void 0?c:a.isStateful,a.activationConfigs=(d=t.activationConfigs)!==null&&d!==void 0?d:a.activationConfigs,a.triggerSignals=(p=t.triggerSignals)!==null&&p!==void 0?p:a.triggerSignals,a.requiredTokenTypes=(g=t.requiredTokenTypes)!==null&&g!==void 0?g:a.requiredTokenTypes,a.activationFlightsConfigs=(k=t.activationFlightsConfigs)!==null&&k!==void 0?k:a.activationFlightsConfigs,a.isAppOnlyTokenAllowed=(S=t.isAppOnlyTokenAllowed)!==null&&S!==void 0?S:a.isAppOnlyTokenAllowed,a.triggerConditions=(x=t.triggerConditions)!==null&&x!==void 0?x:a.triggerConditions,a.minDelayMs=(C=t.minDelayMs)!==null&&C!==void 0?C:a.minDelayMs,a.maxDelayMs=(T=t.maxDelayMs)!==null&&T!==void 0?T:a.maxDelayMs,a.maxExecutionTimeInS=(I=t.maxExecutionTimeInS)!==null&&I!==void 0?I:a.maxExecutionTimeInS,a.collectionScopeType=(_=t.collectionScopeType)!==null&&_!==void 0?_:a.collectionScopeType,a.bypassModel=(M=t.bypassModel)!==null&&M!==void 0?M:a.bypassModel,a.bypassTypes=(A=t.bypassTypes)!==null&&A!==void 0?A:a.bypassTypes,a.fetchExistingAnnotations=(b=t.fetchExistingAnnotations)!==null&&b!==void 0?b:a.fetchExistingAnnotations,a.modelOptions=(N=t.modelOptions)!==null&&N!==void 0?N:a.modelOptions,a.definitionOverrideTargetWorkflows=(z=t.definitionOverrideTargetWorkflows)!==null&&z!==void 0?z:a.definitionOverrideTargetWorkflows,a.billingDomain=(L=t.billingDomain)!==null&&L!==void 0?L:a.billingDomain),a}return(0,Qv.default)(e,[{key:"setPriority",value:function(t){return this.priority=t,this}},{key:"setActivationConfigs",value:function(t){return this.activationConfigs=t,this}},{key:"setCollectionScopeType",value:function(t){return this.collectionScopeType=t,this}},{key:"setInputTypes",value:function(t){return this.inputTypes=Ds(t,!1),this}},{key:"setInputStage",value:function(t){return this.inputStage=t,this}},{key:"setTriggerSignals",value:function(t){return this.triggerSignals=t,this}},{key:"setOutputTypes",value:function(t){return this.outputTypes=Ds(t),this}},{key:"setTriggerConditions",value:function(t){return this.triggerConditions=t,this}},{key:"setMinDelayTime",value:function(t){return this.minDelayMs=t?Math.max(0,t):void 0,this}},{key:"setMaxDelayTime",value:function(t){return this.maxDelayMs=t?Math.max(0,t):void 0,this}},{key:"setMaxExecutionTime",value:function(t){return this.maxExecutionTimeInS=t,this}},{key:"setStateful",value:function(){return this.isStateful=!0,this}},{key:"setStateExpiryMs",value:function(t){return this.stateExpiryMs=t,this}},{key:"setLambdaType",value:function(t){return this.factory=function(){return new t},this}},{key:"setLambda",value:function(t){return this.factory=function(){return{execute:t,dispose:function(){}}},this}},{key:"setRequiredTokenTypes",value:function(t){return Lv(this.id,t)?this.requiredTokenTypes=t:this.requiredTokenOptions=t,this}},{key:"setOptionalTokenTypes",value:function(t){return this.optionalTokenTypes=t,this}},{key:"setActivationFlightsConfigs",value:function(t){return this.activationFlightsConfigs=t,this}},{key:"setIsAppOnlyTokenAllowed",value:function(t){return this.isAppOnlyTokenAllowed=t,this}},{key:"setBypassModel",value:function(t){return this.bypassModel=!0,t&&(this.bypassTypes=Ds(t)),this}},{key:"setFetchExistingAnnotations",value:function(){return this.fetchExistingAnnotations=!0,this}},{key:"setModelOptions",value:function(t){return this.modelOptions=t,this}},{key:"validateOptions",value:function(){var t=(0,Jv.default)((0,Bs.default)(e.prototype),"validateOptions",this).call(this);return t.isValid?Bv(this.bypassModel,this.modelOptions)?Wv(this.bypassModel,this.bypassTypes,this.outputTypes)?{isValid:!0}:{isValid:!1,errorMessage:"Types provided to 'setBypassModel' must be set in 'setOutputTypes'."}:{isValid:!1,errorMessage:"Option 'includeExistingAnnotations' can't be enabled if 'bypassModel' is enabled."}:t}},{key:"setDefinitionOverrideTargetWorkflows",value:function(t){return this.definitionOverrideTargetWorkflows=t,this}},{key:"setMaxInputCountPrefilter",value:function(t,a){var s,u=new Gv(t,a);return Dc((s=this.prefilters)!==null&&s!==void 0?s:this.prefilters=[],this[Hv],u),this[Hv]=u,this}},{key:"setSupportedLanguagesPrefilter",value:function(t,a){var s,u=new Uv(t,a);return Dc((s=this.prefilters)!==null&&s!==void 0?s:this.prefilters=[],this[zv],u),this[zv]=u,this}},{key:"setBillingDomain",value:function(t){return this.billingDomain=t,this}}],[{key:"create",value:function(t){return new e(t)}}]),e}($v);h();h();var gy=w(R()),hy=w(B()),Wc=w(Se()),my=w(_n());h();h();var Yv=w(R()),Zv=w(B()),ey=w(Xv()),Pc=";",Rc=":",J_=".";function go(n){if(!n)return new zo([],new Set,new Map,new Map);var o=n.split(Pc),e=new Set,r=new Map,t=new Map;for(var a of o){var s=a.trim();if(s!==""){e.add(zo.normalizeName(s));var u=s.split(Rc),l=(0,ey.default)(u),f=l[0],c=l.slice(1),d=c.join(Rc),p=zo.normalizeName(f);if(p){r.set(p,d);var g=zo.parseName(p);g&&g!==p&&t.set(g,p)}}}return new zo(o,e,r,t)}function Bc(n){if(!n)return"";var o=new Set,e=[];for(var r of n.split(Pc).reverse()){var t=r.split(Rc)[0],a=zo.normalizeName(t);o.has(a)||(o.add(a),e.push(r))}return e.reverse().join(Pc)}var zo=function(){function n(o,e,r,t){(0,Yv.default)(this,n),this.originalFlights=o,this.normalizedFlights=e,this.keyValueFlightsMap=r,this.parsedFlightsMap=t}return(0,Zv.default)(n,[{key:"hasFlight",value:function(e){var r=n.normalizeName(e),t=this.normalizedFlights.has(r),a=this.keyValueFlightsMap.has(r),s=this.parsedFlightsMap.has(r);return t||a||s}},{key:"getBooleanValue",value:function(e,r){var t,a,s=(t=this.getStringValue(e))===null||t===void 0?void 0:t.toLowerCase(),u=(a=this.getStringValue(this.parsedFlightsMap.get(n.normalizeName(e))))===null||a===void 0?void 0:a.toLowerCase();return s==="true"||u==="true"?!0:s==="false"||u==="false"?!1:r}},{key:"getIntValue",value:function(e,r){var t=this.getStringValue(e),a=Number.parseInt(t,10);return Number.isNaN(a)?r:a}},{key:"getStringValue",value:function(e,r){var t;return(t=this.keyValueFlightsMap.get(n.normalizeName(e)))!==null&&t!==void 0?t:r}},{key:"getAll",value:function(){return this.originalFlights}},{key:"getAllParsed",value:function(){var e=[];return this.keyValueFlightsMap.forEach(function(r,t){var a=r==null?void 0:r.toLowerCase();switch(a){case"true":e.push({name:t,value:!0});break;case"false":e.push({name:t,value:!1});break;default:{var s=Number.parseInt(a,10);Number.isNaN(s)?e.push({name:t,value:r}):e.push({name:t,value:s})}break}}),e}}],[{key:"normalizeName",value:function(e){return e==null?void 0:e.toLowerCase()}},{key:"parseName",value:function(e){var r=e==null?void 0:e.split(J_);return r?r[r.length-1]:void 0}}]),n}();h();var ha=w(_n()),ty=w(R()),ny=w(B());var ry=function(){function n(o,e,r){if((0,ty.default)(this,n),this.correlationValidator=r,!o)throw new Error("workflowMessageHandler is required");if(this.workflowMessageHandler=o,!e)throw new Error("executionContext is required");this.executionContext=e}return(0,ny.default)(n,[{key:"addMessages",value:function(){var o=(0,ha.default)(function*(r){return this.correlationValidator.validate("ChatStore.addMessages"),this.workflowMessageHandler.onChatStoreMessagesSet({messages:r,options:{operationType:Co.Add}},this.executionContext)});function e(r){return o.apply(this,arguments)}return e}()},{key:"updateMessages",value:function(){var o=(0,ha.default)(function*(r){return this.correlationValidator.validate("ChatStore.updateMessages"),this.workflowMessageHandler.onChatStoreMessagesSet({messages:r,options:{operationType:Co.Update}},this.executionContext)});function e(r){return o.apply(this,arguments)}return e}()},{key:"deleteMessages",value:function(){var o=(0,ha.default)(function*(r){this.correlationValidator.validate("ChatStore.deleteMessages");var t=r.map(function(a){return{id:a,content:""}});return this.workflowMessageHandler.onChatStoreMessagesSet({messages:t,options:{operationType:Co.Delete}},this.executionContext)});function e(r){return o.apply(this,arguments)}return e}()},{key:"getMessages",value:function(){var o=(0,ha.default)(function*(r){return this.correlationValidator.validate("ChatStore.getMessages"),this.workflowMessageHandler.onChatStoreMessagesGet({options:r},this.executionContext)});function e(r){return o.apply(this,arguments)}return e}()}]),n}();h();var sy=w(R()),uy=w(B());h();var oy=w(R()),iy=w(B());var ay=function(){function n(o,e){(0,oy.default)(this,n),this.schema=o,this.typeToSchemaItemsMap=e}return(0,iy.default)(n,[{key:"resolve",value:function(e){var r=this,t=y.getAllTypesFor(e.getBody()),a=t.map(function(c){return r.typeToSchemaItemsMap.get(c)}).filter(function(c){return c!==void 0});if(!a)throw m.error(509092953,v.CoreDefault,`Couldn't find a matching schema item. Item types: ${JSON.stringify(t)}, schema: ${JSON.stringify(this.schema)}`),new Error("Cannot find matching schema item");if(a.length===1&&a[0].length===1)return a[0][0];for(var s={child:void 0,schemaItem:void 0,itemTypes:t},u=void 0,l=e.getParentItem();l;){u=l;var f=s;s={child:f,schemaItem:void 0,itemTypes:y.getAllTypesFor(u.getBody())},l=u.getParentItem()}return this.resolveSchemaItem(s,this.schema)}},{key:"resolveSchemaItem",value:function(e,r){var t=r.find(function(a){return e.itemTypes.indexOf(a.type)!==-1});if(!e.child&&t)return t;if(!t||!t.children)throw m.error(509092952,v.CoreDefault,`Couldn't find a matching schema item. Item types: ${JSON.stringify(e.itemTypes)}, schema: ${JSON.stringify(this.schema)}`),new Error("Cannot find matching schema item");return this.resolveSchemaItem(e.child,t.children)}}]),n}();var ly=function(){function n(){(0,sy.default)(this,n)}return(0,uy.default)(n,[{key:"create",value:function(e){var r=new Map;return this.buildTypeToSchemaItemsMap(e,r),new ay(e,r)}},{key:"buildTypeToSchemaItemsMap",value:function(e,r){for(var t of e.filter(function(s){return s.role===Za.Input})){var a=r.get(t.type);a||(a=[],r.set(t.type,a)),a.push(t),t.children&&this.buildTypeToSchemaItemsMap(t.children,r)}}}]),n}();h();var fy=w(R()),cy=w(B()),dy=function(){function n(){var o=this;(0,fy.default)(this,n),this.abortController=new AbortController,this.cancellationDetails=void 0,this.cancellationPromise=new Promise(function(e){o.resolveCancellationPromise=e})}return(0,cy.default)(n,[{key:"abortSignal",get:function(){return this.abortController.signal}},{key:"isCancelled",get:function(){return this.abortSignal.aborted}},{key:"markAsCancelled",value:function(e,r){this.cancellationDetails={reason:e,reasonDetails:r},this.abortController.abort(this.cancellationDetails),this.resolveCancellationPromise()}}]),n}();var j_=new G("workflowSequencerEnabled",!0),K_=new G("workflowSequencerDisabledWorkflows",[]),X_=new G("workflowDeactivateTokensDisabledWorkflows",["ChangeSummaries","Copywriter","Voice","WritersUnblock"]),Y_=new G("workflowDefaultTimeout",8e3),py=new Set,Z_=new G("getAnnotationsTimeoutMs",8e3),vy=function(o,e){var r,t,a,s,u=o.workflow,l=o.workflowMessageHandler,f=o.executionContext,c=o.input,d=o.clientMetadata,p=o.getTokenCallback,g=o.stateCache,k=o.asyncBoundaryLoader,S=o.getSessionInfo,x=o.getWorkflowStoreManager,C=o.correlationValidator,T=!1,I=(t=(r=c.scopeItem)===null||r===void 0?void 0:r.contextId)!==null&&t!==void 0?t:(s=(a=c.inputItems)===null||a===void 0?void 0:a[0])===null||s===void 0?void 0:s.contextId;ss(function(){var _=(0,my.default)(function*(M){var A;m.debug(512336708,v.CoreDefault,function(){return`executeWorkflow id: ${u.id}, inputs count: ${c.inputItems?c.inputItems.length:-1}`});var b=new E({operationName:"ExecuteWorkflowOnService",resourceId:u.resourceId,joinContextId:I!=null?I:""}).start(),N=c.scopeItem||(c.inputItems&&c.inputItems.length>=1?c.inputItems[0]:void 0),z=(k==null?void 0:k.kind)!==Fr.ModelIterating,L=z?new Map:void 0;if(N&&z&&(N.parentPath||m.error(512336707,v.CoreDefault,`Missing scope item parent. Workflow: ${u.id}. Type: ${y.getTypeNameFor(N.body)}`),L.set(N.body,N)),Array.isArray(c.inputItems)&&z)for(var J of c.inputItems)J&&J.body&&(J.parentPath||m.error(512336706,v.CoreDefault,`Missing parent. Workflow: ${u.id}. Type: ${y.getTypeNameFor(J.body)}`),L.set(J.body,J));if(Q("ImplementSignalWithPath")&&c.triggerSignals)for(var P of c.triggerSignals){var D=P;if(D.signalPath){var O={id:D.signalPath.at(-1),parentPath:D.signalPath.slice(0,-1),body:P,sourceInfo:D.sourceInfo};L.set(D,O)}}var $=[],F=N?[].concat((0,Wc.default)(N.parentPath),[N.id]):void 0,q=void 0,W=function(oe){C.validate("executeWorkflowWithCallback.submitSignals"),Le(function(){var j=new E({operationName:"submitSignalsAction",resourceId:u.id,success:!0});for(var ge of oe){var fe=y.getTypeNameFor(ge);y.matchesTypesFor(ge,[Jt.getTypeName()])||(j.resultDescription=`Workflow produced an output that is not an signal (${y.getTypeNameFor(ge)})`,m.info(512336705,v.CoreDefault,j)),(!u.outputTypes||u.outputTypes.indexOf(fe)===-1)&&(j.resultDescription=`Workflow said it would output one of [${u.outputTypes}] but instead output ${fe}`,m.info(512336704,v.CoreDefault,j)),ge.timestamp&&(py.has(u.id)||(py.add(u.id),j.resultDescription=`Workflow "${u.id}" sets signal.timeStamp`,m.info(509212802,v.CoreDefault,j)))}var ce=oe.map(function($e){return{id:an(),source:u.id,body:$e,contextId:I}}),qe=new ot({parentPath:["session"],items:ce}),dt=new Be({cv:M.cv.toString(),ops:[qe]}),rt=JSON.stringify(ce.map(function($e){var nn,Wr;return{id:$e.id,type:(Wr=(nn=$e.body)===null||nn===void 0?void 0:nn.H_)===null||Wr===void 0?void 0:Wr.T_}}));m.debug(512336675,v.CoreDefault,`Publishing message for triggering signals ${rt}.`),l.onMessage(dt,f).then(function(){m.debug(512336674,v.CoreDefault,`Signals ${rt} successfully triggered.`)}).catch(function($e){m.error(512336673,v.CoreDefault,`Error sending signals ${rt}: ${$e}.`)})},M)},K=function(oe,j,ge){C.validate("executeWorkflowWithCallback.overrideWorkflowDefinition"),Le(function(){var fe;switch(ge){case wr.JoinContext:{if(!N.contextId){var ce="ContextId is not defined for this scope item.";throw m.error(512336672,v.CoreDefault,ce),new Error(ce)}fe=N.contextId;break}case wr.Session:{fe=void 0;break}default:{var qe="Defined scope is not supported. "+ge;throw m.error(512336671,v.CoreDefault,qe),new Error(qe)}}var dt=new rr({definition:j,contextId:fe,sourceWorkflowId:u.id,targetWorkflowId:oe});l.onMessage(dt,f).catch(function(rt){m.error(512336670,v.CoreDefault,`Error overriding config for workflow: ${oe}, contextId: ${N.contextId}: ${rt}.`)})},M)},X=function(oe){q=oe},re=function(oe,j,ge,fe){C.validate("executeWorkflowWithCallback.setItemAnnotations"),Le(function(){if(u.isStateful){var ce=g.getAnnotationSequenceGenerator(u,f.sessionKey,f.userId);ce==null||ce.generate(ge)}var qe=Ct(oe,j,ge,fe);if(fe&&fe.immediate){var dt=new E({operationName:"SetImmediateAnnotations",resourceId:u.id,success:!0}).start(),rt=new da({workflow:u,scopeItemPath:F,scopeItemRevId:N==null?void 0:N.revId,annotationQueue:[qe]});if(l.onAnnotationResult(rt,f).catch(function($e){var nn=`Error posting annotations: ${$e}`;m.error(512336669,v.CoreDefault,nn),dt.success=!1,dt.resultDescription=nn}).finally(function(){m.info(507339521,v.CoreDefault,dt.stop())}),Os(u,j))return}$.push(qe)},M)},se=function(oe,j,ge,fe){C.validate("executeWorkflowWithCallback.setAnnotations");var ce=st();Le(function(){if(!ce||(ce==null?void 0:ce.sessionKey)!==(M==null?void 0:M.sessionKey))throw new Error("actions.setAnnotations must be called with a CV matching the session");if(!z)throw new Error("actions.setAnnotations should not be used for the WFs that use model iterating async boundary loader. Use IWorkflowModelItem.addAnnotation instead");var qe=void 0;if(!(fe!=null&&fe.isSessionAnnotation)&&(qe=L.get(oe),!qe))throw m.error(512336664,v.CoreDefault,"Workflow is trying to annotate an unknown object"),new Error(ee[ee.UnknownAnnotationParent]);re(qe,j,ge,fe)},M)},de=an(),ye=function(oe,j){return new Promise(function(ge,fe){C.validate("executeWorkflowWithCallback.getDynamicAnnotations"),Le(function(){Cn(function(){var ce=oe.maxDelayMs?oe.maxDelayMs:Z_.getValue(),qe=setTimeout(function(){var dt=`Timeout: No response received within ${ce} ms`;fe(new Error(dt)),Q("UseWorkflowCancellation")&&We.cancellation.markAsCancelled(Ai.Timeout,dt)},ce);He(oe,ce,function(dt,rt){clearTimeout(qe),l.onGetDynamicAnnotationsDoneCalled(de),dt?fe(dt):ge(rt)},j)})},M)})},He=function(oe,j,ge,fe){var ce=st(),qe={cvString:ce==null?void 0:ce.cv.toString(),interactionId:ce==null?void 0:ce.interactionId,interactionSessionId:ce==null?void 0:ce.interactionSessionId},dt=new ro({annotationTypes:oe.annotationTypes,transientItems:oe.transientItems,callerWorkflowId:u.id,callerRequestId:de,correlationInfo:qe});l.onMessage(dt,f,j,fe).then(function(rt){var $e=rt==null?void 0:rt.payload;if(!$e)ge(new Error("GetAnnotations call didn't return anything"),void 0);else if(y.matchesTypesFor($e,[Y.getTypeName()]))ge(new Error($e.error),void 0);else if(y.matchesTypesFor($e,[ta.getTypeName()]))ge(void 0,{content:$e.content});else{var nn=`Unexpected response with types: ${y.getBaseTypesFor($e)}`;m.error(508680269,v.CoreDefault,nn),ge(new Error(nn),void 0)}}).catch(function(rt){m.error(508680268,v.CoreDefault,`Error with getDynamicAnnotations call: ${rt.message}`),ge(rt,void 0)})},Ct=function(oe,j,ge,fe){if(!Array.isArray(ge))throw m.error(512336668,v.CoreDefault,"Workflow produced an invalid annotation array"),new Error(ee[ee.AnnotationsNotArray]);if(!u.outputTypes||u.outputTypes.indexOf(j)===-1)throw m.error(512336667,v.CoreDefault,`Workflow said it would output one of [${u.outputTypes}] but instead output ${j}`),new Error(ee[ee.UnexpectedOutput]);for(var ce of ge){if(!y.matchesTypesFor(ce,[At.getTypeName()]))throw m.error(512336666,v.CoreDefault,`Workflow produced an output that is not an annotation (${y.getTypeNameFor(ce)})`),new Error(ee[ee.OutputIsNotAnnotation]);if(y.getTypeNameFor(ce)!==j)throw m.error(512336665,v.CoreDefault,`Workflow produced inconsistent annotation types in setAnnotations call (${y.getTypeNameFor(ce)} did not match expected ${j})`),new Error(ee[ee.MixedOutput])}return fe&&fe.isSessionAnnotation?{path:["session"],contextId:I,ancestorType:fe.ancestorType,annotationType:j,annotations:ge,isImmediateAnnotation:fe.immediate,sourceInfo:We.sourceInfo}:fe&&fe.ancestorType?{path:oe.parentPath,contextId:I,ancestorType:fe.ancestorType,annotationType:j,annotations:ge,isImmediateAnnotation:fe.immediate,sourceInfo:We.sourceInfo}:{path:[].concat((0,Wc.default)(oe.parentPath),[oe.id]),revId:oe.revId,contextId:I,annotationType:j,annotations:ge,isImmediateAnnotation:fe==null?void 0:fe.immediate,sourceInfo:We.sourceInfo}},we,nt=u.maxExecutionTimeInS*1e3||Y_.getValue();we=setTimeout(function(){we=void 0,e(new Error(ee[ee.WorkflowTimeout]),void 0),Q("UseWorkflowCancellation")&&We.cancellation.markAsCancelled(Ai.Timeout,`Timeout: No response received within ${nt} ms`)},nt);var $t=function(oe,j){C.validate("executeWorkflowWithCallback.workflowExecutionDone"),T=!0,we&&(clearTimeout(we),Le(function(){var ge,fe,ce,qe;(!oe||j!=null&&j.preserveQueuedOnError||!((ge=j==null?void 0:j.strategy)===null||ge===void 0)&&ge.preserveQueued)&&((fe=We.getModel())===null||fe===void 0||fe.commitPendingAnnotations()),b&&(b.success=!oe,oe&&oe instanceof Mo&&(b.success=!0,b.dimension2="ExpectedFailure"),m.info(512336663,v.CoreDefault,b.stop())),oe&&(j!=null&&j.preserveQueuedOnError||!((ce=j==null?void 0:j.strategy)===null||ce===void 0)&&ce.preserveQueued)?(m.info(512336662,v.CoreDefault,`Workflow execution failed and preserving queue, with error: ${oe.message} at ${oe.stack}`),e(void 0,{error:oe.message,isExpectedError:oe instanceof Mo,annotations:$,billingDomainPerExecution:q})):e(oe,{annotations:j!=null&&j.ignoreExecution?void 0:$,ignoreExecution:(qe=j==null?void 0:j.ignoreExecution)!==null&&qe!==void 0?qe:!1,billingDomainPerExecution:q})},M))},mn=S(f.sessionKey),Fa=function(){function _e(){(0,gy.default)(this,_e);var oe,j,ge,fe,ce;this.clientMetadata=d,this.userContext=f.userContext,this.blobContext={sessionKey:f.sessionKey,userId:f.userId},this.triggerSignals=c.triggerSignals,this.existingAnnotations=(oe=c.existingAnnotations)===null||oe===void 0?void 0:oe.map(function(qe){return qe.body}),this.annotationActivationConfigs=c.annotationActivationConfigs,this.workflowId=u.id,this.sourceInfo=!((ge=L==null?void 0:L.get((j=c.triggerSignals)===null||j===void 0?void 0:j[0]))===null||ge===void 0)&&ge.sourceInfo?L.get(c.triggerSignals[0]).sourceInfo:(ce=(fe=c.inputItems)===null||fe===void 0?void 0:fe[0])===null||ce===void 0?void 0:ce.sourceInfo,this.asyncBoundaryLoader=k,this.sessionEndpoint={url:mn.sessionUrl,origin:f.origin},this._model=u.modelOptions?this.createModel():void 0}return(0,hy.default)(_e,[{key:"cancellation",get:function(){var j;return(j=this._cancellation)!==null&&j!==void 0||(this._cancellation=new dy),this._cancellation}},{key:"model",get:function(){var j;return(j=this._model)!==null&&j!==void 0||(this._model=this.createModel()),this._model}},{key:"flights",get:function(){var j;return(j=this._flights)!==null&&j!==void 0||(this._flights=go(this.clientMetadata.flights)),this._flights}},{key:"workflowStore",get:function(){return!this._workflowStoreManager&&x&&(this._workflowStoreManager=x(f.userId,f.sessionKey,this.workflowId)),this._workflowStoreManager}},{key:"chatStore",get:function(){if(!Q("EnableChatStore")){m.warn(508851673,v.CoreDefault,"Calling chat store from context while chat store is turned off");return}return this._chatStore||(this._chatStore=new ry(l,f,C)),this._chatStore}},{key:"getToken",value:function(j,ge){if(T){var fe=`Workflow ${u.id} asking for token ${j} after workflow is complete. Stack ${Error().stack}`;if(X_.getValue().indexOf(u.id)===-1){m.error(509141987,v.CoreDefault,fe),ge(new Error(`Cannot provide token ${j} after workflow is complete`),void 0);return}else m.info(507319566,v.CoreDefault,fe)}if(p){var ce=function(dt,rt,$e){ge(dt,rt,{returnedTokenType:$e})};return p(u,j,ce)}else throw m.error(512336661,v.CoreDefault,`NYI: Workflow service getTokenCallback for workflow ${u.id} is not available.`),new Error("Token callback not available")}},{key:"getModel",value:function(){return this._model}},{key:"createModel",value:function(){var j,ge,fe,ce,qe,dt=new ly,rt;z&&(rt=function(rp){L.set(rp.body,rp)});var $e=new Pv(N,re,rt,k,u.modelSchema,dt,c.truncationContext,void 0,u.modelOptions);if(u.kind!==U.SingleItem)if(c.dynamicContext)if(u.kind===U.DynamicText||u.kind===U.Generic){var nn=c.dynamicContext;$e.addItems(nn.contextAbove,!0),$e.addItems(c.inputItems),$e.addItems(nn.contextBelow,!0)}else throw new Error(`${u.kind} workflow does not support dynamic context`);else $e.addItems(c.inputItems);else(!((j=u.modelOptions)===null||j===void 0)&&j.includeScopeItemParent||!((ge=u.modelOptions)===null||ge===void 0)&&ge.includeRootItemParent)&&((fe=c.inputItems)===null||fe===void 0?void 0:fe.length)===2&&$e.addItems([c.inputItems[1]]);return!((ce=u.modelOptions)===null||ce===void 0)&&ce.includeExistingAnnotations&&((qe=c.existingAnnotations)===null||qe===void 0||qe.forEach(function(Wr){$e.getItemByReference({referencedPath:Wr.parentPath}).addAnnotation(Wr.body)})),$e.addItems(c.requestedContexts),$e}}]),_e}(),We=new Fa,vn={setAnnotations:se,submitSignals:W,overrideWorkflowDefinition:K,getDynamicAnnotations:ye,done:$t,setBillingDomain:X},mt;if(u.isStateful&&(mt=g.getState(u,f.sessionKey,f.userId)),!mt)try{mt=u.factory(),u.isStateful&&g.setState(u,f.sessionKey,f.userId,mt)}catch(_e){e(new Error(`workflow ${u.id} instance creation process got error: ${_e.message}`),void 0);return}try{if(u.kind===U.SingleItem){if(c.inputItems.length!==1&&c.inputItems.length!==2){m.error(508621079,v.CoreDefault,"Single item workflows expect one or two inputs (second item is the parent item if requested)"),$t(new Error(ee[ee.InvalidInputQuantityForSingleItemWorkflow]));return}We.delta=c.inputItems[0].delta,We.deltas=c.inputItems[0].deltas;var gr=c.inputItems[0],Mn=gr.body;if(Mn&&u.id==="VoiceUxo"&&(Mn.seq=(A=Mn.seq)!==null&&A!==void 0?A:parseInt(gr==null?void 0:gr.id,10)),j_.getValue()&&!K_.getValue().includes(u.id)&&!u.skipWorkflowItemSequencing&&Mn.seq!==void 0){u.id!=="Workflows/Voice"&&m.info(512336659,v.CoreDefault,"WorkflowSequencerEnabled workflow has sequencing with id: "+u.id);try{var qa=g.getBufferingSequencer(u,f.sessionKey,f.userId);qa!==void 0?yield qa.sequence(Mn.seq):m.error(512336658,v.CoreDefault,"BufferingSequencer does not exist in cache and was not instantiated")}catch(_e){if(m.error(512336657,v.CoreDefault,"Error processing workflow sequence: "+_e),Q("SkipWorkflowExecutionOnInvalidSeq")){$t(new Error(ee[ee.SequenceOutOfOrder]));return}}}yield mt.execute(Mn,We,vn)}else if(u.kind===U.DynamicText){if(!Array.isArray(c.inputItems))throw new Error("Dynamic text workflows expect an array of input items");var Rr=new As(c.inputItems.map(function(_e){return _e.body}));We.dynamicTextContext=c.dynamicContext,yield mt.execute(Rr,We,vn)}else if(u.kind===U.Reduce){if(!Array.isArray(c.inputItems))throw new Error("Reduce workflows expect an array of input items");var ni=new As(c.inputItems.map(function(_e){return _e.body}));yield mt.execute(N.body,ni,We,vn)}else if(u.kind===U.Grid){var bn=c.inputContext,hr=[];c.inputItems.slice(0,bn.numberOfNonEmptyCells).forEach(function(_e){if(_e&&_e.body){var oe=_e.body,j=oe.row-bn.neighborhoodTopRow,ge=oe.column-bn.neighborhoodLeftColumn;hr[j]||(hr[j]=[]),hr[j][ge]=oe}});var Br=c.inputItems.slice(bn.numberOfNonEmptyCells),Cu=new As(Br.map(function(_e){return _e.body}));m.info(512336656,v.CoreDefault,`sending grid to workflow. inputItems length: ${bn.numberOfNonEmptyCells}; grid context ${JSON.stringify(bn)}`),yield mt.execute(N.body,{targetGridRelativeTopRow:bn.targetGridRelativeTopRow,targetGridRelativeLeftColumn:bn.targetGridRelativeLeftColumn,cells:hr},Cu,bn,We,vn)}else if(u.kind===U.Join){if(!Array.isArray(c.inputItems))throw new Error("Join workflows expect an array of input items");We.delta=N.delta,We.deltas=N.deltas;var ri=c.inputItems.map(function(_e){return _e.body});yield mt.execute(N.body,ri,We,vn)}else u.kind===U.Generic&&(yield mt.execute(We.model,We,vn))}catch(_e){m.error(507589979,v.CoreDefault,`workflow ${u.id} execution error: ${_e.message} at ${_e.stack}`),$t(_e)}finally{u.isStateful||mt.dispose()}});return function(M){return _.apply(this,arguments)}}(),void 0,void 0,Q("UseWorkflowClientMetadataForCC")?d:void 0,{workflow:u.resourceId,joinContextId:I})};var Oc=function(o,e,r,t,a,s,u,l,f,c){return new Promise(function(d,p){vy({workflow:o,workflowMessageHandler:e,executionContext:r,input:t,clientMetadata:a,getTokenCallback:s,stateCache:u,asyncBoundaryLoader:l,getSessionInfo:f,getWorkflowStoreManager:void 0,correlationValidator:c},function(g,k){if(g){p(g);return}d(k)})})};h();var Sy=w(R()),Cy=w(B());h();h();var yy=w(R()),ky=w(B());var Vo=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;(0,yy.default)(this,n),this.prevSeq=-1,this.bufferingTimeMs=o,this.rejectOutdatedSequenceNumbers=e}return(0,ky.default)(n,[{key:"sequence",value:function(e){var r=this;return new Promise(function(t,a){if(e<r.prevSeq)if(r.rejectOutdatedSequenceNumbers){var s=new Error(`BufferingSequencer: Item out of order. Expecting seqId > ${r.prevSeq}. Actual seqId ${e}`);s.name=n.Rejected,a(s);return}else r.prevSeq=-1;e!=r.prevSeq+1&&m.warn(542712385,v.CoreDefault,`BufferingSequencer: got out of order sequence number. Got ${e}, expected ${r.prevSeq+1}`);var u={seq:e,resolve:t};r.insertItem(u),r.runInOrder(u,!0,!1)})}},{key:"insertItem",value:function(e){if(!this.firstQueueItem){this.firstQueueItem=e,this.lastQueueItem=e;return}var r=this.lastQueueItem,t=null;do{if(e.seq>r.seq){e.prev=r,r.next=e,t?(t.prev=e,e.next=t):this.lastQueueItem=e;return}t=r,r=r.prev}while(r);t&&(t.prev=e),e.next=t,this.firstQueueItem=e}},{key:"runInOrder",value:function(e,r,t){for(var a=this,s=this.prevSeq,u=!1,l=[];this.firstQueueItem;){var f=this.firstQueueItem;if(s+1!=f.seq&&(!t||f.seq>e.seq))break;s=f.seq,f.timeout&&clearTimeout(f.timeout),l.push(f),e==f&&(u=!0),this.firstQueueItem=this.firstQueueItem.next,this.firstQueueItem&&(this.firstQueueItem.prev=null)}l.length>0&&setTimeout(function(){for(var c of l)c.resolve(c.seq)},0),this.prevSeq=s,!u&&r&&(e.timeout=setTimeout(function(){a.runInOrder(e,!1,!0)},this.bufferingTimeMs))}}]),n}();Vo.Rejected="SequenceItemRejected";var eA=new G("workflowStateCacheSweepInterval",1e3),xy=new G("workflowStateCacheIdleTimeoutMs",3e4),tA=new G("workflowStateCacheIdleTimeoutPerWorkflowMs",{}),nA=new G("sequencerTimeoutInMs",500),rA=function(o){return o.stateExpiryMs||xy.getValue()},wy=function(o,e,r){if(!o)throw new Error("workflowId is undefined");if(!e)throw new Error("sessionKey is undefined");if(!r)throw new Error("userId is undefined");return`${o}-${e}-${r}`},Ty=function(){function n(){(0,Sy.default)(this,n),this.cache=new Yn({sweepInterval:eA.getValue(),idleDurationMs:xy.getValue(),idleCallback:this.onStateIdle.bind(this)})}return(0,Cy.default)(n,[{key:"setState",value:function(e,r,t,a){if(!e){m.error(526952585,v.CoreDefault,"cannot set state for undefined workflow");return}if(!e.isStateful){m.error(526952586,v.CoreDefault,`WorkflowStateCache: Attempting to set state for the stateless workflow ${e.id}`);return}var s=wy(e.id,r,t),u=this.cache.get(s);if(u&&u.state.dispose(),a){var l={cc:st(),state:a,annotationSequenceGenerator:new Tv,bufferingSequencer:new Vo(nA.getValue(),!0)};this.cache.put(s,l,rA(e),this.onStateIdle.bind(this),tA.getValue()[e.id])}else this.cache.del(s)}},{key:"getState",value:function(e,r,t){var a=this.getStateCacheItem(e,r,t);return a==null?void 0:a.state}},{key:"getAnnotationSequenceGenerator",value:function(e,r,t){var a=this.getStateCacheItem(e,r,t);return a==null?void 0:a.annotationSequenceGenerator}},{key:"getBufferingSequencer",value:function(e,r,t){var a=this.getStateCacheItem(e,r,t);return a==null?void 0:a.bufferingSequencer}},{key:"clear",value:function(){this.cache.clear()}},{key:"getStateCacheItem",value:function(e,r,t){if(!e){m.error(526952587,v.CoreDefault,"cannot get state for undefined workflow");return}if(e.isStateful){var a=this.cache.get(wy(e.id,r,t));return a}}},{key:"onStateIdle",value:function(e,r){Le(function(){return r.state.dispose()},r.cc)}}]),n}();h();var Ey=w(R()),Ny=w(B());h();var va=w(_n()),My=w(R()),by=w(B());h();var Lc=w(ys()),Iy=w(ze()),_y=w(Ve()),ma=w(Oe()),ho=w(_n()),Fc=w(R()),qc=w(B());function oA(n){var o=iA();return function(){var r=(0,ma.default)(n),t;if(o){var a=(0,ma.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,_y.default)(this,t)}}function iA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var aA=new G("workflowStoreSweepIntervalMs",1e4),sA=new G("workflowStoreItemExpiryMs",6e5),uA=function(){function n(o,e,r,t,a){if((0,Fc.default)(this,n),this.storeType=Xn.WorkflowSession,!e)throw new Error("workflowId is required");if(this.workflowId=e,!r)throw new Error("sessionKey is required");if(this.sessionKey=r,!t)throw new Error("userId is required");if(this.userId=t,!o)throw new Error("instanceId is required");this.instanceId=o,this.cache=new Yn({sweepInterval:aA.getValue()}),this.onWorkflowStoreCleared=a}return(0,qc.default)(n,[{key:"setItem",value:function(){var o=(0,ho.default)(function*(r,t,a,s){var u=this;return new Promise(function(l,f){try{var c=u.getStoreKey(u.workflowId,u.sessionKey,u.userId,r);t?u.cache.put(c,t,s!=null?s:sA.getValue(),u.onItemExpired.bind(u)):u.cache.del(c),l(!0)}catch(d){f(d)}})});function e(r,t,a,s){return o.apply(this,arguments)}return e}()},{key:"getItem",value:function(){var o=(0,ho.default)(function*(r,t){var a=this;return new Promise(function(s,u){var l=a.getStoreKey(a.workflowId,a.sessionKey,a.userId,r),f=a.cache.get(l);s(f)})});function e(r,t){return o.apply(this,arguments)}return e}()},{key:"getStoreKey",value:function(e,r,t,a){return`${e}-${r}-${t}-${a}`}},{key:"clear",value:function(){this.cache.clear(),this.onWorkflowStoreCleared&&this.onWorkflowStoreCleared(this.instanceId,this)}},{key:"onItemExpired",value:function(e,r){this.cache.size()===0&&this.clear()}}]),n}(),Ay=function(n){(0,Iy.default)(e,n);var o=oA(e);function e(r,t,a,s,u){return(0,Fc.default)(this,e),o.call(this,r,t,a,s,u)}return(0,qc.default)(e,[{key:"setItem",value:function(){var r=(0,ho.default)(function*(a,s,u,l){var f=this,c=function(){var d=(0,ho.default)(function*(p,g){try{var k=yield(0,Lc.default)((0,ma.default)(e.prototype),"setItem",f).call(f,a,s,u,l);if(!k)return g(new Error("Item not set in local cache"));p(k)}catch(S){g(S)}});return function(g,k){return d.apply(this,arguments)}}();return new Promise(c)});function t(a,s,u,l){return r.apply(this,arguments)}return t}()},{key:"getItem",value:function(){var r=(0,ho.default)(function*(a,s){var u=this,l=function(){var f=(0,ho.default)(function*(c,d){try{var p=yield(0,Lc.default)((0,ma.default)(e.prototype),"getItem",u).call(u,a,s);if(p)return c(p);c(void 0)}catch(g){d(g)}});return function(d,p){return f.apply(this,arguments)}}();return new Promise(l)});function t(a,s){return r.apply(this,arguments)}return t}()}]),e}(uA);var $c=function(){function n(o){(0,My.default)(this,n);var e;if(!o.userId)throw new Error("userId is required");this.userId=o.userId,this.workflowId=o.workflowId,this.sessionKey=o.sessionKey,this.workflowStores=(e=o.workflowStores)!==null&&e!==void 0?e:new Map,this.onWorkflowStoreCleared=o.workflowStoreClearedCallback}return(0,by.default)(n,[{key:"setItem",value:function(){var o=(0,va.default)(function*(r,t){var a=this,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Xn.WorkflowSession,u=arguments.length>3?arguments[3]:void 0,l=function(){var f=(0,va.default)(function*(c,d){try{var p=a.getStoreInstance(s),g=yield p.setItem(r,t,s,u);c(g)}catch(k){d(k)}});return function(d,p){return f.apply(this,arguments)}}();return new Promise(l)});function e(r,t){return o.apply(this,arguments)}return e}()},{key:"getItem",value:function(){var o=(0,va.default)(function*(r,t){var a=this,s=function(){var u=(0,va.default)(function*(l,f){try{var c=a.getStoreInstance(t),d=yield c.getItem(r,t);l(d)}catch(p){f(p)}});return function(f,c){return u.apply(this,arguments)}}();return new Promise(s)});function e(r,t){return o.apply(this,arguments)}return e}()},{key:"getStoreInstance",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Xn.WorkflowSession,r,t=`${this.userId}-${this.sessionKey}-${this.workflowId}`;switch(e){case Xn.WorkflowSession:if(!this.sessionKey||!this.workflowId)throw new Error("sessionKey and workflow not set for this instance");r=this.workflowStores.get(t),r||(r=new Ay(t,this.workflowId,this.sessionKey,this.userId,this.workflowStoreClearedCallback.bind(this)),this.workflowStores.set(t,r));break;case Xn.User:throw new Error("Workflow Store for user type is not yet implemented");default:throw new Error("Invalid store type")}return r}},{key:"workflowStoreClearedCallback",value:function(e,r){this.workflowStores.delete(e),this.workflowStores.size===0&&this.onWorkflowStoreCleared&&this.onWorkflowStoreCleared(this.userId,this)}}]),n}();var Dy=function(){function n(){(0,Ey.default)(this,n),this.workflowStoreRegistry=new Map}return(0,Ny.default)(n,[{key:"getWorkflowStoreManager",value:function(e,r,t){var a=this.workflowStoreRegistry.get(e);return a||(a=new $c({userId:e}),this.workflowStoreRegistry.set(e,a)),new $c({sessionKey:r,workflowId:t,userId:a.userId,workflowStoreClearedCallback:this.workflowStoreClearedCallback.bind(this),workflowStores:a.workflowStores})}},{key:"workflowStoreClearedCallback",value:function(e,r){this.workflowStoreRegistry.delete(e)}}]),n}();var lA=new G("workflowsEnabledForFallbackToAugloopToken",[]),fA=new G("workflowDeactivateTokensDisabledWorkflows",["ChangeSummaries","Copywriter","Voice","WritersUnblock"]),cA=function(o,e){switch(o){case pt.AutoClpLowPrivilege:return pt.AutoClpAppOnlyLowPrivilege;case pt.EditorLowPrivilege:return pt.EditorAppOnlyLowPrivilege;case pt.AugLoopLowPrivilege:return lA.getValue().includes(e)?pt.WacUserInfo:void 0}},dA=function(o){switch(o){case pt.IncomingPFT:return pt.AugLoopLowPrivilege}},pA=function(o,e,r){var t=dA(o);return r&&!t&&(t=cA(o,e)),t},On=function(o){return Q("BypassModelPerAnnotationType")?o.bypassModel?o.bypassTypes===void 0?!0:Ov(o.bypassTypes,o.outputTypes):!1:o.bypassModel},Os=function(o,e){return Q("BypassModelPerAnnotationType")?o.bypassModel&&(o.bypassTypes===void 0||o.bypassTypes.includes(e)):o.bypassModel},By=function(){function n(o,e,r,t,a){(0,Py.default)(this,n),this.correlationValidatorFactory=a,this.workflowRegistry=new Map,this.workflowMessageHandler=o,this.workflowStateCache=new Ty,this.workflowStoreRegistry=new Dy,this.registerWorkflows(e),this.asyncBoundaryLoaderRegistry=r,this.getSessionInfo=t}return(0,Ry.default)(n,[{key:"onWorkflowRequest",value:function(){var o=(0,Qo.default)(function*(r){var t=r.payload?r.payload:r,a=t.workflowId;if(!this.workflowRegistry.has(a))throw m.error(526718720,v.CoreDefault,`executeWorkflow workflow id '${a}' not available`),new Error(`executeWorkflow workflow id '${a}' not available`);var s=this.getWorkflowDefinition(r),u=this.createTokensMap(t.tokens),l=this.correlationValidatorFactory.create(r.executionContext.sessionKey),f=function(k,S,x){var C;if(l.validate("WorkflowRuntime.getToken"),u){k.id!=a&&m.warn(526718721,v.CoreDefault,`Workflow ${k.id} is requesting token and we are executing workflow ${a}`);var T=u.get(S);if(T)x(void 0,T,S);else{var I=`Workflow ${k.id} is requesting token ${pt[S]} but it is not available`,_=pA(S,a,k.isAppOnlyTokenAllowed),M=u.get(_);M?x(void 0,M,_):_?(I=I+`, try alternate token ${pt[_]} but it is not available either`,m.warn(526718722,v.CoreDefault,I),x(new Error(I),void 0)):(m.warn(526718723,v.CoreDefault,I),x(new Error(I),void 0))}}else{var A=`Workflow ${k.id} is requesting token ${pt[S]} but tokensMap is undefined, from ${(C=t==null?void 0:t.tokens)===null||C===void 0?void 0:C.length} tokens. `;k.optionalTokenTypes?m.info(526718724,v.CoreDefault,A):m.error(526718725,v.CoreDefault,A),x(new Error(A),void 0)}};try{if(Q("executeOneWorkflow")){var c=[];for(var d of t.batchExecutionInputs)c.push(this.executeOneWorkflow(d,t,s,f,l));var p=yield Promise.all(c);return new Go({batchExecutionResults:p})}else return yield this.onWorkflowRequestInternal(t,s,f,l)}finally{Q("DataProvenanceClearTokensOnWorkflowCompletion")&&u&&fA.getValue().indexOf(s.id)===-1&&u.clear()}});function e(r){return o.apply(this,arguments)}return e}()},{key:"getWorkflowDefinition",value:function(e){var r=this.workflowRegistry.get(e.workflowId);return e.executionContext.appliedWorkflowOverrides&&m.info(507543837,v.CoreDefault,`Overriding workflow definition for workflow ${e.workflowId} with ${JSON.stringify(e.executionContext.appliedWorkflowOverrides)}`),Object.assign({},r,e.executionContext.appliedWorkflowOverrides)}},{key:"executeOneWorkflow",value:function(){var o=(0,Qo.default)(function*(r,t,a,s,u){var l=this;return yield Cn((0,Qo.default)(function*(){var f;try{return yield Oc({workflow:a,workflowMessageHandler:l.workflowMessageHandler,executionContext:t.executionContext,input:r,clientMetadata:t.clientMetadata,getTokenCallback:s,stateCache:l.workflowStateCache,asyncBoundaryLoader:l.createAsyncBoundaryLoader(t,(f=a==null?void 0:a.modelOptions)===null||f===void 0?void 0:f.asyncBoundaryLoaderType,r),getSessionInfo:l.getSessionInfo,getWorkflowStoreManager:l.workflowStoreRegistry.getWorkflowStoreManager.bind(l.workflowStoreRegistry),correlationValidator:u})}catch(c){return{error:c.message,isExpectedError:c instanceof Mo}}}))});function e(r,t,a,s,u){return o.apply(this,arguments)}return e}()},{key:"onWorkflowRequestInternal",value:function(){var o=(0,Qo.default)(function*(r,t,a,s){var u=this,l=[],f=function*(g){Cn(function(){var k=function(){var S=(0,Qo.default)(function*(){var x;try{var C=yield Oc({workflow:t,workflowMessageHandler:u.workflowMessageHandler,executionContext:r.executionContext,input:g,clientMetadata:r.clientMetadata,getTokenCallback:a,stateCache:u.workflowStateCache,asyncBoundaryLoader:u.createAsyncBoundaryLoader(r,(x=t==null?void 0:t.modelOptions)===null||x===void 0?void 0:x.asyncBoundaryLoaderType,g),getSessionInfo:u.getSessionInfo,getWorkflowStoreManager:u.workflowStoreRegistry.getWorkflowStoreManager.bind(u.workflowStoreRegistry),correlationValidator:s});return C}catch(T){return{error:T.message,isExpectedError:T instanceof Mo}}});return function(){return S.apply(this,arguments)}}();l.push(k())})};for(var c of r.batchExecutionInputs)yield*So(f(c));var d=yield Promise.all(l);return new Go({batchExecutionResults:d})});function e(r,t,a,s){return o.apply(this,arguments)}return e}()},{key:"registerWorkflow",value:function(e){this.workflowRegistry.set(e.id,e),this.workflowMessageHandler.setWorkflowRequestCallback(e,this.onWorkflowRequest.bind(this))}},{key:"close",value:function(){this.workflowStateCache.clear()}},{key:"getRegisteredWorkflows",value:function(){return Array.from(this.workflowRegistry.values())}},{key:"registerWorkflows",value:function(e){var r=this;e.forEach(function(t){r.registerWorkflow(t)})}},{key:"createTokensMap",value:function(e){if(!(!Array.isArray(e)||e.length===0)){if(e.length%2!==0){m.error(526718728,v.CoreDefault,"token information array contains odd number of items, it should be even for token id/value pairs");return}for(var r=new Map,t=0;t<e.length;t+=2){var a=pt[e[t]];r.set(a,e[t+1])}return r}}},{key:"createAsyncBoundaryLoader",value:function(e,r,t){var a;if(!((a=this.asyncBoundaryLoaderRegistry)===null||a===void 0)&&a.has(r))return this.asyncBoundaryLoaderRegistry.get(r)(e,this.workflowMessageHandler.onWorkflowModelRequest.bind(this.workflowMessageHandler),t,this.workflowMessageHandler.onFetchRangeFromCacheRequest.bind(this.workflowMessageHandler))}}]),n}();h();var Wy;(function(n){n.SyncMessageProcessing="SyncMessageProcessing",n.ItemChangesTriggeredWorkflow="ItemChangesTriggeredWorkflow",n.ContextChangesTriggeredWorkflow="ContextChangesTriggeredWorkflow",n.ScheduleWorkflowExecution="ScheduleWorkflowExecution"})(Wy||(Wy={}));var Z;(function(n){n.SynchronizeMessage="SynchronizeMessage",n.ApplyNextSequence="ApplyNextSequence",n.InvalidateWorkflow="InvalidateWorkflow",n.EvaulatePrefilters="EvaulatePrefilters",n.AddScopeGroupedParameters="AddScopeGroupedParameters",n.WorkflowExecution="WorkflowExecution",n.SendWorkflowRequest="SendWorkflowRequest",n.SendWorkflowRequestSync="SendWorkflowRequestSync",n.QueueWorkflow="QueueWorkflow",n.WaitingInWorkflowQueue="WaitingInWorkflowQueue",n.ExecutionTrackerInvalidate="ExecutionTracker.Invalidate",n.SetScopeExecutionNotification="SetScopeExecutionNotification",n.WorkflowRegistrationQueueTask="WorkflowRegistration.QueueTask",n.ResolveAndValidateAllRequestedContexts="ResolveAndValidateAllRequestedContexts",n.QueueOrSetScopeExecutionNotification="QueueOrSetScopeExecutionNotification",n.ValidateWorkflowExecution="ValidateWorkflowExecution",n.QueueExecutionNotification="QueueExecutionNotification",n.QueueGridNeighborhoodWorkflow="QueueGridNeighborhoodWorkflow",n.SyncMessageSequencerSendResponse="SyncMessageSequencerSendResponse",n.WaitingInDebounceQueue="WaitingInDebounceQueue",n.WaitingForPendingScopeExecution="WaitingForPendingScopeExecution",n.InvalidateHybridSingleItemWorkflow="InvalidateHybridSingleItemWorkflow",n.ProcessWorkflowResponse="ProcessWorkflowResponse",n.ProcessAnnotationQueue="ProcessAnnotationQueue",n.ProcessAnnotationQueueSync="ProcessAnnotationQueueSync",n.ConsolidateAnnotationQueue="ConsolidateAnnotationQueue",n.PersistAnnotationQueueStateless="PersistAnnotationQueue.Stateless",n.PersistAnnotationQueueStateful="PersistAnnotationQueue.Stateful",n.CommitAnnotations="CommitAnnotations",n.SendAnnotations="SendAnnotations",n.SendAnnotationsSync="SendAnnotationsSync",n.WaitingForInOrderMessage="WaitingForInOrderMessage",n.PrepareSequencedOperations="PrepareSequencedOperations",n.GridSplitterSplit="GridSplitter.Split",n.TableBoundaryGridSplitterSplit="TableBoundaryGridSplitter.Split",n.WaitingInSynchronizationQueue="WaitingInSynchronizationQueue",n.SynchronizeWorkflowTask="SynchronizeWorkflowTask",n.SynchronizeWorkflowTasks="SynchronizeWorkflowTasks",n.PostponeWorkflowTask="PostponeWorkflowTask"})(Z||(Z={}));var Gy=w(Rn());function gA(n){var o=hA();return function(){var r=(0,Gc.default)(n),t;if(o){var a=(0,Gc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,$y.default)(this,t)}}function hA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var mA=function(o,e){var r=o.map(e);return o.filter(function(t,a){return r.indexOf(r[a])===a})},vA=function(o,e){var r=o.map(e);return o.filter(function(t,a){return r.lastIndexOf(r[a])===a})},Ls=function(n){(0,qy.default)(e,n);var o=gA(e);function e(r){var t;return(0,Ly.default)(this,e),t=o.call(this),t.session=r,t}return(0,Fy.default)(e,[{key:"processAnnotationQueue",value:function(t,a){if(Array.isArray(a)){var s=V(),u=s.start(Z.ProcessAnnotationQueue),l=s.startSync(Z.ProcessAnnotationQueueSync),f=new Re({sessionHealthEventName:"ProcessAnnotationQueue",success:!0,source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,resourceId:t.resourceId,count:0,message:"",affectedWorkflows:[t.resourceId]}).start();try{for(var c of a)if(Array.isArray(c.annotationQueue)){Q("fasterConsolidateAnnotationQueue")?c.annotationQueue=this.consolidateAnnotationQueue(c.annotationQueue):this.consolidateAnnotationQueue(c.annotationQueue);for(var d of c.annotationQueue)if(Array.isArray(d.annotations))for(var p of d.annotations)f.count++,p.ownerId=t.id}s.stop(l),this.emit("onBeforeAnnotationsPersisted",t,a),this.persistAnnotationQueue(t,a,f),m.info(529093132,v.CoreDefault,f.stop())}catch(g){s.stop(l),f.success=!1,f.dimension0=ee[ee.ApplyAnnotationsException],f.resultDescription=g.message,m.error(529093133,v.CoreDefault,f.stop()),m.error(529093134,v.CoreDefault,`${f.sessionHealthEventName} ${g.stack}`)}V().stop(u)}}},{key:"consolidateAnnotationQueue",value:function(t){if(t.length<2)return t;var a=V().startSync(Z.ConsolidateAnnotationQueue);if(Q("fasterConsolidateAnnotationQueue")){for(var s=!1,u=0;u<t.length;u++)if(t[u].ancestorType){s=!0;break}if(!s){var l;return Q("reverseUniqby")?l=vA(t,function(S){return`${H(S.path)}-${S.annotationType}`}):(t.reverse(),l=mA(t,function(S){return`${H(S.path)}-${S.annotationType}`}),l.reverse()),V().stop(a),l}}for(var f=new Map,c=0;c<t.length;){var d=t[c],p=`${H(d.path)}-${d.annotationType}`,g=f.get(p);if(g!==void 0){if(d.ancestorType){var k;(k=t[g].annotations).push.apply(k,(0,Oy.default)(d.annotations))}else t[g]=d;t.splice(c,1)}else f.set(p,c),c++}return V().stop(a),t}},{key:"generateAnnotationAddOps",value:function(t,a,s,u,l){if(u.length>0){var f=new ke({parentPath:t,items:u});a&&(f.parentRevId=a),s&&(f.isTriggeredBySyncDelta=s),l.push(f),this.session.stats.annotationsAdded+=u.length}}},{key:"generateAnnotationUpdateOps",value:function(t,a,s,u,l){if(u.length>0){var f=new Pe({parentPath:t,items:u});a&&(f.parentRevId=a),s&&(f.isTriggeredBySyncDelta=s),l.push(f),this.session.stats.annotationsUpdated+=u.length}}},{key:"generateAnnotationDeleteOps",value:function(t,a,s,u,l,f){if(l.length>0){var c=new Array(l.length),d=0,p=function(x){c[d++]={id:x.id,parentPath:a,contextId:x.contextId},m.debug(529093135,v.CoreDefault,function(){return`Deleting annotation ${x.id} (type: ${y.getTypeNameFor(x.body)}, workflow: ${t.id})`})};for(var g of l)p(g);var k=new Ge({parentPath:a,items:c});s&&(k.parentRevId=s),u&&(k.isTriggeredBySyncDelta=u),f.push(k),this.session.stats.annotationsDeleted+=c.length}}}]),e}(Gy.EventEmitter);h();var Uy=w(Se());var yA=[he.CursorUpdate,he.FormattingUpdate,he.OtherNonContentUpdate];function Hy(n,o,e){var r=new E({operationName:"ApplyTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();try{if(!o){r.success=!1,r.resultDescription="Unable to apply text tile delta, parent tile is undefined",m.info(538798173,v.CoreDefault,r.stop());return}if(y.getTypeNameFor(o)!==et.getTypeName()){r.success=!1,r.resultDescription=`Unable to apply text tile delta, parent tile is not proper type: expected ${sr.getTypeName()}, received ${y.getTypeNameFor(o)}`,m.info(538798174,v.CoreDefault,r.stop());return}var t=o,a=n,s=t.content,u="";if(a.position===void 0||a.position<0){r.success=!1,r.resultDescription="Unable to apply text tile delta, invalid text tile position",m.info(538798175,v.CoreDefault,r.stop());return}switch(a.deltaType){case he.Add:a.position<s.length?u=`${s.slice(0,a.position)}${a.content}${s.slice(a.position,s.length)}`:u=s+a.content;break;case he.Update:!a.content&&a.unit===je.Sentence&&(r.dimension0="1"),u=`${s.slice(0,a.position)}${a.content}${s.slice(a.position+(a.length||0),s.length)}`;break;case he.Delete:u=`${s.slice(0,a.position)}${s.slice(a.position+(a.length||0),s.length)}`}return m.info(538837071,v.CoreDefault,r.stop()),new et({content:u})}catch(l){r.success=!1,r.resultDescription=`Error applying text tile delta: ${l}`,m.info(538798176,v.CoreDefault,r.stop());return}}function zy(n,o,e){var r,t,a,s,u,l,f,c,d=new E({operationName:"ApplyFormattedTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();d.clientFlights=e;try{if(!o){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, parent tile is undefined",m.info(538798177,v.CoreDefault,d.stop());return}if(y.getTypeNameFor(o)!==ht.getTypeName()){d.success=!1,d.resultDescription=`Unable to apply formatted text tile delta, parent tile is not proper type: expected ${ht.getTypeName()}, received ${y.getTypeNameFor(o)}`,m.info(538798178,v.CoreDefault,d.stop());return}var p=o,g=n,k=p.content,S="";if((g.position===void 0||g.position<0)&&!Uc(g.deltaType)){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, invalid text tile position",m.info(538798179,v.CoreDefault,d.stop());return}else if(g.content===void 0&&!Uc(g.deltaType)){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, non-delete, non-formatting, non-other-non-content-update and non-cursor-update operation without content defined",m.info(538798208,v.CoreDefault,d.stop());return}if(g.deltaType===he.Add&&g.length!==0?m.info(538798209,v.CoreDefault,new E({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta add operation with delta length, expected length 0",success:!0})):Uc(g.deltaType)&&g.content!==void 0&&m.info(538798210,v.CoreDefault,new E({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta delete or non-content related operation with content defined, expected undefined",success:!0})),Vy(g.deltaType)){if(g.deltaType===he.CursorUpdate)return new ht(Object.assign(Object.assign({},p),{ipPosition:(f=g.cursorData)===null||f===void 0?void 0:f.ipPosition,isColdIp:(c=g.cursorData)===null||c===void 0?void 0:c.isColdIp}));if(g.deltaType===he.FormattingUpdate)return new ht(Object.assign(Object.assign({},p),{formattedRanges:g.formattedRanges}));if(g.deltaType===he.OtherNonContentUpdate){var A,b={};for(A in g.otherNonContentData)b[A]=g.otherNonContentData[A];return new ht(Object.assign(Object.assign({},p),b))}}else{var x=kA(p.formattedRanges,g.deltaType,g.position),C=p.formattedRanges?(0,Uy.default)(p.formattedRanges):[],T=x?C.indexOf(x):-1;T!==-1&&(g.position+(g.length||0)>x.start+x.length?x.length=g.position+((r=g.content)!==null&&r!==void 0?r:"").length-x.start:x.length+=((t=g.content)!==null&&t!==void 0?t:"").length-(g.length||0),C[T]=x);var I=p.ipPosition;switch(g.deltaType){case he.Add:g.position<k.length?S=`${k.slice(0,g.position)}${g.content}${k.slice(g.position,k.length)}`:S=k+g.content,I=g.position+g.length;break;case he.Update:!g.content&&g.unit===je.Sentence&&(d.dimension0="1"),S=`${k.slice(0,g.position)}${g.content}${k.slice(g.position+((a=g.length)!==null&&a!==void 0?a:0),k.length)}`,I=g.position+g.content.length;break;case he.Delete:S=`${k.slice(0,g.position)}${k.slice(g.position+((s=g.length)!==null&&s!==void 0?s:0),k.length)}`,I=g.position;break}for(var _ of C.slice(T+1))_.start<g.position||(g.position+(g.length||0)>_.start?(_.length=_.start+_.length-(g.position+(g.length||0)),_.start=g.position+((u=g.content)!==null&&u!==void 0?u:"").length):_.start+=((l=g.content)!==null&&l!==void 0?l:"").length-(g.length||0));C=C.filter(function(N){return N.length>0});var M=new ht(Object.assign(Object.assign({},p),{ipPosition:I,content:S,formattedRanges:C,queryRange:g.queryRange}));return m.info(538837073,v.CoreDefault,d.stop()),M}return}catch(N){d.success=!1,d.resultDescription=`Error applying formatted text tile delta: ${N}`,m.info(538798211,v.CoreDefault,d.stop());return}}function kA(n,o,e){var r=new E({operationName:"FindRangeForDelta",success:!0});if(r.start(),!n){r.resultDescription="No formatted ranges found within the tile, skipping.",m.info(538798212,v.CoreDefault,r.stop());return}if(o===he.Add){var t=n.find(function(s){return s.start===e&&s.length===0});if(t)return r.resultDescription=`Found a zero-length formatted range for add operation with start ${t.start}.`,m.info(538798213,v.CoreDefault,r.stop()),t;e=Math.max(e-1,0)}var a=n.find(function(s){return s.length===0?s.start===e:s.start<=e&&e<s.start+s.length});return a?(r.resultDescription=`Updating formatted range for operation with start: ${a.start} and length: ${a.length}`,m.info(538798214,v.CoreDefault,r.stop())):(r.resultDescription=`Unable to find formatted range for operation at position ${e}, skipping.`,m.info(538798215,v.CoreDefault,r.stop())),a}function Vy(n){return yA.indexOf(n)!==-1}function Uc(n){return Vy(n)||he.Delete===n}h();var Qy=w(R()),Jy=w(B());h();var Ln=function(o,e,r){var t=o.get(e);return t||(t=r(),o.set(e,t)),t},ya=function(o){return{id:o.id,kind:o.kind,visibility:o.visibility,collectionScopeType:o.collectionScopeType,inputTypes:o.inputTypes,outputTypes:o.outputTypes,correlatedSignals:o.correlatedSignals}},Ir=function(o){return Array.isArray(o.correlatedSignals)&&o.correlatedSignals.length>0};var ka=function(o,e){return o==null||e==null?!1:o.length>0&&(o===e||e.indexOf(o)===0&&e.charAt(o.length)===".")},en=function(o){return Array.isArray(o.triggerSignals)&&o.triggerSignals.length>0},wa=function(o){var e,r;return(r=(e=o.triggerConditions)===null||e===void 0?void 0:e.includes(Ht.NonExclusiveTriggerSignals))!==null&&r!==void 0?r:!1};var Fs=function(){function n(){(0,Qy.default)(this,n),this.workflowDefByWorkflowAndContextId=new Map,this.workflowDefByWorkflow=new Map}return(0,Jy.default)(n,[{key:"mergeWorkflowDefinition",value:function(e,r,t){if(t){var a=Ln(this.workflowDefByWorkflowAndContextId,e.id,function(){return new Map});a.set(t,n.mergeDefinitions(e,a.get(t),r))}else this.workflowDefByWorkflow.set(e.id,n.mergeDefinitions(e,this.workflowDefByWorkflow.get(e.id),r))}},{key:"getWorkflowDefinition",value:function(e,r){var t,a;return r&&(a=(t=this.workflowDefByWorkflowAndContextId.get(e.id))===null||t===void 0?void 0:t.get(r)),a||(a=this.workflowDefByWorkflow.get(e.id)),a||(a=e),a}},{key:"deleteWorkflowDefinition",value:function(e,r){var t=this.workflowDefByWorkflowAndContextId.get(e.id);t&&(t.delete(r),t.size===0&&this.workflowDefByWorkflowAndContextId.delete(e.id))}}],[{key:"mergeDefinitions",value:function(e,r,t){return Object.assign(Object.assign(Object.assign({},e),r),t)}}]),n}();h();var qs=function(o,e){var r;return!(e.maxEventAge&&Date.now()-o.timestamp>e.maxEventAge||e.includedTypes&&!e.includedTypes.includes(o.type)||!((r=e.excludedTypes)===null||r===void 0)&&r.includes(o.type))};h();var mo=w(at()),vo=w(Se()),nk=w(R()),rk=w(B());h();h();var jy=w(R()),Ky=w(B());var Xy=function(){function n(){(0,jy.default)(this,n)}return(0,Ky.default)(n,[{key:"generateDelta",value:function(e,r,t){var a=y.getTypeNameFor(e),s=y.getTypeNameFor(r);if(a!==s)throw new Error(`Tile types must be same. NewTile type: '${y.getTypeNameFor(e)}', OldTile type '${y.getTypeNameFor(r)}'.`);var u=new Set(t==null?void 0:t.changes);return(a===et.getTypeName()||y.getBaseTypesFor(e).includes(et.getTypeName()))&&this.setChangesForTextTile(e,r,u),(a===ht.getTypeName()||y.getBaseTypesFor(e).includes(ht.getTypeName()))&&this.setChangesForFormattedTextTile(e,r,u),new Hn({changes:Array.from(u)})}},{key:"setChangesForTextTile",value:function(e,r,t){e.content!==r.content&&t.add(mr.ContentChanged),r.content||t.add(mr.ContentWasEmpty)}},{key:"setChangesForFormattedTextTile",value:function(e,r,t){var a=this.areFormattedTextTilesDifferent(e,r);a&&t.add(mr.FormattingChanged),(r.isInsideTable||r.isInsideTOC)&&t.add(mr.ContentWasInsideOfTheTable)}},{key:"areFormattedTextTilesDifferent",value:function(e,r){return e.indentation!==r.indentation||e.rightIndentation!==r.rightIndentation||e.outlineLevel!==r.outlineLevel||e.listType!==r.listType||e.alignment!==r.alignment||e.isInsideTable!==r.isInsideTable||e.isInsideTOC!==r.isInsideTOC||e.spacingBeforeParagraph!==r.spacingBeforeParagraph||e.spacingAfterParagraph!==r.spacingAfterParagraph||e.lineSpacing!==r.lineSpacing||e.listId!==r.listId||e.bulletAndNumberFontSize!==r.bulletAndNumberFontSize||e.bulletAndNumberFontFamily!==r.bulletAndNumberFontFamily||e.specialIndentType!==r.specialIndentType||e.specialIndentBy!==r.specialIndentBy||e.fontKerning!==r.fontKerning||this.areFormattedRangesChanged(e.formattedRanges,r.formattedRanges)}},{key:"areFormattedRangesChanged",value:function(e,r){var t,a,s=(t=e==null?void 0:e.length)!==null&&t!==void 0?t:0,u=(a=r==null?void 0:r.length)!==null&&a!==void 0?a:0;if(s!==u)return!0;for(var l=0;l<s;l++)if(this.areFormattedRangesDifferent(e[l],r[l]))return!0;return!1}},{key:"areFormattedRangesDifferent",value:function(e,r){return!e||!r?!r!=!e:e.isDeleted!==r.isDeleted||e.fontFamily!==r.fontFamily||e.fontWeight!==r.fontWeight||e.fontSize!==r.fontSize||e.italic!==r.italic||e.underline!==r.underline||e.capitalization!==r.capitalization||e.color!==r.color||e.highlightColor!==r.highlightColor||e.styleName!==r.styleName||e.isFollowUp!==r.isFollowUp||e.link!==r.link||e.isReference!==r.isReference||e.languageId!==r.languageId||e.objectType!==r.objectType}}]),n}();var Yy=function(){return new Map([[Hn.getTypeName(),new Xy]])};h();var Zy=w(R()),ek=w(B());var tk=function(){function n(){(0,Zy.default)(this,n),this.changesByInputKey=new Map,this.changesByWorkflowExecutionKey=new Map}return(0,ek.default)(n,[{key:"removeInputChanges",value:function(e,r){var t=this.changesByInputKey.get(e);if(t===void 0)throw new Error(`InputKey '${e}' not found.`);t.delete(r),t.size===0&&this.changesByInputKey.delete(e);var a=this.changesByWorkflowExecutionKey.get(r);if(a===void 0)throw new Error(`WorkflowExecutionKey '${r}' not found.`);a.delete(e),a.size===0&&this.changesByWorkflowExecutionKey.delete(r)}},{key:"getInputChanges",value:function(e,r){var t=this.changesByInputKey.get(e),a=t==null?void 0:t.get(r);return a}},{key:"getInputChangesByWorkflowExecutionKey",value:function(e){var r=this.changesByWorkflowExecutionKey.get(e);return r?Array.from(r):void 0}},{key:"getInputChangesByInputKey",value:function(e){var r=this.changesByInputKey.get(e);return r?Array.from(r):void 0}},{key:"setInputChangesByInputKey",value:function(e,r){var t=Ln(this.changesByInputKey,e,function(){return new Map});for(var a of t.keys())t.set(a,r),Ln(this.changesByWorkflowExecutionKey,a,function(){return new Map}).set(e,r);return Array.from(t.keys())}},{key:"setInputChanges",value:function(e,r,t){Ln(this.changesByInputKey,e,function(){return new Map}).set(r,t),Ln(this.changesByWorkflowExecutionKey,r,function(){return new Map}).set(e,t)}}]),n}();var ok=function(){function n(o,e){(0,nk.default)(this,n),this.sessionCache=o,this.inputChangesTracker=e!=null?e:new tk,this.itemDeltaGenerators=Yy()}return(0,rk.default)(n,[{key:"getChanges",value:function(e,r){var t=this,a=H([e].concat((0,vo.default)(r))),s=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(a);if(s){var u=s.map(function(l){var f=(0,mo.default)(l,2),c=f[0],d=f[1],p=Wn(c),g=p.pop();return t.inputChangesTracker.setInputChanges(c,a,Object.assign(Object.assign({},d),{canReset:!0})),{id:g,parentPath:p,delta:d.delta,op:d.op}});return u}}},{key:"applyChanges",value:function(e){var r=this,t=new E({operationName:"InputChangesManagerApplyChanges",success:!0}).start();e.forEach(function(a){var s=y.getTypeNameFor(a);switch(s){case Pe.getTypeName():r.markItemsAsModified(a.items,a.parentPath);break;case Ge.getTypeName():r.markItemsAsDeleted(a.items,a.parentPath);break;case kn.getTypeName():r.markItemsAsDeleted(a.items,a.prevParentPath);break;default:break}}),t.stop().durationMs>10&&m.info(527523975,v.CoreDefault,t)}},{key:"setWorkflowInputs",value:function(e,r,t){var a=this,s,u=H([r].concat((0,vo.default)(t))),l=(s=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(u))!==null&&s!==void 0?s:[];l.forEach(function(T){var I=(0,mo.default)(T,2),_=I[0],M=I[1];return a.inputChangesTracker.removeInputChanges(_,u)});for(var f=0,c=0;f<e.length||c<l.length;)if(l[c]!==void 0&&e[f]!==void 0){var d=(0,mo.default)(l[c],2),p=d[0],g=d[1],k=H(e[f].path);(g==null?void 0:g.op)===xt.Deleted?(this.inputChangesTracker.setInputChanges(p,u,g),c++):p===k?(this.inputChangesTracker.setInputChanges(p,u,g),c++,f++):(this.inputChangesTracker.setInputChanges(k,u,{op:xt.Added,deltaType:e[f].deltaType,canReset:!0}),f++)}else if(l[c]!==void 0){var S=(0,mo.default)(l[c],2),x=S[0],C=S[1];this.inputChangesTracker.setInputChanges(x,u,C),c++}else this.inputChangesTracker.setInputChanges(H(e[f].path),u,{op:xt.Added,deltaType:e[f].deltaType,canReset:!0}),f++}},{key:"resetChanges",value:function(e,r){var t=this,a,s=H([e].concat((0,vo.default)(r)));(a=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(s))===null||a===void 0||a.forEach(function(u){var l=(0,mo.default)(u,2),f=l[0],c=l[1];if(c.canReset)switch(c.op){case xt.Deleted:t.inputChangesTracker.removeInputChanges(f,s);break;case xt.Added:case xt.Updated:t.inputChangesTracker.setInputChanges(f,s,{op:xt.None,deltaType:c.deltaType,canReset:!0});break;default:break}})}},{key:"markItemsAsModified",value:function(e,r){var t=this;e.forEach(function(a){var s=H([].concat((0,vo.default)(r),[a.id])),u=t.inputChangesTracker.getInputChangesByInputKey(s),l=t.memoizeGetItem([].concat((0,vo.default)(r),[a.id]));u==null||u.forEach(function(f){var c=(0,mo.default)(f,2),d=c[0],p=c[1];if(p.op===xt.None||p.op===xt.Updated){var g=t.itemDeltaGenerators.get(p.deltaType);if(g){var k=l();p.delta=g.generateDelta(a.body,k.body,p.delta)}p.op=xt.Updated}t.inputChangesTracker.setInputChanges(s,d,{op:p.op,deltaType:p.deltaType,delta:p.delta,canReset:!1})})})}},{key:"memoizeGetItem",value:function(e){var r=this,t=void 0,a=!1;return function(){return a||(t=r.sessionCache.getItem(e),a=!0),t}}},{key:"markItemsAsDeleted",value:function(e,r){var t=this;e.forEach(function(a){t.inputChangesTracker.setInputChangesByInputKey(H([].concat((0,vo.default)(r),[a.id])),{op:xt.Deleted,canReset:!1})})}}]),n}();h();var ik=w(R()),ak=w(B());var Sa=new Set([ke.getTypeName(),Pe.getTypeName(),ot.getTypeName(),Gt.getTypeName()]),Lt=function(){function n(o,e){(0,ik.default)(this,n),this.nextId=1,this.runtimeKind=o,this.workflowGraph=e}return(0,ak.default)(n,[{key:"applyContextIdOnOperations",value:function(e){for(var r of e){var t=y.getTypeNameFor(r);if(this.isSupportedOperation(t))for(var a of r.items){if(!a.contextId){a.contextId=this.addNewContextId();continue}if(a.source&&this.workflowGraph.getWorkflow(a.source,!1)){a.contextId=this.addNewContextId(a.contextId);continue}this.tryLogMessage(new E({operationName:"ApplyContextIdOnOperations",success:!0}).start(),"Item with a contextId but without a workflow source atribute")}}}},{key:"addNewContextId",value:function(e){var r=`${this.runtimeKind}${this.nextId++}`;return e?`${e}.${r}`:r}},{key:"isSupportedOperation",value:function(e){return Sa.has(e)}},{key:"tryLogMessage",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;e&&(e.success=t,e.resultDescription=r,m.verbose(527308633,v.CoreDefault,e.stop()))}}],[{key:"isParentContextId",value:function(e,r){return ka(e,r)}}]),n}(),Ce;(function(n){n[n.Idle=1]="Idle",n[n.Pending=2]="Pending",n[n.Running=3]="Running",n[n.Executed=4]="Executed"})(Ce||(Ce={}));h();var zc=w(ze()),sk=w(Ve()),Hc=w(Oe()),uk=w(at()),$s=w(R()),Gs=w(B());function lk(n){var o=wA();return function(){var r=(0,Hc.default)(n),t;if(o){var a=(0,Hc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,sk.default)(this,t)}}function wA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var fk=function(){function n(o){(0,$s.default)(this,n);var e=this.parseLambda(o),r=(0,uk.default)(e,3),t=r[0],a=r[1],s=r[2],u=s?a:`return ${a}`;this.prefilterFunction=new Function(t,u)}return(0,Gs.default)(n,[{key:"parseLambda",value:function(e){var r=e.indexOf("=>");if(r<0)throw new Error("Prefilter lambda does not contain '=>' operator.");var t=e.substring(0,r).trim();if(t==="")throw new Error("Prefilter lambda input is empty.");t[0]==="("&&t[t.length-1]===")"&&(t=t.substring(1,t.length-1).trim());var a=e.substring(r+2,e.length).trim();if(a==="")throw new Error("Prefilter lambda body is empty.");var s=a[0]==="{";return[t,a,s]}}]),n}(),ck=function(n){(0,zc.default)(e,n);var o=lk(e);function e(r){return(0,$s.default)(this,e),o.call(this,r)}return(0,Gs.default)(e,[{key:"evaluate",value:function(t){return this.prefilterFunction(t.scopeItem.body)}}]),e}(fk),dk=function(n){(0,zc.default)(e,n);var o=lk(e);function e(r){return(0,$s.default)(this,e),o.call(this,r)}return(0,Gs.default)(e,[{key:"evaluate",value:function(t){var a;if(((a=t.scopeItem.deltas)===null||a===void 0?void 0:a.length)>0){for(var s of t.scopeItem.deltas)if(this.prefilterFunction(s))return!0;return!1}else return this.prefilterFunction(t.scopeItem.delta)}}]),e}(fk);h();var Zs=w(Se()),hd=w(R()),md=w(B());h();var Xo=w(at()),_t=w(Se()),Iw=w(R()),_w=w(B()),Ye=w(Ao()),Aw=w(ze()),Mw=w(Ve()),pd=w(Oe());var bw=w(Rn());h();var vk=w(at()),Ca=w(Se()),yk=w(R()),kk=w(B()),wk=w(ze()),Sk=w(Ve()),jc=w(Oe());var Kc=w(ji());h();var pk=w(ze()),gk=w(Ve()),Vc=w(Oe()),Qc=w(R()),Jc=w(B());var hk=w(Rn());function SA(n){var o=CA();return function(){var r=(0,Vc.default)(n),t;if(o){var a=(0,Vc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,gk.default)(this,t)}}function CA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var xA=new G("sequencerTimeoutWhenNotWaitingSeedCompleteInMs",5e3),TA=new G("sequencerTimeoutSeedCompleteInMs",3e5),IA=new G("sequencerTimeoutWhenWaitingOnSeedCompleteInMs",3e4),_A=new G("sequencerTimeoutWhenWaitingOnGroupCompleteInMs",3e4),AA=new G("sequencerMaxQueueLength",1e3),MA=new G("sequencerAcceptedTimeout",100),bA=new G("sequencerLostMessageTimeout",305e3),EA=new G("seedMessageErrors1",!0),NA=new G("seedMessageErrors2",!1),DA=new G("syncErrorOnSessionClose",!0),zt;(function(n){n[n.SeedingDidNotStartTooShortSession=0]="SeedingDidNotStartTooShortSession",n[n.SeedingDidNotStartTimedOut=1]="SeedingDidNotStartTimedOut",n[n.SeedingStartedButFailed=2]="SeedingStartedButFailed",n[n.SeedingCompleted=3]="SeedingCompleted",n[n.SeedingStartedButTimedOut=4]="SeedingStartedButTimedOut",n[n.SeedingStartedButSessionClosed=5]="SeedingStartedButSessionClosed"})(zt||(zt={}));var PA=function(){function n(o,e,r){(0,Qc.default)(this,n),this.sequencer=o,this.healthEvent=new Re({sessionHealthEventName:"QueueAndApplySyncMessage",source:Te.Core,reason:pe.Unknown,impact:Ie.MissingInput,success:!0,message:`seq=${e.seq}`,resourceId:e.seq<=0?"Seeding":"NonSeeding",dimension0:"synchronous"}).start(),this.cc=st(),this.done=r,this.syncMessage=e,this.acceptanceTimeout=setTimeout(this.onAcceptanceTimeout.bind(this),MA.getValue()),this.lostMessageTimeout=setTimeout(this.onLostMessageTimeout.bind(this),bA.getValue())}return(0,Jc.default)(n,[{key:"onAcceptanceTimeout",value:function(){this.done(void 0,new cn),this.acceptanceTimeout=void 0}},{key:"onLostMessageTimeout",value:function(){this.lostMessageTimeout=void 0,this.healthEvent.success=!1,this.healthEvent.message+=" Message Lost",this.healthEvent.dimension1=Ue[Ue.SyncMessageLost],m.info(537002506,v.CoreDefault,this.healthEvent.stop())}},{key:"apply",value:function(){var e=this,r;try{m.verbose(537002519,v.CoreDefault,function(){return`SyncMessageSequencer.applySyncMessage: Applying SyncMessage. seq ${e.syncMessage.seq}, operations count = ${e.syncMessage.ops.length}`}),this.sequencer.emit("applyingSeq",this.syncMessage.seq);var t=V();t.markForLogging(),this.sequencer.applyMessageCallback(this.syncMessage,this.onCompleted.bind(this))}catch(s){var a=(r=s==null?void 0:s.stack)!==null&&r!==void 0?r:"";m.info(507069856,v.CoreDefault,a),this.healthEvent.message+=` ${a}`,this.onCompleted(new Y({error:"Failed to commit",code:Ue.SyncMessageException}))}}},{key:"onCompleted",value:function(e,r){var t=this;Le(function(){t.lostMessageTimeout&&(clearTimeout(t.lostMessageTimeout),t.lostMessageTimeout=void 0),t.acceptanceTimeout?(clearTimeout(t.acceptanceTimeout),t.acceptanceTimeout=void 0,t.done(e,r)):t.healthEvent.dimension0="asynchronous",e&&(t.sequencer.stats.syncMessagesIgnored++,t.syncMessage.seq===0&&t.sequencer.seedErrors++,t.healthEvent.reason===pe[pe.Unknown]&&t.healthEvent.setReason(pe.Core),t.healthEvent.success=!1,Y.typeGuard(e)&&(t.healthEvent.message+=` ${e.error}`,t.healthEvent.dimension1=e.code?Ue[e.code]:Ue[Ue.Unknown])),m.info(507265567,v.CoreDefault,t.healthEvent.stop())},this.cc)}}]),n}(),An;(function(n){n[n.None=0]="None",n[n.Sequenced=1]="Sequenced",n[n.Reconnect=2]="Reconnect",n[n.Reseeding=3]="Reseeding"})(An||(An={}));var mk=function(n){(0,pk.default)(e,n);var o=SA(e);function e(r,t){var a;return(0,Qc.default)(this,e),a=o.call(this),a.seedErrors=0,a.prevSeq=-1,a.groupCount=0,a.groupSize=0,a.groupId=void 0,a.fullFileSeedingComplete=!1,a.cache=new Yn,a.applyMessageCallback=r,a.seedSessionHealthEvent=new Re({sessionHealthEventName:"SessionFullFileSeeding",source:Te.Core,reason:pe.Unknown,impact:Ie.MissingInput,success:!1,message:"",metricCount:!1}).start(),a.seedSessionLogTimeout=setTimeout(function(){a.logForFullFileSeeding(!0)},TA.getValue()),a.seedSessionLogTimeout.unref&&a.seedSessionLogTimeout.unref(),a.stats={seedMode:t?An.Reconnect:An.None,seedSuccess:!1,seedItems:0,seedMessageCount:0,seedGroupSize:0,seedDurationMs:0,syncMessageCount:0,syncMessagesOutOfSequence:0,syncMessagesAbandoned:0,syncMessagesIgnored:0,syncMessageQueueLimitReached:!1},a}return(0,Jc.default)(e,[{key:"setClientMetadata",value:function(t){this.seedSessionHealthEvent.setClientMetadata(t)}},{key:"onSyncMessage",value:function(t,a){var s=this,u,l=new PA(this,t,function(c,d){var p=V(),g=p.startSync(Z.SyncMessageSequencerSendResponse);a(c,d),p.stop(g)});try{if(this.updateGroupParameters(t),m.debug(537002498,v.CoreDefault,function(){return`SyncMessageSequencer.onSyncMessage: SyncMessage received. seq ${t.seq}, ${s.groupParametersToString(t)}, operations count = ${t.ops.length}`}),this.stats.syncMessageCount++,!this.validateSyncMessageAndHandleErrors(l))return;t.seq===0&&this.prevSeq===-1?this.handleSeedMessage(l):this.handleNonSeedMessage(l)}catch(c){var f=(u=c==null?void 0:c.stack)!==null&&u!==void 0?u:"";throw m.info(507069855,v.CoreDefault,f),l.healthEvent.message+=` ${f}`,l.onCompleted(new Y({error:"Failed to Commit",code:Ue.SyncMessageException})),c}}},{key:"getStats",value:function(){return this.stats}},{key:"onClose",value:function(){this.seedSessionLogTimeout&&this.logForFullFileSeeding(!1,!0);for(var t of this.cache.keys()){var a=this.cache.get(t);a&&(DA.getValue()?a.onCompleted(new Y({code:Ue.SyncMessageSessionClosed,error:"Sync message ignored since session is closing."})):a.onCompleted(void 0,new cn))}this.cache.clear()}},{key:"validateSyncMessageAndHandleErrors",value:function(t){if(t.syncMessage.seq<=-1)return t.onCompleted(new Y({code:Ue.SyncMessageUnsupported,error:Wt.UnsupportedSyncMessage})),!1;if(t.syncMessage.seq===0){if(this.fullFileSeedingComplete){if(m.info(507388064,v.CoreDefault,"SyncMessageSequencer.validateSyncMessageAndHandleErrors: SyncMessage with seq0 came in after fullFileSeedingComplete "),EA.getValue())return t.onCompleted(new Y({code:Ue.SyncMessageUnexpectedSeed,error:Wt.UnexpectedSeedMessage})),!1;if(this.prevSeq===-1)return t.onCompleted(new Y({code:Ue.SyncMessageUnexpectedSeed,error:Wt.UnexpectedSeedMessage})),!1}else if(this.prevSeq!==-1&&(m.info(507277377,v.CoreDefault,"SyncMessageSequencer.validateSyncMessageAndHandleErrors: SyncMessage with seq0 came in after prevSeq is !== -1 and fullFileSeedingComplete is false"),NA.getValue()))return t.onCompleted(new Y({code:Ue.SyncMessageUnexpectedSeed,error:Wt.UnexpectedSeedMessage})),!1;return!0}if(this.cache.size()>=AA.getValue())return this.stats.syncMessageQueueLimitReached=!0,t.onCompleted(new Y({code:Ue.SyncMessageQueueFull,error:"Sync messages were ignored since queue was full"})),!1;if(t.syncMessage.seq!==0&&t.syncMessage.seq<=this.prevSeq)return t.onCompleted(new Y({code:Ue.SyncMessageTooLateOrDuplicate,error:"Sync messages were ignored since they were either late or duplicate"})),!1;if(this.groupId&&t.syncMessage.groupId){var a=Number.parseInt(this.groupId,10),s=Number.parseInt(t.syncMessage.groupId,10);if(s>0&&s>a)return!0;if(this.groupId!==t.syncMessage.groupId)return t.onCompleted(new Y({code:Ue.SyncMessageGroupIdMismatch,error:"Sequencer group Id does not match syncMessage group Id"})),!1}return!0}},{key:"handleSeedMessage",value:function(t){t.healthEvent.resourceId="Seeding",this.stats.seedMode===An.Reconnect?this.stats.seedMode=An.Reseeding:this.stats.seedMode===An.None&&(this.stats.seedMode=An.Sequenced),this.emit("seedMessageReceived"),(!t.syncMessage.groupId||this.groupCount===this.groupSize)&&this.emit("lastSeedMessageReceived"),t.apply(),this.stats.seedMessageCount++,t.syncMessage.groupId?this.updateSeedGroup(t.syncMessage):this.completeSeeding()}},{key:"checkSyncMessageToStopPreviousGroup",value:function(t){if(this.groupId&&t.groupId){var a=Number.parseInt(this.groupId,10),s=Number.parseInt(t.groupId,10);s>0&&s>a&&this.stopPreviousGroup(t)}}},{key:"getTimeoutInMs",value:function(){return this.groupId?_A.getValue():this.prevSeq===-1?IA.getValue():xA.getValue()}},{key:"handleNonSeedMessage",value:function(t){t.healthEvent.resourceId="NonSeeding",this.checkSyncMessageToStopPreviousGroup(t.syncMessage);var a=this.cache.get(t.syncMessage.seq);if(a){t.onCompleted(new Y({code:Ue.SyncMessageUnprocessedDuplicate,error:`SyncMessage with seq=${t.syncMessage.seq} is already queued for processing`}));return}this.cache.put(t.syncMessage.seq,t,this.getTimeoutInMs(),this.onTimeout.bind(this));var s=t.syncMessage.seq===this.prevSeq+1,u=this.groupId&&this.groupSize===this.groupCount,l=u||this.groupId===void 0&&s;m.info(520220801,v.CoreDefault,`SyncMessageSequencer.handleNonSeedMessage: groupComplete ${u}, ${l}, groupId ${t.syncMessage.groupId}, SyncMessage.groupSize ${t.syncMessage.groupSize}, Message Sequence ${t.syncMessage.seq}`),s||this.stats.syncMessagesOutOfSequence++,l?this.applyNextSequence(t):V().startAsync(Z.WaitingForInOrderMessage)}},{key:"tryToApplyNextMessage",value:function(){var t=this.cache.get(this.prevSeq+1);t&&this.applyNextSequence(t)}},{key:"onTimeout",value:function(t,a){m.info(537002514,v.CoreDefault,`SyncMessageSequencer.onTimeout: Performing best-effort sync of next sequence after ${this.prevSeq}, ${this.groupParametersToString(a.syncMessage)}`),this.fullFileSeedingComplete||this.logForFullFileSeeding(!0,!1),this.applyNextSequence(a),this.resetGroupParameters()}},{key:"stopPreviousGroup",value:function(t){if(m.info(508839882,v.CoreDefault,`SyncMessageSequencer.stopPreviousGroup: Pervious group ID: ${this.groupId} new group ID: ${t.groupId}`),Q("groupStopErrorResponse"))for(var a of this.cache.keys()){var s=this.cache.get(a);s&&s.onCompleted(new Y({code:Ue.SyncMessageGroupStop,error:`Sequencer group changed to ${t.groupId}. Dropping queued messages`}))}this.cache.clear();var u=Number.parseInt(this.groupId,10);u<=0&&(this.completeSeeding(),this.emit("lastSeedMessageReceived")),this.resetGroupParameters(),this.updateGroupParameters(t)}},{key:"applyNextSequence",value:function(t){var a=this,s,u;Le(function(){s=V(),u=V().startSync(Z.ApplyNextSequence)},t.cc);var l=[t];this.cache.forEach(function(x,C){C!==t.syncMessage.seq&&l.push(x)}),l.sort(function(x,C){return C.syncMessage.seq-x.syncMessage.seq});for(var f=function(C){Le(function(){V().stop(Z.WaitingForInOrderMessage),s.stop(u),C.apply(),s.resume(u),Q("FixPrevSeqResetForSeq0")?a.prevSeq<C.syncMessage.seq?a.prevSeq=C.syncMessage.seq:m.info(507072897,v.CoreDefault,`PrevSeq resetting would have happened from ${a.prevSeq} to ${C.syncMessage.seq}`):a.prevSeq=C.syncMessage.seq,a.cache.del(C.syncMessage.seq)},C.cc)},c=0,d=void 0,p=l.pop();p&&p.syncMessage.seq<=t.syncMessage.seq;){var g=p.syncMessage.seq-(this.prevSeq+1);g<0&&m.info(507388099,v.CoreDefault,`abandonedMessages count: ${g} is negative`),g>0&&d===void 0&&(d=this.prevSeq+1),c+=g,f(p),p=l.pop()}if(c>0){this.stats.syncMessagesAbandoned+=c;var k=d===0&&c===1?pe.Client:pe.ClientRuntime,S=new Re({sessionHealthEventName:"AbandonedSyncMessage",source:Te.Core,reason:k,impact:Ie.MissingInput,success:!1,count:c,message:`seq=${d}`,resourceId:d===0&&c===1?"Seeding":"NonSeeding"});m.info(537002516,v.CoreDefault,S)}for(;p&&p.syncMessage.seq===this.prevSeq+1;)f(p),p=l.pop();this.groupId&&this.resetGroupParameters(),s.stop(u)}},{key:"updateSeedGroup",value:function(t){this.stats.seedItems+=t.ops.reduce(function(a,s){return a+s.items.length},0),this.groupCount===this.groupSize&&this.completeSeeding()}},{key:"completeSeeding",value:function(){this.fullFileSeedingComplete=!0,this.stats.seedSuccess=this.seedErrors===0,this.stats.seedGroupSize=this.groupSize,this.stats.seedDurationMs=this.seedSessionHealthEvent.durationMs,this.prevSeq=0,this.logForFullFileSeeding(),this.tryToApplyNextMessage(),this.emit("seedCompleted"),this.resetGroupParameters()}},{key:"logForFullFileSeeding",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.seedSessionHealthEvent.stop(),clearTimeout(this.seedSessionLogTimeout),this.seedSessionLogTimeout=void 0;var s=this.fullFileSeedingComplete&&this.stats.seedSuccess;this.seedSessionHealthEvent.success=s,s?this.seedSessionHealthEvent.dimension1=zt[zt.SeedingCompleted]:this.stats.seedMessageCount<=0?t?this.seedSessionHealthEvent.dimension1=zt[zt.SeedingDidNotStartTimedOut]:a?this.seedSessionHealthEvent.dimension1=zt[zt.SeedingDidNotStartTooShortSession]:m.info(507107075,v.CoreDefault,"seeding did not start nor succeeded for unknown reasons"):this.stats.seedMessageCount>0&&(t?this.seedSessionHealthEvent.dimension1=zt[zt.SeedingStartedButTimedOut]:a?this.seedSessionHealthEvent.dimension1=zt[zt.SeedingStartedButSessionClosed]:this.seedSessionHealthEvent.dimension1=zt[zt.SeedingStartedButFailed]),this.seedSessionHealthEvent.resourceId=`Full file seeding completed: ${this.fullFileSeedingComplete}. Seed mode: ${An[this.stats.seedMode]}`,this.seedSessionHealthEvent.message=`Number of received messages: ${this.groupCount}. Number of expected messages: ${this.groupSize>0?this.groupSize:"unknown"}.`,m.info(537002524,v.CoreDefault,this.seedSessionHealthEvent)}},{key:"groupParametersToString",value:function(t){if(this.groupId){var a=t?`, groupId ${t.groupId}, syncMessage.groupComplete ${t.groupComplete}`:`groupId ${this.groupId}`;return`inGroup true, groupCount ${this.groupCount}, groupSize ${this.groupSize} ${a}`}else return"inGroup false"}},{key:"resetGroupParameters",value:function(){this.groupCount=0,this.groupSize=0,this.groupId=void 0}},{key:"updateGroupParameters",value:function(t){var a,s,u;t.groupId=(a=t.groupId)!==null&&a!==void 0?a:t.batchId,t.groupSize=(s=t.groupSize)!==null&&s!==void 0?s:t.batchSize,t.groupComplete=(u=t.groupComplete)!==null&&u!==void 0?u:t.batchComplete,t.groupId!==void 0&&(this.groupId===void 0&&(this.groupId=t.groupId),this.groupId===t.groupId&&(this.groupCount++,t.groupComplete&&(this.groupSize=t.groupSize,this.groupCount!==this.groupSize&&m.info(537002525,v.CoreDefault,`SyncMessageSequencer.updateGroupParameters: GroupComplete message is not last message in group ${t.groupId}. groupCount=${this.groupCount}, groupSize=${this.groupSize}.`))))}}]),e}(hk.EventEmitter);function RA(n){var o=BA();return function(){var r=(0,jc.default)(n),t;if(o){var a=(0,jc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Sk.default)(this,t)}}function BA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Ck=function(n){(0,wk.default)(e,n);var o=RA(e);function e(r){var t;return(0,yk.default)(this,e),t=o.call(this,r),t.annotationTypeFirstInstanceLogged=new Set,t}return(0,kk.default)(e,[{key:"persistAnnotationQueue",value:function(t,a,s){var u=this,l,f,c,d,p=V().startSync(Z.PersistAnnotationQueueStateful),g=new Map,k=new Map;for(var S of a){this.synthesizeEmptyAnnotationQueueEntriesIfNecessary(t,S.scopeItemPath,S.scopeItemRevId,S.annotationQueue);var x=function(se,de,ye){var He=ye?k:g;if(de&&de.length>0){var Ct,we=He.get(se);we||(we=[],He.set(se,we)),(Ct=we).push.apply(Ct,(0,Ca.default)(de))}};if(this.isWorkflowInReduceStyle(t)&&t.outputTypes){var C=[].concat((0,Ca.default)(t.outputTypes),[rn.getTypeName()]),T=this.session.cache.getSubtreeItems(S.scopeItemPath,C,function(re){return re.source===t.id}),I=new Map;for(var _ of T){var M=void 0;rn.typeGuard(_.body)?M=_.body.annotationTypeName:M=y.getTypeNameFor(_.body);var A=I.get(M);A?A.push(_):(A=[_],I.set(M,A))}var b=function(se){var de=S.annotationQueue.filter(function(ye){return ye.annotationType===se});u.processSubtreeAnnotationQueue(t,se,de,(l=I.get(se))!==null&&l!==void 0?l:[],x,S.source)};for(var N of t.outputTypes)b(N)}else this.processAnnotationQueueInternal(t,S.annotationQueue,x)}if(g.size>0||k.size>0){var z=new Array(g.size),L=0;for(var J of[{opsByType:g,areApologies:!1},{opsByType:k,areApologies:!0}]){var P=J.opsByType,D=J.areApologies;for(var O of P.keys()){var $=P.get(O),F=0,q=0,W=0;for(var K of $){var X=y.getTypeNameFor(K);X===ke.getTypeName()?F+=((f=K.items)===null||f===void 0?void 0:f.length)||0:X===Pe.getTypeName()?q+=((c=K.items)===null||c===void 0?void 0:c.length)||0:X===Ge.getTypeName()&&(W+=((d=K.items)===null||d===void 0?void 0:d.length)||0)}z[L++]={type:D?`Apology<${O}>`:O,added:F,updated:q,deleted:W}}}s.message=`Committing annotation changes: ${JSON.stringify(z)}`,V().stop(p),this.commitAnnotations(t,g,k)}else V().stop(p),s.message="No annotation changes to commit";s.dimension1="Stateful"}},{key:"synthesizeEmptyAnnotationQueueEntriesIfNecessary",value:function(t,a,s,u){if(t.kind===U.SingleItem){var l=function(d){u.some(function(p){return p.annotationType===d})||u.push({path:a,revId:s,annotationType:d,annotations:[],areApologies:!1})};for(var f of t.outputTypes||[])l(f)}}},{key:"processSubtreeAnnotationQueue",value:function(t,a,s,u,l,f){var c=this;if(f===yo.ApologiesGenerator){this.processAnnotationQueueInternal(t,s,l);return}var d=new Map,p=new Map;for(var g of u){var k=rn.typeGuard(g.body)?p:d,S=H(g.parentPath),x=k.get(S);x||(x=[],k.set(S,x)),x.push(g)}for(var C of s){var T=H(C.path);d.delete(T),p.delete(T)}var I=function(M,A){var b=[];for(var N of M){var z=(0,vk.default)(N,2),L=z[0],J=z[1];c.generateAnnotationDeleteOps(t,Wn(L),void 0,!1,J,b)}l(a,b,A)};I(d,!1),I(p,!0),this.processAnnotationQueueInternal(t,s,l)}},{key:"processAnnotationQueueInternal",value:function(t,a,s){for(var u of a)if(u.ancestorType){var l=this.session.cache.getFirstAncestorOfType(u.path,[u.ancestorType]);if(!l)throw new Error(`Failed to get ancestor of type ${u.ancestorType} on path ${H(u.path)} (no match)`);this.applyAnnotations(t,[].concat((0,Ca.default)(l.parentPath),[l.id]),void 0,!1,u,s)}else this.applyAnnotations(t,u.path,u.revId,u.isTriggeredBySyncDelta,u,s)}},{key:"applyAnnotations",value:function(t,a,s,u,l,f){var c=l.annotationType,d=l.annotations,p=l.sourceInfo,g=l.areApologies,k;try{var S=[].concat((0,Ca.default)(t.outputTypes),[rn.getTypeName()]);k=this.session.cache.getItemChildren(a,S)}catch(L){if(L instanceof uo){m.info(529093124,v.CoreDefault,`Annotations ignored because parent ${H(a)} no longer exists`);return}else throw L}var x=[];for(var C of k)C.source===t.id&&(rn.typeGuard(C.body)&&C.body.annotationTypeName===c||!g&&y.getTypeNameFor(C.body)===c)&&x.push(C);var T=[],I=[];this.compareAnnotationsToExistingChildren(a,t,d,c,l.isImmediateAnnotation,x,T,I,p);var _=[],M=[];for(var A of x)rn.typeGuard(A.body)?_.push(A):M.push(A);var b=[],N=[];Q("DeleteOpsBeforeAdds")?(g||this.generateAnnotationDeleteOps(t,a,s,u,M,b),this.generateAnnotationDeleteOps(t,a,s,u,_,N),this.generateAnnotationAddOps(a,s,u,T,g?N:b),this.generateAnnotationUpdateOps(a,s,u,I,g?N:b)):(this.generateAnnotationAddOps(a,s,u,T,g?N:b),this.generateAnnotationUpdateOps(a,s,u,I,g?N:b),g||this.generateAnnotationDeleteOps(t,a,s,u,M,b),this.generateAnnotationDeleteOps(t,a,s,u,_,N));var z=function(J){for(var P of J)for(var D of P.items)D.contextId=l.contextId};z(b),z(N),f(c,b,!1),f(c,N,!0)}},{key:"isWorkflowInReduceStyle",value:function(t){return t.kind===U.Reduce||t.kind===U.Generic&&t.dynamicExecutionPreferences===void 0}},{key:"compareAnnotationsToExistingChildren",value:function(t,a,s,u,l,f,c,d,p){var g=this,k=function(C){C.id||(C.id=an());var T=C.id;C.id=void 0;var I=C.M_;C.M_=void 0;var _=g.compareAnnotationToExistingChildren(a,C,T,u,f,l),M=_.shouldAddAnnotation,A=_.shouldUpdateAnnotation,b=_.itemId;C.id=T,C.M_=I,M&&(C.M_=Object.assign(Object.assign({},C.M_),{state:Rt.Created}),g.logMetaData(Rt.Created,u,C.ownerId));var N=p?{id:b,parentPath:t,source:a.id,body:C,sourceInfo:p}:{id:b,parentPath:t,source:a.id,body:C},z="Not changing";M?(c.push(N),z="Adding"):A&&(d.push(N),z="Updating"),m.debug(529093125,v.CoreDefault,function(){return`${z} annotation ${C.id} (type: ${y.getTypeNameFor(C)}, workflow: ${a.id})`})};for(var S of s)k(S)}},{key:"compareAnnotationToExistingChildren",value:function(t,a,s,u,l,f){for(var c={shouldAddAnnotation:!0,shouldUpdateAnnotation:!1,itemId:""},d=rn.typeGuard(a),p=0;p<l.length;p++){var g=l[p].body;if(d&&!rn.typeGuard(g)){l.splice(p--,1);continue}var k=g.id;g.id=void 0;var S=g.M_;g.M_=void 0;var x=!1;if(Q("ApplyAnnotationOptimization")?(!en(t)||wa(t)||f)&&(0,Kc.default)(g,a)?(x=!0,c.shouldAddAnnotation=!1):s===k&&(x=!0,c.shouldUpdateAnnotation=!0,c.shouldAddAnnotation=!1,c.itemId=l[p].id):(!en(t)||wa(t))&&(0,Kc.default)(g,a)?(x=!0,c.shouldAddAnnotation=!1):s===k&&(x=!0,c.shouldUpdateAnnotation=!0,c.shouldAddAnnotation=!1,c.itemId=l[p].id),g.id=k,g.M_=S,x){this.logMetaData(Rt.Duplicated,u,g.ownerId),l.splice(p,1);break}}return c.shouldAddAnnotation&&(c.itemId=this.session.cache.getNextAnnotationId()),c}},{key:"commitAnnotations",value:function(t,a,s){var u=this,l=V(),f=l.startSync(Z.CommitAnnotations),c=function(p,g,k){if(p.length){u.session.contextIdManager.applyContextIdOnOperations(p),u.session.updateWorkflowExecutionStates(p);try{u.session.cache.applyOperations(p,void 0)}catch(_){m.info(529093126,v.CoreDefault,new Re({sessionHealthEventName:"FailedApplyingAnnotationsToCache",source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,success:!1,message:"",affectedWorkflows:[t.resourceId]})),m.error(529093127,v.CoreDefault,`Error applying annotation results to cache: ${_.message}`)}var S=g;if(k){var x=p.find(function(_){return!Ge.typeGuard(_)});if(x){var C=x.items[0].body.annotationTypeName;S=`Apology<${C}>`}}var T=u.session.annotationActivationInfosByType.get(g);if(xk.getValue()&&T&&(!k||T.some(function(_){return _.sendApologies}))){var I=p.map(function(_){var M=new Array(_.items.length),A=0;for(var b of _.items)if(b.body){var N=b.body;u.logMetaData(Rt.Sent,S,N.ownerId),M[A++]={id:b.id,body:N,contextId:b.contextId}}return M.length=A,new vt({parentPath:_.parentPath,items:M,M_:{state:Rt.Sent}})});try{u.session.cache.applyOperations(I,void 0)}catch(_){m.info(529093128,v.CoreDefault,new Re({sessionHealthEventName:"FailedSettingAnnotationStateToSent",source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,success:!1,message:"",affectedWorkflows:[t.resourceId]})),m.error(529093129,v.CoreDefault,"Error setting annotation state to sent")}}l.stop(f),u.session.sendAnnotations(g,p,k,t),l.resume(f),u.logAnnotationTypeFirstInstance(S)}};a.forEach(function(d,p){c(d,p,!1)}),s.forEach(function(d,p){c(d,p,!0)}),l.stop(f)}},{key:"logMetaData",value:function(t,a,s){s||(s=""),m.info(529093130,v.CoreDefault,new Pi({sessionKey:this.session.sessionKey,annotationType:a,annotationState:t,workflowId:Ns(s)}))}},{key:"logAnnotationTypeFirstInstance",value:function(t){this.session.syncMessageSequencer.getStats().seedMode===An.Sequenced&&!this.annotationTypeFirstInstanceLogged.has(t)&&(m.info(529093131,v.CoreDefault,new E({operationName:"FirstAnnotation",resourceId:t,durationMs:Date.now()-this.session.startTime,resultSignature:"SinceSessionStart",success:!0},{metricDuration:!0})),this.annotationTypeFirstInstanceLogged.add(t))}}]),e}(Ls);h();var Tk=w(R()),Ik=w(B()),_k=w(ze()),Ak=w(Ve()),Xc=w(Oe());function WA(n){var o=OA();return function(){var r=(0,Xc.default)(n),t;if(o){var a=(0,Xc.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Ak.default)(this,t)}}function OA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Mk=function(n){(0,_k.default)(e,n);var o=WA(e);function e(r,t){var a;return(0,Tk.default)(this,e),a=o.call(this,r),a.itemListeners=t,a}return(0,Ik.default)(e,[{key:"persistAnnotationQueue",value:function(t,a,s){var u=this,l=V(),f=l.startSync(Z.PersistAnnotationQueueStateless),c=new Array(a.length),d=0;for(var p of a){var g=function(x){var C=[],T=x.annotations.map(function(I){return x.sourceInfo?{id:u.session.cache.getNextAnnotationId(),parentPath:x.path,source:t.id,contextId:x.contextId,body:I,sourceInfo:x.sourceInfo}:{id:u.session.cache.getNextAnnotationId(),parentPath:x.path,source:t.id,contextId:x.contextId,body:I}});u.generateAnnotationAddOps(x.path,x.revId,x.isTriggeredBySyncDelta,T,C),u.session.contextIdManager.applyContextIdOnOperations(C),u.session.updateWorkflowExecutionStates(C),u.itemListeners.emitEvents(C),l.stop(f),u.session.sendAnnotations(x.annotationType,C,x.areApologies,t),l.resume(f),c[d++]={type:x.annotationType,added:C.reduce(function(I,_){var M;return I+(((M=_.items)===null||M===void 0?void 0:M.length)||0)},0),updated:0,deleted:0}};for(var k of p.annotationQueue)g(k)}s.message=c.length>0?`Committing annotation changes: ${JSON.stringify(c)}`:"No annotation changes to commit",s.dimension1="Stateless",l.stop(f)}}]),e}(Ls);h();var ie=w(Se()),Vt=w(at()),Bk=w(Ao()),Wk=w(ze()),Ok=w(Ve()),td=w(Oe()),zs=w(R()),Vs=w(B());h();var Us=w(R()),Hs=w(B());var Yc=function(){function n(o){(0,Us.default)(this,n),y.assign(n,this,o)}return(0,Hs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_ContentSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Yc.H_={T_:Yc.getTypeName(),B_:Yc.getBaseTypes()};var Zc=function(){function n(o){(0,Us.default)(this,n),y.assign(n,this,o)}return(0,Hs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_BaseSubstrateSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Zc.H_={T_:Zc.getTypeName(),B_:Zc.getBaseTypes()};var xa=function(){function n(o){(0,Us.default)(this,n),y.assign(n,this,o)}return(0,Hs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_CorrelatedSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();xa.H_={T_:xa.getTypeName(),B_:xa.getBaseTypes()};var Lk=w(Rn());h();var LA=new G("fullInvalidationThreshold",.85),ed=new G("enableLoggingUnexpectedItems",!1),bk=function(o,e,r,t){var a=[];if(t=t!=null?t:LA.getValue(),e.size===0||e.size/r.length>=t){var s=[];for(var u of r)u?s.push(u):ed.getValue()&&m.info(537678304,v.CoreDefault,"Undefined sibling item is detected.");a.push(s)}else{for(var l=new Map,f=0;f<r.length;f++)r[f]?l.set(r[f].id,f):ed.getValue()&&m.info(537678305,v.CoreDefault,"Undefined sibling item is detected.");for(;e.size>0;){var c=[],d=e.keys().next().value,p=d,g=l.get(p);if(g===void 0){m.info(537678306,v.CoreDefault,`SiblingItems doesn't contain invalidated item with id ${p}`),e.delete(p);continue}c.push(r[g]);for(var k=g+1<r.length?r[g+1].id:void 0;e.has(k);)p=k,g+=1,c.push(r[g]),e.delete(p),k=g+1<r.length?r[g+1].id:void 0;p=d,g=l.get(p);for(var S=g-1>=0?r[g-1].id:void 0;e.has(S);)p=S,g-=1,c.unshift(r[g]),e.delete(p),S=g-1>=0?r[g-1].id:void 0;e.delete(d),a.push(c)}}if(o.workflow.dynamicExecutionPreferences.inputSize===-1)return a;var x=[];for(var C of a)for(var T=0,I=o.workflow.dynamicExecutionPreferences.inputSize;T<C.length;){for(var _=0,M=[];_<I&&T<C.length;){if(C[T]&&C[T].body){var A=C[T].body;if(M.push(C[T]),o.workflow.dynamicExecutionPreferences.inputSizeUnit===Pn.Character)_+=A?A.content.length:0;else if(o.workflow.dynamicExecutionPreferences.inputSizeUnit===Pn.Paragraph)_++;else{m.error(537678307,v.CoreDefault,`Unsupported UnitType: ${o.workflow.dynamicExecutionPreferences.inputSizeUnit}`);return}}else ed.getValue()&&m.info(537678336,v.CoreDefault,"Undefined sibling item is detected.");T+=1}x.push(M)}return x};h();var Ek=w(Se()),Nk=w(R()),Dk=w(B());var Pk=function(){function n(){(0,Nk.default)(this,n)}return(0,Dk.default)(n,[{key:"getBatchesByItemPath",value:function*(e,r,t){if(e.length===0)return[];if(e.length<=r()){yield e;return}var a=e.reduce(function(d,p){var g=t(p),k=H([].concat((0,Ek.default)(g.parentPath),[g.id]));return d.has(k)||d.set(k,[]),d.get(k).push(p),d},new Map),s=[],u=r();for(var l of a.values()){s.length>0&&l.length<=u&&s.length+l.length>u&&(yield s,u=r(),s=[]);for(var f=0;f<l.length;){var c=Math.min(u-s.length,l.length-f);s=s.concat(l.slice(f,f+c)),f+=c,s.length===u&&(yield s,u=r(),s=[])}}s.length>0&&(yield s)}},{key:"getBatches",value:function*(e,r){var t=[],a=r();for(var s of e)t.push(s),t.length===a&&(yield t,a=r(),t=[]);t.length>0&&(yield t)}}]),n}();function FA(n){var o=qA();return function(){var r=(0,td.default)(n),t;if(o){var a=(0,td.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Ok.default)(this,t)}}function qA(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var _r=new G("workflowExecutionManagerExtraLogging",!1),Fn;(function(n){n[n.Input=1]="Input",n[n.Context=2]="Context"})(Fn||(Fn={}));var $A=new G("deltaUpdateMinDelayMs",250),GA=new G("deltaUpdateMaxDelayMs",250),UA=function(){return{minDelayMs:$A.getValue(),maxDelayMs:GA.getValue()}},Fk=function(o){return new XA(o)},HA=new G("skipDebounceDeltasEnabled",!0),zA=new G("enableExecutionCountCheck",!1),VA=new G("sweepScopeExecutionNotificationsInterval",200),QA=new G("disableLoggingAncestorNotFoundForWorkflows",["HoneybeeRankingDelta"]),JA=new G("enableDeltaUpdateDelayPerClient",{default:!1}),Rk=new G("enableEarlyJoinCompletion",!1),jA=new Map([[ht.getTypeName(),Hn.getTypeName()]]),KA=function(){function n(){(0,zs.default)(this,n)}return(0,Vs.default)(n,[{key:"setClientMetadata",value:function(e){this.clientSettingsKey=e!=null&&e.appName&&(e!=null&&e.appPlatform)?`${e.appName.toLowerCase()}-${e.appPlatform.toLowerCase()}`:void 0}},{key:"getValue",value:function(){var e=JA.getValue();return this.clientSettingsKey&&e.hasOwnProperty(this.clientSettingsKey)?e[this.clientSettingsKey]:e.hasOwnProperty("default")?e.default:!1}}]),n}(),XA=function(n){(0,Wk.default)(e,n);var o=FA(e);function e(r){var t;return(0,zs.default)(this,e),t=o.call(this),t.sweepIntervalMs=VA.getValue(),t.areasIntersect=function(a){return!1},t.supportsAreaIntersection=function(a){return!1},t.sessionCache=r.cache,t.queueWorkflow=r.queueWorkflow,t.queueGridNeighborhoodWorkflow=r.queueGridNeighborhoodWorkflow,t.sessionCache.on("purgeModel",t.onPurgeModel.bind((0,Bk.default)(t))),t.inputChangesManager=r.inputChangesManager,t.getUserNodePath=r.getUserNodePath,t.workflowDefinitionManager=r.workflowDefinitionManager,t.workflowItemStorage=r.workflowItemStorage,t.getTenantNodePath=r.getTenantNodePath,t.getUserCommandsNodePath=r.getUserCommandsNodePath,t.sessionCreationTime=r.sessionCreationTime,t.usesRefactoredDebouncing=r.usesRefactoredDebouncing,t.workflowSynchronizationManager=r.workflowSynchronizationManager,t.workflowPrefilterManager=new qk,t.workflowQueue=r.workflowQueue,t.enableDeltaUpdateDelay=new KA,t.batchSplitter=new Pk,t.executionCompleteCallback=r.executionCompleteCallback,t.notificationManager=r.notificationManager,t.workflowExecutionTrackersByName=r.workflowExecutionTrackersByName,t.attachExecutionTrackerToEachWorkflow(r.workflowRegistrationsByName,r.workflowsByInputAnnotation,r.workflowsByOutputAnnotation,r.workflowsByRequestedContextType),t.workflowBatchSizeMax=r.workflowBatchSizeMax,t.supportsAreaIntersection=r.supportsAreaIntersection,t.areasIntersect=r.areasIntersect,t.itemScopeMovedTracker=r.itemScopeMovedTracker,t}return(0,Vs.default)(e,[{key:"pendingNotifications",get:function(){return this.notificationManager.pendingNotifications}},{key:"getAllDownstreamWorkflowIds",value:function(t){var a=new Set;Q("WaitContextProducerToComplete")?this.workflowExecutionTrackersByName.get(t).allDownstreamWorkflowExecutionTrackers.forEach(function(f){f.workflowResultType===Fn.Input&&a.add(f)}):a=this.workflowExecutionTrackersByName.get(t).allDownstreamWorkflowExecutionTrackers;var s=new Array(a?a.size:0),u=0;for(var l of a?a.values():[])s[u++]=l.workflowExecutionTracker.workflow.id;return s}},{key:"getAllUpstreamWorkflowIds",value:function(t){var a=new Set;Q("WaitContextProducerToComplete")?this.workflowExecutionTrackersByName.get(t).allUpstreamWorkflowExecutionTrackers.forEach(function(f){f.workflowResultType===Fn.Input&&a.add(f)}):a=this.workflowExecutionTrackersByName.get(t).allUpstreamWorkflowExecutionTrackers;var s=new Array(a?a.size:0),u=0;for(var l of a?a.values():[])s[u++]=l.workflowExecutionTracker.workflow.id;return s}},{key:"invalidateWorkflow",value:function(t,a){var s=this.workflowExecutionTrackersByName.get(t.workflow.id);try{if(t.workflow.kind===U.SingleItem)this.invalidateSingleItemWorkflow(s,t,a);else if(t.workflow.kind===U.DynamicText)this.invalidateDynamicWorkflow(s,t,a);else if(t.workflow.kind===U.Reduce||t.workflow.kind===U.Grid)for(var u of a)this.invalidateReduceWorkflow(s,t,u);else if(t.workflow.kind===U.Join)for(var l of a)this.invalidateJoinWorkflow(s,t,l);else if(t.workflow.kind===U.Generic)for(var f of a)this.invalidateGenericWorkflow(s,t,f);else m.error(537678240,v.CoreDefault,`Failed to invalidate workflow ${t.workflow.id}: workflow in type ${t.workflow.kind} is not supported.`)}catch(k){m.error(537678241,v.CoreDefault,`Failed to invalidate workflow ${t.workflow.id}: ${k.message}`)}finally{var c=s.getExecutionState();for(var d of a){var p=d.item;if(p!=null&&p.contextId){var g=c.get(p.contextId);g===Ce.Idle&&s.afterWorkflowExecution(p.contextId)}}}}},{key:"getWorkflowsByExecutionState",value:function(){for(var t=new Set,a=arguments.length,s=new Array(a),u=0;u<a;u++)s[u]=arguments[u];for(var l of this.workflowExecutionTrackersByName.values())s.includes(l.getWorkflowExecutionState())&&t.add(l.workflow);return t}},{key:"requestSweep",value:function(){this.ensureSweepTimer()}},{key:"onSessionClose",value:function(){this.cancelSweepTimer(),this.usesRefactoredDebouncing&&this.workflowSynchronizationManager.onSessionClose()}},{key:"evaluatePrefilters",value:function(t,a){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ft.All,u={scopeItem:a.scopeItem,inputItems:a.inputItems,clientMetadata:this.clientMetadata};return this.workflowPrefilterManager.evaluateWorkflowPrefilters(t,u,s)}},{key:"setClientMetadata",value:function(t){this.clientMetadata=t,this.enableDeltaUpdateDelay.setClientMetadata(t)}},{key:"attachExecutionTrackerToWorkflow",value:function(t,a,s,u){if(this.workflowExecutionTrackersByName.has(t.workflow.id))throw new Error(`Duplicate workflow ${t.workflow.id}`);for(var l of this.workflowExecutionTrackersByName.values())l.allDownstreamWorkflowExecutionTrackers=void 0,l.allUpstreamWorkflowExecutionTrackers=void 0;this.attachExecutionTrackerToEachWorkflow(new Map([[t.workflow.id,t]]),a,s,u)}},{key:"increasePendingUpstreamWorkflowsCount",value:function(t,a,s){this.workflowExecutionTrackersByName.get(t).increasePendingUpstreamWorkflowsCount(a,this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache),s)}},{key:"preProcessItemToWorkflow",value:function(t,a){var s=this.workflowExecutionTrackersByName.get(t.id);t.kind===U.Join&&y.matchesTypesFor(a.body,t.inputTypes)&&s.addInputItemToProcess(a.contextId),(t.kind===U.SingleItem&&y.matchesTypesFor(a.body,t.inputTypes)||t.kind===U.Join&&y.matchesTypesFor(a.body,[t.collectionScopeType]))&&s.beforeWorkflowExecution(a.contextId)}},{key:"getScopeExecutionTracker",value:function(t){return this.workflowExecutionTrackersByName.get(t)}},{key:"evaluateSingleItemPrefiltersWithoutAction",value:function(t,a){var s={scopeItem:a,inputItems:[a],clientMetadata:this.clientMetadata},u=this.workflowPrefilterManager.evaluateWorkflowPrefilters(t,s,Ft.WithoutActionDefinition);return u.shouldExecuteWorkflow}},{key:"prefilterAndSplitTasksBeforeQueing",value:function(t,a){var s=[],u=[];for(var l of a){var f=this.evaluatePrefilters(t.workflow,l,Ft.WithActionDefinition);f.shouldExecuteWorkflow?s.push(l):(l.prefilterActionResults=f.prefilterActionResults,u.push(l))}return{workflowTasks:s,prefilteredTasks:u}}},{key:"attachExecutionTrackerToEachWorkflow",value:function(t,a,s,u){for(var l of t){var f=(0,Vt.default)(l,2),c=f[0],d=f[1],p=new YA(d,this.onExecutionStateChange.bind(this),this.onContextIdWorkflowExecutionComplete.bind(this));this.workflowExecutionTrackersByName.set(c,p)}for(var g of this.workflowExecutionTrackersByName.values())this.setDownstreamWorkflowExecutionTrackers(g,a,u),this.setUpstreamWorkflowExecutionTrackers(g,s)}},{key:"setDownstreamWorkflowExecutionTrackers",value:function(t,a,s){var u,l,f;if(t.allDownstreamWorkflowExecutionTrackers===void 0){t.allDownstreamWorkflowExecutionTrackers=new Set;for(var c of(u=t.workflow.outputTypes)!==null&&u!==void 0?u:[]){var d=(l=a.get(c))!==null&&l!==void 0?l:new Set;if(this.setDownstreamWorkflowExecutionTrackersForDependentWorkflows(d,a,s,t,Fn.Input),Q("WaitContextProducerToComplete")){var p=(f=s.get(c))!==null&&f!==void 0?f:new Set;this.setDownstreamWorkflowExecutionTrackersForDependentWorkflows(p,a,s,t,Fn.Context)}}}}},{key:"setDownstreamWorkflowExecutionTrackersForDependentWorkflows",value:function(t,a,s,u,l){var f;for(var c of t){this.setDownstreamWorkflowExecutionTrackers(this.workflowExecutionTrackersByName.get(c.id),a,s),u.allDownstreamWorkflowExecutionTrackers.add({workflowExecutionTracker:this.workflowExecutionTrackersByName.get(c.id),workflowResultType:l});var d=function(k){u.allDownstreamWorkflowExecutionTrackers.forEach(function(S){S.workflowExecutionTracker===k.workflowExecutionTracker&&S.workflowResultType===k.workflowResultType&&u.allDownstreamWorkflowExecutionTrackers.delete(S)}),u.allDownstreamWorkflowExecutionTrackers.add(k)};for(var p of(f=this.workflowExecutionTrackersByName.get(c.id).allDownstreamWorkflowExecutionTrackers)!==null&&f!==void 0?f:[])d(p)}}},{key:"setUpstreamWorkflowExecutionTrackers",value:function(t,a){var s;if(t.allUpstreamWorkflowExecutionTrackers===void 0){t.allUpstreamWorkflowExecutionTrackers=new Set;var u=(s=t.workflow.inputTypes)!==null&&s!==void 0?s:[];this.setUpstreamWorkflowExecutionTrackersForTypes(u,t,a,Fn.Input),Q("WaitContextProducerToComplete")&&(u=Fh(this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).requestedContextTypesRules),this.setUpstreamWorkflowExecutionTrackersForTypes(u,t,a,Fn.Context))}}},{key:"setUpstreamWorkflowExecutionTrackersForTypes",value:function(t,a,s,u){var l,f;for(var c of t)for(var d of(l=s.get(c))!==null&&l!==void 0?l:[]){this.setUpstreamWorkflowExecutionTrackers(this.workflowExecutionTrackersByName.get(d.id),s),a.allUpstreamWorkflowExecutionTrackers.add({workflowExecutionTracker:this.workflowExecutionTrackersByName.get(d.id),workflowResultType:u});var p=function(S){a.allUpstreamWorkflowExecutionTrackers.forEach(function(x){x.workflowExecutionTracker===S.workflowExecutionTracker&&x.workflowResultType===S.workflowResultType&&a.allUpstreamWorkflowExecutionTrackers.delete(x)}),a.allUpstreamWorkflowExecutionTrackers.add(S)};for(var g of(f=this.workflowExecutionTrackersByName.get(d.id).allUpstreamWorkflowExecutionTrackers)!==null&&f!==void 0?f:[])p(g)}}},{key:"invalidateSingleItemWorkflow",value:function(t,a,s){var u=this,l,f,c,d,p,g,k,S=new Map,x=this.isWorkflowRequestingContexts(a.workflow),C=void 0,T=this.isWorkflowWithDelay(a.workflow),I=V(),_=function(W){var K,X,re,se=I.startSync(Z.AddScopeGroupedParameters),de="";if(x){C||(C=u.getAllDocumentContextHolderPaths((re=(X=(K=s==null?void 0:s[0])===null||K===void 0?void 0:K.updatedContextScope)===null||X===void 0?void 0:X[0])!==null&&re!==void 0?re:"session"));var ye=u.getDeepestDocumentContextHolderPath(C,W.item);ye&&(de=H(ye))}S.has(de)||S.set(de,[]),S.get(de).push(W),I.stop(se)},M=function(W){return(!a.invalidationFilter||a.invalidationFilter(W)!==!1)&&u.evaluateSingleItemPrefiltersWithoutAction(a.workflow,W)},A=function(W){M(W.item)?_(W):m.verbose(508411922,v.CoreDefault,function(){return`Filtered out single-item invalidation for item with path [${[].concat((0,ie.default)(W.item.parentPath),[W.item.id])}]`})},b=!1;if(!s||s.length==1&&(!s[0].item||s[0].updatedContextScope)){b=!(!((l=s==null?void 0:s[0])===null||l===void 0)&&l.updatedContextScope);var N=function(W){if(Q("OfficeVSO:8048430_ImplementIntersectionInExecutionManager_2"))A({item:W,opType:(d=s==null?void 0:s[0])===null||d===void 0?void 0:d.opType});else{if(!M(W))return m.verbose(537678242,v.CoreDefault,function(){return`Filtered out single-item invalidation for item with path [${[].concat((0,ie.default)(W.parentPath),[W.id])}]`}),1;_({item:W,opType:(p=s==null?void 0:s[0])===null||p===void 0?void 0:p.opType})}};for(var z of this.sessionCache.getSubtreeItems((c=(f=s==null?void 0:s[0])===null||f===void 0?void 0:f.updatedContextScope)!==null&&c!==void 0?c:[],a.workflow.inputTypes))N(z)}else{var L=function(W){if(W.item)if(Q("OfficeVSO:8048430_ImplementIntersectionInExecutionManager_2")&&y.matchesTypesFor(W.item.body,[En.getTypeName()])){var K=u.getAreaIntersectionFilter(W.item.body),X=u.sessionCache.getSubtreeItems([],a.workflow.inputTypes,K);m.info(508411921,v.CoreDefault,`invalidateSingleItemWorkflow: Using intersection for workflow '${a.workflow.id}' , found '${X==null?void 0:X.length}' items.`);for(var re of X)y.matchesTypesFor(re.body,[En.getTypeName()])?m.warn(508411920,v.CoreDefault,function(){return`Skipping a DirtyAreaSignal received from the model for ${a.workflow.id}`}):A({item:re,opType:W.opType})}else if(Q("OfficeVSO:8048430_ImplementIntersectionInExecutionManager_2"))A(W);else{if(!M(W.item))return m.verbose(537678243,v.CoreDefault,function(){return`Filtered out single-item invalidation for item with path [${[].concat((0,ie.default)(W.item.parentPath),[W.item.id])}]`}),1;_(W)}};for(var J of s)L(J)}if(V().stop(Z.InvalidateWorkflow),S.size>0){var P=(k=(g=s==null?void 0:s[0])===null||g===void 0?void 0:g.reInvalidateAfterDebounce)!==null&&k!==void 0?k:!1;for(var D of S.entries()){var O=(0,Vt.default)(D,2),$=O[0],F=O[1];if(Ir(a.workflow)){this.invalidateHybridSingleItemWorkflow(t,a,F);continue}this.queueOrSetScopeExecutionNotification(!T,Wn($),a,t,b,P,F)}}}},{key:"invalidateHybridSingleItemWorkflow",value:function(t,a,s){var u,l=V(),f=l.startSync(Z.InvalidateHybridSingleItemWorkflow),c=a.workflow;for(var d of s)if(d!=null&&d.item){var p=d.item.contextId;if(y.matchesTypesFor(d.item.body,(0,ie.default)(c.inputTypes))){var g=d.item;this.workflowItemStorage.setScopeItem(g,c),l.stop(f),this.queueOrSetScopeExecutionNotification(!1,[].concat((0,ie.default)(g.parentPath),[g.id]),a,t,!0,(u=d.reInvalidateAfterDebounce)!==null&&u!==void 0?u:!1,[{item:g}],d==null?void 0:d.triggerSignals);return}if(!xa.typeGuard(d.item.body))continue;var k=d.item.body;if(!c.correlatedSignals.includes(k.id))continue;var S=this.workflowItemStorage.getScopeItem(p,c);if(!S)continue;var x=this.notificationManager.get(c.id,S.contextId);if(!x){m.info(525218563,v.CoreDefault,`Workflow ${c.id}, contextId ${S.contextId}, already executed, skipping new scope execution`);continue}this.workflowItemStorage.addItemToWorkflowList(d.item,c),l.stop(f),this.tryToQueueExecutionNotification(x,function(){},Q("EnableRequestedContextForJoinWorkflows")?this.resolveAndValidateContextsAndEvents.bind(this):function(C,T){return[!0,!0,[]]},!0)&&this.notificationManager.delete(c.id,S.contextId),l.resume(f)}l.stop(f)}},{key:"invalidateDynamicWorkflow",value:function(t,a,s){var u,l,f,c,d,p=new Map,g=!1,k=function(N,z){var L;if(!p.has(N))p.set(N,[]);else if(((L=p.get(N))===null||L===void 0?void 0:L.length)===0)return;z!==void 0&&p.get(N).push(z.id)};for(var S of s)if(S.item)k(H(S.item.parentPath),S.item);else if(g=!(!((u=s==null?void 0:s[0])===null||u===void 0)&&u.updatedContextScope),a.workflow.inputTypes){var x=this.sessionCache.getSubtreeItems((f=(l=s==null?void 0:s[0])===null||l===void 0?void 0:l.updatedContextScope)!==null&&f!==void 0?f:[],a.workflow.inputTypes);for(var C of x)k(H(C.parentPath))}V().stop(Z.InvalidateWorkflow);var T=(d=(c=s==null?void 0:s[0])===null||c===void 0?void 0:c.reInvalidateAfterDebounce)!==null&&d!==void 0?d:!1;for(var I of p.entries()){var _=(0,Vt.default)(I,2),M=_[0],A=_[1];this.queueOrSetScopeExecutionNotification(!1,Wn(M),a,t,g,T,void 0,void 0,A)}}},{key:"invalidateReduceWorkflow",value:function(t,a,s){var u,l,f=this.isWorkflowWithDelay(a.workflow);if(!this.tryInvalidateReduceWorkflowUsingIntersection(t,a,f,s))if(s!=null&&s.item){if(a.invalidationFilter&&a.invalidationFilter(s.item)===!1){m.verbose(537678272,v.CoreDefault,function(){return`Filtered out reduce invalidation for item with parent path [${[].concat((0,ie.default)(s.item.parentPath),[s.item.id])}]`});return}var c=this.sessionCache.getFirstAncestorOfType([].concat((0,ie.default)(s.item.parentPath),[s.item.id]),[a.workflow.collectionScopeType]);if(c){s.item=c;var d=[].concat((0,ie.default)(c.parentPath),[c.id]);V().stop(Z.InvalidateWorkflow),this.queueOrSetScopeExecutionNotification(!1,d,a,t,!1,(u=s.reInvalidateAfterDebounce)!==null&&u!==void 0?u:!1,void 0,s.triggerSignals)}else return}else{var p=void 0;Q("AllowUndefinedcollectionScopeType")&&s.triggerSignals&&!a.workflow.collectionScopeType?p=[this.sessionCache.getItem([s.triggerSignals[0].signalPath[0]])]:p=this.sessionCache.getSubtreeItems((l=s==null?void 0:s.updatedContextScope)!==null&&l!==void 0?l:[],[a.workflow.collectionScopeType]),this.invalidateReduceWorkflowForMultipleRootItems(p,t,a,f,s)}}},{key:"tryInvalidateReduceWorkflowUsingIntersection",value:function(t,a,s,u){var l,f,c=void 0,d=!1;if(!u||y.getTypeNameFor((l=u.item)===null||l===void 0?void 0:l.body)==a.workflow.collectionScopeType||(this.supportsAreaIntersection((f=u.item)===null||f===void 0?void 0:f.body)?c=u.item.body:(c=e.getDirtyAreaSingleSignalTrigger(u.triggerSignals),d=!!c),!c))return!1;var p=this.getAreaIntersectionFilter(c),g=this.sessionCache.getSubtreeItems([],[a.workflow.collectionScopeType],p);return m.info(508560338,v.CoreDefault,`tryInvalidateReduceWorkflowUsingIntersection: Using intersection for workflow '${a.workflow.id}' , dirty area type: '${y.getTypeNameFor(c)}', found '${g==null?void 0:g.length}' items.`),(g==null?void 0:g.length)>0?(this.invalidateReduceWorkflowForMultipleRootItems(g,t,a,s,u),!0):d}},{key:"invalidateReduceWorkflowForMultipleRootItems",value:function(t,a,s,u,l){var f=this,c,d=!(!((c=l==null?void 0:l[0])===null||c===void 0)&&c.updatedContextScope),p=function(x){if(s.invalidationFilter&&s.invalidationFilter(x)===!1)return m.info(508560337,v.CoreDefault,function(){return`Filtered out reduce invalidation for item with parent path [${[].concat((0,ie.default)(x.parentPath),[x.id])}]`}),{v:void 0};V().stop(Z.InvalidateWorkflow),f.queueOrSetScopeExecutionNotification(!u&&!f.isWaitingForUpstreamWorkflows(s),[].concat((0,ie.default)(x.parentPath),[x.id]),s,a,d,!1,void 0,l==null?void 0:l.triggerSignals)},g;for(var k of t)if(g=p(k),g)return g.v}},{key:"getAreaIntersectionFilter",value:function(t){var a=this;return function(s){return a.supportsAreaIntersection(s.body)&&a.areasIntersect(s.body,t)}}},{key:"isWaitingForUpstreamWorkflows",value:function(t){var a;return(a=t.workflow.triggerConditions)===null||a===void 0?void 0:a.includes(Ht.UpstreamWorkflowsReady)}},{key:"isReadyToEarlyJoin",value:function(t,a){var s=Rk.getValue(),u=function(g){var k,S=Array.from((k=g.states)!==null&&k!==void 0?k:[]).map(function(C){return`${C[0]}: ${C[1].map(function(T){return T.join()})}`}).join(";"),x=new E({operationName:"EarlyJoinCompletion",resourceId:t.workflow.id,joinContextId:a,success:!0}).start();x.resultDescription=`isReadyToEarlyJoin (${s}) -> hasProcessedAllInputItems: ${g.hasProcessedAllInputItems}, allUpstreamComplete: ${g.allUpstreamComplete}, states: ${S}`,m.info(512550801,v.CoreDefault,x.stop())},l=t.countItemsToProcess(a)===0;if(!l)return u({hasProcessedAllInputItems:l}),!1;var f=this.areAllUpstreamWorkflowComplete(t,a),c=f.allUpstreamComplete,d=f.states;return u({hasProcessedAllInputItems:l,allUpstreamComplete:c,states:d}),s?c:!1}},{key:"areAllUpstreamWorkflowComplete",value:function(t,a){var s=new Map;for(var u of t.allUpstreamWorkflowExecutionTrackers){var l=u.workflowExecutionTracker,f=[];for(var c of l.getExecutionState()){var d=(0,Vt.default)(c,2),p=d[0],g=d[1];if(f.push([p,g]),Lt.isParentContextId(a,p))return s.set(l.workflow.id,f),{allUpstreamComplete:!1,states:s}}f.length>0&&s.set(l.workflow.id,f)}return{allUpstreamComplete:!0,states:s}}},{key:"isAnyContextProducerRunning",value:function(t,a){for(var s of a)if(t.contextProducerPendingExecCountByScope.get(H(s))>0)return!0;return!1}},{key:"invalidateJoinWorkflow",value:function(t,a,s){var u=this,l=function(d){var p,g=[].concat((0,ie.default)(d.parentPath),[d.id]),k=a.workflow;if(a.invalidationFilter&&a.invalidationFilter(d)===!1){m.info(537678274,v.CoreDefault,function(){return`Filtered out join invalidation for item with parent path [${g}]`});return}var S=d.contextId;if(y.matchesTypesFor(d.body,[k.collectionScopeType])){var x=d;u.workflowItemStorage.setScopeItem(x,k),m.info(537678275,v.CoreDefault,function(){return`WEM.invalidateJoinWorkflow :: Scope item: ${d.id} (${y.getTypeNameFor(d.body)}), workflow: ${k.id}, contextId: ${S}`}),V().stop(Z.InvalidateWorkflow),u.queueOrSetScopeExecutionNotification(!1,[].concat((0,ie.default)(x.parentPath),[x.id]),a,t,!0,(p=s.reInvalidateAfterDebounce)!==null&&p!==void 0?p:!1,[{item:x,isDeltaUpdate:s.isDeltaUpdate,opType:s.opType}],s==null?void 0:s.triggerSignals)}else{t.removeProcessedInputItem(S);var C=u.workflowItemStorage.getScopeItem(S,k);if(!C){m.info(537678276,v.CoreDefault,function(){return`There is no scope item stored for workflow: ${k.id}, contextId: ${S}`});return}m.info(537678277,v.CoreDefault,function(){return`WEM.invalidateJoinWorkflow :: Input item: ${d.id} (${y.getTypeNameFor(d.body)}), workflow: ${k.id}, contextId: ${S}`}),u.workflowItemStorage.addItemToWorkflowList(d,k);var T=u.isReadyToEarlyJoin(t,C.contextId);if(u.workflowItemStorage.isWorkflowReady(C.contextId,k)||T){var I=u.notificationManager.get(k.id,C.contextId);if(!I){m.info(537678278,v.CoreDefault,`Workflow ${k.id}, contextId ${C.contextId}, already queued, skipping new scope execution`);return}V().stop(Z.InvalidateWorkflow),u.tryToQueueExecutionNotification(I,function(){},Q("EnableRequestedContextForJoinWorkflows")?u.resolveAndValidateContextsAndEvents.bind(u):function(_,M){return[!0,!0,[]]},!1)&&u.notificationManager.delete(k.id,C.contextId)}}};if(s!=null&&s.item)l(s.item);else if(a.workflow.inputStage===Ut.OnSeed&&s.triggerSignals===void 0)for(var f of this.sessionCache.getSubtreeItems([],[a.workflow.collectionScopeType]))l(f)}},{key:"invalidateGenericWorkflow",value:function(t,a,s){var u,l,f,c=this.isWorkflowWithDelay(a.workflow),d=void 0;if(s!=null&&s.item){var p=void 0;if(a.workflow.dynamicExecutionPreferences)p=s.item.parentPath,d=[s.item.id];else{var g=this.sessionCache.getFirstAncestorOfType([].concat((0,ie.default)(s.item.parentPath),[s.item.id]),[a.workflow.collectionScopeType]);if(g)p=[].concat((0,ie.default)(g.parentPath),[g.id]);else return}V().stop(Z.InvalidateWorkflow),this.queueOrSetScopeExecutionNotification(!1,p,a,t,!1,(u=s.reInvalidateAfterDebounce)!==null&&u!==void 0?u:!1,void 0,s==null?void 0:s.triggerSignals,d)}else{var k=!(!((l=s==null?void 0:s[0])===null||l===void 0)&&l.updatedContextScope),S=new Set;if(a.workflow.dynamicExecutionPreferences){var x=this.sessionCache.getSubtreeItems([],a.workflow.inputTypes);for(var C of x)S.add(C.parentPath)}else{var T=this.sessionCache.getSubtreeItems((f=s==null?void 0:s.updatedContextScope)!==null&&f!==void 0?f:[],[a.workflow.collectionScopeType]);for(var I of T||[])S.add([].concat((0,ie.default)(I.parentPath),[I.id]))}V().stop(Z.InvalidateWorkflow);for(var _ of S||[])this.queueOrSetScopeExecutionNotification(!c&&!this.isWaitingForUpstreamWorkflows(a),_,a,t,k,!1,void 0,s==null?void 0:s.triggerSignals,d)}}},{key:"validateExecution",value:function(t,a){var s,u=V().startSync(Z.ValidateWorkflowExecution);try{var l=t.registration.workflow.triggerConditions;if(((s=t.triggerSignals)===null||s===void 0?void 0:s.length)>0&&!(l!=null&&l.includes(Ht.UpstreamWorkflowsReady)))return!0;if(Q("EnableTriggerConditionDeltaUpdate")&&t.minTime&&!t.reInvalidateAfterDebounce&&!this.meetsDelayCondition(t)||!Q("EnableTriggerConditionDeltaUpdate")&&t.registration.workflow.minDelayMs!==void 0&&t.registration.workflow.maxDelayMs!==void 0&&!t.reInvalidateAfterDebounce&&!this.meetsDelayCondition(t)||l!=null&&l.includes(Ht.UpstreamWorkflowsReady)&&t.registration.workflow.kind!=U.SingleItem&&!this.meetsUpstreamWorkflowsReadyCondition(t.registration.workflow.id,t.scopePath))return!1;if(t.registration.workflow.kind===U.Join||Ir(t.registration.workflow)){var f=Date.now(),c=t.registration.workflow,d=t.params[0].item.contextId,p=this.workflowDefinitionManager.getWorkflowDefinition(c,d).maxDelayMs;return this.workflowItemStorage.isWorkflowReady(d,c)?(m.info(537678279,v.CoreDefault,`Workflow: ${c.id} queuing by maxAnnotation, contextId: ${d}`),!0):t.startTime+p<f?(m.info(537678280,v.CoreDefault,`Workflow: ${c.id} queuing by maxTimeout, contextId: ${d}, timeout: ${p}`),!0):this.isReadyToEarlyJoin(this.workflowExecutionTrackersByName.get(c.id),d)?(m.info(512557890,v.CoreDefault,`Workflow: ${c.id} queuing by early completion, contextId: ${d}, timeout: ${p}`),!0):!1}return!(!a&&this.notificationManager.get(t.registration.workflow.id,H(t.scopePath)))}finally{V().stop(u)}}},{key:"meetsDelayCondition",value:function(t){var a=Date.now();return t.minTime===void 0||a>t.minTime}},{key:"meetsUpstreamWorkflowsReadyCondition",value:function(t,a){return this.workflowExecutionTrackersByName.get(t).areUpstreamWorkflowsReadyByScope(a)}},{key:"onExecutionStateChange",value:function(t,a,s){a!==s&&this.emit("executionStateChange",t,a)}},{key:"ensureSweepTimer",value:function(t){this.sweepTimer||(this.sweepTimer=setInterval(this.onSweep.bind(this),this.sweepIntervalMs),this.sweepTimer.unref&&this.sweepTimer.unref(),t&&this.emit("pendingNotificationsChange",!1))}},{key:"onSweep",value:function(){this.emit("sweep"),this.sweepScopeExecutionNotifications()}},{key:"cancelSweepTimer",value:function(){this.sweepTimer?(clearInterval(this.sweepTimer),this.sweepTimer=void 0,_r.getValue()&&m.info(507896610,v.CoreDefault,"WorkflowExecutionManager.cancelSweepTimer: Cancelling sweep timer")):_r.getValue()&&m.info(507856777,v.CoreDefault,"WorkflowExecutionManager.cancelSweepTimer: sweep timer is not set - nothing to cancel")}},{key:"shouldSkipExecutionOnDeletedItem",value:function(t){return t.opType!==Tn.getTypeName()&&t.opType!==ot.getTypeName()&&!this.sessionCache.hasItem([].concat((0,ie.default)(t.item.parentPath),[t.item.id]))}},{key:"removeParamsForExecutionOnDeletedItem",value:function(t,a){var s;if(Q("EnableSkippingWorkflowExecutionForMissingItem")&&(t.registration.workflow.kind===U.SingleItem||t.registration.workflow.kind===U.Join)&&!On(t.registration.workflow)){var u=(s=t.params)!==null&&s!==void 0?s:[],l=[];for(var f of u)this.shouldSkipExecutionOnDeletedItem(f)?(m.info(512296736,v.CoreDefault,`Invalidate Workflow Param for workflow ${t.registration.workflow.id} scopeItem is missing or deleted - skipping adding workflow param to execution.`),a&&this.workflowExecutionTrackersByName.get(t.registration.workflow.id).onExecutionTaskCompleted([].concat((0,ie.default)(f.item.parentPath),[f.item.id]),this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache))):l.push(f);return t.params=l,l.length===0}return!1}},{key:"sweepScopeExecutionNotifications",value:function(){var t=this,a=!0,s=void 0,u=function(k,S){return t.resolveAndValidateContextsAndEvents(k,S,s)},l=function(k){var S=function(M,A){var b=function(){var z=V(),L=z.find(Z.WaitingForPendingScopeExecution);z.stop(L),!s&&t.isWorkflowRequestingContexts(A.registration.workflow)&&(s=t.getAllDocumentContextHolderPaths());var J=t.removeParamsForExecutionOnDeletedItem(A,!0);J||t.tryToQueueExecutionNotification(A,function(){},u,!0)?t.notificationManager.delete(k,M):(z.resume(L),a=!1)};Q("ResumeCorrelationForSweepScopeExecutionNotifications")?Le(function(){b()},A.cc):b()};for(var x of p.entries()){var C=(0,Vt.default)(x,2),T=C[0],I=C[1];S(T,I)}};for(var f of this.notificationManager.entries()){var c=(0,Vt.default)(f,2),d=c[0],p=c[1];l(d)}a&&(m.debug(537678281,v.CoreDefault,"WorkflowExecutionManager.sweepScopeExecutionNotifications: No pending scope notifications left, cancelling sweep timer"),this.emit("pendingNotificationsChange",!0),this.cancelSweepTimer())}},{key:"tryToQueueExecutionNotification",value:function(t,a,s,u){var l=this,f,c,d,p=V(),g=p.startSync(Z.QueueExecutionNotification);try{if(!this.validateExecution(t,u))return!1;var k=function(O){l.workflowExecutionTrackersByName.get(t.registration.workflow.id).onExecutionTaskCompleted(O,l.sessionCache.getFirstAncestorOfType.bind(l.sessionCache))},S=s(t.registration,t.scopePath),x=(0,Vt.default)(S,3),C=x[0],T=x[1],I=x[2];if(!T){if(_r.getValue()&&m.info(507896609,v.CoreDefault,"WorkflowExecutionManager.tryToQueueExecutionNotification: Required events are not ready"),u)if(t.registration.workflow.kind===U.SingleItem){var _=(f=t.params)!==null&&f!==void 0?f:[];for(var M of _)k([].concat((0,ie.default)(M.item.parentPath),[M.item.id]))}else k(t.scopePath);return!0}if(!C)return _r.getValue()&&m.info(507896608,v.CoreDefault,"WorkflowExecutionManager.tryToQueueExecutionNotification: Required contexts are not ready"),!1;try{if(t.registration.workflow.kind===U.SingleItem){var A=(c=t.params)!==null&&c!==void 0?c:[];for(var b of A)a([].concat((0,ie.default)(b.item.parentPath),[b.item.id]));this.queueSingleItemWorkflow(t.registration,A,I)}else if(t.registration.workflow.kind===U.Reduce||t.registration.workflow.kind===U.Grid)try{var N=this.sessionCache.getItem(t.scopePath);a(t.scopePath),this.queueReduceWorkflow(t.registration,it(t.scopePath.slice(0,-1),N),t.triggerSignals,I,t.isTriggeredByEvents,k,H(t.scopePath))}catch(D){m.debug(537678282,v.CoreDefault,"Subtree no longer exists, skipping queue workflow execution")}else if(t.registration.workflow.kind===U.DynamicText)a(t.scopePath),this.queueDynamicWorkflow(t.registration,t.scopePath,t.dynamicItemIds,I,t.isTriggeredByEvents,k);else if(t.registration.workflow.kind===U.Join){var z=t.params[0].item.contextId,L=this.workflowItemStorage.getScopeItem(z,t.registration.workflow);L?(a([].concat((0,ie.default)(L.parentPath),[L.id])),this.queueJoinWorkflow(t.registration,L,I,k,z)):m.debug(537678283,v.CoreDefault,"ContextId no longer exists, skipping queue workflow execution")}else t.registration.workflow.kind===U.Generic?this.queueGenericWorkflow(t,a,I,k):m.error(537678284,v.CoreDefault,`Workflow in type ${t.registration.workflow.kind} is not supported`)}catch(D){if(u)if(t.registration.workflow.kind===U.SingleItem){var J=(d=t.params)!==null&&d!==void 0?d:[];for(var P of J)k([].concat((0,ie.default)(P.item.parentPath),[P.item.id]))}else k(t.scopePath);m.warn(537678285,v.CoreDefault,`WorkflowExecutionManager.tryToQueueExecutionNotification: Trying to queue ${t.registration.workflow.id} caused an exception: ${D}`)}return _r.getValue()&&m.info(507896607,v.CoreDefault,`WorkflowExecutionManager.tryToQueueExecutionNotification: Queued workflow ${t.registration.workflow.id} due to ${t.triggerSignals.length} signals`),!0}finally{p.stop(g)}}},{key:"isDeltaTriggeredWorkflow",value:function(t){var a;return(a=this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).triggerConditions)===null||a===void 0?void 0:a.includes(Ht.DeltaUpdate)}},{key:"calculateWorkflowMinAndMaxStartTime",value:function(t,a){var s=void 0;this.isWorkflowWithDelay(t.workflow)?s={minDelayMs:t.workflow.minDelayMs,maxDelayMs:t.workflow.maxDelayMs}:this.enableDeltaUpdateDelay.getValue()&&!this.isDeltaTriggeredWorkflow(t)&&(a!=null&&a.every(function(c){return c.isDeltaUpdate}))&&(s=UA());var u=Date.now(),l=s!=null&&s.minDelayMs?u+s.minDelayMs:void 0,f=u+aa(s==null?void 0:s.maxDelayMs,5e3);return{notificationStartTime:u,minTime:l,maxTime:f}}},{key:"queueOrSetScopeExecutionNotification",value:function(t,a,s,u,l,f,c,d,p){var g=this,k,S=V().startSync(Z.QueueOrSetScopeExecutionNotification),x,C,T;if(Q("EnableTriggerConditionDeltaUpdate")){var I=this.calculateWorkflowMinAndMaxStartTime(s,c);T=I.notificationStartTime,x=I.minTime,C=I.maxTime}else T=Date.now(),x=T+aa(s.workflow.minDelayMs,1e3),C=T+aa(s.workflow.maxDelayMs,5e3);var _={registration:s,scopePath:a,params:c,triggerSignals:d!=null?d:[],startTime:T,minTime:Q("IgnoreMinTimeWorkflowExecution")&&l?void 0:x,maxTime:C,dynamicItemIds:p?new Set(p):void 0,reInvalidateAfterDebounce:f,isTriggeredByEvents:(k=c==null?void 0:c[0])===null||k===void 0?void 0:k.isInvalidatedByEvents,cc:st()},M=function(N){u.invalidateWorkflow(N,g.sessionCache.getFirstAncestorOfType.bind(g.sessionCache))};V().stop(S);var A=!1;(t||f)&&(A=this.tryToQueueExecutionNotification(_,M,this.resolveAndValidateContextsAndEvents.bind(this),!1)),A||this.setScopeExecutionNotification(a,s,M,_)}},{key:"setScopeExecutionNotification",value:function(t,a,s,u){var l=V().startSync(Z.SetScopeExecutionNotification),f=void 0;u.params&&u.params[0].item.contextId&&(f=u.params[0].item.contextId);var c=H(t);f&&(a.workflow.kind===U.Join||Ir(a.workflow))&&(c=f);var d=this.notificationManager.get(a.workflow.id,c);if(d)(!Q("IgnoreMinTimeWorkflowExecution")||d.minTime)&&(d.minTime=u.minTime?Math.min(u.minTime,aa(d.maxTime,u.maxTime)):void 0),u.reInvalidateAfterDebounce?(d.triggerSignals=u.triggerSignals.concat(d.triggerSignals),d.reInvalidateAfterDebounce=u.reInvalidateAfterDebounce):d.triggerSignals=d.triggerSignals.concat(u.triggerSignals),d.registration.workflow.dynamicExecutionPreferences&&u.dynamicItemIds!==void 0&&u.dynamicItemIds.forEach(function(g){return d.dynamicItemIds.add(g)}),Q("ScopeExecutionNotificationUpdateParams")&&d.registration.workflow.kind===U.SingleItem&&this.updateScopeNotificationParams(d,u),a.workflow.kind===U.Join&&m.info(537678288,v.CoreDefault,`Dropping new scope notification for ${a.workflow.id}: ${c}, contextId: ${f}`);else if(m.info(537678286,v.CoreDefault,function(){return`New pending scope execution for ${a.workflow.id} at ${c} ${a.workflow.kind===U.Join||Ir(a.workflow)?", ("+f+")":""}`}),this.notificationManager.set(a.workflow.id,c,u),a.workflow.kind==U.SingleItem)for(var p of u.params)s([].concat((0,ie.default)(p.item.parentPath),[p.item.id]));else s(t);V().stop(l),d||V().startAsync(Z.WaitingForPendingScopeExecution),this.ensureSweepTimer(!0)}},{key:"updateScopeNotificationParams",value:function(t,a){var s,u,l=new E({operationName:"setScopeExecutionNotification_updateParams",resourceId:t.registration.workflow.resourceId,success:!0}).start();try{if(Q("DoNotOrderParamsByRevId")){if(a.params)if(a.reInvalidateAfterDebounce)t.params=a.params.concat(t.params);else{var f;(f=t.params).push.apply(f,(0,ie.default)(a.params))}return}if(a.params)for(var c of a.params){var d=!1;if(!((s=c.item)===null||s===void 0)&&s.revId){for(var p of t.params)if(!((u=p.item)===null||u===void 0)&&u.revId&&c.item.id===p.item.id){d=!0,parseInt(c.item.revId,10)>parseInt(p.item.revId,10)&&(p.item=c.item);break}}d||t.params.push(c)}}finally{m.info(537678287,v.CoreDefault,l.stop())}}},{key:"fetchInputChanges",value:function(t,a,s){var u=this,l;if(!((l=t.modelOptions)===null||l===void 0)&&l.includeItemOperations){var f=new E({operationName:"FetchInputChanges",success:!0,resourceId:t.id}).start(),c=[].concat((0,ie.default)(s.parentPath),[s.id]);this.inputChangesManager.setWorkflowInputs(a.map(function(x){var C=y.getTypeNameFor(x.body);return{path:[].concat((0,ie.default)(x.parentPath),[x.id]),deltaType:u.getDeltaType(C,t)}}),t.id,c);for(var d=this.inputChangesManager.getChanges(t.id,c),p=0,g=0;p<a.length&&g<d.length;){var k=Object.assign({},a[p]),S=d[g];if(S.op!==xt.Deleted){if(H([].concat((0,ie.default)(k.parentPath),[k.id]))!==H([].concat((0,ie.default)(S.parentPath),[S.id])))throw new Error("Input changes are not in order with input items.");k.op=S.op,k.delta=S.delta,d[g]=k,p++}g++}return f.stop().durationMs>10&&m.info(537678289,v.CoreDefault,f),d}}},{key:"getDeltaType",value:function(t,a){var s,u,l=(s=a.deltaTypesByInputType)===null||s===void 0?void 0:s[t];return!l&&(!((u=a.modelOptions)===null||u===void 0)&&u.includeDefaultItemDeltas)&&(l=jA.get(t)),l}},{key:"fetchParentItem",value:function(t,a){var s,u;if(!(!(!((s=t.modelOptions)===null||s===void 0)&&s.includeScopeItemParent)&&!(!((u=t.modelOptions)===null||u===void 0)&&u.includeRootItemParent)))try{var l=this.sessionCache.getItem(a.parentPath);return it(a.parentPath.slice(0,-1),l)}catch(c){var f=`Fetching parent item with path: ${H(a.parentPath)}. Error: ${c}`;throw m.error(537678290,v.CoreDefault,f),new Error(f)}}},{key:"queueSingleItemWorkflowTask",value:function(t,a){var s=V(),u=s.find(Z.QueueExecutionNotification),l=this.workflowSynchronizationManager.notifyBeforeQueueing(a,t);if(l){this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(a.scopeItem.contextId,Ce.Running);var f=this.evaluatePrefilters(t.workflow,a,Ft.WithActionDefinition);a.prefilterActionResults=f.prefilterActionResults;var c=!f.shouldExecuteWorkflow;s.stop(u),this.queueWorkflow(t,[a],c),s.resume(u)}}},{key:"queueSingleItemWorkflowTasksWithBatching",value:function(t,a){var s=this,u=V(),l=u.find(Z.QueueExecutionNotification),f=this.workflowSynchronizationManager.notifyBeforeBatchedQueuing(a,t);if(f.length>0){f.forEach(function(S){return s.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(S.scopeItem.contextId,Ce.Running)});var c=this.prefilterAndSplitTasksBeforeQueing(t,f),d=c.workflowTasks,p=c.prefilteredTasks;for(var g of this.batchSplitter.getBatchesByItemPath(d,this.workflowBatchSizeMax,function(S){return S.scopeItem}))u.stop(l),this.queueWorkflow(t,g),u.resume(l);for(var k of this.batchSplitter.getBatches(p,this.workflowBatchSizeMax))u.stop(l),this.queueWorkflow(t,k,!0),u.resume(l)}}},{key:"queueSingleItemWorkflow",value:function(t,a,s){var u=this;if(Ir(t.workflow)){this.queueHybridSingleItemWorkflow(t,a,s);return}if(this.usesRefactoredDebouncing){var l=a.map(function(S){return u.createSingleItemWorkflowTask(S,t,s)});l.length===1?this.queueSingleItemWorkflowTask(t,l[0]):this.queueSingleItemWorkflowTasksWithBatching(t,l)}else{var f=V(),c=f.find(Z.QueueExecutionNotification),d=[];for(var p of this.batchSplitter.getBatchesByItemPath(a,this.workflowBatchSizeMax,function(S){return S.item})){var g=function(x){var C=[].concat((0,ie.default)(x.item.parentPath),[x.item.id]),T=u.fetchParentItem(t.workflow,x.item);u.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(x.item.contextId,Ce.Running);var I={scopeItem:x.item,inputItems:T?[x.item,T]:[x.item],requestedContextsAndEvents:s,executionScopeId:u.shouldSkipSynchronization(x)?void 0:H(C),previousAnnotations:e.fetchExistingAnnotations(t.workflow,C,u.sessionCache),onComplete:function(){return u.onExecutionTaskCompleted(t.workflow.id,x.item)},extensibleWorkflowContext:u.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Xe.Pending,opType:x.opType};d.push(I)};for(var k of p)g(k);f.stop(c),this.queueWorkflow(t,d),f.resume(c),d=[]}}}},{key:"createSingleItemWorkflowTask",value:function(t,a,s){var u=this,l=[].concat((0,ie.default)(t.item.parentPath),[t.item.id]),f=this.fetchParentItem(a.workflow,t.item),c={scopeItem:t.item,inputItems:f?[t.item,f]:[t.item],requestedContextsAndEvents:s,executionScopeId:this.shouldSkipSynchronization(t)?void 0:H(l),previousAnnotations:e.fetchExistingAnnotations(a.workflow,l,this.sessionCache),onComplete:function(){return u.onExecutionTaskCompleted(a.workflow.id,t.item)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Xe.Pending,opType:t.opType,maxSynchronizationEndTimeMs:t.maxSynchronizationEndTimeMs};return c}},{key:"getExtensibleWorkflowContext",value:function(){var t=["session",`ext-${Mh}`];return this.sessionCache.hasItem(t)?this.sessionCache.getItem(t).body:void 0}},{key:"queueHybridSingleItemWorkflow",value:function(t,a,s){var u=this,l=function(){var p=c.item,g=u.workflowItemStorage.getItemsToExecute(p.contextId,t.workflow);if(g.length===0)return u.workflowItemStorage.onWorkflowExecuted(p,t.workflow),m.info(525218564,v.CoreDefault,`Failed to retrieve items for workflow: ${t.workflow.id}, contextId: ${p.contextId}`),{v:void 0};if(u.usesRefactoredDebouncing){var k=[].concat((0,ie.default)(p.parentPath),[p.id]),S={scopeItem:p,inputItems:[p],requestedContextsAndEvents:s,executionScopeId:u.shouldSkipSynchronization(c)?void 0:H(k),previousAnnotations:e.fetchExistingAnnotations(t.workflow,k,u.sessionCache),onComplete:function(){return u.onExecutionHybridSingleItemTaskCompleted(t.workflow,p)},extensibleWorkflowContext:u.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Xe.Pending},x=u.workflowSynchronizationManager.notifyBeforeQueueing(S,t);if(x){m.info(525218565,v.CoreDefault,`WEM.queueHybridSingleItemWorkflow :: ${t.workflow.id} queued input: ${p.id}, contextId: ${p.contextId}, correlatedSignal: ${g[0].id}`),u.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(p.contextId,Ce.Running);var C=u.evaluatePrefilters(t.workflow,S,Ft.WithActionDefinition);S.prefilterActionResults=C.prefilterActionResults;var T=!C.shouldExecuteWorkflow;u.queueWorkflow(t,[S],T)}}else m.info(509747276,v.CoreDefault,`WEM.queueHybridSingleItemWorkflow :: ${t.workflow.id} queued input: ${p.id}, contextId: ${p.contextId}, correlatedSignal: ${g[0].id}`),u.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(p.contextId,Ce.Running),u.queueWorkflow(t,[{scopeItem:p,inputItems:[p],requestedContextsAndEvents:s,executionScopeId:u.shouldSkipSynchronization(c)?void 0:H([].concat((0,ie.default)(c.item.parentPath),[c.item.id])),previousAnnotations:e.fetchExistingAnnotations(t.workflow,[].concat((0,ie.default)(c.item.parentPath),[c.item.id]),u.sessionCache),onComplete:function(){return u.onExecutionHybridSingleItemTaskCompleted(t.workflow,p)},extensibleWorkflowContext:u.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Xe.Pending}])},f;for(var c of a)if(f=l(),f)return f.v}},{key:"getContextHolderPaths",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:void 0,s=Q("AddSessionAsContextHolder")?[this.getUserNodePath(),this.getTenantNodePath(),["session"]]:[this.getUserNodePath(),this.getTenantNodePath()],u=[].concat(s),l=[],f=a!=null?a:this.getAllDocumentContextHolderPaths();if(t)for(var c of f)ar(c,t)?u.push(c):ar(t,c)&&l.push(c);else u=u.concat(f);return[u,l]}},{key:"getAllDocumentContextHolderPaths",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"session",a;return((a=this.sessionCache.getSubtreeItems([t],[Mt.getTypeName(),zn.getTypeName(),fo.getTypeName()]))!==null&&a!==void 0?a:[]).map(function(s){return[].concat((0,ie.default)(s.parentPath),[s.id])})}},{key:"getAllContexts",value:function(t){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],s,u=[];for(var l of t){var f=(s=this.sessionCache.getItemChildren(l,a))!==null&&s!==void 0?s:[];if(u.push.apply(u,f),Q("ContextHolderAsSelfContext")){var c=this.sessionCache.getItem(l);c!=null&&c.body&&y.matchesTypesFor(c.body,a)&&u.push(it(l.slice(0,-1),c))}}return u}},{key:"resolveAndValidateAllRequestedContexts",value:function(t,a){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,u=V().startSync(Z.ResolveAndValidateAllRequestedContexts);try{var l=[];if(this.isWorkflowRequestingContexts(t.workflow)){var f=this.getContextHolderPaths(a,s),c=(0,Vt.default)(f,2),d=c[0],p=c[1],g=ir(this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).requestedContextTypesRules),k=g.map(function(M){var A=(0,Vt.default)(M,2),b=A[0],N=A[1];return b});l=this.getAllContexts(d,k);var S=Q("FixRequiredContextBaseTypes")?new Set(l.flatMap(function(M){return y.getAllTypesFor(M.body)})):new Set(l.map(function(M){return y.getTypeNameFor(M.body)}));for(var x of g){var C=(0,Vt.default)(x,3),T=C[0],I=C[1],_=C[2];if(I==Sr.Required&&!S.has(T))return _r.getValue()&&m.info(507896606,v.CoreDefault,`WorkflowExecutionManager.resolveAndValidateAllRequestedContexts: Required context type ${T} not available for workflow ${t.workflow.id}`),[!1,[]];if(_===bo.Always&&this.isAnyContextProducerRunning(this.workflowExecutionTrackersByName.get(t.workflow.id),d))return _r.getValue()&&m.info(507896605,v.CoreDefault,`WorkflowExecutionManager.resolveAndValidateAllRequestedContexts: Required context type ${T} not available for workflow ${t.workflow.id} - producer is running`),[!1,[]]}l=l.concat(this.getAllContexts(p,k))}return[!0,l]}finally{V().stop(u)}}},{key:"getRequestedEvents",value:function(t){var a=this.sessionCache.getItemChildren(this.getUserCommandsNodePath(),[Lr.getTypeName()]);return a=a.filter(function(s){return qs(s.body,t)}),a.sort(function(s,u){return s.body.timestamp-u.body.timestamp}),t.maxWindowSize&&(a=a.slice(-t.maxWindowSize)),a}},{key:"resolveAndValidateEvents",value:function(t){var a,s;if(!Q("EnableUserCommands"))return[!0,[]];var u=[];if(t.workflow.eventSequenceOptions){var l=t.workflow.eventSequenceOptions;if(Date.now()-this.sessionCreationTime<((a=l.minTimeFrame)!==null&&a!==void 0?a:0))return[!l.required,[]];if(u=this.getRequestedEvents(l),u.length<((s=l.minWindowSize)!==null&&s!==void 0?s:1))return[!l.required,[]]}return[!0,u]}},{key:"resolveAndValidateContextsAndEvents",value:function(t,a){var s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,u=this.resolveAndValidateAllRequestedContexts(t,a,s),l=(0,Vt.default)(u,2),f=l[0],c=l[1],d=this.resolveAndValidateEvents(t),p=(0,Vt.default)(d,2),g=p[0],k=p[1],S=g&&f;return[f,g,S?c.concat(k):[]]}},{key:"isWorkflowRequestingContexts",value:function(t){var a;return((a=this.workflowDefinitionManager.getWorkflowDefinition(t).requestedContextTypesRules)!==null&&a!==void 0?a:[]).some(function(s){return s.contextTypes.length>0})}},{key:"getDeepestDocumentContextHolderPath",value:function(t,a){var s,u=void 0,l=[].concat((0,ie.default)(a.parentPath),[a.id]);for(var f of t)ar(f,l)&&f.length>((s=u==null?void 0:u.length)!==null&&s!==void 0?s:0)&&(u=f);return u}},{key:"isWorkflowWithDelay",value:function(t){return!(t.minDelayMs===void 0&&t.maxDelayMs===void 0)}},{key:"shouldSkipSynchronization",value:function(t){var a;return t.opType===Tn.getTypeName()||HA.getValue()&&((a=t.item)===null||a===void 0?void 0:a.delta)!==void 0}},{key:"fetchExistingAnnotationsForItems",value:function(t,a){var s=this,u;if(!(!t.fetchExistingAnnotations&&!(!((u=t.modelOptions)===null||u===void 0)&&u.includeExistingAnnotations))){var l=new E({operationName:"FetchExistingAnnotationsForItems",success:!0,resourceId:t.id}).start(),f=[];return a.forEach(function(c){var d=e.fetchExistingAnnotations(t,[].concat((0,ie.default)(c.parentPath),[c.id]),s.sessionCache);d==null||d.forEach(function(p){f.push(p)})}),l.stop().durationMs>10&&m.info(527524321,v.CoreDefault,l),f.length>0?f:void 0}}},{key:"queueReduceWorkflow",value:function(t,a,s,u,l,f,c){var d=this,p,g,k=[].concat((0,ie.default)(a.parentPath),[a.id]),S=[];if(!Q("FixReduceWorkflowWithoutInputs")||((p=t.workflow.inputTypes)===null||p===void 0?void 0:p.length)>0)try{if(this.supportsAreaIntersection(a.body)){var x=this.getAreaIntersectionFilter(a.body),C=this.sessionCache.getSubtreeItems([],t.workflow.inputTypes,x),T=this.sessionCache.getSubtreeItems(k,t.workflow.inputTypes);S=(0,ie.default)(new Set(C.concat(T)));var I=S.length-C.length;m.info(508597976,v.CoreDefault,`queueReduceWorkflow: Using intersection for workflow '${t.workflow.id}' , #itemsByRootPath: '${C.length}', #itemsByRootPath: '${I}'`)}else S=this.sessionCache.getSubtreeItems(k,t.workflow.inputTypes)}catch(L){m.error(537678291,v.CoreDefault,`Failed to retrieve subtree items for executing workflow ${t.workflow.id}: ${L.message}`),f(k);return}if(t.workflow.kind===U.Reduce||t.workflow.kind===U.Generic){var _={scopeItem:a,inputItems:(g=this.fetchInputChanges(t.workflow,S,a))!==null&&g!==void 0?g:S,requestedContextsAndEvents:u,executionScopeId:c,triggerSignals:s,previousAnnotations:this.fetchExistingAnnotationsForItems(t.workflow,[a].concat((0,ie.default)(S))),onComplete:function(){return d.onExecutionTaskCompleted(t.workflow.id,a)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:l,status:Xe.Pending};if(!this.evaluatePrefilters(t.workflow,_,Ft.WithoutActionDefinition).shouldExecuteWorkflow){m.verbose(523351809,v.CoreDefault,function(){return`Filtered out workflow ${t.workflow.id} invalidation based on prefilter.`}),f(k);return}if((!_.inputItems||_.inputItems.length===0)&&m.info(527237130,v.CoreDefault,`Workflow: '${t.workflow.id}' queued with no inputs.`),this.usesRefactoredDebouncing){var M=this.workflowSynchronizationManager.notifyBeforeQueueing(_,t);if(!M){V().stop(Z.QueueExecutionNotification);return}var A=this.evaluatePrefilters(t.workflow,_,Ft.WithActionDefinition);_.prefilterActionResults=A.prefilterActionResults;var b=!A.shouldExecuteWorkflow;this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(a.contextId,Ce.Running),V().stop(Z.QueueExecutionNotification),this.queueWorkflow(t,[_],b)}else this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(a.contextId,Ce.Running),V().stop(Z.QueueExecutionNotification),this.queueWorkflow(t,[_])}else{var N=S.filter(function(L){return y.matchesTypesFor(L.body,[Nn.getTypeName()])}),z=S.filter(function(L){return!y.matchesTypesFor(L.body,[Nn.getTypeName()])});V().stop(Z.QueueExecutionNotification),this.queueGridNeighborhoodWorkflow(t,k,a,N,z,u,l,function(){d.onExecutionTaskCompleted(t.workflow.id,a)})}}},{key:"queueDynamicWorkflow",value:function(t,a,s,u,l,f){var c=this,d,p;if(t.workflow.dynamicExecutionPreferences.inputSize<-1||t.workflow.dynamicExecutionPreferences.inputSize===0){m.error(537678292,v.CoreDefault,"Workflow inputSize must be positive integers or -1."),f(a);return}var g=void 0;try{g=this.sessionCache.getItemChildren(a,[et.getTypeName()])}catch(z){m.info(537678293,v.CoreDefault,`Failed to fetch children on parent item: ${H(a)}: ${z.message}`),f(a);return}if(!g||g.length===0){m.error(537678294,v.CoreDefault,`There are no children on parent item: ${H(a)}`),f(a);return}var k=bk(t,s,g);if(!k){f(a);return}if((t.workflow.dynamicExecutionPreferences.contextAbove!==void 0||t.workflow.dynamicExecutionPreferences.contextBelow!==void 0)&&((d=t.workflow.dynamicExecutionPreferences)===null||d===void 0?void 0:d.contextUnit)===void 0||t.workflow.dynamicExecutionPreferences.contextAbove===void 0&&t.workflow.dynamicExecutionPreferences.contextBelow===void 0&&((p=t.workflow.dynamicExecutionPreferences)===null||p===void 0?void 0:p.contextUnit)!==void 0){m.error(537678295,v.CoreDefault,"Workflow contextUnit and at least one of workflow [contextAbove, contextBelow] must also be specified."),f(a);return}if(t.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&t.workflow.dynamicExecutionPreferences.contextAbove<-1||t.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&t.workflow.dynamicExecutionPreferences.contextBelow<-1){m.error(537678296,v.CoreDefault,"Workflow contextAbove/contextBelow must be integers greater than or equal to -1."),f(a);return}var S=V(),x=S.find(Z.QueueExecutionNotification);if(this.usesRefactoredDebouncing){var C=[];for(var T of k){var I=this.createDynamicTextWorkflowTask(a,T,g,t,u,l);I&&C.push(I)}var _=this.workflowSynchronizationManager.notifyBeforeBatchedQueuing(C,t);for(var M of this.batchSplitter.getBatches(_,this.workflowBatchSizeMax))S.stop(x),this.queueWorkflow(t,M),S.resume(x);S.stop(x)}else{var A=[],b=function(){var L=(0,ie.default)(a);N.forEach(function(D){return L.push(D.id)});var J=void 0;if(t.workflow.dynamicExecutionPreferences.contextUnit!==void 0&&(J=c.calculateDynamicTextContent(N,g,t),!J))return 1;var P=it(a.slice(0,-1),c.sessionCache.getItem(a));c.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(P.contextId,Ce.Running),A.push({scopeItem:P,inputItems:N,executionScopeId:H(L),dynamicContextItems:J,requestedContextsAndEvents:u,onComplete:function(){return c.onExecutionTaskCompleted(t.workflow.id,P)},extensibleWorkflowContext:c.getExtensibleWorkflowContext(),isTriggeredByEvents:l,status:Xe.Pending}),S.stop(x),A.length>=c.workflowBatchSizeMax()&&(c.queueWorkflow(t,A),A=[]),S.resume(x)};for(var N of k)b();A.length>0&&this.queueWorkflow(t,A)}}},{key:"createDynamicTextWorkflowTask",value:function(t,a,s,u,l,f){var c=this,d=(0,ie.default)(t);a.forEach(function(k){return d.push(k.id)});var p=void 0;if(!(u.workflow.dynamicExecutionPreferences.contextUnit!==void 0&&(p=this.calculateDynamicTextContent(a,s,u),!p))){var g=it(t.slice(0,-1),this.sessionCache.getItem(t));return{scopeItem:g,inputItems:a,executionScopeId:H(d),dynamicContextItems:p,requestedContextsAndEvents:l,onComplete:function(){return c.onExecutionTaskCompleted(u.workflow.id,g)},isTriggeredByEvents:f,status:Xe.Pending}}}},{key:"calculateDynamicTextContent",value:function(t,a,s){var u;try{u=a.indexOf(t[0])}catch(T){m.error(537678297,v.CoreDefault,`Item ${t[0].id} not present within parent item's children.`);return}var l=s.workflow.dynamicExecutionPreferences.contextUnit,f=[],c=u-1;if(s.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&s.workflow.dynamicExecutionPreferences.contextAbove>0)for(var d=s.workflow.dynamicExecutionPreferences.contextAbove,p=0;c>=0&&p<d;){var g=a[c--];l===Pn.Character?(f.unshift(g),p+=g.body?g.body.content.length:0):l===Pn.Paragraph&&(f.unshift(g),p++)}else s.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&s.workflow.dynamicExecutionPreferences.contextAbove===-1&&(f=a.slice(0,u));try{u=a.indexOf(t[t.length-1])}catch(T){m.error(537678298,v.CoreDefault,`Item ${t[t.length-1].id} not present within parent item's children.`);return}c=u+1;var k=[];if(s.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&s.workflow.dynamicExecutionPreferences.contextBelow>0)for(var S=s.workflow.dynamicExecutionPreferences.contextBelow,x=0;c<a.length&&x<S;){var C=a[c++];l===Pn.Character?(k.push(C),x+=C.body?C.body.content.length:0):l===Pn.Paragraph&&(k.push(C),x++)}else s.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&s.workflow.dynamicExecutionPreferences.contextBelow===-1&&(k=a.slice(u+1));return{contextAbove:f,contextBelow:k}}},{key:"queueJoinWorkflow",value:function(t,a,s,u,l){var f=this,c=this.workflowItemStorage.getItemsToExecute(a.contextId,t.workflow);if(c.length===0){this.workflowItemStorage.onWorkflowExecuted(a,t.workflow),m.info(537678299,v.CoreDefault,`Failed to retrieve items for workflow: ${t.workflow.id}, contextId: ${a.contextId}`),u([].concat((0,ie.default)(a.parentPath),[a.id]));return}if(Q("EnableSkippingWorkflowExecutionForMissingItem")&&!On(t.workflow)&&!Jt.typeGuard(a.body)&&!this.sessionCache.hasItem([].concat((0,ie.default)(a.parentPath),[a.id]))){this.workflowItemStorage.onWorkflowExecuted(a,t.workflow),m.info(509748545,v.CoreDefault,`Invalidate Workflow Param for workflow ${t.workflow.id} scopeItem is missing or deleted from model cache - skipping adding workflow param to execution.`),u([].concat((0,ie.default)(a.parentPath),[a.id]));return}m.info(537678300,v.CoreDefault,`WEM.queueJoinWorkflow :: ${t.workflow.id} queued inputs [${c.map(function(p){return p.id}).join(",")}], contextId: ${a.contextId}`),this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(a.contextId,Ce.Running),V().stop(Z.QueueExecutionNotification);var d=this.usesRefactoredDebouncing?void 0:l;this.queueWorkflow(t,[{scopeItem:a,inputItems:c,requestedContextsAndEvents:s,executionScopeId:d,onComplete:function(){return f.onExecutionJoinTaskCompleted(t.workflow,a)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:Xe.Pending}])}},{key:"queueGenericWorkflow",value:function(t,a,s,u){if(t.registration.workflow.dynamicExecutionPreferences)a(t.scopePath),this.queueDynamicWorkflow(t.registration,t.scopePath,t.dynamicItemIds,void 0,t.isTriggeredByEvents,u);else try{var l=this.sessionCache.getItem(t.scopePath);a(t.scopePath),this.queueReduceWorkflow(t.registration,it(t.scopePath.slice(0,-1),l),t.triggerSignals,s,t.isTriggeredByEvents,u,H(t.scopePath))}catch(f){u(t.scopePath),m.debug(537678301,v.CoreDefault,"Subtree no longer exists, skipping queue workflow execution")}}},{key:"onExecutionJoinTaskCompleted",value:function(t,a){this.workflowItemStorage.onWorkflowExecuted(a,t),this.workflowDefinitionManager.deleteWorkflowDefinition(t,a.contextId),this.onExecutionTaskCompleted(t.id,a)}},{key:"onExecutionHybridSingleItemTaskCompleted",value:function(t,a){this.workflowItemStorage.onWorkflowExecuted(a,t),this.onExecutionTaskCompleted(t.id,a)}},{key:"onExecutionTaskCompleted",value:function(t,a){var s=this.workflowExecutionTrackersByName.get(t);a.contextId&&s.afterWorkflowExecution(a.contextId);var u=[].concat((0,ie.default)(a.parentPath),[a.id]),l=u;try{var f=this.itemScopeMovedTracker.getUpdatedScopePathIfExists(u,t);u=f!=null?f:u,s.onExecutionTaskCompleted(u,this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache))}catch(c){m.error(537678302,v.CoreDefault,`Failed to process workflow task completion ${t}: ${c.message}`)}finally{this.itemScopeMovedTracker.afterWorkflowExecution(l,t)}}},{key:"onContextIdWorkflowExecutionComplete",value:function(t,a){var s=this;if(this.executionCompleteCallback&&this.executionCompleteCallback(t,a),Rk.getValue()){var u=function(){for(var f of s.workflowExecutionTrackersByName.values())if(f.workflow.kind===U.Join){for(var c of f.getExecutionState().keys())if(Lt.isParentContextId(c,a))return!0}return!1};u()&&(this.cancelSweepTimer(),this.requestSweep(),this.sweepScopeExecutionNotifications())}}},{key:"updateExecutionTrackersOnPurge",value:function(t){for(var a of t){var s=this.workflowExecutionTrackersByName.get(a.workflowId);s?(s.onExecutionTaskCompleted(a.itemPath,this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache)),m.info(507856773,v.CoreDefault,`WorkflowExecutionManager.updateExecutionTrackersOnPurge: completed execution for workflow ${a.workflowId}, selfPendingExecCount: ${s.selfPendingExecCount}`)):m.info(507847636,v.CoreDefault,`WorkflowExecutionManager.updateExecutionTrackersOnPurge: skip for workflow ${a.workflowId}: no executionTracker found`)}}},{key:"onPurgeModel",value:function(t){if(_r.getValue()&&m.info(507856770,v.CoreDefault,`WorkflowExecutionManager.onPurgeModel ${t.length} item paths to purge`),this.cancelQueuedWorkflows(t),this.pendingNotifications){var a=this.notificationManager.cancelPendingNotifications(t,this.sessionCache,this);a.length>0&&(this.emit("pendingNotificationsChange",!0),this.updateExecutionTrackersOnPurge(a))}}},{key:"cancelQueuedWorkflows",value:function(t){var a=this,s=new E({operationName:"CancelQueuedWorkflowsOnPurge",success:!0}).start(),u=Q("NotifySynchronizationManagerOnPurge"),l=[],f=function(S){return(t==null?void 0:t.find(function(x){return ar(x,S)}))!==void 0},c=function(S){return(S==null?void 0:S.filter(function(x){return!y.matchesTypesFor(x,[En.getTypeName()])}).length)||0},d=function(S,x,C){var T,I=f([].concat((0,ie.default)(S.scopeItem.parentPath),[S.scopeItem.id])),_=((T=S.inputItems)===null||T===void 0?void 0:T.find(function(b){return f([].concat((0,ie.default)(b==null?void 0:b.parentPath),[b==null?void 0:b.id]))}))!==void 0;if(!I&&!_)return m.info(507834947,v.CoreDefault,`WorkflowExecutionManager.cancelQueuedWorkflows: not cancelling ${C} workflow ${x.id}: not affected by purge`),!0;var M=S.opType===ot.getTypeName(),A=c(S.triggerSignals);return M||A>0?(m.info(507856768,v.CoreDefault,`WorkflowExecutionManager.cancelQueuedWorkflows: not cancelling ${C} workflow ${x.id} triggered by ${S.opType} with ${A} signals`),!0):(m.info(507856739,v.CoreDefault,`WorkflowExecutionManager.cancelQueuedWorkflows: cancelling ${C} workflow ${x.id}: scopeIsPurged=${I}, hasPurgedInput=${_}, opTypeIsSignal=${M}, signalCount=${A}`),!1)};for(var p of this.workflowQueue.workersList())if(!On(p.data.registration.workflow))for(var g of p.data.tasks)d(g,p.data.registration.workflow,"running")||(g.status=Xe.ResultsCancelled,u&&this.workflowSynchronizationManager.notifyOnCancelled(g,p.data.registration.workflow.id),l.push({resourceId:p.data.registration.workflow.resourceId,contextId:g.scopeItem.contextId}));this.workflowQueue.remove(function(k){if(On(k.data.registration.workflow))return!1;var S=!0;for(var x of k.data.tasks){if(d(x,k.data.registration.workflow,"queued")){S=!1;continue}x.status=Xe.ResultsCancelled,u&&a.workflowSynchronizationManager.notifyOnCancelled(x,k.data.registration.workflow.id),l.push({resourceId:k.data.registration.workflow.resourceId,contextId:x.scopeItem.contextId})}return S}),s.count=l.length,s.resultJSON=JSON.stringify(l),m.info(512338136,v.CoreDefault,s.stop())}}],[{key:"fetchExistingAnnotations",value:function(t,a,s){var u;if(!(!t.fetchExistingAnnotations&&!(!((u=t.modelOptions)===null||u===void 0)&&u.includeExistingAnnotations))){var l;try{l=s.getItemChildren(a,t.outputTypes)}catch(p){m.info(537678239,v.CoreDefault,function(){return`Fetching existing annotations failed on parent item: ${H(a)}. Error: ${p}`});return}var f=new Array(l.length),c=0;for(var d of l)d.body&&d.source===t.id&&(f[c++]=Object.assign(Object.assign({},d),{parentPath:a}));return f.length=c,f}}},{key:"getDirtyAreaSingleSignalTrigger",value:function(t){return t&&t.length==1&&y.matchesTypesFor(t[0],[En.getTypeName()])?t[0]:void 0}}]),e}(Lk.EventEmitter),YA=function(){function n(o,e,r){(0,zs.default)(this,n),this.selfPendingExecCount=0,this.upstreamPendingExecCountByScope=new Map,this.upstreamToDownstreamExecCountByScope=new Map,this.contextProducerPendingExecCountByScope=new Map,this.selfPendingExecCountByScope=new Map,this.itemsContextId=new Set,this.executionState=new Map,this.workflow=o.workflow,this.registration=o,this.executionStateChangedCallback=e,this.onContextIdWorkflowExecutionComplete=r}return(0,Vs.default)(n,[{key:"invalidateWorkflow",value:function(e,r){var t=V().startSync(Z.ExecutionTrackerInvalidate),a=this.getWorkflowExecutionState();this.incrementSelfPendingExecutions(e,1),this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),a),this.updateAllDownstreamWorkflowExecutionTrackers(e,r,!1),V().stop(t)}},{key:"increasePendingUpstreamWorkflowsCount",value:function(e,r,t){var a=this.getWorkflowExecutionState();this.incrementSelfPendingExecutions(e,t),this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),a),this.updateAllDownstreamWorkflowExecutionTrackers(e,r,!1,t)}},{key:"onExecutionTaskCompleted",value:function(e,r){var t=this.getWorkflowExecutionState();this.decrementSelfPendingExecutions(e,1),this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),t),this.updateAllDownstreamWorkflowExecutionTrackers(e,r,!0,1)}},{key:"getWorkflowExecutionState",value:function(){return this.selfPendingExecCount>0?Ce.Running:this.upstreamPendingExecCountByScope.size>0?Ce.Pending:Ce.Idle}},{key:"areUpstreamWorkflowsReadyByScope",value:function(e){return this.upstreamPendingExecCountByScope.get(H(e))===void 0}},{key:"getPendingExecutionsCount",value:function(e){var r;return e?(r=this.selfPendingExecCountByScope.get(e))!==null&&r!==void 0?r:0:this.selfPendingExecCount}},{key:"moveScope",value:function(e,r,t){this.updatePendingExecutionsScopePaths(e,r),this.updateDownstreamWorkflowExecutionsScopePaths(e,r,t)}},{key:"updatePendingExecutionsScopePaths",value:function(e,r){var t,a=(t=this.selfPendingExecCountByScope.get(e))!==null&&t!==void 0?t:0;a&&(this.selfPendingExecCountByScope.delete(e),this.selfPendingExecCountByScope.set(r,a));var s=this.contextProducerPendingExecCountByScope.get(e);s&&(this.contextProducerPendingExecCountByScope.delete(e),this.contextProducerPendingExecCountByScope.set(r,s))}},{key:"updateDownstreamWorkflowExecutionsScopePaths",value:function(e,r,t){var a,s,u,l=(a=this.selfPendingExecCountByScope.get(e))!==null&&a!==void 0?a:0;for(var f of this.allDownstreamWorkflowExecutionTrackers){var c=f.workflowExecutionTracker.upstreamToDownstreamExecCountByScope,d=c.get(e);if(d){d.pendingCount-l<=0?c.delete(e):d.pendingCount-=l;var p=Wn(r),g=H(d.downstreamScopePath),k=(s=f.workflowExecutionTracker.upstreamPendingExecCountByScope.get(g))!==null&&s!==void 0?s:0;k-l<=0?f.workflowExecutionTracker.upstreamPendingExecCountByScope.delete(g):f.workflowExecutionTracker.upstreamPendingExecCountByScope.set(g,k-l);var S=t(p,[f.workflowExecutionTracker.workflow.collectionScopeType]);if(S){c.set(r,{pendingCount:d.pendingCount,downstreamScopePath:p});var x=H(p),C=((u=f.workflowExecutionTracker.upstreamPendingExecCountByScope.get(x))!==null&&u!==void 0?u:0)+k;f.workflowExecutionTracker.upstreamPendingExecCountByScope.set(x,C)}}}}},{key:"moveAwareGetScopeItem",value:function(e,r,t,a,s,u){if(!ca.getValue())return t(e,r);var l=H(e),f=a.upstreamToDownstreamExecCountByScope,c=f.get(l),d=s?-u:u;if(!c){var p=t(e,r);return d>0?p&&f.set(l,{pendingCount:d,downstreamScopePath:[].concat((0,ie.default)(p.parentPath),[p.id])}):p&&m.error(507605015,v.CoreDefault,`upstreamToDownstreamExecCountByScope an attempt to decrement non-existent upstream to downstream counter. Upstream: ${this.workflow.id}, downstream: ${a.workflow.id}`),p}var g=c.downstreamScopePath;return c.pendingCount+=d,c.pendingCount<=0&&(f.delete(l),c.pendingCount<0&&m.warn(507605014,v.CoreDefault,`downstreamExecCount.pendingCount went below zero. Upstream: ${this.workflow.id}, downstream: ${a.workflow.id}`)),t(g,r)}},{key:"incrementSelfPendingExecutions",value:function(e,r){var t;this.selfPendingExecCount+=r;var a=H(e);this.selfPendingExecCountByScope.set(a,((t=this.selfPendingExecCountByScope.get(a))!==null&&t!==void 0?t:0)+r)}},{key:"decrementSelfPendingExecutions",value:function(e,r){this.selfPendingExecCount-=r;var t=H(e),a=this.selfPendingExecCountByScope.get(t);if(a===void 0){m.error(507605013,v.CoreDefault,`No element in selfPendingExecCountByScope for the scope on attempt to decrement. WorkflowId: ${this.workflow.id}`);return}var s=a-r;s>0?this.selfPendingExecCountByScope.set(t,s):(this.selfPendingExecCountByScope.delete(t),s<0&&m.error(507605012,v.CoreDefault,`Decremented executions count in selfPendingExecCountByScope went below zero. WorkflowId: ${this.workflow.id}`))}},{key:"updateAllDownstreamWorkflowExecutionTrackers",value:function(e,r,t){var a=this,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1,u=r,l=function(p){if(p.workflowResultType===Fn.Input&&p.workflowExecutionTracker.workflow.kind!==U.SingleItem){r=function(x,C){return a.moveAwareGetScopeItem(x,C,u,p.workflowExecutionTracker,t,s)};var g=void 0;try{g=r(e,[p.workflowExecutionTracker.workflow.collectionScopeType])}catch(S){return n.shouldLogAncestorNotFoundError(p.workflowExecutionTracker.workflow.id)&&m.info(537678303,v.CoreDefault,`Failed to retrieve root item for updating workflow ${p.workflowExecutionTracker.workflow.id} execution tracker: ${S.message}`),{v:void 0}}if(g!==void 0){var k=H([].concat((0,ie.default)(g.parentPath),[g.id]));t?p.workflowExecutionTracker.decreasePendingExecutionCount(k,!1,s):p.workflowExecutionTracker.increasePendingExecutionCount(k,!1,s)}}else p.workflowResultType===Fn.Context&&Q("WaitContextProducerToComplete")&&(t?p.workflowExecutionTracker.decreasePendingExecutionCount(H(e),!0,s):p.workflowExecutionTracker.increasePendingExecutionCount(H(e),!0,s))},f;for(var c of this.allDownstreamWorkflowExecutionTrackers)if(f=l(c),f)return f.v}},{key:"increasePendingExecutionCount",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=r?this.contextProducerPendingExecCountByScope:this.upstreamPendingExecCountByScope,s=a.get(e);a.set(e,(s!=null?s:0)+t)}},{key:"decreasePendingExecutionCount",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=r?this.contextProducerPendingExecCountByScope:this.upstreamPendingExecCountByScope,s=a.get(e);zA.getValue()&&(!s||s<t)&&m.info(524153237,v.CoreDefault,`Irregular number of upstream pending executions: current ${s}, decrease value: ${t}`),a.set(e,(s!=null?s:0)-t),a.get(e)<=0&&a.delete(e)}},{key:"addInputItemToProcess",value:function(e){this.registration.suspendExecution||this.itemsContextId.add(e)}},{key:"removeProcessedInputItem",value:function(e){this.itemsContextId.delete(e)}},{key:"countItemsToProcess",value:function(e){var r=0;for(var t of this.itemsContextId)t.indexOf(e)===0&&(r+=1);return r}},{key:"getExecutionState",value:function(){return this.executionState}},{key:"setExecutionState",value:function(e,r){return e?n.isWorkflowReadyToExecute(this.registration)?(this.executionState.set(e,r),!0):(m.info(508883414,v.CoreDefault,new E({operationName:"WorkflowExecutionTracker",resourceId:this.registration.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${r} for not active workflow`})),!1):(m.info(520217549,v.CoreDefault,new E({operationName:"WorkflowExecutionTracker",resourceId:this.registration.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${r} for a undefined contextId (setExecutionState)`})),!1)}},{key:"beforeWorkflowExecution",value:function(e){this.setExecutionState(e,Ce.Idle)}},{key:"afterWorkflowExecution",value:function(e){this.setExecutionState(e,Ce.Executed)&&this.tryToCompleteWorkflowExecution(e)}},{key:"tryToCompleteWorkflowExecution",value:function(e){var r=this.executionState.get(e);if(r===Ce.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.workflow.id,e);for(var t of this.allDownstreamWorkflowExecutionTrackers)for(var a of t.workflowExecutionTracker.getExecutionState()){var s=(0,Vt.default)(a,2),u=s[0],l=s[1];l===Ce.Executed&&Lt.isParentContextId(e,u)&&t.workflowExecutionTracker.tryToCompleteWorkflowExecution(u)}}}},{key:"canCompleteExecution",value:function(e){for(var r of this.allUpstreamWorkflowExecutionTrackers)for(var t of r.workflowExecutionTracker.getExecutionState().keys())if(Lt.isParentContextId(t,e))return!1;return!0}}],[{key:"isWorkflowReadyToExecute",value:function(e){return e.isActivated&&!e.suspendExecution}},{key:"shouldLogAncestorNotFoundError",value:function(e){return!QA.getValue().includes(e)}}]),n}();h();var ZA=new G("wordFilteredOutSubDocs",["comments","endnotes","footnotes","headerfooters","shapes","textboxes"]),eM=new G("wordAllSubDocWorkflows",["AutoSecurityClassificationTextTileV2"]),$k=function(o,e){if((o==null?void 0:o.appName)==="Word"){var r=ZA.getValue(),t=eM.getValue();return function(a){if(a.parentPath.length>=2&&a.parentPath[1]==="doc"){if(a.parentPath.length>=3&&a.parentPath[2]==="main")return!0;var s=a.parentPath.length===2&&r.includes(a.id)||a.parentPath.length>=3&&r.includes(a.parentPath[2]);if(s)return t.includes(e)}return!0}}};h();var Gk=w(R()),Uk=w(B());var tM=new G("queueSaturationHandlingStrategyEnabled",!1),nM=new af("overrideWorkflowDefinition_"),rM=new G("overridableWorkflowDefinitionProperties",["activationConfigs","isStateful","stateExpiryMs","bypassModel","requiredTokenTypes","optionalTokenTypes","requestedContextTypesRules","activationFlightsConfigs","maxExecutionTimeInS","billingDomain","minDelayMs","maxDelayMs","isAppOnlyTokenAllowed"]),Hk=function(){function n(o,e){(0,Gk.default)(this,n),this.totalExecutionCount=0,this.suspendExecution=!1,this.isActivated=!1,this.pendingTokenExchangesCount=0,this.eventCountSinceLastTrigger=0,this.tasksInProgress=new Set,this.debounceQueue=new Map,this.appliedWorkflowOverrides=this.overrideWorkflowDefinition(o),this.workflow=o,this.workflowQueue=e,this.lastTriggerByEventsTime=Date.now()}return(0,Uk.default)(n,[{key:"queueTask",value:function(e){var r=this,t=V(),a=t.currentScope;t.startBranch(Z.WorkflowExecution,e.cc),On(this.workflow)||tM.getValue()?this.queueWorkflow(e):setTimeout(function(){return r.queueWorkflow(e)},0),t.switchToScope(a)}},{key:"queueTaskOld",value:function(e){var r=this,t,a=V(),s=a.currentScope,u=a.startBranch(Z.WorkflowExecution,e.cc),l=u.performanceEvent.startSync(Z.WorkflowRegistrationQueueTask),f=[],c=[],d=function(C,T){return{cc:e.cc,queueOp:e.queueOp,registration:e.registration,executionId:e.executionId,tasks:C,containsPrefilteredTasks:T}},p=function(C){var T={shouldExecuteWorkflow:!0};if(C.executionScopeId&&r.tasksInProgress.has(C.executionScopeId)){var I=r.debounceQueue.get(C.executionScopeId),_=[];I&&Le(function(){var M;V().remove(I.childPerformanceEvent),I.debounceOp.success=!1,m.info(537781722,v.CoreDefault,I.debounceOp.stop()),m.info(537781723,v.CoreDefault,`Removing Duplicate Workflow: ${r.workflow.id}, executionId: ${e.executionId}, debounceKey: ${C.executionScopeId}`);for(var A of I.taskCollection.tasks)_=_.concat(A.triggerSignals),(M=A.onComplete)===null||M===void 0||M.call(A,!0)},I.taskCollection.cc),_.length>0&&(C.triggerSignals=_.concat((t=C.triggerSignals)!==null&&t!==void 0?t:[])),r.debounceQueue.set(C.executionScopeId,{debounceOp:new E({operationName:"DebounceSessionWorkflow",resourceId:r.workflow.resourceId,success:!0,resultSignature:C.executionScopeId}).start(),taskCollection:d([C],!T.shouldExecuteWorkflow),childPerformanceEvent:u.performanceEvent.startAsync(Z.WaitingInDebounceQueue)})}else T=r.executionManager.evaluatePrefilters(r.workflow,C,Ft.WithActionDefinition),C.prefilterActionResults=T.prefilterActionResults,T.shouldExecuteWorkflow?f.push(C):c.push(C),C.executionScopeId&&r.tasksInProgress.add(C.executionScopeId)};for(var g of e.tasks)p(g);if(u.performanceEvent.stop(l),f.length>0){var k=d(f,!1);this.pushToWorkflowsQueue(k)}if(c.length>0){var S=d(c,!0);this.pushToWorkflowsQueue(S)}a.switchToScope(s)}},{key:"onTaskCompleted",value:function(e){var r=this,t,a;if((t=e.onComplete)===null||t===void 0||t.call(e,!1),e.executionScopeId){var s=this.debounceQueue.get(e.executionScopeId);s?Le(function(){var u,l=V();l.stop(s.childPerformanceEvent),r.debounceQueue.delete(e.executionScopeId),m.info(537781724,v.CoreDefault,s.debounceOp.stop()),r.tasksInProgress.delete(e.executionScopeId);for(var f of s.taskCollection.tasks)(u=f.onComplete)===null||u===void 0||u.call(f,!0);l.startSync(Z.InvalidateWorkflow),r.invalidate(s.taskCollection.tasks.map(function(c){return{item:c.scopeItem,triggerSignals:c.triggerSignals,reInvalidateAfterDebounce:!0}}))},(a=s.taskCollection)===null||a===void 0?void 0:a.cc):this.tasksInProgress.delete(e.executionScopeId)}}},{key:"setExecutionManager",value:function(e){this.executionManager=e}},{key:"invalidate",value:function(e){this.executionManager.invalidateWorkflow(this,e)}},{key:"queueWorkflow",value:function(e){var r=V(e.cc),t=r.startSync(Z.QueueWorkflow);this.workflowQueue.push(e,this.workflow.priority),r.stop(t),r.startAsync(Z.WaitingInWorkflowQueue)}},{key:"pushToWorkflowsQueue",value:function(e){var r=this,t=e.containsPrefilteredTasks?"prefiltered":"";m.debug(537781726,v.CoreDefault,function(){return`Queueing ${e.tasks.length} ${t} ${r.workflow.id} workflows`}),V(e.cc).startAsync(Z.WaitingInWorkflowQueue),On(this.workflow)?this.workflowQueue.push(e,this.workflow.priority):setTimeout(function(){return r.workflowQueue.push(e,r.workflow.priority)},0)}},{key:"overrideWorkflowDefinition",value:function(e){var r=new E({operationName:"OverrideWorkflowDefinition",resourceId:e.id,success:!0}).start(),t=this.applyWorkflowDefinitionOverrides(e);if(t)return r.resultJSON=JSON.stringify(t),m.info(507544067,v.CoreDefault,r.stop()),t}},{key:"applyWorkflowDefinitionOverrides",value:function(e){var r,t;for(var a of(r=rM.getValue())!==null&&r!==void 0?r:[]){var s=nM.getSettingInstance(`${e.id}_${a}`).getValue();s!==void 0&&(s=s!=null?s:void 0,e[a]=s,t=t!=null?t:{},t[a]=s)}return t}}]),n}();h();var zk=w(R()),Vk=w(B());var Qk=function(){function n(o,e,r){(0,zk.default)(this,n),this.upstreamMessageEndpoint=o,this.sessionKey=e,this.userId=r}return(0,Vk.default)(n,[{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"executeWorkflow",value:function(e,r,t){var a=new no({workflowId:e.id,batchExecutionInputs:r,clientMetadata:this.clientMetadata,executionContext:{sessionEndpoint:"",origin:"",sessionKey:this.sessionKey,userId:this.userId}});this.upstreamMessageEndpoint.sendMessage(a,function(s,u){if(s){t(new Error(s.error));return}var l=u;t(void 0,l.batchExecutionResults)})}}]),n}();h();var Jk=w(at()),nd=w(Se()),jk=w(R()),Kk=w(B());var Qs=function(){function n(o){(0,jk.default)(this,n),this.scopeItemsByContextId=new Map,this.itemsByWorkflowAndContextId=new Map,this.workflowDefinitionManager=o}return(0,Kk.default)(n,[{key:"setScopeItem",value:function(e,r){var t,a=e.contextId;if(a){if(this.itemsByWorkflowAndContextId.has(r.id)||this.itemsByWorkflowAndContextId.set(r.id,new Map),this.itemsByWorkflowAndContextId.get(r.id).set(a,[]),!this.scopeItemsByContextId.has(a))this.scopeItemsByContextId.set(a,e);else if(!((t=this.itemsByWorkflowAndContextId.get(r.id))===null||t===void 0)&&t.has(a)){var s=new E({resultDescription:`Trying to set new scope item: ${e.id} with already existing contextId ${a} for workflow ${r.id}`,operationName:"WIS.setScopeItem",resourceId:r.id,success:!0}).start();m.verbose(527291288,v.CoreDefault,s.stop())}}}},{key:"updateScopeItemPath",value:function(e,r,t){var a,s;if(e){var u=this.scopeItemsByContextId.get(e);if(u){var l=u.parentPath;this.scopeItemsByContextId.set(e,it(r,u));for(var f=(s=(a=this.itemsByWorkflowAndContextId.get(t.id))===null||a===void 0?void 0:a.get(e))!==null&&s!==void 0?s:[],c=0;c<f.length;c++)f[c]=it([].concat((0,nd.default)(r),(0,nd.default)(f[c].parentPath.slice(0,l.length))),f[c])}}}},{key:"getScopeItem",value:function(e,r){var t;for(var a of((t=this.itemsByWorkflowAndContextId.get(r.id))===null||t===void 0?void 0:t.keys())||[])if(ka(a,e))return this.scopeItemsByContextId.get(a)}},{key:"addItemToWorkflowList",value:function(e,r){var t=e.contextId;if(t){var a=this.itemsByWorkflowAndContextId.get(r.id);if(a)for(var s of a){var u=(0,Jk.default)(s,2),l=u[0],f=u[1];if(ka(l,t)){f.push(e);var c=new E({resultDescription:`Items for contextId ${l}: [${f.map(function(d){return d.id}).join(",")}]`,operationName:"WIS.addItemOnContextIdList",resourceId:r.id,success:!0}).start();m.info(526403808,v.CoreDefault,c.stop())}}}}},{key:"isWorkflowReady",value:function(e,r){var t=this.workflowDefinitionManager.getWorkflowDefinition(r,e).maxAnnotations;return this.getGeneratedItems(e,r).length>=t}},{key:"getItemsToExecute",value:function(e,r){var t=this.getGeneratedItems(e,r);return this.itemsByWorkflowAndContextId.get(r.id).delete(e),t}},{key:"onWorkflowExecuted",value:function(e,r){var t=e.contextId,a=this.itemsByWorkflowAndContextId.get(r.id);a&&(a.delete(t),a.size===0&&this.itemsByWorkflowAndContextId.delete(r.id)),this.hasWorkflowsAwaitingExecution(t)||this.scopeItemsByContextId.delete(t)}},{key:"getGeneratedItems",value:function(e,r){var t;if(!(!((t=this.itemsByWorkflowAndContextId.get(r.id))===null||t===void 0)&&t.get(e)))return[];var a=this.workflowDefinitionManager.getWorkflowDefinition(r,e).maxAnnotations;return this.itemsByWorkflowAndContextId.get(r.id).get(e).slice(0,a)}},{key:"hasWorkflowsAwaitingExecution",value:function(e){for(var r of this.itemsByWorkflowAndContextId.values())for(var t of r.keys())if(t===e)return!0;return!1}}]),n}();h();var Xk=w(Se()),rd=w(R()),od=w(B());var fr;(function(n){n[n.Local=0]="Local",n[n.External=1]="External"})(fr||(fr={}));var Js=function(){function n(){(0,rd.default)(this,n),this.graphNodeByLocationAndWorkflowId=new Map}return(0,od.default)(n,[{key:"getWorkflow",value:function(e,r){var t,a=this.getLocation(r);return(t=this.graphNodeByLocationAndWorkflowId.get(a))===null||t===void 0?void 0:t.get(e)}},{key:"addWorkflow",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.getWorkflow(e.id,r)){var t=new E({operationName:"AddWorkflowToGraphFailure",success:!1,resourceId:e.id,resultDescription:`Adding a new with workflow with a duplicated workflowId: ${r}`}).start();m.error(524300630,v.CoreDefault,t.stop());return}var a=this.getLocation(r),s=new oM(e,a);this.addWorkflowAsDependency(s);var u=this.graphNodeByLocationAndWorkflowId.get(a);u||(u=new Map,this.graphNodeByLocationAndWorkflowId.set(a,u)),u.set(e.id,s)}},{key:"getUpstreamRuntimeVisibleWorkflows",value:function(){var e=[];for(var r of this.graphNodeByLocationAndWorkflowId.values()||[])for(var t of r.values()||[]){var a=this.createWorkflowDefinition(t.workflow);if(t.workflow.visibility===qr.LocalOnly)this.compressDownstreamWorkflows(a,t);else{var s;(s=a.outputTypes).push.apply(s,(0,Xk.default)(t.workflow.outputTypes))}a.inputTypes.length!==0&&e.push(a)}return e}},{key:"removeWorkflows",value:function(e){var r=this.getLocation(e),t=this.graphNodeByLocationAndWorkflowId.get(r),a=Array.from((t==null?void 0:t.values())||[]);for(var s of a){for(var u of s.upstreamWorkflows.values())u.downstreamWorkflows.delete(s);for(var l of s.downstreamWorkflows.values())l.upstreamWorkflows.delete(s);t.delete(s.workflow.id)}}},{key:"getWorkflowsDefinitions",value:function(){var e=[];for(var r of this.graphNodeByLocationAndWorkflowId.values()||[])for(var t of r.values()||[])e.push(t.workflow);return e}},{key:"getWorkflowNodes",value:function(e){var r=[];for(var t of this.graphNodeByLocationAndWorkflowId.values())for(var a of t.values())r.push(a);return r}},{key:"getLocation",value:function(e){return e?fr.External:fr.Local}},{key:"createWorkflowDefinition",value:function(e){return Object.assign(Object.assign({},e),{outputTypes:[]})}},{key:"compressDownstreamWorkflows",value:function(e,r){for(var t of r.downstreamWorkflows){if(t.workflow.visibility===qr.LocalOnly){this.compressDownstreamWorkflows(e,t);continue}if(!(t.workflow.kind===U.Join&&e.inputTypes.indexOf(t.workflow.collectionScopeType)===-1))for(var a of t.workflow.outputTypes)e.outputTypes.indexOf(a)===-1&&e.outputTypes.push(a)}}},{key:"addWorkflowAsDependency",value:function(e){for(var r of this.graphNodeByLocationAndWorkflowId.values())for(var t of r.values()){for(var a of t.workflow.inputTypes)e.workflow.outputTypes.indexOf(a)!==-1&&this.addWorkflowChain(e,t);for(var s of t.workflow.outputTypes)e.workflow.inputTypes.indexOf(s)!==-1&&this.addWorkflowChain(t,e)}}},{key:"addWorkflowChain",value:function(e,r){e.downstreamWorkflows.add(r),r.upstreamWorkflows.add(e)}}]),n}(),oM=(0,od.default)(function n(o,e){(0,rd.default)(this,n),this.isActivated=!0,this.upstreamWorkflows=new Set,this.downstreamWorkflows=new Set,this.location=e,this.workflow=Object.assign(Object.assign({},o),{inputTypes:Array.isArray(o.inputTypes)?o.inputTypes:[],outputTypes:Array.isArray(o.outputTypes)?o.outputTypes:[]})});h();var pw=w(R()),gw=w(B());h();h();h();h();function Yk(n){return function(){for(var o=arguments.length,e=new Array(o),r=0;r<o;r++)e[r]=arguments[r];var t=e.pop();return n.call(this,e,t)}}h();var iM=typeof queueMicrotask=="function"&&queueMicrotask,aM=typeof setImmediate=="function"&&setImmediate,sM=typeof process=="object"&&typeof process.nextTick=="function";function uM(n){setTimeout(n,0)}function lM(n){return function(o){for(var e=arguments.length,r=new Array(e>1?e-1:0),t=1;t<e;t++)r[t-1]=arguments[t];return n(function(){return o.apply(void 0,r)})}}var Ta;iM?Ta=queueMicrotask:aM?Ta=setImmediate:sM?Ta=process.nextTick:Ta=uM;var Jo=lM(Ta);function id(n){return ad(n)?function(){for(var o=arguments.length,e=new Array(o),r=0;r<o;r++)e[r]=arguments[r];var t=e.pop(),a=n.apply(this,e);return Zk(a,t)}:Yk(function(o,e){var r;try{r=n.apply(this,o)}catch(t){return e(t)}if(r&&typeof r.then=="function")return Zk(r,e);e(null,r)})}function Zk(n,o){return n.then(function(e){ew(o,null,e)},function(e){ew(o,e&&e.message?e:new Error(e))})}function ew(n,o,e){try{n(o,e)}catch(r){Jo(function(t){throw t},r)}}function ad(n){return n[Symbol.toStringTag]==="AsyncFunction"}function fM(n){if(typeof n!="function")throw new Error("expected a function");return ad(n)?id(n):n}var js=fM;h();function sd(n){return function(){if(n===null)throw new Error("Callback was already called.");var o=n;n=null;for(var e=arguments.length,r=new Array(e),t=0;t<e;t++)r[t]=arguments[t];o.apply(this,r)}}h();var ft=w(cs());h();var nw=w(Se()),rw=w(R()),ow=w(B()),iw=function(n){function o(){(0,rw.default)(this,o),this.head=this.tail=null,this.length=0}return(0,ow.default)(o,[{key:"removeLink",value:function(r){return r.prev?r.prev.next=r.next:this.head=r.next,r.next?r.next.prev=r.prev:this.tail=r.prev,r.prev=r.next=null,this.length-=1,r}},{key:"empty",value:function(){for(;this.head;)this.shift();return this}},{key:"insertAfter",value:function(r,t){t.prev=r,t.next=r.next,r.next?r.next.prev=t:this.tail=t,r.next=t,this.length+=1}},{key:"insertBefore",value:function(r,t){t.prev=r.prev,t.next=r,r.prev?r.prev.next=t:this.head=t,r.prev=t,this.length+=1}},{key:"unshift",value:function(r){this.head?this.insertBefore(this.head,r):tw(this,r)}},{key:"push",value:function(r){this.tail?this.insertAfter(this.tail,r):tw(this,r)}},{key:"shift",value:function(){return this.head&&this.removeLink(this.head)}},{key:"pop",value:function(){return this.tail&&this.removeLink(this.tail)}},{key:"toArray",value:function(){return(0,nw.default)(this)}},{key:n,value:function*(){for(var r=this.head;r;)yield r.data,r=r.next}},{key:"remove",value:function(r){for(var t=this.head;t;){var a=t,s=a.next;r(t)&&this.removeLink(t),t=s}return this}}]),o}(Symbol.iterator);function tw(n,o){n.length=1,n.head=n.tail=o}function ud(n,o,e){var r;if(o==null)o=1;else if(o===0)throw new RangeError("Concurrency must not be zero");var t=js(n),a=0,s=[],u={error:[],drain:[],saturated:[],unsaturated:[],empty:[]};function l(I,_){u[I].push(_)}function f(I,_){var M=function A(){c(I,A),_.apply(void 0,arguments)};u[I].push(M)}function c(I,_){if(!I)return Object.keys(u).forEach(function(M){return u[M]=[]});if(!_)return u[I]=[];u[I]=u[I].filter(function(M){return M!==_})}function d(I){for(var _=arguments.length,M=new Array(_>1?_-1:0),A=1;A<_;A++)M[A-1]=arguments[A];u[I].forEach(function(b){return b.apply(void 0,M)})}var p=!1;function g(I,_,M,A){if(A!=null&&typeof A!="function")throw new Error("task callback must be a function");T.started=!0;var b,N;function z(J){if(J)return M?N(J):b();for(var P=arguments.length,D=new Array(P>1?P-1:0),O=1;O<P;O++)D[O-1]=arguments[O];if(D.length<=1)return b(D[0]);b(D)}var L=T._createTaskItem(I,M?z:A||z);if(_?T._tasks.unshift(L):T._tasks.push(L),p||(p=!0,Jo(function(){p=!1,T.process()})),M||!A)return new Promise(function(J,P){b=J,N=P})}function k(I){return function(_){a-=1;for(var M=arguments.length,A=new Array(M>1?M-1:0),b=1;b<M;b++)A[b-1]=arguments[b];for(var N=0,z=I.length;N<z;N++){var L,J=I[N],P=s.indexOf(J);P===0?s.shift():P>0&&s.splice(P,1),(L=J).callback.apply(L,[_].concat(A)),_!=null&&d("error",_,J.data)}a<=T.concurrency-T.buffer&&d("unsaturated"),T.idle()&&d("drain"),T.process()}}function S(I){return I.length===0&&T.idle()?(Jo(function(){return d("drain")}),!0):!1}var x=function(_){return function(M){if(!M)return new Promise(function(A,b){f(_,function(N,z){if(N)return b(N);A(z)})});c(_),l(_,M)}},C=!1,T=(r={_tasks:new iw,_createTaskItem:function(_,M){return{data:_,callback:M}}},(0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)(r,Symbol.iterator,function*(){yield*So(T._tasks[Symbol.iterator]())}),"concurrency",o),"payload",e),"buffer",o/4),"started",!1),"paused",!1),"push",function(_,M){return Array.isArray(_)?S(_)?void 0:_.map(function(A){return g(A,!1,!1,M)}):g(_,!1,!1,M)}),"pushAsync",function(_,M){return Array.isArray(_)?S(_)?void 0:_.map(function(A){return g(A,!1,!0,M)}):g(_,!1,!0,M)}),"kill",function(){c(),T._tasks.empty()}),"unshift",function(_,M){return Array.isArray(_)?S(_)?void 0:_.map(function(A){return g(A,!0,!1,M)}):g(_,!0,!1,M)}),(0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)((0,ft.default)(r,"unshiftAsync",function(_,M){return Array.isArray(_)?S(_)?void 0:_.map(function(A){return g(A,!0,!0,M)}):g(_,!0,!0,M)}),"remove",function(_){T._tasks.remove(_)}),"process",function(){if(!C){for(C=!0;!T.paused&&a<T.concurrency&&T._tasks.length;){var _=[],M=[],A=T._tasks.length;T.payload&&(A=Math.min(A,T.payload));for(var b=0;b<A;b++){var N=T._tasks.shift();_.push(N),s.push(N),M.push(N.data)}a+=1,T._tasks.length===0&&d("empty"),a===T.concurrency&&d("saturated");var z=sd(k(_));t(M,z)}C=!1}}),"length",function(){return T._tasks.length}),"running",function(){return a}),"workersList",function(){return s}),"idle",function(){return T._tasks.length+a===0}),"pause",function(){T.paused=!0}),"resume",function(){T.paused!==!1&&(T.paused=!1,Jo(T.process))}));return Object.defineProperties(T,{saturated:{writable:!1,value:x("saturated")},unsaturated:{writable:!1,value:x("unsaturated")},empty:{writable:!1,value:x("empty")},drain:{writable:!1,value:x("drain")},error:{writable:!1,value:x("error")}}),T}h();h();function aw(n,o){var e=js(n);return ud(function(r,t){e(r[0],t)},o,1)}h();var uw=w(Se()),lw=w(at()),fw=w(R()),cw=w(B()),dw=function(n){function o(){(0,fw.default)(this,o),this.heap=[],this.pushCount=Number.MIN_SAFE_INTEGER}return(0,cw.default)(o,[{key:"length",get:function(){return this.heap.length}},{key:"empty",value:function(){return this.heap=[],this}},{key:"percUp",value:function(r){for(var t;r>0&&ld(this.heap[r],this.heap[t=sw(r)]);){var a=this.heap[r];this.heap[r]=this.heap[t],this.heap[t]=a,r=t}}},{key:"percDown",value:function(r){for(var t;(t=cM(r))<this.heap.length&&(t+1<this.heap.length&&ld(this.heap[t+1],this.heap[t])&&(t=t+1),!ld(this.heap[r],this.heap[t]));){var a=this.heap[r];this.heap[r]=this.heap[t],this.heap[t]=a,r=t}}},{key:"push",value:function(r){r.pushCount=++this.pushCount,this.heap.push(r),this.percUp(this.heap.length-1)}},{key:"unshift",value:function(r){return this.heap.push(r)}},{key:"shift",value:function(){var r=(0,lw.default)(this.heap,1),t=r[0];return this.heap[0]=this.heap[this.heap.length-1],this.heap.pop(),this.percDown(0),t}},{key:"toArray",value:function(){return(0,uw.default)(this)}},{key:n,value:function*(){for(var r=0;r<this.heap.length;r++)yield this.heap[r].data}},{key:"remove",value:function(r){for(var t=0,a=0;a<this.heap.length;a++)r(this.heap[a])||(this.heap[t]=this.heap[a],t++);this.heap.splice(t);for(var s=sw(this.heap.length-1);s>=0;s--)this.percDown(s);return this}}]),o}(Symbol.iterator);function cM(n){return(n<<1)+1}function sw(n){return(n+1>>1)-1}function ld(n,o){return n.priority!==o.priority?n.priority<o.priority:n.pushCount<o.pushCount}function Ks(n,o){var e=aw(n,o),r=e.push,t=e.pushAsync;e._tasks=new dw,e._createTaskItem=function(s,u){var l=s.data,f=s.priority;return{data:l,priority:f,callback:u}};function a(s,u){return Array.isArray(s)?s.map(function(l){return{data:l,priority:u}}):{data:s,priority:u}}return e.push=function(s){var u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=arguments.length>2?arguments[2]:void 0;return r(a(s,u),l)},e.pushAsync=function(s){var u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=arguments.length>2?arguments[2]:void 0;return t(a(s,u),l)},delete e.unshift,delete e.unshiftAsync,e}var hw=function(n){function o(e,r,t){(0,pw.default)(this,o),this.executeTask=e,this.concurrencyLimit=r,this.queue=Ks(this.executeTask,this.concurrencyLimit),this.saturationHandlingStrategy=t,this.onItemAddedCallbacks=[],this.saturationHandlingStrategy&&(this.saturated(this.saturationHandlingStrategy.onSaturated.bind(this.saturationHandlingStrategy,this)),this.unsaturated(this.saturationHandlingStrategy.onUnsaturated.bind(this.saturationHandlingStrategy,this)),this.drained(this.saturationHandlingStrategy.onDrained.bind(this.saturationHandlingStrategy,this)),this.onItemAdded(this.saturationHandlingStrategy.onItemAdded.bind(this.saturationHandlingStrategy,this)))}return(0,gw.default)(o,[{key:"buffer",get:function(){return this.queue.buffer},set:function(r){this.queue.buffer=r}},{key:"concurrency",get:function(){return this.queue.concurrency},set:function(r){this.queue.concurrency=r}},{key:"onItemAdded",value:function(r){this.onItemAddedCallbacks.push(r)}},{key:"drained",value:function(r){this.queue.drain(r)}},{key:"unsaturated",value:function(r){this.queue.unsaturated(r)}},{key:"saturated",value:function(r){this.queue.saturated(r)}},{key:"idle",value:function(){return this.queue.idle()}},{key:"running",value:function(){return this.queue.running()}},{key:"length",value:function(){return this.queue.length()}},{key:"workersList",value:function(){return this.queue.workersList()}},{key:"push",value:function(r,t){this.queue.push(r,t);for(var a of this.onItemAddedCallbacks)a()}},{key:"kill",value:function(){this.queue.kill()}},{key:"clear",value:function(){this.queue.kill(),this.queue=Ks(this.executeTask,this.concurrencyLimit)}},{key:n,value:function*(){yield*So(this.queue[Symbol.iterator]())}},{key:"remove",value:function(r){this.queue.remove(r)}}]),o}(Symbol.iterator);h();var jo=w(Se()),vw=w(R()),yw=w(B());var dM=new G("workflowSynchronizationInterval",10),Xs=new G("skipDebounceDeltasEnabled",!0),pM=new G("defaultMaxSynchronizationWaitTimeMsForNonDeltaTriggerdWorkflows",-1),gM=new G("defaultMaxSynchronizationWaitTimeMsForDeltaTriggerdWorkflows",0),mw=Symbol("isDuplicate"),kw=function(){function n(){(0,vw.default)(this,n),this.tasksInProgress=new Map,this.synchronizationQueue=new Map,this.synchronizationIntervalMs=dM.getValue()}return(0,yw.default)(n,[{key:"notifyBeforeBatchedQueuing",value:function(e,r){var t,a=e.some(function(c){return c.executionScopeId});if(!a)return e;var s=V().startSync(Z.SynchronizeWorkflowTasks);this.markDuplicateTasks(e);var u=[],l=0;for(var f of e){if(!f.executionScopeId){u.push(f);continue}if(f[mw]===!0){(t=f.onComplete)===null||t===void 0||t.call(f,!0),l++;continue}this.postponeTaskIfPreviousInProgress(f,r)||(this.getTasksInProgress(r.workflow.id).set(f.executionScopeId,f),u.push(f))}return l>0&&this.logDuplicateTasksRemoval(r,l),V().stop(s),u}},{key:"notifyBeforeQueueing",value:function(e,r){if(!e.executionScopeId)return!0;V().startSync(Z.SynchronizeWorkflowTask);var t=this.postponeTaskIfPreviousInProgress(e,r);return t||this.getTasksInProgress(r.workflow.id).set(e.executionScopeId,e),V().stop(Z.SynchronizeWorkflowTask),!t}},{key:"notifyOnCancelled",value:function(e,r){this.removeTaskInProgress(e,r,!0)}},{key:"notifyOnCompleted",value:function(e,r){this.removeTaskInProgress(e,r,!1)}},{key:"onSessionClose",value:function(){this.cancelSynchronizationTimer()}},{key:"removeTaskInProgress",value:function(e,r,t){var a;if((a=e.onComplete)===null||a===void 0||a.call(e,!1),!!e.executionScopeId){var s=this.getTasksInProgress(r),u=s.get(e.executionScopeId);if(u===e){s.delete(e.executionScopeId);var l=this.getSynchronizationQueue(r),f=l.get(e.executionScopeId);s.size===0&&this.tasksInProgress.delete(r),f&&this.reInvalidatePostponedWorkflowTask(f,l,t)}else m.info(509137730,v.CoreDefault,"Task in progress do not match the task that completed execution.")}}},{key:"markDuplicateTasks",value:function(e){var r=this;e.reduce(function(t,a){if(a.executionScopeId){var s=t.get(a.executionScopeId);s&&(s[mw]=!0,r.accumulateDataFromPreviousTask(s,a)),t.set(a.executionScopeId,a)}return t},new Map)}},{key:"getTasksInProgress",value:function(e){return Ln(this.tasksInProgress,e,function(){return new Map})}},{key:"getSynchronizationQueue",value:function(e){return Ln(this.synchronizationQueue,e,function(){return new Map})}},{key:"getMaxSynchronizationWaitTimeMs",value:function(e){var r;return e.workflow.maxSynchronizationWaitTimeMs===void 0?!((r=e.workflow.triggerConditions)===null||r===void 0)&&r.includes(Ht.DeltaUpdate)?gM.getValue():pM.getValue():e.workflow.maxSynchronizationWaitTimeMs}},{key:"postponeTaskIfPreviousInProgress",value:function(e,r){var t;if(!Xs.getValue()){var a=this.getMaxSynchronizationWaitTimeMs(r);if(e.maxSynchronizationEndTimeMs!==void 0&&e.maxSynchronizationEndTimeMs<=Date.now()||a===0)return!1;e.maxSynchronizationEndTimeMs===void 0&&(e.maxSynchronizationEndTimeMs=a>0?Date.now()+a:void 0)}var s=this.getTasksInProgress(r.workflow.id).get(e.executionScopeId);if((s==null?void 0:s.status)===Xe.Pending)return s.status=Xe.ExecutionCancelled,this.accumulateDataFromPreviousTask(s,e),(t=s.onComplete)===null||t===void 0||t.call(s,!0),this.logTaskCancellation(r),!1;if(s){var u=this.getSynchronizationQueue(r.workflow.id).get(e.executionScopeId);return u&&(this.cancelPreviousPostponedTask(u),this.accumulateDataFromPreviousTask(u.task,e)),this.postponeTask(e,r),!0}return!1}},{key:"postponeTask",value:function(e,r){var t=this,a=V();Cn(function(s){var u=a.startBranch(Z.PostponeWorkflowTask,st()),l=u.performanceEvent.startAsync(Z.WaitingInSynchronizationQueue);t.getSynchronizationQueue(r.workflow.id).set(e.executionScopeId,{waitingInSyncQueueOp:new E({operationName:"WaitingInSynchronizationQueue",resourceId:r.workflow.resourceId,success:!0,resultSignature:e.executionScopeId}).start(),waitingInSyncQueuePerfEvent:l,task:e,correlationContext:st(),workflowRegistration:r}),!Xs.getValue()&&e.maxSynchronizationEndTimeMs!==void 0&&t.ensureSynchronizationTimer()})}},{key:"cancelPreviousPostponedTask",value:function(e){Le(function(){var r,t;e.waitingInSyncQueueOp.success=!1,m.info(509747279,v.CoreDefault,e.waitingInSyncQueueOp.stop()),(t=(r=e.task).onComplete)===null||t===void 0||t.call(r,!0)},e.correlationContext)}},{key:"accumulateTriggerSignals",value:function(e,r){e.triggerSignals&&(r.triggerSignals?r.triggerSignals=e.triggerSignals.concat(r.triggerSignals):r.triggerSignals=(0,jo.default)(e.triggerSignals))}},{key:"accumulateDeltas",value:function(e,r){var t,a,s,u,l,f;Xs.getValue()||(!((a=(t=e.scopeItem)===null||t===void 0?void 0:t.deltas)===null||a===void 0)&&a.length&&(!((u=(s=r.scopeItem)===null||s===void 0?void 0:s.deltas)===null||u===void 0)&&u.length?r.scopeItem.deltas=e.scopeItem.deltas.concat(r.scopeItem.deltas):r.scopeItem&&(r.scopeItem.deltas=(0,jo.default)((l=e.scopeItem)===null||l===void 0?void 0:l.deltas))),!((f=e.inputItems)===null||f===void 0)&&f.length&&e.inputItems.forEach(function(c){var d,p,g,k=H([].concat((0,jo.default)(c.parentPath),[c.id])),S=(d=r.inputItems)===null||d===void 0?void 0:d.find(function(x){return H([].concat((0,jo.default)(x.parentPath),[x.id]))===k});S!=r.scopeItem&&(!((p=c.deltas)===null||p===void 0)&&p.length)&&S&&(!((g=S==null?void 0:S.deltas)===null||g===void 0)&&g.length?S.deltas=c.deltas.concat(S.deltas):S.deltas=(0,jo.default)(c.deltas))}))}},{key:"accumulateDataFromPreviousTask",value:function(e,r){this.accumulateTriggerSignals(e,r),this.accumulateDeltas(e,r)}},{key:"reInvalidateWorkflowTask",value:function(e,r){var t=V();t.startSync(Z.InvalidateWorkflow),r.invalidate([{item:e.scopeItem,triggerSignals:e.triggerSignals,reInvalidateAfterDebounce:!0,maxSynchronizationEndTimeMs:e.maxSynchronizationEndTimeMs}])}},{key:"logTaskCancellation",value:function(e){var r=new E({operationName:"CancelPendingWorkflowExecution",resourceId:e.workflow.resourceId,success:!0,resultDescription:"New execution for the same scope item arrived."}).start();m.info(509747278,v.CoreDefault,r.stop())}},{key:"logDuplicateTasksRemoval",value:function(e,r){var t=new E({operationName:"RemoveDuplicateTasksFromBatch",count:r,resourceId:e.workflow.resourceId,success:!0}).start();m.info(509747277,v.CoreDefault,t.stop())}},{key:"ensureSynchronizationTimer",value:function(){!Xs.getValue()&&!this.synchronizationTimer&&(this.synchronizationTimer=setInterval(this.onSynchronization.bind(this),this.synchronizationIntervalMs),this.synchronizationTimer.unref&&this.synchronizationTimer.unref())}},{key:"onSynchronization",value:function(){var e=0;if(!this.synchronizationQueue||this.synchronizationQueue.size===0){this.cancelSynchronizationTimer();return}var r=this.synchronizationQueue.keys();for(var t of r){var a=this.getSynchronizationQueue(t);if(!(!a||a.size===0)){var s=a.keys();for(var u of s){var l=a.get(u);!l||l.task.maxSynchronizationEndTimeMs===void 0||(e++,l.task.maxSynchronizationEndTimeMs<=Date.now()&&(this.reInvalidatePostponedWorkflowTask(l,a,!1),e--))}}}e<=0&&this.cancelSynchronizationTimer()}},{key:"cancelSynchronizationTimer",value:function(){this.synchronizationTimer&&(clearInterval(this.synchronizationTimer),this.synchronizationTimer=void 0)}},{key:"reInvalidatePostponedWorkflowTask",value:function(e,r,t){var a=this;Le(function(){var s,u,l=V();l.stop(e.waitingInSyncQueuePerfEvent),r.delete(e.task.executionScopeId),e.waitingInSyncQueueOp.success=!t,m.info(509747283,v.CoreDefault,e.waitingInSyncQueueOp.stop()),(u=(s=e.task).onComplete)===null||u===void 0||u.call(s,!0),t||a.reInvalidateWorkflowTask(e.task,e.workflowRegistration)},e.correlationContext)}}]),n}();h();var cd=w(at()),Ko=w(Se()),ww=w(R()),Sw=w(B());var fd=new G("workflowExecutionManagerExtraLogging",!1),Cw=function(){function n(o){(0,ww.default)(this,n),this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.workflowExecutionTrackersByName=o}return(0,Sw.default)(n,[{key:"pendingNotifications",get:function(){return this.pendingScopeExecutionNotificationsByWorkflow.size>0}},{key:"get",value:function(e,r){var t;return(t=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||t===void 0?void 0:t.get(r)}},{key:"set",value:function(e,r,t){var a=this.pendingScopeExecutionNotificationsByWorkflow.get(e);a||(a=new Map,this.pendingScopeExecutionNotificationsByWorkflow.set(e,a)),a.set(r,t);var s=this.workflowExecutionTrackersByName.get(e);for(var u of t.params||[]){var l=u.item;l.contextId&&s.setExecutionState(l.contextId,Ce.Pending)}}},{key:"delete",value:function(e,r){var t,a,s=(t=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||t===void 0?void 0:t.get(r),u=this.workflowExecutionTrackersByName.get(e);if(s)for(var l of s.params||[]){var f=l.item;if(f.contextId){var c=u.getExecutionState().get(f.contextId);c===Ce.Pending&&u.getExecutionState().delete(f.contextId)}}(a=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||a===void 0||a.delete(r),this.pendingScopeExecutionNotificationsByWorkflow.get(e).size===0&&this.pendingScopeExecutionNotificationsByWorkflow.delete(e)}},{key:"entries",value:function(){return this.pendingScopeExecutionNotificationsByWorkflow.entries()}},{key:"pathIsPurged",value:function(e,r){return(r==null?void 0:r.find(function(t){return ar(t,e)}))!==void 0}},{key:"hasPurgedParam",value:function(e,r){var t=this,a;return((a=e.params)===null||a===void 0?void 0:a.find(function(s){var u,l;return t.pathIsPurged([].concat((0,Ko.default)((u=s==null?void 0:s.item)===null||u===void 0?void 0:u.parentPath),[(l=s==null?void 0:s.item)===null||l===void 0?void 0:l.id]),r)}))!==void 0}},{key:"hasPurgedItem",value:function(e,r,t,a){var s=this,u,l,f=t.getItem(e.scopePath),c=it(e.scopePath.slice(0,-1),f),d=[].concat((0,Ko.default)(c.parentPath),[f.id]),p=e.registration.workflow;if(((u=p.inputTypes)===null||u===void 0?void 0:u.length)>0){var g=[];try{if(a.supportsAreaIntersection(f.body)){var k=a.getAreaIntersectionFilter(f.body),S=t.getSubtreeItems([],p.inputTypes,k),x=t.getSubtreeItems(d,p.inputTypes);g=(0,Ko.default)(new Set(S.concat(x)))}else g=t.getSubtreeItems(d,p.inputTypes)}catch(C){return m.info(507774938,v.CoreDefault,`NotificationManager.hasPurgedItem: failed to retrieve subtree items for workflow ${p.id}: ${C.message}`),this.hasPurgedParam(e,r)}return p.kind===U.Reduce||p.kind===U.Generic?g=(l=a.fetchInputChanges(p,g,c))!==null&&l!==void 0?l:g:g=g.filter(function(C){return y.matchesTypesFor(C.body,[Nn.getTypeName()])}),g.find(function(C){return s.pathIsPurged([].concat((0,Ko.default)(C.parentPath),[C.id]),r)})!==void 0}return this.hasPurgedParam(e,r)}},{key:"cancelPendingNotifications",value:function(e,r,t){var a,s,u,l=[],f=new E({operationName:"NotificationManager.cancelPendingNotifications",success:!0}).start(),c=function(q){return(q==null?void 0:q.filter(function(W){return!y.matchesTypesFor(W,[En.getTypeName()])}).length)||0},d=[];for(var p of this.pendingScopeExecutionNotificationsByWorkflow.entries()){var g=(0,cd.default)(p,2),k=g[0],S=g[1],x=[];for(var C of S.entries()){var T=(0,cd.default)(C,2),I=T[0],_=T[1],M=_.registration.workflow,A=M.kind===U.Reduce||M.kind===U.Grid||M.kind===U.Generic,b=_.scopePath,N=this.pathIsPurged(b,e),z=!1;if(A&&!N?z=this.hasPurgedItem(_,e,r,t):(!A||!N)&&(z=this.hasPurgedParam(_,e)),!N&&!z){fd.getValue()&&m.info(507856781,v.CoreDefault,`NotificationManager.cancelPendingNotifications: not cancelling pending workflow=${M.id}, notificationKey=${I}: not affected by purge`);continue}var L=c(_.triggerSignals),J=(s=((a=_.params)===null||a===void 0?void 0:a.find(function(F){return c(F==null?void 0:F.triggerSignals)>0}))!==void 0)!==null&&s!==void 0?s:!1;if(L>0||J){fd.getValue()&&m.info(507856780,v.CoreDefault,`NotificationManager.cancelPendingNotifications: not cancelling pending workflow=${M.id}, notificationKey=${I}, signalCount=${L}, invalidated by signal=${J}: triggered by signal`);continue}if(fd.getValue()&&m.info(507856779,v.CoreDefault,`NotificationManager.cancelPendingNotifications: cancelling pending workflow=${M.id}, notificationKey=${I}`),x.push(I),M.kind===U.SingleItem){var P=(u=_.params)!==null&&u!==void 0?u:[];for(var D of P)l.push({workflowId:M.id,itemPath:[].concat((0,Ko.default)(D.item.parentPath),[D.item.id])})}else A?l.push({workflowId:M.id,itemPath:b}):m.error(507811590,v.CoreDefault,`NotificationManager.cancelPendingNotifications: Workflow of type ${M.kind} is not supported`)}for(var O of x)S.delete(O);S.size===0&&d.push(k)}for(var $ of d)this.pendingScopeExecutionNotificationsByWorkflow.delete($);return f.count=l.length,f.resultJSON=JSON.stringify(l),m.info(507856778,v.CoreDefault,f.stop()),l}}]),n}();function hM(n){var o=mM();return function(){var r=(0,pd.default)(n),t;if(o){var a=(0,pd.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Mw.default)(this,t)}}function mM(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Ia;(function(n){n.SessionInitMessage="SessionInitMessage",n.AnnotationActivatedMessage="AnnotationActivatedMessage",n.SeedCompleted="SeedCompleted",n.TokenProvisionMessage="TokenProvisionMessage"})(Ia||(Ia={}));var Yo;(function(n){n.AnnotationActivation="annotation activation",n.Auth="auth",n.Flight="flight",n.Seeding="seeding",n.WorkflowDisabled="disabled",n.UserType="user type",n.UserContext="user context"})(Yo||(Yo={}));var yo;(function(n){n[n.Workflow=0]="Workflow",n[n.ApologiesGenerator=1]="ApologiesGenerator",n[n.PrefilterManager=2]="PrefilterManager"})(yo||(yo={}));var Xe;(function(n){n[n.Pending=0]="Pending",n[n.Running=1]="Running",n[n.ExecutionCancelled=2]="ExecutionCancelled",n[n.ResultsCancelled=3]="ResultsCancelled"})(Xe||(Xe={}));var Ar;(function(n){n[n.Unknown=0]="Unknown",n[n.ClientClose=1]="ClientClose",n[n.IdleTimeout=2]="IdleTimeout",n[n.ExpireTimeout=3]="ExpireTimeout",n[n.MastermindShutdown=4]="MastermindShutdown",n[n.SessionExtensionClose=5]="SessionExtensionClose"})(Ar||(Ar={}));var xw;(function(n){n.Failure="Failure",n.Success="Success",n.Partial="Partial"})(xw||(xw={}));var vM=new G("workflowConcurrencyLimit",100),xk=new G("setAnnotationStateToSent",!0),Tw=new G("delayedWorkflowActivationTierThreshold",Sn.DelayActivate),yM=new G("workflowMaxTriggerSignalOpsQueueLength",100),kM=new G("sessionLogMinDurationInMs",30),wM=new G("workflowsAllowedToPreactivate",[]),SM=new G("enableRefactoredDebouncing",!0),CM=new G("workflowBatchSizeMax",10),dd="session-init-message",Ew=function(n){(0,Aw.default)(e,n);var o=hM(e);function e(r,t,a){var s;(0,Iw.default)(this,e),s=o.call(this),s.annotationActivationInfosByType=new Map,s.workflowRegistrationsByName=new Map,s.workflowsWaitingForActivation=new Set,s.workflowsByOutputAnnotation=new Map,s.workflowsByInputAnnotation=new Map,s.workflowsByRequestedContextType=new Map,s.workflowGraph=new Js,s.outputAnnotationsRequiredByDownstreamWorkflows=new Set,s.statelessItemListeners=new xs,s.pendingExecutionStateUpdates=new Map,s.lastSeenAnnotationStateByAnnotation=new Map,s.workflowDefinitionManager=new Fs,s.nextAnnotationResultsSequenceId=1,s.nextWorkflowExecutionCompleteSequenceId=1,s.cvParent=new Qe,s.isSeedingCompleted=!1,s.workflowInputTypes=new Set,s.clientMetadataFlightsSet=new Set,s.enableRemoteExecutionNotification=!1,s.isClosed=!1,s.sessionKey=r,s.stats=a,s.sessionObjectCreationTime=Date.now(),s.startTime=t.initialStartTime?t.initialStartTime:s.sessionObjectCreationTime,s.upstreamMessageEndpoint=t.upstreamMessageEndpoint,s.downstreamMessageEndpoint=t.downstreamMessageEndpoint,s.cache=t.cache,s.workflowClientCoordinator=new Qk(s.upstreamMessageEndpoint,s.sessionKey,void 0),s.inputChangesManager=new ok(s.cache),s.annotationProcessor=new Ck((0,Ye.default)(s)),s.statelessAnnotationProcessor=new Mk((0,Ye.default)(s),s.statelessItemListeners),s.contextIdManager=new Lt(Ho.JsClient,s.workflowGraph),s.workflowItemStorage=new Qs(s.workflowDefinitionManager),s.workflowQueue=new hw(s.executeWorkflow.bind((0,Ye.default)(s)),vM.getValue()),s.upstreamMessageEndpoint.onMessage(gt.getTypeName(),s.onSessionInitMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(Je.getTypeName(),s.onSessionCloseMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(nr.getTypeName(),s.onTokenProvisionMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(Yr.getTypeName(),s.onWorkflowGraphInitMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(fn.getTypeName(),s.onAnnotationActivationMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(Xr.getTypeName(),s.onAnnotationConfigUpdateMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(Be.getTypeName(),s.onSyncMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(tr.getTypeName(),s.onMicroSyncMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(to.getTypeName(),s.onWorkflowRegistrationMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(rr.getTypeName(),s.onWorkflowDefinitionOverrideMessage.bind((0,Ye.default)(s))),s.upstreamMessageEndpoint.onMessage(ro.getTypeName(),s.onGetAnnotationsRequestMessage.bind((0,Ye.default)(s))),s.downstreamMessageEndpoint&&s.downstreamMessageEndpoint.onMessage(Nt.getTypeName(),s.onAnnotationResultsMessage.bind((0,Ye.default)(s))),s.syncMessageSequencer=new mk(s.applySyncMessage.bind((0,Ye.default)(s)),t.isReconnect),s.syncMessageSequencer.on("seedCompleted",s.onSeedCompleted.bind((0,Ye.default)(s)));var u=new Map,l=new Cw(u);return s.usesRefactoredDebouncing=SM.getValue(),s.workflowSynchronizationManager=s.usesRefactoredDebouncing?new kw:void 0,s.workflowExecutionManager=Fk({cache:s.cache,workflowRegistrationsByName:s.workflowRegistrationsByName,workflowsByInputAnnotation:s.workflowsByInputAnnotation,workflowsByOutputAnnotation:s.workflowsByOutputAnnotation,workflowsByRequestedContextType:s.workflowsByRequestedContextType,queueWorkflow:s.queueWorkflow.bind((0,Ye.default)(s)),queueGridNeighborhoodWorkflow:s.queueGridNeighborhoodWorkflow.bind((0,Ye.default)(s)),inputChangesManager:s.inputChangesManager,getUserNodePath:function(){return s.userNodePath},getTenantNodePath:function(){return s.tenantNodePath},getUserCommandsNodePath:function(){return s.userCommandsNodePath},workflowDefinitionManager:s.workflowDefinitionManager,workflowItemStorage:s.workflowItemStorage,sessionCreationTime:s.startTime,workflowQueue:s.workflowQueue,executionCompleteCallback:s.onWorkflowExecutionComplete.bind((0,Ye.default)(s)),usesRefactoredDebouncing:s.usesRefactoredDebouncing,workflowSynchronizationManager:s.workflowSynchronizationManager,workflowBatchSizeMax:function(){return CM.getValue()},areasIntersect:function(c){return!1},supportsAreaIntersection:function(c){return!1},itemScopeMovedTracker:void 0,notificationManager:l,workflowExecutionTrackersByName:u}),s.workflowExecutionManager.on("executionStateChange",s.onWorkflowExecutionStateChanged.bind((0,Ye.default)(s))),s.workflowExecutionManager.on("sweep",s.onWorkflowExecutionManagerSweep.bind((0,Ye.default)(s))),s.workflowRegistrationsByName.forEach(function(f){return f.setExecutionManager(s.workflowExecutionManager)}),s.cache.on("beforeItemChange",function(f){s.inputChangesManager.applyChanges([f])}),m.info(595720205,v.CoreDefault,`Starting session ${s.sessionKey}. Is reconnect: ${t.isReconnect}.`),s}return(0,_w.default)(e,[{key:"onClose",value:function(t,a,s){var u=this;ss(function(){var l;m.info(536959044,v.CoreDefault,`Session closing: ${Ar[t]} ${(l=a==null?void 0:a.reason)!==null&&l!==void 0?l:""}`),u.workflowQueue.kill(),u.isClosed=!0,u.downstreamMessageEndpoint&&u.downstreamMessageEndpoint.sendMessage(new Je(a)),t!==Ar.ClientClose&&u.upstreamMessageEndpoint.sendMessage(new Je(a)),u.syncMessageSequencer.onClose(),u.workflowExecutionManager.onSessionClose(),t===Ar.MastermindShutdown&&u.cache.dispose(),s()},this.cvParent.toString(),{sessionKey:this.sessionKey},this.clientMetadata)}},{key:"registerWorkflow",value:function(t){if(m.info(537781729,v.CoreDefault,`Session registering ${U[t.kind]} workflow ${t.id} at priority ${t.priority}`),this.workflowRegistrationsByName.has(t.id))throw new Error(`A workflow with name ${t.id} already exists`);var a=new Hk(t,this.workflowQueue);this.workflowRegistrationsByName.set(a.workflow.id,a),this.addWorkflowToDependencyMaps(t),this.workflowsWaitingForActivation.add(a),this.workflowGraph.addWorkflow(ya(t)),this.workflowExecutionManager.attachExecutionTrackerToWorkflow(a,this.workflowsByInputAnnotation,this.workflowsByOutputAnnotation,this.workflowsByRequestedContextType),a.setExecutionManager(this.workflowExecutionManager)}},{key:"onWorkflowGraphInitMessage",value:function(t,a){var s=new E({operationName:"WorkflowGraphInit"}).start(),u=new $i({downstreamRuntimeWorkflows:this.workflowGraph.getUpstreamRuntimeVisibleWorkflows()});s.success=!0,m.info(524850697,v.CoreDefault,s.stop()),a(void 0,u)}},{key:"sendAnnotations",value:function(t,a,s,u,l){var f=this,c=this.annotationActivationInfosByType.get(t);!this.isClosed&&c&&(!s||c.some(function(d){return d.sendApologies}))&&Cn(function(d){var p,g=new Re({sessionHealthEventName:"SendAnnotations",resourceId:u==null?void 0:u.resourceId,source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,success:!0,message:"",affectedWorkflows:[(p=u==null?void 0:u.resourceId)!==null&&p!==void 0?p:"All"]}).start(),k=function(x){var C=0;for(var T of a)y.getTypeNameFor(T)===x.getTypeName()&&(C+=T.items.length);return C};m.info(573870239,v.CoreDefault,`Sending annotations to client (type: ${t}, workflow: ${u?u.id:void 0}, added: ${k(ke)}, updated: ${k(Pe)}, deleted: ${k(Ge)})`),f.upstreamMessageEndpoint.sendMessage(new Nt({cv:d.toString(),seq:f.nextAnnotationResultsSequenceId++,annotationType:t,batchSize:1,batchId:l,batchComplete:!0,ops:a}),function(S){g.success=!S||f.isClosed,g.message=S==null?void 0:S.error,g.success?m.verbose(536959046,v.CoreDefault,g.stop()):m.info(536959045,v.CoreDefault,g.stop())})})}},{key:"processAnnotationQueue",value:function(t,a){if(On(t)){this.statelessAnnotationProcessor.processAnnotationQueue(t,a);return}if(!t.bypassModel){this.annotationProcessor.processAnnotationQueue(t,a);return}var s=[],u=[];for(var l of a){if(l.annotationQueue.length===0){u.push(l);continue}var f=[],c=[];for(var d of l.annotationQueue)Os(t,d.annotationType)?f.push(d):c.push(d);if(f.length===0){u.push(l);continue}s.push(Object.assign(Object.assign({},l),{annotationQueue:f})),u.push(Object.assign(Object.assign({},l),{annotationQueue:c}))}this.statelessAnnotationProcessor.processAnnotationQueue(t,s),this.annotationProcessor.processAnnotationQueue(t,u)}},{key:"updateWorkflowExecutionStates",value:function(t){var a=this.workflowRegistrationsByName.values();for(var s of t)if(Sa.has(y.getTypeNameFor(s)))for(var u of s.items)for(var l of a||[]){var f=l.workflow;this.workflowExecutionManager.preProcessItemToWorkflow(f,u)}}},{key:"onWorkflowRegistrationMessage",value:function(t,a){var s=t.workflowDefinition,u,l;try{this.registerWorkflow(s),l=new Fe}catch(f){u=new Y({error:f.message})}finally{a(u,l)}}},{key:"onSessionInitMessage",value:function(t,a){if(m.info(537781730,v.CoreDefault,`SessionInit for ${this.sessionKey}`),!t.clientMetadata)m.error(537781731,v.CoreDefault,"Client metadata NOT received");else{if(this.clientMetadata=t.clientMetadata,this.clientMetadata.flights){var s=this.clientMetadata.flights.toLowerCase().split(";");this.clientMetadataFlightsSet=new Set;for(var u of s){var l=u.charCodeAt(0),f=u.charCodeAt(u.length-1);l<33||l>126||f<33||f>126?this.clientMetadataFlightsSet.add(u.trim()):this.clientMetadataFlightsSet.add(u)}}this.upstreamMessageEndpoint.setClientMetadata(this.clientMetadata),this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.setClientMetadata(this.clientMetadata),this.workflowClientCoordinator.setClientMetadata(this.clientMetadata),this.syncMessageSequencer.setClientMetadata(this.clientMetadata),this.workflowExecutionManager.setClientMetadata(this.clientMetadata)}this.enableRemoteExecutionNotification=t.enableRemoteExecutionNotification||!1,this.createUserNodeIfNotExists(),this.createTenantNodeIfNotExists(),this.createUserCommandsNodeIfNotExists(),this.activateWaitingWorkflows(Ia.SessionInitMessage);var c=new ln({sessionUrlBase:"",sessionKey:this.sessionKey,origin:"",messageId:t.messageId,workflowInputTypes:t.returnWorkflowInputTypes?Array.from(this.workflowInputTypes):[],anonymousToken:"FakeToken",tokenExpirationSeconds:999999,downstreamRuntimeWorkflows:this.enableRemoteExecutionNotification?this.workflowGraph.getUpstreamRuntimeVisibleWorkflows():[]});a(void 0,c)}},{key:"onSessionCloseMessage",value:function(t,a){m.info(509728132,v.CoreDefault,`SessionClose for ${this.sessionKey}`),this.onClose(Ar.ClientClose,t,function(s){s?a(void 0,new Y({messageId:t.messageId,error:s.message})):a(void 0,new ea({messageId:t.messageId}))})}},{key:"onAnnotationActivationMessage",value:function(t,a){var s=this;this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.sendMessage(new fn(t));var u=new Re({sessionHealthEventName:"AnnotationActivation",source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],resultDescription:`Activating: ${t.annotationType} with token ${t.token}`},this.clientMetadata).start();{var l=a;a=function(A,b){A&&(u.success=!1),m.info(536959047,v.CoreDefault,u.stop()),l(A,b)}}var f=t.annotationType;if(!f){u.setReason(pe.Client),a(new Y({error:"No annotation type provided"}));return}var c=t.sendStateUpdates,d=t.config,p=t.token,g=t.sendApologies,k=this.annotationActivationInfosByType.get(f),S=!k;S&&(k=[],this.annotationActivationInfosByType.set(f,k)),k.forEach(function(M,A){M.token===t.token&&k.splice(A,1)}),k.push({token:p,sendStateUpdates:c,sendApologies:g,config:d}),m.verbose(536959048,v.CoreDefault,function(){return`Session.onAnnotationActivationMessage: '${f}' annotation was activated`});var x=function(A){t.batchId?(m.info(536959049,v.CoreDefault,"Client supplied batchId param (or ChangeGate was disabled), using legacy behavior"),a(void 0,new Qr({token:p,annotationNotExists:!1})),Array.isArray(A)&&s.sendAnnotations(f,A,!1,void 0,t.batchId||t.token||"Unknown")):(a(void 0,new Fe),Array.isArray(A)&&A.length>0&&s.sendAnnotations(f,A,!1))};if(t.ignoreExistingAnnotations)x();else if(S){var C;try{C=this.cache.getSubtreeItems([],[f])}catch(M){a(new Y({error:`Failed to retrieve existing annotations: ${M.message}`}));return}m.info(536959050,v.CoreDefault,`Sending existing annotations to client (type: ${f}, count: ${C.length})`);var T=C.map(function(M){return new ke({parentPath:M.parentPath,items:[M]})});x(T)}if(c){var I=this.workflowExecutionManager.getWorkflowsByExecutionState(Ce.Pending,Ce.Running);for(var _ of this.workflowsByOutputAnnotation.get(t.annotationType)||[])!I.has(_)||this.pendingExecutionStateUpdates.has(_)||this.pendingExecutionStateUpdates.set(_,Ce.Pending);this.workflowExecutionManager.requestSweep()}this.unsuspendWorkflows(f),this.emit("annotationActivationMessageReceived"),this.activateWaitingWorkflows(Ia.AnnotationActivatedMessage)}},{key:"unsuspendWorkflows",value:function(t){for(var a of(0,_t.default)(this.workflowsByOutputAnnotation.get(t)||[]))if(this.workflowRegistrationsByName.get(a.id).suspendExecution){for(var s of this.workflowExecutionManager.getAllUpstreamWorkflowIds(a.id).reverse())this.workflowRegistrationsByName.get(s).suspendExecution&&(this.workflowRegistrationsByName.get(s).suspendExecution=!1,m.info(509155540,v.CoreDefault,`Execution of ${s} is unsuspended by downstream workflow request.`),this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(s)));this.workflowRegistrationsByName.get(a.id).suspendExecution=!1,m.info(509155539,v.CoreDefault,`Execution of ${a.id} is unsuspended by annotation activation request.`),this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(a.id))}}},{key:"onAnnotationReleaseMessage",value:function(t,a){var s=!1,u=!1,l=new Re({sessionHealthEventName:"AnnotationRelease",source:Te.Core,reason:pe.Core,impact:Ie.None,success:!1,message:"",affectedWorkflows:["All"],resultDescription:`Releasing token: ${t.token}`},this.clientMetadata).start();for(var f of this.annotationActivationInfosByType){var c=(0,Xo.default)(f,2),d=c[0],p=c[1],g=p.findIndex(function(k){return k.token==t.token});if(g>=0){p.length===1?(this.annotationActivationInfosByType.delete(d),u=!0,this.trySuspendWorkflowByAnnotationRelease(d)):p.splice(g,1),s=!0,l.success=!0,l.resultDescription=`Releasing: ${d} and token ${t.token}, lastRelease: ${u}`;break}}m.info(536959051,v.CoreDefault,l.stop()),s?a(void 0,new Kr({lastRelease:u})):a(new Y({error:Wt.AnnotationTokenNotFound}))}},{key:"trySuspendWorkflowByAnnotationRelease",value:function(t){for(var a of(0,_t.default)(this.workflowsByOutputAnnotation.get(t)||[]))if(this.workflowMeetsSuspendConditions(a)){this.workflowRegistrationsByName.get(a.id).suspendExecution=!0,m.info(509155538,v.CoreDefault,`Output annotations fully released, suspending ${a.id} execution.`);for(var s of this.workflowExecutionManager.getAllUpstreamWorkflowIds(a.id))this.trySuspendWorkflowByDownstreamRelease(this.workflowRegistrationsByName.get(s))}}},{key:"workflowMeetsSuspendConditions",value:function(t){var a=this;if(this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(t.id))||(t.outputTypes||[]).some(function(l){return a.annotationActivationInfosByType.has(l)}))return!1;var s=!0;for(var u of this.workflowExecutionManager.getAllDownstreamWorkflowIds(t.id))if(!this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(u))&&!this.workflowRegistrationsByName.get(u).suspendExecution){s=!1;break}return s}},{key:"trySuspendWorkflowByDownstreamRelease",value:function(t){this.workflowMeetsSuspendConditions(t.workflow)&&(t.suspendExecution=!0,m.info(509155537,v.CoreDefault,`Downstream workflows fully released, suspending ${t.workflow.id} execution.`))}},{key:"onWorkflowDefinitionOverrideMessage",value:function(t,a){var s,u,l,f,c=new Re({sessionHealthEventName:"WorkflowDefinitionOverride",source:Te.Core,reason:pe.Core,impact:Ie.None,success:!1,message:"",affectedWorkflows:["All"],joinContextId:(s=t.contextId)!==null&&s!==void 0?s:""},this.clientMetadata).start(),d=function(S,x){c.setReason(S),c.resultDescription=x,m.error(529093136,v.CoreDefault,c.stop()),a(new Y({error:x}))},p=(u=this.workflowRegistrationsByName.get(t.sourceWorkflowId))===null||u===void 0?void 0:u.workflow;if(!p){d(pe.Workflow,`Workflow registration for source workflow '${t.targetWorkflowId} was not found.`);return}var g=(l=this.workflowRegistrationsByName.get(t.targetWorkflowId))===null||l===void 0?void 0:l.workflow;if(!g){d(pe.Workflow,`Workflow registration for target workflow '${t.targetWorkflowId} was not found.`);return}if(!g.allowDefinitionOverride){d(pe.Workflow,`Workflow '${g.id} does not allow workflow definition override.`);return}if(!(!((f=p.definitionOverrideTargetWorkflows)===null||f===void 0)&&f.includes(g.id))){d(pe.Workflow,`Workflow '${p.id} does not allow workflow definition for workflow '${g.id}'.`);return}this.workflowDefinitionManager.mergeWorkflowDefinition(g,t.definition,t.contextId),c.success=!0,c.resourceId=p.id,c.resultDescription=`Updated config for workflow: ${t.targetWorkflowId}, context id: ${t.contextId}`,m.info(529093137,v.CoreDefault,c.stop()),a(void 0,new Fe)}},{key:"onGetAnnotationsRequestMessage",value:function(t,a){throw new Error("Not implemented yet")}},{key:"onAnnotationConfigUpdateMessage",value:function(t,a){for(var s of this.annotationActivationInfosByType){var u=(0,Xo.default)(s,2),l=u[0],f=u[1],c=f.findIndex(function(g){return g.token===t.token});if(c>=0){var d=f[c];d.config=t.config,f.splice(c,1),f.push(d);for(var p of(0,_t.default)(this.workflowsByOutputAnnotation.get(l)||[]))(!en(p)||this.isWorkflowTriggeredByNonExclusiveSignals(p))&&!this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(p.id))&&this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(p.id));m.info(529093138,v.CoreDefault,`Updated: ${l} config by token ${t.token}`),a(void 0,new Wo({token:t.token,success:!0}));return}}m.error(529093139,v.CoreDefault,`Annotation token: ${t.token} was not found`),a(void 0,new Wo({token:t.token,success:!1}))}},{key:"onMicroSyncMessage",value:function(t,a){var s=new ke({items:[t.item],parentPath:t.parentPath||["session"]});this.statelessItemListeners.emitEvents([s]),a(void 0,new Fe)}},{key:"onSyncMessage",value:function(t,a){var s=this;if(this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.sendMessage(new Be(t)),this.contextIdManager.applyContextIdOnOperations(t.ops),this.updateWorkflowExecutionStates(t.ops),t.ops&&t.ops.length>0&&Tn.typeGuard(t.ops[0])){this.applySyncMessage(t,a);return}var u=[];if(t.ops&&t.ops.length>0)for(var l of t.ops)if(y.getTypeNameFor(l)===ot.getTypeName()){var f=function(p){if(!p.body)return 1;var g=function(x){var C=x.workflow.kind===U.SingleItem&&y.matchesTypesFor(p.body,x.workflow.inputTypes),T=en(x.workflow)&&y.matchesTypesFor(p.body,x.workflow.triggerSignals);(C||T)&&(m.verbose(536959052,v.CoreDefault,function(){return`Received trigger signal ${y.getTypeNameFor(p.body)}, adding it to cache for waiting workflow ${x.workflow.resourceId}`}),Array.isArray(x.triggerSignalOpsQueue)||(x.triggerSignalOpsQueue=[]),x.triggerSignalOpsQueue.push(new ot({parentPath:l.parentPath,items:[p]})),x.triggerSignalOpsQueue.length>yM.getValue()&&(m.verbose(536959053,v.CoreDefault,function(){return`Exceeded max trigger signal cache size for ${x.workflow.resourceId}, discarding oldest`}),x.triggerSignalOpsQueue.shift()))};for(var k of s.workflowsWaitingForActivation)g(k)};for(var c of l.items)f(c);m.info(529093140,v.CoreDefault,"Dispensing signal operation to listeners"),this.statelessItemListeners.emitEvents([l])}else H(l.parentPath)==H(["session","#userContext#"])&&this.userNodePath&&(l.parentPath=(0,_t.default)(this.userNodePath)),H(l.parentPath)==H(["session","#tenantContext#"])&&this.tenantNodePath&&(l.parentPath=(0,_t.default)(this.tenantNodePath)),H(l.parentPath)==H(["session","#userCommands#"])&&this.userCommandsNodePath&&(l.parentPath=(0,_t.default)(this.userCommandsNodePath)),u.push(l);t.ops=u,t.seq!==void 0?this.syncMessageSequencer.onSyncMessage(t,a):(u.length>0&&m.warn(536959054,v.CoreDefault,"SyncMessage with non signal operations and undefined sequence bypassed"),a(void 0,new cn))}},{key:"onWorkflowExecutionManagerSweep",value:function(){var t=this;if(!(this.pendingExecutionStateUpdates.size===0||this.isClosed)){var a=new Map;for(var s of this.annotationActivationInfosByType){var u=(0,Xo.default)(s,2),l=u[0],f=u[1];if(f.some(function(_){return _.sendStateUpdates})){var c=(0,_t.default)(this.workflowsByOutputAnnotation.get(l)||[]).filter(function(_){return t.pendingExecutionStateUpdates.has(_)});if(c.length!==0){var d=!0;for(var p of c)if(this.pendingExecutionStateUpdates.get(p)!==Ce.Idle){d=!1;break}d?this.lastSeenAnnotationStateByAnnotation.get(l)===un.Pending&&a.set(l,un.Idle):(this.lastSeenAnnotationStateByAnnotation.get(l)||un.Idle)===un.Idle&&a.set(l,un.Pending)}}}var g=new Array(a.size),k=0;for(var S of a){var x=(0,Xo.default)(S,2),C=x[0],T=x[1];this.lastSeenAnnotationStateByAnnotation.set(C,T),g[k++]={annotationType:C,state:T}}if(this.pendingExecutionStateUpdates.clear(),g.length>0&&!this.isClosed){var I=new Re({sessionHealthEventName:"SendAnnotationResultStates",source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,success:!0,message:"",affectedWorkflows:["All"]}).start();this.upstreamMessageEndpoint.sendMessage(new Jr({updates:g}),function(_){I.success=!_||t.isClosed,I.message=_==null?void 0:_.error,I.success?m.verbose(536959056,v.CoreDefault,I.stop()):m.info(536959055,v.CoreDefault,I.stop())})}}}},{key:"onWorkflowExecutionComplete",value:function(t,a){this.enableRemoteExecutionNotification&&this.upstreamMessageEndpoint.sendMessage(new Zr({seq:this.nextWorkflowExecutionCompleteSequenceId++,workflowId:t,contextId:a,ops:[]}),function(s){if(s){var u=new E({operationName:"WorkflowExecutionCompleteMessageError",resourceId:t,joinContextId:a});u.resultDescription=s==null?void 0:s.error,m.error(512354250,v.CoreDefault,u)}})}},{key:"onWorkflowExecutionStateChanged",value:function(t,a){var s=this,u=this.workflowRegistrationsByName.get(t).workflow,l=(0,_t.default)(u.outputTypes||[]).some(function(f){return(0,_t.default)(s.annotationActivationInfosByType.get(f)||[]).some(function(c){return c.sendStateUpdates})});l&&(this.pendingExecutionStateUpdates.set(u,a),this.workflowExecutionManager.requestSweep())}},{key:"onSeedCompleted",value:function(){this.isSeedingCompleted=!0,this.activateWaitingWorkflows(Ia.SeedCompleted)}},{key:"applySyncMessage",value:function(t,a){var s=new Re({sessionHealthEventName:"ApplySyncMessage",source:Te.Core,reason:pe.Core,impact:Ie.MissingInput,success:!0,message:`seq=${t==null?void 0:t.seq}`,resourceId:(t==null?void 0:t.seq)<=0?"Seeding":"NonSeeding"}).start();if(!t||!Array.isArray(t.ops)||!t.ops.length){a(void 0,new cn);return}try{this.cache.applyOperations(t.ops,t.seq),m.info(536959059,v.CoreDefault,s.stop()),a(void 0,new cn)}catch(u){s.success=!1,m.error(536959057,v.CoreDefault,s.stop()),m.error(536959058,v.CoreDefault,`Cache apply failed: ${u.stack}`),a(new Y({error:"Failed to commit"}));return}}},{key:"activateWorkflowByType",value:function(t){if(t.isActivated=!0,t.workflow.kind===U.SingleItem)this.activateSingleItemWorkflow(t);else if(t.workflow.kind===U.DynamicText)this.activateDynamicTextWorkflow(t);else if(t.workflow.kind===U.Reduce)this.activateReduceWorkflow(t);else if(t.workflow.kind===U.Grid)this.activateGridNeighborhoodWorkflow(t);else if(t.workflow.kind===U.Join)this.activateJoinWorkflow(t);else if(t.workflow.kind===U.Generic)this.activateGenericWorkflow(t);else throw new Error("Unknown workflow type");var a=t.workflow.kind;(a===U.Reduce||a===U.DynamicText||a===U.Generic)&&this.setupEventListener(t),this.setupContextListener(t),this.emit("workflowActivated",t)}},{key:"onAnnotationResultsMessage",value:function(t,a){this.upstreamMessageEndpoint.sendMessage(new Nt(t),a);try{this.cache.applyOperations(t.ops,void 0)}catch(s){}}},{key:"shouldTriggerOnAnnotationMetadataUpdated",value:function(t,a){var s;return!!(t!=null&&t.M_&&(!((s=a.triggerConditions)===null||s===void 0)&&s.includes(Ht.AnnotationMetadataUpdated)))}},{key:"shouldInvalidateOnEvent",value:function(t){var a,s,u,l=t.workflow.eventSequenceOptions,f=(s=(a=l.windowIncrement)!==null&&a!==void 0?a:l.minWindowSize)!==null&&s!==void 0?s:1;if(t.eventCountSinceLastTrigger<f)return!1;var c=Date.now()-t.lastTriggerByEventsTime;return!((u=c<l.minTimeIncrement)!==null&&u!==void 0&&u)}},{key:"setupEventListener",value:function(t){var a=this;!t.workflow.eventSequenceOptions||t.workflow.eventSequenceOptions.shouldTriggerWorkflow===!1||this.cache.onItemChange(Lr.getTypeName(),t.workflow.inputStage,function(s){if(!t.suspendExecution){for(var u of s){var l=y.getTypeNameFor(u);for(var f of u.items)l===ke.getTypeName()&&qs(f.body,t.workflow.eventSequenceOptions)&&t.eventCountSinceLastTrigger++}a.shouldInvalidateOnEvent(t)&&t.invalidate([{isInvalidatedByEvents:!0}])}})}},{key:"setupContextListener",value:function(t){if(!(!t.workflow.requestedContextTypesRules||en(t.workflow)&&!this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow)||t.workflow.kind==U.Join||Ir(t.workflow))){for(var a of t.workflow.requestedContextTypesRules)if(a.shouldTriggerOnContextChange)for(var s of a.contextTypes)this.onContextChange(s,t)}}},{key:"onContextChange",value:function(t,a){var s=this,u=function(f,c,d){if(!d)return!1;var p=s.cache.getItem(d);if(!p)return!1;var g=H(d),k=p.body&&y.matchesTypesFor(p.body,[Mt.getTypeName(),zn.getTypeName(),fo.getTypeName()]),S;return Q("AddSessionAsContextHolder")?S=H(s.userNodePath)===g||H(s.tenantNodePath)===g||g==="session":S=H(s.userNodePath)===g||H(s.tenantNodePath)===g,k||S?(f.push({opType:c,updatedContextScope:k?d:[]}),!0):!1};this.cache.onItemChange(t,a.workflow.inputStage,function(l){var f;if(!a.suspendExecution){var c=[];for(var d of l){var p=y.getTypeNameFor(d);if(!(p===vt.getTypeName()&&!s.shouldTriggerOnAnnotationMetadataUpdated(d,a.workflow)&&!s.isAnnotationMetadataRejection(d))){var g=u(c,p,d.parentPath);if(!g&&Q("ContextHolderAsSelfContext"))for(var k of(f=d.items)!==null&&f!==void 0?f:[])k!=null&&k.id&&u(c,p,[].concat((0,_t.default)(d.parentPath),[k.id]))}}c.length>0&&a.invalidate(c)}})}},{key:"activateSingleItemWorkflow",value:function(t){var a=this;if(t.workflow.inputTypes)for(var s of t.workflow.inputTypes)this.cache.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution){var l=[];for(var f of u){var c=y.getTypeNameFor(f);for(var d of f.items)if(c===ke.getTypeName()||c===Pe.getTypeName()||c===Tn.getTypeName()||c===vt.getTypeName()&&a.shouldTriggerOnAnnotationMetadataUpdated(f,t.workflow)){var p=a.createInvalidationParam(t,c,f.parentPath,d);l.push(p)}}l.length>0&&t.invalidate(l)}}),this.statelessItemListeners.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution){var l=[];for(var f of u)for(var c of f.items){var d=a.createInvalidationParam(t,y.getTypeNameFor(f),f.parentPath,c);l.push(d)}l.length>0&&t.invalidate(l)}})}},{key:"activateDynamicTextWorkflow",value:function(t){var a=this;if(t.workflow.inputTypes)for(var s of t.workflow.inputTypes)this.cache.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution){var l=[];for(var f of u){var c=y.getTypeNameFor(f);for(var d of f.items)if(c===ke.getTypeName()||c===Pe.getTypeName()){var p=a.createInvalidationParam(t,c,f.parentPath,d);l.push(p)}}l.length>0&&t.invalidate(l)}})}},{key:"onTriggerSignalReceived",value:function(t,a,s){var u,l=y.getTypeNameFor(t);if(l===ke.getTypeName()||l===ot.getTypeName()){var f=a.body;if(!f)m.error(508044379,v.CoreDefault,`Attempted triggering of workflow ${s.workflow.id} by an object which is not a signal`);else if(Q("ImplementSignalWithPath")){var c=a.body;c.signalPath=(u=c.signalPath)!==null&&u!==void 0?u:[].concat((0,_t.default)(t.parentPath),[a.id]),a.sourceInfo&&(c.sourceInfo=a.sourceInfo),this.scheduleWorkflowExecution(s,[c])}else this.scheduleWorkflowExecution(s,[f])}}},{key:"isAnnotationMetadataRejection",value:function(t){var a;return((a=t==null?void 0:t.M_)===null||a===void 0?void 0:a.state)===Rt.Rejected}},{key:"activateReduceWorkflow",value:function(t){var a=this;if(en(t.workflow))for(var s of t.workflow.triggerSignals)this.cache.onItemChange(s,t.workflow.inputStage,function(f){if(!t.suspendExecution)for(var c of f)for(var d of c.items)a.onTriggerSignalReceived(c,d,t)}),this.statelessItemListeners.onItemChange(s,t.workflow.inputStage,function(f){if(!t.suspendExecution)for(var c of f)for(var d of c.items)a.onTriggerSignalReceived(c,d,t)});if(!en(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow)){var u=new Set(t.workflow.inputTypes);u.add(t.workflow.collectionScopeType);for(var l of u)this.cache.onItemChange(l,t.workflow.inputStage,function(f){if(!t.suspendExecution)for(var c of f){var d=y.getTypeNameFor(c);if(!(d===vt.getTypeName()&&!a.shouldTriggerOnAnnotationMetadataUpdated(c,t.workflow)&&!a.isAnnotationMetadataRejection(c)))for(var p of c.items){var g=a.createInvalidationParam(t,d,c.parentPath,p);t.invalidate([g])}}},!0)}}},{key:"activateJoinWorkflow",value:function(t){var a=this,s=new Set(t.workflow.inputTypes);s.add(t.workflow.collectionScopeType);for(var u of s)this.cache.onItemChange(u,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var f of l){var c=y.getTypeNameFor(f);if(!(c===vt.getTypeName()&&!a.shouldTriggerOnAnnotationMetadataUpdated(f,t.workflow)&&!a.isAnnotationMetadataRejection(f))&&c!==Ge.getTypeName())for(var d of f.items){var p=a.createInvalidationParam(t,c,f.parentPath,d);t.invalidate([p])}}},!0),this.statelessItemListeners.onItemChange(u,t.workflow.inputStage,function(l){if(!t.suspendExecution){var f=[];for(var c of l){var d=y.getTypeNameFor(c);if(d!==Ge.getTypeName())for(var p of c.items){var g=a.createInvalidationParam(t,d,c.parentPath,p);f.push(g)}}f.length>0&&t.invalidate(f)}})}},{key:"activateGenericWorkflow",value:function(t){var a=this;if(en(t.workflow))for(var s of t.workflow.triggerSignals)this.cache.onItemChange(s,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var f of l)for(var c of f.items)a.onTriggerSignalReceived(f,c,t)}),this.statelessItemListeners.onItemChange(s,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var f of l)for(var c of f.items)a.onTriggerSignalReceived(f,c,t)});if(!en(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow))for(var u of t.workflow.invalidationTypes||[])this.cache.onItemChange(u,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var f of l){var c=y.getTypeNameFor(f);if(!(c===vt.getTypeName()&&!a.shouldTriggerOnAnnotationMetadataUpdated(f,t.workflow)&&!a.isAnnotationMetadataRejection(f)))for(var d of f.items){var p=a.createInvalidationParam(t,c,f.parentPath,d);t.invalidate([p])}}})}},{key:"activateGridNeighborhoodWorkflow",value:function(t){this.activateReduceWorkflow(t)}},{key:"createInvalidationParam",value:function(t,a,s,u){var l=it(s,u);return{opType:a,item:l,isDeltaUpdate:!1}}},{key:"queueGridNeighborhoodWorkflow",value:function(t,a,s,u,l,f,c,d){throw new Error("NYI")}},{key:"queueWorkflow",value:function(t,a,s){var u=this;m.debug(537781760,v.CoreDefault,function(){return`Queuing Workflow. Queue Length: ${u.workflowQueue.length()} Running: ${u.workflowQueue.running()}`});var l=xl(),f=new Re({sessionHealthEventName:"QueueSessionWorkflow",resourceId:t.workflow.resourceId,success:!0,source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,message:"",affectedWorkflows:[t.workflow.resourceId]},this.clientMetadata).start(),c={cc:l,queueOp:f,registration:t,executionId:t.totalExecutionCount++,tasks:a};this.usesRefactoredDebouncing?(c.containsPrefilteredTasks=s,t.queueTask(c)):t.queueTaskOld(c)}},{key:"processPrefilterActionResults",value:function(t,a){var s,u=!1;for(var l of a.tasks)!l.prefilterActionResults||l.status===Xe.ExecutionCancelled||l.status===Xe.ResultsCancelled||(!((s=t.modelOptions)===null||s===void 0)&&s.includeItemOperations&&this.inputChangesManager.resetChanges(t.id,[].concat((0,_t.default)(l.scopeItem.parentPath),[l.scopeItem.id])),this.processAnnotationQueue(t,l.prefilterActionResults),u=!0);return u}},{key:"convertTaskToWorkflowInput",value:function(t,a){return{scopeItem:t.scopeItem,inputItems:t.inputItems,inputContext:t.inputContext,triggerSignals:t.triggerSignals,existingAnnotations:t.previousAnnotations,dynamicContext:t.dynamicContextItems,annotationActivationConfigs:this.getAnnotationActivationConfigs(a.outputTypes),requestedContexts:t.requestedContextsAndEvents}}},{key:"filterCancelledWorkflowTasks",value:function(t){if(this.usesRefactoredDebouncing){var a=[];for(var s of t.tasks)s.status!==Xe.ExecutionCancelled&&s.status!==Xe.ResultsCancelled&&(s.status=Xe.Running,a.push(s));return a}return t.tasks}},{key:"executeWorkflow",value:function(t,a){var s=this;Le(function(){var u=t.registration.workflow;if(s.isClosed){m.info(537781761,v.CoreDefault,`Session is closed - skipping execution of workflow ${u.id}`),a();return}var l=function(){a();for(var T of t.tasks)T.status!==Xe.ResultsCancelled&&T.status!==Xe.ExecutionCancelled&&(s.usesRefactoredDebouncing?s.workflowSynchronizationManager.notifyOnCompleted(T,t.registration.workflow.id):t.registration.onTaskCompleted(T))};if(t.tasks=s.filterCancelledWorkflowTasks(t),t.tasks.length===0){a();return}var f=t.queueOp.stop(),c=function(){m.info(536959061,v.CoreDefault,f)},d=f.durationMs;if(u.maxQueueWaitTimeMs&&d>u.maxQueueWaitTimeMs){m.info(536959062,v.CoreDefault,`Workflow ${u.id} queue wait time (${d}) exceeded specified maximum queue wait time (${u.maxQueueWaitTimeMs}) - skipping workflow execution`),l(),f.success=!1,f.dimension0="WorkflowExecutionCancelled",c();return}if(t.containsPrefilteredTasks){var p=s.processPrefilterActionResults(u,t);l(),f.dimension0=p?"Prefiltered:WithActionResults":"Prefiltered:NoActionResults",c();return}s.stats.workflowExecutions++,c(),t.tasks.some(function(C){return C.isTriggeredByEvents})&&(t.registration.lastTriggerByEventsTime=Date.now(),t.registration.eventCountSinceLastTrigger=0);var g=new Re({sessionHealthEventName:"ExecuteSessionWorkflow",resourceId:u.resourceId,source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,success:!0,message:"",affectedWorkflows:[u.resourceId]},s.clientMetadata).start(),k=function(T){g.stop(),T!==void 0&&T>0&&(g.durationMs-=T),g.success||s.stats.workflowExecutionErrors++,s.stats.workflowExecutionDurationMsMax=Math.max(g.durationMs,s.stats.workflowExecutionDurationMsMax),m.info(524339278,v.CoreDefault,g)},S=t.tasks.map(function(C){return s.convertTaskToWorkflowInput(C,u)}),x=function(T,I,_){var M;if(Q("AllowResultOperationToPassIsTriggeredBySyncDeltaProp")&&(!((M=T.triggerConditions)===null||M===void 0)&&M.some(function(b){return b===Ht.DeltaUpdate}))&&(I!=null&&I.length)){var A=_==null?void 0:_.some(function(b){var N;return(N=b.deltas)===null||N===void 0?void 0:N.some(function(z){var L=z;return!(L!=null&&L.content)&&(L==null?void 0:L.unit)===je.Sentence&&(L==null?void 0:L.deltaType)===he.Update})});A&&I.forEach(function(b){return b.isTriggeredBySyncDelta=!0})}};s.workflowClientCoordinator.executeWorkflow(u,S,function(C,T){var I,_;if(Q("StopWorkflowsOnClose")&&s.isClosed){l(),m.info(524339279,v.CoreDefault,`Session is closed - skipping processing results of workflow ${u.id}`);return}for(var M=[],A=0;A<S.length;A++){var b=t.tasks[A],N=(T==null?void 0:T.length)>A?T[A]:void 0;if(x(u,N==null?void 0:N.annotations,S[A].inputItems),g.success=!0,g.dimension0="",g.dimension1=String(N==null?void 0:N.ignoreExecution),g.dimension2="",g.joinContextId=(I=b.scopeItem.contextId)!==null&&I!==void 0?I:"",g.message="",g.resultDescription="",g.setReason(pe.Core),g.setSource(Te.Core),g.setImpact(Ie.MissingOutput),C)m.info(524339280,v.CoreDefault,`Failure during workflow ${u.id} execution ${C}`),g.success=!1,g.dimension0=ee[Tc(C.message)],g.resultDescription=C.stack,Es.has(C.message)&&Av(ee[C.message])?s.stats.workflowExecutionInfraErrors++:g.setReason(Es.has(C.message)&&ee[C.message]===ee.RequiredTokenNotAvailable?pe.Client:pe.Workflow);else if((T==null?void 0:T.length)!==S.length)g.success=!1,m.error(524339281,v.CoreDefault,`Workflow Inputs/Outputs length mismatch. Expected ${S.length}, Actual: ${T==null?void 0:T.length}`);else if(N.error)m.info(524339282,v.CoreDefault,`Failure during workflow ${u.id} execution ${N.error}`),g.success=!1,g.dimension0=ee[Tc(N.error)],g.resultDescription=N.error,g.setReason(pe.Workflow),N.isExpectedError&&(g.success=!0,g.dimension2="ExpectedFailure");else if(!N.ignoreExecution&&!N.annotations)m.info(524339283,v.CoreDefault,`Workflow ${u.id} is disabled - no error, no annotations`),g.dimension0=ee[ee.WorkflowDisabled];else if(!N.ignoreExecution&&!Array.isArray(N.annotations)){m.error(524339284,v.CoreDefault,"annotationQueue is not an array"),g.success=!1;var z=ee.WorkflowWrongAnnotationType;g.dimension0=ee[z],g.setReason(pe.Workflow)}if(Array.isArray(N==null?void 0:N.annotations)){var L=b.scopeItem||(b.inputItems&&b.inputItems.length===1?b.inputItems[0]:void 0),J=L?[].concat((0,_t.default)(L.parentPath),[L.id]):void 0;M.push({scopeItemPath:J,scopeItemRevId:L==null?void 0:L.revId,annotationQueue:N.annotations,source:yo.Workflow})}k(),s.emit("workflowFinished",{success:g.success,hadAnnotations:Array.isArray(N==null?void 0:N.annotations)&&(N==null?void 0:N.annotations.length)>0,queueIdle:s.workflowQueue.idle(),workflowId:t.registration.workflow.id,parentPath:b.scopeItem.parentPath,itemId:b.scopeItem.id}),!((_=u.modelOptions)===null||_===void 0)&&_.includeItemOperations&&!C&&!(N!=null&&N.error)&&!N.ignoreExecution&&s.inputChangesManager.resetChanges(u.id,[].concat((0,_t.default)(b.scopeItem.parentPath),[b.scopeItem.id]))}M.length>0&&s.processAnnotationQueue(u,M),l()})},t.cc)}},{key:"getAnnotationActivationConfigs",value:function(t){var a=[];for(var s of t||[]){var u=this.annotationActivationInfosByType.get(s),l=[];for(var f of u||[])f.config&&l.push(f.config);l.length>0&&a.push({annotationType:s,configs:l})}return a.length>0?a:void 0}},{key:"onTokenProvisionMessage",value:function(t,a){var s=new Re({sessionHealthEventName:"TokenProvision",success:!1,source:Te.Core,reason:pe.Client,impact:Ie.MissingInput,message:"",resourceId:"undefined",affectedWorkflows:["All"]},this.clientMetadata).start();{var u=a;a=function(f,c){s.success=!f&&!!c,(f==null?void 0:f.error)==="Unexpected server error."&&s.setReason(pe.Core),m.info(524027904,v.CoreDefault,s.stop()),u(f,c)}}this.downstreamMessageEndpoint?this.downstreamMessageEndpoint.sendMessage(t,a):a(void 0,new Fe)}},{key:"createSessionModelNodeIfNotExists",value:function(t,a,s){try{var u=this.cache.getItem([].concat((0,_t.default)(t),[a]));if(u){m.debug(536959063,v.CoreDefault,`Node ${a} already added in the cache`);return}}catch(f){if(f instanceof uo)m.debug(536959064,v.CoreDefault,`Node ${a} not found in the cache`);else throw f}var l=[new ke({parentPath:t,items:[s]})];try{this.cache.applyOperations(l,void 0),m.debug(536959066,v.CoreDefault,`Successfully added node ${a} in the cache`)}catch(f){throw m.error(536959065,v.CoreDefault,`Failed to add node ${a} to the cache.`),f}}},{key:"createUserNodeIfNotExists",value:function(){var t="user_userId",a=["session","user"];this.createSessionModelNodeIfNotExists(a,t,{id:t,body:new yr,source:dd}),this.userNodePath=[].concat(a,[t])}},{key:"createTenantNodeIfNotExists",value:function(){var t="tenant_userId",a=["session","user"];this.createSessionModelNodeIfNotExists(a,t,{id:t,body:new kr,source:dd}),this.tenantNodePath=[].concat(a,[t])}},{key:"createUserCommandsNodeIfNotExists",value:function(){var t="commands_userId",a=["session","user"];this.createSessionModelNodeIfNotExists(a,t,{id:t,body:new ki,source:dd}),this.userCommandsNodePath=[].concat(a,[t])}},{key:"workflowMeetsActivationConditions",value:function(t){var a=this,s="",u=!0,l=this.getActivationTierForCurrentSession(t);if(l===Sn.NeverActivate)return m.verbose(536959067,v.CoreDefault,function(){return`Workflow ${t.id} is disabled in ${a.clientMetadata.appName}/${a.clientMetadata.appPlatform}/${a.clientMetadata.releaseAudienceGroup}/${a.clientMetadata.tenantGroup} session`}),{meetsConditions:!1,waitingReasons:`["${Yo.WorkflowDisabled}"]`,isEnabledAndActivatedByClient:!1};this.isWorkflowWaitingForAnnotationActivation(t,l)&&(s+=`"${Yo.AnnotationActivation}"`,u=!1),this.isWaitingForFlight(t.activationFlightsConfigs)&&(s+=`${s.length===0?"":", "}"${Yo.Flight}"`),this.isWorkflowWaitingForSeedCompleted(t)&&(s+=`${s.length===0?"":", "}"${Yo.Seeding}"`);var f=s.length===0;return s="["+s+"]",{meetsConditions:f,waitingReasons:s,isEnabledAndActivatedByClient:u}}},{key:"isWorkflowWaitingForSeedCompleted",value:function(t){return t.inputStage&Ut.OnSeed&&this.isSeedingCompleted===!1}},{key:"isWorkflowWaitingForAnnotationActivation",value:function(t,a){if(a>=Tw.getValue()&&(!t.outputTypes||t.outputTypes.length===0))return t.activationConfigs.some(function(f){return f.activationTier===Sn.PreActivate})||m.warn(536959068,v.CoreDefault,`${t.id} with no outputs should be pre-activated.`),!0;if(a<Tw.getValue())return!1;var s=!1,u=!1;for(var l of t.outputTypes||[])if(s=this.annotationActivationInfosByType.has(l),s||(u=this.outputAnnotationsRequiredByDownstreamWorkflows.has(l),u))break;return!s&&!u}},{key:"matchesClientAppName",value:function(t){var a,s;if(t.clientAppName==="All")return!0;var u=(s=(a=this.clientMetadata)===null||a===void 0?void 0:a.appName)===null||s===void 0?void 0:s.toLowerCase();return u===void 0?!1:!!(t.clientAppName.toLowerCase()===u||t.clientAppName==="Fluid_*"&&u.startsWith("fluid_"))}},{key:"matchesClientTenantGroup",value:function(t){var a,s;return t==="All"||t===void 0||t.toLowerCase()===((s=(a=this.clientMetadata)===null||a===void 0?void 0:a.tenantGroup)===null||s===void 0?void 0:s.toLowerCase())}},{key:"getActivationTierForCurrentSession",value:function(t){var a,s,u,l,f=Sn.Default;for(var c of t.activationConfigs)this.matchesClientAppName(c)&&(c.clientAppPlatform==="All"||c.clientAppPlatform.toLowerCase()===((s=(a=this.clientMetadata)===null||a===void 0?void 0:a.appPlatform)===null||s===void 0?void 0:s.toLowerCase()))&&(c.clientReleaseAudienceGroup==="All"||c.clientReleaseAudienceGroup===void 0||c.clientReleaseAudienceGroup.toLowerCase()===((l=(u=this.clientMetadata)===null||u===void 0?void 0:u.releaseAudienceGroup)===null||l===void 0?void 0:l.toLowerCase()))&&this.matchesClientTenantGroup(c.clientTenantGroup)&&(f=c.activationTier);return f===Sn.PreActivate&&!wM.getValue().includes(t.id)&&(m.warn(536959069,v.CoreDefault,`Workflow ${t.id} is not allowed to preactivate`),f=Sn.Default),f}},{key:"isWaitingForFlight",value:function(t){var a=this;if(!t||t.length<=0)return!1;var s=this.clientMetadata.appName.toLowerCase().trim(),u=!1;for(var l of t){var f=l.clientAppName.toLowerCase().trim();if(f==="all"||f===s){if((!Array.isArray(l.requiredFlights)||l.requiredFlights.every(function(c){return a.isClientOnFlight(c)}))&&(!Array.isArray(l.restrictedFlights)||!l.restrictedFlights.some(function(c){return a.isClientOnFlight(c)})))return!1;u=!0}}return u}},{key:"isClientOnFlight",value:function(t){return this.clientMetadataFlightsSet.has(t.toLowerCase().trim())}},{key:"addWorkflowToDependencyMaps",value:function(t){var a,s,u,l,f,c,d;for(var p of(a=t.outputTypes)!==null&&a!==void 0?a:[]){var g=(s=this.workflowsByOutputAnnotation.get(p))!==null&&s!==void 0?s:new Set;g.add(t),this.workflowsByOutputAnnotation.set(p,g)}for(var k of(u=t.inputTypes)!==null&&u!==void 0?u:[]){var S=(l=this.workflowsByInputAnnotation.get(k))!==null&&l!==void 0?l:new Set;S.add(t),this.workflowsByInputAnnotation.set(k,S),this.workflowInputTypes.add(k)}for(var x of(f=t.triggerSignals)!==null&&f!==void 0?f:[])this.workflowInputTypes.add(x);t.collectionScopeType&&this.workflowInputTypes.add(t.collectionScopeType);for(var C of(c=t.requestedContextTypesRules)!==null&&c!==void 0?c:[])for(var T of C.contextTypes){var I=(d=this.workflowsByRequestedContextType.get(T))!==null&&d!==void 0?d:new Set;I.add(t),this.workflowsByRequestedContextType.set(T,I),this.workflowInputTypes.add(T)}}},{key:"getAllUpstreamInputTypesByAnnotationType",value:function(t){var a=this,s,u=new Set([t]);return(s=this.workflowsByOutputAnnotation.get(t))===null||s===void 0||s.forEach(function(l){var f,c,d,p=[].concat((0,_t.default)(a.workflowExecutionManager.getAllUpstreamWorkflowIds(l.id)),[l.id]);for(var g of p)(d=(c=(f=a.workflowRegistrationsByName.get(g))===null||f===void 0?void 0:f.workflow)===null||c===void 0?void 0:c.inputTypes)===null||d===void 0||d.forEach(function(k){return u.add(k)})}),u}},{key:"activateWaitingWorkflows",value:function(t){var a=new Re({sessionHealthEventName:"ActivateWaitingWorkflows",resourceId:t,success:!1,source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,message:"",affectedWorkflows:["All"]}).start();try{if(this.workflowsWaitingForActivation.size>0){m.info(536959070,v.CoreDefault,`Checking activation conditions for ${this.workflowsWaitingForActivation.size} waiting workflows`);for(var s of this.workflowsWaitingForActivation)this.tryActivateWorkflow(s)}a.success=!0}finally{a.stop();var u=function(){return a};a.durationMs>kM.getValue()||!a.success?m.info(536959071,v.CoreDefault,u):m.debug(536959072,v.CoreDefault,u)}}},{key:"tryActivateWorkflow",value:function(t){var a,s=new Re({sessionHealthEventName:"TryActivateWorkflow",source:Te.Core,reason:pe.Core,impact:Ie.MissingOutput,success:!0,message:'{"activated":true}',resourceId:t.workflow.resourceId,affectedWorkflows:[t.workflow.resourceId]},this.clientMetadata).start();try{var u=this.workflowMeetsActivationConditions(t.workflow),l=u.meetsConditions,f=u.waitingReasons,c=u.isEnabledAndActivatedByClient;if(!l){c?s.message=JSON.stringify({activated:!1,waitingReasons:f,requiredTokens:t.workflow.requiredTokenTypes}):s=void 0;return}m.info(536959073,v.CoreDefault,`Activating workflow ${t.workflow.id}`),t.invalidationFilter=$k(this.clientMetadata,t.workflow.id);var d=[];for(var p of(a=t.workflow.requestedContextTypesRules)!==null&&a!==void 0?a:[])!p.activationConditions||!this.isWaitingForFlight(p.activationConditions)?d.push(p):m.info(536959074,v.CoreDefault,`Condition for contexts '${JSON.stringify(p.contextTypes)}' is not fulfilled.`);this.workflowDefinitionManager.mergeWorkflowDefinition(t.workflow,{requestedContextTypesRules:d}),this.tryActivateUpstreamWorkflows(t.workflow),t.workflow.inputStage&~Ut.OnSeed&&this.activateWorkflowByType(t),this.tryScheduleWorkflowExecution(t),this.workflowsWaitingForActivation.delete(t)}catch(g){throw s&&(s.success=!1),g}finally{s&&m.info(536959075,v.CoreDefault,s.stop())}}},{key:"tryActivateUpstreamWorkflows",value:function(t){var a,s,u=this.workflowDefinitionManager.getWorkflowDefinition(t),l=u.requestedContextTypesRules,f=ir(l).map(function(k){var S=(0,Xo.default)(k,2),x=S[0],C=S[1];return x}),c=((a=t.inputTypes)!==null&&a!==void 0?a:[]).concat(f);for(var d of c){this.outputAnnotationsRequiredByDownstreamWorkflows.add(d);for(var p of(s=this.workflowsByOutputAnnotation.get(d))!==null&&s!==void 0?s:[]){var g=this.workflowRegistrationsByName.get(p.id);this.workflowsWaitingForActivation.has(g)&&this.tryActivateWorkflow(g)}}}},{key:"tryScheduleWorkflowExecution",value:function(t){var a,s,u=!1;if(((a=t.triggerSignalOpsQueue)===null||a===void 0?void 0:a.length)>0||en(t.workflow)){var l=t.workflow.kind!==U.SingleItem?this.cache.getSubtreeItems([],t.workflow.triggerSignals):void 0,f,c;if((l==null?void 0:l.length)>0?(m.info(536959104,v.CoreDefault,`Found trigger signal(s) in model for workflow: ${t.workflow.id}`),c=l.map(function(k){return k.body})):(c=[],((s=t.triggerSignalOpsQueue)===null||s===void 0?void 0:s.length)>0&&(m.info(536959105,v.CoreDefault,`Found ${t.triggerSignalOpsQueue.length} trigger signal(s) (first type: ${y.getTypeNameFor(t.triggerSignalOpsQueue[0].items[0].body)}) in cache for workflow: ${t.workflow.id}`),f=t.triggerSignalOpsQueue,c=f.map(function(k){return k.items[0].body}),t.triggerSignalOpsQueue=void 0)),t.workflow.kind===U.SingleItem){if((f==null?void 0:f.length)>0){var d=[];for(var p of f){var g=it(p.parentPath,p.items[0]);d.push({opType:y.getTypeNameFor(p),item:g})}d.length>0&&(t.invalidate(d),u=!0)}}else(c==null?void 0:c.length)>0&&(this.scheduleWorkflowExecution(t,c),u=!0)}!u&&t.workflow.inputStage&~Ut.PostSeed&&(!en(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow))&&this.scheduleWorkflowExecution(t)}},{key:"scheduleWorkflowExecution",value:function(t,a){t.invalidate([{triggerSignals:a}])}},{key:"isWorkflowTriggeredByNonExclusiveSignals",value:function(t){return Q("EnableNonExclusiveTriggerSignals")&&wa(t)}}]),e}(bw.EventEmitter);var xM=new G("prefiltersEvaluationMinDurationInMs",1),TM=new G("disabledPrefiltersForWorkflows",[]);function gd(n){return{shouldExecuteWorkflow:n}}var Ys=Symbol("lambdaEvaluator"),Nw=Symbol("isDisabled"),Dw=function(){function n(o){(0,hd.default)(this,n),this.overwrittenSettingsMap=o}return(0,md.default)(n,[{key:"getValue",value:function(e,r){var t;return this.settings.has(e)?t=this.settings.get(e):(t=new G(e,r),this.settings.set(e,t)),t.getValue()}},{key:"settings",get:function(){var e;return(e=this.overwrittenSettingsMap)!==null&&e!==void 0?e:n.settingsMap}}]),n}();Dw.settingsMap=new Map;var Ft;(function(n){n[n.All=0]="All",n[n.WithActionDefinition=1]="WithActionDefinition",n[n.WithoutActionDefinition=2]="WithoutActionDefinition"})(Ft||(Ft={}));var qk=function(){function n(o){(0,hd.default)(this,n),this.workflowSettings=o!=null?o:new Dw}return(0,md.default)(n,[{key:"evaluateWorkflowPrefilters",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ft.All;if(e.prefilters===void 0||e.prefilters.length===0||TM.getValue().includes(e.id))return gd(!0);var a,s=new E({operationName:"EvaluateWorkflowPrefilters",resourceId:e.id,success:!0}).start();V().startSync(Z.EvaulatePrefilters);try{for(a of e.prefilters)if(a!==void 0&&!(t===Ft.WithActionDefinition&&!a.action)&&!(t===Ft.WithoutActionDefinition&&a.action)){var u=this.evaluate(e,a,r);if(!u){var l={shouldExecuteWorkflow:!1,prefilterActionResults:this.createWorkflowResult(a.action,r)};return this.logOperation(s,a),l}}return this.logOperation(s),gd(!0)}catch(f){return this.logOperation(s,a,f),gd(!0)}}},{key:"evaluate",value:function(e,r,t){switch(r.type){case on.Input:case on.Delta:return this.evaluateLambdaPrefilter(e,r,t);case on.MaxInputCount:return this.evaluateMaxCountPrefilter(r,t);case on.UILanguage:return this.evaluateSupportedLanguagesPrefilter(r,t);default:throw Error(`Unknown prefilter type ${r.type}.`)}}},{key:"evaluateMaxCountPrefilter",value:function(e,r){var t;if(e.maxCount===void 0&&e.setting===void 0)throw new Error(`Prefilter ${e.type} is invalid.`);if(e.maxCount!==void 0&&e.setting!==void 0)throw new Error(`Prefilter ${e.type} is invalid.`);var a=(t=e.maxCount)!==null&&t!==void 0?t:this.workflowSettings.getValue(e.setting.name,e.setting.defaultValue);return r.inputItems.length<=a}},{key:"evaluateSupportedLanguagesPrefilter",value:function(e,r){var t;if((e.languages===void 0||e.languages.length==0)&&e.setting===void 0)throw new Error(`Prefilter ${e.type} is invalid.`);if(e.languages!==void 0&&e.setting!==void 0)throw new Error(`Prefilter ${e.type} is invalid.`);var a=(t=e.languages)!==null&&t!==void 0?t:this.workflowSettings.getValue(e.setting.name,e.setting.defaultValue);return a.some(function(s){var u,l;return s.toLowerCase()===((l=(u=r.clientMetadata)===null||u===void 0?void 0:u.uiLanguage)===null||l===void 0?void 0:l.toLowerCase())})}},{key:"evaluateLambdaPrefilter",value:function(e,r,t){try{if(r[Nw]===!0)return!0;var a=this.getLambdaEvaluator(r,e.kind);return a.evaluate(t)}catch(s){return r[Nw]=!0,m.error(537781762,v.CoreDefault,function(){return`Workflow ${e.id} ${r.type} prefilter error ${s.message}. Lambda: ${r.predicateLambda.substring(0,20)}...Stack: ${s.stack}.`}),!0}}},{key:"getLambdaEvaluator",value:function(e,r){if(e[Ys])return e[Ys];this.ensureWorkflowKindIsSupported(r,e.type,[U.SingleItem]);var t=e.predicateLambda;switch(e.type){case on.Input:return e[Ys]=new ck(t);case on.Delta:return e[Ys]=new dk(t);default:throw Error(`Unknown lambda prefilter type ${e.type}.`)}}},{key:"createWorkflowResult",value:function(e,r){if(e!==void 0){var t={scopeItemPath:[].concat((0,Zs.default)(r.scopeItem.parentPath),[r.scopeItem.id]),scopeItemRevId:r.scopeItem.revId,annotationQueue:void 0,source:yo.PrefilterManager};switch(e.type){case Eo.SetPredefinedAnnotation:{var a=e,s=this.createPredefinedAnnotationEntry(a,r);t.annotationQueue=[s];break}case Eo.ClearAnnotations:{var u=e;t.annotationQueue=this.createClearAnnotationsQueue(u,r);break}default:throw new Error(`Prefilter action type ${e.type} is not supported.`)}return[t]}}},{key:"createPredefinedAnnotationEntry",value:function(e,r){return{path:[].concat((0,Zs.default)(r.scopeItem.parentPath),[r.scopeItem.id]),revId:r.scopeItem.revId,annotationType:e.annotationType,annotations:[e.annotation],areApologies:!1}}},{key:"createClearAnnotationsQueue",value:function(e,r){var t=[];for(var a of e.annotationTypes)t.push({path:[].concat((0,Zs.default)(r.scopeItem.parentPath),[r.scopeItem.id]),revId:r.scopeItem.revId,annotationType:a,annotations:[],areApologies:!1});return t}},{key:"logOperation",value:function(e,r,t){e.stop(),V().stop(Z.EvaulatePrefilters);var a=function(){var u;if(!t&&r){e.success=!0,e.dimension0=(!1).toString(),e.dimension1=(u=r.action)===null||u===void 0?void 0:u.type;var l=r.action?`${r.action.type} action`:"no action";e.resultDescription=`${r.type} prefilter triggered ${l}.`}else!t&&!r?(e.success=!0,e.dimension0=(!0).toString(),e.resultDescription="All prefilters evaluated to true."):t&&r?(e.success=!1,e.dimension0=(!0).toString(),e.resultDescription=`${r.type} prefilter error: ${t.message}, stack: ${t.stack}.`):(e.success=!1,e.dimension0=(!0).toString(),e.resultDescription=`Error: ${t.message}, stack: ${t.stack}.`);return e};!t&&e.durationMs<xM.getValue()?m.debug(525448961,v.CoreDefault,a):m.info(537781763,v.CoreDefault,a)}},{key:"ensureWorkflowKindIsSupported",value:function(e,r,t){if(!t.includes(e))throw new Error(`${r} prefilter is not supported for ${U[e]} workflow.`)}}]),n}();h();var $w=w(at()),Gw=w(R()),Uw=w(B()),Hw=w(Se());h();var Lw=w(R()),Fw=w(B());h();var Rw=w(Se());h();function Pw(n,o){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r={firstDiffLeft:0,firstDiffRight:o.length},t,a;return n.length<o.length?(t=n,a=o):(t=o,a=n),a.indexOf(t)===0?(r.firstDiffLeft=t.length,r.firstDiffRight=0):a.endsWith(t)?(r.firstDiffLeft=0,r.firstDiffRight=t.length):(r=_M(n,o,e),r.firstDiffLeft+r.firstDiffRight>t.length&&(r.firstDiffRight=t.length-r.firstDiffLeft)),IM(r,n,o),r}function IM(n,o,e){if(n.firstDiffLeft>0){var r=n.firstDiffLeft<o.length&&tu(o,n.firstDiffLeft),t=n.firstDiffLeft<e.length&&tu(e,n.firstDiffLeft);(r||t)&&(n.firstDiffLeft-=1)}if(n.firstDiffRight>1){var a=n.firstDiffRight<o.length&&tu(o,o.length-n.firstDiffRight),s=n.firstDiffRight<e.length&&tu(e,e.length-n.firstDiffRight);(a||s)&&(n.firstDiffRight-=1)}}function _M(n,o){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,r={firstDiffLeft:0,firstDiffRight:o.length},t;for(t=0;t<n.length&&t<o.length;t+=1){var a=n.charCodeAt(t),s=o.charCodeAt(t);if(a!==s&&!(eu(a,e)&&eu(s,e)))break}for(r.firstDiffLeft=t,t=0;t<n.length&&t<o.length;t+=1){var u=n.charCodeAt(n.length-t-1),l=o.charCodeAt(o.length-t-1);if(u!==l&&!(eu(u,e)&&eu(l,e)))break}return r.firstDiffRight=t,r}function eu(n){var o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;switch(n){case 12288:case 8197:case 32:case 11:case 9:case 160:return!0;case 13:case 10:case 65532:return!o}return!1}function tu(n,o){return n.charCodeAt(o)>=56320&&n.charCodeAt(o)<=57343}var nu=w(ji()),Zo=/[ \u00a0\u2000-\u200a\u202f\u205f\u3000\t]/g,_a=/[.!?]/g;function Bw(n,o){var e=[],r=Ow(n,o);return r&&e.push(r),e}function Ww(n,o){var e=[],r=Ow(n,o);r&&e.push(r);var t=AM(n,o,r);t&&e.push(t);var a=MM(n,o,r);a&&e.push(a);var s=bM(n,o);return s&&e.push(s),e}function Ow(n,o){var e=n.content,r=o.content,t=Pw(e,r),a=t.firstDiffLeft,s=e.length-t.firstDiffRight,u=r.length-t.firstDiffRight,l=he.Update,f=void 0;if(e.length!==r.length)s===a?(l=he.Add,f=e[e.length-1]):u===a&&(l=he.Delete,f=r[r.length-1]);else if(e===r)return;var c=0,d;switch(l){case he.Update:c=s-a,d=r.substring(a,u);break;case he.Add:d=r.substring(a,u);break;case he.Delete:c=s-a,d=e.substring(a,s);break}var p=NM(d,f);if(p!==void 0)return new hn({content:l!==he.Delete?d:void 0,deltaType:l,unit:p,position:a,length:l!==he.Add?c:0})}function AM(n,o,e){var r,t,a,s,u,l,f=n,c=o;if(!((f==null?void 0:f.ipPosition)===(c==null?void 0:c.ipPosition)&&(f==null?void 0:f.isColdIp)===(c==null?void 0:c.isColdIp))){if((f==null?void 0:f.isColdIp)===(c==null?void 0:c.isColdIp)&&e){if(e.deltaType===he.Add){if((c==null?void 0:c.ipPosition)===((r=e.position)!==null&&r!==void 0?r:0)+((t=e.length)!==null&&t!==void 0?t:0))return}else if(e.deltaType===he.Update){if((c==null?void 0:c.ipPosition)===((a=e.position)!==null&&a!==void 0?a:0)+((u=(s=e.content)===null||s===void 0?void 0:s.length)!==null&&u!==void 0?u:0))return}else if(e.deltaType===he.Delete&&(c==null?void 0:c.ipPosition)===((l=e.position)!==null&&l!==void 0?l:0))return}return new hn({deltaType:he.CursorUpdate,cursorData:{ipPosition:c==null?void 0:c.ipPosition,isColdIp:c==null?void 0:c.isColdIp}})}}function MM(n,o,e){var r,t,a,s,u,l,f,c=n,d=o;if(((r=d.formattedRanges)===null||r===void 0?void 0:r.length)<=((t=c.formattedRanges)===null||t===void 0?void 0:t.length)){if(e){var p=c.formattedRanges?(0,Rw.default)(c.formattedRanges):[],g=EM(c.formattedRanges,e,e.position),k=g?p.indexOf(g):-1;if(k!==-1&&(e.position+(e.length||0)>g.start+g.length?g.length=e.position+((a=e.content)!==null&&a!==void 0?a:"").length-g.start:g.length+=((s=e.content)!==null&&s!==void 0?s:"").length-(e.length||0),p[k]=g),p.length>0){for(var S of p.slice(k+1))S.start<e.position||(e.position+(e.length||0)>S.start?(S.length=S.start+S.length-(e.position+(e.length||0)),S.start=e.position+((u=e.content)!==null&&u!==void 0?u:"").length):S.start+=((l=e.content)!==null&&l!==void 0?l:"").length-(e.length||0));p=p.filter(function(C){return C.length>0})}var x=(f=d==null?void 0:d.formattedRanges)!==null&&f!==void 0?f:[];if((0,nu.default)(p,x)||p.length===0&&x.length===0)return}else if((0,nu.default)(c==null?void 0:c.formattedRanges,d==null?void 0:d.formattedRanges))return}return new hn({deltaType:he.FormattingUpdate,formattedRanges:d==null?void 0:d.formattedRanges})}function bM(n,o){var e=n,r=o,t,a={},s=!1;for(t in r)["ipPosition","isColdIp","content","formattedRanges"].indexOf(t)===-1&&((0,nu.default)(r[t],e[t])||(s=!0,a[t]=r[t]));if(s)return new hn({deltaType:he.OtherNonContentUpdate,otherNonContentData:a})}function EM(n,o,e){if(n){if(o.deltaType===he.Add){var r=n.find(function(a){return a.start===e&&a.length===0});if(r)return r;e=Math.max(e-1,0)}var t=n.find(function(a){return a.length===0?a.start===e:a.start<=e&&e<a.start+a.length});return t}}function NM(n,o){var e=Array.from(n.matchAll(Zo));if(Zo.lastIndex=0,e.length===0)return je.Chars;if(e.length===1){if(e[0].index===0)return o&&_a.test(o)?je.Sentence:o&&!Zo.test(o)?je.Word:je.Chars;if(e[0].index+1===n.length)return _a.test(n[e[0].index-1])?je.Sentence:Zo.test(n[e[0].index-1])?je.Chars:je.Word;if(n[e[0].index-1]){var r=n[e[0].index-1];if(_a.test(r))return je.Sentence;if(Zo.test(r))return je.Chars}return je.Word}var t=Array.from(n.matchAll(_a));if(_a.lastIndex=0,t.length===0)return je.PartialSentence;if(t.length>1)return je.Paragraph;if(t[0].index+1<=n.length)return Zo.test(n[t[0].index+1])?je.Sentence:je.Paragraph}var qw=function(){function n(){(0,Lw.default)(this,n),this.deltaBuilderHandlers=new Map,this.registerDeltaBuilderHandler(et.getTypeName(),Bw),this.registerDeltaBuilderHandler(ht.getTypeName(),Ww)}return(0,Fw.default)(n,[{key:"registerDeltaBuilderHandler",value:function(e,r){this.deltaBuilderHandlers.set(e,r)}},{key:"executeDeltaBuilderHandler",value:function(e,r,t){var a=this.deltaBuilderHandlers.get(e);return a?a(r,t):[]}}]),n}();var yd="\\",vd=function(o,e){return e?kd([].concat((0,Hw.default)(e),[o])):o},kd=function(o){return o.join(yd)},zw=function(){function n(o){var e=this;(0,Gw.default)(this,n),this.createTextTileDeltasFromItem=function(r,t){var a,s=new E({operationName:"CreateTextTileDeltaFromItem",success:!0}).start();try{if(!r){s.success=!1,s.resultDescription="Unable to create text tile delta, parent item is undefined",m.info(524883085,v.CoreDefault,s.stop());return}if(!r.body){s.success=!1,s.resultDescription="Unable to create text tile delta, parent item has undefined body",m.info(524883086,v.CoreDefault,s.stop());return}var u=r.body;if(!et.typeGuard(u)){s.success=!1,s.resultDescription=`Unable to create text tile delta, parent item body is not proper type: expected ${et.getTypeName()}, received ${y.getTypeNameFor(u)}`;return}var l=vd(r.id,t),f=(a=e.lastSeenTileByTileId.get(l))!==null&&a!==void 0?a:new et({content:""}),c=e.createDeltas(f,u);return!c||c.length===0?(s.dimension0="0",s.resultDescription="No delta differences found"):(s.dimension0=c.length.toString(),e.lastSeenTileByTileId.set(l,u)),m.info(524883087,v.CoreDefault,s.stop()),c}catch(d){s.success=!1,s.resultDescription=`Error creating text tile delta: ${d}`,m.info(524883088,v.CoreDefault,s.stop());return}},this.lastSeenTileByTileId=o!=null?o:new Map,this.deltaBuilder=new qw}return(0,Uw.default)(n,[{key:"addItemToLocalMap",value:function(e,r){var t=vd(e.id,r),a=e.body;et.typeGuard(a)&&!this.lastSeenTileByTileId.has(t)&&this.lastSeenTileByTileId.set(t,a)}},{key:"deleteItemFromLocalMap",value:function(e,r){var t=vd(e.id,r);this.lastSeenTileByTileId.has(t)&&this.lastSeenTileByTileId.delete(t)}},{key:"moveItemsInLocalMap",value:function(e,r,t){var a=new Set(t),s=kd(r),u=kd(e),l=[],f=function(T,I){return T.length>I.length?T.substring(I.length+yd.length).split(yd)[0]:void 0};for(var c of this.lastSeenTileByTileId){var d=(0,$w.default)(c,2),p=d[0],g=d[1];if(p.startsWith(s)){var k=f(p,s);if(k===void 0||a.has(k)){var S=p.replace(s,u);l.push({item:g,newPathKey:S,prevPathKey:p})}}}for(var x of l)this.lastSeenTileByTileId.delete(x.prevPathKey),this.lastSeenTileByTileId.set(x.newPathKey,x.item)}},{key:"createDeltas",value:function(e,r){return this.deltaBuilder.executeDeltaBuilderHandler(y.getTypeNameFor(r),e,r)}}]),n}();h();var Vw=w(us());var DM=function(n,o,e,r){function t(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(c){try{f(r.next(c))}catch(d){s(d)}}function l(c){try{f(r.throw(c))}catch(d){s(d)}}function f(c){c.done?a(c.value):t(c.value).then(u,l)}f((r=r.apply(n,o||[])).next())})};function Qw(n,o){return DM(this,void 0,void 0,function*(){var e=n.authToken,r=n.origin,t=n.sessionUrl,a=o.body,s=o.cv,u=o.method,l=o.requestUrl,f=yield(0,Vw.fetch)(l||t,{method:u,headers:Object.assign({Authorization:`Bearer ${e}`,"x-origin":r,"x-correlationid":s},o.headers),body:a});if(f.status!==200)throw new Error(`Unexpected status code: ${f.status}`);return f})}var Jw=function(o,e){e?(o.resultDescription=e,o.success=!1,m.error(507646878,v.CoreDefault,o.stop())):m.info(507646877,v.CoreDefault,o.stop())};function wd(n,o,e,r){var t;Qw(n,{headers:{"Content-Type":"application/jsond"},body:dn.serialize(o),cv:e.cv,method:"POST"}).then(function(a){return a.json()}).catch(function(a){t=new Y({messageId:o.messageId,error:a.message})}).then(function(a){Jw(e,t?t.error:void 0),r(t,a)})}function Sd(n,o,e,r){var t=n.sessionUrl,a;Qw(n,{cv:r.cv,method:"GET",requestUrl:o.refType===xo.AlCodedLocation?`${t}/blob/${o.value}`:o.value}).then(function(s){return s.arrayBuffer()}).then(function(s){return new Uint8Array(s)}).catch(function(s){a=s}).then(function(s){Jw(r,a?a.message:void 0),e(a,s)})}h();var jw=w(R()),Kw=w(B()),Xw=w(ze()),Yw=w(Ve()),Cd=w(Oe());var Zw=w(Rn());function PM(n){var o=RM();return function(){var r=(0,Cd.default)(n),t;if(o){var a=(0,Cd.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,Yw.default)(this,t)}}function RM(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Mr=function(n){(0,Xw.default)(e,n);var o=PM(e);function e(){return(0,jw.default)(this,e),o.apply(this,arguments)}return(0,Kw.default)(e,[{key:"init",value:function(){return Promise.resolve()}},{key:"sendMessage",value:function(t,a,s){}},{key:"onMessage",value:function(t,a){}},{key:"forceReconnect",value:function(){return Promise.resolve()}},{key:"closeSession",value:function(){}},{key:"sendBytes",value:function(t){}},{key:"getCorrelationVector",value:function(){return new Qe}},{key:"setState",value:function(t){}}]),e}(Zw.EventEmitter);var BM=function(n,o,e,r){function t(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(c){try{f(r.next(c))}catch(d){s(d)}}function l(c){try{f(r.throw(c))}catch(d){s(d)}}function f(c){c.done?a(c.value):t(c.value).then(u,l)}f((r=r.apply(n,o||[])).next())})},WM=10,OM=function(o){if(o===pt.Substrate)return Vn.Substrate},tn;(function(n){n[n.LocalWorkflow=0]="LocalWorkflow",n[n.ServerWorkflow=1]="ServerWorkflow",n[n.Submitted=2]="Submitted"})(tn||(tn={}));var Er;(function(n){n[n.Internal=0]="Internal",n[n.External=1]="External"})(Er||(Er={}));var cr=function(o,e){e?(o.resultDescription=e,o.success=!1,m.error(509203144,v.CoreDefault,o.stop())):m.info(509203143,v.CoreDefault,o.stop())},eS=function(o){return!o.items.some(function(e){return e.source&&e.source.indexOf("ThirdParty")===0})},Aa=function(){function n(o){(0,tS.default)(this,n);var e;this.annotationActivationTrackers=new Map,this.annotationCallbacks=new Map,this.annotationResultStates=new Map,this.tokensByAnnotationType=new Map,this.registeredContextTypes=new Set,this.availableContexts=new Map,this.nextSyncSequenceId=1,this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.hasSessionConnected=!1,this.isSessionClosed=!1,this.serverAuthenticationState=ut.NotAuthenticated,this.sessionCloseCallbacks=new Map,this.connectCallbacks=new Map,this.reconnectCallbacks=new Map,this.disconnectCallbacks=new Map,this.sessionStateCallbackToken=0,this.workflowGraph=new Js,this.workflowDefinitionManager=new Fs,this.contextIdManager=new Lt(Ho.JsClient,this.workflowGraph),this.workflowItemStorage=new Qs(this.workflowDefinitionManager),this.pendingConnectCallbacks=[],this.onAnnotationsSubmittedEnabled=!1,this.reduceBatchOperationsEnabled=!1,this.batchMessagesEnabled=!1,this.cachedClaimsChallenge={claimsVersion:0,actionRequired:!1},this.tokenMessageVersion=1,this.hostCallbacks=o.hostCallbacks,this.sessionManager=o.sessionManager,this.batchMessagesEnabled=o.batchMessagesEnabled||!1,this.reduceBatchOperationsEnabled=o.reduceBatchOperationsEnabled||!1,this.operationBatchConfig=o.batchOptions?this.getOperationBatchConfig(o.batchOptions):void 0,this.extensionConfigs=o.extensionConfigs,this.clientMetadata=o.clientMetadata,this.userContext=o.userContext,this.localWorkflowManager=o.localWorkflowManager,this.annotationResultsProcessor=o.annotationResultsProcessor,o.workflowRuntimeFactory&&(this.workflowRuntime=o.workflowRuntimeFactory(this.sessionManager)),this.localRegisteredWorkflows=o.localRegisteredWorkflows||[],this.enableRemoteExecutionNotification=o.enableRemoteExecutionNotification||!1,this.networkMode=o.networkMode,this.egress=o.egress,this.serverAuthenticationStateChangeCallback=[],this.claimsChallengeCallback=[],this.onAnnotationsSubmittedEnabled=o.onAnnotationsSubmittedEnabled||!1,this.sessionManager.on("sessionClose",this.onSessionClose.bind(this)),this.sessionManager.on("reconnect",this.onReconnect.bind(this)),this.sessionManager.on("connect",this.onConnect.bind(this)),this.sessionManager.on("disconnect",this.onDisconnect.bind(this)),this.sessionManager.on("resetNextSyncSequenceId",this.resetNextSyncSequenceId.bind(this)),this.sessionManager.on("serverAuthenticationStateChange",this.onServerAuthenticationStateChange.bind(this)),this.sessionManager.onMessage(Nt.getTypeName(),this.workflowRuntime?this.onAnnotationResultsFromLocal.bind(this):this.onAnnotationResultsFromServer.bind(this)),this.sessionManager.onMessage(Jr.getTypeName(),this.onAnnotationResultStateMessage.bind(this)),this.sessionManager.onMessage(Zr.getTypeName(),this.onWorkflowExecutionCompleteMessage.bind(this)),this.sessionManager.onMessage(Vi.getTypeName(),this.onClaimsChallengeMessage.bind(this)),o.isDeltaGeneratorEnabled&&(this.enableSyncDeltaSending=!o.disableSyncDeltaSending,this.syncDeltaTimeout=(e=o.syncDeltaTimeout)!==null&&e!==void 0?e:700,this.enableDeltaGenerator()),this.setServerAuthenticationStateChangeCallback(this.updateGraphOnAuthStateChange.bind(this)),this.setClaimsChallengeCallback(this.requestAuthTokenWithClaims.bind(this))}return(0,nS.default)(n,[{key:"getSessionReconnectParams",value:function(){if(!this.connectParams)throw new Error("Session has not been established yet.");return{sessionUrl:this.connectParams.sessionUrl,origin:this.connectParams.origin,authToken:this.connectParams.authToken,nextSyncSequenceId:this.nextSyncSequenceId}}},{key:"setNextSequenceId",value:function(e){this.nextSyncSequenceId=e}},{key:"tryGetDocSessionId",value:function(){if(!(!this.clientMetadata||!this.clientMetadata.docSessionId))return this.clientMetadata.docSessionId}},{key:"getSessionStateCallbackToken",value:function(e){var r;return e+"-callback-"+((r=this.tryGetDocSessionId())!==null&&r!==void 0?r:"unknown")+"-"+this.sessionStateCallbackToken++}},{key:"updateGraphOnAuthStateChange",value:function(e){this.tryActivateWorkflows()}},{key:"tryActivateWorkflows",value:function(){var e=this;if(this.enableRemoteExecutionNotification){var r=new E({operationName:"GraphServerWorkflowActivation",success:!0}).setClientMetadata(this.clientMetadata).start(),t=[];this.workflowGraph.getWorkflowNodes().filter(function(a){return a.location===fr.External}).forEach(function(a){e.localWorkflowManager.canActivateWorkflow(a,e)?a.isActivated=!0:(e.localWorkflowManager.deactivateServerWorkflow(a,e),t.push(a.workflow.id))}),r.resultDescription=`deactivated workflows: [${t.join()}]`,m.info(508879493,v.CoreDefault,r.stop())}}},{key:"initialize",value:function(){var e=this;return this.localWorkflowManager&&this.localWorkflowManager.addSession(this),this.registerLocalWorkflowsWithoutGraphInit(this.localRegisteredWorkflows),this.sessionManager.init(this.extensionConfigs,this.hostCallbacks.onInitSession?this.hostCallbacks.onInitSession:void 0,this.egress).then(function(){return e.localWorkflowManager&&e.localWorkflowManager.setTokenCallback(e.getAuthToken.bind(e)),e})}},{key:"isLocalWorkflowRegistered",value:function(e){var r=this.getLocalRegisteredWorkflows();return r.some(function(t){return e===t.id})}},{key:"isConnected",get:function(){return!!this.connectParams}},{key:"hasConnected",get:function(){return this.hasSessionConnected}},{key:"isClosed",get:function(){return this.isSessionClosed}},{key:"getServerAuthenticationState",value:function(){return this.serverAuthenticationState}},{key:"getContextIdManager",value:function(){return this.contextIdManager}},{key:"getWorkflowItemStorage",value:function(){return this.workflowItemStorage}},{key:"getWorkflowDefinition",value:function(e,r){return this.workflowDefinitionManager.getWorkflowDefinition(e,r)}},{key:"registerLocalWorkflows",value:function(e){this.registerLocalWorkflowsWithoutGraphInit(e),this.trySendWorkflowGraphInitMessage()}},{key:"registerLocalWorkflowsWithoutGraphInit",value:function(e){if(e.length){if(this.workflowRuntime)for(var r of e)this.workflowRuntime.registerWorkflow(r),this.sendMessageToSession(new to({workflowDefinition:r}));if(this.localWorkflowManager)for(var t of e)this.localWorkflowManager.registerLocalWorkflow(t,this)}}},{key:"registerLocalWorkflow",value:function(e){this.registerLocalWorkflows([e]);var r=new E({operationName:"SessionRegisterLocalWorkflow",resourceId:e.id,success:!0}).setClientMetadata(this.clientMetadata).start();cr(r)}},{key:"activateAnnotation",value:function(e,r,t){var a,s=new rf(this.sendMessageToSession.bind(this),e,r);if(r&&r.callback){var u=this.annotationCallbacks.get(e);u||(u=new Map,this.annotationCallbacks.set(e,u)),u.set(s.token,r.callback)}var l=(a=this.tokensByAnnotationType.get(e))!==null&&a!==void 0?a:[];return l.indexOf(s.token)===-1&&l.push(s.token),this.tokensByAnnotationType.set(e,l),this.annotationActivationTrackers.set(s.token,s),this.activateAnnotationForTracker(s,{ignoreExistingAnnotations:!1,sendOnlyIfConnected:!1})}},{key:"activateAnnotationForTracker",value:function(e,r){var t=new E({operationName:"ActivateAnnotation",resourceId:e.annotationType,success:!0}).setClientMetadata(this.clientMetadata).start();return e.activate(r.ignoreExistingAnnotations,r.sendOnlyIfConnected).then(function(a){return t.resultSignature="Ok",t.resultDescription=`Activated annotation ${e.annotationType} with token ${e.token}; sendOnlyIfConnected: ${r.sendOnlyIfConnected}`,cr(t),a}).catch(function(a){throw cr(t,`error on activate annotation type ${e.annotationType}: ${a}; sendOnlyIfConnected: ${r.sendOnlyIfConnected}`),a})}},{key:"updateAnnotationConfig",value:function(e,r){var t=new Xr({token:e,config:r});this.sendMessageToSession(t);var a=this.annotationActivationTrackers.get(e);a&&a.options&&(a.options.config=r)}},{key:"releaseAnnotation",value:function(e){var r=this.annotationActivationTrackers.get(e);if(r){this.annotationActivationTrackers.delete(e);var t=this.annotationCallbacks.get(r.annotationType);return t&&(t.delete(e),t.size==0&&this.annotationCallbacks.delete(r.annotationType)),r.release()}return Promise.resolve(!1)}},{key:"setAnnotationState",value:function(e,r,t){var a={state:t};this.submitOperation(new vt({parentPath:e,items:[{id:r}],M_:a}))}},{key:"setAnnotationMetadata",value:function(e,r,t){this.submitOperation(new vt({parentPath:e,items:[{id:r}],M_:t}))}},{key:"submitOperation",value:function(e,r){this.submitOperations([e],r)}},{key:"submitOperations",value:function(e,r){var t,a;if(r||(r=this.generateCorrelationId()),this.contextIdManager.applyContextIdOnOperations(e),this.updateWorkflowExecutionStates(e),!this.onAnnotationsSubmittedEnabled){var s=this.partitionAnnotationOperations(e),u=(0,br.default)(s,2),l=u[0],f=u[1];this.executeCallbacksOnAnnotationSubmitted(l,r)}var c=e.filter(this.filterOperationsForSession.bind(this)).filter(eS);if(this.workflowRuntime){if(this.onAnnotationsSubmittedEnabled){var d=this.partitionAnnotationOperations(c),p=(0,br.default)(d,2),g=p[0],k=p[1];this.onAnnotationsSubmitted(g,r),this.submitOperationsToSession(k,r)}else this.submitOperationsToSession(c,r);return}var S=[];if(this.deltaGenerator){var x=new E({operationName:"ExecuteDeltaGenerator",success:!0}).setClientMetadata(this.clientMetadata).start();for(var C of c)if(Pe.typeGuard(C))S.push.apply(S,(0,ko.default)(this.createDeltasFromUpdateOperation(C)));else{var T=C;for(var I of T.items)ke.typeGuard(C)?this.deltaGenerator.addItemToLocalMap(I,T.parentPath):Ge.typeGuard(C)?this.deltaGenerator.deleteItemFromLocalMap(I,T.parentPath):kn.typeGuard(C)&&this.deltaGenerator.moveItemsInLocalMap(C.parentPath,C.prevParentPath,(a=(t=C.items)===null||t===void 0?void 0:t.map(function(N){return N.id}))!==null&&a!==void 0?a:[]);S.push(C)}cr(x)}if(this.onAnnotationsSubmittedEnabled){var _=this.partitionAnnotationOperations(S.length?S:c),M=(0,br.default)(_,2),A=M[0],b=M[1];this.onAnnotationsSubmitted(A,r),this.submitOperationsToSession(b,r)}else this.submitOperationsToSession(S.length?S:c,r);this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e,this,!0)}},{key:"submitSeedOperations",value:function(e,r){if(!this.allowSeed)throw new Error("Cannot submit seed operations more than once per session");if(this.networkMode===be.LocalWorkflowsOnly&&this.localWorkflowManager){this.localWorkflowManager.runLocalWorkflows(e,this);return}r||(r=this.generateCorrelationId()),this.allowSeed=!1,this.allowGroupSeed=!1;var t=this.partitionAnnotationOperations(e),a=(0,br.default)(t,2),s=a[0],u=a[1];this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(s,r):this.executeCallbacksOnAnnotationSubmitted(s,r),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?u:e,!0,r):this.sendMessageToSession(new Be({cv:r,seq:0,ops:this.onAnnotationsSubmittedEnabled?u:e}))}},{key:"submitSeedGroupOperations",value:function(e,r,t){if(!this.allowGroupSeed)throw new Error("Seed operations are not allowed for this session");if(this.networkMode===be.LocalWorkflowsOnly&&this.localWorkflowManager){this.localWorkflowManager.runLocalWorkflows(e,this);return}t||(t=this.generateCorrelationId()),r&&(this.allowGroupSeed=!1),this.allowSeed=!1;var a=this.partitionAnnotationOperations(e),s=(0,br.default)(a,2),u=s[0],l=s[1];this.executeCallbacksOnAnnotationSubmitted(u,t),this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(u,t):this.executeCallbacksOnAnnotationSubmitted(u,t),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?l:e,!!r,t):(this.seedGroupSize++,this.sendMessageToSession(new Be({cv:t,seq:0,ops:this.onAnnotationsSubmittedEnabled?l:e,groupId:"Seed",groupSize:r?this.seedGroupSize:void 0,groupComplete:r||void 0})))}},{key:"submitCustomMessage",value:function(e){var r=this;return new Promise(function(t,a){r.sendMessageToSession(e,function(s,u){s?a(new Error(s.error)):t(u)})})}},{key:"submitLargeBinaryDataMessage",value:function(e){var r=this;return new Promise(function(t,a){r.sendMessageToSessionPostEndpoint(e,function(s,u){s?a(new Error(s.error)):t(u)})})}},{key:"requestBinaryDataForBlob",value:function(e){var r=this;return e.data?Promise.resolve(e.data):!e.dataPointer||e.dataPointer.refType===xo.None?Promise.reject(new Error("Blob does not have a data pointer")):new Promise(function(t,a){r.requestBinaryDataFromSessionBlobEndpoint(e.dataPointer,function(s,u){s?a(s):t(u)})})}},{key:"requestCacheDump",value:function(e){if(e)throw new Error("NYI");return this.submitCustomMessage(new qi)}},{key:"forceReconnect",value:function(e){return this.extensionConfigs=e,this.sessionManager.forceReconnect(e)}},{key:"close",value:function(e){this.isSessionClosed=!0,this.sessionManager.closeSession(e),this.workflowRuntime&&this.workflowRuntime.close(),this.localWorkflowManager&&this.localWorkflowManager.closeSession(this),this.graphInitMessageTimer&&(clearTimeout(this.graphInitMessageTimer),this.graphInitMessageTimer=void 0)}},{key:"authenticateInteractive",value:function(){return BM(this,void 0,void 0,function*(){if(this.cachedClaimsChallenge.actionRequired){var e=yield this.requestAuthTokenWithClaimsAsync(this.cachedClaimsChallenge,{interactive:!0});if(Oo.typeGuard(e))throw new Error(e.reason)}})}},{key:"getClientMetadata",value:function(){return this.clientMetadata}},{key:"getUserContext",value:function(){return this.userContext}},{key:"setSessionCloseCallback",value:function(e){var r=this.getSessionStateCallbackToken("close");return e&&this.sessionCloseCallbacks.set(r,e),r}},{key:"setConnectCallback",value:function(e){var r=this.getSessionStateCallbackToken("connect");return e&&this.connectCallbacks.set(r,e),r}},{key:"setDisconnectCallback",value:function(e){var r=this.getSessionStateCallbackToken("disconnect");return e&&this.disconnectCallbacks.set(r,e),r}},{key:"setReconnectCallback",value:function(e){var r=this.getSessionStateCallbackToken("reconnect");return e&&this.reconnectCallbacks.set(r,e),r}},{key:"removeSessionStateCallback",value:function(e){function r(t){return t.has(e)?(t.delete(e),!0):!1}return r(this.sessionCloseCallbacks)||r(this.reconnectCallbacks)||r(this.disconnectCallbacks)||r(this.connectCallbacks)}},{key:"setServerAuthenticationStateChangeCallback",value:function(e){this.serverAuthenticationStateChangeCallback.push(e),e(this.serverAuthenticationState)}},{key:"setClaimsChallengeCallback",value:function(e){this.cachedClaimsChallenge.actionRequired&&e(this.cachedClaimsChallenge),this.claimsChallengeCallback.push(e)}},{key:"getConnectParams",value:function(){return this.connectParams}},{key:"setOfflineMode",value:function(){this.sessionManager=new Mr}},{key:"onAnnotationResults",value:function(e,r,t){var a=this;m.info(508916486,v.CoreDefault,new E({operationName:"OnAnnotationResultsEgress",dimension0:e==null?void 0:e.annotationType,success:!0,cv:e.cv})),t(void 0,new Fe),r===tn.LocalWorkflow&&this.contextIdManager.applyContextIdOnOperations(e.ops),this.updateWorkflowExecutionStates(e.ops),this.egress&&this.egress(e,function(){}),this.annotationResultsProcessor.process(e,function(s,u){a.applyOperationForContext(s,u,r)},function(s,u){a.triggerRegisteredAnnotationCallbacks(s,e.annotationType,u)},function(s){if(r!==tn.ServerWorkflow){var u=s.ops.filter(a.filterOperationsForSession.bind(a)).filter(eS);a.submitOperationsToSession(u,s.cv)}a.localWorkflowManager&&a.localWorkflowManager.runLocalWorkflows(s.ops,a)})}},{key:"onAnnotationResultStateMessage",value:function(e,r){var t;r(void 0,new Fe);for(var a of e.updates){var s=a.annotationType,u=a.state;if(this.tokensByAnnotationType.has(s)){var l=void 0;this.annotationResultStates.has(s)?l=this.annotationResultStates.get(s):u===un.Idle?l=un.Pending:l=un.Idle;for(var f of this.tokensByAnnotationType.get(s)){var c=this.annotationActivationTrackers.get(f);!((t=c.options)===null||t===void 0)&&t.stateUpdateCallback&&c.options.stateUpdateCallback(l,u)}}}}},{key:"submitOperationsToSession",value:function(e,r){var t=this;r||(r=this.generateCorrelationId());var a=e.filter(function(l){return ot.typeGuard(l)}),s=e.filter(function(l){return!ot.typeGuard(l)});if(a.length>0&&this.sendMessageToSession(new Be({cv:r,ops:a})),s.length>0)if(this.operationBatchConfig){if(!this.batchedOperationsManager){var u=void 0;this.batchMessagesEnabled?u=function(f,c,d){if(f.length){var p=new xn;p.messages=[],f.forEach(function(g){p.messages.push(new Be({cv:g.cv,seq:t.nextSyncSequenceId++,ops:g.input}))}),t.sendMessageToSession(p,function(g){d(g?new Error(g.error):void 0)})}}:u=function(f,c,d){t.sendMessageToSession(new Be({cv:c.cv,seq:t.nextSyncSequenceId++,ops:f}),function(p){d(p?new Error(p.error):void 0)})},this.batchedOperationsManager=new Po(u,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled)}this.batchedOperationsManager.addBatchItem(s,this.operationBatchConfig,{name:"SubmitOperations"},r)}else this.sendMessageToSession(new Be({cv:r,seq:this.nextSyncSequenceId++,ops:s}))}},{key:"sendMessageToSession",value:function(e,r){this.sessionManager.sendMessage(e,r),Je.typeGuard(e)&&this.close()}},{key:"sendMessageToSessionPostEndpoint",value:function(e,r){var t=new E({operationName:"SendLargeBinaryDataMessage",success:!0,cv:e.cv}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)wd(this.connectParams,e,t,r);else{var a=function(s){return wd(s,e,t,r)}.bind(this);this.pendingConnectCallbacks.push(a)}}},{key:"requestBinaryDataFromSessionBlobEndpoint",value:function(e,r){var t=new E({operationName:"RequestBinaryData",success:!0,cv:new Qe().toString()}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Sd(this.connectParams,e,r,t);else{var a=function(s){return Sd(s,e,r,t)}.bind(this);this.pendingConnectCallbacks.push(a)}}},{key:"registerContextTypes",value:function(e){for(var r of e)this.activateAnnotation(r),this.registeredContextTypes.add(r)}},{key:"applyOperationForContext",value:function(e,r,t){var a=this,s=y.getTypeNameFor(e);if(!(s!=ke.getTypeName()&&s!=vr.getTypeName()&&s!=Pe.getTypeName()&&s!=Ge.getTypeName())){s==vr.getTypeName()&&(s=ke.getTypeName());var u=it(this.resolvePlaceholdersInOperationParentPath(e.parentPath),r),l=H(u.parentPath);if(s==ke.getTypeName()||s==Pe.getTypeName()){if(!u.body)return;var f=y.getTypeNameFor(u.body);if(!this.registeredContextTypes.has(f))return;var c=this.availableContexts.get(f);c||(c=new Map,this.availableContexts.set(f,c));var d=c.get(t);if(d||(d=[],c.set(t,d)),!u.id){if(this.workflowRuntime)throw new Error("Expected item to have id already");this.localWorkflowManager&&(u.id=this.localWorkflowManager.getNextClientAnnotationId())}if(s==ke.getTypeName())d.filter(function(g){return H(g.parentPath)==l&&g.id==u.id}).length==0?d.push(u):m.info(540848911,v.CoreDefault,`AddOperation for (${t}, ${u.id}, ${u.source}) can't be applied as the context item with matching path and ID already exists. Use UpdateOperation instead.`);else for(var p=0;p<d.length;p++)if(d[p].id==u.id&&H(d[p].parentPath)==l)if(d[p].source==u.source){d[p]=u;break}else m.warn(540848912,v.CoreDefault,`UpdateOperation for (${t}, ${u.id}, ${u.source}) can't be applied as the context item with provided path and ID has different source: ${d[p].source}`);else m.warn(540848913,v.CoreDefault,`UpdateOperation for (${t}, ${u.id}, ${u.source}) can't be applied as the context item with matching path and ID was not found. AddOperation should be used instead`)}else if(s==Ge.getTypeName()){if(!u.id)return;this.availableContexts.forEach(function(g,k){var S=g.get(t);S&&(S=S.filter(function(x){return!(H(x.parentPath)==l&&x.id==u.id)}),S.length==0?g.delete(t):g.set(t,S),g.size==0?a.availableContexts.delete(k):a.availableContexts.set(k,g))})}}}},{key:"updateWorkflowExecutionStates",value:function(e){if(this.localWorkflowManager){var r=this.enableRemoteExecutionNotification?this.workflowGraph.getWorkflowNodes().map(function(u){return u.workflow}):this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this);for(var t of e)if(Sa.has(y.getTypeNameFor(t)))for(var a of t.items)for(var s of r||[])this.localWorkflowManager.preProcessItemToWorkflow(s,a,this)}}},{key:"resolveRequestedContexts",value:function(e){var r=[];for(var t of ir(e.requestedContextTypesRules)){var a=(0,br.default)(t,3),s=a[0],u=a[1],l=a[2];if(!this.availableContexts.has(s)){if(u==Sr.Required)return[!1,[]];continue}var f=Array.from(this.availableContexts.get(s).values()).reduce(function(c,d){return c.concat(d)},[]);if(f.length==0)throw new Error(`Assert: availableContexts have the entry for ${s} which does not contain any context annotation.`);r.push.apply(r,(0,ko.default)(f))}return[!0,this.removeDuplicatedContextItems(r)]}},{key:"removeDuplicatedContextItems",value:function(e){return e.filter(function(r,t,a){return a.findIndex(function(s){return me.deepEquals(s,r)})===t})}},{key:"getContextAnnotations",value:function(e,r,t,a){var s,u,l=t?H(t):void 0;return(u=(s=this.availableContexts.get(e))===null||s===void 0?void 0:s.get(r))===null||u===void 0?void 0:u.filter(function(f){return(!l||H(f.parentPath)==l)&&(!a||f.source==a)})}},{key:"onWorkflowDefinitionOverrideMessage",value:function(e){var r=new E({operationName:"WorkflowDefinitionOverride",success:!0}).setClientMetadata(this.clientMetadata).start(),t=function(f){throw cr(r,f),Error(`WorkflowDefinitionOverride: ${f}`)};if(!this.localWorkflowManager){t("Not supported by this local SessionProxy instance.");return}var a=this.localWorkflowManager.getWorkflowDefinitionsByName(this),s=a.get(e.sourceWorkflowId);if(!s){t(`Workflow registration for source workflow '${e.targetWorkflowId}' was not found.`);return}r.resourceId=s.id;var u=a.get(e.targetWorkflowId);if(u){if(!u.allowDefinitionOverride){t(`Workflow '${u.id}' does not allow workflow definition override.`);return}if(!s.definitionOverrideTargetWorkflows||s.definitionOverrideTargetWorkflows.indexOf(u.id)===-1){t(`Workflow '${s.id}' does not allow workflow definition for workflow '${u.id}'.`);return}this.workflowDefinitionManager.mergeWorkflowDefinition(u,e.definition,e.contextId),r.resultDescription=`Updated config for workflow: ${e.targetWorkflowId}, context id: ${e.contextId}`,cr(r)}}},{key:"applyContextIdOnOperations",value:function(e){this.contextIdManager.applyContextIdOnOperations(e)}},{key:"attachToWorkflowGraph",value:function(e){this.addToWorkflowGraph(e),this.attachExecutionTrackerToEachWorkflow()}},{key:"triggerRegisteredAnnotationCallbacks",value:function(e,r,t){if(this.callAnnotationCallbacks(e,r,t),this.hostCallbacks.onAnnotationResult)try{this.hostCallbacks.onAnnotationResult(e,t)}catch(a){m.error(540301151,v.CoreDefault,new E({operationName:"HostCallbackOnAnnotationResultError",dimension0:r,resultDescription:`onAnnotationResult error: ${a}`}))}}},{key:"attachExecutionTrackerToEachWorkflow",value:function(){this.localWorkflowManager&&this.localWorkflowManager.attachExecutionTrackerToEachWorkflow(this.workflowGraph,this,this.onWorkflowExecutionComplete.bind(this))}},{key:"onWorkflowExecutionCompleteMessage",value:function(e,r){r(void 0,new Fe),this.localWorkflowManager&&this.localWorkflowManager.onExternalWorkflowExecuted(e.contextId,e.workflowId,this)}},{key:"onWorkflowExecutionComplete",value:function(e,r){}},{key:"enableDeltaGenerator",value:function(){var e,r;this.deltaGenerator=(e=this.deltaGenerator)!==null&&e!==void 0?e:new zw,this.syncDeltaTimers=(r=this.syncDeltaTimers)!==null&&r!==void 0?r:new Map}},{key:"createDeltasFromUpdateOperation",value:function(e){var r,t,a=[];m.info(523776396,v.CoreDefault,`Calling delta create for UpdateOperation under parent path [${e.parentPath}] (${(r=e.items)===null||r===void 0?void 0:r.length} item(s), first item id: ${((t=e.items)===null||t===void 0?void 0:t.length)>0?e.items[0].id:"(no items)"})`);var s=(0,ko.default)(e.parentPath);for(var u of e.items){var l=[],f=this.deltaGenerator.createTextTileDeltasFromItem(u,e.parentPath);if(!(f!=null&&f.length)){m.info(523329632,v.CoreDefault,`Failed to create delta on item ${u.id}`);continue}for(var c of f){var d=an();s=[].concat((0,ko.default)(e.parentPath),[u.id]);var p={id:d,revId:u.revId,body:c,contextId:u.contextId,source:u.source};l.push(p)}l.length>0&&(a.push(new Gt({parentPath:s,items:l})),this.enableSyncDeltaSending&&this.setupSyncDeltaAfterDelay(u,s,l))}return a}},{key:"setupSyncDeltaAfterDelay",value:function(e,r,t){var a=this,s,u,l,f=this.syncDeltaTimers.get(e.id);f&&(clearTimeout(f),this.syncDeltaTimers.delete(e.id));var c=t.find(function(C){var T;return((T=C.body)===null||T===void 0?void 0:T.unit)===je.Chars});if(c){var d=c.body,p={content:"",deltaType:he.Update,length:0,position:((s=d==null?void 0:d.position)!==null&&s!==void 0?s:0)+((l=(u=d==null?void 0:d.content)===null||u===void 0?void 0:u.length)!==null&&l!==void 0?l:0),unit:je.Sentence},g=ht.typeGuard(e.body)?new hn(p):new sr(p),k={id:an(),revId:e.revId,body:g,contextId:e.contextId,source:e.source},S=new Gt({parentPath:r,items:[k]}),x=setTimeout(function(C,T){a.submitOperation(C),a.syncDeltaTimers.delete(T)},this.syncDeltaTimeout,S,e.id);this.syncDeltaTimers.set(e.id,x)}}},{key:"addToWorkflowGraph",value:function(e){this.workflowGraph.addWorkflow(ya(e))}},{key:"getAuthToken",value:function(e,r){var t={Tickets:[]};this.clientMetadata.docSessionId&&(t.DocSessionId=this.clientMetadata.docSessionId);var a=OM(e);a&&(t.TokenType=a),this.hostCallbacks.requestAuthToken(t).then(function(s){var u;if(!s)throw new Error("Missing AuthTokenResponse from requestAuthToken");if(!s.Token)throw new Error("Missing Token from requestAuthToken");r(void 0,s.Token,{returnedTokenType:e,timeToLiveSec:(u=s.TokenProperties)===null||u===void 0?void 0:u.timeToLiveSec})}).catch(function(s){r(s)})}},{key:"resetNextSyncSequenceId",value:function(){this.nextSyncSequenceId=1}},{key:"onReconnect",value:function(){var e=this;if(this.annotationActivationTrackers.forEach(function(r){e.activateAnnotationForTracker(r,{ignoreExistingAnnotations:!0,sendOnlyIfConnected:!0}).catch(function(){})}),this.reconnectCallbacks.forEach(function(r,t){r()}),!this.connectParams)throw new Error("Expected onConnect before onReconnect")}},{key:"onSessionClose",value:function(e){this.isSessionClosed=!0,this.connectParams=void 0,this.sessionCloseCallbacks.forEach(function(r,t){r(e)})}},{key:"onConnect",value:function(e,r,t,a,s,u){this.hasSessionConnected?e&&(this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.seedBatchedOperationsManager&&(this.seedBatchedOperationsManager.removeAllBatchedItems(),this.seedBatchedOperationsManager=void 0),this.batchedOperationsManager&&(this.batchedOperationsManager.removeAllBatchedItems(),this.batchedOperationsManager=void 0),this.cachedClaimsChallenge=Object.assign(Object.assign({},this.cachedClaimsChallenge),{claimsVersion:0})):this.enableRemoteExecutionNotification&&this.addDownstreamWorkflowsIntoClientGraph(u),this.connectParams={isSeedingRequired:e,sessionUrl:r,origin:t,authToken:a},this.hasSessionConnected=!0,this.tryActivateWorkflows();for(var l of this.pendingConnectCallbacks)l(this.connectParams);this.connectCallbacks.forEach(function(f,c){f(e,r,t,a)}),this.serverInputTypes=s}},{key:"onDisconnect",value:function(e){this.connectParams=void 0,this.disconnectCallbacks.forEach(function(r,t){r(e)})}},{key:"onServerAuthenticationStateChange",value:function(e){if(e!=this.serverAuthenticationState){if(this.serverAuthenticationState==ut.Authenticated&&e==ut.Pending)return;this.serverAuthenticationState=e;for(var r of this.serverAuthenticationStateChangeCallback)r(this.serverAuthenticationState)}}},{key:"callAnnotationCallbacks",value:function(e,r,t){if(this.annotationCallbacks.size!==0){var a=this.annotationCallbacks.get(r);a&&a.forEach(function(s){s(e,t)})}}},{key:"getOperationBatchConfig",value:function(e){var r=function(){return"operations"},t=void 0;this.batchMessagesEnabled?t=function(u){return{input:u,demultiplex:function(){return[[]]}}}:t=function(u){return{input:u.filter(function(l){return l.length}).reduce(function(l,f){return l.concat(f)},[]),demultiplex:function(){return[[]]}}};var a=function(u){if(!(u.length<=1))return{inputs:u.reduce(function(l,f){return l.push([f]),l},[]),join:function(){return[]}}};return{delayMs:e.delayMs,delayMsMax:e.delayMsMax,maxInputSize:e.maxInputSize,estimateSize:fs,groupingKeyExtractor:r,multiplex:t,split:a}}},{key:"sendSeedMessagesViaBatchManager",value:function(e,r,t){var a=this;if(!this.seedBatchedOperationsManager){var s=void 0;this.batchMessagesEnabled?s=function(l,f,c){if(a.batchedSeedMessageGroupSize+=l.length,l.length){var d=new xn;d.messages=[],l.forEach(function(p){d.messages.push(new Be({cv:p.cv,seq:0,ops:p.input,groupId:"Seed",groupSize:f.groupComplete?a.batchedSeedMessageGroupSize:void 0,groupComplete:f.groupComplete?f.groupComplete:void 0}))}),a.sendMessageToSession(d,function(p){c(p?new Error(p.error):void 0)})}}:s=function(l,f,c){a.seedGroupSize++,a.sendMessageToSession(new Be({cv:f.cv,seq:0,ops:l,groupId:"Seed",groupSize:f.groupComplete?a.seedGroupSize:void 0,groupComplete:f.groupComplete?f.groupComplete:void 0}),function(d){c(d?new Error(d.error):void 0)})},this.seedBatchedOperationsManager=new Po(s,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled)}this.seedBatchedOperationsManager.addBatchItem(e,this.operationBatchConfig,{name:"SubmitSeedOperations"},t,r)}},{key:"onAnnotationResultsFromServer",value:function(e,r){this.onAnnotationResults(e,tn.ServerWorkflow,r)}},{key:"onAnnotationResultsFromLocal",value:function(e,r){this.onAnnotationResults(e,tn.LocalWorkflow,r)}},{key:"getLocalRegisteredWorkflows",value:function(){return this.workflowRuntime?this.workflowRuntime.getRegisteredWorkflows():this.localWorkflowManager?this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this).map(function(e){return ya(e)}):[]}},{key:"sendWorkflowGraphInitMessage",value:function(){var e=this,r=this.getLocalRegisteredWorkflows(),t=new E({operationName:"WorkflowGraphInit",success:!0}).setClientMetadata(this.clientMetadata).start(),a=new Yr({upstreamRuntimeWorkflows:r});this.sendMessageToSession(a,function(s,u){if(s){cr(t,s.error);return}t.resultDescription=`local workflows: ${r.map(function(l){return l.id})}, remote workflows: ${u.downstreamRuntimeWorkflows.map(function(l){return l.id})}`,cr(t),e.onWorkflowGraphInitResponse(u)})}},{key:"trySendWorkflowGraphInitMessage",value:function(){var e=this;!this.graphInitMessageTimer&&this.enableRemoteExecutionNotification&&(this.graphInitMessageTimer=setTimeout(function(){e.graphInitMessageTimer=void 0,e.sendWorkflowGraphInitMessage()},WM))}},{key:"onWorkflowGraphInitResponse",value:function(e){this.addDownstreamWorkflowsIntoClientGraph(e.downstreamRuntimeWorkflows),this.tryActivateWorkflows()}},{key:"addDownstreamWorkflowsIntoClientGraph",value:function(e){this.workflowGraph.removeWorkflows(!0);for(var r of e||[])this.workflowGraph.addWorkflow(r,!0);this.workflowRuntime||this.attachExecutionTrackerToEachWorkflow()}},{key:"resolvePlaceholdersInOperationParentPath",value:function(e){var r=e;return r.length==3&&r[0]=="session"&&r[1]=="user"&&r[2].startsWith("user_")&&(m.info(540848914,v.CoreDefault,`Replacing user context placeholder for: ${H(e)}.`),r=["session","#userContext#"]),r.length==3&&r[0]=="session"&&r[1]=="user"&&r[2].startsWith("tenant_")&&(m.info(540848915,v.CoreDefault,`Replacing tenant context placeholder for: ${H(e)}.`),r=["session","#tenantContext#"]),r}},{key:"filterOperationsForSession",value:function(e){return this.workflowRuntime?!0:Gg(e,this.serverInputTypes)}},{key:"executeCallbacksOnAnnotationSubmitted",value:function(e,r){var t=this,a=this.getAnnotationOperationsByType(e);a.forEach(function(s,u){Array.from(s).forEach(function(l){return t.triggerRegisteredAnnotationCallbacks(l,u,r)})})}},{key:"partitionAnnotationOperations",value:function(e){return e.reduce(function(r,t){var a=(0,br.default)(r,2),s=a[0],u=a[1];return t.items.some(function(l){return l.body&&At.typeGuard(l.body)})?[[].concat((0,ko.default)(s),[t]),u]:[s,[].concat((0,ko.default)(u),[t])]},[[],[]])}},{key:"onAnnotationsSubmitted",value:function(e,r){var t=this,a=this.getAnnotationOperationsByType(e);a.forEach(function(s,u){var l=Array.from(s);t.onAnnotationResults(new Nt({annotationType:u,ops:l,cv:r}),tn.Submitted,function(){})})}},{key:"getAnnotationOperationsByType",value:function(e){var r=new Map;for(var t of e)for(var a of t.items)if(a.body&&At.typeGuard(a.body)){var s=y.getTypeNameFor(a.body),u=r.get(s)||new Set;u.add(t),r.set(s,u)}return r}},{key:"onClaimsChallengeMessage",value:function(e,r){e.claimsVersion>this.cachedClaimsChallenge.claimsVersion&&(this.cachedClaimsChallenge=Object.assign(Object.assign({},e),{actionRequired:!0}));for(var t of this.claimsChallengeCallback)t(this.cachedClaimsChallenge);r(void 0,new Fe)}},{key:"generateCorrelationId",value:function(){return this.sessionManager.getCorrelationVector().newChild().toString()}},{key:"requestAuthTokenWithClaims",value:function(e){this.requestAuthTokenWithClaimsAsync(e).catch(function(){})}},{key:"requestAuthTokenWithClaimsAsync",value:function(e,r){var t=this,a=new E({operationName:"RequestAuthTokenWithClaims",success:!0}).start(),s={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:Vn.Augloop,ConnectParams:this.connectParams,Claims:e.claims,Interactive:r==null?void 0:r.interactive};return this.hostCallbacks.requestAuthToken(s).then(function(u){if(!u)throw new Error("Missing AuthTokenResponse from requestAuthToken claims");if(!u.Token)throw new Error("Missing Token from requestAuthToken claims");return a.resultSignature="Token",new nr({authToken:u.Token,version:++t.tokenMessageVersion,claimsVersion:e.claimsVersion})}).catch(function(u){return a.resultSignature="NoToken",new Oo({reason:u.message,version:++t.tokenMessageVersion,claimsVersion:e.claimsVersion})}).then(function(u){return new Promise(function(l,f){t.sendMessageToSession(u,function(c){cr(a,c==null?void 0:c.error),c?f(new Error(c.error)):(t.cachedClaimsChallenge.actionRequired=!1,l(u))})})})}}]),n}();h();var rS=w(B()),oS=w(R()),Ma=(0,rS.default)(function n(){(0,oS.default)(this,n)});h();var sS=w(R()),uS=w(B()),lS=w(ze()),fS=w(Ve()),xd=w(Oe());h();var iS=w(R()),aS=w(B()),ba;(function(n){n[n.Anonymous=0]="Anonymous",n[n.Host=1]="Host"})(ba||(ba={}));var dr=function(){function n(){(0,iS.default)(this,n),this.timers=new Map}return(0,aS.default)(n,[{key:"scheduleRefresh",value:function(e,r,t,a){var s=this.timers.get(e);s||(s={numberOfAttempts:0},this.timers.set(e,s)),s.refreshTimeoutId&&(clearTimeout(s.refreshTimeoutId),s.refreshTimeoutId=void 0),s.expiredTimeoutId&&(clearTimeout(s.expiredTimeoutId),s.expiredTimeoutId=void 0);var u=r*1e3-n.tokenRefreshBufferMs,l=r*1e3-n.tokenExpirationBufferMs;u>0?s.numberOfAttempts=0:(++s.numberOfAttempts,u=n.tokenRefreshBackoffIntervalMs,l=n.tokenExpirationBufferMs),s.numberOfAttempts<=n.tokenRefreshMaximumAttempts&&(s.refreshTimeoutId=setTimeout(function(){t()},u)),a&&(s.expiredTimeoutId=setTimeout(function(){a()},l))}},{key:"clearRefreshTimeouts",value:function(){this.clearTimeouts(!1)}},{key:"clearAllTimeouts",value:function(){this.clearTimeouts(!0)}},{key:"clearTimeouts",value:function(e){var r=this;this.timers.forEach(function(t,a){t.refreshTimeoutId&&(clearTimeout(t.refreshTimeoutId),t.refreshTimeoutId=void 0),e&&t.expiredTimeoutId&&(clearTimeout(t.expiredTimeoutId),t.expiredTimeoutId=void 0),t.expiredTimeoutId||r.timers.delete(a)})}}]),n}();dr.tokenRefreshBufferMs=24e4;dr.tokenExpirationBufferMs=12e4;dr.tokenRefreshBackoffIntervalMs=3e4;dr.tokenRefreshMaximumAttempts=3;var cS=w(Rn());function LM(n){var o=FM();return function(){var r=(0,xd.default)(n),t;if(o){var a=(0,xd.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,fS.default)(this,t)}}function FM(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Ea=function(n){(0,lS.default)(e,n);var o=LM(e);function e(r,t,a,s,u){var l;if((0,sS.default)(this,e),l=o.call(this),l.getSessionStats=r,l.clientMetadata=t,l.tokenRefreshManager=a,l.sendMessage=s,l.options=u||{},l.options.overrideSessionInitMessage=l.options.overrideSessionInitMessage||function(f){return f},l.clientMetadata&&!l.clientMetadata.userSystemTimezone)try{l.clientMetadata.userSystemTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(f){}return l}return(0,uS.default)(e,[{key:"initSession",value:function(t){var a=this;t.onResponse=t.onResponse||function(){};var s=me.getCurrentTimeMs(),u=this.getSessionStats().lastConnectionClose&&s-this.getSessionStats().lastConnectionClose,l=this.getSessionStats().lastSyncMessage&&s-this.getSessionStats().lastSyncMessage,f=new E({operationName:"SessionInit"}).start(),c={sessionKey:this.sessionKey,sessionId:this.clientMetadata.sessionId,timeSinceLastConnectionClose:u,timeSinceLastSyncMessage:l,isTokenRefresh:t.isTokenRefresh,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,error:void 0},d=this.options.overrideSessionInitMessage(new gt({protocolVersion:Wg,clientMetadata:this.clientMetadata,sessionKey:this.sessionKey,origin:this.origin,authToken:this.anonymousToken,extensionConfigs:t.extensionConfigs,returnWorkflowInputTypes:!0,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification}));this.sendMessage(d,function(p,g){if(f.success=!p,f.resultSignature=a.getSessionStats().lastConnectionClose?"Reconnect":"FirstConnect",f.resourceId=sn(g==null?void 0:g.sliceUrl),f.setClientMetadata(a.clientMetadata),g!=null&&g.sessionKey&&c.sessionKey!==g.sessionKey&&(c.sessionKey=g.sessionKey),p&&(c.error=p.error),f.resultDescription=JSON.stringify(c),m.info(508843779,v.CoreDefault,f.stop()),t.onResponse(p,g),p){a.emit("serverAuthenticationStateChange",ut.NotAuthenticated);return}if(t.isReconnectOnSameSlice&&g.forceReconnect){a.emit("serverAuthenticationStateChange",ut.NotAuthenticated);return}if(!g.anonymousToken||!g.tokenExpirationSeconds){a.emit("serverAuthenticationStateChange",ut.NotAuthenticated),m.error(508843778,v.CoreDefault,"AL Anonymous token was not generated for the session");return}a.anonymousToken=g.anonymousToken,a.onSuccessfulSessionInitOnServerSide(g)})}},{key:"onSuccessfulSessionInitOnServerSide",value:function(t){var a=this;this.tokenRefreshManager.scheduleRefresh(ba.Anonymous,t.tokenExpirationSeconds,this.initSession.bind(this,{isTokenRefresh:!0}),function(){a.anonymousToken=void 0}),this.connectParams={isSeedingRequired:this.sessionKey!==t.sessionKey,sessionUrl:`${t.sessionUrlBase}/${t.sessionKey}`,origin:t.origin,authToken:this.anonymousToken},this.initHostAuthToken();var s=!!this.sessionKey;this.sessionKey=t.sessionKey,this.origin=t.origin,this.emit("connect",this.connectParams.isSeedingRequired,s,this.connectParams.sessionUrl,this.connectParams.origin,this.connectParams.authToken,t.workflowInputTypes,t.downstreamRuntimeWorkflows),s&&this.emit("reconnect")}},{key:"getAuthToken",value:function(){var t={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:Vn.Augloop,ConnectParams:this.connectParams};return this.options.requestAuthToken(t).then(function(a){return a.Token}).catch(function(){})}},{key:"initHostAuthToken",value:function(){var t=this,a=this.options.requestAuthToken?this.getAuthToken.bind(this):this.options.getAuthToken;if(a){var s=new E({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();a().then(function(u){if(!u){t.emit("serverAuthenticationStateChange",ut.NotAuthenticated),s.success=!1,s.resultDescription="Host auth token provision failed",m.info(508843777,v.CoreDefault,s.stop());return}m.info(508843776,v.CoreDefault,s.stop()),t.sendTokenProvisionMessage(u)}).catch(function(u){t.emit("serverAuthenticationStateChange",ut.NotAuthenticated),s.success=!1,s.resultDescription=`Error happened while attempting to fetch host token: ${u}`,m.error(508843747,v.CoreDefault,s.stop())})}}},{key:"sendTokenProvisionMessage",value:function(t){var a=new nr({authToken:t,version:1});this.emit("serverAuthenticationStateChange",ut.Pending),this.sendMessage(a,this.onTokenProvisionResponse.bind(this),!0)}},{key:"onTokenProvisionResponse",value:function(t,a){if(t||!a||!a.tokenExpirationSeconds){this.emit("serverAuthenticationStateChange",ut.NotAuthenticated);return}var s=a.tokenType&&a.tokenType==pt.WacUserInfo?ut.WacUserInfoAuthenticated:ut.Authenticated;this.emit("serverAuthenticationStateChange",s),this.tokenRefreshManager.scheduleRefresh(ba.Host,a.tokenExpirationSeconds,this.initHostAuthToken.bind(this))}}]),e}(cS.EventEmitter);h();var ru=w(Se()),Nr=w(at()),wS=w(R()),SS=w(B());h();var Td=w(Se()),Id=w(R()),_d=w(B());var qM=function(){function n(o){(0,Id.default)(this,n),this.item=o,this.operation=o.op,this.delta=o.delta,this.deltas=o.deltas,this.id=H(this.itemPath),this.revId=o.revId}return(0,_d.default)(n,[{key:"itemPath",get:function(){return[].concat((0,Td.default)(this.item.parentPath),[this.item.id])}},{key:"getModelIterator",value:function(){throw new Error("Method not implemented.")}},{key:"getBody",value:function(){return this.item.body}},{key:"getItemReference",value:function(){throw new Error("Method not implemented.")}},{key:"getParentItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getParentItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getPrevItem",value:function(e,r){throw new Error("Method not implemented.")}},{key:"getPrevItemBody",value:function(e,r){throw new Error("Method not implemented.")}},{key:"getNextItem",value:function(e,r){throw new Error("Method not implemented.")}},{key:"getNextItemBody",value:function(e,r){throw new Error("Method not implemented.")}},{key:"getChildItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"addAnnotation",value:function(e,r){throw new Error("Method not implemented.")}},{key:"updateAnnotation",value:function(e,r){throw new Error("Method not implemented.")}},{key:"deleteAnnotation",value:function(e){throw new Error("Method not implemented.")}},{key:"loadSubtree",value:function(e){throw new Error("Method not implemented.")}},{key:"getSourceTimestamp",value:function(){return this.item.sourceTimestamp}},{key:"getContextId",value:function(){return this.item.contextId}}]),n}(),dS=function(){function n(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];(0,Id.default)(this,n),this.scopeItem=void 0,this.rootItem=void 0,this.normalizeFilter=function(r){if(!r)return function(t){return t!==void 0};if(typeof r=="function")throw new Error("Not implemented yet");if((r.id?1:0)+(r.ids?1:0)+(r.itemType?1:0)+(r.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");if(r.itemType)return function(t){return t&&y.matchesTypesFor(t.body,[r.itemType])};if(r.itemTypes)return function(t){return t&&y.matchesTypesFor(t.body,r.itemTypes)};throw new Error("Not implemented yet")},this.items=[].concat((0,Td.default)(e),[o]),this.scopeItem=new qM(o)}return(0,_d.default)(n,[{key:"getItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getItemBody",value:function(e){var r=this.getItemBodies(e);return r[0]}},{key:"getItemBodies",value:function(e){var r=this.normalizeFilter(e);return this.items.filter(r).map(function(t){return t.body})}},{key:"getItemByReference",value:function(e){throw new Error("Method not implemented.")}},{key:"getItemBodyByReference",value:function(e){throw new Error("Method not implemented.")}}]),n}();h();var pS=w(R()),gS=w(B());var Ad=function(){function n(o){(0,pS.default)(this,n),this.model=o.model,this.clientMetadata=o.clientMetadata,this.userContext=o.userContext,this.site=o.site,this.getTokenCallback=o.getTokenCallback}return(0,gS.default)(n,[{key:"flights",get:function(){var e;return(e=this._flights)!==null&&e!==void 0||(this._flights=go(this.clientMetadata.flights)),this._flights}},{key:"getToken",value:function(e,r){return this.getTokenCallback(e,r)}}]),n}();h();var hS=w(at()),mS=w(R()),vS=w(B());var yS=function(){function n(o,e,r){(0,mS.default)(this,n),this.itemsContextId=new Set,this.executionState=new Map,this.graphNode=o,this.onContextIdWorkflowExecutionComplete=e,r&&(this.itemsContextId=r.itemsContextId,this.executionState=r.executionState)}return(0,vS.default)(n,[{key:"addInputItemToProcess",value:function(e){this.itemsContextId.add(e)}},{key:"removeProcessedInputItem",value:function(e){this.itemsContextId.delete(e)}},{key:"countItemsToProcess",value:function(e){var r=0;for(var t of this.itemsContextId)t.indexOf(e)===0&&(r+=1);return r}},{key:"getExecutionState",value:function(){return this.executionState}},{key:"setExecutionState",value:function(e,r){return this.graphNode.isActivated?e?(this.executionState.set(e,r),!0):(m.info(520217546,v.CoreDefault,new E({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${r} for a undefined contextId (setExecutionState)`})),!1):(m.info(508883415,v.CoreDefault,new E({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${r} for a not activated workflow`})),!1)}},{key:"beforeWorkflowExecution",value:function(e){this.setExecutionState(e,Ce.Pending)}},{key:"afterWorkflowExecution",value:function(e){this.setExecutionState(e,Ce.Executed)&&this.tryToCompleteWorkflowExecution(e)}},{key:"clearWorkflowExecutions",value:function(){var e=this;this.executionState.forEach(function(r,t){return e.afterWorkflowExecution(t)})}},{key:"tryToCompleteWorkflowExecution",value:function(e){var r=this.executionState.get(e);if(r===Ce.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.graphNode.workflow.id,e);for(var t of this.downstreamWorkflowExecutionTrackers)for(var a of t.getExecutionState()){var s=(0,hS.default)(a,2),u=s[0],l=s[1];l===Ce.Executed&&Lt.isParentContextId(e,u)&&t.tryToCompleteWorkflowExecution(u)}}}},{key:"canCompleteExecution",value:function(e){for(var r of this.upstreamWorkflowExecutionTrackers)for(var t of r.getExecutionState().keys())if(Lt.isParentContextId(t,e))return!1;return!0}}]),n}();var kS=500,qn;(function(n){n.Unknown="",n.InputReceived="input",n.JoinMaxAnnnotation="maxAnnotation",n.JoinMaxTimeout="maxTimeout",n.JoinEarlyCompletion="earlyCompletion"})(qn||(qn={}));var CS=function(){function n(o,e,r){var t=this;(0,wS.default)(this,n),this.executionTrackersByWorkflowNameBySession=new Map,this.workflowsWithSessionAffinity=new Map,this.workflowDefinitionsWithSessionAffinity=[],this.workflowsWithoutSessionAffinity=[],this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.sweepIntervalMs=200,this.sweepTimers=new Map,this.getResourceAsArrayBuffer=function(a,s,u){return t.modelDownloader?t.modelDownloader.getResourceAsArrayBuffer(a,s,u):Promise.reject(new Error("Resource Downloader never created"))},this.getResourceAsURL=function(a,s,u){return t.modelDownloader?t.modelDownloader.getResourceAsURL(a,s,u):Promise.reject(new Error("Resource Downloader never created"))},this.createModel=function(a){return!t.inferenceService&&t.inferenceServiceFactory&&(t.inferenceService=t.inferenceServiceFactory()),t.inferenceService?t.inferenceService.then(function(s){return s.createModel(a)}):Promise.reject(new Error("Inference Service never created"))},this.createModelInputs=function(){if(!t.inferenceService&&t.inferenceServiceFactory&&(t.inferenceService=t.inferenceServiceFactory()),t.inferenceService)return t.inferenceService.then(function(a){return a.createInputs()});throw new Error("Inference Service never created")},this.nextAnnotationId=1,this.nextSignalId=1,this.modelDownloader=o,this.inferenceServiceFactory=e,r.enableDeltas&&(this.deltaHandlers=new Map().set(y.getTypeNameFor(sr),Hy).set(y.getTypeNameFor(hn),zy),this.itemsForDelta=new Map),this.enableEarlyJoin=r.enableEarlyJoin||!1,this.site={getResourceAsArrayBuffer:this.getResourceAsArrayBuffer,getResourceAsURL:this.getResourceAsURL,createModel:this.createModel,createModelInputs:this.createModelInputs}}return(0,SS.default)(n,[{key:"getNextClientAnnotationId",value:function(){return"#AC"+this.nextAnnotationId++}},{key:"getNextClientSignalId",value:function(){return"#SC"+this.nextSignalId++}},{key:"registerLocalWorkflow",value:function(e,r){var t=this,a=new E({operationName:"WorkflowRegistration",resourceId:e.id}).start();if(e.inputTypes.length===0)throw new Error("Invalid workflow params");r?(this.workflowsWithSessionAffinity.get(r).push(this.createWorkflowImplementation(e,r)),r.registerContextTypes(ir(e.requestedContextTypesRules).map(function(s){var u=(0,Nr.default)(s,2),l=u[0],f=u[1];return l})),r.attachToWorkflowGraph(e),a.setClientMetadata(r.getClientMetadata())):(e.isStateful?(this.workflowDefinitionsWithSessionAffinity.push(e),this.workflowsWithSessionAffinity.forEach(function(s,u){s.push(t.createWorkflowImplementation(e,u))})):this.workflowsWithoutSessionAffinity.push(this.createWorkflowImplementation(e)),this.workflowsWithSessionAffinity.forEach(function(s,u){u.registerContextTypes(ir(e.requestedContextTypesRules).map(function(l){var f=(0,Nr.default)(l,2),c=f[0],d=f[1];return c})),u.attachToWorkflowGraph(e)})),a.success=!0,m.info(572838110,v.CoreDefault,a.stop())}},{key:"getAllRegisteredWorkflowsFromSession",value:function(e){var r=[];return r.push.apply(r,(0,ru.default)(this.workflowsWithoutSessionAffinity||[])),r.push.apply(r,(0,ru.default)(this.workflowsWithSessionAffinity.get(e)||[])),r.map(function(t){return t.workflow})}},{key:"getWorkflowDefinitionsByName",value:function(e){var r,t=new Map;return(r=this.workflowsWithSessionAffinity.get(e))===null||r===void 0||r.forEach(function(a){return t.set(a.workflow.id,a.workflow)}),t}},{key:"getWorkflowDefinitionsWithSessionAffinity",value:function(){return this.workflowDefinitionsWithSessionAffinity}},{key:"attachExecutionTrackerToEachWorkflow",value:function(e,r,t){var a=this,s=e.getWorkflowNodes(),u=this.executionTrackersByWorkflowNameBySession.get(r),l=function(k,S){if(t&&t(k,S),a.enableEarlyJoin){var x=function(){for(var T of a.executionTrackersByWorkflowNameBySession.get(r).values())if(T.graphNode.workflow.kind===U.Join){for(var I of T.getExecutionState().keys())if(Lt.isParentContextId(I,S))return!0}return!1};x()&&(a.cancelSweepTimer(r),a.ensureSweepTimer(r),a.sweepScopeExecutionNotifications())}};for(var f of s){var c=u.get(f.workflow.id),d=new yS(f,l.bind(this),c);u.set(f.workflow.id,d)}for(var p of u.values())this.setDownstreamWorkflowExecutionTrackers(p,u),this.setUpstreamWorkflowExecutionTrackers(p,u)}},{key:"canActivateWorkflow",value:function(e,r){var t;return e.location===fr.Local?!0:!(!r.hasConnected||((t=e.workflow.requiredTokenTypes)===null||t===void 0?void 0:t.length)>0&&r.getServerAuthenticationState()===ut.NotAuthenticated)}},{key:"setDownstreamWorkflowExecutionTrackers",value:function(e,r){if(e.downstreamWorkflowExecutionTrackers===void 0){e.downstreamWorkflowExecutionTrackers=new Set;var t=e.graphNode;for(var a of t.downstreamWorkflows||[]){var s=r.get(a.workflow.id);this.setDownstreamWorkflowExecutionTrackers(s,r),e.downstreamWorkflowExecutionTrackers.add(s)}}}},{key:"setUpstreamWorkflowExecutionTrackers",value:function(e,r){if(e.upstreamWorkflowExecutionTrackers===void 0){e.upstreamWorkflowExecutionTrackers=new Set;var t=e.graphNode;for(var a of t.upstreamWorkflows||[]){var s=r.get(a.workflow.id);this.setUpstreamWorkflowExecutionTrackers(s,r),e.upstreamWorkflowExecutionTrackers.add(s)}}}},{key:"deactivateServerWorkflow",value:function(e,r){var t;e.location!==fr.Local&&((t=this.executionTrackersByWorkflowNameBySession.get(r))===null||t===void 0||t.get(e.workflow.id).clearWorkflowExecutions(),e.isActivated=!1)}},{key:"addSession",value:function(e){this.executionTrackersByWorkflowNameBySession.set(e,new Map);var r=[];for(var t of this.workflowDefinitionsWithSessionAffinity)r.push(this.createWorkflowImplementation(t)),e.attachToWorkflowGraph(t);this.workflowsWithSessionAffinity.set(e,r);for(var a of this.workflowsWithoutSessionAffinity)e.attachToWorkflowGraph(a.workflow)}},{key:"closeSession",value:function(e){this.cancelSweepTimer(e);for(var r of this.workflowsWithSessionAffinity.get(e)||[])r.workflowLambda.dispose();this.workflowsWithSessionAffinity.delete(e)}},{key:"setTokenCallback",value:function(e){this.getAuthTokenCallback=e}},{key:"preProcessItemToWorkflow",value:function(e,r,t){var a=this.executionTrackersByWorkflowNameBySession.get(t).get(e.id);e.kind===U.Join&&y.matchesTypesFor(r.body,e.inputTypes)&&a.addInputItemToProcess(r.contextId),(e.kind===U.SingleItem&&y.matchesTypesFor(r.body,e.inputTypes)||e.kind===U.Join&&y.matchesTypesFor(r.body,[e.collectionScopeType]))&&a.beforeWorkflowExecution(r.contextId)}},{key:"isReadyToEarlyJoin",value:function(e,r,t){var a=this,s=function(p){var g,k=Array.from((g=p.states)!==null&&g!==void 0?g:[]).map(function(x){return`${x[0]}: ${x[1].map(function(C){return C.join()})}`}).join(),S=new E({operationName:"EarlyJoinCompletion",resourceId:e.graphNode.workflow.id,joinContextId:r,success:!0}).start();S.setClientMetadata(t),S.resultDescription=`isReadyToEarlyJoin (${a.enableEarlyJoin}) -> hasProcessedAllInputItems: ${p.hasProcessedAllInputItems}, allUpstreamComplete: ${p.allUpstreamComplete}, states: ${k}`,m.info(512550800,v.CoreDefault,S.stop())},u=e.countItemsToProcess(r)===0;if(!u)return this.enableEarlyJoin||s({hasProcessedAllInputItems:u}),!1;var l=this.areAllUpstreamWorkflowComplete(e,r),f=l.allUpstreamComplete,c=l.states;return this.enableEarlyJoin?f:(s({hasProcessedAllInputItems:u,allUpstreamComplete:f,states:c}),!1)}},{key:"areAllUpstreamWorkflowComplete",value:function(e,r){var t=new Map;for(var a of e.upstreamWorkflowExecutionTrackers){var s=[];for(var u of a.getExecutionState()){var l=(0,Nr.default)(u,2),f=l[0],c=l[1];if(s.push([f,c]),Lt.isParentContextId(r,f))return t.set(a.graphNode.workflow.id,s),{allUpstreamComplete:!1,states:t}}s.length>0&&t.set(a.graphNode.workflow.id,s)}return{allUpstreamComplete:!0,states:t}}},{key:"runLocalWorkflows",value:function(e,r){var t=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s,u,l,f=function(C,T,I){var _,M,A=r.getWorkflowItemStorage(),b=C.workflow,N=(_=t.executionTrackersByWorkflowNameBySession.get(r))===null||_===void 0?void 0:_.get(b.id),z=b.inputTypes.concat(b.kind===U.Join?b.collectionScopeType:[]),L=new E({operationName:"RunLocalWorkflows",success:!0,resourceId:b.id,joinContextId:T.contextId}).start();if(L.setClientMetadata(r.getClientMetadata()),y.matchesTypesFor(T.body,z)){var J=it(I.parentPath,T);if(b.kind===U.Join)if(y.matchesTypesFor(J.body,[b.collectionScopeType])){A.setScopeItem(J,b),L.resultDescription=`Scope item: ${T.id} (${y.getTypeNameFor(T.body)})`,m.info(524126153,v.CoreDefault,L.stop()),t.setScopeExecutionNotification(r,C,J,Er.Internal);return}else{N.removeProcessedInputItem(J.contextId);var P=A.getScopeItem(J.contextId,b);if(!P){L.resultDescription=`Filtered out join invalidation: out of scope type (${b.collectionScopeType}), item id: ${J.id}`,m.info(541173894,v.CoreDefault,L.stop());return}A.addItemToWorkflowList(J,b),L.joinContextId=P.contextId,L.resultDescription=`Input item: ${T.id} (${y.getTypeNameFor(T.body)})`}if(y.getBaseTypesFor(J.body).indexOf(yi.getTypeName())>=0){var D=[].concat((0,ru.default)(J.parentPath),[J.id]),O=!0;for(var $ of(M=b.outputTypes)!==null&&M!==void 0?M:[])if(!r.getContextAnnotations($,tn.LocalWorkflow,D,b.id)){O=!1;break}if(O)return}var F=function q(){var W,K=r.resolveRequestedContexts(b),X=(0,Nr.default)(K,2),re=X[0],se=X[1];if(!re){L.resultDescription=`Required contexts are not ready for ${b.id}. Retrying execution in ${kS} milliseconds...`,m.info(545837259,v.CoreDefault,L.stop()),setTimeout(q,kS);return}if(b.kind===U.SingleItem)t.queueWorkflow({workflowInfo:C,scopeItem:J,inputItems:[J],requestedContexts:se,session:r,orchestrationMode:Er.Internal,triggerReason:qn.InputReceived,onCompleteCallback:t.onWorkflowExecuted.bind(t,J,b,r)}).then(function(){m.info(509154263,v.WorkflowDefault,L.stop())}).catch(function($t){L.resultDescription=$t,m.error(572838111,v.CoreDefault,L.stop())});else if(b.kind===U.Join){var de=T.contextId,ye=A.getScopeItem(de,C.workflow);if(!ye){L.resultDescription=`No scope item for ${b.id} workflow from contextId ${de}`,m.info(526758475,v.CoreDefault,L.stop());return}var He=t.isReadyToEarlyJoin(N,ye.contextId,r.getClientMetadata()),Ct=He?qn.JoinEarlyCompletion:qn.JoinMaxAnnnotation;if(A.isWorkflowReady(ye.contextId,b)||He){var we=(W=t.pendingScopeExecutionNotificationsByWorkflow.get(b.id))===null||W===void 0?void 0:W.get(ye.contextId);if(!we){L.resultDescription=`Workflow ${b.id}, contextId ${ye.contextId}, already queued, skipping new scope execution`,m.info(528048977,v.CoreDefault,L.stop());return}var nt=A.getItemsToExecute(ye.contextId,b);t.queueWorkflow({workflowInfo:C,scopeItem:ye,inputItems:nt,requestedContexts:se,session:r,orchestrationMode:Er.Internal,triggerReason:Ct,onCompleteCallback:t.onWorkflowExecuted.bind(t,ye,b,r)}).then(function(){m.info(509154262,v.WorkflowDefault,L.stop())}).catch(function($t){L.resultDescription=$t,m.error(541173895,v.CoreDefault,L.stop())}),t.pendingScopeExecutionNotificationsByWorkflow.get(b.id).delete(ye.contextId),t.pendingScopeExecutionNotificationsByWorkflow.get(b.id).size===0&&t.pendingScopeExecutionNotificationsByWorkflow.delete(b.id)}}};F()}},c=e;a&&(c=[new ke({parentPath:["session"],items:[{id:"#userContext#",body:new yr}]}),new ke({parentPath:["session"],items:[{id:"#tenantContext#",body:new kr}]})],r.getContextIdManager().applyContextIdOnOperations(c),c=c.concat(e));for(var d of c){var p=y.getTypeNameFor(d);for(var g of d.items){if(r.applyOperationForContext(d,g,tn.Submitted),p===Ge.getTypeName()){(s=this.itemsForDelta)===null||s===void 0||s.delete(d.parentPath.concat(g.id).toString());continue}else if(g.body)if(p===Gt.getTypeName()&&this.deltaHandlers&&this.itemsForDelta){this.handleLocalDeltaUpdate(g,d,r);continue}else(u=this.itemsForDelta)===null||u===void 0||u.set(d.parentPath.concat(g.id).toString(),g);else continue;for(var k of this.workflowsWithoutSessionAffinity)f(k,g,d);for(var S of(l=this.workflowsWithSessionAffinity.get(r))!==null&&l!==void 0?l:[])f(S,g,d)}}}},{key:"handleLocalDeltaUpdate",value:function(e,r,t){var a=new E({operationName:"LocalDeltaUpdate",dimension0:y.getTypeNameFor(e.body),success:!0});a.start();try{var s=this.deltaHandlers.get(y.getTypeNameFor(e.body)),u=this.itemsForDelta.get(r.parentPath.toString());if(s&&u){var l=r.parentPath.length>0?r.parentPath.slice(0,r.parentPath.length-1):r.parentPath,f=s(e.body,u.body);if(f){var c={id:u.id,revId:e.revId,body:f,parentPath:l,delta:e.body,contextId:e.contextId},d=new vr({parentPath:c.parentPath,items:[c]});m.info(539637591,v.CoreDefault,a.stop()),this.runLocalWorkflows([d],t)}else a.success=!1,a.resultDescription="Failed because the handler did not produce valid updated item",m.info(539637592,v.CoreDefault,a.stop())}else a.success=!1,a.resultDescription="Failed due to lack of handler or parent item",m.info(539637593,v.CoreDefault,a.stop())}catch(p){a.success=!1,a.resultDescription=`Failed to apply delta, error: ${p}`,m.info(539637594,v.CoreDefault,a.stop())}}},{key:"createWorkflowImplementation",value:function(e,r){var t=e.factory(),a={workflow:e,workflowLambda:t,initPromise:this.initWorkflow(e.kind,t,r)};return a}},{key:"initWorkflow",value:function(e,r,t){var a=new Ad({model:void 0,clientMetadata:t?t.getClientMetadata():void 0,userContext:t?t.getUserContext():void 0,site:this.site,getTokenCallback:this.getAuthTokenCallback});return e===U.SingleItem?r.init(this.site,a):e===U.Join?r.init(this.site,a):Promise.resolve()}},{key:"queueWorkflow",value:function(e){var r=this;return this.executionTrackersByWorkflowNameBySession.get(e.session).get(e.workflowInfo.workflow.id).setExecutionState(e.scopeItem.contextId,Ce.Running),this.executeLocalWorkflow(e.workflowInfo,e.scopeItem,e.inputItems,e.session,e.requestedContexts,e.orchestrationMode,e.triggerReason).then(function(t){r.processAnnotationResults(t,e.session),e.onCompleteCallback()}).catch(function(t){throw e.onCompleteCallback(),t})}},{key:"processAnnotationResults",value:function(e,r){for(var t of e)r.onAnnotationResults(t,tn.LocalWorkflow,function(){})}},{key:"executeLocalWorkflow",value:function(e,r,t,a,s,u,l){var f=this;return new Promise(function(c,d){var p,g,k,S=[],x=e.workflow,C=new E({operationName:"ExecuteWorkflow",resourceId:x.id,joinContextId:(p=r==null?void 0:r.contextId)!==null&&p!==void 0?p:"",resultDescription:l!=null?l:"",success:!0}).setClientMetadata(a.getClientMetadata());C.start();var T=(g=r==null?void 0:r.contextId)!==null&&g!==void 0?g:t[0].contextId,I=(k=r==null?void 0:r.revId)!==null&&k!==void 0?k:t[0].revId,_=function(){var q=new Map;if(r&&(r.parentPath||m.error(525382231,v.CoreDefault,`Missing scope item parent. Workflow: ${x.id}. Type: ${y.getTypeNameFor(r.body)}`),q.set(r.body,r)),Array.isArray(t))for(var W of t)W&&W.body&&(W.parentPath||m.error(525382232,v.CoreDefault,`Missing parent. Workflow: ${x.id}. Type: ${y.getTypeNameFor(W.body)}`),q.set(W.body,W));return q},M=_(),A=function(q){var W=arguments.length>1&&arguments[1]!==void 0?arguments[1]:C;if(q)return W.success=!1,W.resultDescription+=typeof q=="string"?q:q.message,W.resultSignature="Exception",m.error(572838112,v.CoreDefault,W.stop()),typeof q=="string"?new Error(q):q;m.info(572838113,v.CoreDefault,W.stop())},b=function(q,W,K,X){var re,se=new E({operationName:"SetAnnotations",resourceId:W,joinContextId:(re=r==null?void 0:r.contextId)!==null&&re!==void 0?re:"",success:!0}).setClientMetadata(a.getClientMetadata());se.start();var de=function(mn){m.info(555866112,v.CoreDefault,new Pi({annotationType:W,annotationState:mn,workflowId:e.workflow.id}))};for(var ye of K)ye.metadata=Object.assign(Object.assign({},ye.metadata),{state:Rt.Created}),de(Rt.Created);var He=M.get(q),Ct=y.getTypeNameFor(He.body),we=function(){var mn;if(x.kind===U.SingleItem&&t[0].body!==q){var Fa=`Expected obj to be ${t[0].body} but instead it was ${q}`;A(Fa,se),d(A(Fa));return}var We;if(!Array.isArray(K))We="Workflow produced an invalid annotation array";else if(!x.outputTypes||x.outputTypes.indexOf(W)<0)We=`Workflow said it would output one of [${x.outputTypes}] but instead output ${W}`;else if(!He)We="No item provided";else for(var vn of K)y.matchesTypesFor(vn,[At.getTypeName()])?y.getTypeNameFor(vn)!==W&&(We=`Workflow produced inconsistent annotation types in setAnnotations call (${y.getTypeNameFor(vn)} did not match expected ${W})`):We=`Workflow produced an output that is not an annotation ${y.getTypeNameFor(vn)}`;if(We){A(We,se),d(A(We));return}var mt;if(X&&X.isSessionAnnotation?mt=["session"]:X&&X.ancestorType?mt=He.parentPath:mt=He.parentPath.concat(He.id),u!==Er.External){var gr=[],Mn=[],qa=function(){Rr.metadata=Object.assign(Object.assign({},Rr.metadata),{state:Rt.Sent}),de(Rt.Sent);var hr=Rr.id,Br=hr?(mn=a.getContextAnnotations(W,tn.LocalWorkflow,mt,x.id))===null||mn===void 0?void 0:mn.filter(function(Cu){var ri;return((ri=Cu.body)===null||ri===void 0?void 0:ri.id)==hr}):void 0;(Br==null?void 0:Br.length)==1?Br.length==1?Mn.push({id:Br[0].id,source:x.id,revId:I,body:Rr,contextId:T}):m.error(545837260,v.CoreDefault,`Assert: Multiple existing context annotations with body id ${hr} found for ${W} and local workflow ${x.id}).`):gr.push({id:f.getNextClientAnnotationId(),source:x.id,revId:I,body:Rr,contextId:T})};for(var Rr of K)qa();var ni=[];return gr.length>0&&ni.push(new ke({parentPath:mt,items:gr,parentRevId:I})),Mn.length>0&&ni.push(new Pe({parentPath:mt,items:Mn,parentRevId:I})),new Nt({annotationType:W,ops:ni})}},nt=we();if(!nt){m.info(509644823,v.CoreDefault,se.stop());return}X&&X.immediate?a.onAnnotationResults(nt,tn.LocalWorkflow,function(){}):S.push(nt),(Ct==yr.getTypeName()||Ct==kr.getTypeName()||y.matchesTypesFor(He.body,[Mt.getTypeName(),zn.getTypeName()]))&&a.submitOperationsToSession(nt.ops),m.info(509644822,v.CoreDefault,se.stop())},N=function(q){if(u===Er.External){d(A("NYI"));return}var W=new E({operationName:"submitSignalsAction",resourceId:x.id,success:!0}).setClientMetadata(a.getClientMetadata());for(var K of q){var X=y.getTypeNameFor(K);y.matchesTypesFor(K,[Jt.getTypeName()])||(W.resultDescription=`Workflow produced an output that is not an signal (${y.getTypeNameFor(K)})`,m.info(521413954,v.CoreDefault,W)),(!x.outputTypes||x.outputTypes.indexOf(X)===-1)&&(W.resultDescription=`Workflow said it would output one of [${x.outputTypes}] but instead output ${X}`,m.info(521413953,v.CoreDefault,W)),K.timestamp&&(n.logTimestampUsageByWorkflowId.has(x.id)||(n.logTimestampUsageByWorkflowId.add(x.id),W.resultDescription=`Workflow "${x.id}" sets signal.timeStamp`,m.info(509212803,v.CoreDefault,W)))}var re=q.map(function(de){return{id:f.getNextClientSignalId(),source:x.id,revId:I,body:de,contextId:T}}),se=new ot({parentPath:["session"],parentRevId:I,items:re});a.submitOperations([se])},z=function(q,W,K){var X;switch(K){case wr.JoinContext:{if(!r.contextId){var re="ContextId is not defined for this scope item.";throw m.error(527472289,v.CoreDefault,re),new Error(re)}X=r.contextId;break}case wr.Session:{X=void 0;break}default:{var se="Defined scope is not supported. "+K;throw m.error(527472290,v.CoreDefault,se),new Error(se)}}var de=new rr({definition:W,contextId:X,sourceWorkflowId:x.id,targetWorkflowId:q});a.onWorkflowDefinitionOverrideMessage(de)},L=new Ad({model:new dS(t[0],s),clientMetadata:a.getClientMetadata(),userContext:a.getUserContext(),site:f.site,getTokenCallback:f.getAuthTokenCallback}),J=function(q){A(q?q.message:void 0),q?d(q):c(S)},P={setAnnotations:b,submitSignals:N,done:J,overrideWorkflowDefinition:z,getDynamicAnnotations:void 0,setBillingDomain:void 0},D=e.workflowLambda;if(x.kind===U.SingleItem){t.length!==1&&J(new Error("Single item workflows expect a single input")),L.delta=t[0].delta,L.deltas=t[0].deltas;try{var O=D;e.initPromise||(e.initPromise=O.init(f.site,L)),e.initPromise.then(function(){O.execute(t[0].body,L,P)}).catch(function(F){A(F)})}catch(F){A(F)}}else if(x.kind===U.Join){t.length===0&&J(new Error("Join workflows expect an inputs array")),L.delta=r.delta,L.deltas=r.deltas;try{var $=D;e.initPromise||(e.initPromise=$.init(f.site,L)),e.initPromise.then(function(){$.execute(r.body,t.map(function(F){return F.body}),L,P)}).catch(function(F){A(F)})}catch(F){A(F)}}else A(`Workflow kind ${x.kind} not supported`)})}},{key:"ensureSweepTimer",value:function(e){if(!this.sweepTimers.get(e)){var r=setInterval(this.onSweep.bind(this),this.sweepIntervalMs);this.sweepTimers.set(e,r)}}},{key:"cancelSweepTimer",value:function(e){var r=this.sweepTimers.get(e);this.sweepTimers.get(e)&&(clearInterval(r),this.sweepTimers.delete(e))}},{key:"onSweep",value:function(){this.sweepScopeExecutionNotifications()}},{key:"setScopeExecutionNotification",value:function(e,r,t,a){var s,u,l=Date.now(),f=l+Hl(r.workflow.minDelayMs,1e3),c=l+Hl(r.workflow.maxDelayMs,5e3),d={session:e,workflowImplementation:r,scopeItem:t,startTime:l,minTime:f,maxTime:c,orchestrationMode:a},p=r.workflow.kind===U.Join?t.contextId:d.scopeItem.parentPath.concat(t.id).join("\\");this.pendingScopeExecutionNotificationsByWorkflow.get(r.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(r.workflow.id,new Map);var g=this.pendingScopeExecutionNotificationsByWorkflow.get(r.workflow.id).get(p);if(g){var S=new E({resultDescription:`Duplicated pending scope execution for ${r.workflow.id} at ${p}`,operationName:"LocalScopeExecutionNotification",resourceId:r.workflow.id,joinContextId:(u=t==null?void 0:t.contextId)!==null&&u!==void 0?u:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();m.info(509727899,v.CoreDefault,S.stop())}else{var k=new E({resultDescription:`New pending scope execution for ${r.workflow.id} at ${p}`,operationName:"LocalScopeExecutionNotification",resourceId:r.workflow.id,joinContextId:(s=t==null?void 0:t.contextId)!==null&&s!==void 0?s:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();m.info(539883075,v.CoreDefault,k.stop()),this.pendingScopeExecutionNotificationsByWorkflow.get(r.workflow.id).set(p,d)}this.ensureSweepTimer(e)}},{key:"sweepScopeExecutionNotifications",value:function(){var e=this,r,t,a=new Set(Array.from(this.sweepTimers.keys()));for(var s of Array.from(this.pendingScopeExecutionNotificationsByWorkflow.entries())){var u=(0,Nr.default)(s,2),l=u[0],f=u[1],c=function(T){var I=T.session,_=T.workflowImplementation.workflow,M=T.orchestrationMode,A=I.getWorkflowItemStorage(),b=new E({operationName:"LocalScopeExecutionNotification",resourceId:_.id,joinContextId:(t=(r=T.scopeItem)===null||r===void 0?void 0:r.contextId)!==null&&t!==void 0?t:"",success:!0}).setClientMetadata(I.getClientMetadata()).start(),N=function(){if(_.kind===U.Join){var J=Date.now(),P=T.workflowImplementation.workflow,D=T.scopeItem.contextId,O=I.getWorkflowDefinition(P,D).maxDelayMs;return A.isWorkflowReady(D,P)?(b.resultDescription=`Join Workflow: ${P.id} queuing by maxAnnotation, contextId: ${D}`,m.info(528048978,v.CoreDefault,b.stop()),{isValid:!0,triggerReason:qn.JoinMaxAnnnotation}):T.startTime+O<J?(b.resultDescription=`Join Workflow: ${P.id} queuing by maxTimeout, contextId: ${D}`,m.info(528048979,v.CoreDefault,b.stop()),{isValid:!0,triggerReason:qn.JoinMaxTimeout}):e.isReadyToEarlyJoin(e.executionTrackersByWorkflowNameBySession.get(I).get(P.id),D,I.getClientMetadata())?(m.info(512550856,v.CoreDefault,`Workflow: ${P.id} queuing by early completion, contextId: ${D}, timeout: ${O}`),{isValid:!0,triggerReason:qn.JoinEarlyCompletion}):{isValid:!1,triggerReason:qn.Unknown}}return{isValid:!0,triggerReason:qn.Unknown}},z=function(){var J=N(),P=J.isValid,D=J.triggerReason;if(!P)return!1;var O=I.resolveRequestedContexts(_),$=(0,Nr.default)(O,2),F=$[0],q=$[1];if(!F)return!1;try{if(_.kind===U.Join){var W=T.scopeItem.contextId,K=A.getScopeItem(W,_);if(K){var X=A.getItemsToExecute(K.contextId,_);if(X.length===0)return b.resultDescription=`Failed to retrieve items for workflow: ${_.id}, contextId: ${W}, skipping execution`,m.info(527472291,v.CoreDefault,b.stop()),e.onWorkflowExecuted(K,_,I),!0;e.queueWorkflow({workflowInfo:T.workflowImplementation,scopeItem:K,inputItems:X,requestedContexts:q,session:I,orchestrationMode:M,triggerReason:D,onCompleteCallback:e.onWorkflowExecuted.bind(e,K,_,I)}).catch(function(re){b.success=!1,b.resultDescription=re.message,m.error(509092189,v.CoreDefault,b.stop())})}else b.resultDescription="ContextId no longer exists, skipping workflow execution",m.info(539883076,v.CoreDefault,b.stop())}else b.resultDescription=`Workflow in type ${_.kind} is not supported`,m.error(539883077,v.CoreDefault,b.stop())}catch(re){b.resultDescription=`Trying to execute ${_.id} caused an exception: ${re}`,m.warn(539883078,v.CoreDefault,b.stop())}return!0};z()?(e.pendingScopeExecutionNotificationsByWorkflow.get(l).delete(g),e.pendingScopeExecutionNotificationsByWorkflow.get(l).size===0&&e.pendingScopeExecutionNotificationsByWorkflow.delete(l)):a.delete(I)};for(var d of Array.from(f.entries())){var p=(0,Nr.default)(d,2),g=p[0],k=p[1];c(k)}}if(a.size!==0)for(var S of Array.from(a)){var x=new E({resultDescription:"No pending scope notifications left, cancelling sweep timer",operationName:"LocalScopeExecutionNotification",success:!0}).start();m.debug(539883079,v.CoreDefault,x.stop()),this.cancelSweepTimer(S)}}},{key:"onExternalWorkflowExecuted",value:function(e,r,t){var a={id:"",parentPath:[],contextId:e},s={id:r};this.onWorkflowExecuted(a,s,t,!1)}},{key:"onWorkflowExecuted",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,s;(s=this.executionTrackersByWorkflowNameBySession.get(t).get(r.id))===null||s===void 0||s.afterWorkflowExecution(e.contextId),a&&r.kind===U.Join&&t.getWorkflowItemStorage().onWorkflowExecuted(e,r)}}]),n}();h();var BS=w(R()),WS=w(B());h();var bS=w(R()),ES=w(B());h();var _S=w(R()),AS=w(B());h();var xS=w(R()),TS=w(B());var IS=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500;(0,xS.default)(this,n),this.bufferingTimeMs=500,this.workflowIdToSequencersMap=new Map,this.bufferingTimeMs=o}return(0,TS.default)(n,[{key:"create",value:function(e){if(!e.ownerId)return null;var r=this.workflowIdToSequencersMap.get(e.ownerId);return r||(r=new Vo(this.bufferingTimeMs),this.workflowIdToSequencersMap.set(e.ownerId,r)),r}}]),n}();var $M=function(n,o,e,r){function t(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(c){try{f(r.next(c))}catch(d){s(d)}}function l(c){try{f(r.throw(c))}catch(d){s(d)}}function f(c){c.done?a(c.value):t(c.value).then(u,l)}f((r=r.apply(n,o||[])).next())})},MS=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500,e=arguments.length>1?arguments[1]:void 0;(0,_S.default)(this,n),this.sequencerFactory=e!=null?e:new IS(o)}return(0,AS.default)(n,[{key:"sequence",value:function(e){var r;return $M(this,void 0,void 0,function*(){var t=(r=e==null?void 0:e.M_)===null||r===void 0?void 0:r.seq;if(t!=null){var a=this.sequencerFactory.create(e);a&&(yield a.sequence(e.M_.seq))}})}}]),n}();var NS=function(){function n(o){(0,bS.default)(this,n),this.annotationSequencer=o!=null?o:new MS}return(0,ES.default)(n,[{key:"process",value:function(e,r,t,a){var s=this,u=[],l=function(d){var p=[];if(d!=null&&d.items){var g=function(x){var C=s.annotationSequencer.sequence(x.body).then(function(){r(d,x)});p.push(C)};for(var k of d.items)g(k)}u.push(Promise.all(p).then(function(){t(d,e.cv)}))};for(var f of e.ops)l(f);Promise.all(u).then(function(){return a(e)})}}]),n}();h();var DS=w(R()),PS=w(B()),RS=function(){function n(){(0,DS.default)(this,n)}return(0,PS.default)(n,[{key:"process",value:function(e,r,t,a){for(var s of e.ops){if(s!=null&&s.items)for(var u of s.items)r(s,u);t(s,e.cv)}a(e)}}]),n}();var OS=function(){function n(o,e,r){(0,BS.default)(this,n),this.isOrderingEnabled=o,this.orderedAnnotationResultsProcessor=e!=null?e:new NS,this.unorderedAnnotationResultsProcessor=r!=null?r:new RS}return(0,WS.default)(n,[{key:"process",value:function(e,r,t,a){this.isOrderingEnabled()?this.orderedAnnotationResultsProcessor.process(e,r,t,a):this.unorderedAnnotationResultsProcessor.process(e,r,t,a)}}]),n}();var GM=30,ou=function(){return FS().version},iu=function(){function n(o,e,r){var t=this;(0,qS.default)(this,n),this.sessionsByDocSessionId=new Map,this.isDeltaGeneratorEnabled=!1,this.disableSyncDeltaSending=!1,this.hasBeenInitialized=!1,this.settings={annotationsOrderingEnabled:!0,deltaOperationsEnabled:!1,checkIdbByFeatures:!1,defaultBatchingEnabled:!0,batchingWith20msIntervalEnabled:!0,onAnnotationsSubmittedEnabled:!1,httpFallbackEnabled:!1,reduceBatchOperationsEnabled:!1,batchMessagesEnabled:!1,dynamicRateControllerEnabled:!1,useRequestAuthToken:!0,removeDuplicateFlights:!0},this.isDownloaderCompatible=function(){if(t.settings.checkIdbByFeatures)return typeof Array!="undefined"&&typeof Array.from!="undefined"&&typeof URL!="undefined"&&typeof URL.createObjectURL!="undefined";if(typeof navigator!="undefined"&&navigator.userAgent){var s=navigator.userAgent;return!(!s.indexOf||s.indexOf("MSIE ")>0||s.indexOf("Trident/")>0)}else return!1},this.workerFactory=o||function(s){return s&&s===be.HttpFallback?new ms:new Ml};var a=this.createDefaultSessionManagerFactory();this.sessionManagerFactory=function(){return(e==null?void 0:e.apply(void 0,arguments))||a.apply(void 0,arguments)},this.sessionFactory=r||function(s){return new Aa(s)}}return(0,$S.default)(n,[{key:"init",value:function(e,r,t,a){var s=this,u,l,f,c,d,p,g,k,S,x,C=new E({operationName:"InitRuntime",resourceId:sn(e),dimension1:this.hasBeenInitialized.toString()});C.start(),this.hasBeenInitialized=!0,this.hostCallbacks=t,this.clientMetadata=r,this.clientMetadata&&(this.clientMetadata.runtimeVersion=ou()),this.shouldAddLogger(C)?(m.addLogger(new zr(this.hostCallbacks)),this.addLoggingAggregator(a)):(m.clearLoggers(),m.addLogger(new zr(this.hostCallbacks))),n.haveCalledInit=!0,this.annotationResultsProcessor=new OS(function(){return s.settings.annotationsOrderingEnabled}),this.inferenceServiceFactory=a.inferenceServiceFactory,C.dimension2=is(wt.info).toString();var T=[];e&&(this.defaultServiceUrl=me.convertServiceUrlToWebSocket(e),this.serviceProtocol=this.defaultServiceUrl.split(":")[0].toLowerCase()),T.push(this.isFeatureEnabled("CheckIdbByFeatures",!1).then(function(M){s.settings.checkIdbByFeatures=M})),T.push(this.isFeatureEnabled("AnnotationsOrderingEnabled",!0).then(function(M){s.settings.annotationsOrderingEnabled=M})),T.push(this.isFeatureEnabled("DefaultBatchingDisabled").then(function(M){var A;(A=s.settings).defaultBatchingEnabled&&(A.defaultBatchingEnabled=!M)})),T.push(this.isFeatureEnabled("HttpFallbackEnabled").then(function(M){var A;(A=s.settings).httpFallbackEnabled||(A.httpFallbackEnabled=M)})),T.push(this.isFeatureEnabled("BatchingWith20msIntervalDisabled").then(function(M){var A;(A=s.settings).batchingWith20msIntervalEnabled&&(A.batchingWith20msIntervalEnabled=!M)})),T.push(this.isFeatureEnabled("OnAnnotationsSubmittedDisabled").then(function(M){var A;(A=s.settings).onAnnotationsSubmittedEnabled&&(A.onAnnotationsSubmittedEnabled=!M)})),T.push(this.isFeatureEnabled("ReduceBatchOperationsEnabled").then(function(M){var A;(A=s.settings).reduceBatchOperationsEnabled||(A.reduceBatchOperationsEnabled=M)})),T.push(this.isFeatureEnabled("BatchMessagesEnabled").then(function(M){var A;(A=s.settings).batchMessagesEnabled||(A.batchMessagesEnabled=M)})),T.push(this.isFeatureEnabled("DynamicRateControllerEnabled").then(function(M){s.settings.dynamicRateControllerEnabled=M}));var I={enableDeltas:!1,enableEarlyJoin:!1};T.push(Promise.all([this.isFeatureEnabled("DeltaOperationsEnabled").then(function(M){return I.enableDeltas=M}).catch(function(){return I.enableDeltas=!1}),this.isFeatureEnabled("EarlyJoinCompletionEnabled").then(function(M){return I.enableEarlyJoin=M}).catch(function(){return I.enableEarlyJoin=!1})]).then(function(){s.localWorkflowManager=new CS(a.modelDownloader&&s.isDownloaderCompatible()?a.modelDownloader:void 0,s.inferenceServiceFactory,I)}));var _=go((u=r.flights)!==null&&u!==void 0?u:"");return this.isDeltaGeneratorEnabled=_.getBooleanValue("Microsoft.Office.WordOnline.AugloopDeltas",(l=a.isDeltaGeneratorEnabled)!==null&&l!==void 0?l:!1),this.disableSyncDeltaSending=_.getBooleanValue("Microsoft.Office.WordOnline.DisableSyncDeltaSending",(f=a.disableSyncDeltaSending)!==null&&f!==void 0?f:!1),this.syncDeltaTimeout=_.getIntValue("Microsoft.Office.WordOnline.SyncDeltaTimeout",a.syncDeltaTimeout),(c=this.settings).httpFallbackEnabled||(c.httpFallbackEnabled=_.getBooleanValue("Microsoft.Office.WordOnline.Augloop.HttpFallbackEnabled",!1)),(d=this.settings).defaultBatchingEnabled&&(d.defaultBatchingEnabled=!_.getBooleanValue("DefaultBatchingDisabled",!1)),(p=this.settings).batchingWith20msIntervalEnabled&&(p.batchingWith20msIntervalEnabled=!_.getBooleanValue("BatchingWith20msIntervalDisabled",!1)),(g=this.settings).reduceBatchOperationsEnabled||(g.reduceBatchOperationsEnabled=_.getBooleanValue("ReduceBatchOperationsEnabled",!1)),(k=this.settings).batchMessagesEnabled||(k.batchMessagesEnabled=_.getBooleanValue("BatchMessagesEnabled",!1)),(S=this.settings).useRequestAuthToken&&(S.useRequestAuthToken=_.getBooleanValue("UseRequestAuthToken",!0)),(x=this.settings).removeDuplicateFlights&&(x.removeDuplicateFlights=_.getBooleanValue("RemoveDuplicateFlights",!0)),C.setDataField("Flights",JSON.stringify(this.settings)),a&&a.networkMode&&(a.networkMode===be.HttpFallback&&(a.networkMode=this.settings.httpFallbackEnabled?be.HttpFallback:be.JSWebSockets),this.networkMode=a.networkMode,a.networkMode===be.LocalWorkflowsOnly&&(this.sessionManagerFactory=function(){return new Mr})),a&&a.loggableUrls&&_l(a.loggableUrls),Promise.all(T).then(function(){s.batchOptions=a.batchOptions,!s.batchOptions&&s.settings.defaultBatchingEnabled&&(s.batchOptions={delayMs:1,maxInputSize:1e6,delayMsMax:50},s.settings.batchingWith20msIntervalEnabled&&(s.batchOptions.delayMs=20)),s.batchOptions&&!s.batchOptions.delayMsMax&&(s.batchOptions.delayMsMax=50),C.dimension0=JSON.stringify(s.batchOptions),s.logOperation(C,!0)}).catch(function(M){s.logOperation(C,!1,"Error",M?M.message:"(no error)")})}},{key:"getServiceProtocol",value:function(){return this.serviceProtocol}},{key:"registerLocalWorkflow",value:function(e){this.localWorkflowManager.registerLocalWorkflow(e)}},{key:"flushTelemetry",value:function(e){m.flushAggregators(e)}},{key:"createSession",value:function(e){var r,t=e&&e.docSessionId?e.docSessionId:an(),a=e&&e.documentId?e.documentId:void 0,s=this.sessionsByDocSessionId.get(t),u=new E({operationName:"CreateSession",resourceId:t,dimension1:this.hasBeenInitialized.toString()});if(u.start(),s&&s.isClosed===!1)throw this.logOperation(u,!1,"Error","docSessionId already exists"),new Error("docSessionId already exists");var l=e?(r=e.serviceUrl)!==null&&r!==void 0?r:this.defaultServiceUrl:this.defaultServiceUrl;l=me.convertServiceUrlToWebSocket(l),l||(e=e||{},e.networkMode=be.LocalWorkflowsOnly),this.networkMode&&!(e&&e.networkMode)&&(e=e||{},e.networkMode=this.networkMode),e&&e.networkMode===be.HttpFallback&&(e.networkMode=this.settings.httpFallbackEnabled?be.HttpFallback:be.JSWebSockets);var f=Object.assign({},this.clientMetadata);f.docSessionId=t,a&&(f.documentId=a),e&&e.flights&&(f.flights=f.flights?f.flights+";"+e.flights:e.flights),this.settings.removeDuplicateFlights&&f.flights&&(f.flights=Bc(f.flights)),u.setDataField("Flights",f.flights||"");var c=this.sessionFactory({hostCallbacks:this.hostCallbacks,sessionManager:this.sessionManagerFactory(f,l,e),batchOptions:this.batchOptions,extensionConfigs:(e==null?void 0:e.extensionConfigs)||[],clientMetadata:f,userContext:e?e.userContext:void 0,localWorkflowManager:e&&e.enableComplexLocalWorkflows?void 0:this.localWorkflowManager,annotationResultsProcessor:this.annotationResultsProcessor,localRegisteredWorkflows:(e==null?void 0:e.localRegisteredWorkflows)||[],enableRemoteExecutionNotification:(e==null?void 0:e.enableRemoteExecutionNotification)||!1,networkMode:e==null?void 0:e.networkMode,egress:e?e.egress:void 0,isDeltaGeneratorEnabled:this.isDeltaGeneratorEnabled,onAnnotationsSubmittedEnabled:this.settings.onAnnotationsSubmittedEnabled,disableSyncDeltaSending:this.disableSyncDeltaSending,syncDeltaTimeout:this.syncDeltaTimeout,reduceBatchOperationsEnabled:this.settings.reduceBatchOperationsEnabled,batchMessagesEnabled:this.settings.batchMessagesEnabled});return this.sessionsByDocSessionId.set(t,c),e&&e.onSessionConnect&&c.setConnectCallback(e.onSessionConnect),e&&e.onSessionDisconnect&&c.setDisconnectCallback(e.onSessionDisconnect),e&&e.onSessionReconnect&&c.setReconnectCallback(e.onSessionReconnect),e&&e.onSessionClose&&c.setSessionCloseCallback(e.onSessionClose),e&&e.onServerAuthenticationStateChangeCallback&&c.setServerAuthenticationStateChangeCallback(e.onServerAuthenticationStateChangeCallback),e&&e.onClaimsChallengeCallback&&c.setClaimsChallengeCallback(e.onClaimsChallengeCallback),this.logOperation(u,!0),c.initialize?c.initialize():Promise.resolve(c)}},{key:"getSessionManagerFactory",value:function(){return this.sessionManagerFactory}},{key:"shouldAddLogger",value:function(e){if(n.haveCalledInit){var r=new Error("Runtime already initialized");return e.dimension3=r.stack,e.dimension2=is(wt.info).toString(),this.logOperation(e,!1,"Error",r.message),!1}else return!0}},{key:"createDefaultSessionManagerFactory",value:function(){var e=this;return function(r,t,a){if(a&&a.enableComplexLocalWorkflows)throw new Error("NYI");if(a&&a.networkMode==be.LocalWorkflowsOnly)return new Mr;var s=new dr,u=new Ma,l=function(){m.error(573321615,v.CoreDefault,"Unexpectedly not set sendMessage")},f=new Ea(function(){return u},r,s,function(d,p,g){l(d,p,g)},{getAuthToken:e.settings.useRequestAuthToken?void 0:e.getAuthToken.bind(e,r.docSessionId),requestAuthToken:e.settings.useRequestAuthToken?e.hostCallbacks.requestAuthToken:void 0,overrideSessionInitMessage:e.hostCallbacks.overrideSessionInitMessage,enableRemoteExecutionNotification:(a==null?void 0:a.enableRemoteExecutionNotification)||!1}),c=new nf(me.convertServiceUrlToWebSocket(t),u,e.workerFactory,f,r,s,e.settings,a==null?void 0:a.networkMode);return l=c.sendMessage.bind(c),c.on("disconnect",function(){return s.clearRefreshTimeouts()}),c.on("connect",function(d,p,g,k){d&&e.hostCallbacks.setSessionData&&e.hostCallbacks.setSessionData(p,g,k)}),c}}},{key:"getAuthToken",value:function(e){var r={Tickets:[],TokenType:Vn.Augloop};return e&&(r.DocSessionId=e),this.hostCallbacks.requestAuthToken(r).then(function(t){if(t)return t.Token}).catch(function(){})}},{key:"isFeatureEnabled",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"None";return me.isFeatureEnabled(this.hostCallbacks,e,r,t)}},{key:"logOperation",value:function(e,r,t,a){e.stop(),e.success=r,e.resultSignature=t,e.resultDescription=a,m.info(573321622,v.CoreDefault,e)}},{key:"addLoggingAggregator",value:function(e){var r,t,a,s;me.isChangeGateEnabled(this.hostCallbacks,"AggregateInProductionOnly")&&this.clientMetadata.releaseAudienceGroup==="Dogfood"||(m.addAggregator(Ro("Operation","operationName",["ExecuteBatch","ReduceBatchOperations","ProcessResponse","LocalDeltaUpdate","ApplyFormattedTextTileDeltaForLocalWorkflows","ApplyTextTileDeltaForLocalWorkflows","FindRangeForDelta","RunModelForInferencing","GetResource","CreateTextTileDeltaFromItem","NetworkEgressControl","HttpEgress","LongPollNoOp","NetworkRateControllerAbandonedSyncMessage","NetworkRateControllerEgress","NetworkRateControllerQueueItem","NetworkRateControllerOnRateLimitResponse","NetworkRateControllerOnRateLimitError","NetworkRateControllerRateLimitsSet","NetworkRateControllerQueueItem"],(r=e.telemetryAggregationIntervalSec)!==null&&r!==void 0?r:GM)),m.addAggregator(Ro("Operation","operationName",["ExecuteWorkflow","ExecuteLambda","EarlyJoinCompletion","OnLongPollMessage","OnAnnotationResultsEgress"],(t=e.telemetryAggregationIntervalSec)!==null&&t!==void 0?t:60)),m.addAggregator(Ro("Operation","operationName",["LocalScopeExecutionNotification","RunLocalWorkflows","EarlyJoinCompletion","SetAnnotations","WIS.addItemOnContextIdList","WIS.setScopeItem"],(a=e.telemetryAggregationIntervalSec)!==null&&a!==void 0?a:120)),m.addAggregator(Ro("SessionHealth","sessionHealthEventName",["SendMessage","ProcessMessage"],(s=e.telemetryAggregationIntervalSec)!==null&&s!==void 0?s:60)))}},{key:"uninitialize",value:function(){this.flushTelemetry(!0),this.hostCallbacks=null,this.hasBeenInitialized=!1,n.haveCalledInit=!1,m.clearAggregators(),m.clearLoggers()}}]),n}(),au=new iu;h();var GS=w(R()),US=w(B()),HS=function(){function n(){(0,GS.default)(this,n),this.cache=new Map}return(0,US.default)(n,[{key:"setReduceTimer",value:function(e,r,t){var a=this,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:function(){return!1},l=arguments.length>5&&arguments[5]!==void 0?arguments[5]:5e3;this.cache.has(e)||this.cache.set(e,new Map);var f=this.cache.get(e);f.has(r)&&clearTimeout(f.get(r).timer);var c=function(){var p=f.get(r),g=Date.now()-p.start;u()&&g<l?p.timer=setTimeout(p.timerCallback,Math.min(s,l-g)):(f.size>1?f.delete(r):a.cache.delete(e),t())};f.set(r,{start:Date.now(),timerCallback:c,timer:setTimeout(c,s)})}},{key:"clear",value:function(e,r){this.cache.forEach(function(t,a){(!e||e===a)&&t.forEach(function(s,u){(!r||r===u)&&clearTimeout(s.timer)})}),this.cache.clear()}}]),n}();h();h();var zS=w(B()),VS=w(R());var su=function(){function n(){var o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:33e5;(0,VS.default)(this,n),this.tokenCache=new Map,this.requestMap=new Map,this.requestRecordMap=new Map,this.tokenExpirationMs=o}return(0,zS.default)(n,[{key:"updateAuthToken",value:function(e,r){var t=this,a=JSON.stringify(r),s=this.requestRecordMap.get(a);return(s===void 0||this.isTokenExpired(s))&&(s={requestPromise:e.requestAuthToken(r).then(function(u){if(!u||!u.Token)throw new Error(`No token available for request ${a}`);t.tokenCache.set(a,u.Token)}),requestTime:me.getCurrentTimeMs()},this.requestRecordMap.set(a,s)),s.requestPromise}},{key:"getAuthTokenEntries",value:function(e,r){var t=this;return Array.from(this.tokenCache.keys()).map(function(a){var s=t.requestMap.get(a);return s===void 0&&(s=JSON.parse(a),t.requestMap.set(a,s)),{requestKey:a,request:s}}).filter(function(a){var s=a.request;return r?s.DocId===r:!0}).map(function(a){var s=a.requestKey,u=a.request;return t.isTokenExpired(t.requestRecordMap.get(s))&&t.updateAuthToken(e,u),{ticket:u.Tickets[0],token:t.tokenCache.get(s)}})}},{key:"isTokenExpired",value:function(e){return me.getCurrentTimeMs()>e.requestTime+this.tokenExpirationMs}}]),n}();var uu,Md=function(){uu=new su};Md();var QS=function n(o,e,r,t,a,s,u,l,f,c){var d={method:"POST",headers:{"content-type":"application/json","X-CorrelationId":a},body:JSON.stringify({payload:e.payload,payloadSchema:r,requestedSchema:t,clientMetadata:s,tokens:uu.getAuthTokenEntries(u,f.docId)})};Hr(o,d,function(p,g){p?c(new Error(`Fetch error in remote lambda request to ${o}: ${p}`)):g.status===401?l>0?(m.info(572838109,v.CoreDefault,"Auth token required for remote lambda request"),g.json().then(function(k){return uu.updateAuthToken(u,{Tickets:[k],DocId:f.docId})}).then(function(){n(o,e,r,t,a,s,u,l-1,f,c)}).catch(function(k){c({exceptionType:xe.Authentication,message:k.message})})):c({exceptionType:xe.Authentication,message:"Remote lambda request retry with authentication token failed"}):g.ok?g.json().then(function(k){if(!Array.isArray(k))c(new Error("Did not receive a valid response for remote lambda request"));else if(k.length>0){var S=0;for(var x of k)e.moreResults=++S<k.length,c(null,x)}else c(new Error("No output"))}).catch(function(k){c({exceptionType:xe.LambdaThrow,message:k.message})}):c(new Error(`Remote lambda request failed with status ${g.status}`))})},JS=function(o,e,r,t,a,s,u,l,f){Array.isArray(l.authTickets)?uu.updateAuthToken(u,{Tickets:l.authTickets,DocId:l.docId}).then(function(){QS(o,e,r,t,a.id,s,u,1,l,f)}).catch(function(c){f({exceptionType:xe.Authentication,message:c.message})}):QS(o,e,r,t,a.id,s,u,1,l,f)};h();h();var jS=w(R()),KS=w(B()),XS=w(Al());var ei=function(){function n(){(0,jS.default)(this,n),this.hasBeenOpened=!1,this.hadEgressError=!1,this.lastEgressTime=0,this.lastPongTime=0,this.remainingPingFailures=3,this.egressMessageCount=0,this.egressByteCount=0,this.isClosing=!1,this.pendingEgress=[]}return(0,KS.default)(n,[{key:"init",value:function(e,r,t,a){var s=this;this.ws=new XS.default(e),this.logOp=new E({operationName:n.className,success:!0,dimension1:"V1"}).start(),this.egressTimer=Date.now(),this.egressMessageCountOp=new E({operationName:"WSEgressMessageCount",success:!0,dimension1:"V1"}),this.egressByteCountOp=new E({operationName:"WSEgressByteOrderOfMagnitude",success:!0,dimension1:"V1"}),this.ingressByteCountOp=new E({operationName:"WSIngressByteOrderOfMagnitude",success:!0,dimension1:"V1"});var u=function(f){s.logPingLatencyOp&&(s.logPingLatencyOp.success=f,m.info(507789790,v.CoreDefault,s.logPingLatencyOp.stop()),s.logPingLatencyOp=void 0)};this.ws.addEventListener("open",function(l){t(),n.logCountLimiter.log(function(){s.logOp.resourceId="OnOpen",s.logOp.resultDescription="",s.logOp.success=!0,s.logOp.dimension0=s.pendingEgress.length.toString(),m.info(507789789,v.CoreDefault,s.logOp.stop())}),s.hasBeenOpened=!0,s.pendingEgress.forEach(function(f){s.egress({obj:f})}),s.pendingEgress=[],s.pingInterval=setInterval(function(){s.logPingLatencyOp&&(--s.remainingPingFailures,u(!1)),s.remainingPingFailures>0&&s.hasBeenOpened&&s.lastPongTime<s.lastEgressTime&&(s.logPingLatencyOp=new E({operationName:"Ping",success:!0,dimension0:s.ws.bufferedAmount>=0?s.ws.bufferedAmount.toString().length.toString():void 0,dimension1:"V1"}).start(),s.ws.send(n.pingPongMessage,function(f){f&&(--s.remainingPingFailures,u(!1))}))},3e4)}),this.ws.addEventListener("message",function(l){s.logPingLatencyOp&&typeof l.data=="string"&&l.data.length===1&&l.data[0]===n.pingPongMessage?(u(!0),s.lastPongTime=Date.now()):(s.logIngressCount(l.data),r(l.data))}),this.ws.addEventListener("error",function(l){s.errorMessage=l.message,n.logCountLimiter.log(function(){s.logOp.resourceId="OnError",s.logOp.resultDescription=s.errorMessage,s.logOp.success=!1,m.info(507789788,v.CoreDefault,s.logOp.stop())}),s.ws.close()}),this.ws.addEventListener("close",function(l){n.logCountLimiter.log(function(){s.logOp.resourceId="OnClose",s.logOp.resultDescription=l?`code: ${l.code}. reason: ${l.reason}`:"",s.logOp.success=!0,m.info(507789787,v.CoreDefault,s.logOp.stop())}),s.pingInterval&&(clearInterval(s.pingInterval),s.pingInterval=void 0),a(s.errorMessage),s.isClosing=!1})}},{key:"egress",value:function(e){var r=this,t=e.obj;this.logEgressCount(t instanceof ArrayBuffer||t instanceof Uint8Array?t.byteLength:t.length),this.lastEgressTime=Date.now(),this.hasBeenOpened?this.ws.send(t,function(a){a&&!r.hadEgressError&&(r.hadEgressError=!0,n.logCountLimiter.log(function(){r.logOp.resourceId="OnFirstEgressError",r.logOp.resultDescription=a.message,r.logOp.success=!1,m.info(507789786,v.CoreDefault,r.logOp.stop())}))}):this.pendingEgress.push(t)}},{key:"close",value:function(){this.isClosing||(this.isClosing=!0,this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0),this.ws.close())}},{key:"logEgressCount",value:function(e){var r=Date.now(),t=r-this.egressTimer;t>1e3&&(this.egressMessageCount>50&&(this.egressMessageCountOp.start(),this.egressMessageCountOp.resultDescription="Egress message count: "+this.egressMessageCount.toString()+", Buffered amount: "+(this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+t.toString(),m.info(507789785,v.CoreDefault,this.egressMessageCountOp.stop())),this.egressByteCount>1e5&&(this.egressByteCountOp.start(),this.egressByteCountOp.dimension2=this.egressByteCount.toString().length.toString(),this.egressMessageCountOp.resultDescription="Buffered amount: "+(this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+t.toString(),m.info(507789784,v.CoreDefault,this.egressByteCountOp.stop())),this.egressTimer=r,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=e!=null?e:0}},{key:"logIngressCount",value:function(e){var r=e.length;r>1e5&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=r.toString().length.toString(),m.info(507789783,v.CoreDefault,this.ingressByteCountOp.stop()))}}]),n}();ei.className="WebSocketWorker";ei.logCountLimiter=new eo(ei.className);ei.pingPongMessage="~";h();var bd=w(R()),Ed=w(B());var HM=function(){function n(o,e,r,t,a,s){(0,bd.default)(this,n),this.requestId=o,this.correlationId=e,this.schemaName=r,this.data=t,this.callback=a,this.requestTimeoutInMs=s,this.ended=!1,this.startTime=0}return(0,Ed.default)(n,[{key:"startRequest",value:function(){this.startTime=me.getCurrentTimeMs()}},{key:"getMsUntilTimeout",value:function(){var e=me.getCurrentTimeMs()-this.startTime;return this.requestTimeoutInMs-e}},{key:"endRequest",value:function(e){this.ended||(this.invokeCallback(null,e,!0),this.ended=!0)}},{key:"addResponseData",value:function(e){this.invokeCallback(e,null,!1)}},{key:"invokeCallback",value:function(e,r,t){var a=this;new Promise(function(){return a.callback(e,r,t)}).catch(function(s){})}}]),n}(),YS=function(){function n(o,e,r){(0,bd.default)(this,n),this.requestCounter=0,this.activeRequests=[],this.pendingRequests=[],this.requestTimeoutInMs=o,this.workerFactory=e,this.maxActiveRequests=r}return(0,Ed.default)(n,[{key:"testConnection",value:function(e,r){var t=this,a=!1,s=new E({cv:new Qe().toString(),operationName:"WebSocketTest",resourceId:sn(e),success:!0}).start();return new Promise(function(u){var l=me.createHealthCheckRequest(r);e?t.addRequest(e,l,s.cv,"HealthCheckRequest",function(f,c,d){c&&(s.success=!1,s.resultSignature="Error",s.resultDescription=c.message||c),f&&f.status==="OK"&&(a=!0),d&&(s.success&&!a&&(s.success=!1,s.resultSignature="NoResponseData"),m.info(556617949,v.CoreDefault,s.stop()),u(s.success))}):(s.success=!1,s.resultSignature="EmptyUrl",m.info(557641870,v.CoreDefault,s.stop()),u(s.success))})}},{key:"addRequest",value:function(e,r,t,a,s){var u=(this.requestCounter++).toString(),l=new HM(u,t,a,r,s,this.requestTimeoutInMs);this.getWorker(e),this.pendingRequests.push(l),this.egressPendingRequests()}},{key:"egressPendingRequests",value:function(){for(;this.pendingRequests.length>0&&this.activeRequests.length<this.maxActiveRequests;){var e=this.pendingRequests.shift();if(this.activeRequests.push(e),this.activeRequests.length===1){var r=e.getMsUntilTimeout();setTimeout(this.onTimeout.bind(this),r)}e.startRequest(),this.worker&&this.worker.egress({obj:this.createRequestMessage(e.data,e.requestId,e.correlationId)})}}},{key:"createRequestMessage",value:function(e,r,t){return JSON.stringify({correlationId:t,requestId:r,body:e})}},{key:"onTimeout",value:function(){for(;this.activeRequests.length>0;){var e=this.activeRequests[0],r=e.getMsUntilTimeout();if(r<=0){var t=new Error("Request timed out");e.endRequest(t),this.activeRequests.shift(),this.egressPendingRequests()}else{setTimeout(this.onTimeout.bind(this),r);return}}}},{key:"onMessage",value:function(e){try{for(var r=JSON.parse(e),t=0;t<this.activeRequests.length;t++){var a=this.activeRequests[t];if(a.requestId===r.requestId){r.end?(this.activeRequests.splice(t,1),a.endRequest(r.error),this.egressPendingRequests()):r.body&&a.addResponseData(r.body);break}}}catch(s){m.error(557641871,v.CoreDefault,s)}}},{key:"onClose",value:function(e){var r=new Error(`Connection closed: ${e}`);for(var t of this.activeRequests)t.endRequest(r);this.activeRequests=[];for(var a of this.pendingRequests)a.endRequest(r);this.pendingRequests=[],this.worker=void 0}},{key:"getWorker",value:function(e){return this.worker||(this.worker=this.workerFactory(),this.worker.init(e,this.onMessage.bind(this),function(){},this.onClose.bind(this))),this.worker}}]),n}();var zM=3e4,VM=50,lu,Nd=function(){lu=new su};Nd();var eC=new YS(zM,function(){return new ei},VM),ZS=function n(o,e,r,t,a,s,u,l,f,c){var d={payload:e.payload,payloadSchema:r,requestedSchema:t,clientMetadata:s,tokens:lu.getAuthTokenEntries(u,f.docId)},p="";t&&t.schema&&(p=t.schema.name);var g=!1;eC.addRequest(o,d,a,p,function(k,S,x){if(!g)if(g=!0,S!=null)if(S.exceptionType===xe.Authentication)try{var C=JSON.parse(S.data);l>0?(m.info(572838108,v.CoreDefault,"Auth token required for remote lambda WebSocket request"),lu.updateAuthToken(u,{Tickets:[C],DocId:f.docId}).then(function(){n(o,e,r,t,a,s,u,l-1,f,c)}).catch(function(T){c({exceptionType:xe.Authentication,message:T.message})})):c({exceptionType:xe.Authentication,message:"Remote lambda request retry with authentication token failed"})}catch(T){c({exceptionType:xe.Authentication,message:T.message})}else c(new Error(`Error in remote lambda WebSocket request to ${o}: ${S}`));else e.moreResults=!1,c(null,k)})},tC=function(o,e,r,t,a,s,u,l,f){Array.isArray(l.authTickets)?lu.updateAuthToken(u,{Tickets:l.authTickets,DocId:l.docId}).then(function(){ZS(o,e,r,t,a.id,s,u,1,l,f)}).catch(function(c){f({exceptionType:xe.Authentication,message:c.message})}):ZS(o,e,r,t,a.id,s,u,1,l,f)},nC=function(o,e){return eC.testConnection(o,e)};h();var rC=w(R()),oC=w(B()),iC=function(){function n(){(0,rC.default)(this,n),this.cache=new Map,this.bucketSizes=new Map}return(0,oC.default)(n,[{key:"setBucketSize",value:function(e,r){this.bucketSizes.set(e,r)}},{key:"setResult",value:function(e,r,t){if(r.primary){var a=this.cache.get(e);a||(a=new Map,this.cache.set(e,a));var s=a.get(r.primary);if(s||(s=r.secondary?new Map:[],a.set(r.primary,s)),r.secondary){var u=s;u.set(r.secondary,t)}else{var l=s;l.length==this.getBucketSize(e)&&l.shift(),l.push(t)}}}},{key:"getResults",value:function(e,r){var t=this.cache.get(e);if(t){var a=t.get(r.primary);if(a){if(!r.secondary)return a;var s=Array.from(a.values());if(s.length>0)return s}}return[]}},{key:"clear",value:function(e,r){r?this.cache.forEach(function(t,a){if(!e||e===a)if(r.secondary){var s=t.get(r.primary);s&&s.delete(r.secondary)}else t.delete(r.primary)}):e?this.cache.delete(e):this.cache.clear()}},{key:"getBucketSize",value:function(e){return this.bucketSizes.get(e)||10}}]),n}();h();var ae;(function(n){n[n.Unknown=0]="Unknown",n[n.Local=1]="Local",n[n.Custom=2]="Custom",n[n.Remote=3]="Remote",n[n.BatchedRemote=4]="BatchedRemote"})(ae||(ae={}));h();var aC=w(R()),sC=w(B());var uC=function(){function n(){(0,aC.default)(this,n),this.throttleInfoMap=new Map}return(0,sC.default)(n,[{key:"execute",value:function(e,r,t){var a=this;if(!r.throttleSettings.shouldBeThrottled||!(r.throttleSettings.throttlingInterval>0))t();else{var s=this.getWorkflowThrottleInfo(r.name);if(s.currentTileId==null)s.currentTileId=e,s.timeOfPreviousStartedEvent=me.getCurrentTimeMs(),t();else if(s.currentTileId===e){var u=me.getCurrentTimeMs(),l=this.delayTime(s,u,r.throttleSettings.throttlingInterval);l>0?(s.latestCallback=t,s.lastTimeout==null&&(s.lastTimeout=setTimeout(function(){var f=a.getWorkflowThrottleInfo(r.name);f.lastTimeout=void 0,f.timeOfPreviousStartedEvent=me.getCurrentTimeMs(),f.latestCallback()},l))):(s.timeOfPreviousStartedEvent=u,t())}else s.lastTimeout!=null&&(clearTimeout(s.lastTimeout),s.latestCallback(),s.lastTimeout=void 0),s.currentTileId=e,s.timeOfPreviousStartedEvent=me.getCurrentTimeMs(),t()}}},{key:"delayTime",value:function(e,r,t){var a=r-e.timeOfPreviousStartedEvent;return Math.max(t-a,0)}},{key:"getWorkflowThrottleInfo",value:function(e){var r=this.throttleInfoMap.get(e);return r||(r={currentTileId:void 0,timeOfPreviousStartedEvent:-1,latestCallback:function(){},lastTimeout:void 0},this.throttleInfoMap.set(e,r)),r}}]),n}();var $n;(function(n){n[n.Restricted=0]="Restricted",n[n.Unrestricted=1]="Unrestricted",n[n.Suppressed=2]="Suppressed"})($n||($n={}));var Dd=function(){function n(){(0,Pd.default)(this,n),this.canaryTextTileEventSubmittedByDocSessionId=new Set,this.stateByDocSessionId=new Map,this.executionQueueByDocSessionId=new Map,this.executionCountByDocSessionId=new Map}return(0,Rd.default)(n,[{key:"getOutputSchema",value:function(){return this.lambdas[this.lambdas.length-1].outputSchema}},{key:"scheduleExecution",value:function(e,r){var t=this.docSessionIdExtractor?this.docSessionIdExtractor(e):void 0,a=this.getStateForDocSessionId(t);if(a===$n.Restricted){var s=this.getExecutionQueueForDocSessionId(t);s.push(r),s.length===1&&r()}else a===$n.Unrestricted?r():$n.Suppressed}},{key:"onStart",value:function(e){this.incrementExecutionCountForDocSessionId(e)}},{key:"onFinish",value:function(e,r){if(this.decrementExecutionCountForDocSessionId(e),r===xe.Authentication)this.stateByDocSessionId.set(e,$n.Suppressed),this.executionQueueByDocSessionId.delete(e);else if(this.stateByDocSessionId.get(e)===$n.Restricted){var t=this.getExecutionQueueForDocSessionId(e);if(t.shift(),r===void 0){this.stateByDocSessionId.set(e,$n.Unrestricted),this.executionQueueByDocSessionId.delete(e);for(var a of t)a()}else if(t.length>0){var s=t[0];s()}}}},{key:"onRefresh",value:function(e){this.stateByDocSessionId=new Map,this.triggerOnRefresh&&(e?(this.executionQueueByDocSessionId.delete(e),this.executionCountByDocSessionId.delete(e)):(this.executionQueueByDocSessionId=new Map,this.executionCountByDocSessionId=new Map)),this.canaryTextTileEventSubmittedByDocSessionId.delete(e)}},{key:"getStateForDocSessionId",value:function(e){var r=this.stateByDocSessionId.get(e);return r===void 0&&(r=n.executionQueuesEnabled?$n.Restricted:$n.Unrestricted,this.stateByDocSessionId.set(e,r)),r}},{key:"getExecutionQueueForDocSessionId",value:function(e){var r=this.executionQueueByDocSessionId.get(e);return r===void 0&&(r=[],this.executionQueueByDocSessionId.set(e,r)),r}},{key:"incrementExecutionCountForDocSessionId",value:function(e){var r=this.executionCountByDocSessionId.get(e)||0;this.executionCountByDocSessionId.set(e,r+1)}},{key:"decrementExecutionCountForDocSessionId",value:function(e){var r=this.executionCountByDocSessionId.get(e)||0;r<=1?this.executionCountByDocSessionId.delete(e):this.executionCountByDocSessionId.set(e,r-1)}}]),n}();Dd.executionQueuesEnabled=!0;var Dr=function(o){return{category:Dn.Schema,schema:{name:o}}},Da="Tiling.TextTileEvent",Bd="ClpSlideTile",JM=function(o,e){return o===Da&&e&&e.type==Qn.TextTileEventType.Delete||o===Bd&&e&&e.eventType==wi.SlideTileEventType.Delete},fC=function(o,e){return o===Da&&e&&e.type==Qn.TextTileEventType.Refresh},cC=function(o,e){return o===Bd&&e&&e.eventType==wi.SlideTileEventType.Refresh},lC=function(o,e){return fC(o,e)||cC(o,e)},jM=function(o,e){var r,t;return fC(o,e)?(t=(r=e.tile)===null||r===void 0?void 0:r.metadata)===null||t===void 0?void 0:t.seqnoCLPRefresh:(cC(o,e),-1)},fu=function(o,e){var r,t;if(o===Da)return(t=(r=e.tile)===null||r===void 0?void 0:r.metadata)===null||t===void 0?void 0:t.docSessionId;if(o===Bd)return e.docId},KM=function(o){return{type:o.type,tile:{metadata:{docSessionId:o.tile.metadata.docSessionId,docId:o.tile.metadata.docId,seqnoCLPRefresh:o.tile.metadata.seqnoCLPRefresh,tileId:"A56B3127DBDFD0D6"},elements:[{text:"B91153AE828B4E48"}]}}},XM=function(){function n(){(0,Pd.default)(this,n),this.inputSchemasToWorkflows=new Map,this.inputSchemasToReduceWorkflows=new Map,this.reduceWorkflowsGroupingKeyExtractors=new Map,this.defaultWorkflowOptions={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},triggerOnRefresh:!1},this.resultCache=new iC,this.reduceTimerCache=new HS,this.lookupTableCache=new Map,this.throttling=new uC,this.lastTileRefreshSeq=-1,this.lastTileRefreshSeqByDocSessionId=new Map,this.tileRefreshByDocSessionIdEnabled=!0}return(0,Rd.default)(n,[{key:"init",value:function(e,r,t){var a=this,s=new E({operationName:"InitRuntimeALv1",resourceId:sn(e)});s.start(),this.clientMetadata=r,this.clientMetadata&&(this.clientMetadata.runtimeVersion=ou()),this.hostCallbacks=t;var u=[];return u.push(this.isFeatureEnabled("DisableWebSocket").then(function(l){var f=!l;if(!f)return!1;var c=["Outlook Mac","Outlook Win32","PowerPoint Mac","PowerPoint Web","PowerPoint Win32","Word Mac","Word Win32"];return c.indexOf(`${r.appName} ${r.appPlatform}`)>=0?nC(me.convertServiceUrlToWebSocket(e),a.clientMetadata):!0}).then(function(l){e&&(a.serviceUrl=l?me.convertServiceUrlToWebSocket(e):e,a.executeRemoteLambda=l?tC:JS,a.clearRemoteLambdaTokenCache=l?Nd:Md,a.serviceProtocol=a.serviceUrl.split(":")[0].toLowerCase())})),u.push(this.isFeatureEnabled("WorkflowQueuesDisabled").then(function(l){Dd.executionQueuesEnabled=!l})),u.push(this.isFeatureEnabled("TileRefreshByDocSessionIdDisabled").then(function(l){a.tileRefreshByDocSessionIdEnabled=!l})),Promise.all(u).then(function(){a.logOperation(s,!0)}).catch(function(l){a.logOperation(s,!1,"Error",l?l.message:"(no error)")})}},{key:"getServiceProtocol",value:function(){return this.serviceProtocol}},{key:"registerSchemas",value:function(e,r){return Promise.resolve()}},{key:"registerSimpleLocalWorkflow",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.defaultWorkflowOptions;return r.source=r.source||ae.Custom,this.registerHardcodedWorkflow(e,[r],this.inputSchemasToWorkflows,t)}},{key:"registerSimpleRemoteWorkflow",value:function(e,r,t,a){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions,u=[];return r&&(r.source=ae.Custom,u.push(r)),t.source=t.func?ae.Custom:ae.Remote,u.push(t),a&&(a.source=ae.Custom,u.push(a)),this.registerHardcodedWorkflow(e,u,this.inputSchemasToWorkflows,s)}},{key:"registerMultipleLambdasWorkflow",value:function(e,r){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.defaultWorkflowOptions;return this.registerHardcodedWorkflow(e,r,this.inputSchemasToWorkflows,t)}},{key:"registerReduceWorkflow",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions;return this.reduceWorkflowsGroupingKeyExtractors.set(r.inputSchema,t),this.resultCache.setBucketSize(r.inputSchema,a),r.source=r.source||ae.Custom,this.registerHardcodedWorkflow(e,[r],this.inputSchemasToReduceWorkflows,s)}},{key:"registerMultipleLambdasReduceWorkflow",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions;return this.reduceWorkflowsGroupingKeyExtractors.set(r[0].inputSchema,t),this.resultCache.setBucketSize(r[0].inputSchema,a),this.registerHardcodedWorkflow(e,r,this.inputSchemasToReduceWorkflows,s)}},{key:"submit",value:function(e,r,t){this.submitToWorkflows(e,r,t,this.inputSchemasToWorkflows)}},{key:"getGroupingKey",value:function(e,r,t){var a=this.reduceWorkflowsGroupingKeyExtractors.get(t);if(a==null)throw new Error("Reduce workflow does not have a grouping extractor");return a(r,e)}},{key:"submitToWorkflows",value:function(e,r,t){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:this.inputSchemasToWorkflows;if(this.hostCallbacks){var s;t?s=Qe.fromString(t):s=new Qe,this.handleTileRefresh(e,r,s);var u=a.get(e)||[];for(var l of u)lC(e,r)&&!l.triggerOnRefresh||(l.useCanaryTextTile&&e===Da&&!l.canaryTextTileEventSubmittedByDocSessionId.has(fu(e,r))&&(this.submitToWorkflow(Da,KM(r),s,l,a),l.canaryTextTileEventSubmittedByDocSessionId.add(fu(e,r))),this.submitToWorkflow(e,r,s,l,a))}}},{key:"submitToWorkflow",value:function(e,r,t,a,s){var u=this,l={messageType:wn.Input,correlationVector:t.newChild(),payload:r,payloadSchema:Dr(a.lambdas[0].inputSchema),clientMetadata:this.clientMetadata},f=new E({cv:l.correlationVector.toString(),operationName:"ExecuteWorkflow",resourceId:a.name});f.setClientMetadata(this.clientMetadata),f.start(),a.scheduleExecution(r,function(){try{if(!l.payload||!l.payload.tile||!l.payload.tile.metadata||!l.payload.tile.metadata.tileId)u.executeWorkflow(f,l,r,a,e,s);else{var c=l.payload.tile.metadata.tileId;u.throttling.execute(c,a,function(){return u.executeWorkflow(f,l,r,a,e,s)})}}catch(d){f.success=!1,f.resultSignature="ExecuteException",f.resultDescription=d?d.message:"(no error)",m.error(559290447,v.CoreDefault,f.stop())}})}},{key:"handleTileRefresh",value:function(e,r,t){var a=this;if(lC(e,r)){var s=this.tileRefreshByDocSessionIdEnabled?fu(e,r):void 0,u=jM(e,r);if(this.tileRefreshByDocSessionIdEnabled){var l=this.lastTileRefreshSeqByDocSessionId.get(s);if(l>=0&&u<=l)return}else if(u<=this.lastTileRefreshSeq)return;var f=new E({cv:t.toString(),operationName:"TileRefresh",resultDescription:"",success:!0});if(f.start(),this.tileRefreshByDocSessionIdEnabled&&!s){f.success=!1,f.resultDescription="NoDocSessionId",m.info(559290448,v.CoreDefault,f.stop());return}this.inputSchemasToReduceWorkflows.forEach(function(p,g){p.some(function(k){return k.triggerOnRefresh})&&(a.tileRefreshByDocSessionIdEnabled?(a.resultCache.clear(g,{primary:s}),a.resultCache.clear(a.getForcedDocLevelSchema(g),{primary:s}),a.reduceTimerCache.clear(g,s)):(a.resultCache.clear(g),a.resultCache.clear(a.getForcedDocLevelSchema(g)),a.reduceTimerCache.clear(g)),p.some(function(k){return!k.triggerOnRefresh})&&(f.resultDescription+="X_"),f.resultDescription+=g+" ")}),this.clearRemoteLambdaTokenCache();var c=[];this.inputSchemasToWorkflows.forEach(function(p){return c.push.apply(c,(0,Na.default)(p))}),this.inputSchemasToReduceWorkflows.forEach(function(p){return c.push.apply(c,(0,Na.default)(p))});for(var d of c)this.tileRefreshByDocSessionIdEnabled?d.onRefresh(s):d.onRefresh();this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.set(s,u):this.lastTileRefreshSeq=u,m.info(559290449,v.CoreDefault,f.stop())}}},{key:"executeWorkflow",value:function(e,r,t,a,s,u){var l=this,f=a.docIdExtractor?a.docIdExtractor(r.payload):void 0,c=a.docSessionIdExtractor(t),d=this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.get(c):this.lastTileRefreshSeq;a.onStart(c);var p=function(k){var S=l.tileRefreshByDocSessionIdEnabled?l.lastTileRefreshSeqByDocSessionId.get(c):l.lastTileRefreshSeq;if(a.triggerOnRefresh&&S!==d){e.success=!0,e.resultSignature="TileRefreshIgnore",m.info(559290450,v.CoreDefault,e.stop());return}var x=k.messageType==wn.Exception&&k.payload.exceptionType==xe.NoOutput,C=x&&a.canProduceNullResult,T=C?a.lambdas[a.lambdas.length-1].outputSchema:k.payloadSchema.schema.name,I=C?null:k.payload;k.messageType===wn.Input||C?(a.shouldSendResultsToHost&&(u===l.inputSchemasToReduceWorkflows?l.hostCallbacks.onResult("Reduce.Input",t,T,I):l.hostCallbacks.onResult(s,t,T,I)),e.success=!0,e.resultSignature=x?"NoOutput":"ValidOutput"):x?(e.success=!0,e.resultSignature="NoOutput"):(e.success=!1,e.resultSignature="Exception",e.resultDescription=Gr(k)),u!==l.inputSchemasToReduceWorkflows&&l.updateResultCacheForReduceWorkflows(s,t,T,I,k.correlationVector.toString()),k.moreResults||(e.stop(),m.info(559290451,v.CoreDefault,e),a.onFinish(c,k.payload&&k.payload.exceptionType?kg(k):void 0))};a.preExecutionPromise.then(function(){for(var g={lookupTable:l.lookupTableCache.get(a.name),docId:f,docSessionId:c},k=p,S=a.lambdas.length-1;S>=0;S--)k=l.createLambdaExecutionStep(a.name,a.lambdas[S],g,k,p);k(r)})}},{key:"getForcedDocLevelSchema",value:function(e){return`~${e}`}},{key:"updateResultCacheForReduceWorkflows",value:function(e,r,t,a,s){var u=this,l=this.inputSchemasToReduceWorkflows.get(t);if(l){var f;e==="docSessionId"?(f=this.getGroupingKey(e,r,t),this.resultCache.setResult(this.getForcedDocLevelSchema(t),f,a),f.secondary="*"):(f=this.getGroupingKey(e,r,t),JM(e,r)&&f.primary!=null&&f.secondary!=null?this.resultCache.clear(void 0,f):this.resultCache.setResult(t,f,a));var c=l.some(function(k){return k.deferReduceUntilIdle}),d=[];this.inputSchemasToWorkflows.forEach(function(k){return d.push.apply(d,(0,Na.default)(k.filter(function(S){return S.getOutputSchema()===t})))});var p=function(){return c&&d.some(function(S){return S.executionCountByDocSessionId.get(f.primary)>0})},g=l.map(function(k){return k.deferReduceUntilIdleMaxDelayMs||0}).reduce(function(k,S){return Math.max(k,S)});this.reduceTimerCache.setReduceTimer(t,f.primary,function(){var k=u.resultCache.getResults(t,f);if(k.push.apply(k,(0,Na.default)(u.resultCache.getResults(u.getForcedDocLevelSchema(t),{primary:f.primary}))),Array.isArray(k)){var S={id:f.primary,values:k,isReduceInput:!0};u.submitToWorkflows(t,S,s,u.inputSchemasToReduceWorkflows)}else m.error(559290452,v.CoreDefault,`Cached results have unexpected type "${typeof k}"`)},500,p,g)}}},{key:"isFeatureEnabled",value:function(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"None";return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled("Microsoft.Office.AugLoop."+e,t).catch(function(){return Promise.resolve(r)}):Promise.resolve(r)}},{key:"areLicenseFeaturesEnabled",value:function(e){return this.hostCallbacks&&this.hostCallbacks.areLicenseFeaturesEnabled?this.hostCallbacks.areLicenseFeaturesEnabled(e).catch(function(){return Promise.resolve(!1)}):Promise.resolve(!1)}},{key:"isWorkflowEnabled",value:function(e,r,t,a,s){var u=this,l=r.some(function(c){return c.source===ae.Remote||c.source===ae.BatchedRemote});if(l){if(!this.serviceUrl)return s.resultDescription="Disabled because no service URL available for remote workflow",Promise.resolve(!1);if(this.clientMetadata&&this.clientMetadata.privateMode&&r.some(function(c){return(c.source===ae.Remote||c.source===ae.BatchedRemote)&&!c.canRunInPrivateMode}))return s.resultDescription="Disabled because we are running in private mode",Promise.resolve(!1)}(!this.clientMetadata||this.clientMetadata.appPlatform!=="Mac"&&this.clientMetadata.appPlatform!=="Win32")&&(a=!0,s.resultDescription="Enabled by default due to platform name");var f;return a?f=Promise.resolve(!0):f=this.isFeatureEnabled("WorkflowEnabled."+e),f.then(function(c){return c?u.isFeatureEnabled("WorkflowDisabled."+e).then(function(d){return d?(s.resultDescription="Disabled because explicitly disabled",!1):t?u.areLicenseFeaturesEnabled(t).then(function(p){return p||(s.resultDescription="Disabled because license check failed"),p}):!0}):(s.resultDescription="Disabled because not explicitly enabled",!1)})}},{key:"registerHardcodedWorkflow",value:function(e,r){var t=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.inputSchemasToWorkflows,s=arguments.length>3?arguments[3]:void 0;if(!e||e.length>40)throw new Error("Workflow name has invalid length");if(new RegExp(/^[A-Z][a-zA-Z0-9_]+$/).test(e)===!1)throw new Error("Workflow name has invalid format");a.forEach(function(l){if(l.some(function(f){return f.name===e}))throw new Error("Workflow name already registered.")});var u=new E({operationName:"WorkflowRegistration",resourceId:e,success:!0});return u.setClientMetadata(this.clientMetadata),u.start(),this.isWorkflowEnabled(e,r,s.licenseFeatures,s.enabledByDefault,u).then(function(l){if(u.resultSignature=l?"Enabled":"Disabled",u.stop(),m.info(559290453,v.CoreDefault,u),l){var f=r[0].inputSchema,c=a.get(f);c||(c=[],a.set(f,c));var d=Promise.resolve();s.lookupTableLambda&&(d=new Promise(function(g,k){var S=new Qe,x={messageType:wn.Input,correlationVector:S,payloadSchema:Dr(s.lookupTableLambda.inputSchema),clientMetadata:t.clientMetadata,payload:{}},C=function(_){_.messageType===wn.Input&&_.payload&&t.lookupTableCache.set(e,_.payload),g()},T=t.createLambdaExecutionStep("",s.lookupTableLambda,{},C,C);T(x)}));var p=new Dd;p.name=e,p.lambdas=r,p.canProduceNullResult=s.canProduceNullResult,p.shouldSendResultsToHost=s.shouldSendResultsToHost,p.triggerOnRefresh=s.triggerOnRefresh,p.throttleSettings=s.throttleSettings||t.defaultWorkflowOptions.throttleSettings,p.docIdExtractor=s.docIdExtractor,p.docSessionIdExtractor=function(g){return g.isReduceInput?g.id:fu(f,g)},p.deferReduceUntilIdle=s.deferReduceUntilIdle,p.deferReduceUntilIdleMaxDelayMs=s.deferReduceUntilIdleMaxDelayMs,p.useCanaryTextTile=s.useCanaryTextTile,p.preExecutionPromise=d,c.push(p)}})}},{key:"logOperation",value:function(e,r,t,a){e.stop(),e.success=r,e.resultSignature=t,e.resultDescription=a,m.info(559290454,v.CoreDefault,e)}},{key:"handleLambdaError",value:function(e,r,t,a,s){e.exceptionType!=null?Zn(r,e):e instanceof Error?Zn(r,{exceptionType:a,message:e.message}):Zn(r,{exceptionType:xe.Unknown,message:e?e.toString():void 0}),this.logOperation(t,!1,"Exception",Gr(r)),s(r)}},{key:"handleLambdaOutput",value:function(e,r,t,a,s,u){e&&e.exceptionType!==xe.NoOutput?e.exceptionType!=null?this.handleLambdaError(e,r,t,e.exceptionType,u):e instanceof Error?this.handleLambdaError(e,r,t,xe.LambdaErrorCallback,u):(r.payload=e,r.payloadSchema=Dr(a),this.logOperation(t,!0),s(r)):(Zn(r,{exceptionType:xe.NoOutput}),this.logOperation(t,!0,"NoOutput"),u(r))}},{key:"executeCustomLambdaStep",value:function(e,r,t,a,s,u){var l=this;if(t.func==null)Zn(e,{exceptionType:xe.LambdaThrow,message:"No lambda function set"}),this.logOperation(r,!1,"Error",Gr(e)),u(e);else{var f=function(p){l.handleLambdaOutput(p,e,r,t.outputSchema,s,u)},c=function(p,g){l.handleLambdaOutput(p,e,r,g,u,u)};try{t.func(e.payload,t.config,a,f,c)}catch(d){this.handleLambdaError(d,e,r,xe.LambdaThrow,u)}}}},{key:"executeLocalLambdaStep",value:function(e,r,t,a,s){var u=this;this.hostCallbacks.executeLocalLambda==null?(Zn(e,{exceptionType:xe.LambdaThrow,message:"No local lambda host callback set"}),this.logOperation(r,!1,"Error",Gr(e)),s(e)):this.hostCallbacks.executeLocalLambda(t.inputSchema,e.payload,t.outputSchema).then(function(l){u.handleLambdaOutput(l,e,r,t.outputSchema,a,s)}).catch(function(l){u.handleLambdaError(l,e,r,xe.LambdaThrow,s)})}},{key:"executeRemoteLambdaStep",value:function(e,r,t,a,s,u){var l=this;if(this.serviceUrl){r.resourceId+=`.${this.serviceProtocol}`;var f=function(S,x){S?l.handleLambdaError(S,e,r,S.exceptionType||xe.LambdaErrorCallback,u):l.handleLambdaOutput(x,e,r,t.outputSchema,s,u)};if(a.authTickets=t.authTickets,t.source===ae.Remote)this.executeRemoteLambda(this.serviceUrl,e,Dr(t.inputSchema),Dr(t.outputSchema),e.correlationVector,this.clientMetadata,this.hostCallbacks,a,f);else{this.batchedRemoteLambdaManager||(this.batchedRemoteLambdaManager=new Po(function(k,S,x){var C=S.context,T=C.remoteLambda,I=C.lambdaContext;l.executeRemoteLambda(l.serviceUrl,{messageType:wn.Input,correlationVector:{id:S.cv},payload:k,payloadSchema:Dr(T.inputSchema),clientMetadata:l.clientMetadata},Dr(T.remoteInputSchema),Dr(T.remoteOutputSchema),{id:S.cv},l.clientMetadata,l.hostCallbacks,I,x)},!1,!1,function(k,S,x){var C,T=x.lambdaContext;l.updateResultCacheForReduceWorkflows("docSessionId",(C=T.docSessionId)!==null&&C!==void 0?C:T.docId,k,S)}));var c=t.batchOptions,d=this.normalizeBatchOptions(c),p=d.groupingKeyExtractor;d.groupingKeyExtractor=function(k){return`${t.name}-${p(k)}`};var g={name:t.name,remoteLambda:t,lambdaContext:a};this.batchedRemoteLambdaManager.addBatchItem(e.payload,d,g,e.correlationVector.id.length>127?e.correlationVector.id.substring(0,127)+"!":e.correlationVector.id,void 0,f)}}else Zn(e,{exceptionType:xe.LambdaThrow,message:"No URL for remote lambda"}),this.logOperation(r,!1,"Error",Gr(e)),u(e)}},{key:"createLambdaExecutionStep",value:function(e,r,t,a,s){var u=this;return function(l){var f=new E({cv:l.correlationVector.toString(),operationName:"ExecuteLambda",resourceId:r.name,dimension0:e});f.start(),r.source===ae.Custom?u.executeCustomLambdaStep(l,f,r,t,a,s):r.source===ae.Local?u.executeLocalLambdaStep(l,f,r,a,s):r.source===ae.Remote||r.source===ae.BatchedRemote?u.executeRemoteLambdaStep(l,f,r,t,a,s):(Zn(l,{exceptionType:xe.LambdaThrow,message:"Unknown/No lambda location set"}),u.logOperation(f,!1,"Error",Gr(l)),s(l))}}},{key:"normalizeBatchOptions",value:function(e){if(!e)throw new Error("Expected batchConfig");var r=Object.assign({},e);return e.estimateSize||(r.estimateSize=fs),r}}]),n}(),ct=new XM;h();var NC=w(R()),DC=w(B());h();h();var yC=w(R()),kC=w(B()),wC=w(ze()),SC=w(Ve()),Od=w(Oe()),CC=w(Rn());h();var dC=w(R()),pC=w(B()),gC=w(Ao()),hC=w(ze()),mC=w(Ve()),Wd=w(Oe());function YM(n){var o=ZM();return function(){var r=(0,Wd.default)(n),t;if(o){var a=(0,Wd.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,mC.default)(this,t)}}function ZM(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var vC=function(n){(0,hC.default)(e,n);var o=YM(e);function e(r){var t;return(0,dC.default)(this,e),t=o.call(this,{messageIdPrefix:"s",responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}),t.session=r,t.setEgress(t.egressToSession.bind((0,gC.default)(t))),t}return(0,pC.default)(e,[{key:"egressToSession",value:function(t,a){var s=this;if(y.getTypeNameFor(t)===fn.getTypeName()){var u=t.annotationType,l=t.config;this.session.activateAnnotation(u,{config:l,callback:function(d){s.ingress(new Nt({annotationType:u,ops:[d]}),function(){})}}).then(function(){s.ingress(new Fe({messageId:t.messageId}),function(){}),a()}).catch(function(c){a(c)})}else if(y.getTypeNameFor(t)===Je.getTypeName())this.session.close(),a();else if(y.getTypeNameFor(t)===Be.getTypeName()){var f=t;f.seq===0?this.session.submitSeedOperations(f.ops):this.session.submitOperations(f.ops),this.ingress(new Fe({messageId:t.messageId}),function(){}),a()}}}]),e}(Fo);function eb(n){var o=tb();return function(){var r=(0,Od.default)(n),t;if(o){var a=(0,Od.default)(this).constructor;t=Reflect.construct(r,arguments,a)}else t=r.apply(this,arguments);return(0,SC.default)(this,t)}}function tb(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(n){return!1}}var Ld=function(n){(0,wC.default)(e,n);var o=eb(e);function e(r,t,a){var s;return(0,yC.default)(this,e),s=o.call(this),s.messageCallbacksByMessageType=new Map,s.messageIdPrefix="c",s.nextMessageId=1,s.upstreamMessageEndpoint=new Fo({messageIdPrefix:s.messageIdPrefix,responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}),s.sessionInitializer=r,s.tokenRefreshManager=t,s.serverSessionFactory=a,s}return(0,kC.default)(e,[{key:"init",value:function(t,a,s){var u=this;return this.serverSessionFactory().then(function(l){u.upstreamMessageEndpoint.setEgress(function(p,g){var k=function(C){g(C?new Error(C.error):void 0)},S=u.messageCallbacksByMessageType.get(y.getTypeNameFor(p));S?S(p,function(x,C){C?(C.messageId=p.messageId,u.upstreamMessageEndpoint.ingress(C,k)):k(x)}):s&&s(p,g)});var f=new Sc,c=new yv(function(){return new Zm(f)}),d=new Jp({log:function(){}});u.downstreamMessageEndpoint=new vC(l),u.session=new Ew("FakeSessionKey"+e.nextSessionKey++,{upstreamMessageEndpoint:u.upstreamMessageEndpoint,downstreamMessageEndpoint:u.downstreamMessageEndpoint,cache:c},d),u.sessionInitializer.on("connect",function(p,g,k,S,x,C){u.emit("connect",p,k,S,x,C)}),u.sessionInitializer.initSession({isTokenRefresh:!1,onResponse:function(g,k){s&&(g||k)&&s(g||k,function(){})}})})}},{key:"sendMessage",value:function(t,a,s){y.getTypeNameFor(t)?(t.messageId||(t.messageId=`${this.messageIdPrefix}${this.nextMessageId++}`),this.upstreamMessageEndpoint.ingress(t,a||function(){})):a&&a(new Y({messageId:t.messageId,error:"Dropped invalid message"}))}},{key:"sendBytes",value:function(t){throw new Error("NYI")}},{key:"onMessage",value:function(t,a){if(this.messageCallbacksByMessageType.has(t))throw new Error(`Cannot register another ${t} callback`);this.messageCallbacksByMessageType.set(t,a)}},{key:"getCorrelationVector",value:function(){return new Qe}},{key:"forceReconnect",value:function(t){throw new Error("NYI")}},{key:"closeSession",value:function(){this.session&&this.session.onClose(Ar.MastermindShutdown,new Je,function(){}),this.tokenRefreshManager.clearAllTimeouts()}}]),e}(CC.EventEmitter);Ld.nextSessionKey=0;h();var xC=w(R()),TC=w(B());var IC=function(){function n(o,e){(0,xC.default)(this,n),this.sessionManager=o,this.egress=e,this.workflowRequestCallbackMap=new Map,this.sessionManager.onMessage(no.getTypeName(),this.onWorkflowExecutionRequest.bind(this))}return(0,TC.default)(n,[{key:"setWorkflowRequestCallback",value:function(e,r){if(this.workflowRequestCallbackMap.has(e.id))throw new Error(`Duplicate workflow ${e.id} registered`);this.workflowRequestCallbackMap.set(e.id,r)}},{key:"onAnnotationResult",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onChatStoreMessagesSet",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onChatStoreMessagesGet",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onMessage",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onWorkflowModelRequest",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onFetchRangeFromCacheRequest",value:function(e,r){return this.sendMessageAsync(e)}},{key:"onWorkflowExecutionRequest",value:function(e,r){var t=this.workflowRequestCallbackMap.get(e.workflowId);if(!t){if(this.egress){this.egress(e,function(u){u?r(new Y({messageId:e.messageId,error:u.message})):r()});return}throw new Error(`Cannot execute unknown workflow ${e.workflowId}`)}var a,s;t(e).then(function(u){s=u}).catch(function(u){a=new Y({messageId:e.messageId,error:u.stack})}).then(function(){r(a,s)})}},{key:"sendMessageAsync",value:function(e){var r=this;return new Promise(function(t,a){r.sessionManager.sendMessage(e,function(s,u){s?a(s.error?new Error(s.error):s):t(u)})})}}]),n}();h();var _C=w(R()),AC=w(B()),MC=function(){function n(){(0,_C.default)(this,n)}return(0,AC.default)(n,[{key:"create",value:function(){return{validate:function(){return!0}}}}]),n}();var bC=function(o){var e=new iu(void 0,function(r,t,a){if(a&&!a.enableComplexLocalWorkflows)return o&&o.networkMode===be.LocalWorkflowsOnly?new Mr:void 0;var s=new dr,u=new Ld(new Ea(function(){return new Ma},r,s,function(l,f){u.sendMessage(l,f)}),s,function(){return e.createSession({docSessionId:`${r.docSessionId}-Server`,serviceUrl:t})});return u},function(r){return r.localWorkflowManager||(r.workflowRuntimeFactory=function(t){var a=function(){return{}};return new By(new IC(t,r.egress),new Map,new Map,a,new MC)}),new Aa(r)});return e};var pr;(function(n){n.InitMessageAlreadyReceived="InitMessageAlreadyReceived",n.UnknownBridgeId="UnknownBridgeId",n.UnknownDocSessionId="UnknownDocSessionId",n.InitNotStarted="InitNotStarted"})(pr||(pr={}));var EC=function(o){return new Error(`Runtime${o}`)},Fd=function(o){return new Error(`Session${o}`)},PC=function(){function n(){(0,NC.default)(this,n),this.optionsByBridgeId=new Map,this.runtimesByBridgeId=new Map,this.sessionsByBridgeIdAndDocSessionId=new Map}return(0,DC.default)(n,[{key:"initBridge",value:function(e){if(this.optionsByBridgeId.has(e.bridgeId))throw new Error(`Bridge ${e.bridgeId} already exists`);this.optionsByBridgeId.set(e.bridgeId,e)}},{key:"closeBridge",value:function(e){if(!this.optionsByBridgeId.delete(e))throw new Error(`Bridge ${e} does not exist`);this.runtimesByBridgeId.delete(e),this.sessionsByBridgeIdAndDocSessionId.delete(e)}},{key:"ingress",value:function(e,r,t){var a=this,s;try{typeof t=="string"?s=JSON.parse(t):s=dn.deserialize(t)}catch(u){this.egressResponse(e,void 0,new Y({error:"FailedBridgeMessageParse: "+(u==null?void 0:u.message)}),r);return}Yi.typeGuard(s)?this.onRuntimeInitMessage(e,r,s):this.afterRuntimeInit(e,function(u){if(u){a.egressResponse(e,s.messageId,new Y({error:u.message}),r);return}gt.typeGuard(s)?a.onSessionInitMessage(e,r,s):r&&a.onSessionIngress(e,r,s)})}},{key:"afterRuntimeInit",value:function(e,r){var t=this.runtimesByBridgeId.get(e);if(!t){r(EC(pr.UnknownBridgeId));return}if(!t.runtimeInitPromise){r(EC(pr.InitNotStarted));return}if(t.runtimeInitialized){r(void 0,t.runtime);return}var a;t.runtimeInitPromise.catch(function(s){a=s}).then(function(){r(a,t.runtime)})}},{key:"afterSessionInit",value:function(e,r,t){var a=this.sessionsByBridgeIdAndDocSessionId.get(e);if(!a){t(Fd(pr.UnknownBridgeId));return}var s=a.get(r);if(!s){t(Fd(pr.UnknownDocSessionId));return}if(!s.sessionInitPromise){t(Fd(pr.InitNotStarted));return}if(s.sessionInitialized){t(void 0,s.session);return}var u;s.sessionInitPromise.catch(function(l){u=l}).then(function(){t(u,s.session)})}},{key:"onRuntimeInitMessage",value:function(e,r,t){var a=this,s=this.runtimesByBridgeId.get(e);if(s){this.egressResponse(e,t.messageId,new Y({error:`Runtime${pr.InitMessageAlreadyReceived}`}),r);return}s={runtimeInitialized:!1},this.runtimesByBridgeId.set(e,s),s.runtime=bC(t.runtimeInitOptions),s.runtimeInitPromise=s.runtime.init("https://augloop-int.officeppe.com",{appName:"Testing",appPlatform:"Client"},{requestAuthToken:function(){return Promise.reject()},sendTelemetryEvent:function(l,f,c,d,p,g,k,S){a.egress(e,JSON.stringify(new Zi({tenant:l,event:f,dataJson:JSON.stringify(c),contract:d,contractDataJson:JSON.stringify(p),critical:g,dataCategories:k,diagnosticLevel:S})),r)},isFeatureEnabled:function(l,f){return t.runtimeInitOptions.featureEnabled.indexOf(l)!==-1?Promise.resolve(!0):Promise.resolve(!1)},areLicenseFeaturesEnabled:function(){return Promise.resolve(!1)}},{telemetryAggregationIntervalSec:t.telemetryAggregationIntervalSec}).then(function(){s.runtimeInitialized=!0;var u=a.optionsByBridgeId.get(e);return u&&u.onRuntimeInit&&u.onRuntimeInit(s.runtime,{bridgeId:e,bridgeMessage:t}),new Fe({})}).catch(function(u){return a.runtimesByBridgeId.delete(e),new Y({error:u==null?void 0:u.message})}).then(function(u){a.egressResponse(e,t.messageId,u,r)})}},{key:"onSessionInitMessage",value:function(e,r,t){var a=this,s;if(!r||((s=t.clientMetadata)===null||s===void 0?void 0:s.docSessionId)!==r){this.egressResponse(e,t.messageId,new Y({error:"InvalidDocSessionId"}),r);return}this.afterRuntimeInit(e,function(u,l){if(u){a.egressResponse(e,t.messageId,new Y({error:u.message}),r);return}var f=a.sessionsByBridgeIdAndDocSessionId.get(e);f||(f=new Map,a.sessionsByBridgeIdAndDocSessionId.set(e,f));var c=f.get(r);if(c){a.egressResponse(e,t.messageId,new Y({error:`Session${pr.InitMessageAlreadyReceived}`}),r);return}c={sessionInitialized:!1},f.set(r,c),c.sessionInitPromise=l.createSession({docSessionId:r,extensionConfigs:t.extensionConfigs,serviceUrl:t.serviceUrl,enableComplexLocalWorkflows:!0,egress:function(p,g){ln.typeGuard(p)?a.egressResponse(e,t.messageId,new ln(p),r):a.egress(e,JSON.stringify(p),r),g(void 0)}}).then(function(d){c.session=d,c.sessionInitialized=!0;var p=a.optionsByBridgeId.get(e);p&&p.onSessionInit&&p.onSessionInit(c.session,{bridgeId:e,docSessionId:r,bridgeMessage:t})}).catch(function(d){f.delete(r),a.egressResponse(e,t.messageId,new Y({error:d==null?void 0:d.message}),r)})})}},{key:"onSessionIngress",value:function(e,r,t){var a=this;this.afterSessionInit(e,r,function(s,u){if(s){a.egressResponse(e,t.messageId,new Y({error:s.message}),r);return}u.sendMessageToSession(t,function(l,f){(l||f)&&a.egressResponse(e,t.messageId,l||f,r)})})}},{key:"egressResponse",value:function(e,r,t,a){r!==void 0&&(t.messageId=r),this.egress(e,JSON.stringify(t),a)}},{key:"egress",value:function(e,r,t){var a=this.optionsByBridgeId.get(e);a&&a.egress(r,t)}}]),n}();h();var du=w(_n());h();var cu=function(o){return{primary:o.tile.metadata.docSessionId,secondary:o.tile.metadata.tileId}};h();var nb=3,rb=10,RC=function(o){var e=new Map,r=!1,t=new Map;if(o&&Array.isArray(o.values)){var a=0;for(var s of o.values)if(s&&Array.isArray(s.acronyms)){a+=s.acronyms.length;var u=function(p){if(p.annotationId!==void 0&&p.annotationId.indexOf("=")>=0){var g=p.annotationId.substring(0,p.annotationId.indexOf("=")),k=e.get(g);e.set(g,k===void 0?1:k+1);var S;if(Array.isArray(s.annotations)){var x=s.annotations,C=x.filter(function(M){return M.annotationId===p.annotationId});C.length===1&&C[0]&&C[0].tileInfo&&C[0].tileInfo.tileId&&(S=C[0].tileInfo.tileId)}if(!t.has(g)){var T={paragraphId:S,acronym:g,expansions:[],sourceTransactionId:s.transactionId};t.set(g,T)}var I=t.get(g).expansions;if(I.every(function(M){return M.name!==p.name})){var _={name:p.name,description:p.description,sourceType:p.sourceType,sourceEmail:p.sourceEmail,sourceFile:p.sourceFile,sourceAdmin:p.sourceAdmin,score:p.score,instrumentationId:p.instrumentationId,sourceTransactionIds:[s.transactionId]};I.push(_)}}};for(var l of s.acronyms)u(l);(a>=rb||e.size>=nb)&&(r=!0)}}var f=[];t.forEach(function(d,p){f.push(d)});var c={acronymsThresholdHit:r,paragraphAcronyms:t.size===0?[]:f};return c};h();h();var BC=function(o){return o?o===o.toUpperCase():!1},WC=function(o,e){if(!o)return o;for(var r=0,t=o.length-1;e.indexOf(o[r])!==-1&&r<t;)r++;for(;e.indexOf(o[t])!==-1&&t>=r;)t--;return o.substring(r,t+1)};var ob=/(\b[0-9A-Z][A-Z/\.]*([a-z/]){0,3}[A-Z0-9/\.]*[- #\s&\+]?[A-Z0-9/\.]*[- #\s&\+]?[A-Z0-9/\.]*([a-z/]){0,50}[A-Z0-9\./]*([a-z/]){0,50}[\.]?s?([\+]|([\.])|\b))/,ib=/(\b(([A-Z]([a-z/]){0,50})|([0-9])*)[\.]?s?([\+]|([\.])|\b))/,ab=20,sb=function(o){if(!o)return!1;o=WC(o,[" ","\xA0","."]);var e=ob.exec(o),r=e&&e.length>0?e[0].trim():"",t=ib.exec(o),a=t&&t.length>0?t[0].trim():"";return r===o&&r.length>1&&r.length<=ab&&a!==o},ub=function(o){if(!o)return[];var e=o.trim().split(/[\s,?!'"]/g);return e.length>1&&BC(o)?[]:e.filter(function(r){return r&&sb(r)})},OC=function(o,e,r){if(!o||!o.tile||!o.tile.metadata||o.type===Qn.TextTileEventType.Delete)return null;var t=o.tile.elements;if(!Array.isArray(t)||t.length===0)return null;var a=ub(t.map(function(l){return l.text}).join(" "));if(!a.length)return null;if(e&&e.lookupTable&&e.lookupTable.acronymsMap&&r){var s=e.lookupTable,u=s.acronymsMap;if(a.every(function(l){return!lb(l,u)}))return null}return{documentId:o.tile.metadata.docId,documentSessionId:o.tile.metadata.docSessionId,tiles:[o.tile]}},lb=function(o,e){return e[o]!==void 0};h();var FC=w(_n());h();var fb=function(o){return Array.isArray(o)?o.reverse().reduce(function(e,r){return e*2+(r?1:0)},0):0},Pa=function(o,e,r){for(var t=[],a=0;a<e;a++)t.push(o.IsFeatureEnabled(r+`${a}`,"None").then(function(s){return s}).catch(function(){return!1}));return Promise.all(t).then(function(s){return fb(s)})};h();var LC=function(o){return o.type===Qn.TextTileEventType.Delete||o.tile.elements===void 0||o.tile.elements===null||o.tile.elements.length===0||o.tile.elements[0].text===void 0||o.tile.elements[0].text===null||o.tile.elements[0].text.length===0?null:o};var qd=function(o,e){if(e===null)throw new Error(`${o} must be defined and non null`)};h();var Ra=function(){return[{Provider:Ja.ADAL,ResourceId:"https://nleditor.osi.office.net/NlEditor",AuthorityUrl:"https://login.microsoftonline.com/common/oauth2/authorize"}]};var cb="Acronyms.Request",db="Acronyms.Response",pb="Acronyms.BatchRequest",gb="Acronyms.BatchResponse",hb=function(o){try{return o.tiles[0].elements[0].text.length}catch(e){throw new Error(`invalid estimateSize input ${e}`)}},mb=function(o){return qd("request",o),o.documentId},vb=function(o){return qd("acronymsBatchResponse",o),o.responses},yb=function(o){var e={requests:o};return{input:e,demultiplex:vb}},qC=function(){var n=(0,FC.default)(function*(o,e){var r=yield Pa(o,7,"Microsoft.Office.Augloop.AcronymsBatchingInterval"),t=yield Pa(o,7,"Microsoft.Office.Augloop.AcronymsBatchingSizeInKB"),a=r===0?1:r,s=t===0?20:t;return{name:"AcronymsLambdaRemoteBatched",source:ae.BatchedRemote,inputSchema:cb,outputSchema:db,remoteInputSchema:pb,remoteOutputSchema:gb,authTickets:e?Ra():void 0,batchOptions:{delayMs:a*1e3,maxInputSize:s*1024,estimateSize:hb,groupingKeyExtractor:mb,multiplex:yb}}});return function(e,r){return n.apply(this,arguments)}}();var GC=898989898,$d="Tiling.TextTileEvent",$C="Acronyms.Request",UC="Acronyms.Response",kb="Acronyms.CountReduceOutput",Gd=function(){var n=(0,du.default)(function*(o,e){var r=yield e.IsFeatureEnabled("Microsoft.Office.Augloop.ShouldAcronymsUseLookupTable","None"),t={name:"AcronymsLambdaBefore",source:ae.Custom,inputSchema:$d,outputSchema:$C,func:function(k,S,x,C){var T=OC(k,x,r);C(T)}},a=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.RemoteLambdaAuthTickets","Production"),s=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.AcronymsLocalLambda","None"),u=yield wb(e,a,s),l=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.AcronymsWordBatchedWorkflow","None");if(l){var f=yield qC(e,a),c=[],d={name:"AcronymsLocalLambda",inputSchema:$d,outputSchema:$d,source:ae.Local};return s&&c.push(d),c.push(t),c.push(f),o.registerMultipleLambdasWorkflow("AcronymsWorkflow",c,u)}else{var p={name:"AcronymsLambdaRemote",source:ae.Remote,inputSchema:$C,outputSchema:UC,authTickets:a?Ra():void 0};return o.registerSimpleRemoteWorkflow("AcronymsWorkflow",t,p,null,u)}});return function(e,r){return n.apply(this,arguments)}}(),wb=function(){var n=(0,du.default)(function*(o,e,r){var t=yield Sb(o,e),a=yield Pa(o,7,"Microsoft.Office.Augloop.AcronymsThrottlingInterval");return{canProduceNullResult:!0,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:a*1e3},licenseFeatures:[GC],lookupTableLambda:t,triggerOnRefresh:r}});return function(e,r,t){return n.apply(this,arguments)}}(),Sb=function(){var n=(0,du.default)(function*(o,e){var r=yield o.IsFeatureEnabled("Microsoft.Office.Augloop.AcronymsLookupTable","None");if(r)return{name:"AcronymsLambdaLookup",source:ae.Remote,inputSchema:"Acronyms.LookupRequest",outputSchema:"Acronyms.LookupResponse",authTickets:e?Ra():void 0}});return function(e,r){return n.apply(this,arguments)}}(),Ud=function(o){var e={name:"AcronymsReduceLambda",source:ae.Custom,inputSchema:UC,outputSchema:kb,func:function(a,s,u,l){l(RC(a))}},r={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},licenseFeatures:[GC]};return o.registerReduceWorkflow("AcronymsReduceWorkflow",e,cu,10,r)};h();var Cb="Tiling.TextTileEvent",HC="SavePrompt.Request",zC="SavePrompt.Response",xb="SavePrompt.ReduceCountSignal",Tb=300,Ib=function(o){if(!o||!o.tile||!o.tile.metadata)return null;var e=o.tile.elements;return!Array.isArray(e)||e.length===0?null:{documentId:o.tile.metadata.docId,documentSessionId:o.tile.metadata.docSessionId,tiles:[o.tile]}};function _b(n){return n=n.replace(/(^\s*)|(\s*$)/gi,""),n===""?0:n.split(/\r\n|\r|\n/).length}function Ab(n){return n=n.replace(/(^\s*)|(\s*$)/gi,""),n=n.replace(/[ ]{2,}/gi," "),n=n.replace(/\n /gi,`
`),n=n.replace(/\r /gi,"\r"),n=n.replace(/\r\n /gi,`\r
`),n=n.replace(/\r\n|\r|\n/gi," "),n.split(" ").filter(function(o){return o!==""}).length}var Mb=function(o){if(o===null)throw new Error("savepromptRequest must be defined and non null");var e=o.tiles;if(!(!e||e.length<1)){if(e.length>1)throw new Error("There are more than 1 tiles in input. Expecting max 1 tile");var r="",t=`
`;for(var a of e[0].elements)a.text&&(r+=r?t+a.text:a.text);var s=_b(r),u=Ab(r),l=r.length;return{rowCount:s,wordCount:u,charCount:l,documentId:o.documentId}}},Hd=function(o){var e={name:"SavePromptLambdaBefore",source:ae.Custom,inputSchema:Cb,outputSchema:HC,func:function(s,u,l,f){var c=Ib(s);f(c)}},r={name:"SavePromptLambdaNew",source:ae.Custom,inputSchema:HC,outputSchema:zC,func:function(s,u,l,f){var c=Mb(s);f(c)}},t={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:7e3},licenseFeatures:[]};return o.registerSimpleRemoteWorkflow("SavePromptWorkflow",e,r,null,t)},bb=function(o){var e=!1,r=0,t=0,a=0;if(o&&Array.isArray(o.values)){for(var s of o.values)s&&(r+=s.rowCount,t+=s.wordCount,a+=s.charCount);e=a>=Tb}var u={thresholdHit:e,rowCount:r,wordCount:t,charCount:a};return u},zd=function(o){var e={name:"SavePromptReduceLambda",source:ae.Custom,inputSchema:zC,outputSchema:xb,func:function(a,s,u,l){l(bb(a))}},r={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},licenseFeatures:[]};return o.registerReduceWorkflow("SavePromptReduceWorkflow",e,cu,10,r)};h();var VC=w(_n());h();var Vd={documents:new Map,officeUILanguage:"",serviceUrl:"",docSessionIdToDocIdMap:new Map,docIdToDocSessionIdMap:new Map,classificationResponse:"Classification.Response",classificationBatchedResponse:"Classification.BatchResponse",classificationReduce:"Classification.Reduce",classificationReduceResponse:"Labelling.Response",labellingEditorUIResponse:"Labelling.EditorUIResponse",autoClpLicenseFeatures:[76080228,31135922],defaultBatchIntervalSeconds:3,defaultBatchSizeKB:20,defaultThrottlingIntervalSeconds:3,maxReduceDelayUntilIdleSeconds:5};function pu(n,o){return Qd.apply(this,arguments)}function Qd(){return Qd=(0,VC.default)(function*(n,o){Vd.officeUILanguage=n.uiLanguage,Vd.serviceUrl=o}),Qd.apply(this,arguments)}h();h();h();var QC="SlideTile";var jC="Proofing.",Eb="ProofingRequest",Nb="ProofingResponse",JC=`${jC}${Eb}`,Db=`${jC}${Nb}`,Pb="827D1907-1E10-4F04-987A-B13FEC819C3C",Rb="818BCDBE-64CE-46E8-A3D7-75A1EA8365A8",Bb=function(o,e){if(e.slides.length===0)return null;var r=[];o.appMetadata&&o.appMetadata.overriddenCritiqueTypeOptions&&(r=o.appMetadata.overriddenCritiqueTypeOptions),r.push({id:Rb,languageId:"en-US",value:"0"});var t={documentId:o.docId,languageUxId:o.appMetadata?o.appMetadata.languageUxId:"en-US",descriptors:{isCompliant:o.appMetadata?o.appMetadata.descriptor.isCompliant:!0,licenseType:o.appMetadata?o.appMetadata.descriptor.licenseType:2},tiles:[],requestOrderInSession:o.reqOrd,runOnProfileId:Pb,overriddenCritiqueTypeOptions:r},a=e.slides[0];if(a.drawingElems)for(var s of a.drawingElems){var u=s.textTile;u.metadata={tileId:s.id,revisionId:"revision",tileType:1};for(var l=0,f=u.elements;l<f.length;l++){var c=f[l];c.languageId||(c.languageId="en-US"),c.textUnit=4}t.tiles.push(u)}return t},KC=function(o){var e={name:"ProofingLambdaBefore",source:ae.Custom,inputSchema:QC,outputSchema:JC,func:function(s,u,l,f){var c=s,d=JSON.parse(c.content),p=Bb(c,d);f(p)}},r={name:"ProofingLambdaRemote",source:ae.Remote,inputSchema:JC,outputSchema:Db},t={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!0};return o.registerSimpleRemoteWorkflow("ProofingWorkflow",e,r,null,t)};function Jd(n){return KC(n)}h();var Wb="Tiling.TextTileEvent",XC="SharingSuggestion.Request",jd="SharingSuggestion.Response",YC={},ZC=function(o,e){var r={name:"SharingSuggestionLambdaBefore",source:ae.Custom,inputSchema:Wb,outputSchema:XC,func:function(f,c,d,p){var g={Provider:lp.ADAL,ResourceId:"https://substrate.office.com",AuthorityUrl:"https://login.microsoftonline.com/common/oauth2/authorize",Target:"https://substrate.office.com",Policy:"MBI_SSL"};YC[f.tile.metadata.docId]?p(null):e.RequestAuthToken({Tickets:[g]}).then(function(k){p({tiles:[f.tile],tokens:[{token:k.Token,ticket:g}]})}).catch(function(){p(null)})}},t={name:"SharingSuggestionLambdaRemote",source:ae.Remote,inputSchema:XC,outputSchema:jd},a={name:"SharingSuggestionLambdaAfter",source:ae.Custom,inputSchema:jd,outputSchema:jd,func:function(f,c,d,p){YC[f.docId]=!f.retry,f.identities.length>0&&f.identities[0].suggestions.length>0?(delete f.retry,delete f.docId,p(f)):p(null)}},s=10,u={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:1e4},licenseFeatures:[]};return o.registerSimpleRemoteWorkflow("SharingSuggestionWorkflow",r,t,a,u)};h();var ti=w(Kd()),dx=w(sx());h();var Ze=w(ux()),lx=w(R()),fx=w(B()),cx=function(){function n(){(0,lx.default)(this,n)}return(0,fx.default)(n,[{key:"log",value:function(e,r,t,a){(0,Ze.default)(e),(0,Ze.default)(r),(0,Ze.default)(t),(0,Ze.default)(a)}},{key:"info",value:function(e,r,t){(0,Ze.default)(e),(0,Ze.default)(r),(0,Ze.default)(t)}},{key:"warn",value:function(e,r,t){(0,Ze.default)(e),(0,Ze.default)(r),(0,Ze.default)(t)}},{key:"error",value:function(e,r,t){(0,Ze.default)(e),(0,Ze.default)(r),(0,Ze.default)(t)}},{key:"debug",value:function(e,r,t){(0,Ze.default)(e),(0,Ze.default)(r),(0,Ze.default)(t)}},{key:"logEvent",value:function(e,r,t,a,s,u){(0,Ze.default)(e),(0,Ze.default)(r),(0,Ze.default)(t),(0,Ze.default)(a),(0,Ze.default)(s),(0,Ze.default)(u)}}]),n}();var px="Skills.Signal",o0="Skills.Intent",gx="Skills.ProviderResult",i0="Skills.RankedResult",Zd,hx=function(o){var e={name:"IntentClassifierLambdaRemote",source:ae.Remote,inputSchema:px,outputSchema:o0};return o.registerSimpleRemoteWorkflow("IntentClassifierWorkflow",null,e,null)},mx=function(o){var e={name:"ProviderResultLambdaRemote",source:ae.Remote,inputSchema:px,outputSchema:gx};return o.registerSimpleRemoteWorkflow("ProviderResultWorkflow",null,e,null)},a0=function(o){var e={},r=[];for(var t of o.values)if(t){var a=t;try{var s={id:a.id,surfaceType:a.surfaceType,providerId:a.providerId,resultStatus:ti.ProviderResultStatus[a.resultStatus],statusCode:a.statusCode,error:a.error?{errorType:ti.ProviderErrorType[a.error.errorType],detail:a.error.detail}:null,additionalInfo:a.additionalInfo?JSON.parse(a.additionalInfo):null,entityGroups:a.entityGroups.map(function(l){return{groupTypeId:l.groupTypeId,providerId:l.providerId,data:l.data?JSON.parse(l.data):null,rank:l.rank}})},u={providerId:s.providerId,resultStatus:s.resultStatus,statusCode:s.statusCode,error:s.error,additionalInfo:s.additionalInfo,entityGroups:s.entityGroups,id:a.id,surfaceType:a.surfaceType};s.resultStatus===ti.ProviderResultStatus.Success&&s.entityGroups?r=r.concat(s.entityGroups):s.resultStatus===ti.ProviderResultStatus.NoResult&&s.entityGroups&&(u.entityGroups=void 0),e[s.providerId]=u}catch(l){e[a.providerId]=void 0}}return{transactionId:null,providerStatuses:e,rankedEntityGroups:r}},s0=function(){return{transactionId:null,interactionId:null}},u0=function(){if(!Zd){var o={shouldQueryMatchQfDocumentTitle:!0},e=new cx;Zd=new dx.SmartLookupRanker(e,o)}return Zd},vx=function(o){var e={name:"InterProviderRanker",source:ae.Custom,inputSchema:gx,outputSchema:i0,func:function(a,s,u,l){var f=a0(a),c=u0();c.rank(s0(),f),l(f)}},r=function(a){var s={primary:a.id,secondary:null};return s};return o.registerReduceWorkflow("InterProviderRankerWorkflow",e,r)};h();var l0=function(o){if(!o)return null;var e={bar:o.baz,baz:o.bar};return e},yx=function(o){var e={name:"BazBarLambda",source:ae.Custom,inputSchema:"Microsoft.AugLoop.BazBar",outputSchema:"Microsoft.AugLoop.BazBar",func:function(u,l,f,c){var d=l0(u);c(d)}},r={name:"HealthCheckRemoteLambda",source:ae.Remote,inputSchema:"HealthCheckRequest",outputSchema:"HealthCheckResponse"},t={name:"BazBarNativeLambda",source:ae.Local,inputSchema:"BazBarNativeRequest",outputSchema:"BazBarNativeResponse"},a={name:"BazBarMissingNativeLambda",source:ae.Local,inputSchema:"BazBarMissingNativeRequest",outputSchema:"BazBarNativeResponse"};return Promise.all([o.registerSimpleLocalWorkflow("BazBarWorkflow",e),o.registerSimpleLocalWorkflow("BazBarNativeWorkflow",t),o.registerSimpleLocalWorkflow("BazBarMissingNativeWorkflow",a),o.registerSimpleRemoteWorkflow("HealthCheckWorkflow",null,r,null)]).then(function(){})};var Pt=w(wx()),Bx=w(Cx());h();var xx="Tiling.TextTileEvent",f0="LangDetect.Request",c0="LangDetect.Response",d0=function(o){var e={name:"LangDetectLambdaBefore",source:ae.Custom,inputSchema:xx,outputSchema:xx,func:function(a,s,u,l){var f=LC(a);if(!f)l(null);else{var c={context:f.tile.elements.map(function(d){return d.text}).join(" ")};l(c)}}},r={name:"LangDetectLambdaRemote",source:ae.Remote,inputSchema:f0,outputSchema:c0};return o.registerSimpleRemoteWorkflow("LangDetectWorkflow",e,r,null,{canProduceNullResult:!0,shouldSendResultsToHost:!0,enabledByDefault:!0})};function Tx(n){return d0(n)}h();var Ix=w(_n());function p0(n,o,e,r){return ep.apply(this,arguments)}function ep(){return ep=(0,Ix.default)(function*(n,o,e,r){var t;try{var a=yield o.getAll(),s=new Set;for(var u of a){var l=u.content.split(" ");for(var f of l)s.add(f)}var c=new lo({count:s.size});r.setAnnotations(n,lo.getTypeName(),[c])}catch(d){t=d}finally{r.done(t)}}),ep.apply(this,arguments)}function _x(){return Ws.create("UniqueWordsCount").setCollectionScopeType(Mt.getTypeName()).setInputTypes([et.getTypeName()]).setOutputTypes([lo.getTypeName()]).setLambda(p0)}h();var Nx=w(R()),Dx=w(B());h();var Gn;(function(n){n.Table="Table",n.List="List",n.Footer="Footer",n.Header="Header",n.Paragraph="Paragraph",n.Multiselect="Multiselect"})(Gn||(Gn={}));var wu;(function(n){n.ContentType="ContentType"})(wu||(wu={}));h();var tp=w(R()),np=w(B());var Oa=function(){function n(o){(0,tp.default)(this,n),y.assign(n,this,o)}return(0,np.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_FeatureExtraction_FeatureExtractionSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();Oa.H_={T_:Oa.getTypeName(),B_:Oa.getBaseTypes()};var wo=function(){function n(o){(0,tp.default)(this,n),y.assign(n,this,o)}return(0,np.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_FeatureExtraction_FeatureExtractionAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return y.matchesTypesFor(e,[n.getTypeName()])}}]),n}();wo.H_={T_:wo.getTypeName(),B_:wo.getBaseTypes()};h();var Ax=w(Se()),Mx=w(R()),bx=w(B());h();var Su;(function(n){n.HeaderFooter="headerfooters"})(Su||(Su={}));var La;(function(n){n.Footer="Footer",n.Normal="Normal"})(La||(La={}));var Ex=function(){function n(o){(0,Mx.default)(this,n),this.context=o}return(0,bx.default)(n,[{key:"getContentType",value:function(e,r){var t,a,s=new Set;if(!e||!r||!e.selectedRanges||!Array.isArray(e.selectedRanges))return s;for(var u of e.selectedRanges)if(u){var l=r.getItemBodyByReference(u.tileReference);if(l){if(l.isInsideTable&&s.add(Gn.Table),l.listType!==Ts.NoList&&s.add(Gn.List),u.tileReference.referencedPath.indexOf(Su.HeaderFooter)>-1&&(!((a=(t=l.formattedRanges)===null||t===void 0?void 0:t[0])===null||a===void 0)&&a.styleName&&l.formattedRanges[0].styleName===La.Footer?s.add(Gn.Footer):s.add(Gn.Header)),s.size===0&&s.add(Gn.Paragraph),l.formattedRanges)for(var f of l.formattedRanges)f!=null&&f.styleName&&f.styleName!==La.Normal&&s.add(f.styleName);u.range.length>l.content.length&&s.add(Gn.Multiselect)}}return e.selectedRanges.length>1&&s.add(Gn.Multiselect),s}},{key:"extractContentType",value:function(){var e,r,t,a=new E({operationName:"Extracting content-type",success:!0}).start();try{var s=(r=(e=this.context)===null||e===void 0?void 0:e.triggerSignals)===null||r===void 0?void 0:r[0];if(!(s!=null&&s.currentSelection)||!(!((t=this.context)===null||t===void 0)&&t.model))return"";var u=this.getContentType(s.currentSelection,this.context.model);return m.info(512242182,v.WorkflowDefault,a.stop()),(0,Ax.default)(u.values()).join(",")}catch(f){a.success=!1;var l={error:f,message:f.message,stack:f.stack};a.resultDescription=JSON.stringify(l),m.error(512242181,v.WorkflowDefault,a.stop())}return""}}]),n}();var g0=function(){function n(){(0,Nx.default)(this,n)}return(0,Dx.default)(n,[{key:"execute",value:function(e,r,t,a){var s=new E({operationName:"Extracting Features",success:!0}).start();try{var u=new wo({extractedFeatures:[]}),l=new Ex(t),f=l.extractContentType();u.extractedFeatures.push({key:wu.ContentType,value:f}),m.info(512238366,v.WorkflowDefault,s.stop()),a.setAnnotations(e,wo.getTypeName(),[u]),a.done()}catch(d){s.success=!1;var c={error:d,message:d.message,stack:d.stack};s.resultDescription=JSON.stringify(c),m.error(512238365,v.WorkflowDefault,s.stop()),a.done(d)}}},{key:"dispose",value:function(){}}]),n}(),Px=Ws.create("FeatureExtraction").setBypassModel().setCollectionScopeType(Mt.getTypeName()).setTriggerSignals([Oa.getTypeName()]).setInputTypes([et.getTypeName()]).setOutputTypes([wo.getTypeName()]).setLambdaType(g0);var Wx=function(o){var e,r,t=null,a={sendConnectionParamsAcrossBridge:!1},s=new Map,u=new Map,l=new Map,f=new Map,c=function(D,O,$,F){o.OnResult({InputSchema:D,InputJson:JSON.stringify(O),OutputSchema:$,OutputJson:JSON.stringify(F)})},d=function(D){return o.RequestAuthToken(D)},p=function(D,O){return o.IsFeatureEnabled(D,O)},g=function(D){return o.IsChangeGateEnabled(D)},k=function(D){return o.AreLicenseFeaturesEnabled(D)},S=function(D,O,$,F){var q={InputSchema:D,InputJson:JSON.stringify(O),CorrelationVector:""};return o.ExecuteLocalLambda(q,$,"").then(function(W){return W?JSON.parse(W):void 0})},x=function(){var D=new Pt.TelemetryLogger;D.setTenantTokens({Office:{AugLoop:{ariaTenantToken:"3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770",nexusTenantToken:1780,Client:{}}}}),D.addSink((0,Bx.createOTelSink)());var O=function(F,q){var W=F.charAt(0).toUpperCase()+F.slice(1);if(typeof q=="string")return{name:W,dataType:Pt.DataFieldType.String,value:q};if(typeof q=="boolean")return{name:W,dataType:Pt.DataFieldType.Boolean,value:q};if(typeof q=="number")return{name:W,dataType:Pt.DataFieldType.Double,value:q};if(typeof q=="object"&&q.isInteger)return{name:W,dataType:Pt.DataFieldType.Int64,value:q.value}};return function($,F,q,W,K,X){var re={eventName:F.replace(/_/g,".")};re.eventFlags={samplingPolicy:Pt.SamplingPolicy.Measure,dataCategories:Pt.DataCategories.ProductServiceUsage|Pt.DataCategories.ProductServicePerformance,diagnosticLevel:Pt.DiagnosticLevel.NecessaryServiceDataEvent},W==="Office.System.Activity"&&(re.eventContract={name:W,dataFields:Pt.Contracts.Office.System.Activity.getFields({duration:K.Duration,count:K.Count,aggMode:K.AggMode,cV:K.CV,success:K.Success,result:K.Result?{code:K.Result.Code||0,type:K.Result.Type,tag:K.Result.Tag}:void 0})}),re.dataFields=Object.keys(q).filter(function(se){return q[se]!==void 0}).map(function(se){return O(se,q[se])}),D.sendTelemetryEvent(re),r&&r.appName&&r.appName.toLowerCase()==="testing"&&o.SendDiagnosticTrace(0,Qt.Info,`EventName: ${F} Contract: ${W} ContractData: ${JSON.stringify(K)} Data: ${JSON.stringify(q)}`)}},C={onResult:c,onAnnotationResult:null,requestAuthToken:d,sendTelemetryEvent:x(),isFeatureEnabled:p,isChangeGateEnabled:g,executeLocalLambda:S,areLicenseFeaturesEnabled:k};m.addLogger({level:wt.info,log:function(D){if(D.eventName==="Log"){var O,$,F;o.SendDiagnosticTrace((O=D.tagId)!=null?O:0,($=D.traceLevel)!=null?$:Qt.Info,(F=D.message)!=null?F:"")}}});var T=function(){return t!==null||(t=Promise.all([o.IsFeatureEnabled("Microsoft.Office.AugLoop.EnableBatchOptions","Production"),o.IsFeatureEnabled("Microsoft.Office.AugLoop.EnableAugLoopPhase3","None"),o.IsFeatureEnabled("Microsoft.Office.AugLoop.EnablePhase3Service","None"),o.IsChangeGateEnabled("SendConnectionParamsAcrossBridge")]).then(function(D){var O=(0,Rx.default)(D,4),$=O[0],F=O[1],q=O[2],W=O[3];return a.sendConnectionParamsAcrossBridge=W,au.init(e,r,C,{networkMode:F&&q?be.LocalWorkflowsOnly:void 0,telemetryAggregationIntervalSec:30,batchOptions:$?{delayMs:1e3,maxInputSize:1048576}:void 0}).then(function(){return ct.init(e,r,C)}).then(function(){if(r.appName==="PowerPoint")return Promise.all([Jd(ct),hx(ct),pu(r,e)]).then(function(){});if(r.appName==="Word")return Promise.all([Gd(ct,o),Ud(ct),Hd(ct),zd(ct),mx(ct),vx(ct),pu(r,e),ZC(ct,o)]).then(function(){});if(r.appName==="Outlook")return Promise.all([pu(r,e)]).then(function(){});if(r.appName==="OneNote")return Tx(ct);if(r.appName==="Testing")return Promise.all([yx(ct),Jd(ct),Gd(ct,o),Ud(ct),Hd(ct),zd(ct)]).then(function(){})})})),t};o.OnSubmit.subscribe(function(P){var D="RekaPing";if(P.InputSchema===D){o.OnResult({InputSchema:D,InputJson:P.InputJson,OutputSchema:D,OutputJson:P.InputJson});return}T().then(function(){ct.submit(P.InputSchema,JSON.parse(P.InputJson),P.CorrelationVector)})}),o.OnSetServiceUrl.subscribe(function(P){e=P}),o.OnSetHostMetadata.subscribe(function(P){var D=[];for(var O of P.DisabledServiceGroups)D.push({officeServiceGroup:O.OfficeServiceGroup,controllerServiceGroup:O.ControllerServiceGroup});r={appName:P.AppName,appPlatform:P.AppPlatform,appVersion:P.AppVersion,uiLanguage:P.UILanguage,releaseAudienceGroup:P.ReleaseAudienceGroup,releaseChannel:P.ReleaseChannel,releaseFork:P.ReleaseFork,sessionId:P.SessionId,flights:P.Flights,privateMode:P.PrivateMode,disabledServiceGroups:D,userSystemTimezone:P.SystemTimezone}});var I=function(D){m.error(593892183,v.CoreDefault,`Session not found for ${D} event`)},_=function(D){m.warn(0,v.CoreDefault,`Annotation token not found for ${D} event`)},M=function(D,O){m.error(0,v.CoreDefault,`Bad input for ${D}: ${O}`)},A=function(D,O){m.error(593892186,v.CoreDefault,new E({operationName:"InteropPromiseRejected",success:!1,resourceId:D,resultDescription:O}))},b=function(D){if(D){if(typeof D=="string")return D;if(typeof D.message=="string")return D.message}return"Unknown error"},N=function(D,O){if(f.has(O)&&a.sendConnectionParamsAcrossBridge){var $=f.get(O),F=$.sessionUrl,q=new Ke({bridgeId:D,docSessionId:O,message:new ln({origin:$.origin,sessionKey:F.split("/").pop(),sessionUrlBase:F.split("/").slice(0,-1).join("/"),anonymousToken:$.authToken})});o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke(q))})}};o.OnCreateSession.subscribe(function(P){var D=P.docSessionId,O=P.flights,$=P.serviceUrl,F=P.offlineMode;if(s.has(D)){o.OnCreateSessionResult({errMessage:"docSessionId already exists",docSessionId:D});return}var q=T().then(function(){var W=[];try{for(var K of P.extensionConfigs||[])W.push(JSON.parse(K))}catch(se){throw M("OnCreateSession",b(se)),new Error("Bad extension configs")}var X="*",re={docSessionId:D,onSessionConnect:function(de,ye,He,Ct){if(m.debug(0,v.CoreDefault,"In AL Session onSessionConnect"),!f.has(D)&&a.sendConnectionParamsAcrossBridge){var we={authToken:Ct,isSeedingRequired:de,sessionUrl:ye,origin:He};f.set(D,we),N(X,D)}var nt={bridgeId:X,docSessionId:D,message:new Gi({isSeedingRequired:de,sessionUrl:ye,origin:He,authToken:Ct})};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke(nt))})},onSessionDisconnect:function(de){m.debug(0,v.CoreDefault,"In AL Session onSessionDisconnect"),f.delete(D);var ye={bridgeId:X,docSessionId:D,message:new Ui({error:de})};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke(ye))})},onSessionReconnect:function(){m.debug(0,v.CoreDefault,"In AL Session onSessionReconnect");var de={bridgeId:X,docSessionId:D,message:new Hi};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke(de))})},onSessionClose:function(de){m.debug(0,v.CoreDefault,"In AL Session onSessionClose");var ye={bridgeId:X,docSessionId:D,message:de};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke(ye))})},onServerAuthenticationStateChangeCallback:function(de){m.debug(0,v.CoreDefault,"In AL Session onServerAuthenticationStateChangeCallback"),l.set(D,de);var ye={bridgeId:X,docSessionId:D,message:new Lo({serverAuthenticationState:de})};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke(ye))})},onClaimsChallengeCallback:function(de){m.debug(0,v.CoreDefault,"In AL Session onClaimsChallengeCallback");var ye={bridgeId:X,docSessionId:D,message:de};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke(ye))})},extensionConfigs:W,flights:O,serviceUrl:$};return F&&(re.networkMode=be.LocalWorkflowsOnly),au.createSession(re)}).then(function(W){return o.OnCreateSessionResult({docSessionId:D}),W}).catch(function(W){s.delete(D);var K=b(W);throw A("OnCreateSession",K),o.OnCreateSessionResult({errMessage:K,docSessionId:D}),new Error(K)});s.set(D,q)}),o.OnActivateAnnotation.subscribe(function(P){var D=P.annotationType,O=P.token,$=P.config,F=P.docSessionId,q=P.forceReturnCachedAnnotations,W=s.get(F);if(!W){I("OnActivateAnnotation");return}var K;W.then(function(X){var re=$?JSON.parse($):void 0,se=function(ye){o.OnAnnotationResult({operation:JSON.stringify(ye),token:O,docSessionId:F})};return X.activateAnnotation(D,{config:re,callback:se,forceReturnCachedAnnotations:q})}).then(function(X){X&&X.token&&u.set(O,X.token)}).catch(function(X){K=b(X)}).then(function(){o.OnActivateAnnotationResult({errMessage:K,token:O,docSessionId:F})}).catch(function(X){A("OnActivateAnnotation",b(X))})}),o.OnReleaseAnnotation.subscribe(function(P){var D=P.token,O=P.docSessionId,$=u.get(D);if(!$){_("OnReleaseAnnotation");return}var F=s.get(O);if(!F){I("OnReleaseAnnotation");return}var q;F.then(function(W){return W.releaseAnnotation($)}).catch(function(W){q=b(W)}).then(function(W){W&&u.delete(D),o.OnReleaseAnnotationResult({errMessage:q,token:D,result:W})}).catch(function(W){A("OnReleaseAnnotation",b(W))})}),o.OnSubmitOperations.subscribe(function(P){var D=P.operations,O=P.cv,$=P.docSessionId,F=s.get($);if(!F){I("OnSubmitOperations");return}F.then(function(q){q.submitOperations(D.map(function(W){return JSON.parse(W)}),O)}).catch(function(q){A("OnSubmitOperations",b(q))})}),o.OnSubmitSeedOperations.subscribe(function(P){var D=P.operations,O=P.cv,$=P.docSessionId,F=s.get($);if(!F){I("OnSubmitSeedOperations");return}F.then(function(q){q.submitSeedOperations(D.map(function(W){return JSON.parse(W)}),O)}).catch(function(q){A("OnSubmitSeedOperations",b(q))})}),o.OnSubmitSeedGroupOperations.subscribe(function(P){var D=P.operations,O=P.groupComplete,$=P.cv,F=P.docSessionId,q=s.get(F);if(!q){I("OnSubmitSeedGroupOperations");return}q.then(function(W){W.submitSeedGroupOperations(D.map(function(K){return JSON.parse(K)}),O,$)}).catch(function(W){A("OnSubmitSeedGroupOperations",b(W))})}),o.OnSubmitCustomMessage.subscribe(function(P){var D=P.message,O=P.messageId,$=P.docSessionId,F=s.get($);if(!F){I("OnSubmitCustomMessage");return}var q,W;F.then(function(K){return K.submitCustomMessage(JSON.parse(D))}).then(function(K){W=K}).catch(function(K){q=b(K)}).then(function(){o.OnSubmitCustomMessageResult({errMessage:q,response:JSON.stringify(W),messageId:O,docSessionId:$})}).catch(function(K){A("OnSubmitCustomMessage",b(K))})}),o.OnForceReconnect.subscribe(function(P){var D=P.docSessionId,O=s.get(D);if(!O){I("OnForceReconnect");return}var $=[];try{for(var F of P.extensionConfigs||[])$.push(JSON.parse(F))}catch(W){M("OnForceReconnect",b(W));return}var q;O.then(function(W){return W.forceReconnect()}).catch(function(W){q=b(W)}).then(function(){o.OnForceReconnectResult({errMessage:q,docSessionId:D})}).catch(function(W){A("OnForceReconnect",b(W))})}),o.OnClose.subscribe(function(P){var D=P.docSessionId,O=s.get(D);if(!O){I("OnClose");return}O.then(function($){$.close(),s.delete(D),l.delete(D)}).catch(function($){A("OnClose",b($))})}),o.OnSetSessionCloseCallback.subscribe(function(P){var D=P.docSessionId,O=s.get(D);if(!O){I("OnSetSessionCloseCallback");return}O.then(function($){$.setSessionCloseCallback(function(F){o.OnSessionCloseResult({docSessionId:D,sessionCloseMessage:F?JSON.stringify(F):void 0})})}).catch(function($){A("OnSetSessionCloseCallback",b($))})}),o.OnSetConnectCallback.subscribe(function(P){var D=P.docSessionId,O=s.get(D);if(!O){I("OnSetConnectCallback");return}O.then(function($){$.setConnectCallback(function(F,q,W,K){o.OnConnectResult({docSessionId:D,isSeedingRequired:F,sessionUrl:q,origin:W,authToken:K})})}).catch(function($){A("OnSetConnectCallback",b($))})}),o.OnSetDisconnectCallback.subscribe(function(P){var D=P.docSessionId,O=s.get(D);if(!O){I("OnSetDisconnectCallback");return}O.then(function($){$.setDisconnectCallback(function(F){o.OnDisconnectResult({error:F,docSessionId:D})})}).catch(function($){A("OnSetDisconnectCallback",b($))})}),o.OnSetOfflineMode.subscribe(function(P){var D=P.docSessionId,O=s.get(D);if(!O){I("OnSetOfflineMode");return}O.then(function($){$.setOfflineMode()}).catch(function($){A("OnSetOfflineMode",b($))})});var z,L=new Set,J=function(D){L.has(D)||(L.add(D),z.initBridge({bridgeId:D,egress:function($,F){var q=typeof $=="string",W={bridgeId:D,docSessionId:F,bridgeMessage:q?$:void 0,binaryMessage:q?void 0:Array.from($)};o.OnIngressAugLoopBridgeMessage(W)},onSessionInit:function($){$.registerLocalWorkflow(_x()),$.registerLocalWorkflow(Px)}}))};o.OnInitAugLoopBridgeManager.subscribe(function(P){z||(z=new PC)}),o.OnEgressAugLoopBridgeMessage.subscribe(function(P){if(!z)throw new Error("Called OnEgressAugLoopBridgeMessage before OnInitAugLoopBridgeManager");var D=P.bridgeId,O=P.docSessionId,$=P.bridgeMessage,F=P.binaryMessage;J(D);var q=typeof $=="string";z.ingress(D,O,q?$:new Uint8Array(F))}),o.OnSDXBridgeMessageFromNative.subscribe(function(P){var D=JSON.parse(P.bridgeMessage),O=D.bridgeId,$=D.docSessionId,F=D.message,q=y.getTypeNameFor(F);o.SendDiagnosticTrace(0,Qt.Info,"TS Received Brige Message of type = "+q);var W=s.get($);if(!W){I("OnSDXBridgeMessageFromNative");var K=JSON.stringify(new Ke({bridgeId:O,docSessionId:$,response:new Y({messageId:F.messageId,error:"Session not found"})}));o.OnSDXBridgeMessageResult({bridgeMessage:K});return}W.then(function(X){if(fn.typeGuard(F)){var re=F.annotationType,se=F.config;o.SendDiagnosticTrace(0,Qt.Info,"TS Activate Annotation of type = "+re+" token = "+F.token),X.activateAnnotation(re,{config:se,callback:function(nt,$t){var mn={bridgeId:O,docSessionId:$,message:new Nt({annotationType:re,ops:[nt],cv:$t})};o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke(mn))})},forceReturnCachedAnnotations:F.forceReturnCachedAnnotations}).then(function(we){o.SendDiagnosticTrace(0,Qt.Info,"TS Annotation Activation Response Recieved with token = "+we.token);var nt={bridgeId:O,docSessionId:$,response:new Qr({messageId:F.messageId,token:we.token})},$t=JSON.stringify(new Ke(nt)),mn={bridgeMessage:$t};o.OnSDXBridgeMessageResult(mn)}).catch(function(we){var nt=JSON.stringify(new Ke({bridgeId:O,docSessionId:$,response:new Y({messageId:F.messageId,error:b(we)})}));o.OnSDXBridgeMessageResult({bridgeMessage:nt})})}else if(Be.typeGuard(F)){var de=F.ops;for(var ye of de)X.submitOperation(ye,F.cv)}else if(jr.typeGuard(F))o.SendDiagnosticTrace(0,Qt.Info,"TS Releasing Annotation Activation token = "+F.token),X.releaseAnnotation(F.token).then(function(we){o.SendDiagnosticTrace(0,Qt.Info,"TS Sending Annotation Release Response token = "+F.token);var nt=JSON.stringify(new Ke({bridgeId:O,docSessionId:$,response:new Kr({messageId:F.messageId,lastRelease:we})}));o.OnSDXBridgeMessageResult({bridgeMessage:nt})});else if(zi.typeGuard(F))X.submitCustomMessage(F.customMessage).then(function(we){we.messageId=F.messageId,o.SendDiagnosticTrace(0,Qt.Info,`Responded to ${q}`),o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke({bridgeId:O,docSessionId:$,response:we}))})}).catch(function(we){o.SendDiagnosticTrace(0,Qt.Info,we.message),o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke({bridgeId:O,docSessionId:$,response:new Y({messageId:F.messageId,error:we.message})}))})});else if(gt.typeGuard(F))N(O,$),o.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new Ke({bridgeId:O,docSessionId:$,message:new Lo({serverAuthenticationState:l.has($)?l.get($):ut.Pending})}))});else if(Qi.typeGuard(F)){o.SendDiagnosticTrace(0,Qt.Info,`Interactive auth requested via message ${F.messageId}`);var He;X.authenticateInteractive().then(function(){o.SendDiagnosticTrace(0,Qt.Info,`Interactive auth succeeded for message ${F.messageId}`),He=new Fe({messageId:F.messageId})}).catch(function(we){o.SendDiagnosticTrace(0,Qt.Error,`Interactive auth failed for message ${F.messageId}`),He=new Y({messageId:F.messageId,error:b(we)})}).finally(function(){var we=JSON.stringify(new Ke({bridgeId:O,docSessionId:$,response:He}));o.OnSDXBridgeMessageResult({bridgeMessage:we})})}else{var Ct=JSON.stringify(new Ke({bridgeId:O,docSessionId:$,response:new Y({messageId:F.messageId,error:"Unknown message type to handle"})}));o.OnSDXBridgeMessageResult({bridgeMessage:Ct})}}).catch(function(X){A("OnReceiveBridgeMessageFromNative",b(X));var re=JSON.stringify(new Ke({bridgeId:O,docSessionId:$,response:new Y({messageId:F.messageId,error:b(X)})}));o.OnSDXBridgeMessageResult({bridgeMessage:re})})})};(0,Ox.initReka)();Wx(fp.NativeService);})();
//# sourceMappingURL=index.win32.bundle.map
