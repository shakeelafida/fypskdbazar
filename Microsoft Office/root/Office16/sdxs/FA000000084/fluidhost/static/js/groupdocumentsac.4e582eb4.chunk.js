"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[97138],{36591:(e,t,i)=>{i.d(t,{C:()=>r});class r{constructor(e,t,i,r,o){this.dispatcher=e,this.logicModuleProviders=t,this.entityStoreSet=i,this.clientSettings=r,this.loggers=o}}},65672:(e,t,i)=>{i.r(t),i.d(t,{GroupDocumentsActionCreator:()=>k});var r=i(38752),o=i(51676),s=i(85230),n=i(7304),a=i(23835),l=i(27750),d=i(36591),c=i(64226);class u{static get delimiter(){return":"}static get taskPrefix(){return"TSK"}}var h=i(96891),p=i(95783),m=i(23918),g=i(26796),f=i(65818),v=i(23312),w=i(80708),y=i(37535),x=i(52274),S=i(74844),T=i(54320),I=i.n(T),U=i(9962),b=i(39156),P=i(91246),D=i(98502),E=i(82841);class k extends d.C{get name(){return h.M.GroupDocumentsActionCreator}async cancelUploadSession(e){const t=await this.logicModuleProviders.driveItemModule(),i=await this.logicModuleProviders.notificationModule();t.cancelUploadSession(e).catch((t=>{if(!(t.error instanceof x.U)){var r,o,s;const n=null===(r=t.response)||void 0===r?void 0:r.status,a=null===(o=t.response)||void 0===o?void 0:o.statusText;i.showErrorInternal(c.fc.CancelFileUploadError,n,a,void 0,t.response,[null!==(s=e.itemName)&&void 0!==s?s:""])}}))}async getGroupDocumentsInFolder(e,t){(await this.logicModuleProviders.driveItemModule()).getGroupDocumentsInFolder(e,t).catch((t=>{this.handleGetGroupDocumentsInFolderFailure(t,e)}))}async fetchDriveItem(e){(await this.logicModuleProviders.driveItemModule()).fetchDriveItem(e).catch((()=>{}))}async getDriveItemThumbnail(e,t,i){(await this.logicModuleProviders.driveItemModule()).getDriveItemThumbnail(e,t,i).catch((i=>{var r,s,n,a;i.error instanceof x.U||this.dispatcher.dispatchAction(new o.z(e,t,i.response,null!==(r=null===(s=i.response)||void 0===s?void 0:s.statusText)&&void 0!==r?r:"",null!==(n=null===(a=i.error)||void 0===a?void 0:a.message)&&void 0!==n?n:""))}))}async uploadFileAsAttachment(e,t,i,r){const o=e.name,n=g.z.builder.withPropertyBag({bytesSent:0,groupId:i,itemName:e.name,itemSize:e.size,uploadUrl:"",id:u.taskPrefix+u.delimiter+t.id+u.delimiter+P.o.generate()}).build(),l={Alias:e.name.substring(0,v.o.AliasMaxLength),PreviewPriority:r,Type:m.Y.GetFileType(e.name),isProtected:!1},d=t.addAttachment(v.o.builder.fromAttachmentResource(n.id,l).build()),h=P.o.generate();let p=!1;const f=await this.logicModuleProviders.driveItemModule(),w=await this.logicModuleProviders.notificationModule();f.createUploadSession(i,o,n,d,h).then((t=>(p=!0,this.uploadBytesToSessionRecursivePromise(e,t)))).then((e=>this.updateTaskDetailsWithSession(e,t.id))).catch((async i=>{var r,o,l,d;(this.loggers.traceLogger.logTrace(507873090,S.k.Warning,"Error uploading attachment. ".concat((0,E.s8)(i))),p)&&this.dispatcher.dispatchAction(new s.t(i.response,null!==(r=null===(o=i.response)||void 0===o?void 0:o.statusText)&&void 0!==r?r:"",null!==(l=null===(d=i.error)||void 0===d?void 0:d.message)&&void 0!==l?l:"",n,t.id,h));if(!(i.error instanceof x.U)){var u,m;const t=null===(u=i.response)||void 0===u?void 0:u.status,r=null===(m=i.response)||void 0===m?void 0:m.statusText;i.response&&await D.g.isAuthenticationInsuficientClaimsResponse(i.response,this.loggers.traceLogger)?this.dispatcher.dispatchAction(new a.i(c.fc.UploadFileError,t,r,void 0,[e.name],i.response)):w.showErrorInternal(c.fc.UploadFileError,t,r,void 0,i.response,[e.name])}}))}async uploadBytesToSessionRecursivePromise(e,t){const i=this.calculateFileUploadParams(e,t),r=this,o=await this.logicModuleProviders.notificationModule();return new Promise(((s,a)=>{this.fileReader.onerror=i=>{r.cancelUploadSession(t),o.showErrorInternal(c.fc.FileReadError,void 0,void 0,void 0,void 0,[e.name]),a(i)},this.fileReader.onload=async o=>{let l=o.target.result;l.indexOf("base64,")>-1&&(l=l.substr(l.indexOf("base64,")+7));(await this.logicModuleProviders.driveItemModule()).uploadBytesToSession(t,l,i.chunkSize,i.initialByteIndex,i.finalByteIndex,e.size).then((t=>{i.finalByteIndex<e.size-1?this.uploadBytesToSessionRecursivePromise(e,t).then(s).catch(a):(t=t.setProperty("lastUploadRequestSucceeded",!0),s(t)),this.dispatcher.dispatchAction(new n.h(t))})).catch((e=>{this.loggers.traceLogger.logTrace(507873089,S.k.Warning,"Upload chunk failed ".concat((0,E.s8)(e))),r.cancelUploadSession(t),a(e)}))};const l=e.slice(i.initialByteIndex,i.finalByteIndex+1);this.fileReader.readAsDataURL(l)}))}async updateTaskDetailsWithSession(e,t){try{if(null==t){const e="invalidTaskId";throw D.g.generateAjaxClientError(new Response(e,{status:p.t3.BadRequest,statusText:e}),e)}const i=this.entityStoreSet.taskStore.getTask(t);if(null==i){const e="taskNotInStore";throw D.g.generateAjaxClientError(new Response(e,{status:p.t3.BadRequest,statusText:e}),e)}const r=this.entityStoreSet.taskStore.getTaskDetails(t);if(null==r)throw D.g.generateAjaxClientError(null,new U.m("oldTaskDetails","taskStore"));const o=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(t),s=this.entityStoreSet.containerStore.getContainer(e.groupId);if(null==s||s.containerType!==f.K.Group)throw D.g.generateAjaxClientError(null,new U.m("storeContainer","containerStore"));const n=s;if(null==n.unifiedGroupDetails)throw D.g.generateAjaxClientError(null,new U.m("groupDetails","containerStore"));const a=n.unifiedGroupDetails.getWorkloadUrl(y.P[y.P.Documents]);if(null==a)throw D.g.generateAjaxClientError(null,new b.n("driveUrl"));const l=r.references[e.id];a||this.loggers.traceLogger.logTrace(507873088,S.k.Warning,"DriveUrl is empty"),e.name||this.loggers.traceLogger.logTrace(507873059,S.k.Warning,"Upload Session Name field came back empty or undefined"),e.webUrl||this.loggers.traceLogger.logTrace(507873058,S.k.Warning,"Upload session webUrl is empty"),e.itemName||this.loggers.traceLogger.logTrace(507873057,S.k.Warning,"Upload session itemName is empty");const d=new v.o(v.o.builder.fromRecentlyUploadedDriveItem(a,e.itemName||"",l.taskAttachmentType,l.previewPriority,e.name||e.itemName||""));try{const e=new URL(d.url);"http:"!==e.protocol&&"https:"!==e.protocol&&this.loggers.traceLogger.logTrace(507873056,S.k.Warning,"Invalid protocol")}catch{this.loggers.traceLogger.logTrace(507873055,S.k.Warning,"Cannot parse new attachment url")}let c=r.removeAttachment(l.url);c=c.addAttachment(d);(await this.logicModuleProviders.planModule()).fetchPlanAsync(i.planId).then((async e=>{const t=await this.logicModuleProviders.containerModule();t.fetchUnifiedGroupAsync(e.plan.container.externalId).then((()=>{t.fetchUnifiedGroupDetailsAsync(e.plan.container.externalId).then((async e=>{(await this.logicModuleProviders.driveItemModule()).fetchTaskReferenceThumbnails(c,e,[d])}),(e=>{this.loggers.traceLogger.logTrace(507873054,S.k.Warning,"Error ensuring group details")}))}),(e=>{this.loggers.traceLogger.logTrace(507873053,S.k.Warning,"Error ensuring group")}))}),(e=>{this.loggers.traceLogger.logTrace(507873052,S.k.Warning,"Error fetching plan")}));const u=r.removeTemporaryAttachments(),h=c.removeTemporaryAttachments(),m=u.getDiff(h);if(I()(m))throw D.g.generateAjaxClientError(null,new b.n("detailsDiff"));const g=await this.logicModuleProviders.taskModule(),x=await g.updateTaskAsync(w.F.builder.withTask(i).withDetails(u).withFormatData(o||void 0).build(),w.F.builder.withTask(i).withDetails(h).withFormatData(o||void 0).build());return(await this.logicModuleProviders.notificationModule()).enqueueHiddenToastNotification("SharedComponents_TaskReferenceAddedToastTitle"),x}catch(i){return Promise.reject(i)}}calculateFileUploadParams(e,t){const i=t.bytesSent?t.bytesSent:0,o=r.B.clientSettings.UploadChunkSize||0;let s=e.size-t.bytesSent;s>o&&(s=o);return{chunkSize:s,initialByteIndex:i,finalByteIndex:i+s-1}}async handleGetGroupDocumentsInFolderFailure(e,t){const i=e;if(!(i.error instanceof x.U)){var r,o,s,n,d,u;const e=null===(r=i.response)||void 0===r?void 0:r.status,h=null===(o=i.response)||void 0===o?void 0:o.statusText;if(i.response&&await D.g.isAuthenticationInsuficientClaimsResponse(i.response,this.loggers.traceLogger))this.dispatcher.dispatchAction(new a.i(c.fc.GetGroupDocumentsError,e,h,t,void 0,i.response));else if(e===p.t3.NotFound)this.dispatcher.dispatchAction(new a.i(c.fc.GetGroupDocumentsError,e,h,t,void 0,i.response));else{(await this.logicModuleProviders.notificationModule()).showErrorInternal(c.fc.GetGroupDocumentsError,e,h,t,i.response)}this.dispatcher.dispatchAction(new l.c(t,i.response,null!==(s=null===(n=i.response)||void 0===n?void 0:n.statusText)&&void 0!==s?s:"",null!==(d=null===(u=i.error)||void 0===u?void 0:u.message)&&void 0!==d?d:""))}}constructor(e,t,i,o,s){super(e,t,i,r.B.clientSettings,s),this.fileReader=o}}},39156:(e,t,i)=>{i.d(t,{n:()=>r});class r extends Error{constructor(e){super(),Object.setPrototypeOf(this,r.prototype),this.message="".concat(e," should not be null"),this.name="NullReferenceError"}}},91675:(e,t,i)=>{i.d(t,{t:()=>r});var r={Word:["docx","docm","doc","dotx","dotm"],Excel:["xlsx","xlsm","xlsb","xltx","xltm","xls","xlam","xla","xlw","xml"],PowerPoint:["pptx","pptm","ppt","potx","potm","pot","thmx","pps","ppsx","ppsm","ppsam","ppa"],OneNote:["one"],Project:["mpp","mpt","mpd"],Visio:["vsdx","vsd","vsdm","vssx","vssm","vstx","vstm"],Pdf:["pdf"],Loop:["loop","fluid"]}},23918:(e,t,i)=>{i.d(t,{Y:()=>f});var r=i(91675),o=i(51171),s=i(57718),n=i(86178),a=i.n(n),l=i(14983),d=function(){function e(){this.id=s.cM(),this.name="",this.fileType=l.Er.Other,this.url="",this.modifiedDate=a()(),this.childCount=-1,this.itemPath="/drive/root:"}return e.prototype.build=function(){return new f(this)},e.prototype.withPropertyBag=function(e){return this.id=e.id||this.id,this.name=e.name||this.name,this.fileType=e.fileType||this.fileType,this.url=e.url||this.url,this.modifiedDate=e.modifiedDate||this.modifiedDate,this.childCount=void 0!==e.childCount?e.childCount:this.childCount,this.itemPath=e.itemPath||this.itemPath,this},e.prototype.withDefaultValues=function(){return this.withPropertyBag({id:"driveItemId",name:"Item1",fileType:l.Er.Other,url:"driveItemUrl",modifiedDate:a()(),itemPath:"/drive/root:",childCount:-1})},e.prototype.fromGraphDriveItemResource=function(e){return this.withPropertyBag({id:e.id,name:e.name,fileType:e.folder?l.Er.Other:e.package?f.GetType(e.package.type):f.GetFileType(e.name),url:e.webUrl,modifiedDate:a()(e.lastModifiedDateTime),childCount:e.folder?e.folder.childCount:-1,itemPath:e.parentReference.path})},e}(),c=i(98990),u=i.n(c),h=i(55491),p=i.n(h),m=i(54320),g=i.n(m),f=function(){function e(e){if(g()(e.id))throw new o.L("id");if(g()(e.name))throw new o.L("name");if(g()(e.url))throw new o.L("url");this.id=e.id,this.name=e.name,this.url=e.url,this.fileType=e.fileType,this.description=e.description,this.modifiedDate=e.modifiedDate,this.childCount=e.childCount,this.itemPath=e.itemPath}return Object.defineProperty(e,"builder",{get:function(){return new d},enumerable:!1,configurable:!0}),e.GetType=function(e){switch(e.toLowerCase()){case"excel":return l.Er.Excel;case"onenote":return l.Er.OneNote;case"pdf":return l.Er.Pdf;case"powerpoint":return l.Er.PowerPoint;case"project":return l.Er.Project;case"visio":return l.Er.Visio;case"word":return l.Er.Word;case"loop":return l.Er.Loop;default:return l.Er.Other}},e.GetFileType=function(t){var i=l.Er.Other,o=t.slice(t.lastIndexOf(".")+1);return p()(r.t,(function(t,r){u()(t,(function(e){return e.toLowerCase()===o.toLowerCase()}))&&(i=e.GetType(r))})),i},e}()},26796:(e,t,i)=>{i.d(t,{z:()=>s});var r=i(57718),o=function(){function e(){this.bytesSent=0,this.groupId="",this.id=r.cM(),this.itemName="",this.itemSize=0,this.itemId="",this.lastUploadRequestSucceeded=!1,this.uploadUrl="",this.name="",this.webUrl="",this.nextExpectedRanges=void 0}return e.prototype.build=function(){return new s(this)},e.prototype.withPropertyBag=function(e){return this.bytesSent=e.bytesSent||this.bytesSent,this.expirationDateTime=e.expirationDateTime||this.expirationDateTime,this.groupId=e.groupId||this.groupId,this.id=e.id||this.id,this.itemId=e.itemId||this.itemId,this.itemName=e.itemName||this.itemName,this.itemSize=e.itemSize||this.itemSize,this.lastUploadRequestSucceeded=null!=e.lastUploadRequestSucceeded?e.lastUploadRequestSucceeded:this.lastUploadRequestSucceeded,this.uploadUrl=e.uploadUrl||this.uploadUrl,this.name=e.name||this.name,this.webUrl=e.webUrl||this.webUrl,this.nextExpectedRanges=e.nextExpectedRanges||this.nextExpectedRanges,this},e.prototype.withDefaultValues=function(){return this.id="DriveItemUploadSessionId",this.bytesSent=0,this.groupId="GroupId",this.itemId="itemId",this.itemName="sampleFile.txt",this.itemSize=28,this.uploadUrl="UploadURL",this.name="sampleFile.txt",this.expirationDateTime=new Date("2020-09-02"),this.webUrl="https://contoso.com/sites/group/sampleFile.txt",this.nextExpectedRanges=["26-"],this},e}(),s=function(){function e(e){this.bytesSent=e.bytesSent,this.expirationDateTime=e.expirationDateTime,this.groupId=e.groupId,this.id=e.id,this.itemId=e.itemId,this.itemName=e.itemName,this.itemSize=e.itemSize,this.lastUploadRequestSucceeded=e.lastUploadRequestSucceeded,this.uploadUrl=e.uploadUrl,this.name=e.name,this.webUrl=e.webUrl,this.nextExpectedRanges=e.nextExpectedRanges}return Object.defineProperty(e,"builder",{get:function(){return new o},enumerable:!1,configurable:!0}),e.prototype.getClone=function(){return e.builder.withPropertyBag({bytesSent:this.bytesSent,expirationDateTime:this.expirationDateTime,groupId:this.groupId,id:this.id,itemId:this.itemId,itemName:this.itemName||"",itemSize:this.itemSize||0,lastUploadRequestSucceeded:this.lastUploadRequestSucceeded,uploadUrl:this.uploadUrl,name:this.name,webUrl:this.webUrl,nextExpectedRanges:this.nextExpectedRanges}).build()},e.prototype.setProperty=function(e,t){if("id"===e)throw new Error("ReadOnlyException: "+e);var i=this.getClone();return i[e]=t,i},e}()},57718:(e,t,i)=>{function r(e){for(var t="";t.length<e;){var i=16*Math.random();t+=(i|=0).toString(16)}return t}i.d(t,{cM:()=>o});function o(){var e=[];e.push(r(8)),e.push(r(4));var t="4"+r(3);e.push(t);var i=r(4),o=parseInt(i[0],16);return o&=3,i=(o|=8).toString(16)+i.substr(1),e.push(i),e.push(r(12)),e.join("-")}}}]);
//# sourceMappingURL=groupdocumentsac.4e582eb4.chunk.js.map