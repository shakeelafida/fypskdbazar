"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[65354],{83126:(e,t,i)=>{i.r(t),i.d(t,{CacheKeys:()=>W,SharepointInformationProtectionService:()=>j});var r=i(60835),s=i(74906);class o extends Map{set(e,t){return super.set(e,t.then()),this}get(e){var t;return null===(t=super.get(e))||void 0===t?void 0:t.then()}}var a=i(27284);var n=i(40635),l=i(74405),c=i(18206),d=i(29018),p=i(37805),h=i(93537);const u={allowedAttributes:["term","scheme","rel","href","type","m:null","m:type"],allowedNamespaces:["http://www.w3.org/2005/Atom","http://schemas.microsoft.com/ado/2007/08/dataservices/metadata","http://schemas.microsoft.com/ado/2007/08/dataservices","http://www.georss.org/georss","http://www.opengis.net/gml"],allowedTags:["entry","id","category","link","title","updated","author","name","content","m:properties","d:AppliedActionsText","d:ComplianceUrl","d:GeneralText","d:OverrideOptions","d:LastProcessedTime","d:MatchedConditionDescriptions","d:element","d:TwoLetterISOLanguageName","d:GetDlpPolicyTip"]};function g(e,t){const i=e.getElementsByTagName(t);return 1===i.length&&i[0].textContent?i[0].textContent:""}var m=i(85874);function v(e){const t=[408,409,503];return e&&(0,m.e9)(e)&&t.push(709,710),{maxRetries:2,backoffFn:(0,p.FT)(500),filter:(0,h.sC)(t),respectRetryAfterHeader:!0}}function y(e){const t=[503];return e&&(0,m.e9)(e)&&t.push(709,710),{respectRetryAfterHeader:!0,maxRetries:3,filter:(0,h.sC)(t),backoffFn:(0,p.Ed)(100)}}const b={Watermark:"#microsoft.graph.security.addWatermarkAction",Metadata:"#microsoft.graph.security.metadataAction"},L=2e4;function f(e){var t;const i=null===e||void 0===e||null===(t=e.value)||void 0===t?void 0:t.filter((e=>{if(e["@odata.type"]===b.Metadata)return e}));return 1===i.length?i[0]:void 0}const P="https://graph.microsoft.com/beta/",I="https://graph.microsoft.com/v1.0/",C=["InformationProtectionPolicy.Read"];async function w(e,t,i,r,s){const o=null===s||void 0===s?void 0:s.user.upn,a=(0,m.yg)(r),c=a&&o,d="GetPolicyLabels",p=c?I+"users/".concat(o,"/informationProtection/sensitivityLabels"):P+"me/security/informationProtection/sensitivityLabels?$filter=contentFormats/any(s:s eq 'file')",h=G(t,d);c&&h.set("Accept-Language","default");const u={getToken:t=>e.getToken(C,t),url:p,retryPolicy:y(r),timeoutMs:L,additionalRequestHeaders:h},g=i?(0,n.g)({...u,logger:i,nameForLogging:d,getAdditionalProps:async(e,t)=>({...(0,l.u)(e),hasUpn:!!o,shouldFilterUDPLabels:a})}):(0,n.y)(u),v=(await g).result;if(404===v.status)return[];if(!v.ok||200!==v.status)throw new Error("".concat(d," failed with status : ").concat(v.status));const b=await v.json();return c?E(b.value):b.value}function E(e,t){if(!e)return[];const i=[];for(const r of e)if(!M(r.labelActions)){const e=T(r,t);i.push(e,...E(r.sublabels,e))}return i}function T(e,t){var i,r,s;return{id:e.id,name:e.displayName,description:null!==(i=e.description)&&void 0!==i?i:"",isActive:e.isEnabled,sensitivity:e.priority,tooltip:null!==(r=e.toolTip)&&void 0!==r?r:"",color:null!==(s=e.color)&&void 0!==s?s:"#000000",parent:t||null,hasProtection:R(e.labelActions)}}function S(e){return"encryptWith"in e}function R(e){return!!e&&e.some((e=>S(e)&&"template"===e.encryptWith))}function M(e){return!!e&&e.some((e=>S(e)&&"userDefinedRights"===e.encryptWith))}function A(e){return{metadata:[{name:"MSIP_Label_".concat(e,"_Enabled"),value:"true"}]}}async function x(e,t,i,r,s,o,a){const n=P+"me/security/informationProtection/sensitivityLabels/evaluateApplication",l=G(i,"EvaluateApplication"),d={contentInfo:s||A(t),labelingOptions:{labelId:t,downgradeJustification:{isDowngradeJustified:!!r,justificationMessage:r||""}}},p=await(0,c.z$)((t=>e.getToken(C,t)),n,"EvaluateApplication",o,void 0,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)},y(a),L,void 0,l);if(!p.ok||200!==p.status)throw new Error("evaluateLabelApplication failed with status : ".concat(p.status));const h=await p.json(),u=function(e){var t;const i=null===e||void 0===e||null===(t=e.value)||void 0===t?void 0:t.filter((e=>{if(e["@odata.type"]===b.Watermark)return e}));return 1===i.length?i[0]:void 0}(h),g=f(h);return null!==g&&void 0!==g&&g.metadataToAdd?{changeLabel:!0,contentInfo:{metadata:g.metadataToAdd},watermark:u}:{changeLabel:!1}}async function N(e,t,i,r,s,o,a,p){const h=(0,m.p3)(p)?await async function(e,t,i,r,s,o,a){const c=(0,d.$)(r),p=G(s,"extractSensitivityLabels"),h={getToken:s=>{const o={...s,siteUrl:r,driveId:i,itemId:t};return e.getToken(["".concat(c,"/files.readwrite.all")],o)},url:"".concat(c,"/_api/v2.0/drives/").concat(i,"/items/").concat(t,"/oneDrive.extractSensitivityLabels"),requestInit:{method:"POST",headers:{"Content-Type":"application/json"}},retryPolicy:v(a),timeoutMs:L,additionalRequestHeaders:p},u=o?await(0,n.g)({...h,logger:o,nameForLogging:"extractSensitivityLabels",getAdditionalProps:async(e,t)=>(0,l.u)(e)}):await(0,n.y)(h);if(!u.result.ok||200!==u.result.status)throw new Error("extractInformationProtectionContentLabels failed with status : ".concat(u.result.status));const g=await u.result.json();return g}(e,t,i,r,o,a,p):await async function(e,t,i,r,s,o,a,n){const l=new URL(r).hostname,d="".concat(I,"sites/").concat(l,"/drives/").concat(i,"/items/").concat(t,"/extractSensitivityLabels"),p=t=>e.getToken(["files.readwrite.all"],t),h=G(o,"extractSensitivityLabels"),u=await(0,c.z$)(p,d,"extractSensitivityLabels",a,s,{method:"POST"},y(n),L,void 0,h);if(!u.ok||200!==u.status)throw new Error("extractInformationProtectionContentLabels failed with status : ".concat(u.status));const g=await u.json();return g}(e,t,i,r,s,o,a,p);let u=null===h||void 0===h?void 0:h.labels.find((e=>e.tenantId===s));return!u&&null!==h&&void 0!==h&&h.labels.length&&h.labels.length>0&&(0,m.Ix)(p)&&(u=h.labels[0]),u}async function k(e,t,i,s,o,a,c,p){const h=(0,d.$)(s),y=G(a,"GetDlpPolicyTip"),b=await(0,r.OF)(e,s,i,t,c),f=null===b||void 0===b?void 0:b.sharepointIds.listItemUniqueId,P=null===b||void 0===b?void 0:b.webDavUrl.replace(h,""),I=(0,m.hP)(p),C={getToken:r=>{const o={...r,siteUrl:s,driveId:i,itemId:t};return e.getToken(["".concat(h,"/files.readwrite.all")],o)},url:I&&f?"".concat(s,"/_api/web/getList('").concat(P,"')/getItemByUniqueId('").concat(f,"')/getDlpPolicyTip"):"".concat(s,"/_api/web/getListItem('").concat(P,"')/getdlppolicytip"),retryPolicy:v(p),timeoutMs:L,additionalRequestHeaders:y},w=c?await(0,n.g)({...C,logger:c,nameForLogging:"GetDlpPolicyTip",getAdditionalProps:async(e,t)=>({...(0,l.u)(e),isFileIdUsedForDlpTip:I,hasGuid:!!f})}):await(0,n.y)(C);if(!w.result.ok||200!==w.result.status)throw new Error("getDlpTooltip failed with status : ".concat(w.result.status));const E=await w.result.text();return await async function(e,t){let i;i=t?(0,(await t).createXML)(e,u):e;const r=(new DOMParser).parseFromString(i,"text/xml"),s=r.querySelector("parsererror");if(s)throw new Error("parseDlpPolicyTip failed to parse : ".concat(s.textContent));const o=r.querySelector("content");if(o){const e=g(o,"d:GeneralText"),t=g(o,"d:AppliedActionsText"),i=g(o,"d:ComplianceUrl"),r=g(o,"d:OverrideOptions"),s=r?parseInt(r,10):void 0,a=g(o,"d:LastProcessedTime"),n=function(e,t){const i=e.getElementsByTagName(t),r=[];if(1===i.length)for(let s=0;s<i[0].children.length;s+=1){const e=i[0].children[s].textContent;r.push(e||"")}return r}(o,"d:MatchedConditionDescriptions");if([e,t,i,s,a,n.length].every((e=>!e)))return;return{generalText:e,appliedActionsText:t,complianceUrl:i,overrideOptions:void 0!==s?s:NaN,lastProcessedTime:a,matchedConditionDescriptions:n}}}(E,o)}function G(e,t){const i="".concat(e.scenario||"InformationProtection","_").concat(e.subScenario||t||"Undefined",",");return new Headers({Application:e.application||"Undefined",Scenario:i,ScenarioType:e.scenarioType,Version:e.appVersion||"0.0.0"})}var D=i(20057),U=i(19352),O=i(64993),H=i(95996),q=i(33788);const W={AppliedLabel:"AppliedLabel",IrmCapabilities:"IrmCapabilities",IsProtectionEnabled:"IsProtectionEnabled",PolicySettings:"PolicySettings",Watermark:"Watermark",DlpPolicyTip:"DlpPolicyTip",Labels:"Labels",IsMandatoryLabelingRequired:"IsMandatoryLabelingRequired"};class j extends a.EventEmitter{clone(){return new j(this.props)}createAttributionHeaders(e){return{application:this.props.applicationName||"Loop",appVersion:this.props.appVersion||"0.0.0",scenarioType:e||"AUO",scenario:"InformationProtection"}}get Disposable(){return this}dispose(){this.disposed=!0,window.clearInterval(this.refreshTimer),window.clearTimeout(this.mandatoryLabelTimeout),this.removeAllListeners(),this.PromiseCache.clear(),this.labelMetadataCache=void 0,this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:U.S.InformationProtectionServiceDisposed,protectionChangedListenerCount:this.listenerCount("protectionChanged"),watermarkChangedListenerCount:this.listenerCount("watermarkingChanged"),mandatoryLabelRequiredListenerCount:this.listenerCount("mandatoryLabelRequired"),irmCapabilitiesChangedListenerCount:this.listenerCount("IrmCapabilitiesChanged"),sensitivityLabelChangedListenerCount:this.listenerCount("sensitivityLabelChanged"),dlpPolicyTipListenerCount:this.listenerCount("dlpPolicyTip"),sensitivityErrorListenerCount:this.listenerCount("sensitivityError"),sensitivityLabelChangeAttemptedListenerCount:this.listenerCount("sensitivityLabelChangeAttempted")}),delete this.labelMetadataCache,delete this.refreshTimer,delete this.mandatoryLabelTimeout}get InformationProtectionService(){return this}async getSupportsCLP(e,t){return void 0===this.supportsCLP&&await this.getIrmInformation(e,t),this.supportsCLP}getCacheKey(e,t){if(void 0!==t)return e+"_"+t}async getCurrentLabel(e,t,i){if(!(0,r.g2)(e))return void(this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.GetAppliedLabel}));const o=this.getCacheKey(W.AppliedLabel,e.hashedDocumentId);let a=o&&this.PromiseCache.get(o);if(a)return a;const n=q.m.start("GetAppliedLabel",this.props.logger),l=(0,s.n)(e.siteUrl,this.props.logger);if(l)return a=(async()=>{try{const r=await N(this.props.tokenProvider,e.itemId,e.driveId,e.siteUrl,l,this.createAttributionHeaders(t),this.props.logger,this.props.settingsProvider);return this.monitorAppliedLabel(e),i&&!r?void n.setResult(!(0,m.E7)(this.props.settingsProvider),{skipDefaultLabeling:i}):(this.processPolicySettings(e,r,"AUO"),n.setResult(!0,{appliedLabel:!!r,sensitivityLabelId:null===r||void 0===r?void 0:r.sensitivityLabelId,assignmentMethod:null===r||void 0===r?void 0:r.assignmentMethod}),r)}catch(r){return o&&this.PromiseCache.delete(o),void n.setResult(!1,{errorType:D.N.GetAppliedLabelError},r)}})(),o&&this.PromiseCache.set(o,a),a.then();n.setResult(!1,{errorType:D.N.InvalidTenantId})}async getHasProtection(e,t){if(!(0,r.g2)(e))return void(this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.GetIsProtectionEnabled}));const i=this.getCacheKey(W.IsProtectionEnabled,e.hashedDocumentId);let s=i&&this.PromiseCache.get(i);if(s)return s;const o=q.m.start("IsProtectionEnabled",this.props.logger);return s=(async()=>{const[r,s]=await Promise.all([this.getCurrentLabel(e,t),this.getLabels(t)]);if(r&&!s)return o.setResult(!1,{hasProtection:!1,appliedLabel:!!r,allLabels:!!s}),void(i&&this.PromiseCache.delete(i));let a=!1;if(r&&s){const e=function(e,t){const i=e.filter((e=>e.id===t));return 1===i.length?i[0]:void 0}(s,r.sensitivityLabelId);a=!(null===e||void 0===e||!e.hasProtection)}return o.setResult(!0,{appliedLabel:!!r,allLabels:!!s,hasProtection:a}),a})(),i&&this.PromiseCache.set(i,s),s.then()}async getIrmInformation(e,t){if(!(0,r.g2)(e))return void(this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.GetIrmCapabilities}));const i=this.createAttributionHeaders(t),s=this.getCacheKey(W.IrmCapabilities,e.hashedDocumentId);let o=s&&this.PromiseCache.get(s);if(o)return o;const a=q.m.start("GetIrmCapabilities",this.props.logger);return o=(async()=>{try{const t=await async function(e,t,i,r,s,o,a){const c=(0,d.$)(r),p=G(s,"getItemIrmCapabilities"),h={getToken:s=>{const o={...s,siteUrl:r,driveId:i,itemId:t};return e.getToken(["".concat(c,"/files.readwrite.all")],o)},url:"".concat(r,"/_api/v2.1/drives/").concat(i,"/items/").concat(t,"/opStream/capabilities?$select=canWrite,canPrint,canExtract,supportsCLP"),retryPolicy:v(a),timeoutMs:L,additionalRequestHeaders:p},u=o?await(0,n.g)({...h,logger:o,nameForLogging:"GetItemIrmCapabilities",getAdditionalProps:async(e,t)=>(0,l.u)(e)}):await(0,n.y)(h);if(!u.result.ok||200!==u.result.status)throw new Error("getItemIrmCapabilities failed with status : ".concat(u.result.status));return await u.result.json()}(this.props.tokenProvider,e.itemId,e.driveId,e.siteUrl,i,this.props.logger,this.props.settingsProvider);return this.supportsCLP=t.supportsCLP,a.setResult(!0,{supportsCLP:t.supportsCLP,canWrite:t.canWrite,canExtract:t.canExtract,canPrint:t.canPrint}),t}catch(t){return s&&this.PromiseCache.delete(s),a.setResult(!1,{errorType:D.N.GetIrmCapabilitiesError},t),void(this.supportsCLP=!1)}})(),s&&this.PromiseCache.set(s,o),o.then()}async getPolicySettings(e){let t=this.PromiseCache.get(W.PolicySettings.toString());if(t)return t;const i=q.m.start("GetPolicySettings",this.props.logger);return t=(async()=>{try{const t=await async function(e,t,i,r){const s=P+"me/security/informationProtection/labelPolicySettings",o=G(t,"GetPolicySettings"),a=await(0,c.z$)((t=>e.getToken(C,t)),s,"GetPolicySettings",i,void 0,void 0,y(r),L,void 0,o);if(404===a.status)return{id:"",moreInfoUrl:"",isDowngradeJustificationRequired:!1,isMandatory:!1,defaultLabelId:""};if(!a.ok||200!==a.status)throw new Error("getPolicySettings failed with status : ".concat(a.status));return await a.json()}(this.props.tokenProvider,this.createAttributionHeaders(e),this.props.logger,this.props.settingsProvider);return i.setResult(!0,{infoUrl:!!t.moreInfoUrl,isMandatory:t.isMandatory,isDefault:!!t.defaultLabelId,isDowngradeJustificationRequired:t.isDowngradeJustificationRequired}),t}catch(t){return this.PromiseCache.delete(W.PolicySettings.toString()),void i.setResult(!1,{errorType:D.N.GetPolicySettingsError},t)}})(),this.PromiseCache.set(W.PolicySettings.toString(),t),t.then()}async getWatermarkInformation(e,t){if(!(0,r.g2)(e))return void(this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.GetWatermarking}));const i=this.getCacheKey(W.Watermark,e.hashedDocumentId);let s=i&&this.PromiseCache.get(i);if(s)return s;const o=q.m.start("GetWatermarking",this.props.logger);return s=(async()=>{try{const i=await this.getCurrentLabel(e,t);if(i){const e=await x(this.props.tokenProvider,i.sensitivityLabelId,this.createAttributionHeaders(t),void 0,void 0,this.props.logger,this.props.settingsProvider);return this.labelMetadataCache=e.contentInfo,o.setResult(!0,{appliedLabel:!0,isWatermark:!!e.watermark,isContentInfo:!!e.contentInfo}),e.watermark}return void o.setResult(!0,{appliedLabel:!!i})}catch(r){return i&&this.PromiseCache.delete(i),void o.setResult(!1,{errorType:D.N.GetWatermarkingError},r)}})(),i&&this.PromiseCache.set(i,s),s.then()}async overrideDlpPolicyTip(e){throw new Error("Not Implemented..")}async getLabels(e){let t=this.PromiseCache.get(W.Labels.toString());if(t)return t;const i=q.m.start("GetLabels",this.props.logger);return t=(async()=>{try{const t=await w(this.props.tokenProvider,this.createAttributionHeaders(e),this.props.logger,this.props.settingsProvider,this.props.userContext);return i.setResult(!0),t}catch(t){return this.PromiseCache.delete(W.Labels.toString()),void i.setResult(!1,{errorType:D.N.GetLabelsError},t)}})(),this.PromiseCache.set(W.Labels.toString(),t),t.then()}async changeLabel(e,t,i){if(!(0,r.g2)(e))return!1;const s=await async function(e,t,i,r,s,o,a,c){const p=(0,d.$)(r),h=G(o,"SetLabel"),u={getToken:s=>{const o={...s,siteUrl:r,driveId:i,itemId:t};return e.getToken(["".concat(p,"/files.readwrite.all")],o)},url:"".concat(p,"/_api/v2.0/drives/").concat(i,"/items/").concat(t,"/setSensitivityLabel"),requestInit:{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)},retryPolicy:v(c),timeoutMs:L,additionalRequestHeaders:h};return 200===(a?await(0,n.g)({...u,logger:a,nameForLogging:"SetLabel",getAdditionalProps:async(e,t)=>(0,l.u)(e)}):await(0,n.y)(u)).result.status}(this.props.tokenProvider,e.itemId,e.driveId,e.siteUrl,t,this.createAttributionHeaders(i),this.props.logger,this.props.settingsProvider);return s&&this.refreshAppliedLabel(e,i),s}async setCurrentLabel(e,t,i){if(!(0,m.E7)(this.props.settingsProvider)){return q.m.start("SetLabel",this.props.logger).setResult(!1,{settingName:m.LV,settingValue:(0,m.E7)(this.props.settingsProvider),settingsProviderExists:void 0!==this.props.settingsProvider}),!1}if(!(0,r.g2)(e))return this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.SetLabel}),!1;if(null===t.id)return this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidLabelId,scenario:O.N.SetLabel}),!1;const s=q.m.start("SetLabel",this.props.logger);let o=!0;const a=await this.getSupportsCLP(e,i);try{const r=await x(this.props.tokenProvider,t.id,this.createAttributionHeaders(i),t.justificationText,this.labelMetadataCache,this.props.logger,this.props.settingsProvider);r.changeLabel&&!1!==a&&(o=await this.changeLabel(e,t,i)),s.setResult(o,{changeLabel:r.changeLabel,changeLabelStatus:o,assignmentMethod:t.assignmentMethod,actionSource:t.actionSource,sensitivityLabelId:t.id,ifMatchLabelId:t.ifMatchLabelId,supportsCLP:a})}catch(n){s.setResult(!1,{errorType:D.N.SetLabelError,assignmentMethod:t.assignmentMethod,actionSource:t.actionSource,sensitivityLabelId:t.id,ifMatchLabelId:t.ifMatchLabelId,supportsCLP:a},n),o=!1}return o||this.emit("sensitivityError"),o}async removeCurrentLabel(e,t,i){if(!(0,m.E7)(this.props.settingsProvider)){return q.m.start("RemoveLabel",this.props.logger).setResult(!1,{settingName:m.LV,settingValue:(0,m.E7)(this.props.settingsProvider),settingsProviderExists:void 0!==this.props.settingsProvider}),!1}if(!(0,r.g2)(e))return this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.RemoveLabel}),!1;if(null===t.id)return this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidLabelId,scenario:O.N.SetLabel}),!1;const s=q.m.start("RemoveLabel",this.props.logger);let o=!0;const a=await this.getSupportsCLP(e,i);try{const r=await async function(e,t,i,r,s,o,a){const n=P+"me/security/informationProtection/sensitivityLabels/evaluateRemoval",l=G(i,"EvaluateRemoval"),d={contentInfo:r||A(t),downgradeJustification:{isDowngradeJustified:!!s,justificationMessage:s||""}},p=await(0,c.z$)((t=>e.getToken(C,t)),n,"EvaluateRemoval",o,void 0,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)},y(a),L,void 0,l);if(!p.ok||200!==p.status)throw new Error("evaluateLabelRemoval failed with status : ".concat(p.status));const h=f(await p.json());return null!==h&&void 0!==h&&h.metadataToRemove?{changeLabel:!0}:{changeLabel:!1}}(this.props.tokenProvider,t.id,this.createAttributionHeaders(i),this.labelMetadataCache,t.justificationText,this.props.logger,this.props.settingsProvider);r.changeLabel&&!1!==a&&(t.id=null,o=await this.changeLabel(e,t,i),o&&(this.labelMetadataCache=void 0)),s.setResult(!0,{changeLabel:r.changeLabel,removeCurrentLabelStatus:o,assignmentMethod:t.assignmentMethod,actionSource:t.actionSource,supportsCLP:a})}catch(n){s.setResult(!1,{errorType:D.N.RemoveLabelError,supportsCLP:a},n),o=!1}return o||this.emit("sensitivityError"),o}async getDlpTooltip(e,t){if(!(0,m.y6)(this.props.settingsProvider))return;if(!(0,r.g2)(e))return void(this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.GetDlpPolicyTip}));const i=this.getCacheKey(W.DlpPolicyTip,e.hashedDocumentId);let s=i&&this.PromiseCache.get(i);if(s)return s;const o=q.m.start("GetDlpPolicyTip",this.props.logger);return s=(async()=>{try{const i=await k(this.props.tokenProvider,e.itemId,e.driveId,e.siteUrl,this.props.trustedTypesPolicy,this.createAttributionHeaders(t),this.props.logger,this.props.settingsProvider);return i&&this.emit("dlpPolicyTip",i),o.setResult(!0,{tip:!!i,moreInfoUrl:!(null===i||void 0===i||!i.complianceUrl),overrideOptions:null===i||void 0===i?void 0:i.overrideOptions}),i}catch(r){return i&&this.PromiseCache.delete(i),void o.setResult(!1,{errorType:D.N.GetDlpPolicyTipError},r)}})(),i&&this.PromiseCache.set(i,s),s.then()}async getIsMandatoryLabeling(e,t){if(!(0,m.E7)(this.props.settingsProvider)){return q.m.start("IsMandatoryLabelingRequired",this.props.logger).setResult(!1,{settingName:m.LV,settingValue:(0,m.E7)(this.props.settingsProvider),settingsProviderExists:void 0!==this.props.settingsProvider}),!1}if(!(0,r.g2)(e))return void(this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.GetIsProtectionEnabled}));const i=this.getCacheKey(W.IsMandatoryLabelingRequired,e.hashedDocumentId);let s=i&&this.PromiseCache.get(i);if(s)return s;const o=q.m.start("IsMandatoryLabelingRequired",this.props.logger);return s=(async()=>{const e=await this.getPolicySettings(t);if(!e)return o.setResult(!1,{policySettings:!!e}),void(i&&this.PromiseCache.delete(i));const r=e.isMandatory;return o.setResult(!0,{isMandatoryLabelingRequired:r}),r})(),i&&this.PromiseCache.set(i,s),s.then()}async enforceMandatoryLabelExperience(e,t){if(!(0,m.E7)(this.props.settingsProvider)||!(0,m.vY)(this.props.settingsProvider))return;if(!(0,r.g2)(e))return void(this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:D.N.InvalidResolvedUrl,scenario:O.N.EnforceMandatoryLabelExperience}));const i=q.m.start("EnforceMandatoryLabelExperience",this.props.logger),[s,o]=await Promise.all([this.getPolicySettings(t),this.getCurrentLabel(e,t)]);null!==s&&void 0!==s&&s.isMandatory&&!o&&(s.defaultLabelId?this.delayExecuteMandatoryLabeling(e,1e4,t):this.executeMandatoryLabeling()),i.setResult(!0)}delayExecuteMandatoryLabeling(e,t,i){this.mandatoryLabelTimeout||(this.mandatoryLabelTimeout=window.setTimeout((async()=>{await this.getCurrentLabel(e,i)||this.executeMandatoryLabeling()}),t))}async initialize(e){const t=q.m.start("Initialization",this.props.logger);await Promise.all([this.getLabels(e),this.getPolicySettings(e)]),t.setResult(!0)}async monitorAppliedLabel(e){if(window.clearInterval(this.refreshTimer),!this.disposed){const t=9e5;this.refreshTimer=window.setInterval((async()=>{this.props.logger&&(0,H.Ot)(this.props.logger,{eventName:U.S.RefreshTimerTriggered}),await this.refreshAppliedLabel(e,"AUO")}),t)}}async refreshAppliedLabel(e,t){if(!(0,r.g2)(e))return;const i=q.m.start("RefreshAppliedLabel",this.props.logger),s=(0,m.jP)(this.props.settingsProvider),o=await this.getCurrentLabel(e,t,s),a=this.getCacheKey(W.AppliedLabel,e.hashedDocumentId);a&&this.PromiseCache.delete(a);const n=await this.getCurrentLabel(e,t,s),l=(null===o||void 0===o?void 0:o.sensitivityLabelId)!==(null===n||void 0===n?void 0:n.sensitivityLabelId);if(l){this.emit("sensitivityLabelChanged",n);const i=this.getCacheKey(W.IrmCapabilities,e.hashedDocumentId);i&&this.PromiseCache.delete(i);const r=this.getCacheKey(W.Watermark,e.hashedDocumentId);r&&this.PromiseCache.delete(r);const[s,o]=await Promise.all([this.getIrmInformation(e,t),this.getWatermarkInformation(e,t)]);this.emit("IrmCapabilitiesChanged",s),this.emit("watermarkingChanged",o);const a=this.getCacheKey(W.IsProtectionEnabled,e.hashedDocumentId);a&&this.PromiseCache.delete(a);const l=await this.getHasProtection(e,t);this.emit("protectionChanged",l)}i.setResult(!0,{isRefreshed:l})}async processPolicySettings(e,t,i){const r=q.m.start("ProcessPolicySettings",this.props.logger);if(!(0,m.E7)(this.props.settingsProvider))return void r.setResult(!0,{settingName:m.LV,settingValue:(0,m.E7)(this.props.settingsProvider),settingsProviderExists:void 0!==this.props.settingsProvider});const s=await this.getPolicySettings(i||"AUO");if(!s)return void r.setResult(!1,{errorType:D.N.GetPolicySettingsError,scenario:O.N.ProcessPolicySettings});let o=!1;this.existingHostLabel&&(0,m.M6)(this.props.settingsProvider)&&(o=await this.executeInheritedLabeling(e,i),r.addAdditionalProps({executeInheritedLabel:o}));let a=!1;o||!s.defaultLabelId||null!==t&&void 0!==t&&t.sensitivityLabelId||(a=await this.executeDefaultLabeling(e,s.defaultLabelId,i),r.addAdditionalProps({defaultLabelingStatus:a}));let n=!1;!s.isMandatory||null!==t&&void 0!==t&&t.sensitivityLabelId||!(0,m.vY)(this.props.settingsProvider)||s.defaultLabelId&&a||(n=!0,this.executeMandatoryLabeling()),r.setResult(!0,{isDefault:!!s.defaultLabelId,executeInheritedLabel:o,defaultLabelingStatus:a,isMandatory:s.isMandatory,executeMandatoryLabel:n})}async executeDefaultLabeling(e,t,i){if(!(0,m.E7)(this.props.settingsProvider))return!1;const r={id:t,assignmentMethod:"standard",actionSource:"defaultLabel"};return await this.setCurrentLabel(e,r,i)}async executeInheritedLabeling(e,t){const i=q.m.start("ExecuteInheritedLabeling",this.props.logger);if(!this.existingHostLabel)return i.setResult(!1),!1;const r=this.existingHostLabel.sensitivityLabelId,s={id:r,assignmentMethod:"auto",actionSource:"auto"},o=await this.setCurrentLabel(e,s,t);return i.setResult(o,{existingHostLabel:r}),o&&(this.existingHostLabel=void 0),o}async executeMandatoryLabeling(){(0,m.E7)(this.props.settingsProvider)&&this.emit("mandatoryLabelRequired"),this.mandatoryLabelTimeout&&window.clearTimeout(this.mandatoryLabelTimeout)}constructor(e){super(),this.props=e,this.disposed=!1,this.existingHostLabel=e.existingHostLabel,this.setMaxListeners(0),this.PromiseCache=new o}}},20057:(e,t,i)=>{i.d(t,{N:()=>r});const r={ConfigureIrmCapabilitiesError:"ConfigureIrmCapabilitiesError",ConfigureMandatoryLabelError:"ConfigureMandatoryLabelError",ContainerAndComponentLifecycleMissingError:"ContainerAndComponentLifecycleMissingError",EnforceInformationProtectionError:"EnforceInformationProtectionError",GetAppliedLabelError:"GetAppliedLabelError",GetContainerAssignedLabelError:"GetContainerAssignedLabelError",GetContainerLabelsError:"GetContainerLabelsError",GetContainerPolicySettingsError:"GetContainerPolicySettingsError",GetDlpPolicyTipError:"GetDlpPolicyTipError",GetIrmCapabilitiesError:"GetIrmCapabilitiesError",GetLabelsError:"GetLabelsError",GetPolicySettingsError:"GetPolicySettingsError",GetWatermarkingError:"GetWatermarkingError",InitializationError:"InitializationError",InvalidLabelId:"InvalidLabelId",InvalidResolvedUrl:"InvalidResolvedUrl",InvalidTenantId:"InvalidTenantId",ProcessPolicySettingsError:"ProcessPolicySettingsError",RefreshLabelError:"RefreshLabelError",RemoveLabelError:"RemoveLabelError",SetLabelError:"SetLabelError"}},19352:(e,t,i)=>{i.d(t,{S:()=>r});const r={RefreshTimerTriggered:"RefreshTimerTriggered",MandatoryLabelHandlerSetReadOnly:"MandatoryLabelHandlerSetReadOnly",MandatoryLabelHandlerResetReadOnly:"MandatoryLabelHandlerResetReadOnly",InformationProtectionServiceDisposed:"InformationProtectionServiceDisposed",LogExtractSensitivityDiscrepancy:"LogExtractSensitivityDiscrepancy"}},64993:(e,t,i)=>{i.d(t,{N:()=>r});const r={EnforceInformationProtection:"EnforceInformationProtection",EnforceMandatoryLabelExperience:"EnforceMandatoryLabelExperience",GetAppliedLabel:"GetAppliedLabel",GetDlpPolicyTip:"GetDlpPolicyTip",GetIsProtectionEnabled:"GetIsProtectionEnabled",GetIrmCapabilities:"GetIrmCapabilities",GetWatermarking:"GetWatermarking",RefreshLabel:"RefreshLabel",RemoveLabel:"RemoveLabel",SetLabel:"SetLabel",ProcessPolicySettings:"ProcessPolicySettings"}}}]);
//# sourceMappingURL=SharepointInformationProtectionService.923a60fd.chunk.js.map