"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[41380],{36591:(e,t,a)=>{a.d(t,{C:()=>s});class s{constructor(e,t,a,s,i){this.dispatcher=e,this.logicModuleProviders=t,this.entityStoreSet=a,this.clientSettings=s,this.loggers=i}}},19401:(e,t,a)=>{a.r(t),a.d(t,{TaskActionCreator:()=>Ye});var s=a(23835),i=a(7574),r=a(27197),n=a(24367),o=a(75992);class l extends o.r{constructor(e,t,a){super(e),this.actionId=t,this.inverseCallback=a}}class c extends l{loggingData(){return{id:this.deletedTaskEntitySet.id}}constructor(e,t){super(c.actionType,c.actionType+e.id,t),this.deletedTaskEntitySet=e}}c.actionType="PLW_DELETE_TASK_UNDO";class d extends o.r{constructor(e){super(d.undoAction),this.actionId=e}}d.undoAction="UNDO_ACTION";var u=a(32084),g=a(72438),h=a(36591),p=a(38752),k=a(95783),v=a(74844),T=a(78332),f=a(64226),m=a(96891),y=a(23918),S=a(14983),w=a(91675),F=a(16698),D=a(98990),C=a.n(D),P=a(55491),b=a.n(P),I=a(69108),A=a.n(I),M=function(){function e(){this.taskAttachmentType=S.Er.Other,this.specificType=null,this.videoUrlParseResult={canPlay:!1,embedUrl:"",provider:"Unknown"}}return e.prototype.build=function(){return new E(this)},e.prototype.fromDriveItem=function(e,t){return this.taskAttachmentType=t.fileType,this.taskAttachmentType===S.Er.Other&&e&&(this.specificType=this.getSpecificType(e),this.videoUrlParseResult=F.W.TryParseVideoUrl(e)),this},e.prototype.fromFileName=function(e){var t=S.Er.Other,a=null,s=e.lastIndexOf(".");if(s>-1){var i=e.slice(s+1).toLowerCase();b()(w.t,(function(e,a){C()(e,(function(e){return e.toLowerCase()===i}))&&(t=E.getTaskAttachmentTypeFromString(a))})),A()(S.ig,i)>=0&&(a=i)}return this.specificType=a,this.taskAttachmentType=t,this},e.prototype.withPropertyBag=function(e){return this.taskAttachmentType=e.taskAttachmentType||this.taskAttachmentType,this.specificType=e.specificType||this.specificType,this.taskAttachmentType===S.Er.Other&&e.url&&(null==this.specificType&&(this.specificType=this.getSpecificType(e.url)),this.videoUrlParseResult=F.W.TryParseVideoUrl(e.url)),this},e.prototype.ofDriveItemType=function(e){return this.taskAttachmentType=e,this},e.prototype.getSpecificType=function(e){var t=e.slice(2+(e.lastIndexOf(".")-1>>>0)).split(/\#|\?|\&|\s/g);return t.length>0&&A()(S.ig,t[0].toLowerCase())>=0?t[0]:null},e}(),E=function(){function e(e){this.taskAttachmentType=e.taskAttachmentType,this.specificType=e.specificType,this.videoUrlParseResult=e.videoUrlParseResult}return Object.defineProperty(e,"builder",{get:function(){return new M},enumerable:!1,configurable:!0}),e.getTaskAttachmentTypeFromString=function(e){return S.Er[e]?S.Er[e]:S.Er.Other},e}(),B=a(65818),L=a(94772),O=a(95952),x=a(91181),R=a(87952),U=a(82025),H=a(18647),G=a(60653),N=a(71964),V=a(52274),j=a(80708),W=a(39589),_=a(23312),q=a(40468),X=a(8403),Y=a(56128),Z=a(34717),z=a(32561),K=a(97139),$=a(64696),J=a(17776),Q=a(62687),ee=a(70252),te=a(34648),ae=a(30275),se=a(26566),ie=a(97498),re=a(56434),ne=a.n(re),oe=a(50723),le=a.n(oe),ce=a(40840),de=a.n(ce),ue=a(54320),ge=a.n(ue),he=a(19853),pe=a.n(he),ke=a(56641),ve=a.n(ke),Te=a(10871),fe=a.n(Te),me=a(28673),ye=a.n(me),Se=a(92394),we=a.n(Se),Fe=a(56707),De=a.n(Fe),Ce=a(9821),Pe=a(79537),be=a(88880),Ie=a(86053),Ae=a(80347),Me=a(9962),Ee=a(39156),Be=a(98424),Le=a(91246),Oe=a(33268),xe=a(70776),Re=a(67271),Ue=a(7670),He=a(98502),Ge=a(49728),Ne=a(82841);const Ve=16,je=16,We=".",_e="$%@#";function qe(e){const t=function(e){try{const t=function(e){return t=atob(e.replace(/ /g,"")),t.split("").map((e=>e.charCodeAt(0)));var t}(e=e.replace(/_/g,"/").replace(/-/g,"+")),a=Xe(t.slice(0,Ve)),s=Xe(t.slice(Ve,Ve+je));let i=function(e,t){if(null===e||void 0===e||0===e.length)return e;let a=e.length;for(;--a>=0&&!(t.indexOf(e.charAt(a))<0););return e.substr(0,a+1)}(function(e){let t="";for(let a=0;a<e.length;++a)t+=String.fromCharCode(e[a]);return t}(t.slice(Ve+je)),We);const r={},n=i.split(_e);if(n.length>1){i=n[0];for(let e=1;e<n.length;e++){const t=n[e].split("=");t&&2===t.length&&(r[t[0]]=t[1])}}return{orgId:a,ownerId:s,tableId:i,moreInfo:r}}catch(t){return{orgId:null,ownerId:null,tableId:null,moreInfo:null}}}(e);let a=!1,s="0";return t.moreInfo&&("g"===t.moreInfo.t&&(a=!0),t.moreInfo.c&&(s=t.moreInfo.c)),{orgId:t.orgId,ownerId:t.ownerId,tableId:t.tableId,isGroupOwner:a,containerId:s}}function Xe(e){if(16!==e.length)return"";let t=function(e){let t="",a="";for(let s=0;s<e.length;s++)a=e[s].toString(16),a=1===a.length?"0"+a:a,t+=a;return t}([].concat(e.slice(0,4).reverse(),e.slice(4,6).reverse(),e.slice(6,8).reverse(),e.slice(8)));return t=t.slice(0,8)+"-"+t.slice(8,12)+"-"+t.slice(12,16)+"-"+t.slice(16,20)+"-"+t.slice(20),t}class Ye extends h.C{get name(){return m.M.TaskActionCreator}async addFormResponseToTask(e,t,a){const s=this.entityStoreSet.taskStore.getTaskDetails(e);if(null==s||null===t)return;const i=ne()(s.forms);i[a]=s.forms[a].setProperty("formResponse",t);const r=s.setProperty("forms",i);this.updateTaskDetails(s,r)}async fetchTasksForPlan(e,t,a){const s=await this.logicModuleProviders.planModule(),i=await this.logicModuleProviders.notificationModule();s.fetchPlanAsync(e).then((async()=>{(await this.logicModuleProviders.taskModule()).fetchPlanTasksAsync(e,t).then((async e=>{if(!a)return;const t=[];e.data.Results.forEach((e=>{e.task.getReferencedUserIds().forEach((e=>{-1===t.indexOf(e)&&t.push(e)}))}));(await this.logicModuleProviders.userModule()).fetchUsersAsync(t)}),(t=>{i.handleRequestFailures(t,[k.t3.Forbidden],[k.t3.NotFound],f.fc.GetTasksForPlanError,e)}))}),(t=>{i.handleRequestFailures(t,[k.t3.Forbidden],[k.t3.NotFound],f.fc.GetPlanError,e)}))}async fetchTaskEntityGroup(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=await this.logicModuleProviders.taskModule(),n=await this.logicModuleProviders.notificationModule();i.fetchTaskAsync(e,t).then((async e=>{(await this.logicModuleProviders.userModule()).fetchUsersAsync(e.task.getReferencedUserIds()).catch((()=>{}));const t=e.taskDetails;null!=t&&this.fetchPlanAndContainerBasedDependenciesForTask(e.task,t)})).catch((t=>{if(!(t.error instanceof V.U)&&!a){var i,o;const a=null===(i=t.response)||void 0===i?void 0:i.status,l=null===(o=t.response)||void 0===o?void 0:o.statusText;if(a===k.t3.NotFound){const t=this.entityStoreSet.taskStore.getTask(e);t?(this.dispatcher.dispatchAction(new r.o(j.F.builder.withTask(t).build(),!0)),this.dispatcher.dispatchAction(new s.i(f.fc.TaskNotFoundError,a,l,e,[t.title],void 0,l))):this.dispatcher.dispatchAction(new s.i(f.fc.UnknownTaskNotFoundError,a,l,e,void 0,void 0,l))}else n.handleRequestFailures(t,[],[k.t3.Forbidden],f.fc.GetTaskDetailsError,e)}}))}fetchReferencePreviewForTask(e){const t=this.entityStoreSet.taskStore.getTask(e),a=this.entityStoreSet.taskStore.getTaskDetails(e);if(null!==t&&void 0!==t&&t.hasPreview()&&null!=a){var s;const e=null!==(s=null===a||void 0===a?void 0:a.getTaskPreviewReference())&&void 0!==s?s:null;null!=e&&this.ensureTaskReferencePreviewThumbnail(a,e)}}async fetchFormResponseForTask(e,t){let a=null;try{var s;const i=await this.logicModuleProviders.driveItemModule(),r=await i.fetchFormResponse(e,t);if(({ownerId:a}=qe(r.formId)),!a)return void this.loggers.traceLogger.logTrace(507573833,v.k.Error,"fetchFormResponseForTask - ownerId is null [TaskId=".concat(e,"][FormId=").concat(t,"]"));const n=await this.logicModuleProviders.containerModule(),o=await n.fetchContainer({externalId:null!==(s=a)&&void 0!==s?s:"",containerType:B.K.Group},!0);if(!o.unifiedGroupDetails)return void this.loggers.traceLogger.logTrace(507576733,v.k.Error,"fetchFormResponseForTask - unifiedGroupDetails is null [TaskId=".concat(e,"][FormId=").concat(t,"][GroupId=").concat(o.unifiedGroup.id,"]"));i.fetchTaskFormResponseThumbnails(r,o.unifiedGroupDetails)}catch(i){const s=i;this.loggers.traceLogger.logTrace(507576732,v.k.Error,"fetchFormResponseForTask - Failed [TaskId=".concat(e,"][FormId=").concat(t,"][GroupId=").concat(a,"] ").concat((0,Ne.s8)(s)))}}fetchApprovalDetailsForTask(e){this.fetchApprovalDetailsForTaskAsync(e).catch((()=>{}))}createTask(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.createTaskAsync(e,void 0,t).catch((()=>{}))}createApproval(e,t){this.createApprovalAsync(e,t).catch((()=>{}))}copyTask(e,t){this.copyTaskAsync(e,t).catch((e=>{this.loggers.traceLogger.logTrace(507639451,v.k.Error,"Error copying task ".concat((0,Ne.LB)(e)))}))}async copyLinkToTask(e){var t;const a=this.entityStoreSet.taskStore.getTask(e);if(this.loggers.usageLogger.logData(this.name,m.M.TaskLinkCopied,{taskCreationSourceType:null!==(t=null===a||void 0===a?void 0:a.taskCreationSourceType)&&void 0!==t?t:""}),null!=this.shareDeepLinkCallback)this.shareDeepLinkCallback(e);else if(null==a)this.loggers.traceLogger.logTrace(507880145,v.k.Error,"copyLinkToTask - task not in store [TaskId=".concat(e,"]"));else{const t=await this.logicModuleProviders.linksModule().catch((()=>null));if(!t)return void this.loggers.traceLogger.logTrace(507531868,v.k.Error,"copyLinkToTask - failed to get LinksModule");let s=t.generateDeepLink(a.planId,e);if(s||(s=Oe.wS.generateEntityLink(a,f._n.TaskLink,f.rl.Link,new Date)),s){if(Ce.B.copyToClipboard(s)){const t=new O.N(e,a.title,s);this.dispatcher.dispatchAction(new n.Z(t))}}else this.loggers.traceLogger.logTrace(507561547,v.k.Error,"copyLinkToTask - generated taskLink is null")}}async moveTask(e,t){const a=this.entityStoreSet.taskStore.getTask(e),s=await this.logicModuleProviders.notificationModule();if(null==a)return void s.showErrorInternal(f.fc.MoveTaskError,void 0,void 0,t.plan.id);const i=j.F.builder.withTask(a).withFormatData(this.entityStoreSet.taskStore.getTaskboardTaskFormatting(a.id)||void 0).build();(await this.logicModuleProviders.planModule()).fetchPlanAsync(t.plan.id,!0).then((s=>{this.ensureBucket(t.bucketId,t.plan.id).then((async r=>{t={...t,bucketId:r?r.id:null};const n=await this.logicModuleProviders.taskModule();n.fetchTaskAsync(e).then((()=>{n.fetchPlanTasksAsync(t.plan.id).then((()=>{const e={bucketId:r?r.id:null,plan:t.plan,moveToDifferentContainer:t.moveToDifferentContainer};let n,o,l,c=a.getCloneForMove(e);const d=this.entityStoreSet.viewStore.getCurrentTaskGroupingState(Q.t.Plan);switch(d){case T.Yc.Progress:n=this.calculateProgressFormattingForCopyOrMove(a,i.taskFormatData,c);break;case T.Yc.Assignee:o=this.calculateAssignedToFormattingForCopyOrMove(a,i.taskFormatData,c);break;case T.Yc.Bucket:l=this.calculateBucketFormattingForCopyOrMove(a,i.taskFormatData,c);break;case T.Yc.Plan:if(!this.entityStoreSet.appContextStore.getFlights().EnableFixedSortForAtmViews){const e=this.calculateAssigneePriorityForCopyOrMove(a,c);c=c.setProperty("assigneePriority",e)}break;case T.Yc.DueDate:case T.Yc.Category:case T.Yc.Priority:case T.Yc.None:break;default:return void Pe.f.unreachableCase(d,(e=>{this.loggers.traceLogger.logTrace(507880144,v.k.Error,e)}))}const u=W._.builder.withPropertyBag({assignedBoardFormat:o,bucketBoardFormat:l,progressBoardFormat:n}).build(),g=i.getCloneForMove(e,u);this.logMoveTask(a,s,t),this.updateTask(j.F.builder.withTask(a).build(),g)}))}))}))}),(e=>{this.loggers.traceLogger.logTrace(507639450,v.k.Error,"Error loading plan for move task ".concat((0,Ne.LB)(e))),s.showErrorInternal(f.fc.MoveTaskError,void 0,void 0,t.plan.id)}))}assignTask(e){var t,a;const{userId:s,originalTask:i,updatedTask:r,elementToFocusOnDismiss:n,onAssignSuccess:o}=e,{planStore:l,userStore:c,taskStore:d,permissionsStore:u,containerStore:h,appContextStore:p}=this.entityStoreSet,k=i.planId,T=l.getPlan(k);if(null==T)return void this.loggers.traceLogger.logTrace(507880143,v.k.Error,"assignTask - plan not in store [planId=".concat(k,"]"));const f={planId:k,assigneeId:s},y=e;let S;if(!0===e.addNewMember)S=this.addNewMembersToContainer([s],T.container);else if(!0===y.shareFile){if(null==y.vroomId)return;S=this.shareDriveItem(y.vroomId,[s])}const w=null!==(t=l.getContainerIdForPlan(k))&&void 0!==t?t:"",F=(null!==(a=c.getContainerUsers(w))&&void 0!==a?a:[]).map((e=>e.id)),D=h.getContainer(w),C=F.indexOf(s)>-1,P=s===p.getCurrentUserId(),b=D&&u.getContainerPermissions(D),I=null===b||void 0===b?void 0:b.canViewMembers;if(null!=S||P||I&&C||(()=>{var e;const t=null!==(e=d.getTasksForPlan(k))&&void 0!==e?e:[];return!!(0,Ge.bN)(t)[s]})()){null===o||void 0===o||o(),this.loggers.usageLogger.logData(this.name,m.M.AssignTaskSuccessful,f);var A;if(Le.o.isPlexTempId(i.id))return void(null===(A=S)||void 0===A||A.catch((()=>{})));const e=j.F.builder.withTask(i).build(),t=j.F.builder.withTask(r).build();return void this.updateTaskAsync(e,t,void 0,S).catch((()=>{}))}const M=u.canAccessPlanViaSharedContainers(T.sharedWithContainers);return I&&!C?(this.dispatcher.dispatchAction(new g.o({dialogType:ie.h.AssignTaskWarning,userId:s,taskId:i.id,planId:k,assignerHasSharedContainerAccess:M,elementToFocusOnDismiss:n,onAssignSuccess:o})),void this.loggers.usageLogger.logData(this.name,m.M.AssignTaskBlockedByAddNonMember,f)):M?(this.dispatcher.dispatchAction(new g.o({dialogType:ie.h.ShareFileWarning,userId:s,taskId:i.id,planId:k,elementToFocusOnDismiss:n,onAssignSuccess:o})),void this.loggers.usageLogger.logData(this.name,m.M.AssignTaskBlockedByShareFile,f)):void 0}deleteTask(e,t){this.deleteTaskAsync(e,t).catch((()=>{}))}deleteTaskSeries(e){this.deleteTaskSeriesAsync(e).catch((()=>{}))}cancelApproval(e){this.cancelApprovalAsync(e).catch((()=>{}))}updateApprovalStatus(e,t,a){this.updateApprovalStatusAsync(e,t,a).catch((()=>{}))}async undeleteTask(e){const t=await this.logicModuleProviders.taskModule(),a=await this.logicModuleProviders.notificationModule();t.undeleteTaskAsync(e).then((e=>{const t=Oe.wS.generateEntityLink(e.task,f._n.TaskLink,f.rl.Link,new Date);this.dispatcher.dispatchAction(new n.Z(new N.f(e.task.title,t)))}),(t=>{if(!(t.error instanceof V.U)){var s,i;const r=null===(s=t.response)||void 0===s?void 0:s.status,n=null===(i=t.response)||void 0===i?void 0:i.statusText;a.showErrorInternal(f.fc.UndeleteTaskError,r,n,e.id,t.response,[e.task.title])}}))}updateTask(e,t){this.updateTaskAsync(e,t).catch((()=>{}))}updateTaskDetails(e,t){this.updateTaskDetailsInternal(e,t).catch((()=>{}))}ensureTaskReferencePreviewThumbnail(e,t){null!=this.entityStoreSet.taskStore.getTask(e.id)?this.fetchTaskContainer(e.id).then((async a=>{if(a.containerType!==B.K.Group)return;const s=a;if(s.unifiedGroupDetails){(await this.logicModuleProviders.driveItemModule()).fetchTaskReferenceThumbnails(e,s.unifiedGroupDetails,[t])}})).catch((e=>{this.loggers.traceLogger.logTrace(507880141,v.k.Warning,"ensureTaskReferencePreviewThumbnail - fetchTaskContainer Failed ".concat((0,Ne.s8)(e)))})):this.loggers.traceLogger.logTrace(507880142,v.k.Error,"ensureTaskReferencePreviewThumbnail - task not in store [TaskId=".concat(e.id,"]"))}async convertSuggestionToAttachment(e,t){var a;const s=this.entityStoreSet.taskStore.getTaskDetails(e),i=await this.logicModuleProviders.notificationModule();if(null==s)return;let r,o=t.webUrl||t.url;try{o=encodeURI(decodeURIComponent(o))}catch{return this.loggers.traceLogger.logTrace(507880140,v.k.Error,"Error encoding suggestion url for attachment [TaskId=".concat(e,"]")),void i.showErrorInternal(f.fc.ConvertSuggestionToAttachmentError,void 0,void 0,e)}const l=t.fileName.length>_.o.AliasMaxLength?t.fileName.substring(0,_.o.AliasMaxLength):t.fileName,c=y.Y.GetFileType(o);r=_.o.builder.withPropertyBag({url:o,alias:l,taskAttachmentType:E.builder.ofDriveItemType(c).build()}).build();if(ye()(null!==(a=s.references)&&void 0!==a?a:{}).indexOf(r.url)>-1)return void this.loggers.traceLogger.logTrace(507880139,v.k.Warning,"Suggestion already exists as attachment [TaskId=".concat(e,"][SuggestionId=").concat(t.uniqueId,"]"));let d;const u=s.getReferenceWithLowestPriority();let g;g=null!=u?Be.O.generateOrderHintBetween(null,u.previewPriority):Be.O.generateOrderHintBetween(null,null),r=r.setProperty("previewPriority",g),d=s.addAttachment(r),d.previewType===te.X.Automatic&&(d=d.setProperty("previewType",te.X.Reference)),this.loggers.usageLogger.logData(this.name,m.M.FileSuggestionToAttachment),this.updateTaskDetailsInternal(s,d).then((()=>{const e=new H.e(t.fileName);this.dispatcher.dispatchAction(new n.Z(e))})).catch((()=>{})),this.ensureTaskReferencePreviewThumbnail(d,r)}logMoveTask(e,t,a){var s,i;const r=this.entityStoreSet.planStore.getPlan(e.planId),n=this.entityStoreSet.planStore.getPlanDetails(e.planId),o=null!=r&&null!=n?q.T.getFirstDisplayableContextString(r,n):"",l=null!=t.planDetails?q.T.getFirstDisplayableContextString(t.plan,t.planDetails):"";this.loggers.usageLogger.logData(this.name,"MoveTask",{originalTaskId:e.id,sourcePlanId:e.planId,targetPlanId:a.plan.id,sourceBucketId:null!==(s=e.bucketId)&&void 0!==s?s:"",targetBucketId:null!==(i=a.bucketId)&&void 0!==i?i:"",sourcePlanDisplayAs:o,targetPlanDisplayAs:l})}async fetchApprovalDetailsForTaskAsync(e){const t=await this.logicModuleProviders.taskModule();await t.fetchTaskApprovalDetailsAsync(e)}async createApprovalAsync(e,t){return(await this.logicModuleProviders.taskModule()).createTaskApprovalAsync(e,t).then((()=>{this.fetchApprovalDetailsForTask(e)})).catch((()=>{}))}async cancelApprovalAsync(e){return(await this.logicModuleProviders.taskModule()).cancelApprovalAsync(e).then((()=>{this.fetchApprovalDetailsForTask(e)})).catch((()=>{}))}async updateApprovalStatusAsync(e,t,a){return(await this.logicModuleProviders.taskModule()).updateTaskApprovalAsync(e,t,a).then((()=>{this.fetchApprovalDetailsForTask(e)}))}updateTaskDetailsInternal(e,t){var a;const s=this.entityStoreSet.taskStore.getTask(e.id);if(null==s)throw new Me.m("originalTask","taskStore");this.loggers.usageLogger.logData(this.name,m.M.TaskDetailsUpdated,{taskCreationSourceType:null!==(a=s.taskCreationSourceType)&&void 0!==a?a:""});const i=j.F.builder.withPropertyBag({task:s,taskDetails:e}).build(),r=j.F.builder.withPropertyBag({task:s,taskDetails:t}).build();return this.updateTaskAsync(i,r)}fetchPlanAndContainerBasedDependenciesForTask(e,t){this.fetchTaskContainer(e.id).then((async e=>{if(e.containerType===B.K.Group){const a=e,s=De()(t.references);if(a.unifiedGroupDetails&&s.length>0){(await this.logicModuleProviders.driveItemModule()).fetchTaskReferenceThumbnails(t,a.unifiedGroupDetails,s)}}})).catch((e=>{this.loggers.traceLogger.logTrace(507880138,v.k.Warning,"fetchPlanAndContainerBasedDependenciesForTask - fetchTaskContainer Failed ".concat((0,Ne.s8)(e)))}))}async fetchTaskContainer(e){const t=this.entityStoreSet.taskStore.getTask(e);if(null==t){const e="fetchTaskContainer called for an uncached task";return this.loggers.traceLogger.logTrace(507880137,v.k.Warning,e),Promise.reject(He.g.generateAjaxClientError(null,e))}return(await this.logicModuleProviders.planModule()).fetchPlanAsync(t.planId).then((async e=>(await this.logicModuleProviders.containerModule()).fetchContainer(e.plan.container,!0).catch((e=>(this.loggers.traceLogger.logTrace(507880136,v.k.Warning,"fetchTaskContainer - fetchContainer Failed ".concat((0,Ne.s8)(e))),Promise.reject(e)))))).catch((e=>(this.loggers.traceLogger.logTrace(507880135,v.k.Warning,"fetchTaskContainer - fetchPlanAsync Failed ".concat((0,Ne.s8)(e))),Promise.reject(e))))}async shareDriveItem(e,t){try{const a=await this.logicModuleProviders.driveItemModule();await a.shareDriveItemAsync(e,t)}catch(a){const t=a;return(await this.logicModuleProviders.notificationModule()).handleRequestFailures(t,[k.t3.NotImplemented],[k.t3.Forbidden,k.t3.NotFound],f.fc.ShareDriveItemError,e),Promise.reject(t)}}async addNewMembersToContainer(e,t){const a=await this.logicModuleProviders.containerModule(),s=await this.logicModuleProviders.notificationModule();return a.addUsersToContainerAsync(t,e).then((()=>{}),(t=>{if(!(t.error instanceof V.U)){var a,i;const r=null===(a=t.response)||void 0===a?void 0:a.status,n=null===(i=t.response)||void 0===i?void 0:i.statusText;r===k.t3.NotImplemented?this.loggers.traceLogger.logTrace(507880134,v.k.Error,"addUsersToGroup - Not Implemented"):s.showErrorInternal(f.fc.AddUsersToGroupError,r,n,e.length.toString(),t.response)}return Promise.reject(t)}))}async generateTaskActivityFeed(e,t){if(null!=t.task){const a=t.task.planId;if(null==a)return;const s=this.entityStoreSet.planStore.getPlanDetails(a);if(null==s){(await this.logicModuleProviders.planModule()).fetchPlanAsync(a).then((a=>{if(null==a.planDetails)return void this.dispatcher.dispatchAction(new i.j(null,"","planDetails wasn't returned by fetchPlanAsync"));const s=new Date,r=Oe.wS.generateEntityLink(t.task,f._n.Comment,f.rl.GroupMailbox,s),n=Oe.wS.generateEntityLink(a.plan,f._n.Comment,f.rl.GroupMailbox,s),o=this.taskActivityFeedProvider.getTaskActivityFeed(e,t,a.planDetails.notifyWhen,a.plan,r,n);null!=o&&this.postActivityFeed(t.task,o)}),(()=>{}))}else{const i=this.entityStoreSet.planStore.getPlan(a);if(null==i)this.loggers.traceLogger.logTrace(507880133,v.k.Error,"generateTaskActivityFeed - plan not found [PlanId=".concat(a,"]"));else{const a=new Date,r=Oe.wS.generateEntityLink(t.task,f._n.Comment,f.rl.GroupMailbox,a),n=i?Oe.wS.generateEntityLink(i,f._n.Comment,f.rl.GroupMailbox,a):"",o=this.taskActivityFeedProvider.getTaskActivityFeed(e,t,s.notifyWhen,i,r,n);null!=o&&this.postActivityFeed(t.task,o)}}}}async postActivityFeed(e,t){if(null==e.planId)return;const a=this.entityStoreSet.planStore.getContainerIdForPlan(e.planId);if(null==a)return;const s=e.conversationThreadId,i=await this.logicModuleProviders.unifiedGroupModule();if(null!=s)i.postReplyInGroupConversationThread(a,s,t,!0).catch((e=>{var t;(null===(t=e.response)||void 0===t?void 0:t.status)===k.t3.NotFound&&this.dispatcher.dispatchAction(new u.x(a,s))}));else{const s=Le.o.generate(),r=be.i.getTaskCommentEmailSubject(e.title);i.createGroupConversationThread(a,s,t,e,r,!0).catch((()=>{}))}}async ensureBucket(e,t){if(e===T.iR)return Promise.resolve(null);const a=await this.logicModuleProviders.bucketModule();if(null==e){const e=X.f.builder.withPropertyBag({id:"",title:Ie.p.Strings.SharedComponents_DefaultBucketName,planId:t}).withLocallyUniqueId().build();return a.createBucketAsync(e)}{const s=await this.logicModuleProviders.notificationModule();return new Promise(((i,r)=>{a.fetchBucketsForPlanAsync(t,!0).then((s=>{let n=null;if(s&&s.length>0){for(const t of s)if(t.id===e){n=t;break}n?i(n):(s.sort(xe.k),i(s[0]))}else{const e=X.f.builder.withPropertyBag({id:"",title:Ie.p.Strings.SharedComponents_DefaultBucketName,planId:t}).withLocallyUniqueId().build();a.createBucketAsync(e).then((e=>{i(e)}),(e=>{r(e)}))}}),(e=>{const a=e;s.handleRequestFailures(a,[],[k.t3.Forbidden,k.t3.NotFound],f.fc.GetBucketsForPlanError,t),r(e)}))}))}}async copyTaskAsync(e,t){var a,s,i,r,n;try{const e=await this.logicModuleProviders.planModule();await e.fetchPlanAsync(t.plan.id,!0)}catch(D){const e=D;return(await this.logicModuleProviders.notificationModule()).handleRequestFailures(e,[],[k.t3.Forbidden,k.t3.NotFound],f.fc.GetPlanError,t.plan.id),Promise.reject(e)}const o=await this.ensureBucket(t.bucketId,t.plan.id);t={...t,bucketId:o?o.id:null};const l=await this.logicModuleProviders.taskModule(),c=await l.fetchTaskAsync(e);await l.fetchPlanTasksAsync(t.plan.id);const d=Le.o.generate();let u,g,h=te.X.Automatic;switch(c.task.previewType){case te.X.NoPreview:h=te.X.NoPreview;break;case te.X.Reference:h=t.copyReferences?te.X.Reference:te.X.Automatic;break;case te.X.CheckList:h=t.copyChecklist?te.X.CheckList:te.X.Automatic;break;case te.X.Description:h=t.copyDescription?te.X.Description:te.X.Automatic}if(t.copyAssignments&&!ge()(c.task.assignments)){const e={};de()(c.task.assignments,((t,a)=>{e[a]=new Y.I(t.assignedBy,t.assignedDate.toDate())})),u=e}t.copyRecurrence&&null!=(null===(a=c.task.recurrence)||void 0===a?void 0:a.schedule)&&(g=ae.G.builder.withRecurrenceSchedule(se.s.builder.withRecurrencePattern(ne()(c.task.recurrence.schedule.pattern)).build().setRecurrenceRangeStartDate(c.task.dueDate)).build());let p=Z.Y.builder.withPropertyBag({id:d,title:t.title,planId:t.plan.id,percentComplete:t.copyProgress?c.task.percentComplete:(0,Re.BK)(L.$.NotStarted),bucketId:t.bucketId,dueDate:t.copyDates&&null!==(s=c.task.dueDate)&&void 0!==s?s:void 0,startDate:t.copyDates&&null!==(i=c.task.startDate)&&void 0!==i?i:void 0,assignments:u,appliedCategories:t.copyLabels?c.task.appliedCategories:void 0,previewType:h,priority:c.task.priority,numberOfActiveChecklistItems:t.copyChecklist?c.task.numberOfActiveChecklistItems:void 0,numberOfChecklistItems:t.copyChecklist?c.task.numberOfChecklistItems:void 0,numberOfReferences:t.copyReferences?c.task.numberOfReferences:void 0,recurrence:g}).build();if(!c.taskDetails)throw new Ee.n("ensuredTaskEntitySet.taskDetails");const v=c.taskDetails.getCopy(),m=z.U.builder.withPropertyBag({id:d,previewType:h,checklist:t.copyChecklist?v.checklist:void 0,description:t.copyDescription&&null!==(r=v.description)&&void 0!==r?r:void 0,notes:t.copyDescription&&v.notes&&null!==(n={content:v.notes.content,contentType:v.notes.contentType})&&void 0!==n?n:void 0,references:t.copyReferences?v.references:void 0}).build();let y=null,S=null,w=null;switch(this.entityStoreSet.viewStore.getCurrentTaskGroupingState(Q.t.Plan)){case T.Yc.Progress:y=this.calculateProgressFormattingForCopyOrMove(c.task,c.taskFormatData,p,t);break;case T.Yc.Assignee:S=this.calculateAssignedToFormattingForCopyOrMove(c.task,c.taskFormatData,p,t);break;case T.Yc.Bucket:w=this.calculateBucketFormattingForCopyOrMove(c.task,c.taskFormatData,p);break;case T.Yc.Plan:if(!this.entityStoreSet.appContextStore.getFlights().EnableFixedSortForAtmViews){const e=this.calculateAssigneePriorityForCopyOrMove(c.task,p);p=p.setProperty("assigneePriority",e)}}const F=W._.builder.withPropertyBag({assignedBoardFormat:S||void 0,bucketBoardFormat:w||void 0,progressBoardFormat:y||void 0}).build();return this.createTaskAsync(j.F.builder.withTask(p).withDetails(m).withFormatData(F).build(),void 0,!0)}async createTaskAsync(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const i=await this.logicModuleProviders.taskModule();if(e.id&&null==e.taskDetails){const t=z.U.builder.withId(e.id).build();e=j.F.builder.forClone(e).withDetails(t).build()}const r=j.F.builder.withDetails(e.taskDetails).withTask(e.task).withFormatData(e.taskFormatData).build(),o=await this.logicModuleProviders.notificationModule();return i.createTaskAsync(r,t,((e,t)=>{var n,l;const c=null===(n=e.response)||void 0===n?void 0:n.status,d=null===(l=e.response)||void 0===l?void 0:l.statusText,u=()=>{o.showErrorInternal(f.fc.CreateTaskError,c,d,void 0,e.response,[r.task.title])};if(c!==k.t3.BadRequest||s)t(),u();else try{i.fixTaskOrderHintPrecision(null,r,u,this.reorderTaskGroups.bind(this),((e,t,s)=>this.fixCreateTask(e,t,s,a)),t)}catch(g){this.loggers.traceLogger.logTrace(507639449,v.k.Error,"createTaskAsync - fixTaskOrderHintPrecision failed ".concat((0,Ne.LB)(g))),t(),u()}})).then((e=>{if(a){const t=new x.g(e.task.id,e.task.title,Oe.wS.generateEntityLink(e.task,f._n.TaskLink,f.rl.Link,new Date));this.dispatcher.dispatchAction(new n.Z(t))}else o.enqueueHiddenToastNotification("SharedComponents_CreateTaskToastTitle",[],r.task.title);this.loggers.usageLogger.logData(this.name,m.M.CreateTask,{isCopyOperation:String(a)});const t=ye()(e.task.assignments);if(!ge()(t)){const a={planId:e.task.planId,assigneeIds:t.join(",")};this.loggers.usageLogger.logData(this.name,m.M.AssignTaskSuccessful,a)}const s=this.entityStoreSet.appContextStore.getCurrentUserId(),i=this.entityStoreSet.userStore.getUserDetailsById(s);return null!==i&&void 0!==i&&i.isUserAccessWithin24Hours()&&this.loggers.usageLogger.logData(this.name,m.M.CreateTaskIn24h,{isCopyOperation:String(a)}),this.generateTaskActivityFeed(null,e),e}))}async deleteTaskAsync(e,t){const a=this.entityStoreSet.taskStore.getTask(e);if(null==a)throw this.loggers.usageLogger.logData(this.name,"deleteTask::task not in store",{taskId:e}),new Me.m("task","taskStore");try{var s,i;this.loggers.usageLogger.logData(this.name,m.M.DeleteTask);const r=await this.logicModuleProviders.taskModule(),o=await r.deleteTaskAsync(e,t),l=new c(o,(()=>this.undeleteTask(o)));this.dispatcher.dispatchAction(l);const u=new U.W(a.title,(()=>{this.dispatcher.dispatchAction(new d(l.actionId))}));this.dispatcher.dispatchAction(new n.Z(u)),null!==(s=a.recurrence)&&void 0!==s&&s.isActive()&&null!=(null===(i=o.task.recurrence)||void 0===i?void 0:i.nextInSeriesTaskId)&&this.fetchTaskEntityGroup(o.task.recurrence.nextInSeriesTaskId)}catch(l){const t=l,a=await this.logicModuleProviders.notificationModule();if(!(t.error instanceof V.U)){var r,o;const s=null===(r=t.response)||void 0===r?void 0:r.status,i=null===(o=t.response)||void 0===o?void 0:o.statusText;a.showErrorInternal(f.fc.DeleteTaskError,s,i,e,t.response)}}}async deleteTaskSeriesAsync(e){const t=this.entityStoreSet.taskStore.getTask(e);if(null==t)throw new Me.m("task","taskStore");const a=j.F.builder.withTask(t).build(),s=t.setRecurrenceSchedule(null);let i=!1;try{const e=await this.logicModuleProviders.taskModule(),r=await e.updateTaskAsync(a,j.F.builder.withTask(s).build());i=!0,this.loggers.usageLogger.logData(this.name,m.M.DeleteTask),await e.deleteTaskAsync(r.task.id,r.task.itemVersion);const o=new R.N(t.title);this.dispatcher.dispatchAction(new n.Z(o))}catch(l){const t=l;if(!(t.error instanceof V.U)){var r,o;const a=await this.logicModuleProviders.notificationModule(),s=null===(r=t.response)||void 0===r?void 0:r.status,n=null===(o=t.response)||void 0===o?void 0:o.statusText,l=i?f.fc.DeleteRecurringTaskSeriesDeleteError:f.fc.DeleteRecurringTaskSeriesUpdateError;a.showErrorInternal(l,s,n,e,t.response)}}}async updateTaskAsync(e,t){var a,i,r,o,l,c;let d=arguments.length>2&&void 0!==arguments[2]&&arguments[2],u=arguments.length>3?arguments[3]:void 0;const g=await this.logicModuleProviders.taskModule();if(ve()(e,t,Ae.lz.isEqualMomentCustomizer))return Promise.resolve(t);const h=e.task.getDiff(t.task),p=null!=e.taskDetails&&null!=t.taskDetails?e.taskDetails.getDiff(t.taskDetails):{},T=null!=(null===(a=e.taskFormatData)||void 0===a?void 0:a.assignmentBoardFormat)&&null!=(null===(i=t.taskFormatData)||void 0===i?void 0:i.assignmentBoardFormat)?e.taskFormatData.assignmentBoardFormat.getDiff(t.taskFormatData.assignmentBoardFormat):{},m=null!=(null===(r=e.taskFormatData)||void 0===r?void 0:r.bucketBoardFormat)&&null!=(null===(o=t.taskFormatData)||void 0===o?void 0:o.bucketBoardFormat)?e.taskFormatData.bucketBoardFormat.getDiff(t.taskFormatData.bucketBoardFormat):{},y=null!=(null===(l=e.taskFormatData)||void 0===l?void 0:l.progressBoardFormat)&&null!=(null===(c=t.taskFormatData)||void 0===c?void 0:c.progressBoardFormat)?e.taskFormatData.progressBoardFormat.getDiff(t.taskFormatData.progressBoardFormat):{};this.logUpdateTaskUsage(h,e.task,t.task),this.logUpdateTaskDetailsUsage(p,e.taskDetails,t.taskDetails),this.logUpdateTaskFormatsUsage(e.id,T,m,y);const S=await this.logicModuleProviders.notificationModule();return g.updateTaskAsync(e,t,u,((a,i)=>{var r,n;const o=null===(r=a.response)||void 0===r?void 0:r.status,l=null===(n=a.response)||void 0===n?void 0:n.statusText,c=()=>{S.showErrorInternal(f.fc.UpdateTaskError,o,l,e.id,a.response)};if(o===k.t3.Conflict)i(),g.fetchTaskAsync(e.id,!0).catch((e=>{this.loggers.traceLogger.logTrace(507880132,v.k.Warning,"UpdateTaskAsync - 409 Recovery - fetchTaskAsync Fail ".concat((0,Ne.s8)(e)))}));else if(o!==k.t3.BadRequest||d)if(o===k.t3.NotFound){const t=e.task?e.task.title:"";this.dispatcher.dispatchAction(new s.i(f.fc.UpdateDeletedTaskInfo,o,l,e.id,[t]))}else i(),c();else try{g.fixTaskOrderHintPrecision(e,t,c,this.reorderTaskGroups.bind(this),this.fixUpdateTask.bind(this),i)}catch(u){this.loggers.traceLogger.logTrace(507639448,v.k.Error,"updateTaskAsync - fixTaskOrderHintPrecision failed ".concat((0,Ne.LB)(u))),i(),c()}})).then((a=>{var s,i;if(null!=e.task&&null!=a.task&&this.generateTaskActivityFeed(e,a),null!=e.task&&null!=t.task&&e.task.planId!==t.task.planId){const e=new G.c(t.task.id,t.task.title,Oe.wS.generateEntityLink(t.task,f._n.TaskLink,f.rl.Link,new Date));this.dispatcher.dispatchAction(new n.Z(e))}else S.announceTaskUpdates(h,e.task),e.taskDetails&&S.announceTaskDetailsUpdates(p,e.taskDetails),S.announceTaskReorder(h,T,m,y,e,a.task.title);return null!==(s=e.task.recurrence)&&void 0!==s&&s.isActive()&&null!=(null===(i=a.task.recurrence)||void 0===i?void 0:i.nextInSeriesTaskId)&&this.fetchTaskEntityGroup(a.task.recurrence.nextInSeriesTaskId),a}),(t=>(this.loggers.traceLogger.logTrace(507880131,v.k.Info,"Task update failed - [TaskCreationSourceType=".concat(e.task.taskCreationSourceType,"]")),Promise.reject(t))))}logUpdateTaskUsage(e,t,a){if(!ge()(e)){const e=this.entityStoreSet.appContextStore.getCurrentUserId(),n=this.entityStoreSet.userStore.getUserDetailsById(e),o=!!n&&n.isUserAccessWithin24Hours();if(this.loggers.usageLogger.logData(this.name,m.M.TaskUpdated,{taskCreationSourceType:t.taskCreationSourceType}),o&&this.loggers.usageLogger.logData(this.name,m.M.TaskUpdatedIn24h,{taskCreationSourceType:t.taskCreationSourceType}),!pe()(t.assignments,a.assignments)){const e=le()(ye()(a.assignments),(e=>null==t.assignments[e])),i=le()(ye()(t.assignments),(e=>null==a.assignments[e])),r=e.length,n=i.length;if(r>0||n>0){var s;const e=null!=(null===(s=this.entityStoreSet.planStore.getPlanDetails(a.planId))||void 0===s?void 0:s.background.overlayImage);this.loggers.usageLogger.logData(this.name,m.M.TaskAssigned,{newAssigmentsCount:String(r),removedAssignmentsCount:String(n),planHasBackground:String(e),taskCreationSourceType:t.taskCreationSourceType}),o&&this.loggers.usageLogger.logData(this.name,m.M.TaskAssignedIn24h,{newAssigmentsCount:String(r),removeAssignmentsCount:String(n),taskCreationSourceType:t.taskCreationSourceType})}}var i,r;if(t.percentComplete!==a.percentComplete&&(this.loggers.usageLogger.logData(this.name,m.M.TaskProgressChanged,{taskCreationSourceType:t.taskCreationSourceType}),(0,Re.Fk)(a.percentComplete)===L.$.Complete&&this.loggers.usageLogger.logData(this.name,m.M.TaskCompleted,{taskCreationSourceType:t.taskCreationSourceType}),(0,Re.Fk)(t.percentComplete)===L.$.Complete&&this.loggers.usageLogger.logData(this.name,m.M.TaskReactivated,{taskCreationSourceType:t.taskCreationSourceType})),pe()(t.appliedCategories,a.appliedCategories)||(t.appliedCategories.length>a.appliedCategories.length?this.loggers.usageLogger.logData(this.name,m.M.RemoveLabelFromTask,{taskCreationSourceType:t.taskCreationSourceType}):t.appliedCategories.length<a.appliedCategories.length&&this.loggers.usageLogger.logData(this.name,m.M.AddLabelToTask,{taskCreationSourceType:t.taskCreationSourceType})),t.bucketId!==a.bucketId)this.loggers.usageLogger.logData(this.name,"TaskBucketUpdated",{sourceBucketId:null!==(i=t.bucketId)&&void 0!==i?i:"null",targetBucketId:null!==(r=a.bucketId)&&void 0!==r?r:"null",taskCreationSourceType:t.taskCreationSourceType});if(t.priority!==a.priority&&this.loggers.usageLogger.logData(this.name,"TaskPriorityUpdated",{taskCreationSourceType:t.taskCreationSourceType}),!pe()(t.startDate,a.startDate)){let e="TaskStartDate";t.startDate?a.startDate?e+="Updated":e+="Removed":e+="Set",this.loggers.usageLogger.logData(this.name,e,{taskCreationSourceType:t.taskCreationSourceType})}if(!pe()(t.dueDate,a.dueDate)){let e="TaskDueDate";t.dueDate?a.dueDate?e+="Updated":e+="Removed":e+="Set",this.loggers.usageLogger.logData(this.name,e,{taskCreationSourceType:t.taskCreationSourceType})}t.title!==a.title&&this.loggers.usageLogger.logData(this.name,"TaskTitleUpdated",{taskCreationSourceType:t.taskCreationSourceType}),ve()(t.recurrence,a.recurrence,Ae.lz.isEqualMomentCustomizer)||this.loggers.usageLogger.logData(this.name,"TaskRecurrenceChanged",{taskCreationSourceType:t.taskCreationSourceType})}}logUpdateTaskDetailsUsage(e,t,a){if(!ge()(e)&&null!=t&&null!=a){if(t.description!==a.description){let e="TaskNotes";ge()(t.description)?e+="Set":ge()(a.description)?e+="Removed":e+="Updated",this.loggers.usageLogger.logData(this.name,e)}if(!pe()(t.checklist,a.checklist)){const e=le()(ye()(a.checklist),(e=>null==t.checklist[e])),s=le()(ye()(t.checklist),(e=>null==a.checklist[e])),i=e.length,r=s.length;(i>0||r>0)&&this.loggers.usageLogger.logData(this.name,"TaskChecklist",{newChecklistCount:String(i),removedChecklistCount:String(r)})}if(!pe()(t.references,a.references)){const e=le()(ye()(a.references),(e=>null==t.references[e])),s=le()(ye()(t.references),(e=>null==a.references[e])),i=e.length,r=s.length;(i>0||r>0)&&this.loggers.usageLogger.logData(this.name,"TaskAttachments",{newAttachmentsCount:String(i),removedAttachmentsCount:String(r)})}if(e.previewType){let t="TaskPreviewType";e.previewType===te.X.NoPreview?t+="Removed":t+="Set",this.loggers.usageLogger.logData(this.name,t,{previewType:String(a.previewType)})}}}logUpdateTaskFormatsUsage(e,t,a,s){let i={};ge()(t)||(i={...i,assigneeOrderHintsFormat:String(!ge()(t.orderHintsByAssignee)),unassignedOrderHintFormat:String(!ge()(t.unassignedOrderHint))}),ge()(a)||(i={...i,bucketFormat:String(!0)}),ge()(s)||(i={...i,progressFormat:String(!0)}),ge()(i)||this.loggers.usageLogger.logData(this.name,"TaskFormatsUpdated",i)}reorderTaskGroups(e,t){const a=[];return b()(e,(e=>{t?ge()(e.aboveTasks)||null==e.aboveTasks?a.push(Promise.resolve(e)):a.push(this.reorderTaskCard(e.aboveTasks,e)):ge()(e.belowTasks)||null==e.belowTasks?a.push(Promise.resolve(e)):a.push(this.reorderTaskCard(e.belowTasks,e))})),ge()(a)?Promise.resolve([]):Promise.allSettled(a).then((e=>{const t=[];let a=!1,s=null;return b()(e,(e=>{"rejected"===e.status?(a=!0,s=e.reason):null==e.value?a=!0:t.push(e.value)})),a?Promise.reject(s):t}))}fixCreateTask(e,t,a){let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=t.taskFormatData;null!=i&&b()(a,(e=>{i=e.setOrderHint(i,e.nextOrderHint,e.pivotValue)}));const r=j.F.builder.withTask(t.task).withDetails(t.taskDetails).withFormatData(i).build();return new Promise(((e,t)=>{this.createTaskAsync(r,void 0,s,!0).then((t=>{const s=[];b()(a,(e=>{e.nextOrderHint=Be.O.generateOrderHintBetween(null!=t.taskFormatData?e.getOrderHint(t.taskFormatData,e.pivotValue):null,null),s.push(e)})),e(s)}),(e=>{t(e)}))}))}fixUpdateTask(e,t,a){if(null==e)return Promise.reject("originalTaskInfo is null!");let s=t.taskFormatData;null!=s&&b()(a,(e=>{s=e.setOrderHint(s,e.nextOrderHint,e.pivotValue)}));const i=j.F.builder.withTask(t.task).withDetails(t.taskDetails).withFormatData(s).build();return new Promise(((t,s)=>{this.updateTaskAsync(e,i,!0).then((e=>{const s=[];b()(a,(t=>{t.nextOrderHint=Be.O.generateOrderHintBetween(null!=e.taskFormatData?t.getOrderHint(e.taskFormatData,t.pivotValue):null,null),s.push(t)})),t(s)}),(e=>{s(e)}))}))}async reorderTaskCard(e,t){const a=await this.logicModuleProviders.taskModule();return new Promise(((s,i)=>{const r=e.shift();if(null==r){const e="reorderTaskCard null task",t=new Response("Bad request",{status:k.t3.BadRequest,statusText:"Bad Request"});i(He.g.generateAjaxClientError(t,e))}else if(A()(this.inProgressTaskReorderIds,r.id)>-1)e.unshift(r),setTimeout((()=>{this.reorderTaskCard(e,t).then((e=>{s(e)}),(e=>{i(e)}))}),4e3);else{this.inProgressTaskReorderIds.push(r.id);const n=j.F.builder.withTask(r).withFormatData(this.entityStoreSet.taskStore.getTaskboardTaskFormatting(r.id)||void 0).build(),o=n.taskFormatData?t.setOrderHint(n.taskFormatData,t.nextOrderHint,t.pivotValue):n.taskFormatData;a.updateTaskAsync(n,j.F.builder.withTask(r).withFormatData(o).build()).then((a=>{we()(this.inProgressTaskReorderIds,r.id),t.nextOrderHint=Be.O.generateOrderHintBetween(a.taskFormatData?t.getOrderHint(a.taskFormatData,t.pivotValue):null,null),e.length>0?this.reorderTaskCard(e,t).then((e=>{s(e)}),(e=>{i(e)})):s(t)}),(e=>{if(we()(this.inProgressTaskReorderIds,r.id),!(e.error instanceof V.U)){var t;(null===(t=e.response)||void 0===t?void 0:t.status)===k.t3.Conflict&&this.fetchTaskEntityGroup(n.id,!0,!0)}i(e)}))}}))}calculateProgressFormattingForCopyOrMove(e,t,a,s){const i=this.entityStoreSet.taskStore.getTasksForPlan(a.planId)||[],r=fe()(this.entityStoreSet.taskStore.getTaskboardTaskFormattingForPlan(a.planId,ee.s.Progress),"id"),n=(0,Ue.py)(i,r,!0);let o,l=null,c=null,d=null;if(s&&!s.copyProgress){var u,g;const e=n.filter((e=>e.pivotValue===L.$.NotStarted))[0],t=null!==(u=null===e||void 0===e||null===(g=e.dataEntities)||void 0===g?void 0:g[0])&&void 0!==u?u:null;if(null!=t){var h;const e=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(t.id);l=null!==(h=null===e||void 0===e?void 0:e.progressBoardFormat)&&void 0!==h?h:null}o=Be.O.generateOrderHintBetween(null,l?l.orderHint:null)}else{const s=n.filter((t=>t.pivotValue===(0,Re.Fk)(e.percentComplete)))[0];if(e.planId===a.planId){var p;if(null!==s&&void 0!==s&&s.dataEntities){const t=s.dataEntities.indexOf(e);if(t<s.dataEntities.length-1){var k;const e=s.dataEntities[t+1],a=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);l=null!==(k=null===a||void 0===a?void 0:a.progressBoardFormat)&&void 0!==k?k:null}}c=null!==(p=null===t||void 0===t?void 0:t.progressBoardFormat)&&void 0!==p?p:null}else if(null!==s&&void 0!==s&&s.dataEntities&&s.dataEntities.length>0){var v;const e=s.dataEntities[0],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);l=null!==(v=null===t||void 0===t?void 0:t.progressBoardFormat)&&void 0!==v?v:null}o=Be.O.generateOrderHintBetween(c?c.orderHint:null,l?l.orderHint:null)}return d=K.j.builder.withPropertyBag({id:a.id,orderHint:o}).build(),d}calculateAssignedToFormattingForCopyOrMove(e,t,a,s){const i=this.entityStoreSet.planStore.getPlan(a.planId),r=this.entityStoreSet.taskStore.getTasksForPlan(a.planId)||[],n=fe()(this.entityStoreSet.taskStore.getTaskboardTaskFormattingForPlan(a.planId,ee.s.AssignedTo),"id");let o;null==i?(this.loggers.traceLogger.logTrace(507880130,v.k.Error,"calculateAssignedToFormattingForCopyOrMove - no plan for task [TaskId=".concat(a.planId,"]")),o=""):o=i.container.externalId;const l=fe()(this.entityStoreSet.userStore.getContainerUsers(o),"id"),c=(0,Ue.Fy)(r,n,l,this.entityStoreSet.appContextStore.getCurrentUserId());let d=null,u=null,g=null;if(s&&!s.copyAssignments){var h,p;const e=c.filter((e=>null===e.pivotValue))[0],t=null!==(h=null===e||void 0===e||null===(p=e.dataEntities)||void 0===p?void 0:p[0])&&void 0!==h?h:null;if(null!=t){var k;const e=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(t.id);d=null!==(k=null===e||void 0===e?void 0:e.assignmentBoardFormat)&&void 0!==k?k:null}const s=Be.O.generateOrderHintBetween(null,d?d.unassignedOrderHint:null);g=$.x.builder.withPropertyBag({id:a.id,unassignedOrderHint:s}).build()}else if(ge()(e.getAssigneeIds())){const s=c.filter((e=>null===e.pivotValue))[0];if(e.planId===a.planId){var T;const a=null!==s&&void 0!==s&&s.dataEntities?s.dataEntities.indexOf(e):-1;if(null!==s&&void 0!==s&&s.dataEntities&&a<s.dataEntities.length-1){var f;const e=s.dataEntities[a+1],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);d=null!==(f=null===t||void 0===t?void 0:t.assignmentBoardFormat)&&void 0!==f?f:null}u=null!==(T=null===t||void 0===t?void 0:t.assignmentBoardFormat)&&void 0!==T?T:null}else if(null!==s&&void 0!==s&&s.dataEntities&&s.dataEntities.length>0){var m;const e=s.dataEntities[0],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);d=null!==(m=null===t||void 0===t?void 0:t.assignmentBoardFormat)&&void 0!==m?m:null}const i=Be.O.generateOrderHintBetween(u?u.unassignedOrderHint:null,d?d.unassignedOrderHint:null);g=$.x.builder.withPropertyBag({id:a.id,unassignedOrderHint:i}).build()}else{const s={};b()(e.getAssigneeIds(),(i=>{const r=c.filter((e=>e.pivotValue===i))[0];if(e.planId===a.planId){var n;const a=null!==r&&void 0!==r&&r.dataEntities?r.dataEntities.indexOf(e):-1;if(null!==r&&void 0!==r&&r.dataEntities&&a<r.dataEntities.length-1){var o;const e=r.dataEntities[a+1],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);d=null!==(o=null===t||void 0===t?void 0:t.assignmentBoardFormat)&&void 0!==o?o:null}u=null!==(n=null===t||void 0===t?void 0:t.assignmentBoardFormat)&&void 0!==n?n:null}else if(null!==r&&void 0!==r&&r.dataEntities&&r.dataEntities.length>0){var l;const e=r.dataEntities[0],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);d=null!==(l=null===t||void 0===t?void 0:t.assignmentBoardFormat)&&void 0!==l?l:null}s[i]=Be.O.generateOrderHintBetween(u?u.orderHintsByAssignee[i]:null,d?d.orderHintsByAssignee[i]:null)})),g=$.x.builder.withPropertyBag({id:a.id,orderHintsByAssignee:s}).build()}return g}calculateBucketFormattingForCopyOrMove(e,t,a){var s;const i=this.entityStoreSet.taskStore.getTasksForPlan(a.planId)||[],r=fe()(this.entityStoreSet.taskStore.getTaskboardTaskFormattingForPlan(a.planId,ee.s.Bucket),"id");let n=null,o=null,l=null;const c=(0,Ue.M1)(i,r,null!==(s=this.entityStoreSet.bucketStore.getBucketsForPlan(a.planId))&&void 0!==s?s:[]).filter((e=>e.pivotValue===a.bucketId))[0];if(e.bucketId===a.bucketId){var d;const a=null!==c&&void 0!==c&&c.dataEntities?c.dataEntities.indexOf(e):-1;if(null!==c&&void 0!==c&&c.dataEntities&&a<c.dataEntities.length-1){var u;const e=c.dataEntities[a+1],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);n=null!==(u=null===t||void 0===t?void 0:t.bucketBoardFormat)&&void 0!==u?u:null}o=null!==(d=null===t||void 0===t?void 0:t.bucketBoardFormat)&&void 0!==d?d:null}else if(null!==c&&void 0!==c&&c.dataEntities&&c.dataEntities.length>0){var g;const e=c.dataEntities[0],t=this.entityStoreSet.taskStore.getTaskboardTaskFormatting(e.id);n=null!==(g=null===t||void 0===t?void 0:t.bucketBoardFormat)&&void 0!==g?g:null}const h=Be.O.generateOrderHintBetween(o?o.orderHint:null,n?n.orderHint:null);return l=J.g.builder.withPropertyBag({id:a.id,orderHint:h}).build(),l}calculateAssigneePriorityForCopyOrMove(e,t){const a=this.entityStoreSet.taskStore.getTasksForUser(p.B.currentUserId),s=a?a.filter((t=>e.isComplete()?t.isComplete():!t.isComplete())):[],i=s.map((e=>e.planId)),r=(0,Ue.V2)(s,i,[],!1).filter((e=>e.pivotValue===t.planId))[0];let n=null,o=null;if(e.planId===t.planId){var l;const t=null!==r&&void 0!==r&&r.dataEntities?r.dataEntities.indexOf(e):-1;if(null!==r&&void 0!==r&&r.dataEntities&&t<r.dataEntities.length-1){var c;n=null!==(c=r.dataEntities[t+1].assigneePriority)&&void 0!==c?c:null}o=null!==(l=e.assigneePriority)&&void 0!==l?l:null}else if(null!==r&&void 0!==r&&r.dataEntities&&r.dataEntities.length>0){var d;n=null!==(d=r.dataEntities[0].assigneePriority)&&void 0!==d?d:null}return Be.O.generateOrderHintBetween(o,n)}constructor(e,t,a,s,i,r){super(e,t,a,p.B.clientSettings,i),this.taskActivityFeedProvider=s,this.inProgressTaskReorderIds=[],this.shareDeepLinkCallback=r}}},39156:(e,t,a)=>{a.d(t,{n:()=>s});class s extends Error{constructor(e){super(),Object.setPrototypeOf(this,s.prototype),this.message="".concat(e," should not be null"),this.name="NullReferenceError"}}},70776:(e,t,a)=>{a.d(t,{k:()=>i});var s=a(28730);function i(e,t){return s.l.compareByOrderHint(t,e,(e=>e?e.orderHint:null))}},91675:(e,t,a)=>{a.d(t,{t:()=>s});var s={Word:["docx","docm","doc","dotx","dotm"],Excel:["xlsx","xlsm","xlsb","xltx","xltm","xls","xlam","xla","xlw","xml"],PowerPoint:["pptx","pptm","ppt","potx","potm","pot","thmx","pps","ppsx","ppsm","ppsam","ppa"],OneNote:["one"],Project:["mpp","mpt","mpd"],Visio:["vsdx","vsd","vsdm","vssx","vssm","vstx","vstm"],Pdf:["pdf"],Loop:["loop","fluid"]}},23918:(e,t,a)=>{a.d(t,{Y:()=>v});var s=a(91675),i=a(51171),r=a(57718),n=a(86178),o=a.n(n),l=a(14983),c=function(){function e(){this.id=r.cM(),this.name="",this.fileType=l.Er.Other,this.url="",this.modifiedDate=o()(),this.childCount=-1,this.itemPath="/drive/root:"}return e.prototype.build=function(){return new v(this)},e.prototype.withPropertyBag=function(e){return this.id=e.id||this.id,this.name=e.name||this.name,this.fileType=e.fileType||this.fileType,this.url=e.url||this.url,this.modifiedDate=e.modifiedDate||this.modifiedDate,this.childCount=void 0!==e.childCount?e.childCount:this.childCount,this.itemPath=e.itemPath||this.itemPath,this},e.prototype.withDefaultValues=function(){return this.withPropertyBag({id:"driveItemId",name:"Item1",fileType:l.Er.Other,url:"driveItemUrl",modifiedDate:o()(),itemPath:"/drive/root:",childCount:-1})},e.prototype.fromGraphDriveItemResource=function(e){return this.withPropertyBag({id:e.id,name:e.name,fileType:e.folder?l.Er.Other:e.package?v.GetType(e.package.type):v.GetFileType(e.name),url:e.webUrl,modifiedDate:o()(e.lastModifiedDateTime),childCount:e.folder?e.folder.childCount:-1,itemPath:e.parentReference.path})},e}(),d=a(98990),u=a.n(d),g=a(55491),h=a.n(g),p=a(54320),k=a.n(p),v=function(){function e(e){if(k()(e.id))throw new i.L("id");if(k()(e.name))throw new i.L("name");if(k()(e.url))throw new i.L("url");this.id=e.id,this.name=e.name,this.url=e.url,this.fileType=e.fileType,this.description=e.description,this.modifiedDate=e.modifiedDate,this.childCount=e.childCount,this.itemPath=e.itemPath}return Object.defineProperty(e,"builder",{get:function(){return new c},enumerable:!1,configurable:!0}),e.GetType=function(e){switch(e.toLowerCase()){case"excel":return l.Er.Excel;case"onenote":return l.Er.OneNote;case"pdf":return l.Er.Pdf;case"powerpoint":return l.Er.PowerPoint;case"project":return l.Er.Project;case"visio":return l.Er.Visio;case"word":return l.Er.Word;case"loop":return l.Er.Loop;default:return l.Er.Other}},e.GetFileType=function(t){var a=l.Er.Other,i=t.slice(t.lastIndexOf(".")+1);return h()(s.t,(function(t,s){u()(t,(function(e){return e.toLowerCase()===i.toLowerCase()}))&&(a=e.GetType(s))})),a},e}()},9821:(e,t,a)=>{a.d(t,{B:()=>n});var s=a(12358),i=a.n(s),r=a(34167),n=function(){function e(){}return e.copyToClipboard=function(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();var a=document.execCommand("copy");return document.body.removeChild(t),a},e.copyPrettifiedLinkToClipboard=function(e,t){var a=document.createElement("a");a.href=t,a.style.all="initial",a.innerText=e,document.body.appendChild(a);var s=document.createRange();s.selectNode(a);var n=window.getSelection();null===n||void 0===n||n.removeAllRanges(),null===n||void 0===n||n.addRange(s),a.oncopy=function(a){var s,n,o="<a href="+t+' style="all: initial;">'+i()(e)+"</a>";null===(s=a.clipboardData)||void 0===s||s.setData("text/plain",t);var l=new r.tR;l.inputString=o,null===(n=a.clipboardData)||void 0===n||n.setData("text/html",r.xC.sanitize(l)),a.preventDefault()};var o=document.execCommand("copy");return document.body.removeChild(a),o},e}()},57718:(e,t,a)=>{function s(e){for(var t="";t.length<e;){var a=16*Math.random();t+=(a|=0).toString(16)}return t}a.d(t,{cM:()=>i});function i(){var e=[];e.push(s(8)),e.push(s(4));var t="4"+s(3);e.push(t);var a=s(4),i=parseInt(a[0],16);return i&=3,a=(i|=8).toString(16)+a.substr(1),e.push(a),e.push(s(12)),e.join("-")}}}]);
//# sourceMappingURL=taskac.a58e4138.chunk.js.map