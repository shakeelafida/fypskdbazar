"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[87212],{87212:(e,t,s)=>{s.d(t,{LR:()=>w,VH:()=>k,yv:()=>f});var i=s(21605),o=s(24356),n=s(12624),r=s(76078),h=s(19307),a=s(11158),l=s(45019),d=s(84792);const u=50;class c{get working(){return"working"===this.workingState}get canceled(){return"canceled"===this.workingState}constructor(e,t,s,i,n,r){this.to=t,this.payloadSize=s,this.logger=i,this.requestCallback=n,this.responseCallback=r,this.results=new Map,this.workingState="working",this.requestsInFlight=0,this.endEvent=new o.c,this.requests=0,this.latestRequested=e,this.nextToDeliver=e,this.knewTo=void 0!==t}cancel(){this.working&&(this.workingState="canceled",this.endEvent.resolve())}async run(e){(0,n.v)(e>0,258),(0,n.v)(this.working,259);let t=e;for(;t>0;)t--,this.addRequest();return this.dispatch(),this.endEvent.promise}done(){(0,n.v)(void 0!==this.to,260),(0,n.v)(this.nextToDeliver>=this.to,261),this.working&&(this.workingState="done",this.endEvent.resolve())}fail(e){this.working&&(this.workingState="done",this.endEvent.reject(e))}dispatch(){for(;this.working;){const e=this.results.get(this.nextToDeliver);if(void 0===e)break;this.results.delete(this.nextToDeliver),(0,n.v)(e.length<=this.payloadSize,473),this.nextToDeliver+=e.length,this.responseCallback(e)}this.working&&(0===this.requestsInFlight?((0,n.v)(0===this.results.size,263),this.done()):void 0!==this.to&&this.nextToDeliver>=this.to&&((0,n.v)(!this.knewTo,264),this.done()))}getNextChunk(){if(!this.working)return;const e=this.latestRequested;return void 0!==this.to&&this.to<=e?void 0:(this.latestRequested+=this.payloadSize,void 0!==this.to&&(this.latestRequested=Math.min(this.to,this.latestRequested)),(0,n.v)(e<this.latestRequested,265),{from:e,to:this.latestRequested})}addRequest(){const e=this.getNextChunk();void 0!==e&&this.addRequestCore(e.from,e.to).catch(this.fail.bind(this))}async addRequestCore(e,t){(0,n.v)(this.working,266);let s=e,i=t;for(this.requestsInFlight++;this.working;){const e=i-s;(0,n.v)(e>0,267),void 0!==this.to&&((0,n.v)(s<this.to,268),(0,n.v)(i<=this.to,269)),this.requests++;const t=this.requestCallback(this.requests,s,i,void 0!==this.to,{});this.dispatch();const{payload:o,cancel:r,partial:h}=await t;if(r&&this.cancel(),void 0!==this.to&&s>=this.to){(0,n.v)(!this.knewTo,270),0!==o.length&&this.logger.sendErrorEvent({eventName:"ParallelRequests_GotExtra",from:s,to:i,end:this.to,length:o.length});break}if(this.working){const t=s,r=o.length;let a=e<=r;if(0!==r){e<r&&this.logger.sendTelemetryEvent({eventName:"ParallelRequests_Over",from:s,to:i,length:r});const t=o.splice(0,e);this.results.set(s,t),s+=t.length}else(0,n.v)(!h,271),(0,n.v)(!this.knewTo,272);if(!h&&!a){if(!this.knewTo){(void 0===this.to||this.to>s)&&(this.to=s);break}this.logger.sendPerformanceEvent({eventName:"ParallelRequests_Partial",from:t,to:i,length:r})}if(i===this.latestRequested){for(;0!==o.length;){const t=o.splice(0,e);this.results.set(s,t),s+=t.length}this.latestRequested=s,a=!0}if(a){const e=this.getNextChunk();if(void 0===e)break;s=e.from,i=e.to}}}this.requestsInFlight--,this.dispatch()}}class v{constructor(){this.queue=[],this.done=!1}pushValue(e){this.pushCore(Promise.resolve({done:!1,value:e}))}pushError(e){this.pushCore(Promise.reject(e)),this.done=!0}pushDone(){this.pushCore(Promise.resolve({done:!0})),this.done=!0}pushCore(e){(0,n.v)(!this.done,274),this.deferred?((0,n.v)(0===this.queue.length,275),this.deferred.resolve(e),this.deferred=void 0):this.queue.push(e)}async read(){(0,n.v)(void 0===this.deferred,276);const e=this.queue.shift();return void 0!==e?e:((0,n.v)(!this.done,277),this.deferred=new o.c,this.deferred.promise)}}const g=async()=>{var e;if(!1===(null===(e=globalThis.navigator)||void 0===e?void 0:e.onLine)&&void 0!==globalThis.addEventListener)return new Promise((e=>{const t=()=>{e(),globalThis.removeEventListener("online",t)};globalThis.addEventListener("online",t)}))};function f(e,t,s,o,f,w,k,p){let q,m=0,y=0;const b=new v,T={fromTotal:s,toTotal:o},R=r.Bt.start(w,{eventName:"GetDeltas",...T,reason:p}),E=new c(s,o,f,w,(async(t,s,o,n,c)=>(m++,async function(e,t,s,o,n,c){let v,f,w=0,k=0,p=0,q=u;for(;!0!==(null===n||void 0===n?void 0:n.aborted);){let n;k++;const u=i.F.now();try{const{messages:o,partialResult:n}=await e({...t,retry:k});var m;if(0!==o.length||!s)return null===(m=f)||void 0===m||m.end({duration:w,...t,reason:c}),{payload:o,cancel:!1,partial:n};if(void 0===v)v=i.F.now();else if(i.F.now()-v>3e4)throw(0,h.ix)("Failed to retrieve ops from storage (Too Many Retries)",{canRetry:!1},{retry:k,driverVersion:l.z,...t})}catch(y){n=y;const e=(0,h.YU)(y),s=(0,h.E9)(y);if((0,a.f)(o,{eventName:"GetDeltas_Error",...t,retry:k,duration:i.F.now()-u,retryAfter:s,reason:c},y),!e)throw y}void 0===f&&(p=i.F.now(),f=r.Bt.start(o,{eventName:"GetDeltasWaitTime"})),q=(0,d.F)(q,n),await new Promise((e=>{setTimeout(e,q)})),await g(),w+=i.F.now()-p}return{partial:!1,cancel:!0,payload:[]}}((async t=>e(s,o,t)),{request:t,from:s,to:o,...T,...c},n,w,k,p))),(e=>{void 0===q?(0,n.v)(e[0].sequenceNumber===s,621):(0,n.v)(e[0].sequenceNumber===q+1,622),q=e[e.length-1].sequenceNumber,(0,n.v)(q-e[0].sequenceNumber+1===e.length,623),y+=e.length,b.pushValue(e)})),C=e=>{E.cancel()};return void 0!==k&&k.addEventListener("abort",C),E.run(t).finally((()=>{void 0!==k&&k.removeEventListener("abort",C)})).then((()=>{const e={lastFetch:q,length:y,requests:m};E.canceled?R.cancel({...e,error:"ops request cancelled by client"}):((0,n.v)(void 0===o||void 0!==q&&q>=o-1,624),R.end(e)),b.pushDone()})).catch((e=>{R.cancel({lastFetch:q,length:y,requests:m},e),b.pushError(e)})),b}const w={read:async()=>({done:!0})};function k(e,t){return{read:async()=>{const s=await e.read();return t(s),s}}}}}]);
//# sourceMappingURL=87212.d08189db.chunk.js.map