/*! For license information please see 13255.3bc6efaf.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[13255],{13255:(e,t,o)=>{o.d(t,{I:()=>Ae});var s=o(76078),r=o(97652),n=o(55919),i=o(14826),a=o(89165),c=o(79478);class h{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:36e5;this.snapshotExpiryPolicy=e,this.cache=new Map,this.docIdExpirationMap=new Map}async get(e){const t=(0,c.V)(e);return this.cache.get(t)}async put(e,t){const o=(0,c.V)(e);this.cache.set(o,t),this.updateExpirationEntry(e.file.docId)}async removeEntries(e){this.removeDocIdEntriesFromCache(e.docId)}removeDocIdEntriesFromCache(e){return this.removeExpirationEntry(e),Array.from(this.cache).filter((t=>{let[o]=t;if(o.split("_")[0]===e)return!0})).map((e=>{let[t]=e;this.cache.delete(t)}))}removeExpirationEntry(e){const t=this.docIdExpirationMap.get(e);void 0!==t&&(clearTimeout(t),this.docIdExpirationMap.delete(e))}updateExpirationEntry(e){this.removeExpirationEntry(e),this.docIdExpirationMap.set(e,setTimeout((()=>{this.removeDocIdEntriesFromCache(e)}),this.snapshotExpiryPolicy))}}a.o;class l{constructor(){this.sessionJoinCache=new a.o,this.fileUrlCache=new a.o,this.snapshotPrefetchResultCache=new a.o}}var d=o(45792),u=o(72264),p=o(12624),g=o(21605);function m(e,t){var o,s;let r,n,i,a,c,h,l,d;const u=null!==(o=null===(s=g.F.getEntriesByType)||void 0===s?void 0:s.call(g.F,"resource"))&&void 0!==o?o:[];for(let p=u.length-1;p>0;p--){const o=u[p],s=o.name.toString();if(0===o.initiatorType.localeCompare(t)&&s.includes(e)){n=o.redirectEnd-o.redirectStart,d=o.fetchStart,r=o.domainLookupEnd-o.domainLookupStart,i=o.connectEnd-o.connectStart,a=o.secureConnectionStart>0?o.connectEnd-o.secureConnectionStart:0,c=o.responseStart>0?o.responseEnd-o.responseStart:void 0,h=o.fetchStart>0?o.responseEnd-o.fetchStart:void 0,l=o.requestStart>0?o.responseEnd-o.requestStart:void 0;break}}return{dnsLookupTime:r,w3cStartTime:d,redirectTime:n,tcpHandshakeTime:i,secureConnectionTime:a,responseNetworkTime:c,fetchStartToResponseEndTime:h,reqStartToResponseEndTime:l}}function v(e,t,o,s){let r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(0!==t.length){const n=t[0].sequenceNumber,i=t.length,a=t[i-1].sequenceNumber;if(a+1!==o+i){if(r||o!==n)t.length=0;else{let e=1;for(;e<t.length&&t[e].sequenceNumber===t[e-1].sequenceNumber+1;)e++;t.length=e}s.sendErrorEvent({eventName:"OpsFetchViolation",reason:e,from:o,start:n,last:a,length:i,details:JSON.stringify({validLength:t.length,lastValidOpSeqNumber:t.length>0?t[t.length-1].sequenceNumber:void 0,strict:r})})}}}var b=o(87212),f=o(76140);class y{constructor(e,t,o,s){this.deltaFeedUrl=e,this.getStorageToken=t,this.epochTracker=o,this.logger=s}async get(e,t,o,r){return(0,f.gO)((async n=>{const a=this.buildUrl(e,t),c=await this.getStorageToken(n,"DeltaStorage");return s.Bt.timedExecAsync(this.logger,{eventName:"OpsFetch",attempts:n.refresh?2:1,from:e,to:t,...o,reason:r},(async e=>{const t=(0,i.A)();let o="--".concat(t,"\r\n");o+="Authorization: Bearer ".concat(c,"\r\n"),o+="X-HTTP-Method-Override: GET\r\n",o+="_post: 1\r\n",o+="\r\n--".concat(t,"--");const s={"Content-Type":"multipart/form-data;boundary=".concat(t)},n=new AbortController,h=setTimeout((()=>n.abort()),3e4),l=await this.epochTracker.fetchAndParseAsJSON(a,{headers:s,body:o,method:"POST",signal:n.signal},"ops",!0,r);clearTimeout(h);const d=l.content,u=d.value.length>0&&"op"in d.value[0]?d.value.map((e=>e.op)):d.value;return e.end({headers:0!==Object.keys(s).length||void 0,length:u.length,...l.propsToLog}),{messages:u,partialResult:!1}}))}))}buildUrl(e,t){const o=encodeURIComponent("sequenceNumber ge ".concat(e," and sequenceNumber le ").concat(t-1)),s="?ump=1&filter=".concat(o);return"".concat(this.deltaFeedUrl).concat(s)}}class S{constructor(e,t,o,s,r,n,i,a,c){this.snapshotOps=e,this.logger=t,this.batchSize=o,this.concurrency=s,this.getFromStorage=r,this.getCached=n,this.requestFromSocket=i,this.opsReceived=a,this.storageManagerGetter=c,this.useCacheForOps=!0}fetchMessages(e,t,o,s,r){var n;(0,p.v)(!s||void 0===t,483),this.useCacheForOps=this.useCacheForOps&&!1===(null===(n=this.storageManagerGetter())||void 0===n?void 0:n.isFirstSnapshotFromNetwork);let i=0,a=0,c=0;const h=async(e,t,o)=>{if(void 0!==this.snapshotOps&&0!==this.snapshotOps.length){const o=this.snapshotOps.filter((o=>o.sequenceNumber>=e&&o.sequenceNumber<t));if(v("cached",o,e,this.logger),o.length>0&&o[0].sequenceNumber===e)return this.snapshotOps=this.snapshotOps.filter((e=>e.sequenceNumber>=t)),i+=o.length,{messages:o,partialResult:!0};this.snapshotOps=void 0}if(this.requestFromSocket(e,t),this.useCacheForOps){const o=await this.getCached(e,t);if(v("cached",o,e,this.logger),this.useCacheForOps=e+o.length>=t,0!==o.length)return a+=o.length,{messages:o,partialResult:!0}}if(s)return{messages:[],partialResult:!1};const n=await this.getFromStorage(e,t,o,r);return v("storage",n.messages,e,this.logger),c+=n.messages.length,this.opsReceived(n.messages),n},l=(0,b.yv)((async(e,t,o)=>{const s=await h(e,t,o);return v("catch all",s.messages,e,this.logger),s}),this.concurrency,e,t,this.batchSize,this.logger,o,r);return(0,b.VH)(l,(e=>{e.done&&i+a+c!==0&&this.logger.sendPerformanceEvent({eventName:"CacheOpsRetrieved",opsFromSnapshot:i,opsFromCache:a,opsFromStorage:c,reason:r})}))}}var T,C,w=o(60056),k=o(30667),N=o(28340);!function(e){e[e.NoCaching=0]="NoCaching",e[e.Prefetch=1]="Prefetch"}(T||(T={})),function(e){e.default="default",e.noCache="noCache"}(C||(C={}));var E=o(95740),P=o(7791),B=o(19307),I=o(69953),L=o(33941),O=o(74086),U=o(16713),R=o(25880),F=o(8024);function D(e){let t="";for(const o of Object.keys(e))if(void 0!==e[o]){t+="".concat(""===t?"?":"&").concat(o,"=").concat(encodeURIComponent(e[o]))}return t}var A=o(45061),x=o(70202);function M(e){const t={},o={id:e.id,blobs:{},trees:{}};t[""]=o;for(const s of e.entries){const e=s.path.lastIndexOf("/"),o=s.path.slice(0,Math.max(0,e)),r=s.path.slice(e+1),n=t[o];if("tree"===s.type){const e={blobs:{},trees:{},unreferenced:s.unreferenced};n.trees[decodeURIComponent(r)]=e,t[s.path]=e}else"blob"===s.type&&(n.blobs[decodeURIComponent(r)]=s.id)}return o}function q(e){var t,o;const s=new Map;e.blobs&&e.blobs.forEach((e=>{var t;(0,p.v)("base64"===e.encoding||void 0===e.encoding,164),s.set(e.id,(0,x.Xg)(e.content,null!==(t=e.encoding)&&void 0!==t?t:"utf8"))}));const r=null===e||void 0===e?void 0:e.trees[0].sequenceNumber;return{blobs:s,ops:null!==(t=null===(o=e.ops)||void 0===o?void 0:o.map((e=>e.op)))&&void 0!==t?t:[],sequenceNumber:r,snapshotTree:M(e.trees[0]),latestSequenceNumber:e.ops&&e.ops.length>0?e.ops[e.ops.length-1].sequenceNumber:r}}class z{get buffer(){return this.data}constructor(e){this.data=e,this.index=0,Object.freeze(e.buffer)}get eof(){return this.index===this.data.length}get pos(){return this.index}get length(){return this.data.length}slice(e,t){return this.data.slice(e,t)}reset(){this.index=0}read(){let e=0,t=1,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;for(;o>0;)(0,p.v)(!this.eof,547),e+=this.data[this.index]*t,this.index++,t*=256,o--;return e}skip(e){(0,p.v)(e>=0,548),this.index+=e,(0,p.v)(this.index<=this.data.length,988)}}var _,V,W,j=o(8653),H=o(53727);!function(e){e[e.BoolTrue=11]="BoolTrue",e[e.BoolFalse=12]="BoolFalse",e[e.StringEmpty=13]="StringEmpty",e[e.String8Length=14]="String8Length",e[e.String16Length=15]="String16Length",e[e.String32Length=16]="String32Length",e[e.ConstString8Id=17]="ConstString8Id",e[e.ConstString16Id=18]="ConstString16Id",e[e.ConstString32Id=19]="ConstString32Id",e[e.ConstStringDeclare=20]="ConstStringDeclare",e[e.ConstStringDeclareBig=21]="ConstStringDeclareBig",e[e.Int0=1]="Int0",e[e.UInt8=3]="UInt8",e[e.UInt16=5]="UInt16",e[e.UInt32=7]="UInt32",e[e.UInt64=9]="UInt64",e[e.Int8=2]="Int8",e[e.Int16=4]="Int16",e[e.Int32=6]="Int32",e[e.Int64=8]="Int64",e[e.BinaryEmpty=32]="BinaryEmpty",e[e.BinarySingle8=33]="BinarySingle8",e[e.BinarySingle16=34]="BinarySingle16",e[e.BinarySingle32=35]="BinarySingle32",e[e.BinarySingle64=36]="BinarySingle64"}(_||(_={})),function(e){e[e.list=49]="list",e[e.set=51]="set"}(V||(V={})),function(e){e[e.list=50]="list",e[e.set=52]="set"}(W||(W={}));const J={1:0,2:1,3:1,4:2,5:2,6:4,7:4,8:8,9:8,13:0,14:1,15:2,16:4,17:1,18:2,19:4,20:1,21:4,32:0,33:1,34:2,35:4,36:8};function G(e,t){const o=e[t];return(0,p.v)(void 0!==o,647),o}function $(e){const t={};for(const[o,s]of e.iteratePairs()){t[ee(o,"keynode should be a string")]=s}return t}class K{constructor(){}}class Q extends K{constructor(e){super(),this.data=e}get buffer(){return this.data}get arrayBuffer(){return(0,j.M)(this.buffer)}static read(e,t){const o=e.read(t),s=new Uint8Array(o);for(let r=0;r<o;r++)s[r]=e.read();return new Q(s)}}class X extends K{constructor(e,t,o){super(),this.data=e,this.start=t,this.end=o}get buffer(){return this.data.subarray(this.start,this.end)}get arrayBuffer(){const e=this.data.byteOffset;return this.data.buffer.slice(this.start+e,this.end+e)}static read(e,t){const o=e.read(t),s=e.pos;return e.skip(o),new X(e.buffer,s,s+o)}}class Y{get nodes(){return this.children}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"set";this.type=e,this.children=[]}[Symbol.iterator](){return this.children[Symbol.iterator]()}iteratePairs(){return(0,p.v)(this.length%2===0,556),function(e){const t={next:()=>{const t=e.next();if(t.done)return{value:void 0,done:!0};const o=e.next();return(0,p.v)(!0!==o.done,555),{value:[t.value,o.value],done:o.done}},[Symbol.iterator]:()=>t};return t}(this[Symbol.iterator]())}get length(){return this.children.length}get(e){return this.children[e]}getString(e){return ee(this.children[e],"getString should return string")}getMaybeString(e){return function(e){const t=e;if(t._stringElement)return t.content}(this.children[e])}getBlob(e){const t=this.children[e];return te(t,"getBlob should return a blob"),t}getNode(e){const t=this.children[e];return oe(t,"getNode should return a node"),t}getNumber(e){const t=this.children[e];return se(t,"getNumber should return a number"),t}getBool(e){const t=this.children[e];return re(t,"getBool should return a boolean"),t}addNode(e){const t=new Y(e);return this.children.push(t),t}addBlob(e){this.children.push(new Q(e))}addDictionaryString(e){this.children.push({content:e,dictionary:!0,_stringElement:!0})}addString(e){this.children.push({content:e,dictionary:!1,_stringElement:!0})}addNumber(e){(0,p.v)(Number.isInteger(e),561),(0,p.v)(void 0!==e&&e>=0,562),this.children.push(e)}addBool(e){this.children.push(e)}static readString(e,t,o){const s=G(J,t),r=e.read(s),n=e.pos;e.skip(r);return{dictionary:o,_stringElement:!0,startPos:n,endPos:e.pos}}load(e,t){const[o,s]=(0,f.xP)((()=>this.loadStructure(e,t))),[,r]=(0,f.xP)((()=>this.loadStrings(e,o,t)));return{durationStructure:s,durationStrings:r}}loadStructure(e,t){const o=[],s=[],r=[];let n=this.children;for(;!e.eof;){const t=e.read();switch(t){case V.list:case V.set:{const e=new Y(t===V.set?"set":"list");n.push(e),o.push(n),n=e.children;continue}case _.ConstStringDeclare:case _.ConstStringDeclareBig:{const o=e.read(G(J,t)),n=Y.readString(e,t,!0);s.push(n),r[o]=n;continue}case _.ConstString8Id:case _.ConstString16Id:case _.ConstString32Id:{const o=r[e.read(G(J,t))];(0,p.v)(void 0!==o,990),n.push(o);continue}case _.StringEmpty:case _.String8Length:case _.String16Length:case _.String32Length:{const o=Y.readString(e,t,!1);s.push(o),n.push(o);continue}case _.BinaryEmpty:case _.BinarySingle8:case _.BinarySingle16:case _.BinarySingle32:case _.BinarySingle64:n.push(X.read(e,G(J,t)));continue;case _.Int0:n.push(0);continue;case _.UInt8:case _.UInt16:case _.UInt32:case _.UInt64:case _.Int8:case _.Int16:case _.Int32:case _.Int64:n.push(e.read(G(J,t)));continue;case _.BoolTrue:n.push(!0);continue;case _.BoolFalse:n.push(!1);continue;case W.list:case W.set:n=o.pop();continue;default:throw new Error("Invalid code: ".concat(t))}}return(0,p.v)(n===this.children,999),s}loadStrings(e,t,o){let s=0;for(const a of t)s+=a.endPos-a.startPos+1;const r=new Uint8Array(s);s=0;const n=e.buffer;(0,p.v)(0===n.byteOffset,1e3);for(const a of t){for(let e=a.startPos;e<a.endPos;e++)r[s]=n[e],s++;r[s]=0,s++}(0,p.v)(s===r.length,1048);const i=(0,x.Km)(r,"utf-8").split(String.fromCharCode(0));if(i.length===t.length+1)for(let a=0;a<t.length;a++)t[a].content=i[a];else{o.sendErrorEvent({eventName:"StringParsingError"});for(const e of t)(0,p.v)(e.content===(0,x.Km)(n.subarray(e.startPos,e.endPos),"utf-8"),1002)}}}class Z extends Y{static load(e,t){const o=new Z,s=o.load(e,t);return(0,p.v)(e.eof,563),{builder:o,telemetryProps:s}}}function ee(e,t){const o=e;if(o._stringElement)return o.content;ne(e,"BlobCore",t)}function te(e,t){e instanceof K||ne(e,"BlobCore",t)}function oe(e,t){e instanceof Y||ne(e,"NodeCore",t)}function se(e,t){"number"!==typeof e&&ne(e,"Number",t)}function re(e,t){"boolean"!==typeof e&&ne(e,"Boolean",t)}function ne(e,t,o){throw new B.OI("Buffer parsing exception: ".concat(o),E.f.incorrectServerResponse,{nodeType:ie(e),expectedNodeType:t,driverVersion:H.z})}function ie(e){return"number"===typeof e?"Number":e instanceof K?"BlobCore":e instanceof Y?"NodeCore":"boolean"===typeof e?"Boolean":e._stringElement?"String":"UnknownType"}const ae="1.0",ce="1.0";function he(e){oe(e,"Deltas should be of type NodeCore");const t=[],o=$(e);se(o.firstSequenceNumber,"Seq number should be a number"),oe(o.deltas,"Deltas should be a Node");for(let s=0;s<o.deltas.length;++s)t.push(JSON.parse(o.deltas.getString(s)));return(0,p.v)(0===t.length||o.firstSequenceNumber.valueOf()===t[0].sequenceNumber,640),t}function le(e){let t=0;const o={},s={blobs:{},trees:o};for(const r of e){oe(r,"tree nodes should be nodes");const e=r.length;if(e>0&&"name"===r.getMaybeString(0)){if(4===e){const e=r.getMaybeString(2);if("children"===e){const e=le(r.getNode(3));o[r.getString(1)]=e.snapshotTree,t+=e.slowTreeStructureCount;continue}if("value"===e){s.blobs[r.getString(1)]=r.getString(3);continue}}if(6===e&&"nodeType"===r.getMaybeString(2)&&"value"===r.getMaybeString(4)){s.blobs[r.getString(1)]=r.getString(5);continue}if(6===e&&"unreferenced"===r.getMaybeString(2)&&"children"===r.getMaybeString(4)){const e=le(r.getNode(5));o[r.getString(1)]=e.snapshotTree,t+=e.slowTreeStructureCount,(0,p.v)(r.getBool(3),987),s.unreferenced=!0;continue}}t+=1;const n=$(r);void 0!==n.unreferenced&&(re(n.unreferenced,"Unreferenced flag should be bool"),(0,p.v)(n.unreferenced,641),s.unreferenced=!0);const i=ee(n.name,"Path name should be string");if(void 0!==n.value)s.blobs[i]=ee(n.value,"Blob value should be string");else if(void 0!==n.children){oe(n.children,"Trees should be of type NodeCore");const e=le(n.children);o[i]=e.snapshotTree,t+=e.slowTreeStructureCount}else o[i]={blobs:{},trees:{}}}return{snapshotTree:s,slowTreeStructureCount:t}}function de(e){oe(e,"Snapshot should be of type NodeCore");const t=$(e);oe(t.treeNodes,"TreeNodes should be of type NodeCore"),se(t.sequenceNumber,"sequenceNumber should be of type number");const{snapshotTree:o,slowTreeStructureCount:s}=le(t.treeNodes);o.id=ee(t.id,"snapshotId should be string");return{sequenceNumber:t.sequenceNumber.valueOf(),snapshotTree:o,slowTreeStructureCount:s}}function ue(e,t){const{builder:o,telemetryProps:s}=Z.load(new z(e),t);(0,p.v)(1===o.length,537);const r=$(o.getNode(0)),n=ee(r.mrv,"minReadVersion should be string"),i=ee(r.cv,"createVersion should be string");void 0!==r.lsn&&se(r.lsn,"lsn should be a number"),(0,p.v)(parseFloat(ae)>=parseFloat(n),527),(0,p.v)(parseFloat(i)>=parseFloat(ae),528),(0,p.v)(ce===i,706);const[a,c]=(0,f.xP)((()=>de(r.snapshot))),[h,l]=(0,f.xP)((()=>function(e){oe(e,"TreeBlobs should be of type NodeCore");let t=0;const o=new Map;for(const s of e){if(oe(s,"blob should be node"),4===s.length&&"id"===s.getMaybeString(0)&&"data"===s.getMaybeString(2)){o.set(s.getString(1),s.getBlob(3).arrayBuffer);continue}t+=1;const e=$(s);te(e.data,"data should be of BlobCore type");const r=ee(e.id,"blob id should be string");o.set(r,e.data.arrayBuffer)}return{blobs:o,slowBlobStructureCount:t}}(r.blobs)));return{...a,...h,ops:void 0!==r.deltas?he(r.deltas):[],latestSequenceNumber:r.lsn,telemetryProps:{...s,durationSnapshotTree:c,durationBlobs:l,slowTreeStructureCount:a.slowTreeStructureCount,slowBlobStructureCount:h.slowBlobStructureCount}}}var pe;async function ge(e,t,o,r,n,i,a,c,h){const l=e.sharingLinkToRedeem;return l&&(e.shareLinkInfo={...e.shareLinkInfo,sharingLinkToRedeem:l}),me(e,t,o,n,i,a,h).catch((async c=>{if(h&&function(e,t){var o;if(void 0!==(null===(o=e.shareLinkInfo)||void 0===o?void 0:o.sharingLinkToRedeem)&&"object"===typeof t&&null!==t&&(t.errorType===E.f.authorizationError||t.errorType===E.f.fileNotFoundOrAccessDeniedError))return!0;return!1}(e,c)){await async function(e,t,o,r){return s.Bt.timedExecAsync(o,{eventName:"RedeemShareLink"},(async()=>(0,f.gO)((async o=>{var s,n;(0,p.v)(!(null===(s=e.shareLinkInfo)||void 0===s||!s.sharingLinkToRedeem),493);const i=await t(o,"RedeemShareLink"),a=function(e){let t=(0,O.O0)(encodeURI(e));return t=t.replace(/=+$/g,"").replace(/\//g,"_").replace(/\+/g,"-"),t="u!".concat(t),t}(null===(n=e.shareLinkInfo)||void 0===n?void 0:n.sharingLinkToRedeem),c="".concat(e.siteUrl,"/_api/v2.0/shares/").concat(a),{url:h,headers:l}=(0,A.$)(c,i,r);return l.prefer="redeemSharingLink",(0,f.bf)(h,{headers:l})}))))}(e,t,n,r);const h={...e,shareLinkInfo:{...e.shareLinkInfo,sharingLinkToRedeem:void 0}};return n.sendTelemetryEvent({eventName:"RedeemFallback",errorType:c.errorType},c),me(h,t,o,n,i,a)}throw c})).catch((async e=>{throw("object"===typeof e&&null!==e&&e.errorType===E.f.authorizationError||e.errorType===E.f.fileNotFoundOrAccessDeniedError)&&await c(),e}))}async function me(e,t,o,r,n,i,a){return(0,f.gO)((async c=>{var h;const l=await t(c,"TreesLatest",!0);(0,p.v)(null!==l,485);const d={eventName:"TreesLatest",attempts:c.refresh?2:1,shareLinkPresent:void 0!==(null===(h=e.shareLinkInfo)||void 0===h?void 0:h.sharingLinkToRedeem),isSummarizer:e.summarizer,redeemFallbackEnabled:a};return void 0!==o&&Object.entries(o).forEach((e=>{let[t,o]=e;void 0!==o&&(d["snapshotOption_".concat(t)]=o)})),s.Bt.timedExecAsync(r,d,(async t=>{var s,a,c,h,d,u,g;let v,b;void 0!==(null===o||void 0===o?void 0:o.timeout)&&(v=new AbortController,b=setTimeout((()=>v.abort()),o.timeout));const[y,S]=await(0,f.jL)((async()=>n(e,l,o,v))).finally((()=>{void 0!==b&&(clearTimeout(b),b=void 0)})),T=y.odspResponse,C=T.headers.get("content-type"),k={...T.propsToLog,contentType:C,accept:y.requestHeaders.accept,driverVersion:H.z};let N,P,I,O;null!==C&&void 0!==C&&C.includes("application/ms-fluid")?P="application/ms-fluid":null!==C&&void 0!==C&&C.includes("application/json")&&(P="application/json");try{switch(P){case"application/json":{let e,t;[e,O]=await(0,f.jL)((async()=>T.content.text().catch((e=>(0,R.lJ)("Error while parsing fetch response",R.TX,T.content,void 0,k))))),k.bodySize=e.length,[t,I]=(0,f.xP)((()=>JSON.parse(e))),function(e){(0,p.v)(void 0!==e.trees,512),(0,p.v)(void 0!==e.blobs,513)}(t);const o=q(t);N={...T,content:{...o,telemetryProps:{}}};break}case"application/ms-fluid":{var D,A;let e,t;if([e,O]=await(0,f.jL)((async()=>T.content.arrayBuffer().catch((e=>(0,R.lJ)("Error while parsing fetch response",R.TX,T.content,void 0,k))))),k.bodySize=e.byteLength,[t,I]=(0,f.xP)((()=>ue(new Uint8Array(e),r))),void 0===t.snapshotTree.trees||void 0===t.snapshotTree.blobs)throw new B.OI("Returned odsp snapshot is malformed. No trees or blobs!",E.f.incorrectServerResponse,k);const o=t.telemetryProps,s=null!==(D=o.slowTreeStructureCount)&&void 0!==D?D:0,n=null!==(A=o.slowBlobStructureCount)&&void 0!==A?A:0;(s>10||n>10)&&r.sendErrorEvent({eventName:"SlowSnapshotParseCodePaths",slowTreeStructureCount:s,slowBlobStructureCount:n}),N={...T,content:t};break}default:throw new B.OI("Unknown snapshot content type",E.f.incorrectServerResponse,k)}}catch(J){if((0,L.Xy)(J))throw J.addTelemetryProperties(k),J;throw(0,w.J4)(J,(e=>new B.OI("Error parsing snapshot response: ".concat(e),E.f.genericError,k)))}(0,p.v)(void 0!==N,786);const x=N.content,{trees:M,numBlobs:z,encodedBlobsSize:_}=ve(x),V="true"!==T.headers.get("disablebrowsercachingofusercontent"),W=null!==(s=x.sequenceNumber)&&void 0!==s?s:0,j=x.ops&&x.ops.length>0?x.ops[0].sequenceNumber-1:void 0;if(!Number.isInteger(W)||void 0!==j&&j!==W)r.sendErrorEvent({eventName:"fetchSnapshotError",sequenceNumber:W,seqNumberFromOps:j}),x.sequenceNumber=void 0;else if(V){const e=T.headers.get("x-fluid-epoch");(0,p.v)(void 0!==e,486);const t={value:{...x,cacheEntryTime:Date.now()},fluidEpoch:e,version:F.F};i(t)}return t.end({trees:M,blobs:null!==(a=null===(c=x.blobs)||void 0===c?void 0:c.size)&&void 0!==a?a:0,leafNodes:z,encodedBlobsSize:_,sequenceNumber:W,ops:null!==(h=null===(d=x.ops)||void 0===d?void 0:d.length)&&void 0!==h?h:0,userOps:null!==(u=null===(g=x.ops)||void 0===g?void 0:g.filter((e=>(0,U.Wz)(e))).length)&&void 0!==u?u:0,headers:0!==Object.keys(y.requestHeaders).length||void 0,fetchTime:S,parseTime:I,receiveContentTime:O,...m(y.requestUrl,"fetch"),sltelemetry:T.headers.get("x-fluid-sltelemetry"),...k,...N.content.telemetryProps}),x})).catch((e=>{throw"object"!==typeof e||null===e||e.errorType!==E.f.fetchFailure&&e.errorType!==I.P.fetchTimeout||(e[f.TV]=!0),e}))}))}function ve(e){const t=be(e.snapshotTree),o=e.blobs.size;let s=0;for(const[r,n]of e.blobs)s+=n.byteLength;return{trees:t,numBlobs:o,encodedBlobsSize:s}}function be(e){let t=0;for(const[o,s]of Object.entries(e.trees))t+=1,t+=be(s);return t}async function fe(e,t,o,s,r,n,a,c){var h;const l=e.sharingLinkToRedeem;l&&(e.shareLinkInfo={...e.shareLinkInfo,sharingLinkToRedeem:l});const d=e.endpoints.snapshotStorageUrl,u={ump:1};void 0!==s&&Object.entries(s).forEach((e=>{let[t,o]=e;void 0!==o&&"timeout"!==t&&(u[t]=o)}));const p=D(u),g="".concat(d,"/trees/latest").concat(p),{body:m,headers:v}=function(e,t,o){var s;const r=(0,i.A)(),n=[];var a;return n.push("--".concat(r)),n.push("Authorization: Bearer ".concat(t)),n.push("X-HTTP-Method-Override: GET"),void 0!==o&&Object.entries(o).forEach((e=>{let[t,o]=e;void 0!==o&&n.push("".concat(t,": ").concat(o))})),null!==(s=e.shareLinkInfo)&&void 0!==s&&s.sharingLinkToRedeem&&n.push("sl: ".concat(null===(a=e.shareLinkInfo)||void 0===a?void 0:a.sharingLinkToRedeem)),n.push("_post: 1"),n.push("\r\n--".concat(r,"--")),{body:n.join("\r\n"),headers:{"Content-Type":"multipart/form-data;boundary=".concat(r)}}}(e,t,{prefer:"manualredirect"}),b={body:m,headers:v,signal:null===n||void 0===n?void 0:n.signal,method:"POST"};if(r===pe.Binary)v.accept="application/ms-fluid; v=".concat(ce);else v.accept="application/json, application/ms-fluid; v=".concat(ce);return{odspResponse:await(null!==(h=null===a||void 0===a?void 0:a.fetch(g,b,"treesLatest",!0,c))&&void 0!==h?h:(0,f.ZR)(g,b)),requestHeaders:v,requestUrl:g}}!function(e){e[e.Json=0]="Json",e[e.Binary=1]="Binary",e[e.JsonAndBinary=2]="JsonAndBinary"}(pe||(pe={}));class ye{constructor(){this.deferBlobCacheClear=!1,this._blobCache=new Map,this.blobsEvicted=new Set,this.blobCacheTimeoutDuration=12e4,this.purgeEnabled=!1}get value(){return this._blobCache}addBlobs(e){e.forEach(((e,t)=>{this._blobCache.set(t,e)})),this.scheduleClearBlobsCache()}scheduleClearBlobsCache(){if(void 0!==this.blobCacheTimeout)this.deferBlobCacheClear=!0;else if(this.purgeEnabled){const e=()=>{this.blobCacheTimeout=void 0,this.deferBlobCacheClear?(this.deferBlobCacheClear=!1,this.scheduleClearBlobsCache()):(this._blobCache.forEach(((e,t)=>this.blobsEvicted.add(t))),this._blobCache.clear())};this.blobCacheTimeout=setTimeout(e,this.blobCacheTimeoutDuration),this.blobCacheTimeoutDuration=1e4}}getBlob(e){this.scheduleClearBlobsCache();return{blobContent:this._blobCache.get(e),evicted:this.blobsEvicted.has(e)}}setBlob(e,t){if(t.byteLength<262144)return this.scheduleClearBlobsCache(),this._blobCache.set(e,t);this.blobsEvicted.add(e)}}class Se{constructor(e){this.commitCache=new Map,this.attributesBlobHandles=new Set,this.blobCache=new ye,this.repositoryUrl="";const t=e.getBoolean("Fluid.Driver.Odsp.TestOverride.DisableSnapshotCache")?0:432e6;this.policies={caching:T.NoCaching,maximumCacheDurationMs:t}}set ops(e){(0,p.v)(void 0===this._ops,165),this._ops=e}get ops(){return this._ops}get snapshotSequenceNumber(){return this._snapshotSequenceNumber}async readBlobCore(e){const{blobContent:t,evicted:o}=this.blobCache.getBlob(e);return null!==t&&void 0!==t?t:this.fetchBlobFromStorage(e,o)}async readBlob(e){return this.readBlobCore(e)}async getSnapshotTree(e,t){let o;if(null!==e&&void 0!==e&&e.id)o=e.id;else{const e=await this.getVersions(null,1,t);if(!e||0===e.length)return null;o=e[0].id}const s=await this.readTree(o,t);if(!s)return null;if(s.blobs){const e=s.blobs.attributes;e&&this.attributesBlobHandles.add(e)}const r=s.trees[".app"],n=s.trees[".protocol"];return this.combineProtocolAndAppSnapshotTree(r,n)}async downloadSummary(e){throw new Error("Not implemented yet")}setRootTree(e,t){this.commitCache.set(e,t)}initBlobsCache(e){this.blobCache.addBlobs(e)}async readTree(e,t){var o;let s=this.commitCache.get(e);return s||(s=await this.fetchTreeFromSnapshot(e,t)),null!==(o=s)&&void 0!==o?o:null}combineProtocolAndAppSnapshotTree(e,t){return{blobs:{...e.blobs},trees:{...e.trees,".protocol":t}}}initializeFromSnapshot(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._snapshotSequenceNumber=e.sequenceNumber;const{snapshotTree:o,blobs:s,ops:r}=e;let n;return o&&(n=o.id,(0,p.v)(void 0!==n,545),this.setRootTree(n,o)),s&&this.initBlobsCache(s),t&&(this.ops=r),n}}class Te extends Se{constructor(e,t,o,s,r,n,i,a,c,h){super((0,u.Ln)(o).config),this.odspResolvedUrl=e,this.getStorageToken=t,this.logger=o,this.fetchFullSnapshot=s,this.cache=r,this.hostPolicy=n,this.epochTracker=i,this.flushCallback=a,this.relayServiceTenantAndSessionId=c,this.snapshotFormatFetchType=h,this.odspSummaryModuleLoaded=!1,this.firstVersionCall=!0,this.maxSnapshotSizeLimit=5e8,this.maxSnapshotFetchTimeout=12e4,this.createBlobRateLimiter=new P.v(1),this.documentId=this.odspResolvedUrl.hashedDocumentId,this.snapshotUrl=this.odspResolvedUrl.endpoints.snapshotStorageUrl,this.attachmentPOSTUrl=this.odspResolvedUrl.endpoints.attachmentPOSTStorageUrl,this.attachmentGETUrl=this.odspResolvedUrl.endpoints.attachmentGETStorageUrl}get isFirstSnapshotFromNetwork(){return this._isFirstSnapshotFromNetwork}async createBlob(e){this.checkAttachmentPOSTUrl();return(await(0,f.gO)((async t=>{var o;const r=await this.getStorageToken(t,"CreateBlob"),{url:n,headers:i}=(0,A.$)("".concat(this.attachmentPOSTUrl,"/content"),r,!(null===(o=this.hostPolicy.sessionOptions)||void 0===o||!o.forceAccessTokenViaAuthorizationHeader));return i["Content-Type"]="application/octet-stream",s.Bt.timedExecAsync(this.logger,{eventName:"createBlob",size:e.byteLength,waitQueueLength:this.createBlobRateLimiter.waitQueueLength},(async t=>{const o=await this.createBlobRateLimiter.schedule((async()=>this.epochTracker.fetchAndParseAsJSON(n,{body:e,headers:i,method:"POST"},"createBlob")));return t.end({blobId:o.content.id,...o.propsToLog}),o}))}))).content}async fetchBlobFromStorage(e,t){this.checkAttachmentGETUrl();const o=await(0,f.gO)((async o=>{var r;const n=await this.getStorageToken(o,"GetBlob"),i="".concat(this.attachmentGETUrl,"/").concat(encodeURIComponent(e),"/content"),{url:a,headers:c}=(0,A.$)(i,n,!(null===(r=this.hostPolicy.sessionOptions)||void 0===r||!r.forceAccessTokenViaAuthorizationHeader));return s.Bt.timedExecAsync(this.logger,{eventName:"readDataBlob",blobId:e,evicted:t,headers:0!==Object.keys(c).length||void 0,waitQueueLength:this.epochTracker.rateLimiter.waitQueueLength},(async t=>{const s=await this.epochTracker.fetchArray(a,{headers:c},"blob");t.end({waitQueueLength:this.epochTracker.rateLimiter.waitQueueLength,...s.propsToLog,attempts:o.refresh?2:1});const r=s.headers.get("cache-control");return void 0!==r&&(r.includes("private")||r.includes("public"))||this.logger.sendErrorEvent({eventName:"NonCacheableBlob",cacheControl:r,blobId:e,...s.propsToLog}),s.content}))}));return this.blobCache.setBlob(e,o),o}async getSnapshotTree(e,t){return this.snapshotUrl?super.getSnapshotTree(e,t):null}async getVersions(e,t,o,r){if(e!==this.documentId&&e)return[{id:e,treeId:void 0}];if(!this.snapshotUrl)return[];if(1===t&&(null===e||e===this.documentId)){const e=this.hostPolicy.snapshotOptions,t=await s.Bt.timedExecAsync(this.logger,{eventName:"ObtainSnapshot",fetchSource:r},(async t=>{const s={};let n,i,a=0,c=g.F.now();if(r===C.noCache)n=await this.fetchSnapshot(e,o),i="networkOnly";else{const t=this.epochTracker.get((0,f.wL)(this.odspResolvedUrl)).then((async e=>{if(void 0!==e){var t;const o=Date.now()-(null!==(t=e.cacheEntryTime)&&void 0!==t?t:Date.now()-2592e6);if(this.hostPolicy.summarizerClient){if(o>6e4)return void(s.cacheSummarizerExpired=!0);s.cacheSummarizerExpired=!1}s.cacheEntryAge=o}return e}));if(this.firstVersionCall&&this.hostPolicy.concurrentSnapshotFetch&&!this.hostPolicy.summarizerClient){const s=this.fetchSnapshot(e,o),r=await async function(e){return new Promise(((t,o)=>{e.forEach(((e,s)=>{e.then((e=>t({index:s,value:e}))).catch(o)}))}))}([t.catch((()=>{})),s.catch((()=>{}))]);if(n=r.value,i=0===r.index?"cache":"network",void 0===n)try{1===r.index&&(n=await t,i="cache"),void 0===n&&(n=await s,i="network")}catch(l){const e=l.stack,t=(0,w.cQ)(l);t.addTelemetryProperties({innerStack:e});const o="<<STACK TRUNCATED: see innerStack property>> \n".concat((0,w.aX)());throw(0,w.kc)(t,o),t}}else{const s=g.F.now();n=await t,a=g.F.now()-s,i=void 0!==n?"cache":"network",void 0===n&&(c=g.F.now(),n=await this.fetchSnapshot(e,o))}}"network"===i&&(s.cacheEntryAge=void 0),this.firstVersionCall&&(this._isFirstSnapshotFromNetwork="cache"!==i);const h=n.prefetchStartTime;return t.end({...s,method:i,avoidPrefetchSnapshotCache:this.hostPolicy.avoidPrefetchSnapshotCache,...ve(n),cacheLookupTimeInSerialFetch:a,prefetchSavedDuration:void 0!==h&&"cache"!==i?c-h:void 0}),n})),n=g.F.now(),i=this.initializeFromSnapshot(t,this.firstVersionCall);return this.logger.sendTelemetryEvent({eventName:"SnapshotInitializeTime",duration:g.F.now()-n},void 0,N.$.verbose),this.firstVersionCall=!1,i?[{id:i,treeId:void 0}]:[]}return(0,f.gO)((async e=>{var r;const n=await this.getStorageToken(e,"GetVersions"),{url:i,headers:a}=(0,A.$)("".concat(this.snapshotUrl,"/versions?top=").concat(t),n,!(null===(r=this.hostPolicy.sessionOptions)||void 0===r||!r.forceAccessTokenViaAuthorizationHeader)),c=(await s.Bt.timedExecAsync(this.logger,{eventName:"getVersions",headers:0!==Object.keys(a).length||void 0},(async()=>this.epochTracker.fetchAndParseAsJSON(i,{headers:a},"versions",void 0,o)))).content;if(!c)throw new B.OI("No response from /versions endpoint",E.f.genericNetworkError,{driverVersion:H.z});if(!Array.isArray(c.value))throw new B.OI("Incorrect response from /versions endpoint, expected an array",E.f.genericNetworkError,{driverVersion:H.z});return c.value.map((e=>({id:e.id,treeId:void 0})))}))}async fetchSnapshot(e,t){return this.fetchSnapshotCore(e,t).catch((e=>{throw"object"===typeof e&&null!==e&&(e.canRetry=!1),e}))}async fetchSnapshotCore(e,t){if(!this.hostPolicy.avoidPrefetchSnapshotCache){var o;const e=(0,c.V)((0,f.wL)(this.odspResolvedUrl)),t=await(null===(o=this.cache.snapshotPrefetchResultCache)||void 0===o||null===(o=o.get(e))||void 0===o?void 0:o.then((async t=>(this.cache.snapshotPrefetchResultCache.remove(e),await this.epochTracker.validateEpoch(t.fluidEpoch,"treesLatest"),t))).catch((async e=>{this.logger.sendTelemetryEvent({eventName:"PrefetchSnapshotError",concurrentSnapshotFetch:this.hostPolicy.concurrentSnapshotFetch},e)})));if(void 0!==t)return t}const s={mds:this.maxSnapshotSizeLimit,...e,timeout:null!==e&&void 0!==e&&e.timeout?Math.min(e.timeout,this.maxSnapshotFetchTimeout):this.maxSnapshotFetchTimeout};this.hostPolicy.summarizerClient&&(s.mds=void 0,s.timeout=void 0);const r=async(e,o,s,r)=>fe(e,o,this.logger,s,this.snapshotFormatFetchType,r,this.epochTracker,t),n=async e=>this.cache.persistedCache.put((0,f.wL)(this.odspResolvedUrl),e.value),i=async()=>this.cache.persistedCache.removeEntries();try{var a;return await ge(this.odspResolvedUrl,this.getStorageToken,s,!(null===(a=this.hostPolicy.sessionOptions)||void 0===a||!a.forceAccessTokenViaAuthorizationHeader),this.logger,r,n,i,this.hostPolicy.enableRedeemFallback)}catch(l){const t=l.errorType;if(t===I.P.snapshotTooBig&&void 0!==(null===e||void 0===e?void 0:e.mds)&&!0!==this.hostPolicy.summarizerClient)throw l;if((t===I.P.snapshotTooBig||t===I.P.fetchTimeout)&&s.blobs){var h;this.logger.sendErrorEvent({eventName:"TreeLatest_SecondCall",errorType:t});const e={...s,blobs:0,mds:void 0,timeout:void 0};return await ge(this.odspResolvedUrl,this.getStorageToken,e,!(null===(h=this.hostPolicy.sessionOptions)||void 0===h||!h.forceAccessTokenViaAuthorizationHeader),this.logger,r,n,i,this.hostPolicy.enableRedeemFallback)}throw l}}async uploadSummaryWithContext(e,t){if(this.checkSnapshotUrl(),void 0===this.summaryModuleP&&(this.summaryModuleP=this.getDelayLoadedSummaryManager()),".protocol"in e.tree&&void 0!==t.ackHandle){let e=1;for(;;){var o;const s=await this.flushCallback(),r=s.lastPersistedSequenceNumber;if(void 0!==r&&r>=t.referenceSequenceNumber)break;if(e>3){this.logger.sendErrorEvent({eventName:"FlushFailure",...s,retry:e,referenceSequenceNumber:t.referenceSequenceNumber});break}this.logger.sendPerformanceEvent({eventName:"FlushExtraCall",...s,retry:e,referenceSequenceNumber:t.referenceSequenceNumber}),e++,await(0,k.c)(1e3*(null!==(o=s.retryAfter)&&void 0!==o?o:1))}}this.odspSummaryUploadManager||(this.odspSummaryUploadManager=await this.summaryModuleP.then((async e=>(this.odspSummaryModuleLoaded=!0,e))).catch((e=>{throw this.odspSummaryModuleLoaded=!1,e}))),(0,p.v)(void 0!==this.odspSummaryUploadManager,1390);return await this.odspSummaryUploadManager.writeSummaryTree(e,t)}async getDelayLoadedSummaryManager(){var e;(0,p.v)(!1===this.odspSummaryModuleLoaded,1391);const t=await o.e(38868).then(o.bind(o,16487)).then((e=>(this.logger.sendTelemetryEvent({eventName:"SummaryModuleLoaded"}),e))).catch((e=>{throw this.logger.sendErrorEvent({eventName:"SummaryModuleLoadFailed"},e),e}));return this.odspSummaryUploadManager=new t.OdspSummaryUploadManager(this.odspResolvedUrl.endpoints.snapshotStorageUrl,this.getStorageToken,this.logger,this.epochTracker,!(null===(e=this.hostPolicy.sessionOptions)||void 0===e||!e.forceAccessTokenViaAuthorizationHeader),this.relayServiceTenantAndSessionId),this.odspSummaryUploadManager}checkSnapshotUrl(){if(!this.snapshotUrl)throw new B.OI("Method failed because no snapshot url was available",E.f.genericError,{driverVersion:H.z})}checkAttachmentPOSTUrl(){if(!this.attachmentPOSTUrl)throw new B.OI("Method failed because no attachment POST url was available",E.f.genericError,{driverVersion:H.z})}checkAttachmentGETUrl(){if(!this.attachmentGETUrl)throw new B.OI("Method failed because no attachment GET url was available",E.f.genericError,{driverVersion:H.z})}async fetchTreeFromSnapshot(e,t){return(0,f.gO)((async o=>{var r,n;const i=await this.getStorageToken(o,"ReadCommit"),a=await async function(e,t,o,r,n,i,a){const c="/trees/".concat(o);let h={};r&&(h="latest"!==o?{blobs:2}:{deltas:1,blobs:2});const l=D(h),{url:d,headers:u}=(0,A.$)("".concat(e).concat(c).concat(l),t,n);return q((await s.Bt.timedExecAsync(i,{eventName:"fetchSnapshot",headers:0!==Object.keys(u).length||void 0},(async()=>a(d,{headers:u})))).content)}(this.snapshotUrl,i,e,this.fetchFullSnapshot,!(null===(r=this.hostPolicy.sessionOptions)||void 0===r||!r.forceAccessTokenViaAuthorizationHeader),this.logger,(async(e,o)=>this.epochTracker.fetchAndParseAsJSON(e,o,"snapshotTree",void 0,t)));let c="";return a.snapshotTree&&((0,p.v)(void 0!==a.snapshotTree.id,546),c=a.snapshotTree.id,this.setRootTree(c,a.snapshotTree)),a.blobs&&this.initBlobsCache(a.blobs),null!==(n=this.commitCache.get(e))&&void 0!==n?n:this.commitCache.get(c)}))}}var Ce=o(56730);class we{constructor(e,t,o,s,r,n){this.logger=t,this.cache=o,this.batchSize=s,this.timerGranularity=r,this.totalOpsToCache=n,this.batches=new Map;const i=this.batchSize-this.getPositionInBatchArray(e)-1;0!==i&&this.batches.set(this.getBatchNumber(e),{remainingSlots:i,batchData:this.initializeNewBatchDataArray(),dirty:!1})}dispose(){this.batches.clear(),void 0!==this.timer&&(clearTimeout(this.timer),this.timer=void 0)}flushOps(){for(const[e,t]of this.batches)null===t||!t.dirty||0===t.batchData.length||void 0===t.batchData[0]&&void 0===t.batchData[t.batchData.length-1]||(t.dirty=!1,this.write(e,t))}addOps(e){if(!(this.totalOpsToCache<=0))for(const t of e){const e=this.getBatchNumber(t.sequenceNumber),o=this.getPositionInBatchArray(t.sequenceNumber);let s=this.batches.get(e);if(void 0===s)s={remainingSlots:this.batchSize-1,batchData:this.initializeNewBatchDataArray(),dirty:!0},s.batchData[o]=t,this.batches.set(e,s);else{if(null===s||void 0!==s.batchData[o])return;s.batchData[o]=t,s.remainingSlots--,s.dirty=!0}if(0===s.remainingSlots?(this.write(e,s),this.batches.set(e,null)):this.scheduleTimer(),this.totalOpsToCache--,0===this.totalOpsToCache){this.logger.sendPerformanceEvent({eventName:"CacheOpsLimitHit"}),this.cache.remove(),this.dispose();break}}}async getCore(e,t){const o=[];let s=this.getBatchNumber(e);for(;;){const r=await this.cache.read("".concat(this.batchSize,"_").concat(s));if(void 0===r)return o;const n=JSON.parse(r),i=o.length;for(const s of n)if(s){if(void 0!==t&&s.sequenceNumber>=t)return o;if(0===o.length){if(s.sequenceNumber>e)return o;if(s.sequenceNumber<e)continue}o.push(s)}else if(0!==o.length)return o;if(i===o.length)return o;s++}}async get(e,t){const o=g.F.now(),s=await this.getCore(e,t),r=g.F.now()-o;return(s.length>0||r>1e3)&&this.logger.sendPerformanceEvent({eventName:"CacheOpsUsed",from:e,to:t,length:s.length,duration:r}),s}write(e,t){this.cache.write("".concat(this.batchSize,"_").concat(e),JSON.stringify(t.batchData)).catch((()=>{this.totalOpsToCache=0}))}scheduleTimer(){!this.timer&&this.timerGranularity>0&&(this.timer=setTimeout((()=>{this.timer=void 0,this.flushOps()}),this.timerGranularity))}getBatchNumber(e){return Math.floor(e/this.batchSize)}getPositionInBatchArray(e){return e%this.batchSize}initializeNewBatchDataArray(){const e=[];return e.length=this.batchSize,e}}var ke=o(9690);class Ne{constructor(e,t){this.internalStorageService=e,this.logger=t,this._disposed=!1}get policies(){return this.internalStorageService.policies}get disposed(){return this._disposed}dispose(){this._disposed=!0}get repositoryUrl(){return this.internalStorageService.repositoryUrl}async getSnapshotTree(e){return this.runWithRetry((async()=>this.internalStorageService.getSnapshotTree(e)),"storage_getSnapshotTree")}async readBlob(e){return this.runWithRetry((async()=>this.internalStorageService.readBlob(e)),"storage_readBlob")}async getVersions(e,t,o,s){return this.runWithRetry((async()=>this.internalStorageService.getVersions(e,t,o,s)),"storage_getVersions")}async uploadSummaryWithContext(e,t){return this.runWithRetry((async()=>this.internalStorageService.uploadSummaryWithContext(e,t)),"storage_uploadSummaryWithContext")}async downloadSummary(e){return this.runWithRetry((async()=>this.internalStorageService.downloadSummary(e)),"storage_downloadSummary")}async createBlob(e){return this.runWithRetry((async()=>this.internalStorageService.createBlob(e)),"storage_createBlob")}checkStorageDisposed(){if(this._disposed)throw new w.iq("Storage Service is disposed. Cannot retry",{canRetry:!1})}async runWithRetry(e,t){return(0,ke.M)(e,t,this.logger,(()=>this.checkStorageDisposed()))}}class Ee{static async create(e,t,o,s,r,n,i,a,c){return new Ee((0,f.Yn)(e),t,o,s,r,n,i,a,c)}constructor(e,t,o,s,r,n,i,a,c){this.odspResolvedUrl=e,this.getStorageToken=t,this.getWebsocketToken=o,this.cache=r,this.epochTracker=i,this.socketReferenceKeyPrefix=a,this.clientIsSummarizer=c,this.odspSocketModuleLoaded=!1,this._policies={storageOnly:void 0!==e.fileVersion,summarizeProtocolTree:!0},this.mc=(0,u.CL)({logger:s,properties:{all:{odc:(0,Ce.hw)(new URL(this.odspResolvedUrl.endpoints.snapshotStorageUrl).origin)}}}),this.hostPolicy=n,this.clientIsSummarizer&&(this.hostPolicy={...this.hostPolicy,summarizerClient:!0})}get resolvedUrl(){return this.odspResolvedUrl}get policies(){return this._policies}async connectToStorage(){return this.storageManager||(this.storageManager=new Te(this.odspResolvedUrl,this.getStorageToken,this.mc.logger,!0,this.cache,this.hostPolicy,this.epochTracker,(async()=>{var e;const t=null===(e=this.odspDelayLoadedDeltaStream)||void 0===e?void 0:e.currentDeltaConnection;if(void 0!==t&&!t.disposed)return t.flush();throw new Error("Disconnected while uploading summary (attempt to perform flush())")}),(()=>{var e;return null===(e=this.odspDelayLoadedDeltaStream)||void 0===e?void 0:e.relayServiceTenantAndSessionId}),this.mc.config.getNumber("Fluid.Driver.Odsp.snapshotFormatFetchType"))),new Ne(this.storageManager,this.mc.logger)}async connectToDeltaStorage(){var e,t,o,s;const r=null!==(e=null===(t=this.storageManager)||void 0===t?void 0:t.ops)&&void 0!==e?e:[],n=new y(this.odspResolvedUrl.endpoints.deltaStorageUrl,this.getStorageToken,this.epochTracker,this.mc.logger),i=null!==(o=this.hostPolicy.opsBatchSize)&&void 0!==o?o:5e3,a=null!==(s=this.hostPolicy.concurrentOpsBatches)&&void 0!==s?s:1;return new S(r,this.mc.logger,i,a,(async(e,t,o,s)=>n.get(e,t,o,s)),(async(e,t)=>{var o;const s=await(null===(o=this.opsCache)||void 0===o?void 0:o.get(e,t));return null!==s&&void 0!==s?s:[]}),((e,t)=>{var o;const s=null===(o=this.odspDelayLoadedDeltaStream)||void 0===o?void 0:o.currentDeltaConnection;void 0===s||s.disposed||s.requestOps(e,t)}),(e=>this.opsReceived(e)),(()=>this.storageManager))}async connectToDeltaStream(e){return void 0===this.socketModuleP&&(this.socketModuleP=this.getDelayLoadedDeltaStream()),this.socketModuleP.then((async t=>(this.odspSocketModuleLoaded=!0,t.connectToDeltaStream(e)))).catch((e=>{throw this.socketModuleP=void 0,this.odspSocketModuleLoaded=!1,e}))}async getDelayLoadedDeltaStream(){(0,p.v)(!1===this.odspSocketModuleLoaded,1287);const e=await o.e(98256).then(o.bind(o,98256)).then((e=>(this.mc.logger.sendTelemetryEvent({eventName:"SocketModuleLoaded"}),e))).catch((e=>{throw this.mc.logger.sendErrorEvent({eventName:"SocketModuleLoadFailed"},e),e}));return this.odspDelayLoadedDeltaStream=new e.OdspDelayLoadedDeltaStream(this.odspResolvedUrl,this._policies,this.getStorageToken,this.getWebsocketToken,this.mc,this.cache,this.hostPolicy,this.epochTracker,(e=>this.opsReceived(e)),this.socketReferenceKeyPrefix),this.odspDelayLoadedDeltaStream}dispose(e){var t,o,s;void 0!==e?this.epochTracker.removeEntries().catch((()=>{})):null===(s=this._opsCache)||void 0===s||s.flushOps();null===(t=this._opsCache)||void 0===t||t.dispose(),null===(o=this.odspDelayLoadedDeltaStream)||void 0===o||o.dispose()}get opsCache(){var e,t,o,s,r,n,i;if(this._opsCache)return this._opsCache;const a=null===(e=this.storageManager)||void 0===e?void 0:e.snapshotSequenceNumber,c=null!==(t=null===(o=this.hostPolicy.opsCaching)||void 0===o?void 0:o.batchSize)&&void 0!==t?t:100;if(void 0===a||c<1)return;const h={type:"ops"};return this._opsCache=new we(a,this.mc.logger,{write:async(e,t)=>this.cache.persistedCache.put({...h,key:e},t),read:async e=>this.cache.persistedCache.get({...h,key:e}),remove:()=>{this.cache.persistedCache.removeEntries().catch((()=>{}))}},c,null!==(s=null===(r=this.hostPolicy.opsCaching)||void 0===r?void 0:r.timerGranularity)&&void 0!==s?s:5e3,null!==(n=null===(i=this.hostPolicy.opsCaching)||void 0===i?void 0:i.totalOpsToCache)&&void 0!==n?n:5e3),this._opsCache}opsReceived(e){var t;0===e.length||this.odspResolvedUrl.summarizer||null===(t=this.opsCache)||void 0===t||t.addOps(e)}}class Pe{get snapshotPrefetchResultCache(){return this.nonPersistentCache.snapshotPrefetchResultCache}get IRelaySessionAwareDriverFactory(){return this}async getRelayServiceSessionInfo(e){const t=(0,f.Yn)(e),o=await this.nonPersistentCache.sessionJoinCache.get((0,f.Q1)(t));return null===o||void 0===o?void 0:o.joinSessionResponse}async createContainer(e,t,i,a){let c=(0,f.Yn)(t);const h={siteUrl:c.siteUrl,driveId:c.driveId,itemId:c.itemId};let l,u;if(c.itemId)l={type:"Existing",driveId:c.driveId,siteUrl:c.siteUrl,itemId:c.itemId};else{if(!c.fileName)throw new Error("A new or existing file must be specified to create container!");{const[,e]=c.url.split("?"),t=new URLSearchParams(e),o=t.get("path");if(void 0===o||null===o)throw new Error("File path should be provided!!");u=function(e,t){let o;if(e.enableSingleRequestForShareLinkWithCreate){const e=t.get("createLinkScope"),s=t.get("createLinkRole");e&&n.Vy[e]&&(o={scope:n.Vy[e],...s&&n.Nd[s]?{role:n.Nd[s]}:{}})}else if(e.enableShareLinkWithCreate){const e=t.get("createLinkType");e&&n.DD[e]&&(o=n.DD[e||""])}return o}(this.hostPolicy,t),l={type:"New",driveId:c.driveId,siteUrl:c.siteUrl,filePath:o,filename:c.fileName,createLinkType:u}}}if((0,r.ub)(e)){const t=(0,r.YG)(e.tree[".protocol"]);if(0!==(null===t||void 0===t?void 0:t.sequenceNumber))throw new Error("Seq number in detached ODSP container should be 0")}const p=(0,f.bP)(i),g={resolvedUrl:c,docId:c.hashedDocumentId},m=(0,d.iJ)(this.persistedCache,this.nonPersistentCache,g,p,a);return s.Bt.timedExecAsync(p,{eventName:"CreateNew",isWithSummaryUpload:!0,createShareLinkParam:u?JSON.stringify(u):void 0,enableShareLinkWithCreate:this.hostPolicy.enableShareLinkWithCreate,enableSingleRequestForShareLinkWithCreate:this.hostPolicy.enableSingleRequestForShareLinkWithCreate},(async t=>{var s,r,n,i;const d=(0,f.yI)(p,h,this.getStorageToken,!0),u=await o.e(69225).then(o.bind(o,69225)).then((e=>(p.sendTelemetryEvent({eventName:"createNewModuleLoaded"}),e))).catch((e=>{throw p.sendErrorEvent({eventName:"createNewModuleLoadFailed"},e),e}));c=(0,f.$o)(l)?await u.createNewFluidFile(d,l,p,e,m.epochTracker,g,null===(s=this.hostPolicy.cacheCreateNewSummary)||void 0===s||s,!(null===(r=this.hostPolicy.sessionOptions)||void 0===r||!r.forceAccessTokenViaAuthorizationHeader),c.isClpCompliantApp,this.hostPolicy.enableSingleRequestForShareLinkWithCreate,this.hostPolicy.enableShareLinkWithCreate):await u.createNewContainerOnExistingFile(d,l,p,e,m.epochTracker,g,null===(n=this.hostPolicy.cacheCreateNewSummary)||void 0===n||n,!(null===(i=this.hostPolicy.sessionOptions)||void 0===i||!i.forceAccessTokenViaAuthorizationHeader),c.isClpCompliantApp);const v=this.createDocumentServiceCore(c,p,m,a);return t.end({docId:c.hashedDocumentId}),v}))}constructor(e,t){var o;let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new h,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.getStorageToken=e,this.getWebsocketToken=t,this.persistedCache=s,this.hostPolicy=r,this.nonPersistentCache=new l,!0===this.hostPolicy.isolateSocketCache&&(this.socketReferenceKeyPrefix=(0,i.A)()),this.hostPolicy.enableRedeemFallback=null===(o=this.hostPolicy.enableRedeemFallback)||void 0===o||o,this.hostPolicy.sessionOptions={forceAccessTokenViaAuthorizationHeader:!0,...this.hostPolicy.sessionOptions}}async createDocumentService(e,t,o){return this.createDocumentServiceCore(e,(0,f.bP)(t),void 0,o)}async createDocumentServiceCore(e,t,o,s){const r=(0,f.Yn)(e),n={siteUrl:r.siteUrl,driveId:r.driveId,itemId:r.itemId},i=null!==o&&void 0!==o?o:(0,d.iJ)(this.persistedCache,this.nonPersistentCache,{resolvedUrl:r,docId:r.hashedDocumentId},t,s),a=(0,f.yI)(t,n,this.getStorageToken,!0),c=void 0===this.getWebsocketToken?void 0:async e=>(0,f.yI)(t,n,this.getWebsocketToken,!1)(e,"GetWebsocketToken");return Ee.create(e,a,c,t,i.cache,this.hostPolicy,i.epochTracker,this.socketReferenceKeyPrefix,s)}}class Be extends Pe{constructor(e,t,o,s){super(e,t,o,s)}}var Ie=o(25969),Le=o(14836);const Oe=["https://pushchannel.1drv.ms/pushchannel.readwrite.all"];function Ue(){return Oe}function Re(e,t,o,s,r){const n={...s};!1!==n.concurrentSnapshotFetch&&(n.concurrentSnapshotFetch=!0);return new Be(Fe((o=>e.getToken((0,Ie.K)(o.siteUrl),(0,Le.r)(o,t)))),e.identityType&&["Consumer","UnauthenticatedGuest"].includes(e.identityType)?void 0:Fe((o=>e.getToken(Ue(),(0,Le.r)(o,t)))),o,n)}function Fe(e){return function(){return e(...arguments).then((e=>e||null))}}var De=o(29967);function Ae(e,t,o,s,r,n,i){return{documentServiceFactory:Re(e,t,o,s),urlResolver:(0,De.o)(e,t,r,i)}}},28340:(e,t,o)=>{o.d(t,{$:()=>s});const s={verbose:10,default:20,error:30}}}]);
//# sourceMappingURL=13255.3bc6efaf.chunk.js.map